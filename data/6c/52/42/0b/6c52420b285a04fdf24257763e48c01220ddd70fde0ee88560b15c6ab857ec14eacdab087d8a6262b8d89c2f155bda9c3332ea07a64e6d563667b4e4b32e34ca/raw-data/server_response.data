<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #73764 - RDF' href='rss/bug.php?id=73764'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #73764 - RSS 2.0' href='rss/bug.php?id=73764&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #73764 :: Crash while loading hostile phar archive</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=73764">Sec Bug</a>&nbsp;#73764</th>
            <td id="summary" colspan="5">Crash while loading hostile phar archive</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-12-16 21:22 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2017-01-25 11:10 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.29</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10159" target="_blank">2016-10159</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=73764&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=73764&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=73764&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1481923345">&nbsp;</a><strong>[2016-12-16 21:22 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Loading a hostile phar archive can cause an extensive memory allocation, that will trigger a fatal PHP error on 32 bit computers.

1) entry.filename_len is 4 bytes
2) value of 2 ** 32 - x can trigger an integer-overflow in the sanity check ( 0 &lt; x &lt;= 20):
if(entry.filename_len - 20 &gt; (size_t)(endbuffer - buffer)){
3) later the call to &quot;pestrndup&quot; will crash:
pestrndup(buffer, entry.filename_len, entry.is_persistent);

The fix should be in 2 separate checks:
1) update the 1st check inside the loop from 4 to 24 (full entry size):
if (buffer + 24 &lt; endbuffer){
2) avoid integer-overflow in the sanity check (20 because buffer was advanced by 4 already):
if(entry.filename_len &gt; (size_t)(endbuffer - buffer) - 20){

Test script:
---------------
&lt;?php
	$p = Phar::LoadPhar('example_hostile.phar', 'alias.phar');
	echo &quot;Loaded the phar archive\n&quot;;
?&gt;

Expected result:
----------------
The script should print the message

Actual result:
--------------
&quot;

mmap() failed: [22] Invalid argument

mmap() failed: [22] Invalid argument
PHP Fatal error:  Out of memory (allocated 2097152) (tried to allocate 4294967277 bytes) in XXX on line 2
&quot;

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=73764'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=73764'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1482822272">&nbsp;</a><strong>[2016-12-27 07:04 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1482822272">&nbsp;</a><strong>[2016-12-27 07:04 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Please provide example_hostile.phar
</pre>
</div><div class='comment type_log' ><a name="1482829553">&nbsp;</a><strong>[2016-12-27 09:05 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Open</span>
</div></div></div><div class='comment type_comment' ><a name="1482829553">&nbsp;</a><strong>[2016-12-27 09:05 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Uploaded the example_hostile.phar (+ the python script than generated it) to this link: <a href="http://www.cs.tau.ac.il/~eyalitki/Upload/73764/" rel="nofollow">http://www.cs.tau.ac.il/~eyalitki/Upload/73764/</a>
</pre>
</div><div class='comment type_log' ><a name="1483141276">&nbsp;</a><strong>[2016-12-30 23:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1483141276">&nbsp;</a><strong>[2016-12-30 23:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as ca46d0acbce55019b970fcd4c1e8a10edfdded93 and in <a href="https://gist.github.com/b9b67335b75597cce9d3b997dcfc9466" rel="nofollow">https://gist.github.com/b9b67335b75597cce9d3b997dcfc9466</a>

Please verify.
</pre>
</div><div class='comment type_log' ><a name="1483142358">&nbsp;</a><strong>[2016-12-30 23:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.1.0</span>
<span class="added">+PHP Version: 5.6.29</span>
</div></div></div><div class='comment type_log' ><a name="1483146069">&nbsp;</a><strong>[2016-12-31 01:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_comment' ><a name="1483173020">&nbsp;</a><strong>[2016-12-31 08:30 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>I verified the fix in the repository, and it will indeed solve this vulnerability.

Wanted to ask why did the PHP version changed to 5.X instead of 7.X? The vulnerability was found (and reproduced) in the latest PHP version, and it also (but not only) applies to previous versions.
</pre>
</div><div class='comment type_comment' ><a name="1483239048">&nbsp;</a><strong>[2017-01-01 02:50 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Due to the nature of PHP branches and how bugs are fixed in PHP, in the bug is in 5.6, it's most likely also in 7.x, but the reverse is frequently not true. Thus, the lowest branch having the problem is used. If the bug is 5.x specific, but not present in 7.x, it is noted in the bug (and then manual merge procedure is needed).
</pre>
</div><div class='comment type_log' ><a name="1483421213">&nbsp;</a><strong>[2017-01-03 05:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1483421213">&nbsp;</a><strong>[2017-01-03 05:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1485342644">&nbsp;</a><strong>[2017-01-25 11:10 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-10159</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
