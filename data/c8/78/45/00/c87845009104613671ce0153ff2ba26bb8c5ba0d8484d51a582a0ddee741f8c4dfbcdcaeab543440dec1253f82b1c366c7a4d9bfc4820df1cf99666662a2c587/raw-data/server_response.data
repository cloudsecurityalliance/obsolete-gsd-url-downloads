
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>
Issue 35121: [CVE-2018-20852] Cookie domain check returns incorrect results - Python tracker

</title>
<link rel="shortcut icon" href="@@file/favicon.ico" />
<link rel="stylesheet" type="text/css" href="@@file/main.css" />
<link rel="stylesheet" type="text/css" href="@@file/style.css" />
<link rel="search" type="application/opensearchdescription+xml" href="@@file/osd.xml" title="Python bug tracker search" />
<meta http-equiv="Content-Type"
      content="text/html; charset=utf-8" />

<script nonce="a5f0c234f43fdf6b9afc3120b2c92da81d83642b5849c1bdd83b20ef0656bd42" type="text/javascript">
submitted = false;
function submit_once() {
    if (submitted) {
        alert("Your request is being processed.\nPlease be patient.");
        return false;
    }
    submitted = true;
    return true;
}

function help_window(helpurl, width, height) {
    HelpWin = window.open('https://bugs.python.org/' + helpurl, 'RoundupHelpWindow', 'scrollbars=yes,resizable=yes,toolbar=no,height='+height+',width='+width);
    HelpWin.focus ()
}
</script>


<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.js"></script>
<script type="text/javascript" src="@@file/issue.item.js"></script>
<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/smoothness/jquery-ui.css" />


</head>
<body>
  <!--  Logo  -->
  <h1 id="logoheader">
    <a accesskey="1" href="." id="logolink">
       <img src="@@file/python-logo.gif" alt="homepage" border="0" id="logo" /></a>
  </h1>

<div id="utility-menu">
<!-- Search Box -->
<div id="searchbox">
    <form name="searchform" method="get" action="issue" id="searchform">
      <div id="search">
       <input type="hidden" name="@columns"
              value="id,activity,title,creator,assignee,status,type" />
       <input type="hidden" name="@sort" value="-activity" />
       <input type="hidden" name="@filter" value="status" />
       <input type="hidden" name="@action" value="searchid" />
       <input type="hidden" name="ignore" value="file:content" />
       <input class="input-text" id="search-text"
              name="@search_text" size="10" />
       <input type="submit" id="submit" value="search" name="submit" class="input-button" />
       <input type="radio" name="status"
              id="status_notresolved" value="-1,1,3" />
       <label for="status_notresolved">open</label>
       <input type="radio" name="status" checked="checked"
              id="status_all" value="-1,1,2,3" />
       <label for="status_all">all</label>
      </div>
     </form>
</div>
</div>


<div id="left-hand-navigation">
<!--  Main Menu NEED LEVEL TWO HEADER AND FOOTER -->
<div id="menu">
  <ul class="level-one">
    <li><a href="https://www.python.org/" title="Go to the Python homepage">Python Home</a></li>
    <li><a href="https://www.python.org/about/" title="About The Python Language">About</a></li>
    <li><a href="https://www.python.org/blogs/" title="">News</a></li>
    <li><a href="https://www.python.org/doc/" title="">Documentation</a></li>
    <li><a href="https://www.python.org/downloads/" title="">Downloads</a></li>
    <li><a href="https://www.python.org/community/" title="">Community</a></li>
    <li><a href="https://www.python.org/psf/" title="Python Software Foundation">Foundation</a></li>
    <li><a href="https://devguide.python.org/" title="Python Developer's Guide">Developer's Guide</a></li>
    <li class="selected"><a href="." class="selected" title="Python Issue Tracker">Issue Tracker</a>
      <ul class="level-two">
        <li>
          <strong>Issues</strong>
          <ul class="level-three">
            
            <li><a href="issue?@template=search&amp;status=1">Search</a></li>
            <li><a href="issue?@action=random">Random Issue</a></li>
            <li>
              <form method="post" action="issue35121">
                <input type="submit" class="form-small"
                       value="Show issue:" />
                <input class="form-small" size="4" type="text" name="@number" />
                <input type="hidden" name="@type" value="issue" />
                <input type="hidden" name="@action" value="show" />
              </form>
            </li>
          </ul>
        </li>


        <li>
          <strong>Summaries</strong>
          <ul class="level-three">
            

            

            

            <li>
              <a href="issue?status=1&amp;@sort=-activity&amp;@columns=id%2Cactivity%2Ctitle%2Ccreator%2Cstatus&amp;@dispname=Issues%20with%20patch&amp;@startwith=0&amp;@group=priority&amp;keywords=2&amp;@action=search&amp;@filter=&amp;@pagesize=50">Issues with patch</a>
            </li>

            <li>
              <a href="issue?status=1&amp;@sort=-activity&amp;@columns=id%2Cactivity%2Ctitle%2Ccreator%2Cstatus&amp;@dispname=Easy%20issues&amp;@startwith=0&amp;@group=priority&amp;keywords=6&amp;@action=search&amp;@filter=&amp;@pagesize=50">Easy issues</a>
            </li>

            <li>
              <a href="issue?@template=stats">Stats</a>
            </li>

          </ul>
        </li>


        <li>
          <strong>User</strong>
          <form method="post" action="issue35121">
          <ul class="level-three">
            <li>
                Login&nbsp;(OpenID&nbsp;possible)<br />
	         <a style="display:inline;width:0;margin:0"
             href="issue35121?@action=oic_login&amp;provider=Google">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://www.google.com/favicon.ico"
                       alt="Google" title="Google" /></a>
	         <a style="display:inline;width:0;margin:0"
             href="issue35121?@action=oic_login&amp;provider=GitHub">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://www.github.com/favicon.ico"
                       alt="GitHub" title="GitHub" /></a>
	         <a style="display:inline;width:0;margin:0"
             href="issue35121?@action=openid_login&amp;provider=Launchpad">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://launchpad.net/favicon.ico"
                       alt="Launchpad" title="Launchpad" /></a>
                <input size="10" name="openid_identifier" style="background:url(@@file/openid-16x16.gif)
                  center left no-repeat;padding-left:16px" /><br />
                <input size="10" type="password" name="__login_password" /><br />
                <input type="hidden" name="@action" value="Login" />
                <input type="checkbox" name="remember" id="remember" />
                <label for="remember">Remember me?</label><br />
                <input class="form-small" type="submit"
                       value="Login" /><br />
                <input type="hidden" name="__came_from"
                       value="https://bugs.python.org/issue35121?">
                
                <input type="hidden" name="@sort" value=""/>
<input type="hidden" name="@group" value=""/>
<input type="hidden" name="@pagesize" value="50"/>
<input type="hidden" name="@startwith" value="0"/>
            </li>
            <li>
                <a href="user?@template=register">Register</a>
            </li>
            <li><a href="user?@template=forgotten">Lost&nbsp;your&nbsp;login?</a></li>
          </ul>
          </form>
        </li>

        

        

        <li>
          <strong>Administration</strong>
          <ul class="level-three">
            
            <li>
                <a href="user?@sort=username">User List</a></li>
            <li>
                <a href="user?iscommitter=1&amp;@action=search&amp;@sort=username&amp;@pagesize=300">Committer List</a></li>
            
            
            
          </ul>
        </li>

        <li>
          <strong>Help</strong>
          <ul class="level-three">
            <li><a href="http://docs.python.org/devguide/triaging.html">
                Tracker Documentation</a></li>
            <li><a href="http://wiki.python.org/moin/TrackerDevelopment">
                Tracker Development</a></li>
            <li><a href="https://github.com/python/psf-infra-meta/issues">
                Report Tracker Problem</a></li>
          </ul>
        </li>

      </ul>
    </li>
  </ul>
</div> <!-- menu -->
</div> <!-- left-hand-navigation -->

<div id="content-body">
<div id="body-main">
<div id="content">
<div id="breadcrumb">
 
 
 Issue35121
 
</div>
 
 





<div>

<form method="post" name="itemSynopsis"
      onsubmit="return submit_once()"
      enctype="multipart/form-data" action="issue35121">

<fieldset><legend>classification</legend>
<table class="form">
<tr>
 <th class="required"><a href="http://docs.python.org/devguide/triaging.html#title" target="_blank">Title</a>:</th>
 
 <td colspan="3">
  <span>[CVE-2018-20852] Cookie domain check returns incorrect results</span>
  <input type="hidden" name="title"
         value="[CVE-2018-20852] Cookie domain check returns incorrect results">
 </td>
</tr>

<tr>
 <th class="required"><a href="http://docs.python.org/devguide/triaging.html#type" target="_blank">Type</a>:</th>
 <td>security</td>
 <th><a href="http://docs.python.org/devguide/triaging.html#stage" target="_blank">Stage</a>:</th>
 <td>resolved</td>
</tr>

<tr>
 <th><a href="http://docs.python.org/devguide/triaging.html#components" target="_blank">Components</a>:</th>
 <td>Library (Lib)</td>
 <th><a href="http://docs.python.org/devguide/triaging.html#versions" target="_blank">Versions</a>:</th>
 <td>Python 3.8, Python 3.7, Python 3.6, Python 3.4, Python 3.5, Python 2.7</td>
</tr>
</table>
</fieldset>

<fieldset><legend>process</legend>
<table class="form">
<tr>
  <th><a href="http://docs.python.org/devguide/triaging.html#status" target="_blank">Status</a>:</th>
  <td>closed</td>
  <th><a href="http://docs.python.org/devguide/triaging.html#resolution" target="_blank">Resolution</a>:</th>
  <td>fixed</td>
</tr>

<tr>
 <th>
    <a href="http://docs.python.org/devguide/triaging.html#dependencies"
       target="_blank">Dependencies</a>:
 </th>
 <td>
  
  
 </td>
 <th><a href="http://docs.python.org/devguide/triaging.html#superseder" target="_blank">Superseder</a>:</th>
 <td>
  
 
 </td>
 </tr>
 <tr>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#assigned-to"
      target="_blank">Assigned To</a>:
 </th>
 
 <td>
  benjamin.peterson
 </td>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#nosy-list"
      target="_blank">Nosy List</a><!--
        <span tal:condition="context/nosy_count" tal:replace="python: ' (%d)' % context.nosy_count" /> -->:
 </th>
 <td>
     Windson Yang, benjamin.peterson, larry, lukasz.langa, martin.panter, miss-islington, ned.deily, orsenthil, rschiron, serhiy.storchaka, vstinner, xtreak, 西田雄治
     
 </td>
</tr>
<tr>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#priority"
      target="_blank">Priority</a>:
 </th>
 <td>release blocker</td>
 <th>
    <a href="http://docs.python.org/devguide/triaging.html#keywords"
       target="_blank">Keywords</a>:
 </th>
 <td>patch, security_issue</td>


</tr>









</table>
</fieldset>

</form>

<p>Created on <strong>2018-10-31 06:52</strong> by <strong>西田雄治</strong>, last changed <strong>2019-07-15 09:42</strong> by <strong>vstinner</strong>. This issue is now <strong style="color:#00F; background-color:inherit;">closed</strong>.</p>



<table class="files">
 <tr><th class="header" colspan="4">Pull Requests</th></tr>
 <tr>
  <th>URL</th>
  <th>Status</th>
  <th>Linked</th>
  <th>Edit</th>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/10258" title="bpo-35121: prefix dot in domain for proper subdomain validation">PR 10258</a></td>
  <td>merged</td>
  <td>
   <span>xtreak</span>,
   <span>2018-10-31 10:29</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/12260" title="[3.6] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 12260</a></td>
  <td>merged</td>
  <td>
   <span>miss-islington</span>,
   <span>2019-03-10 02:10</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/12261" title="[3.7] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 12261</a></td>
  <td>merged</td>
  <td>
   <span>miss-islington</span>,
   <span>2019-03-10 02:36</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/12279" title="[3.4] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 12279</a></td>
  <td>merged</td>
  <td>
   <span>xtreak</span>,
   <span>2019-03-11 15:54</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/12281" title="[3.5] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 12281</a></td>
  <td>merged</td>
  <td>
   <span>xtreak</span>,
   <span>2019-03-11 16:02</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/13426" title="[2.7] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 13426</a></td>
  <td>merged</td>
  <td>
   <span>xtreak</span>,
   <span>2019-05-19 19:09</span>
  </td>
  <td>
    
  </td>
 </tr>
</table>





<table class="messages">
 <tr><th colspan="4" class="header">Messages (30)</th></tr>
 
  <tr>
    <th>
     <a href="#msg328973" id="msg328973">msg328973</a> - <a
    href="msg328973">(view)</a></th>
   <th>Author: 西田雄治 (西田雄治)</th>
   <th>Date: 2018-10-31 06:52</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>http.cookiejar.DefaultPolicy.domain_return_ok returns incorrect results.

So, HTTP clients send cookies which issued from wrong server.

policy = http.cookiejar.DefaultCookiePolicy()
req = urllib.request.Request('<a href="https://xxxfoo.co.jp/">https://xxxfoo.co.jp/</a>')
print(policy.domain_return_ok('foo.co.jp', req)   # should be False, but it returns True</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg328975" id="msg328975">msg328975</a> - <a
    href="msg328975">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-10-31 08:15</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>The current set of tests are at <a href="https://github.com/python/cpython/blob/0353b4eaaf451ad463ce7eb3074f6b62d332f401/Lib/test/test_http_cookiejar.py#L406">https://github.com/python/cpython/blob/0353b4eaaf451ad463ce7eb3074f6b62d332f401/Lib/test/test_http_cookiejar.py#L406</a> . A simple set of tuple that can be added based on the report as below : 

("<a href="http://barfoo.com">http://barfoo.com</a>", ".foo.com", False)
("<a href="http://barfoo.com">http://barfoo.com</a>", "foo.com", False) # Fails on master

The check is done at <a href="https://github.com/python/cpython/blob/0353b4eaaf451ad463ce7eb3074f6b62d332f401/Lib/http/cookiejar.py#L1176">https://github.com/python/cpython/blob/0353b4eaaf451ad463ce7eb3074f6b62d332f401/Lib/http/cookiejar.py#L1176</a> . There is no check to add '.' before domain if absent. Hence it performs a substring match with the values req_host = ".barfoo.com" and erhn = ".barfoo.com" and domain = "foo.com" so the condition `not (req_host.endswith(domain) or erhn.endswith(domain))` fails and doesn't return False. I would suggest adding a check to make sure domain also starts with '.' similar to req_host and erhn thus fixing the issue. I tried the fix and existing tests along with the reported case works fine.

diff --git a/Lib/http/cookiejar.py b/Lib/http/cookiejar.py
index <a href="https://hg.python.org/lookup/0ba8200f32">0ba8200f32</a>..<a href="https://hg.python.org/lookup/da7462701b">da7462701b</a> 100644
--- a/Lib/http/cookiejar.py
+++ b/Lib/http/cookiejar.py
@@ -1173,6 +1173,8 @@ class DefaultCookiePolicy(CookiePolicy):
             req_host = "."+req_host
         if not erhn.startswith("."):
             erhn = "."+erhn
+        if not domain.startswith("."):
+            domain = "."+domain
         if not (req_host.endswith(domain) or erhn.endswith(domain)):
             #_debug("   request domain %s does not match cookie domain %s",
             #       req_host, domain)

("<a href="http://barfoo.com">http://barfoo.com</a>", ".foo.com", False)
("<a href="http://barfoo.com">http://barfoo.com</a>", "foo.com", False) # Tests pass with fix

Also tried the script attached in the report

$ cat ../backups/bpo35121.py

import urllib
from http.cookiejar import DefaultCookiePolicy

policy = DefaultCookiePolicy()
req = urllib.request.Request('<a href="https://xxxfoo.co.jp/">https://xxxfoo.co.jp/</a>')
print(policy.domain_return_ok('foo.co.jp', req))

# without fix

$ ./python.exe ../backups/bpo35121.py
True

# With domain fix

$ ./python.exe ../backups/bpo35121.py
False

The check was added in 2004 with commit <a href="https://hg.python.org/lookup/2a6ba9097ee3942ae328befaf074ce9722b93ca0">2a6ba9097ee3942ae328befaf074ce9722b93ca0</a> . If my fix is correct I am willing to raise a PR for this with test.

Hope it helps!</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg328981" id="msg328981">msg328981</a> - <a
    href="msg328981">(view)</a></th>
   <th>Author: 西田雄治 (西田雄治)</th>
   <th>Date: 2018-10-31 10:24</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I think that is desired result. thanks!</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg328985" id="msg328985">msg328985</a> - <a
    href="msg328985">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-10-31 11:27</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Thanks for the confirmation. I have created a PR (<a href="https://github.com/python/cpython/pull/10258">https://github.com/python/cpython/pull/10258</a>) with test and added 3.8 as affected version. Please add in if I have missed anything in the PR.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg329176" id="msg329176">msg329176</a> - <a
    href="msg329176">(view)</a></th>
   <th>Author: Windson Yang (Windson Yang) <span title="Contributor form received">*</span></th>
   <th>Date: 2018-11-03 02:12</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I wonder <a href="https://github.com/python/cpython/blob/master/Lib/test/test_http_cookiejar.py#L420">https://github.com/python/cpython/blob/master/Lib/test/test_http_cookiejar.py#L420</a> 

("<a href="http://foo.bar.com/">http://foo.bar.com/</a>", "com", True),
("<a href="http://foo.com/">http://foo.com/</a>", "com", True),

are expected behavior?</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg329179" id="msg329179">msg329179</a> - <a
    href="msg329179">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-11-03 04:02</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Good catch Windson! I overlooked the tests. There is also a comment that it's liberal in the test function. Since the code was added in 2006 I don't if it's ok broken to fix this or not. I will let the reviewers take a call then. There is also domain_match and user_domain_match that perform more tests.

&gt; This is only a rough check for performance reasons, so it's not too critical as long as it's sufficiently liberal.

Thanks for your input!</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg332299" id="msg332299">msg332299</a> - <a
    href="msg332299">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-12-21 20:57</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Looking further into this the domain validation makes it little more stricter and can have wider implications. For example requests library uses cookiejar to maintain cookies between sessions. One more case is that `domain` can be empty so only non-empty domains can be prefixed with dot.

A simple server that sets Cookie with value `A=LDJDSFLKSDJLDSF`

import SimpleHTTPServer
import logging

class MyHTTPRequestHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.cookieHeader = self.headers.get('Cookie')
        SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)

    def end_headers(self):
        self.send_my_headers()
        SimpleHTTPServer.SimpleHTTPRequestHandler.end_headers(self)

    def send_my_headers(self):
        self.send_header('Set-Cookie', 'A=LDJDSFLKSDJLDSF')

if __name__ == '__main__':
    SimpleHTTPServer.test(HandlerClass=MyHTTPRequestHandler)


Add below host entry to `/etc/hosts` 

127.0.0.1 test.com
127.0.0.1 1.test.com
127.0.0.1 footest.com


Sample script to demonstrate requests behavior change

import requests

with requests.Session() as s:
    cookies = dict(cookies_are='working')
    m = s.get("<a href="http://test.com:8000">http://test.com:8000</a>", cookies=cookies)
    print(m.request.headers)
    m = s.get("<a href="http://1.test.com:8000">http://1.test.com:8000</a>", cookies=cookies)
    print(m.request.headers)
    m = s.get("<a href="http://footest.com:8000">http://footest.com:8000</a>", cookies=cookies)
    print(m.request.headers)


Before patch : 


{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'cookies_are=working'}
{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'A=LDJDSFLKSDJLDSF; cookies_are=working'}
{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'A=LDJDSFLKSDJLDSF; cookies_are=working'}

After patch :


{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'cookies_are=working'}
{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'A=LDJDSFLKSDJLDSF; cookies_are=working'}
{'User-Agent': 'python-requests/2.11.1', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Cookie': 'cookies_are=working'}


As with my patch since the cookie is set on `test.com` while making a request to `footest.com` the cookie is skipped as part of the patch since footest is not a subdomain of test.com but 1.test.com is a subdomain. This is a behavior change to be decided whether worth doing or to document this since in a client with session like requests module connecting to lot of hosts this can potentially pass cookies of test.com to footest.com. A discussion on requests repo on providing the option for user to set a stricter cookie policy : <a href="https://github.com/requests/requests/issues/2576">https://github.com/requests/requests/issues/2576</a>

On testing with curl cookie-jar it seems that the cookies are passed even for the subdomain only when it's set and not as part of top level domain.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg332576" id="msg332576">msg332576</a> - <a
    href="msg332576">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-12-27 06:58</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Also looking at the docs for different frameworks like [Flask](<a href="http://flask.pocoo.org/docs/1.0/api/#flask.Response.set_cookie">http://flask.pocoo.org/docs/1.0/api/#flask.Response.set_cookie</a>) and [Django](<a href="https://docs.djangoproject.com/en/2.1/ref/request-response/#django.http.HttpResponse.set_cookie">https://docs.djangoproject.com/en/2.1/ref/request-response/#django.http.HttpResponse.set_cookie</a>) they recommend setting Domain attribute only for cross-domain cookies.

From Django docs

&gt; Use domain if you want to set a cross-domain cookie. For example, domain="example.com" will set a cookie that is readable by the domains <a href="http://www.example.com">www.example.com</a>, blog.example.com, etc. Otherwise, a cookie will only be readable by the domain that set it.

When there is no domain specified then the frameworks seem to set the cookie only for the host only as per [RFC 6265](<a href="https://tools.ietf.org/html/rfc6265#section-5.3">https://tools.ietf.org/html/rfc6265#section-5.3</a>). So domain attribute is set all the time and it's just that if the domain attribute is set explicitly by the server with the set_cookie function in the frameworks then the cookiejar has domain_specified set along with dot prefixed for the domain enabling stricter validations. I don't know about the metrics of setting the domain attribute vs not setting it. Checking with a simple Flask app and set_cookie without domain parameter the cookies are passed to suffix domains. With domain passed to set_cookie has dot prefixed and the cookies are not passed to suffix domains.

I also looked into other implementations

* aiohttp - uses cookiejar but has custom domain checks and update cookie methods at <a href="https://github.com/aio-libs/aiohttp/blob/49261c192ff225372dffb39056c3c311714b12c5/aiohttp/cookiejar.py#L141">https://github.com/aio-libs/aiohttp/blob/49261c192ff225372dffb39056c3c311714b12c5/aiohttp/cookiejar.py#L141</a> . Thus it's not affected when tested.
* golang implementation - <a href="https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/net/http/cookiejar/jar.go#L123">https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/net/http/cookiejar/jar.go#L123</a></pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg332583" id="msg332583">msg332583</a> - <a
    href="msg332583">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2018-12-27 10:21</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I have come across another behavior change between path checks while using the cookie jar implementation available in Python. This is related to incorrect cookie validation but with respect to path so let me know if this needs a separate ticket. I observed the following difference : 

1. Make a request to "/" that sets a cookie with "path=/any"
2. Make a request to "/any" and the set cookie is passed since the path matches
3. Make a request to "/anybad" and cookie with "path=/any" is also passed too.

On using golang stdlib implementation of cookiejar the cookie "path=/any" is not passed when a request to "/anybad" is made. So I checked with RFC 6265 where the path match check is defined in section-5.1.4 . RFC 6265 also obsoletes RFC 2965 upon which cookiejar is based I hope since original implementation of cookiejar is from 2004 and RFC 6265 was standardized later. So I think it's good to enforce RFC 6265 since RFC 2965 is obsolete at least in Python 3.8 unless this is considered as a security issue. I think this is a security issue. The current implementation can potentially cause cookies to be sent to incorrect paths in the same domain that share the same prefix. This is a behavior change with more strict checks but I could see no tests failing with RFC 6265 implementation too.

RFC 2965 also gives a loose definition of path-match without mentioning about / check in the paths based on which Python implementation is based as a simple prefix match.

&gt; For two strings that represent paths, P1 and P2, P1 path-matches P2
&gt; if P2 is a prefix of P1 (including the case where P1 and P2 string-
&gt; compare equal).  Thus, the string /tec/waldo path-matches /tec.

RFC 6265 path-match definition : <a href="https://tools.ietf.org/html/rfc6265#section-5.1.4">https://tools.ietf.org/html/rfc6265#section-5.1.4</a>

   A request-path path-matches a given cookie-path if at least one of
   the following conditions holds:

   o  The cookie-path and the request-path are identical.

   o  The cookie-path is a prefix of the request-path, and the last
      character of the cookie-path is %x2F ("/").

   o  The cookie-path is a prefix of the request-path, and the first
      character of the request-path that is not included in the cookie-
      path is a %x2F ("/") character.

The current implementation in cookiejar is as below : 

def path_return_ok(self, path, request):
    _debug("- checking cookie path=%s", path)
    req_path = request_path(request)
    if not req_path.startswith(path):
        _debug("  %s does not path-match %s", req_path, path)
        return False
    return True

Translating the RFC 6265 steps (a literal translation of go implementation) would have something like below and no tests fail on master. So the python implementation goes in line with the RFC not passing cookies of "path=/any" to /anybody

def path_return_ok(self, path, request):
    req_path = request_path(request)
    if req_path == path:
        return True
    elif req_path.startswith(path) and ((path.endswith("/") or req_path[len(path)] == "/")):
        return True
        
    return False


The golang implementation is as below which is a literal translation of RFC 6265 steps at <a href="https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/net/http/cookiejar/jar.go#L130">https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/net/http/cookiejar/jar.go#L130</a>

// pathMatch implements "path-match" according to RFC 6265 section 5.1.4.
func (e *entry) pathMatch(requestPath string) bool {
	if requestPath == e.Path {
		return true
	}
	if strings.HasPrefix(requestPath, e.Path) {
		if e.Path[len(e.Path)-1] == '/' {
			return true // The "/any/" matches "/any/path" case.
		} else if requestPath[len(e.Path)] == '/' {
			return true // The "/any" matches "/any/path" case.
		}
	}
	return false
}


Feel free to correct me if I am wrong on the above.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg332920" id="msg332920">msg332920</a> - <a
    href="msg332920">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-01-03 08:01</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I have opened <a class="closed" title="[closed] Cookie path check returns incorrect results" href="issue35647">issue35647</a> for path related checks as a separate report.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg335386" id="msg335386">msg335386</a> - <a
    href="msg335386">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-02-13 06:30</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>This issue affects 2.7 as well along with 3.4 and 3.5. The initial report was notified to <a href="mailto:security@python.org">security@python.org</a> . 2.7.16 release candidate dates were announced at <a href="https://mail.python.org/pipermail/python-dev/2019-February/156266.html">https://mail.python.org/pipermail/python-dev/2019-February/156266.html</a>. I have prepared an initial backport of this with tests for 2.7 at <a href="https://github.com/python/cpython/compare/2.7...tirkarthi:bpo35121-27">https://github.com/python/cpython/compare/2.7...tirkarthi:bpo35121-27</a> . Serhiy has approved the PR for master. I have added notes here and on the PR about the issue and implementation in other languages. It would be helpful if someone can double check my analysis since cookiejar has not received much change over the years.

If this is a potential candidate for 2.7 release I can help with that once the changes are merged to master. Adding Benjamin Peterson to this issue to take a call on if it needs to be backported to 2.7. If it's planned for a backport then also to decide on priority if this needs to be part of 2.7.16 or later release.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337588" id="msg337588">msg337588</a> - <a
    href="msg337588">(view)</a></th>
   <th>Author: Ned Deily (ned.deily) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 02:09</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a> by Ned Deily (Xtreak) in branch 'master':
<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>)
<a href="https://github.com/python/cpython/commit/ca7fe5063593958e5efdf90f068582837f07bd14">https://github.com/python/cpython/commit/ca7fe5063593958e5efdf90f068582837f07bd14</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337590" id="msg337590">msg337590</a> - <a
    href="msg337590">(view)</a></th>
   <th>Author: Ned Deily (ned.deily) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 02:58</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/e5123d81ffb3be35a1b2767d6ced1a097aaf77be">e5123d81ffb3be35a1b2767d6ced1a097aaf77be</a> by Ned Deily (Miss Islington (bot)) in branch '3.7':
<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>) (<a href="https://github.com/python/cpython/pull/12261" class="closed" title="GitHub PR 12261: [merged] [3.7] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">GH-12261</a>)
<a href="https://github.com/python/cpython/commit/e5123d81ffb3be35a1b2767d6ced1a097aaf77be">https://github.com/python/cpython/commit/e5123d81ffb3be35a1b2767d6ced1a097aaf77be</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337592" id="msg337592">msg337592</a> - <a
    href="msg337592">(view)</a></th>
   <th>Author: Ned Deily (ned.deily) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 02:59</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/b241af861b37e20ad30533bc0b7e2e5491cc470f">b241af861b37e20ad30533bc0b7e2e5491cc470f</a> by Ned Deily (Miss Islington (bot)) in branch '3.6':
<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>) (<a href="https://github.com/python/cpython/pull/12260" class="closed" title="GitHub PR 12260: [merged] [3.6] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">GH-12260</a>)
<a href="https://github.com/python/cpython/commit/b241af861b37e20ad30533bc0b7e2e5491cc470f">https://github.com/python/cpython/commit/b241af861b37e20ad30533bc0b7e2e5491cc470f</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337593" id="msg337593">msg337593</a> - <a
    href="msg337593">(view)</a></th>
   <th>Author: Ned Deily (ned.deily) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 03:06</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>OK, thanks for the initial report and a big thank you to @xtreak for the PR and following up on things.  The PR is now merged to master for 3.8.0 and backported as a security fix for release in 3.7.3 and 3.6.9.  Reassigning to Benjamin for a decision on backporting to 2.7.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337598" id="msg337598">msg337598</a> - <a
    href="msg337598">(view)</a></th>
   <th>Author: Serhiy Storchaka (serhiy.storchaka) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 08:21</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>What about 3.4 and 3.5?</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337600" id="msg337600">msg337600</a> - <a
    href="msg337600">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 08:51</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>From my initial tests 3.4 and 3.5 were also affected. 3.4 is going EoL and RC1 is out but there is one another security issue (<a class="closed" title="[closed] CVE-2019-9636: urlsplit does not handle NFKC normalization" href="issue36216">issue36216</a>) fixed last week with a PR open. If the merge window is open and Larry is okay then I can raise backport PRs if needed. There are less changes made to cookiejar and cherry_picker would also work fine as I tried it locally.


cherry_picker --no-push <a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a> 3.5
🐍 🍒 ⛏

Now backporting '<a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a>' into '3.5'
Switched to a new branch 'backport-ca7fe50-3.5'
Branch 'backport-ca7fe50-3.5' set up to track remote branch '3.5' from 'upstream'.

[backport-ca7fe50-3.5 <a href="https://hg.python.org/lookup/fcb2dd85a0">fcb2dd85a0</a>] <a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>)
 Author: Xtreak &lt;<a href="mailto:tir.karthi@gmail.com">tir.karthi@gmail.com</a>&gt;
 Date: Sun Mar 10 07:39:48 2019 +0530
 3 files changed, 45 insertions(+), 2 deletions(-)
 create mode 100644 <a href="https://github.com/python/cpython/blob/master/Misc/NEWS.d/next/Security/2018-10-31-15-39-17.<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>.EgHv9k.rst">Misc/NEWS.d/next/Security/2018-10-31-15-39-17.<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>.EgHv9k.rst</a>


Finished cherry-pick <a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a> into backport-ca7fe50-3.5 😀

cherry_picker --no-push <a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a> 3.4
🐍 🍒 ⛏

Now backporting '<a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a>' into '3.4'
Switched to a new branch 'backport-ca7fe50-3.4'
Branch 'backport-ca7fe50-3.4' set up to track remote branch '3.4' from 'upstream'.

Performing inexact rename detection: 100% (639108/639108), done.
[backport-ca7fe50-3.4 <a href="https://hg.python.org/lookup/46ea57d6b3">46ea57d6b3</a>] <a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>)
 Author: Xtreak &lt;<a href="mailto:tir.karthi@gmail.com">tir.karthi@gmail.com</a>&gt;
 Date: Sun Mar 10 07:39:48 2019 +0530
 3 files changed, 45 insertions(+), 2 deletions(-)
 create mode 100644 <a href="https://github.com/python/cpython/blob/master/Misc/NEWS.d/next/Security/2018-10-31-15-39-17.<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>.EgHv9k.rst">Misc/NEWS.d/next/Security/2018-10-31-15-39-17.<a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>.EgHv9k.rst</a>


Finished cherry-pick <a href="https://hg.python.org/lookup/ca7fe5063593958e5efdf90f068582837f07bd14">ca7fe5063593958e5efdf90f068582837f07bd14</a> into backport-ca7fe50-3.4 😀</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg337601" id="msg337601">msg337601</a> - <a
    href="msg337601">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-10 09:16</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>There are many libraries that use DefaultCookiePolicy and requests library uses it for client where session state needs to be maintained across different requests. Currently, requests doesn't have a documented API to change to cookiejar policy and were not keen on introducing a custom one since this might introduce maintenance burden over keeping it in sync with other changes when made upstream. The team have been informed about this when the issue was created and I also updated the maintainers now about the fix being merged since it's a highly popular library. 

So requests will remain affected when ran on versions where this patch is not available in CPython standard library as of now. A potentially simple workaround in the absence of patch on affected versions is to set DomainStrict in the cookiepolicy that would make sure a literal match against domain is made at [0] . The disadvantage I guess would be that cookie set on example.com would not be shared with subdomain which might break workflow. aio-http was not affected since it uses custom cookiejar policy. scrapy also seems to be not affected since they custom policies. Most of the web frameworks don't recommend setting domain explicitly and set them implicitly so it can be reproduced in the default setup of frameworks and Flask was the one I tested which makes me assume this could be easily exploited.


[0] <a href="https://github.com/python/cpython/blob/ca7fe5063593958e5efdf90f068582837f07bd14/Lib/http/cookiejar.py#L1158">https://github.com/python/cpython/blob/ca7fe5063593958e5efdf90f068582837f07bd14/Lib/http/cookiejar.py#L1158</a></pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg338109" id="msg338109">msg338109</a> - <a
    href="msg338109">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-16 22:56</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/42ad4101d3ba7ca3c371dadf0f8880764c9f15fb">42ad4101d3ba7ca3c371dadf0f8880764c9f15fb</a> by larryhastings (Xtreak) in branch '3.4':
[3.4] <a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>) (<a class="closed" title="[closed] Add build_distinfo command to packaging" href="issue12279">#12279</a>)
<a href="https://github.com/python/cpython/commit/42ad4101d3ba7ca3c371dadf0f8880764c9f15fb">https://github.com/python/cpython/commit/42ad4101d3ba7ca3c371dadf0f8880764c9f15fb</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg338114" id="msg338114">msg338114</a> - <a
    href="msg338114">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-17 00:03</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/4749f1b69000259e23b4cc6f63c542a9bdc62f1b">4749f1b69000259e23b4cc6f63c542a9bdc62f1b</a> by larryhastings (Xtreak) in branch '3.5':
[3.5] <a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>) (<a class="closed" title="[closed] bytes.decode('mbcs', 'ignore') does replace undecodable bytes on Windows Vista or later" href="issue12281">#12281</a>)
<a href="https://github.com/python/cpython/commit/4749f1b69000259e23b4cc6f63c542a9bdc62f1b">https://github.com/python/cpython/commit/4749f1b69000259e23b4cc6f63c542a9bdc62f1b</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg338152" id="msg338152">msg338152</a> - <a
    href="msg338152">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-03-18 01:22</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Larry, I am reopening this since this seems to affects 2.7 and would wait for Benjamin's call on backporting this.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg344555" id="msg344555">msg344555</a> - <a
    href="msg344555">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-04 12:30</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I added this issue to my security website:
<a href="https://python-security.readthedocs.io/vuln/cookie-domain-check.html">https://python-security.readthedocs.io/vuln/cookie-domain-check.html</a>

So it's fixed in Python 3.4.10, 3.5.7 and 3.7.3. Right now, 2.7 and 3.6 are vulnerable (but 3.6 branch is fixed).</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg344556" id="msg344556">msg344556</a> - <a
    href="msg344556">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-04 12:37</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Can someone try to backport the fix to Python 2.7?</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg344560" id="msg344560">msg344560</a> - <a
    href="msg344560">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-04 12:49</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>&gt; Can someone try to backport the fix to Python 2.7?

The backport to 2.7 <a href="https://github.com/python/cpython/pull/13426" class="closed" title="GitHub PR 13426: [merged] [2.7] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">PR 13426</a> is open. It would be helpful if someone can review it. I am not sure of the commit review process and who needs to review and approve it since this is assigned to Benjamin Peterson. It's a fairly straightforward backport except that http.cookiejar is cookielib in Python 2.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg345689" id="msg345689">msg345689</a> - <a
    href="msg345689">(view)</a></th>
   <th>Author: miss-islington (miss-islington)</th>
   <th>Date: 2019-06-15 15:29</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/979daae300916adb399ab5b51410b6ebd0888f13">979daae300916adb399ab5b51410b6ebd0888f13</a> by Miss Islington (bot) (Xtreak) in branch '2.7':
[2.7] <a class="closed" title="[closed] [CVE-2018-20852] Cookie domain check returns incorrect results" href="issue35121">bpo-35121</a>: prefix dot in domain for proper subdomain validation (<a href="https://github.com/python/cpython/pull/10258" class="closed" title="GitHub PR 10258: [merged] bpo-35121: prefix dot in domain for proper subdomain validation">GH-10258</a>) (<a href="https://github.com/python/cpython/pull/13426" class="closed" title="GitHub PR 13426: [merged] [2.7] bpo-35121: prefix dot in domain for proper subdomain validation (GH-10258)">GH-13426</a>)
<a href="https://github.com/python/cpython/commit/979daae300916adb399ab5b51410b6ebd0888f13">https://github.com/python/cpython/commit/979daae300916adb399ab5b51410b6ebd0888f13</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg345700" id="msg345700">msg345700</a> - <a
    href="msg345700">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-15 16:38</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Closing this as resolved since the fix was merged to all branches. Thank you all.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg345736" id="msg345736">msg345736</a> - <a
    href="msg345736">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-16 07:58</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Again, well done Karthikeyan Singaravelan!</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg346748" id="msg346748">msg346748</a> - <a
    href="msg346748">(view)</a></th>
   <th>Author: Riccardo Schirone (rschiron)</th>
   <th>Date: 2019-06-27 15:49</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Did anybody request a CVE for this issue? I think it deserves one as it is a security issue and it may leak cookies to wrong domains. Does anybody have anything against assigning a CVE to this issue? If not, I would try to get one from MITRE.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg346749" id="msg346749">msg346749</a> - <a
    href="msg346749">(view)</a></th>
   <th>Author: Karthikeyan Singaravelan (xtreak) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2019-06-27 15:55</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I also reported it to <a href="mailto:security@python.org">security@python.org</a> . Please check with them too to see if there is a CVE request already made. Thanks.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg347951" id="msg347951">msg347951</a> - <a
    href="msg347951">(view)</a></th>
   <th>Author: Riccardo Schirone (rschiron)</th>
   <th>Date: 2019-07-15 08:30</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>CVE-2018-20852 has been assigned to this flaw.</pre>
   </td>
  </tr>
 
</table>

<table class="history table table-condensed table-striped"><tr><th colspan="4" class="header">
History
</th></tr><tr>
<th>Date</th>
<th>User</th>
<th>Action</th>
<th>Args</th>
</tr>
<tr><td>2019-07-15&nbsp;09:42:01</td><td>vstinner</td><td>set</td><td>title: [ CVE-2018-20852] Cookie domain check returns incorrect results -> [CVE-2018-20852] Cookie domain check returns incorrect results</td></tr>
<tr><td>2019-07-15&nbsp;09:41:35</td><td>vstinner</td><td>set</td><td>title: Cookie domain check returns incorrect results -> [ CVE-2018-20852] Cookie domain check returns incorrect results</td></tr>
<tr><td>2019-07-15&nbsp;08:30:53</td><td>rschiron</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg347951">msg347951</a></td></tr>
<tr><td>2019-06-27&nbsp;15:55:29</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg346749">msg346749</a></td></tr>
<tr><td>2019-06-27&nbsp;15:49:06</td><td>rschiron</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user31501">rschiron</a><br />messages:
  + <a rel="nofollow" href="msg346748">msg346748</a><br /></td></tr>
<tr><td>2019-06-16&nbsp;07:58:28</td><td>vstinner</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg345736">msg345736</a></td></tr>
<tr><td>2019-06-15&nbsp;16:38:00</td><td>xtreak</td><td>set</td><td>status: open -> closed<br />resolution: fixed<br />messages:
  + <a rel="nofollow" href="msg345700">msg345700</a><br /><br />stage: patch review -> resolved</td></tr>
<tr><td>2019-06-15&nbsp;15:29:46</td><td>miss-islington</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user27838">miss-islington</a><br />messages:
  + <a rel="nofollow" href="msg345689">msg345689</a><br /></td></tr>
<tr><td>2019-06-04&nbsp;12:49:06</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg344560">msg344560</a></td></tr>
<tr><td>2019-06-04&nbsp;12:37:47</td><td>vstinner</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg344556">msg344556</a></td></tr>
<tr><td>2019-06-04&nbsp;12:30:18</td><td>vstinner</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user2377">vstinner</a><br />messages:
  + <a rel="nofollow" href="msg344555">msg344555</a><br /></td></tr>
<tr><td>2019-05-19&nbsp;19:09:00</td><td>xtreak</td><td>set</td><td>stage: commit review -> patch review<br />pull_requests:
  + <a rel="nofollow" href="pull_request13336">pull_request13336</a></td></tr>
<tr><td>2019-05-10&nbsp;17:57:59</td><td>ned.deily</td><td>set</td><td>messages:
  - <a rel="nofollow" href="msg342111">msg342111</a></td></tr>
<tr><td>2019-05-10&nbsp;17:36:40</td><td>ned.deily</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg342111">msg342111</a></td></tr>
<tr><td>2019-03-18&nbsp;01:22:13</td><td>xtreak</td><td>set</td><td>status: closed -> open<br />resolution: fixed -> (no value)<br />messages:
  + <a rel="nofollow" href="msg338152">msg338152</a><br /><br />stage: resolved -> commit review</td></tr>
<tr><td>2019-03-17&nbsp;20:52:04</td><td>larry</td><td>set</td><td>status: open -> closed<br />resolution: fixed<br />stage: patch review -> resolved</td></tr>
<tr><td>2019-03-17&nbsp;00:03:41</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg338114">msg338114</a></td></tr>
<tr><td>2019-03-16&nbsp;22:56:36</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg338109">msg338109</a></td></tr>
<tr><td>2019-03-11&nbsp;16:02:58</td><td>xtreak</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request12261">pull_request12261</a></td></tr>
<tr><td>2019-03-11&nbsp;15:54:07</td><td>xtreak</td><td>set</td><td>stage: commit review -> patch review<br />pull_requests:
  + <a rel="nofollow" href="pull_request12259">pull_request12259</a></td></tr>
<tr><td>2019-03-10&nbsp;09:16:39</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg337601">msg337601</a></td></tr>
<tr><td>2019-03-10&nbsp;08:51:02</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg337600">msg337600</a></td></tr>
<tr><td>2019-03-10&nbsp;08:21:40</td><td>serhiy.storchaka</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user2731">larry</a><br /><br />messages:
  + <a rel="nofollow" href="msg337598">msg337598</a><br />versions:
  + Python 3.4, Python 3.5</td></tr>
<tr><td>2019-03-10&nbsp;03:06:58</td><td>ned.deily</td><td>set</td><td>assignee: <a rel="nofollow" href="user4455">benjamin.peterson</a><br />stage: patch review -> commit review<br />messages:
  + <a rel="nofollow" href="msg337593">msg337593</a><br />versions:
  + Python 2.7</td></tr>
<tr><td>2019-03-10&nbsp;03:01:07</td><td>ned.deily</td><td>set</td><td>pull_requests:
  - <a rel="nofollow" href="pull_request12244">pull_request12244</a></td></tr>
<tr><td>2019-03-10&nbsp;02:59:30</td><td>ned.deily</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg337592">msg337592</a></td></tr>
<tr><td>2019-03-10&nbsp;02:58:28</td><td>ned.deily</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg337590">msg337590</a></td></tr>
<tr><td>2019-03-10&nbsp;02:36:45</td><td>miss-islington</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request12246">pull_request12246</a></td></tr>
<tr><td>2019-03-10&nbsp;02:10:28</td><td>miss-islington</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request12245">pull_request12245</a></td></tr>
<tr><td>2019-03-10&nbsp;02:10:14</td><td>miss-islington</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request12244">pull_request12244</a></td></tr>
<tr><td>2019-03-10&nbsp;02:09:53</td><td>ned.deily</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user12704">lukasz.langa</a><br />messages:
  + <a rel="nofollow" href="msg337588">msg337588</a><br /></td></tr>
<tr><td>2019-02-13&nbsp;06:30:08</td><td>xtreak</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user4455">benjamin.peterson</a><br />messages:
  + <a rel="nofollow" href="msg335386">msg335386</a><br /></td></tr>
<tr><td>2019-01-03&nbsp;08:01:23</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg332920">msg332920</a></td></tr>
<tr><td>2018-12-27&nbsp;10:21:23</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg332583">msg332583</a></td></tr>
<tr><td>2018-12-27&nbsp;06:58:31</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg332576">msg332576</a></td></tr>
<tr><td>2018-12-24&nbsp;09:59:22</td><td>serhiy.storchaka</td><td>set</td><td>priority: high -> release blocker<br />nosy:
  + <a rel="nofollow" href="user5248">ned.deily</a><br />type: behavior -> security<br /></td></tr>
<tr><td>2018-12-24&nbsp;03:44:50</td><td>ned.deily</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user15623">serhiy.storchaka</a><br /></td></tr>
<tr><td>2018-12-24&nbsp;03:42:28</td><td>ned.deily</td><td>set</td><td>keywords:
  + <a rel="nofollow" href="keyword15">security_issue</a><br />priority: normal -> high</td></tr>
<tr><td>2018-12-21&nbsp;20:57:07</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg332299">msg332299</a></td></tr>
<tr><td>2018-11-03&nbsp;04:02:30</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg329179">msg329179</a></td></tr>
<tr><td>2018-11-03&nbsp;02:12:48</td><td>Windson Yang</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user28180">Windson Yang</a><br />messages:
  + <a rel="nofollow" href="msg329176">msg329176</a><br /></td></tr>
<tr><td>2018-10-31&nbsp;12:36:05</td><td>xtreak</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user1741">orsenthil</a>, <a rel="nofollow" href="user14751">martin.panter</a><br /></td></tr>
<tr><td>2018-10-31&nbsp;11:27:17</td><td>xtreak</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg328985">msg328985</a><br />versions:
  + Python 3.8</td></tr>
<tr><td>2018-10-31&nbsp;10:29:16</td><td>xtreak</td><td>set</td><td>keywords:
  + <a rel="nofollow" href="keyword2">patch</a><br />stage: patch review<br />pull_requests:
  + <a rel="nofollow" href="pull_request9569">pull_request9569</a></td></tr>
<tr><td>2018-10-31&nbsp;10:24:45</td><td>西田雄治</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg328981">msg328981</a></td></tr>
<tr><td>2018-10-31&nbsp;08:15:02</td><td>xtreak</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user28746">xtreak</a><br />messages:
  + <a rel="nofollow" href="msg328975">msg328975</a><br /></td></tr>
<tr><td>2018-10-31&nbsp;06:52:48</td><td>西田雄治</td><td>create</td><td></td></tr>
</table>

</div>


</div> <!-- content-body -->
<div id="footer">
<div id="credits">
  Hosted on <a href="https://m.do.co/c/783434964889" title="Hosted on DigitalOcean">DigitalOcean</a>,
  <br>
  Supported by <a href="https://python.org/psf-landing/" title="The Python Software Foundation">The Python Software Foundation</a>,
  <br>
  Powered by <a href="http://roundup.sourceforge.net" title="Powered by the Roundup Issue Tracker">Roundup</a>
</div> <!-- credits -->
Copyright &copy; 1990-2020, <a href="http://python.org/psf">Python Software Foundation</a><br />
<a href="http://python.org/about/legal">Legal Statements</a>
</div> <!-- footer -->
</div> <!-- body-main -->
</div> <!-- content -->



</body>
</html>

