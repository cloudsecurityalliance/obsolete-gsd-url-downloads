<!DOCTYPE html>
<html lang='en'>
<head>
<title>openssh.git - Portable OpenSSH</title>
<meta name='generator' content='cgit v1.2.3'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://anongit.mindrot.org/openssh.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://github.com/openssh/openssh-portable' title='openssh.git Git repository'/>
<link rel='vcs-git' href='git://anongit.mindrot.org/openssh.git' title='openssh.git Git repository'/>
<link rel='vcs-git' href='https://anongit.mindrot.org/openssh.git' title='openssh.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='openssh.git' href='/openssh.git/'>openssh.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'/><select name='h' onchange='this.form.submit();'>
<option value='IBS'>IBS</option>
<option value='PRIVSEP'>PRIVSEP</option>
<option value='V_2_5_2'>V_2_5_2</option>
<option value='V_2_9_9'>V_2_9_9</option>
<option value='V_2_9_P1'>V_2_9_P1</option>
<option value='V_3_0_2'>V_3_0_2</option>
<option value='V_3_2_3'>V_3_2_3</option>
<option value='V_3_3'>V_3_3</option>
<option value='V_3_5'>V_3_5</option>
<option value='V_3_6'>V_3_6</option>
<option value='V_3_6_1'>V_3_6_1</option>
<option value='V_3_7'>V_3_7</option>
<option value='V_3_8'>V_3_8</option>
<option value='V_3_8_1'>V_3_8_1</option>
<option value='V_3_9'>V_3_9</option>
<option value='V_4_0'>V_4_0</option>
<option value='V_4_1'>V_4_1</option>
<option value='V_4_2'>V_4_2</option>
<option value='V_4_3'>V_4_3</option>
<option value='V_4_4'>V_4_4</option>
<option value='V_4_5'>V_4_5</option>
<option value='V_4_6'>V_4_6</option>
<option value='V_4_7'>V_4_7</option>
<option value='V_4_9'>V_4_9</option>
<option value='V_5_3'>V_5_3</option>
<option value='V_5_4'>V_5_4</option>
<option value='V_5_6'>V_5_6</option>
<option value='V_5_8'>V_5_8</option>
<option value='V_5_9'>V_5_9</option>
<option value='V_6_0'>V_6_0</option>
<option value='V_6_2'>V_6_2</option>
<option value='V_6_3'>V_6_3</option>
<option value='V_6_4'>V_6_4</option>
<option value='V_6_5'>V_6_5</option>
<option value='V_6_6'>V_6_6</option>
<option value='V_6_7'>V_6_7</option>
<option value='V_6_8'>V_6_8</option>
<option value='V_6_9'>V_6_9</option>
<option value='V_7_0'>V_7_0</option>
<option value='V_7_1'>V_7_1</option>
<option value='V_7_2'>V_7_2</option>
<option value='V_7_3'>V_7_3</option>
<option value='V_7_4'>V_7_4</option>
<option value='V_7_5'>V_7_5</option>
<option value='V_7_6'>V_7_6</option>
<option value='V_7_7'>V_7_7</option>
<option value='V_7_8'>V_7_8</option>
<option value='V_7_9'>V_7_9</option>
<option value='V_8_0'>V_8_0</option>
<option value='V_8_1'>V_8_1</option>
<option value='V_8_2'>V_8_2</option>
<option value='V_8_3'>V_8_3</option>
<option value='V_8_4'>V_8_4</option>
<option value='V_8_5'>V_8_5</option>
<option value='V_8_6'>V_8_6</option>
<option value='V_8_7'>V_8_7</option>
<option value='V_8_8'>V_8_8</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Portable OpenSSH</td><td class='sub right'></td></tr></table>
<table class='tabs'><tr><td>
<a href='/openssh.git/'>summary</a><a href='/openssh.git/refs/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>refs</a><a href='/openssh.git/log/'>log</a><a href='/openssh.git/tree/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>tree</a><a class='active' href='/openssh.git/commit/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>commit</a><a href='/openssh.git/diff/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>diff</a></td><td class='form'><form class='right' method='get' action='/openssh.git/log/'>
<input type='hidden' name='id' value='ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>djm@openbsd.org &lt;djm@openbsd.org&gt;</td><td class='right'>2016-01-13 23:04:47 +0000</td></tr>
<tr><th>committer</th><td>Damien Miller &lt;djm@mindrot.org&gt;</td><td class='right'>2016-01-14 10:06:01 +1100</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/openssh.git/commit/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c</a> (<a href='/openssh.git/patch/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/openssh.git/tree/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>008ac3334471370857e32b48893cb6f07d28e987</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/openssh.git/commit/?id=9a728cc918fad67c8a9a71201088b1e150340ba4'>9a728cc918fad67c8a9a71201088b1e150340ba4</a> (<a href='/openssh.git/diff/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c&amp;id2=9a728cc918fad67c8a9a71201088b1e150340ba4'>diff</a>)</td></tr></table>
<div class='commit-subject'>upstream commit</div><div class='commit-msg'>eliminate fallback from untrusted X11 forwarding to trusted
 forwarding when the X server disables the SECURITY extension; Reported by
 Thomas Hoger; ok deraadt@

Upstream-ID: f76195bd2064615a63ef9674a0e4096b0713f938
</div><div class='diffstat-header'><a href='/openssh.git/diff/?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/openssh.git/diff/clientloop.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>clientloop.c</a></td><td class='right'>114</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 61.4%;'/><td class='rem' style='width: 38.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/openssh.git/diff/clientloop.h?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>clientloop.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.8%;'/><td class='rem' style='width: 1.8%;'/><td class='none' style='width: 96.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/openssh.git/diff/mux.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>mux.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 10.5%;'/><td class='rem' style='width: 8.8%;'/><td class='none' style='width: 80.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/openssh.git/diff/ssh.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>ssh.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 7.9%;'/><td class='rem' style='width: 12.3%;'/><td class='none' style='width: 79.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 93 insertions, 70 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/clientloop.c b/clientloop.c<br/>index f5554519..c0386d56 100644<br/>--- a/<a href='/openssh.git/tree/clientloop.c?id=9a728cc918fad67c8a9a71201088b1e150340ba4'>clientloop.c</a><br/>+++ b/<a href='/openssh.git/tree/clientloop.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>clientloop.c</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-/* $OpenBSD: clientloop.c,v 1.278 2015/12/26 07:46:03 semarie Exp $ */</div><div class='add'>+/* $OpenBSD: clientloop.c,v 1.279 2016/01/13 23:04:47 djm Exp $ */</div><div class='ctx'> /*</div><div class='ctx'>  * Author: Tatu Ylonen &lt;ylo@cs.hut.fi&gt;</div><div class='ctx'>  * Copyright (c) 1995 Tatu Ylonen &lt;ylo@cs.hut.fi&gt;, Espoo, Finland</div><div class='hunk'>@@ -288,6 +288,9 @@ client_x11_display_valid(const char *display)</div><div class='ctx'> {</div><div class='ctx'> 	size_t i, dlen;</div><div class='ctx'> </div><div class='add'>+	if (display == NULL)</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	dlen = strlen(display);</div><div class='ctx'> 	for (i = 0; i &lt; dlen; i++) {</div><div class='ctx'> 		if (!isalnum((u_char)display[i]) &amp;&amp;</div><div class='hunk'>@@ -301,34 +304,33 @@ client_x11_display_valid(const char *display)</div><div class='ctx'> </div><div class='ctx'> #define SSH_X11_PROTO		"MIT-MAGIC-COOKIE-1"</div><div class='ctx'> #define X11_TIMEOUT_SLACK	60</div><div class='del'>-void</div><div class='add'>+int</div><div class='ctx'> client_x11_get_proto(const char *display, const char *xauth_path,</div><div class='ctx'>     u_int trusted, u_int timeout, char **_proto, char **_data)</div><div class='ctx'> {</div><div class='del'>-	char cmd[1024];</div><div class='del'>-	char line[512];</div><div class='del'>-	char xdisplay[512];</div><div class='add'>+	char cmd[1024], line[512], xdisplay[512];</div><div class='add'>+	char xauthfile[PATH_MAX], xauthdir[PATH_MAX];</div><div class='ctx'> 	static char proto[512], data[512];</div><div class='ctx'> 	FILE *f;</div><div class='del'>-	int got_data = 0, generated = 0, do_unlink = 0, i;</div><div class='del'>-	char xauthdir[PATH_MAX] = "", xauthfile[PATH_MAX] = "";</div><div class='add'>+	int got_data = 0, generated = 0, do_unlink = 0, i, r;</div><div class='ctx'> 	struct stat st;</div><div class='ctx'> 	u_int now, x11_timeout_real;</div><div class='ctx'> </div><div class='ctx'> 	*_proto = proto;</div><div class='ctx'> 	*_data = data;</div><div class='del'>-	proto[0] = data[0] = '\0';</div><div class='add'>+	proto[0] = data[0] = xauthfile[0] = xauthdir[0] = '\0';</div><div class='ctx'> </div><div class='del'>-	if (xauth_path == NULL ||(stat(xauth_path, &amp;st) == -1)) {</div><div class='del'>-		debug("No xauth program.");</div><div class='del'>-	} else if (!client_x11_display_valid(display)) {</div><div class='del'>-		logit("DISPLAY '%s' invalid, falling back to fake xauth data",</div><div class='add'>+	if (!client_x11_display_valid(display)) {</div><div class='add'>+		logit("DISPLAY \"%s\" invalid; disabling X11 forwarding",</div><div class='ctx'> 		    display);</div><div class='del'>-	} else {</div><div class='del'>-		if (display == NULL) {</div><div class='del'>-			debug("x11_get_proto: DISPLAY not set");</div><div class='del'>-			return;</div><div class='del'>-		}</div><div class='add'>+		return -1;</div><div class='add'>+	}</div><div class='add'>+	if (xauth_path != NULL &amp;&amp; stat(xauth_path, &amp;st) == -1) {</div><div class='add'>+		debug("No xauth program.");</div><div class='add'>+		xauth_path = NULL;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	if (xauth_path != NULL) {</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * Handle FamilyLocal case where $DISPLAY does</div><div class='ctx'> 		 * not match an authorization entry.  For this we</div><div class='hunk'>@@ -337,43 +339,60 @@ client_x11_get_proto(const char *display, const char *xauth_path,</div><div class='ctx'> 		 *      is not perfect.</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (strncmp(display, "localhost:", 10) == 0) {</div><div class='del'>-			snprintf(xdisplay, sizeof(xdisplay), "unix:%s",</div><div class='del'>-			    display + 10);</div><div class='add'>+			if ((r = snprintf(xdisplay, sizeof(xdisplay), "unix:%s",</div><div class='add'>+			    display + 10)) &lt; 0 ||</div><div class='add'>+			    (size_t)r &gt;= sizeof(xdisplay)) {</div><div class='add'>+				error("%s: display name too long", __func__);</div><div class='add'>+				return -1;</div><div class='add'>+			}</div><div class='ctx'> 			display = xdisplay;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (trusted == 0) {</div><div class='del'>-			mktemp_proto(xauthdir, PATH_MAX);</div><div class='ctx'> 			/*</div><div class='add'>+			 * Generate an untrusted X11 auth cookie.</div><div class='add'>+			 *</div><div class='ctx'> 			 * The authentication cookie should briefly outlive</div><div class='ctx'> 			 * ssh's willingness to forward X11 connections to</div><div class='ctx'> 			 * avoid nasty fail-open behaviour in the X server.</div><div class='ctx'> 			 */</div><div class='add'>+			mktemp_proto(xauthdir, sizeof(xauthdir));</div><div class='add'>+			if (mkdtemp(xauthdir) == NULL) {</div><div class='add'>+				error("%s: mkdtemp: %s",</div><div class='add'>+				    __func__, strerror(errno));</div><div class='add'>+				return -1;</div><div class='add'>+			}</div><div class='add'>+			do_unlink = 1;</div><div class='add'>+			if ((r = snprintf(xauthfile, sizeof(xauthfile),</div><div class='add'>+			    "%s/xauthfile", xauthdir)) &lt; 0 ||</div><div class='add'>+			    (size_t)r &gt;= sizeof(xauthfile)) {</div><div class='add'>+				error("%s: xauthfile path too long", __func__);</div><div class='add'>+				unlink(xauthfile);</div><div class='add'>+				rmdir(xauthdir);</div><div class='add'>+				return -1;</div><div class='add'>+			}</div><div class='add'>+</div><div class='ctx'> 			if (timeout &gt;= UINT_MAX - X11_TIMEOUT_SLACK)</div><div class='ctx'> 				x11_timeout_real = UINT_MAX;</div><div class='ctx'> 			else</div><div class='ctx'> 				x11_timeout_real = timeout + X11_TIMEOUT_SLACK;</div><div class='del'>-			if (mkdtemp(xauthdir) != NULL) {</div><div class='del'>-				do_unlink = 1;</div><div class='del'>-				snprintf(xauthfile, PATH_MAX, "%s/xauthfile",</div><div class='del'>-				    xauthdir);</div><div class='del'>-				snprintf(cmd, sizeof(cmd),</div><div class='del'>-				    "%s -f %s generate %s " SSH_X11_PROTO</div><div class='del'>-				    " untrusted timeout %u 2&gt;" _PATH_DEVNULL,</div><div class='del'>-				    xauth_path, xauthfile, display,</div><div class='del'>-				    x11_timeout_real);</div><div class='del'>-				debug2("x11_get_proto: %s", cmd);</div><div class='del'>-				if (x11_refuse_time == 0) {</div><div class='del'>-					now = monotime() + 1;</div><div class='del'>-					if (UINT_MAX - timeout &lt; now)</div><div class='del'>-						x11_refuse_time = UINT_MAX;</div><div class='del'>-					else</div><div class='del'>-						x11_refuse_time = now + timeout;</div><div class='del'>-					channel_set_x11_refuse_time(</div><div class='del'>-					    x11_refuse_time);</div><div class='del'>-				}</div><div class='del'>-				if (system(cmd) == 0)</div><div class='del'>-					generated = 1;</div><div class='add'>+			if ((r = snprintf(cmd, sizeof(cmd),</div><div class='add'>+			    "%s -f %s generate %s " SSH_X11_PROTO</div><div class='add'>+			    " untrusted timeout %u 2&gt;" _PATH_DEVNULL,</div><div class='add'>+			    xauth_path, xauthfile, display,</div><div class='add'>+			    x11_timeout_real)) &lt; 0 ||</div><div class='add'>+			    (size_t)r &gt;= sizeof(cmd))</div><div class='add'>+				fatal("%s: cmd too long", __func__);</div><div class='add'>+			debug2("%s: %s", __func__, cmd);</div><div class='add'>+			if (x11_refuse_time == 0) {</div><div class='add'>+				now = monotime() + 1;</div><div class='add'>+				if (UINT_MAX - timeout &lt; now)</div><div class='add'>+					x11_refuse_time = UINT_MAX;</div><div class='add'>+				else</div><div class='add'>+					x11_refuse_time = now + timeout;</div><div class='add'>+				channel_set_x11_refuse_time(x11_refuse_time);</div><div class='ctx'> 			}</div><div class='add'>+			if (system(cmd) == 0)</div><div class='add'>+				generated = 1;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		/*</div><div class='hunk'>@@ -395,9 +414,7 @@ client_x11_get_proto(const char *display, const char *xauth_path,</div><div class='ctx'> 				got_data = 1;</div><div class='ctx'> 			if (f)</div><div class='ctx'> 				pclose(f);</div><div class='del'>-		} else</div><div class='del'>-			error("Warning: untrusted X11 forwarding setup failed: "</div><div class='del'>-			    "xauth key data not generated");</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (do_unlink) {</div><div class='hunk'>@@ -405,6 +422,13 @@ client_x11_get_proto(const char *display, const char *xauth_path,</div><div class='ctx'> 		rmdir(xauthdir);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	/* Don't fall back to fake X11 data for untrusted forwarding */</div><div class='add'>+	if (!trusted &amp;&amp; !got_data) {</div><div class='add'>+		error("Warning: untrusted X11 forwarding setup failed: "</div><div class='add'>+		    "xauth key data not generated");</div><div class='add'>+		return -1;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * If we didn't get authentication data, just make up some</div><div class='ctx'> 	 * data.  The forwarding code will check the validity of the</div><div class='hunk'>@@ -427,6 +451,8 @@ client_x11_get_proto(const char *display, const char *xauth_path,</div><div class='ctx'> 			rnd &gt;&gt;= 8;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/clientloop.h b/clientloop.h<br/>index 338d4518..f4d4c69b 100644<br/>--- a/<a href='/openssh.git/tree/clientloop.h?id=9a728cc918fad67c8a9a71201088b1e150340ba4'>clientloop.h</a><br/>+++ b/<a href='/openssh.git/tree/clientloop.h?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>clientloop.h</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-/* $OpenBSD: clientloop.h,v 1.31 2013/06/02 23:36:29 dtucker Exp $ */</div><div class='add'>+/* $OpenBSD: clientloop.h,v 1.32 2016/01/13 23:04:47 djm Exp $ */</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='ctx'>  * Author: Tatu Ylonen &lt;ylo@cs.hut.fi&gt;</div><div class='hunk'>@@ -39,7 +39,7 @@</div><div class='ctx'> </div><div class='ctx'> /* Client side main loop for the interactive session. */</div><div class='ctx'> int	 client_loop(int, int, int);</div><div class='del'>-void	 client_x11_get_proto(const char *, const char *, u_int, u_int,</div><div class='add'>+int	 client_x11_get_proto(const char *, const char *, u_int, u_int,</div><div class='ctx'> 	    char **, char **);</div><div class='ctx'> void	 client_global_request_reply_fwd(int, u_int32_t, void *);</div><div class='ctx'> void	 client_session2_setup(int, int, int, const char *, struct termios *,</div><div class='head'>diff --git a/mux.c b/mux.c<br/>index f9c3af65..6bf53ebd 100644<br/>--- a/<a href='/openssh.git/tree/mux.c?id=9a728cc918fad67c8a9a71201088b1e150340ba4'>mux.c</a><br/>+++ b/<a href='/openssh.git/tree/mux.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>mux.c</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-/* $OpenBSD: mux.c,v 1.57 2015/12/26 07:46:03 semarie Exp $ */</div><div class='add'>+/* $OpenBSD: mux.c,v 1.58 2016/01/13 23:04:47 djm Exp $ */</div><div class='ctx'> /*</div><div class='ctx'>  * Copyright (c) 2002-2008 Damien Miller &lt;djm@openbsd.org&gt;</div><div class='ctx'>  *</div><div class='hunk'>@@ -1354,16 +1354,18 @@ mux_session_confirm(int id, int success, void *arg)</div><div class='ctx'> 		char *proto, *data;</div><div class='ctx'> </div><div class='ctx'> 		/* Get reasonable local authentication information. */</div><div class='del'>-		client_x11_get_proto(display, options.xauth_location,</div><div class='add'>+		if (client_x11_get_proto(display, options.xauth_location,</div><div class='ctx'> 		    options.forward_x11_trusted, options.forward_x11_timeout,</div><div class='del'>-		    &amp;proto, &amp;data);</div><div class='del'>-		/* Request forwarding with authentication spoofing. */</div><div class='del'>-		debug("Requesting X11 forwarding with authentication "</div><div class='del'>-		    "spoofing.");</div><div class='del'>-		x11_request_forwarding_with_spoofing(id, display, proto,</div><div class='del'>-		    data, 1);</div><div class='del'>-		client_expect_confirm(id, "X11 forwarding", CONFIRM_WARN);</div><div class='del'>-		/* XXX exit_on_forward_failure */</div><div class='add'>+		    &amp;proto, &amp;data) == 0) {</div><div class='add'>+			/* Request forwarding with authentication spoofing. */</div><div class='add'>+			debug("Requesting X11 forwarding with authentication "</div><div class='add'>+			    "spoofing.");</div><div class='add'>+			x11_request_forwarding_with_spoofing(id, display, proto,</div><div class='add'>+			    data, 1);</div><div class='add'>+			/* XXX exit_on_forward_failure */</div><div class='add'>+			client_expect_confirm(id, "X11 forwarding",</div><div class='add'>+			    CONFIRM_WARN);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (cctx-&gt;want_agent_fwd &amp;&amp; options.forward_agent) {</div><div class='head'>diff --git a/ssh.c b/ssh.c<br/>index 81704ab3..096c5b5d 100644<br/>--- a/<a href='/openssh.git/tree/ssh.c?id=9a728cc918fad67c8a9a71201088b1e150340ba4'>ssh.c</a><br/>+++ b/<a href='/openssh.git/tree/ssh.c?id=ed4ce82dbfa8a3a3c8ea6fa0db113c71e234416c'>ssh.c</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-/* $OpenBSD: ssh.c,v 1.432 2015/12/11 03:20:09 djm Exp $ */</div><div class='add'>+/* $OpenBSD: ssh.c,v 1.433 2016/01/13 23:04:47 djm Exp $ */</div><div class='ctx'> /*</div><div class='ctx'>  * Author: Tatu Ylonen &lt;ylo@cs.hut.fi&gt;</div><div class='ctx'>  * Copyright (c) 1995 Tatu Ylonen &lt;ylo@cs.hut.fi&gt;, Espoo, Finland</div><div class='hunk'>@@ -1626,6 +1626,7 @@ ssh_session(void)</div><div class='ctx'> 	struct winsize ws;</div><div class='ctx'> 	char *cp;</div><div class='ctx'> 	const char *display;</div><div class='add'>+	char *proto = NULL, *data = NULL;</div><div class='ctx'> </div><div class='ctx'> 	/* Enable compression if requested. */</div><div class='ctx'> 	if (options.compression) {</div><div class='hunk'>@@ -1696,13 +1697,9 @@ ssh_session(void)</div><div class='ctx'> 	display = getenv("DISPLAY");</div><div class='ctx'> 	if (display == NULL &amp;&amp; options.forward_x11)</div><div class='ctx'> 		debug("X11 forwarding requested but DISPLAY not set");</div><div class='del'>-	if (options.forward_x11 &amp;&amp; display != NULL) {</div><div class='del'>-		char *proto, *data;</div><div class='del'>-		/* Get reasonable local authentication information. */</div><div class='del'>-		client_x11_get_proto(display, options.xauth_location,</div><div class='del'>-		    options.forward_x11_trusted,</div><div class='del'>-		    options.forward_x11_timeout,</div><div class='del'>-		    &amp;proto, &amp;data);</div><div class='add'>+	if (options.forward_x11 &amp;&amp; client_x11_get_proto(display,</div><div class='add'>+	    options.xauth_location, options.forward_x11_trusted,</div><div class='add'>+	    options.forward_x11_timeout, &amp;proto, &amp;data) == 0) {</div><div class='ctx'> 		/* Request forwarding with authentication spoofing. */</div><div class='ctx'> 		debug("Requesting X11 forwarding with authentication "</div><div class='ctx'> 		    "spoofing.");</div><div class='hunk'>@@ -1792,6 +1789,7 @@ ssh_session2_setup(int id, int success, void *arg)</div><div class='ctx'> 	extern char **environ;</div><div class='ctx'> 	const char *display;</div><div class='ctx'> 	int interactive = tty_flag;</div><div class='add'>+	char *proto = NULL, *data = NULL;</div><div class='ctx'> </div><div class='ctx'> 	if (!success)</div><div class='ctx'> 		return; /* No need for error message, channels code sens one */</div><div class='hunk'>@@ -1799,12 +1797,9 @@ ssh_session2_setup(int id, int success, void *arg)</div><div class='ctx'> 	display = getenv("DISPLAY");</div><div class='ctx'> 	if (display == NULL &amp;&amp; options.forward_x11)</div><div class='ctx'> 		debug("X11 forwarding requested but DISPLAY not set");</div><div class='del'>-	if (options.forward_x11 &amp;&amp; display != NULL) {</div><div class='del'>-		char *proto, *data;</div><div class='del'>-		/* Get reasonable local authentication information. */</div><div class='del'>-		client_x11_get_proto(display, options.xauth_location,</div><div class='del'>-		    options.forward_x11_trusted,</div><div class='del'>-		    options.forward_x11_timeout, &amp;proto, &amp;data);</div><div class='add'>+	if (options.forward_x11 &amp;&amp; client_x11_get_proto(display,</div><div class='add'>+	    options.xauth_location, options.forward_x11_trusted,</div><div class='add'>+	    options.forward_x11_timeout, &amp;proto, &amp;data) == 0) {</div><div class='ctx'> 		/* Request forwarding with authentication spoofing. */</div><div class='ctx'> 		debug("Requesting X11 forwarding with authentication "</div><div class='ctx'> 		    "spoofing.");</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.3</a> (<a href='https://git-scm.com/'>git 2.25.1</a>) at 2021-10-30 15:46:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
