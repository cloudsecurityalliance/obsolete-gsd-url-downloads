<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>12adc723acf02633595a4d8da8345742729f46c0 - aom - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><link rel="stylesheet" type="text/css" href="/+static/doc.css"><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://aomedia.googlesource.com/login/aom/%2B/12adc723acf02633595a4d8da8345742729f46c0">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">aomedia</a> / <a class="Breadcrumbs-crumb" href="/aom/">aom</a> / <span class="Breadcrumbs-crumb">12adc723acf02633595a4d8da8345742729f46c0</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>12adc723acf02633595a4d8da8345742729f46c0</td><td><span>[<a href="/aom/+log/12adc723acf02633595a4d8da8345742729f46c0">log</a>]</span> <span>[<a href="/aom/+archive/12adc723acf02633595a4d8da8345742729f46c0.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Wan-Teh Chang &lt;wtc@google.com&gt;</td><td>Fri Apr 30 14:45:52 2021 -0700</td></tr><tr><th class="Metadata-title">committer</th><td>Wan-Teh Chang &lt;wtc@google.com&gt;</td><td>Sat May 01 00:32:00 2021 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/">c34488c0d1841ce9c70ad15e0fedf54c87c9f338</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0%5E">4efe20e99dcd9b6f8eadc8de8acc825be7416578</a> <span>[<a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">aom_dsp: Fix aom_noise_strength_lut_init with zero size

Return 0 when lut size is zero. aom_noise_strength_lut_eval() assumes
lut size is nonzero. For example, it accesses lut-&gt;points[0] and
lut-&gt;points[lut-&gt;num_points - 1] without checking lut-&gt;num_points.

Also handle the failure of aom_noise_strength_solver_fit_piecewise().

BUG=aomedia:2999

Change-Id: <a href="https://aomedia-review.googlesource.com/#/q/I19858c8bd097f523f6316effedb5e3b9acd2e4b7">I19858c8bd097f523f6316effedb5e3b9acd2e4b7</a>
</pre><ul class="DiffTree"><li><a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_dsp/noise_model.c">aom_dsp/noise_model.c</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0%5E%21/#F0">diff</a>]</span></li><li><a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/test/noise_model_test.cc">test/noise_model_test.cc</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0%5E%21/#F1">diff</a>]</span></li></ul><div class="DiffSummary">2 files changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: c34488c0d1841ce9c70ad15e0fedf54c87c9f338</div><ol class="FileList"><li class="FileList-item FileList-item--regularFile" title="Regular file - .clang-format"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/.clang-format">.clang-format</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .cmake-format.py"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/.cmake-format.py">.cmake-format.py</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitattributes"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/.gitattributes">.gitattributes</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitignore"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/.gitignore">.gitignore</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .mailmap"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/.mailmap">.mailmap</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - AUTHORS"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/AUTHORS">AUTHORS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CHANGELOG"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/CHANGELOG">CHANGELOG</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CMakeLists.txt"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/CMakeLists.txt">CMakeLists.txt</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - LICENSE"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/LICENSE">LICENSE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - PATENTS"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/PATENTS">PATENTS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README.md"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/README.md">README.md</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Sample.cfg"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/Sample.cfg">Sample.cfg</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom/">aom/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom_dsp/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_dsp/">aom_dsp/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom_mem/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_mem/">aom_mem/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom_ports/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_ports/">aom_ports/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom_scale/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_scale/">aom_scale/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - aom_util/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aom_util/">aom_util/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - aomedia_logo_200.png"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/aomedia_logo_200.png">aomedia_logo_200.png</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - apps/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/apps/">apps/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - av1/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/av1/">av1/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - build/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/build/">build/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - codereview.settings"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/codereview.settings">codereview.settings</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - common/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/common/">common/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - doc/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/doc/">doc/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - docs.cmake"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/docs.cmake">docs.cmake</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - examples/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/examples/">examples/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - keywords.dox"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/keywords.dox">keywords.dox</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - libs.doxy_template"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/libs.doxy_template">libs.doxy_template</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - mainpage.dox"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/mainpage.dox">mainpage.dox</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - stats/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/stats/">stats/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - test/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/test/">test/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - third_party/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/third_party/">third_party/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tools/"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/tools/">tools/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - usage.dox"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/usage.dox">usage.dox</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - usage_cx.dox"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/usage_cx.dox">usage_cx.dox</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - usage_dx.dox"><a class="FileList-itemLink" href="/aom/+/12adc723acf02633595a4d8da8345742729f46c0/usage_dx.dox">usage_dx.dox</a></li></ol><div class="InlineReadme"><div class="InlineReadme-path">README.md</div><div class="doc"><h1><a class="h" name="LREADME" href="#LREADME"><span></span></a><a class="h" name="lreadme" href="#lreadme"><span></span></a>README.md</h1><h1><a class="h" name="AV1-Codec-Library" href="#AV1-Codec-Library"><span></span></a><a class="h" name="av1-codec-library" href="#av1-codec-library"><span></span></a>AV1 Codec Library</h1><h2><a class="h" name="Contents" href="#Contents"><span></span></a><a class="h" name="contents" href="#contents"><span></span></a>Contents</h2><ol><li><a href="#building-the-library-and-applications">Building the lib and applications</a><ul><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#get-the-code">Get the code</a></li><li><a href="#basic-build">Basics</a></li><li><a href="#configuration-options">Configuration options</a></li><li><a href="#dylib-builds">Dylib builds</a></li><li><a href="#debugging">Debugging</a></li><li><a href="#cross-compiling">Cross compiling</a></li><li><a href="#sanitizers">Sanitizer support</a></li><li><a href="#microsoft-visual-studio-builds">MSVC builds</a></li><li><a href="#xcode-builds">Xcode builds</a></li><li><a href="#emscripten-builds">Emscripten builds</a></li><li><a href="#extra-build-flags">Extra Build Flags</a></li><li><a href="#build-with-vmaf">Build with VMAF support</a></li></ul></li><li><a href="#testing-the-av1-codec">Testing the library</a><ul><li><a href="#testing-basics">Basics</a><ul><li><a href="#1_unit-tests">Unit tests</a></li><li><a href="#2_example-tests">Example tests</a></li><li><a href="#3_encoder-tests">Encoder tests</a></li></ul></li><li><a href="#ide-hosted-tests">IDE hosted tests</a></li><li><a href="#downloading-the-test-data">Downloading test data</a></li><li><a href="#adding-a-new-test-data-file">Adding a new test data file</a></li><li><a href="#additional-test-data">Additional test data</a></li><li><a href="#sharded-testing">Sharded testing</a><ul><li><a href="#1_running-test_libaom-directly">Running tests directly</a></li><li><a href="#2_running-the-tests-via-the-cmake-build">Running tests via CMake</a></li></ul></li></ul></li><li><a href="#coding-style">Coding style</a></li><li><a href="#submitting-patches">Submitting patches</a><ul><li><a href="#login-cookie">Login cookie</a></li><li><a href="#contributor-agreement">Contributor agreement</a></li><li><a href="#testing-your-code">Testing your code</a></li><li><a href="#commit-message-hook">Commit message hook</a></li><li><a href="#upload-your-change">Upload your change</a></li><li><a href="#incorporating-reviewer-comments">Incorporating Reviewer Comments</a></li><li><a href="#submitting-your-change">Submitting your change</a></li><li><a href="#viewing-the-status-of-uploaded-changes">Viewing change status</a></li></ul></li><li><a href="#support">Support</a></li><li><a href="#bug-reports">Bug reports</a></li></ol><h2><a class="h" name="building-the-library-and-applications" href="#building-the-library-and-applications"><span></span></a>Building the library and applications</h2><h3><a class="h" name="prerequisites" href="#prerequisites"><span></span></a>Prerequisites</h3><ol><li><a href="https://cmake.org">CMake</a> version 3.5 or higher.</li><li><a href="https://git-scm.com/">Git</a>.</li><li><a href="https://www.perl.org/">Perl</a>.</li><li>For x86 targets, <a href="http://yasm.tortall.net/">yasm</a>, which is preferred, or a recent version of <a href="http://www.nasm.us/">nasm</a>. If you download yasm with the intention to work with Visual Studio, please download win32.exe or win64.exe and rename it into yasm.exe. DO NOT download or use vsyasm.exe.</li><li>Building the documentation requires <a href="http://doxygen.org">doxygen version 1.8.10 or newer</a>.</li><li>Building the unit tests requires <a href="https://www.python.org/">Python</a>.</li><li>Emscripten builds require the portable <a href="https://kripken.github.io/emscripten-site/index.html">EMSDK</a>.</li></ol><h3><a class="h" name="get-the-code" href="#get-the-code"><span></span></a>Get the code</h3><p>The AV1 library source code is stored in the Alliance for Open Media Git repository:</p><pre class="code">    $ git clone https://aomedia.googlesource.com/aom
    # By default, the above command stores the source in the aom directory:
    $ cd aom
</pre><h3><a class="h" name="basic-build" href="#basic-build"><span></span></a>Basic build</h3><p>CMake replaces the configure step typical of many projects. Running CMake will produce configuration and build files for the currently selected CMake generator. For most systems the default generator is Unix Makefiles. The basic form of a makefile build is the following:</p><pre class="code">    $ cmake path/to/aom
    $ make
</pre><p>The above will generate a makefile build that produces the AV1 library and applications for the current host system after the make step completes successfully. The compiler chosen varies by host platform, but a general rule applies: On systems where cc and c++ are present in $PATH at the time CMake is run the generated build will use cc and c++ by default.</p><h3><a class="h" name="configuration-options" href="#configuration-options"><span></span></a>Configuration options</h3><p>The AV1 codec library has a great many configuration options. These come in two varieties:</p><ol><li>Build system configuration options. These have the form <code class="code">ENABLE_FEATURE</code>.</li><li>AV1 codec configuration options. These have the form <code class="code">CONFIG_FEATURE</code>.</li></ol><p>Both types of options are set at the time CMake is run. The following example enables ccache and disables the AV1 encoder:</p><pre class="code">    $ cmake path/to/aom -DENABLE_CCACHE=1 -DCONFIG_AV1_ENCODER=0
    $ make
</pre><p>The available configuration options are too numerous to list here. Build system configuration options can be found at the top of the CMakeLists.txt file found in the root of the AV1 repository, and AV1 codec configuration options can currently be found in the file <code class="code">build/cmake/aom_config_defaults.cmake</code>.</p><h3><a class="h" name="dylib-builds" href="#dylib-builds"><span></span></a>Dylib builds</h3><p>A dylib (shared object) build of the AV1 codec library can be enabled via the CMake built in variable <code class="code">BUILD_SHARED_LIBS</code>:</p><pre class="code">    $ cmake path/to/aom -DBUILD_SHARED_LIBS=1
    $ make
</pre><p>This is currently only supported on non-Windows targets.</p><h3><a class="h" name="debugging" href="#debugging"><span></span></a>Debugging</h3><p>Depending on the generator used there are multiple ways of going about debugging AV1 components. For single configuration generators like the Unix Makefiles generator, setting <code class="code">CMAKE_BUILD_TYPE</code> to Debug is sufficient:</p><pre class="code">    $ cmake path/to/aom -DCMAKE_BUILD_TYPE=Debug
</pre><p>For Xcode, mainly because configuration controls for Xcode builds are buried two configuration windows deep and must be set for each subproject within the Xcode IDE individually, <code class="code">CMAKE_CONFIGURATION_TYPES</code> should be set to Debug:</p><pre class="code">    $ cmake path/to/aom -G Xcode -DCMAKE_CONFIGURATION_TYPES=Debug
</pre><p>For Visual Studio the in-IDE configuration controls should be used. Simply set the IDE project configuration to Debug to allow for stepping through the code.</p><p>In addition to the above it can sometimes be useful to debug only C and C++ code. To disable all assembly code and intrinsics set <code class="code">AOM_TARGET_CPU</code> to generic at generation time:</p><pre class="code">    $ cmake path/to/aom -DAOM_TARGET_CPU=generic
</pre><h3><a class="h" name="cross-compiling" href="#cross-compiling"><span></span></a>Cross compiling</h3><p>For the purposes of building the AV1 codec and applications and relative to the scope of this guide, all builds for architectures differing from the native host architecture will be considered cross compiles. The AV1 CMake build handles cross compiling via the use of toolchain files included in the AV1 repository. The toolchain files available at the time of this writing are:</p><ul><li>arm64-ios.cmake</li><li>arm64-linux-gcc.cmake</li><li>arm64-mingw-gcc.cmake</li><li>armv7-ios.cmake</li><li>armv7-linux-gcc.cmake</li><li>armv7-mingw-gcc.cmake</li><li>armv7s-ios.cmake</li><li>mips32-linux-gcc.cmake</li><li>mips64-linux-gcc.cmake</li><li>x86-ios-simulator.cmake</li><li>x86-linux.cmake</li><li>x86-macos.cmake</li><li>x86-mingw-gcc.cmake</li><li>x86_64-ios-simulator.cmake</li><li>x86_64-mingw-gcc.cmake</li></ul><p>The following example demonstrates use of the x86-macos.cmake toolchain file on a x86_64 MacOS host:</p><pre class="code">    $ cmake path/to/aom \
      -DCMAKE_TOOLCHAIN_FILE=path/to/aom/build/cmake/toolchains/x86-macos.cmake
    $ make
</pre><p>To build for an unlisted target creation of a new toolchain file is the best solution. The existing toolchain files can be used a starting point for a new toolchain file since each one exposes the basic requirements for toolchain files as used in the AV1 codec build.</p><p>As a temporary work around an unoptimized AV1 configuration that builds only C and C++ sources can be produced using the following commands:</p><pre class="code">    $ cmake path/to/aom -DAOM_TARGET_CPU=generic
    $ make
</pre><p>In addition to the above it&#39;s important to note that the toolchain files suffixed with gcc behave differently than the others. These toolchain files attempt to obey the $CROSS environment variable.</p><h3><a class="h" name="sanitizers" href="#sanitizers"><span></span></a>Sanitizers</h3><p>Sanitizer integration is built-in to the CMake build system. To enable a sanitizer, add <code class="code">-DSANITIZE=&lt;type&gt;</code> to the CMake command line. For example, to enable address sanitizer:</p><pre class="code">    $ cmake path/to/aom -DSANITIZE=address
    $ make
</pre><p>Sanitizers available vary by platform, target, and compiler. Consult your compiler documentation to determine which, if any, are available.</p><h3><a class="h" name="microsoft-visual-studio-builds" href="#microsoft-visual-studio-builds"><span></span></a>Microsoft Visual Studio builds</h3><p>Building the AV1 codec library in Microsoft Visual Studio is supported. Visual Studio 2017 (15.0) or later is required. The following example demonstrates generating projects and a solution for the Microsoft IDE:</p><pre class="code">    # This does not require a bash shell; Command Prompt (cmd.exe) is fine.
    # This assumes the build host is a Windows x64 computer.

    # To build with Visual Studio 2019 for the x64 target:
    $ cmake path/to/aom -G &quot;Visual Studio 16 2019&quot;
    $ cmake --build .

    # To build with Visual Studio 2019 for the 32-bit x86 target:
    $ cmake path/to/aom -G &quot;Visual Studio 16 2019&quot; -A Win32
    $ cmake --build .

    # To build with Visual Studio 2017 for the x64 target:
    $ cmake path/to/aom -G &quot;Visual Studio 15 2017&quot; -T host=x64 -A x64
    $ cmake --build .

    # To build with Visual Studio 2017 for the 32-bit x86 target:
    $ cmake path/to/aom -G &quot;Visual Studio 15 2017&quot; -T host=x64
    $ cmake --build .
</pre><p>NOTE: The build system targets Windows 7 or later by compiling files with <code class="code">-D_WIN32_WINNT=0x0601</code>.</p><h3><a class="h" name="xcode-builds" href="#xcode-builds"><span></span></a>Xcode builds</h3><p>Building the AV1 codec library in Xcode is supported. The following example demonstrates generating an Xcode project:</p><pre class="code">    $ cmake path/to/aom -G Xcode
</pre><h3><a class="h" name="emscripten-builds" href="#emscripten-builds"><span></span></a>Emscripten builds</h3><p>Building the AV1 codec library with Emscripten is supported. Typically this is used to hook into the AOMAnalyzer GUI application. These instructions focus on using the inspector with AOMAnalyzer, but all tools can be built with Emscripten.</p><p>It is assumed here that you have already downloaded and installed the EMSDK, installed and activated at least one toolchain, and setup your environment appropriately using the emsdk_env script.</p><ol><li><p>Download <a href="https://people.xiph.org/~mbebenita/analyzer/">AOMAnalyzer</a>.</p></li><li><p>Configure the build:</p></li></ol><pre class="code">    $ cmake path/to/aom \
        -DENABLE_CCACHE=1 \
        -DAOM_TARGET_CPU=generic \
        -DENABLE_DOCS=0 \
        -DENABLE_TESTS=0 \
        -DCONFIG_ACCOUNTING=1 \
        -DCONFIG_INSPECTION=1 \
        -DCONFIG_MULTITHREAD=0 \
        -DCONFIG_RUNTIME_CPU_DETECT=0 \
        -DCONFIG_WEBM_IO=0 \
        -DCMAKE_TOOLCHAIN_FILE=path/to/emsdk-portable/.../Emscripten.cmake
</pre><ol start="3"><li>Build it: run make if that&#39;s your generator of choice:</li></ol><pre class="code">    $ make inspect
</pre><ol start="4"><li>Run the analyzer:</li></ol><pre class="code">    # inspect.js is in the examples sub directory of the directory in which you
    # executed cmake.
    $ path/to/AOMAnalyzer path/to/examples/inspect.js path/to/av1/input/file
</pre><h3><a class="h" name="extra-build-flags" href="#extra-build-flags"><span></span></a>Extra build flags</h3><p>Three variables allow for passing of additional flags to the build system.</p><ul><li>AOM_EXTRA_C_FLAGS</li><li>AOM_EXTRA_CXX_FLAGS</li><li>AOM_EXTRA_EXE_LINKER_FLAGS</li></ul><p>The build system attempts to ensure the flags passed through the above variables are passed to tools last in order to allow for override of default behavior. These flags can be used, for example, to enable asserts in a release build:</p><pre class="code">    $ cmake path/to/aom \
        -DCMAKE_BUILD_TYPE=Release \
        -DAOM_EXTRA_C_FLAGS=-UNDEBUG \
        -DAOM_EXTRA_CXX_FLAGS=-UNDEBUG
</pre><h3><a class="h" name="build-with-vmaf" href="#build-with-vmaf"><span></span></a>Build with VMAF support</h3><p>After installing <a href="https://github.com/Netflix/vmaf/tree/master/libvmaf">libvmaf.a</a>, you can use it with the encoder:</p><pre class="code">    $ cmake path/to/aom -DCONFIG_TUNE_VMAF=1
</pre><p>Please note that the default VMAF model (&ldquo;/usr/local/share/model/vmaf_v0.6.1.json&rdquo;) will be used unless you set the following flag when running the encoder:</p><pre class="code">    # --vmaf-model-path=path/to/model
</pre><h2><a class="h" name="testing-the-av1-codec" href="#testing-the-av1-codec"><span></span></a>Testing the AV1 codec</h2><h3><a class="h" name="testing-basics" href="#testing-basics"><span></span></a>Testing basics</h3><p>There are several methods of testing the AV1 codec. All of these methods require the presence of the AV1 source code and a working build of the AV1 library and applications.</p><h4><a class="h" name="1_unit-tests" href="#1_unit-tests"><span></span></a>1. Unit tests:</h4><p>The unit tests can be run at build time:</p><pre class="code">    # Before running the make command the LIBAOM_TEST_DATA_PATH environment
    # variable should be set to avoid downloading the test files to the
    # cmake build configuration directory.
    $ cmake path/to/aom
    # Note: The AV1 CMake build creates many test targets. Running make
    # with multiple jobs will speed up the test run significantly.
    $ make runtests
</pre><h4><a class="h" name="2_example-tests" href="#2_example-tests"><span></span></a>2. Example tests:</h4><p>The example tests require a bash shell and can be run in the following manner:</p><pre class="code">    # See the note above about LIBAOM_TEST_DATA_PATH above.
    $ cmake path/to/aom
    $ make
    # It&#39;s best to build the testdata target using many make jobs.
    # Running it like this will verify and download (if necessary)
    # one at a time, which takes a while.
    $ make testdata
    $ path/to/aom/test/examples.sh --bin-path examples
</pre><h4><a class="h" name="3_encoder-tests" href="#3_encoder-tests"><span></span></a>3. Encoder tests:</h4><p>When making a change to the encoder run encoder tests to confirm that your change has a positive or negligible impact on encode quality. When running these tests the build configuration should be changed to enable internal encoder statistics:</p><pre class="code">    $ cmake path/to/aom -DCONFIG_INTERNAL_STATS=1
    $ make
</pre><p>The repository contains scripts intended to make running these tests as simple as possible. The following example demonstrates creating a set of baseline clips for comparison to results produced after making your change to libaom:</p><pre class="code">    # This will encode all Y4M files in the current directory using the
    # settings specified to create the encoder baseline statistical data:
    $ cd path/to/test/inputs
    # This command line assumes that run_encodes.sh, its helper script
    # best_encode.sh, and the aomenc you intend to test are all within a
    # directory in your PATH.
    $ run_encodes.sh 200 500 50 baseline
</pre><p>After making your change and creating the baseline clips, you&#39;ll need to run encodes that include your change(s) to confirm that things are working as intended:</p><pre class="code">    # This will encode all Y4M files in the current directory using the
    # settings specified to create the statistical data for your change:
    $ cd path/to/test/inputs
    # This command line assumes that run_encodes.sh, its helper script
    # best_encode.sh, and the aomenc you intend to test are all within a
    # directory in your PATH.
    $ run_encodes.sh 200 500 50 mytweak
</pre><p>After creating both data sets you can use <code class="code">test/visual_metrics.py</code> to generate a report that can be viewed in a web browser:</p><pre class="code">    $ visual_metrics.py metrics_template.html &quot;*stt&quot; baseline mytweak \
      &gt; mytweak.html
</pre><p>You can view the report by opening mytweak.html in a web browser.</p><h3><a class="h" name="ide-hosted-tests" href="#ide-hosted-tests"><span></span></a>IDE hosted tests</h3><p>By default the generated projects files created by CMake will not include the runtests and testdata rules when generating for IDEs like Microsoft Visual Studio and Xcode. This is done to avoid intolerably long build cycles in the IDEs-- IDE behavior is to build all targets when selecting the build project options in MSVS and Xcode. To enable the test rules in IDEs the <code class="code">ENABLE_IDE_TEST_HOSTING</code> variable must be enabled at CMake generation time:</p><pre class="code">    # This example uses Xcode. To get a list of the generators
    # available, run cmake with the -G argument missing its
    # value.
    $ cmake path/to/aom -DENABLE_IDE_TEST_HOSTING=1 -G Xcode
</pre><h3><a class="h" name="downloading-the-test-data" href="#downloading-the-test-data"><span></span></a>Downloading the test data</h3><p>The fastest and easiest way to obtain the test data is to use CMake to generate a build using the Unix Makefiles generator, and then to build only the testdata rule:</p><pre class="code">    $ cmake path/to/aom -G &quot;Unix Makefiles&quot;
    # 28 is used because there are 28 test files as of this writing.
    $ make -j28 testdata
</pre><p>The above make command will only download and verify the test data.</p><h3><a class="h" name="adding-a-new-test-data-file" href="#adding-a-new-test-data-file"><span></span></a>Adding a new test data file</h3><p>First, add the new test data file to the <code class="code">aom-test-data</code> bucket of the <code class="code">aomedia-testing</code> project on Google Cloud Platform. You may need to ask someone with the necessary access permissions to do this for you.</p><p>NOTE: When a new test data file is added to the <code class="code">aom-test-data</code> bucket, its &ldquo;Public access&rdquo; is initially &ldquo;Not public&rdquo;. We need to change its &ldquo;Public access&rdquo; to &ldquo;Public&rdquo; by using the following <a href="https://cloud.google.com/storage/docs/gsutil_install"><code class="code">gsutil</code></a> command:</p><pre class="code">    $ gsutil acl ch -g all:R gs://aom-test-data/test-data-file-name
</pre><p>This command grants the <code class="code">AllUsers</code> group READ access to the file named &ldquo;test-data-file-name&rdquo; in the <code class="code">aom-test-data</code> bucket.</p><p>Once the new test data file has been added to <code class="code">aom-test-data</code>, create a CL to add the name of the new test data file to <code class="code">test/test_data_util.cmake</code> and add the SHA1 checksum of the new test data file to <code class="code">test/test-data.sha1</code>. (The SHA1 checksum of a file can be calculated by running the <code class="code">sha1sum</code> command on the file.)</p><h3><a class="h" name="additional-test-data" href="#additional-test-data"><span></span></a>Additional test data</h3><p>The test data mentioned above is strictly intended for unit testing.</p><p>Additional input data for testing the encoder can be obtained from: <a href="https://media.xiph.org/video/derf/">https://media.xiph.org/video/derf/</a></p><h3><a class="h" name="sharded-testing" href="#sharded-testing"><span></span></a>Sharded testing</h3><p>The AV1 codec library unit tests are built upon gtest which supports sharding of test jobs. Sharded test runs can be achieved in a couple of ways.</p><h4><a class="h" name="1_running-test_libaom-directly" href="#1_running-test_libaom-directly"><span></span></a>1. Running test_libaom directly:</h4><pre class="code">   # Set the environment variable GTEST_TOTAL_SHARDS to control the number of
   # shards.
   $ export GTEST_TOTAL_SHARDS=10
   # (GTEST shard indexing is 0 based).
   $ seq 0 $(( $GTEST_TOTAL_SHARDS - 1 )) \
       | xargs -n 1 -P 0 -I{} env GTEST_SHARD_INDEX={} ./test_libaom
</pre><p>To create a test shard for each CPU core available on the current system set <code class="code">GTEST_TOTAL_SHARDS</code> to the number of CPU cores on your system minus one.</p><h4><a class="h" name="2_running-the-tests-via-the-cmake-build" href="#2_running-the-tests-via-the-cmake-build"><span></span></a>2. Running the tests via the CMake build:</h4><pre class="code">    # For IDE based builds, ENABLE_IDE_TEST_HOSTING must be enabled. See
    # the IDE hosted tests section above for more information. If the IDE
    # supports building targets concurrently tests will be sharded by default.

    # For make and ninja builds the -j parameter controls the number of shards
    # at test run time. This example will run the tests using 10 shards via
    # make.
    $ make -j10 runtests
</pre><p>The maximum number of test targets that can run concurrently is determined by the number of CPUs on the system where the build is configured as detected by CMake. A system with 24 cores can run 24 test shards using a value of 24 with the <code class="code">-j</code> parameter. When CMake is unable to detect the number of cores 10 shards is the default maximum value.</p><h2><a class="h" name="coding-style" href="#coding-style"><span></span></a>Coding style</h2><p>We are using the Google C Coding Style defined by the <a href="https://google.github.io/styleguide/cppguide.html">Google C++ Style Guide</a>.</p><p>The coding style used by this project is enforced with clang-format using the configuration contained in the <a href="https://chromium.googlesource.com/webm/aom/+/master/.clang-format">.clang-format</a> file in the root of the repository.</p><p>You can download clang-format using your system&#39;s package manager, or directly from <a href="http://llvm.org/releases/download.html">llvm.org</a>. You can also view the <a href="https://clang.llvm.org/docs/ClangFormat.html">documentation</a> on llvm.org. Output from clang-format varies by clang-format version, for best results your version should match the one used on Jenkins. You can find the clang-format version by reading the comment in the <code class="code">.clang-format</code> file linked above.</p><p>Before pushing changes for review you can format your code with:</p><pre class="code">    # Apply clang-format to modified .c, .h and .cc files
    $ clang-format -i --style=file \
      $(git diff --name-only --diff-filter=ACMR &#39;*.[hc]&#39; &#39;*.cc&#39;)
</pre><p>Check the .clang-format file for the version used to generate it if there is any difference between your local formatting and the review system.</p><p>Some Git installations have clang-format integration. Here are some examples:</p><pre class="code">    # Apply clang-format to all staged changes:
    $ git clang-format

    # Clang format all staged and unstaged changes:
    $ git clang-format -f

    # Clang format all staged and unstaged changes interactively:
    $ git clang-format -f -p
</pre><h2><a class="h" name="submitting-patches" href="#submitting-patches"><span></span></a>Submitting patches</h2><p>We manage the submission of patches using the <a href="https://www.gerritcodereview.com/">Gerrit</a> code review tool. This tool implements a workflow on top of the Git version control system to ensure that all changes get peer reviewed and tested prior to their distribution.</p><h3><a class="h" name="login-cookie" href="#login-cookie"><span></span></a>Login cookie</h3><p>Browse to <a href="https://aomedia.googlesource.com/">AOMedia Git index</a> and login with your account (Gmail credentials, for example). Next, follow the <code class="code">Generate Password</code> Password link at the top of the page. You’ll be given instructions for creating a cookie to use with our Git repos.</p><h3><a class="h" name="contributor-agreement" href="#contributor-agreement"><span></span></a>Contributor agreement</h3><p>You will be required to execute a <a href="http://aomedia.org/license">contributor agreement</a> to ensure that the AOMedia Project has the right to distribute your changes.</p><h3><a class="h" name="testing-your-code" href="#testing-your-code"><span></span></a>Testing your code</h3><p>The testing basics are covered in the <a href="#testing-the-av1-codec">testing section</a> above.</p><p>In addition to the local tests, many more (e.g. asan, tsan, valgrind) will run through Jenkins instances upon upload to gerrit.</p><h3><a class="h" name="commit-message-hook" href="#commit-message-hook"><span></span></a>Commit message hook</h3><p>Gerrit requires that each submission include a unique Change-Id. You can assign one manually using git commit --amend, but it’s easier to automate it with the commit-msg hook provided by Gerrit.</p><p>Copy commit-msg to the <code class="code">.git/hooks</code> directory of your local repo. Here&#39;s an example:</p><pre class="code">    $ curl -Lo aom/.git/hooks/commit-msg https://chromium-review.googlesource.com/tools/hooks/commit-msg

    # Next, ensure that the downloaded commit-msg script is executable:
    $ chmod u+x aom/.git/hooks/commit-msg
</pre><p>See the Gerrit <a href="https://gerrit-review.googlesource.com/Documentation/user-changeid.html">documentation</a> for more information.</p><h3><a class="h" name="upload-your-change" href="#upload-your-change"><span></span></a>Upload your change</h3><p>The command line to upload your patch looks like this:</p><pre class="code">    $ git push https://aomedia-review.googlesource.com/aom HEAD:refs/for/master
</pre><h3><a class="h" name="incorporating-reviewer-comments" href="#incorporating-reviewer-comments"><span></span></a>Incorporating reviewer comments</h3><p>If you previously uploaded a change to Gerrit and the Approver has asked for changes, follow these steps:</p><ol><li>Edit the files to make the changes the reviewer has requested.</li><li>Recommit your edits using the --amend flag, for example:</li></ol><pre class="code">   $ git commit -a --amend
</pre><ol start="3"><li>Use the same git push command as above to upload to Gerrit again for another review cycle.</li></ol><p>In general, you should not rebase your changes when doing updates in response to review. Doing so can make it harder to follow the evolution of your change in the diff view.</p><h3><a class="h" name="submitting-your-change" href="#submitting-your-change"><span></span></a>Submitting your change</h3><p>Once your change has been Approved and Verified, you can “submit” it through the Gerrit UI. This will usually automatically rebase your change onto the branch specified.</p><p>Sometimes this can’t be done automatically. If you run into this problem, you must rebase your changes manually:</p><pre class="code">    $ git fetch
    $ git rebase origin/branchname
</pre><p>If there are any conflicts, resolve them as you normally would with Git. When you’re done, reupload your change.</p><h3><a class="h" name="viewing-the-status-of-uploaded-changes" href="#viewing-the-status-of-uploaded-changes"><span></span></a>Viewing the status of uploaded changes</h3><p>To check the status of a change that you uploaded, open <a href="https://aomedia-review.googlesource.com/">Gerrit</a>, sign in, and click My &gt; Changes.</p><h2><a class="h" name="support" href="#support"><span></span></a>Support</h2><p>This library is an open source project supported by its community. Please please email <a href="mailto:aomediacodec@jointdevelopment.kavi.com">aomediacodec@jointdevelopment.kavi.com</a> for help.</p><h2><a class="h" name="bug-reports" href="#bug-reports"><span></span></a>Bug reports</h2><p>Bug reports can be filed in the Alliance for Open Media <a href="https://bugs.chromium.org/p/aomedia/issues/list">issue tracker</a>.</p></div></div></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>