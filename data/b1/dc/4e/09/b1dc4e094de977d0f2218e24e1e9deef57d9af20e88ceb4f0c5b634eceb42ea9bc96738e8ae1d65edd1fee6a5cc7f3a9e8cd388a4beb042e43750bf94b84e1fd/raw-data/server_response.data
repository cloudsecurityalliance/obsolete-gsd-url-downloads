<!DOCTYPE html>
<html lang='en'>
<head>
<title>xorg/lib/libX11 - libX11 GIT Repository  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libx11)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/xorg/lib/libX11/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/xorg/lib/libx11' title='xorg/lib/libX11 Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='xorg/lib/libX11' href='/xorg/lib/libX11/'>xorg/lib/libX11</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b469da1430cdcee06e31c6251b83aede072a1ff0'/><select name='h' onchange='this.form.submit();'>
<option value='CYGWIN'>CYGWIN</option>
<option value='IPv6-REVIEW'>IPv6-REVIEW</option>
<option value='XACE-SELINUX'>XACE-SELINUX</option>
<option value='XEVIE'>XEVIE</option>
<option value='XFree86'>XFree86</option>
<option value='XORG-6_8-branch'>XORG-6_8-branch</option>
<option value='XORG-CURRENT'>XORG-CURRENT</option>
<option value='XORG-RELEASE-1'>XORG-RELEASE-1</option>
<option value='XORG-RELEASE-1-STSF'>XORG-RELEASE-1-STSF</option>
<option value='XORG-RELEASE-1-TM'>XORG-RELEASE-1-TM</option>
<option value='XPRINT'>XPRINT</option>
<option value='lg3d'>lg3d</option>
<option value='lg3d-dev-0-6-1'>lg3d-dev-0-6-1</option>
<option value='lg3d-dev-0-6-1-1'>lg3d-dev-0-6-1-1</option>
<option value='lg3d-dev-0-6-1-current'>lg3d-dev-0-6-1-current</option>
<option value='lg3d-dev-0-6-1-latest'>lg3d-dev-0-6-1-latest</option>
<option value='lg3d-dev-0-7-0'>lg3d-dev-0-7-0</option>
<option value='lg3d-event'>lg3d-event</option>
<option value='libX11-1.1-branch'>libX11-1.1-branch</option>
<option value='libX11-1.2-branch'>libX11-1.2-branch</option>
<option value='libX11-1.3-branch'>libX11-1.3-branch</option>
<option value='master' selected='selected'>master</option>
<option value='sco_port_update'>sco_port_update</option>
<option value='stable'>stable</option>
<option value='xge'>xge</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>libX11 GIT Repository  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libx11)</td><td class='sub right'>keithp</td></tr></table>
<table class='tabs'><tr><td>
<a href='/xorg/lib/libX11/'>summary</a><a href='/xorg/lib/libX11/refs/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>refs</a><a href='/xorg/lib/libX11/log/'>log</a><a href='/xorg/lib/libX11/tree/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>tree</a><a class='active' href='/xorg/lib/libX11/commit/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>commit</a><a href='/xorg/lib/libX11/diff/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>diff</a></td><td class='form'><form class='right' method='get' action='/xorg/lib/libX11/log/'>
<input type='hidden' name='id' value='b469da1430cdcee06e31c6251b83aede072a1ff0'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b469da1430cdcee06e31c6251b83aede072a1ff0'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;</td><td class='right'>2018-07-27 16:36:34 +0200</td></tr>
<tr><th>committer</th><td>Matthieu Herrb &lt;matthieu@herrb.eu&gt;</td><td class='right'>2018-08-21 16:42:29 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/xorg/lib/libX11/commit/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>b469da1430cdcee06e31c6251b83aede072a1ff0</a> (<a href='/xorg/lib/libX11/patch/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/xorg/lib/libX11/tree/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>de86b50e1aec0db052b0b80fbd4cb357868676cd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/xorg/lib/libX11/commit/?id=d81da209fd4d0c2c9ad0596a8078e58864479d0d'>d81da209fd4d0c2c9ad0596a8078e58864479d0d</a> (<a href='/xorg/lib/libX11/diff/?id=b469da1430cdcee06e31c6251b83aede072a1ff0&amp;id2=d81da209fd4d0c2c9ad0596a8078e58864479d0d'>diff</a>)</td></tr></table>
<div class='commit-subject'>Fixed off-by-one writes (CVE-2018-14599).</div><div class='commit-msg'>The functions XGetFontPath, XListExtensions, and XListFonts are
vulnerable to an off-by-one override on malicious server responses.

The server replies consist of chunks consisting of a length byte
followed by actual string, which is not NUL-terminated.

While parsing the response, the length byte is overridden with '\0',
thus the memory area can be used as storage of C strings later on. To
be able to NUL-terminate the last string, the buffer is reserved with
an additional byte of space.

For a boundary check, the variable chend (end of ch) was introduced,
pointing at the end of the buffer which ch initially points to.
Unfortunately there is a difference in handling "the end of ch".

While chend points at the first byte that must not be written to,
the for-loop uses chend as the last byte that can be written to.

Therefore, an off-by-one can occur.

I have refactored the code so chend actually points to the last byte
that can be written to without an out of boundary access. As it is not
possible to achieve "ch + length &lt; chend" and "ch + length + 1 &gt; chend"
with the corrected chend meaning, I removed the inner if-check.

Signed-off-by: Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;
</div><div class='diffstat-header'><a href='/xorg/lib/libX11/diff/?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libX11/diff/src/FontNames.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/FontNames.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 75.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libX11/diff/src/GetFPath.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/GetFPath.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 6.2%;'/><td class='rem' style='width: 6.2%;'/><td class='none' style='width: 87.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libX11/diff/src/ListExt.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/ListExt.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 25.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 9 insertions, 21 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/FontNames.c b/src/FontNames.c<br/>index 9ffdfd29..ec7d90fa 100644<br/>--- a/<a href='/xorg/lib/libX11/tree/src/FontNames.c?id=d81da209fd4d0c2c9ad0596a8078e58864479d0d'>src/FontNames.c</a><br/>+++ b/<a href='/xorg/lib/libX11/tree/src/FontNames.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/FontNames.c</a></div><div class='hunk'>@@ -88,24 +88,16 @@ int *actualCount)	/* RETURN */</div><div class='ctx'> 	 * unpack into null terminated strings.</div><div class='ctx'> 	 */</div><div class='ctx'> 	chstart = ch;</div><div class='del'>-	chend = ch + (rlen + 1);</div><div class='add'>+	chend = ch + rlen;</div><div class='ctx'> 	length = *(unsigned char *)ch;</div><div class='ctx'> 	*ch = 1; /* make sure it is non-zero for XFreeFontNames */</div><div class='ctx'> 	for (i = 0; i &lt; rep.nFonts; i++) {</div><div class='ctx'> 	    if (ch + length &lt; chend) {</div><div class='ctx'> 		flist[i] = ch + 1;  /* skip over length */</div><div class='ctx'> 		ch += length + 1;  /* find next length ... */</div><div class='del'>-		if (ch &lt;= chend) {</div><div class='del'>-		    length = *(unsigned char *)ch;</div><div class='del'>-		    *ch = '\0';  /* and replace with null-termination */</div><div class='del'>-		    count++;</div><div class='del'>-		} else {</div><div class='del'>-                    Xfree(chstart);</div><div class='del'>-                    Xfree(flist);</div><div class='del'>-                    flist = NULL;</div><div class='del'>-                    count = 0;</div><div class='del'>-                    break;</div><div class='del'>-		}</div><div class='add'>+		length = *(unsigned char *)ch;</div><div class='add'>+		*ch = '\0';  /* and replace with null-termination */</div><div class='add'>+		count++;</div><div class='ctx'> 	    } else {</div><div class='ctx'>                 Xfree(chstart);</div><div class='ctx'>                 Xfree(flist);</div><div class='head'>diff --git a/src/GetFPath.c b/src/GetFPath.c<br/>index 3d87e4f6..7ad21e9a 100644<br/>--- a/<a href='/xorg/lib/libX11/tree/src/GetFPath.c?id=d81da209fd4d0c2c9ad0596a8078e58864479d0d'>src/GetFPath.c</a><br/>+++ b/<a href='/xorg/lib/libX11/tree/src/GetFPath.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/GetFPath.c</a></div><div class='hunk'>@@ -69,7 +69,7 @@ char **XGetFontPath(</div><div class='ctx'> 	    /*</div><div class='ctx'> 	     * unpack into null terminated strings.</div><div class='ctx'> 	     */</div><div class='del'>-	    chend = ch + (nbytes + 1);</div><div class='add'>+	    chend = ch + nbytes;</div><div class='ctx'> 	    length = *ch;</div><div class='ctx'> 	    for (i = 0; i &lt; rep.nPaths; i++) {</div><div class='ctx'> 		if (ch + length &lt; chend) {</div><div class='head'>diff --git a/src/ListExt.c b/src/ListExt.c<br/>index 7fdf9932..8f344ac0 100644<br/>--- a/<a href='/xorg/lib/libX11/tree/src/ListExt.c?id=d81da209fd4d0c2c9ad0596a8078e58864479d0d'>src/ListExt.c</a><br/>+++ b/<a href='/xorg/lib/libX11/tree/src/ListExt.c?id=b469da1430cdcee06e31c6251b83aede072a1ff0'>src/ListExt.c</a></div><div class='hunk'>@@ -74,19 +74,15 @@ char **XListExtensions(</div><div class='ctx'> 	    /*</div><div class='ctx'> 	     * unpack into null terminated strings.</div><div class='ctx'> 	     */</div><div class='del'>-	    chend = ch + (rlen + 1);</div><div class='add'>+	    chend = ch + rlen;</div><div class='ctx'> 	    length = *ch;</div><div class='ctx'> 	    for (i = 0; i &lt; rep.nExtensions; i++) {</div><div class='ctx'> 		if (ch + length &lt; chend) {</div><div class='ctx'> 		    list[i] = ch+1;  /* skip over length */</div><div class='ctx'> 		    ch += length + 1; /* find next length ... */</div><div class='del'>-		    if (ch &lt;= chend) {</div><div class='del'>-			length = *ch;</div><div class='del'>-			*ch = '\0'; /* and replace with null-termination */</div><div class='del'>-			count++;</div><div class='del'>-		    } else {</div><div class='del'>-			list[i] = NULL;</div><div class='del'>-		    }</div><div class='add'>+		    length = *ch;</div><div class='add'>+		    *ch = '\0'; /* and replace with null-termination */</div><div class='add'>+		    count++;</div><div class='ctx'> 		} else</div><div class='ctx'> 		    list[i] = NULL;</div><div class='ctx'> 	    }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:17 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
