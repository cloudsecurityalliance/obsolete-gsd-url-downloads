<!DOCTYPE html>
<html lang="en">
  <head>
    <title>13112 &ndash; receive_xattr heap overread with non null terminated name</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">

<link href="data/assets/9a550fbe5564198f829468c7984d86b3.css" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 10
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "13112 – receive_xattr heap overread with non null terminated name",
                             "show_bug.cgi?id=13112" );
        document.title = "13112 – receive_xattr heap overread with non null terminated name";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "13112 – receive_xattr heap overread with non null terminated name", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="The Samba-Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="favicon.ico">
  </head>

  <body 
        class="bugzilla-samba-org
                 bz_bug
                 bz_status_RESOLVED
                 bz_product_rsync
                 bz_component_core
                 bz_bug_13112 yui-skin-sam">

  <div id="header"><div style="background-image:url(/images/blueHeaderSimple.png);
 background-repeat:repeat-x;
 background-size: contain;
 height:24px;
 border-radius: 38px 10px;
">
</div>

    <div id="titles">
      <span id="title">The Samba-Bugzilla &ndash; Bug&nbsp;13112</span>

        <span id="subtitle" class="subheader">receive_xattr heap overread with non null terminated name</span>

        <span id="information" class="header_addl_info">Last modified: 2017-11-05 19:48:34 UTC</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="show_bug.cgi?id=13112&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>

  <form action="show_bug.cgi?id=13112" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_top">
    <input id="Bugzilla_login_top" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_top" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_top">
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>


  <li id="forgot_container_top">
    <span class="separator">| </span>
    <a id="forgot_link_top" href="show_bug.cgi?id=13112&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_top')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_top"
          class="mini_forgot bz_default_hidden">
      <label for="login_top">Login:</label>
      <input name="loginname" size="20" id="login_top" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_top" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_top" name="token"
             value="1635630128-eIy-3t10kVCXxbEmZp8KqRn14-GQXEc4RgZr07BcKPQ">
      <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
    </form>
  </li>
</ul>
    </div>
  </div>

  <div id="bugzilla-body">


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2017-11-05 19:48:34">
  <input type="hidden" name="id" value="13112">
  <input type="hidden" name="token" value="1635630128-4lgmDFKbHzMmtomY7SN0p-PYJK0h1vdgNdc09iBrroA">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=13112"><b>Bug&nbsp;13112</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">receive_xattr heap overread with non null terminated name</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>receive_xattr heap overread with non null terminated name
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'receive_xattr heap overread with non null terminated name' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >rsync

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=rsync"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >core

  (<a href="buglist.cgi?component=core&amp;product=rsync&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>
<td>3.1.3
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">All
        All
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>P5
       normal<span id="votes_container">
    (<a href="page.cgi?id=voting/user.html&amp;bug_id=13112#vote_13112">vote</a>)
  </span>
      </td>
    </tr>

      <tr><th class="field_label "
    id="field_label_target_milestone">


  <a 
      title="The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it."
      class="field_help_link"
      href="page.cgi?id=fields.html#target_milestone"
  >Target Milestone:</a>

</th><td>---
  </td>
      </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Wayne Davison</span>
</span>
      </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_qa_contact">


  <a 
      title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#qa_contact"
  >QA Contact:</a>

</th>
      <td><span class="vcard"><span class="fn">Rsync QA Contact</span>
</span>
      </td>
    </tr>
    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'wayne\x40opencoder.net',
        'rsync-qa\x40samba.org');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>


    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2017-10-31 04:03 UTC by <span class="vcard">jeriko.one
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2017-11-05 19:48 UTC
      (<a href="show_activity.cgi?id=13112">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>0 
          users
        <div id="cc_edit_area">
          <br>
        </div>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="3" class="left">
      Attachments
    </th>
  </tr>


      <tr id="a1" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=13744"
               title="View the content of the attachment">
          <b>Make room for trailing NULL and use read_sbuf</b></a>

          <span class="bz_attach_extra_info">
              (1.09 KB,
                patch)

            <br>
            <a href="#attach_13744"
               title="Go to the comment associated with the attachment">2017-10-31 04:03 UTC</a>,

            <span class="vcard">jeriko.one
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=13744&amp;action=edit">Details</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="3">
        <span class="bz_attach_view_hide">
            <a id="view_all" href="attachment.cgi?bugid=13112&amp;action=viewall">View All</a>
        </span>
        <a href="attachment.cgi?bugid=13112&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>
<div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=13112&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        replytext = prefix;


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=13112#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">jeriko.one
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2017-10-31 04:03:13 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=13744" name="attach_13744" title="Make room for trailing NULL and use read_sbuf">attachment 13744</a> <a href="attachment.cgi?id=13744&amp;action=edit" title="Make room for trailing NULL and use read_sbuf">[details]</a></span>
Make room for trailing NULL and use read_sbuf

$ ./rsync -v
rsync  version 3.1.3dev  protocol version 31

code snippets are from receive_xattr in xattrs.c

in receive_xattr a name is read from the sender. The sender sends the length of the name, and then sends the name. The name is read in via read_buf so it's not null terminated. 

 815         size_t name_len = read_varint(f);

 826         read_buf(f, name, name_len);


If the sender sent --filter that had an xattr filter then this name will be passed to name_is_excluded. 

 834         if (saw_xattr_filter) {
 835             if (name_is_excluded(name, NAME_IS_XATTR, ALL_FILTERS)) {

This can lead to a heap overread as name_is_excluded is expecting a NULL terminated string. 

These are the arguments I'm sending to the daemon when connecting
{&quot;--server&quot;, &quot;--filter&quot;, &quot;+x jk&quot;, &quot;-X&quot;, &quot;.&quot;, &quot;.&quot;, &quot;\0&quot;};

I provided a patch that will make room for a NULL byte in name, and use read_sbuf instead. 

ASan output: 
=================================================================
==3497==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60200000e831 at pc 0x7ffff6edc15b bp 0x7fffffff9990 sp 0x7fffffff9138
READ of size 2 at 0x60200000e831 thread T0
    #0 0x7ffff6edc15a in strlen (/usr/lib/gcc/x86_64-pc-linux-gnu/5.4.0/libasan.so.2+0x7015a)
    #1 0x4412dd in rule_matches /home/raj/rsync/rsync/exclude.c:696
    #2 0x441921 in check_filter /home/raj/rsync/rsync/exclude.c:772
    #3 0x441724 in name_is_excluded /home/raj/rsync/rsync/exclude.c:744
    #4 0x4a2d76 in receive_xattr /home/raj/rsync/rsync/xattrs.c:835
    #5 0x40beac in recv_file_entry /home/raj/rsync/rsync/flist.c:1108
    #6 0x415bee in recv_file_list /home/raj/rsync/rsync/flist.c:2476
    #7 0x454eaa in do_server_recv /home/raj/rsync/rsync/main.c:1036
    #8 0x4556f4 in start_server /home/raj/rsync/rsync/main.c:1115
    #9 0x4b20f2 in rsync_module /home/raj/rsync/rsync/clientserver.c:1007
    #10 0x4b2b11 in start_daemon /home/raj/rsync/rsync/clientserver.c:1135
    #11 0x48f636 in start_accept_loop /home/raj/rsync/rsync/socket.c:618
    #12 0x4b32d2 in daemon_main /home/raj/rsync/rsync/clientserver.c:1237
    #13 0x458318 in main /home/raj/rsync/rsync/main.c:1630
    #14 0x7ffff64d866f in __libc_start_main (/lib64/libc.so.6+0x2066f)
    #15 0x4047c8 in _start (/home/raj/rsync/asan/bin/rsync+0x4047c8)

0x60200000e831 is located 0 bytes to the right of 1-byte region [0x60200000e830,0x60200000e831)
allocated by thread T0 here:
    #0 0x7ffff6f04572 in malloc (/usr/lib/gcc/x86_64-pc-linux-gnu/5.4.0/libasan.so.2+0x98572)
    #1 0x44e48b in _new_array /home/raj/rsync/rsync/util2.c:68
    #2 0x4a2c63 in receive_xattr /home/raj/rsync/rsync/xattrs.c:822
    #3 0x40beac in recv_file_entry /home/raj/rsync/rsync/flist.c:1108
    #4 0x415bee in recv_file_list /home/raj/rsync/rsync/flist.c:2476
    #5 0x454eaa in do_server_recv /home/raj/rsync/rsync/main.c:1036
    #6 0x4556f4 in start_server /home/raj/rsync/rsync/main.c:1115
    #7 0x4b20f2 in rsync_module /home/raj/rsync/rsync/clientserver.c:1007
    #8 0x4b2b11 in start_daemon /home/raj/rsync/rsync/clientserver.c:1135
    #9 0x48f636 in start_accept_loop /home/raj/rsync/rsync/socket.c:618
    #10 0x4b32d2 in daemon_main /home/raj/rsync/rsync/clientserver.c:1237
    #11 0x458318 in main /home/raj/rsync/rsync/main.c:1630
    #12 0x7ffff64d866f in __libc_start_main (/lib64/libc.so.6+0x2066f)

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 strlen
Shadow bytes around the buggy address:
  0x0c047fff9cb0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9cc0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9cd0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9ce0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9cf0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=&gt;0x0c047fff9d00: fa fa fa fa fa fa[01]fa fa fa 04 fa fa fa 00 07
  0x0c047fff9d10: fa fa fd fd fa fa 02 fa fa fa 02 fa fa fa 00 01
  0x0c047fff9d20: fa fa 03 fa fa fa 06 fa fa fa 00 01 fa fa 06 fa
  0x0c047fff9d30: fa fa 00 01 fa fa 06 fa fa fa fd fd fa fa fd fa
  0x0c047fff9d40: fa fa 00 01 fa fa fd fa fa fa fd fa fa fa 00 01
  0x0c047fff9d50: fa fa fd fa fa fa fd fa fa fa 02 fa fa fa fd fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
==3497==ABORTING</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=13112#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">jeriko.one
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2017-10-31 18:46:33 UTC
        </span>

      </div>




<pre class="bz_comment_text">This issue can also be reached in 3.1.2, but through a different path as the earlier version doesn't have an xattr filter. I believe the same fix for 3.1.3 would work for 3.1.2 (using read_sbuf) If I should open a separate bug for this please let me know. 

It requires the daemon to use:
fake super = yes 
so that am_root == -1

the sender needs to send at least 2 xattrs, at least one without the USER_PREFIX, and one that doesn't have a terminating NULL. 

same issue of name being read in with read_buf, so it's not guaranteed to be NULL terminated. 

 698         read_buf(f, name, name_len);

 705 #ifdef HAVE_LINUX_XATTRS
 706         /* Non-root can only save the user namespace. */
 707         if (am_root &lt;= 0 &amp;&amp; !HAS_PREFIX(name, USER_PREFIX)) {
 708             if (!am_root) {
 709                 free(ptr);
 710                 continue;
 711             }
 712             name -= RPRE_LEN;
 713             name_len += RPRE_LEN;
 714             memcpy(name, RSYNC_PREFIX, RPRE_LEN);
 715             need_sort = 1;
 716         }

After reading the xattrs it'll sort them if need be. need_sort is set in the previous code snippet. 

 747     if (need_sort &amp;&amp; count &gt; 1)
 748         qsort(temp_xattr.items, count, sizeof (rsync_xa), rsync_xal_compare_names);

 116 static int rsync_xal_compare_names(const void *x1, const void *x2)
 117 {
 118     const rsync_xa *xa1 = x1;
 119     const rsync_xa *xa2 = x2;
 120     return strcmp(xa1-&gt;name, xa2-&gt;name);
 121 }

rsync_xal_compare_names is expecting the names to be NULL terminated, but that isn't guaranteed. 

ASan output:
=================================================================
==29001==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60200000eaa0 at pc 0x7ffff6eb3185 bp 0x7fffffff99d0 sp 0x7fffffff9178
READ of size 18 at 0x60200000eaa0 thread T0
    #0 0x7ffff6eb3184  (/usr/lib/gcc/x86_64-pc-linux-gnu/5.4.0/libasan.so.2+0x47184)
    #1 0x49b7e6 in rsync_xal_compare_names /home/raj/rsync/rsync-3.1.2/xattrs.c:120
    #2 0x7ffff64ecc9b  (/lib64/libc.so.6+0x34c9b)
    #3 0x7ffff64ecfe9 in qsort_r (/lib64/libc.so.6+0x34fe9)
    #4 0x49f443 in receive_xattr /home/raj/rsync/rsync-3.1.2/xattrs.c:748
    #5 0x40be5b in recv_file_entry /home/raj/rsync/rsync-3.1.2/flist.c:1126
    #6 0x415b95 in recv_file_list /home/raj/rsync/rsync-3.1.2/flist.c:2494
    #7 0x45478f in do_server_recv /home/raj/rsync/rsync-3.1.2/main.c:1025
    #8 0x454fd9 in start_server /home/raj/rsync/rsync-3.1.2/main.c:1104
    #9 0x4ae074 in rsync_module /home/raj/rsync/rsync-3.1.2/clientserver.c:1003
    #10 0x4ae68a in start_daemon /home/raj/rsync/rsync-3.1.2/clientserver.c:1094
    #11 0x48e271 in start_accept_loop /home/raj/rsync/rsync-3.1.2/socket.c:618
    #12 0x4aee41 in daemon_main /home/raj/rsync/rsync-3.1.2/clientserver.c:1196
    #13 0x457c02 in main /home/raj/rsync/rsync-3.1.2/main.c:1621
    #14 0x7ffff64d866f in __libc_start_main (/lib64/libc.so.6+0x2066f)
    #15 0x404778 in _start (/home/raj/rsync/release_asan/bin/rsync+0x404778)

0x60200000eaa0 is located 0 bytes to the right of 16-byte region [0x60200000ea90,0x60200000eaa0)
allocated by thread T0 here:
    #0 0x7ffff6f04572 in malloc (/usr/lib/gcc/x86_64-pc-linux-gnu/5.4.0/libasan.so.2+0x98572)
    #1 0x44ddad in _new_array /home/raj/rsync/rsync-3.1.2/util2.c:70
    #2 0x49f012 in receive_xattr /home/raj/rsync/rsync-3.1.2/xattrs.c:694
    #3 0x40be5b in recv_file_entry /home/raj/rsync/rsync-3.1.2/flist.c:1126
    #4 0x415b95 in recv_file_list /home/raj/rsync/rsync-3.1.2/flist.c:2494
    #5 0x45478f in do_server_recv /home/raj/rsync/rsync-3.1.2/main.c:1025
    #6 0x454fd9 in start_server /home/raj/rsync/rsync-3.1.2/main.c:1104
    #7 0x4ae074 in rsync_module /home/raj/rsync/rsync-3.1.2/clientserver.c:1003
    #8 0x4ae68a in start_daemon /home/raj/rsync/rsync-3.1.2/clientserver.c:1094
    #9 0x48e271 in start_accept_loop /home/raj/rsync/rsync-3.1.2/socket.c:618
    #10 0x4aee41 in daemon_main /home/raj/rsync/rsync-3.1.2/clientserver.c:1196
    #11 0x457c02 in main /home/raj/rsync/rsync-3.1.2/main.c:1621
    #12 0x7ffff64d866f in __libc_start_main (/lib64/libc.so.6+0x2066f)

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 ??
Shadow bytes around the buggy address:
  0x0c047fff9d00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9d10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9d20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9d30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff9d40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa 00 00
=&gt;0x0c047fff9d50: fa fa 00 00[fa]fa 04 fa fa fa 00 07 fa fa fd fd
  0x0c047fff9d60: fa fa 02 fa fa fa 02 fa fa fa 00 01 fa fa 00 01
  0x0c047fff9d70: fa fa 06 fa fa fa fd fd fa fa fd fa fa fa 02 fa
  0x0c047fff9d80: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa
  0x0c047fff9d90: fa fa 02 fa fa fa 03 fa fa fa 00 01 fa fa fd fd
  0x0c047fff9da0: fa fa 00 04 fa fa fd fd fa fa fd fd fa fa fd fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
==29001==ABORTING</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=13112#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Davison</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2017-11-05 19:48:34 UTC
        </span>

      </div>




<pre class="bz_comment_text">The name_len value is set to include the terminating null char, e.g.:
    name_len = strlen(name) + 1;

I tweaked the read code to validate that the read value is null-terminated, and die if it is not.</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=13112">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=13112">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=13112">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="show_bug.cgi?id=13112&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>

  <form action="show_bug.cgi?id=13112" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_bottom">
    <input id="Bugzilla_login_bottom" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_bottom" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_bottom">
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>


  <li id="forgot_container_bottom">
    <span class="separator">| </span>
    <a id="forgot_link_bottom" href="show_bug.cgi?id=13112&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_bottom')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_bottom"
          class="mini_forgot bz_default_hidden">
      <label for="login_bottom">Login:</label>
      <input name="loginname" size="20" id="login_bottom" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_bottom" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_bottom" name="token"
             value="1635630128-eIy-3t10kVCXxbEmZp8KqRn14-GQXEc4RgZr07BcKPQ">
      <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
    </form>
  </li>
</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>

  </body>
</html>