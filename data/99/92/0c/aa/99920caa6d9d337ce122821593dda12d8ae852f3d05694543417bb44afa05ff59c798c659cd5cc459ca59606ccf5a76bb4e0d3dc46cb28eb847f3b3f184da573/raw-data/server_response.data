<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/qemu/+bug/1886362/+index" />

    <meta charset="UTF-8" />
    <title>Bug #1886362 “Heap use-after-free in lduw_he_p through e1000e_wr...” : Bugs : QEMU</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/1886362" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/1886362/bug.atom" title="Bug 1886362 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="Hello,
This reproducer causes a heap-use-after free. QEMU Built with --enable-sanitizers:
cat &lt;&lt; EOF | ./i386-softmmu/qemu-system-i386 -M q35,accel=qtest \
-qtest stdio -nographic -monitor none -serial none
outl 0xcf8 0x80001010
outl 0xcfc 0xe1020000
outl 0xcf8 0x80001014
outl 0xcf8 0x80001004
outw 0xcfc 0x7
outl 0xcf8 0x800010a2
write 0xe102003b 0x1 0xff
write 0xe1020103 0x1e 0xffffff055c5e5c30be4511d084ffffffffffffffffffffffffffffffffff
write 0xe1020420 0x4 0xffffffff
write 0xe1020424 0x4 0..." />
      <meta property="og:description" content="Hello,
This reproducer causes a heap-use-after free. QEMU Built with --enable-sanitizers:
cat &lt;&lt; EOF | ./i386-softmmu/qemu-system-i386 -M q35,accel=qtest \
-qtest stdio -nographic -monitor none -serial none
outl 0xcf8 0x80001010
outl 0xcfc 0xe1020000
outl 0xcf8 0x80001014
outl 0xcf8 0x80001004
outw 0xcfc 0x7
outl 0xcf8 0x800010a2
write 0xe102003b 0x1 0xff
write 0xe1020103 0x1e 0xffffff055c5e5c30be4511d084ffffffffffffffffffffffffffffffffff
write 0xe1020420 0x4 0xffffffff
write 0xe1020424 0x4 0..." />
    

    
    
      <meta property="og:title" content="Bug #1886362 “Heap use-after-free in lduw_he_p through e1000e_wr...” : Bugs : QEMU" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/1886362" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["arm", "feature-request", "i386", "linux-user", "mips", "patch", "ppc", "qemu-img", "s390x", "sh4", "sparc", "usb", "windows"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/qemu/+bug/1886362/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/qemu"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/27372372/qemu_64.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/qemu">QEMU</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/qemu">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/qemu">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/qemu">Bugs</a></li>
      
      
    
    
      
      <li class="specifications"><a href="https://blueprints.launchpad.net/qemu">Blueprints</a></li>
      
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/qemu">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/qemu">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    Heap use-after-free in lduw_he_p through e1000e_write_to_rx_buffers
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #1886362 reported by
      <a href="https://launchpad.net/~a1xndr" class="sprite person">Alexander Bulekov</a>
      <time title="2020-07-06 02:44:58 UTC" datetime="2020-07-06T02:44:58.066918+00:00">on 2020-07-06</time>
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">8</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr class="highlight" id="tasksummary2618839">
    <td>
      <a class="bugtask-expander" href="https://bugs.launchpad.net/qemu/+bug/1886362/+editstatus">
        &#8203;
      </a>
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2618839">
        <span class="yui3-activator-data-box">
            <a class="sprite product" href="https://bugs.launchpad.net/qemu">QEMU</a>
        </span>
        <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
          Edit
        </button>
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        
        
          <a href="https://bugs.launchpad.net/qemu/+bug/1886362/+editstatus" style="float: left" class="value statusFIXRELEASED">Fix Released</a>
          <a href="https://bugs.launchpad.net/qemu/+bug/1886362/+editstatus" style="margin-left: 3px">
            <img class="editicon" src="/@@/edit" />
          </a>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2618839">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
            Edit
          </button>
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  
    <tr class="bugtask-collapsible-content hidden" id="task2618839">
     <td colspan="7"><form action="/qemu/+bug/1886362/+editstatus" method="post" enctype="multipart/form-data">
  

  <p class="error message">
    You need to log in to change this bug's status.
  </p>
  
  <table class="summary" style="float: right; margin-left: 1em;">
    <tr>
      <th>Affecting:</th>
      <td><a href="/qemu">QEMU</a></td>
    </tr>
    <tr>
      <th>Filed here by:</th>
      <td><a href="https://launchpad.net/~a1xndr" class="sprite person">Alexander Bulekov</a></td>
    </tr>
    <tr>
      <th>When:</th>
      <td>
        <time title="2020-07-06 02:44:58 UTC" datetime="2020-07-06T02:44:58.066918+00:00">2020-07-06</time>
      </td>
    </tr>
    <tr>
      <th>Confirmed:</th>
      <td>
        <time title="2021-06-15 18:19:44 UTC" datetime="2021-06-15T18:19:44.480223+00:00">2021-06-15</time>
      </td>
    </tr>
    
    <tr>
      <th>Started work:</th>
      <td>
        <time title="2021-06-15 18:19:44 UTC" datetime="2021-06-15T18:19:44.480223+00:00">2021-06-15</time>
      </td>
    </tr>
    <tr>
      <th>Completed:</th>
      <td>
        <time title="2021-06-15 18:19:44 UTC" datetime="2021-06-15T18:19:44.480223+00:00">2021-06-15</time>
      </td>
    </tr>
  </table>
  <div class="field">
    <table>
      <tr>
        <td>
          <label for="qemu.target">Target</label>
        </td>
      </tr>
      <tr>
        <td>
          <table>
  <tr>
    <td>
      <label>
        <input class="radioType" id="qemu.target.option.package" name="qemu.target" type="radio" value="package" />
        Distribution
      </label>
    </td>
    <td>
      <select id="qemu.target.distribution" name="qemu.target.distribution" size="1" >
<option value="baltix">Baltix</option>
<option value="boss">BOSS</option>
<option value="charms">Juju Charms Collection</option>
<option value="elbuntu">Elbuntu</option>
<option value="guadalinex">Guadalinex</option>
<option value="guadalinexedu">Guadalinex Edu</option>
<option value="kiwilinux">Kiwi Linux</option>
<option value="nubuntu">nUbuntu</option>
<option value="pld-linux">PLD Linux</option>
<option value="tilix">Tilix</option>
<option value="tuxlab">tuXlab</option>
<option selected="selected" value="ubuntu">Ubuntu</option>
<option value="ubuntu-leb">Ubuntu Linaro Evaluation Build</option>
<option value="ubuntu-rtm">Ubuntu RTM</option>
</select>
<input name="qemu.target.distribution-empty-marker" type="hidden" value="1" />
    </td>
  </tr>
  <tr>
    <td align="right">
      <label for="qemu.target.option.package">
        Package
      </label>
    </td>
    <td>
      


    <input type="text" value="" id="qemu.target.package"
                         name="qemu.target.package" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;qemu.target.option.package&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('qemu.target.package');
              var select_menu = Y.DOM.byId('qemu.target.package-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-qemu-target-package" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_remove_button": false, "header": "Select a package", "vocabulary_filters": [], "remove_team_text": "Remove team", "remove_person_text": "Remove person", "selected_value_metadata": null, "show_create_team": false, "picker_type": "default", "vocabulary_name": "DistributionPackage", "extra_no_results_message": null, "selected_value": null, "show_assign_me_button": false, "show_widget_id": "show-widget-qemu-target-package", "step_title": "Search by name", "assign_me_text": "Pick me", "input_element": "qemu.target.package"};
        var show_widget_id = 'show-widget-qemu-target-package';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>

  <tr>
    <td>
      <label>
        <input class="radioType" checked="checked" id="qemu.target.option.product" name="qemu.target" type="radio" value="product" />
       Project
      </label>
    </td>
    <td>
      


    <input type="text" value="qemu" id="qemu.target.product"
                         name="qemu.target.product" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;qemu.target.option.product&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('qemu.target.product');
              var select_menu = Y.DOM.byId('qemu.target.product-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-qemu-target-product" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_remove_button": false, "header": "Select a project", "vocabulary_filters": [], "remove_team_text": "Remove team", "remove_person_text": "Remove person", "selected_value_metadata": null, "show_create_team": false, "picker_type": "default", "vocabulary_name": "Product", "extra_no_results_message": null, "selected_value": "qemu", "show_assign_me_button": false, "show_widget_id": "show-widget-qemu-target-product", "step_title": "Search", "assign_me_text": "Pick me", "input_element": "qemu.target.product"};
        var show_widget_id = 'show-widget-qemu-target-product';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>
</table>

          
        </td>
      </tr>
    </table>
    
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="qemu.status">Status</label>
        </td>
        <td>
          <label style="font-weight: bold" for="qemu.importance">Importance</label>
        </td>
        
      </tr>
      <tr>
        <td><div>
<div class="value">
<select id="qemu.status" name="qemu.status" size="1" >
<option selected="selected" value="Fix Released">Fix Released</option>
</select>
</div>
<input name="qemu.status-empty-marker" type="hidden" value="1" />
</div></td>
        <td title="Changeable only by a project maintainer or bug supervisor">
          <span class="sprite read-only"></span>
          <span class="importanceUNDECIDED">Undecided</span>
        </td>
        
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="qemu.assignee">Assigned to</label>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="white-space: nowrap">

  <table>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" checked="checked" id="qemu.assignee.assign_to_nobody" name="qemu.assignee.option" value="qemu.assignee.assign_to_nobody" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="qemu.assignee.assign_to_nobody">
          Nobody
        </label>
      </td>
    </tr>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" id="qemu.assignee.assign_to_me" name="qemu.assignee.option" value="qemu.assignee.assign_to_me" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="qemu.assignee.assign_to_me">
          Me
        </label>
      </td>
    </tr>
    
    
  </table>


</td>
      </tr>
    </table>
    
  </div>
  <div class="field">
    <div>
      <label style="font-weight: bold" for="qemu.comment_on_change">Comment on this change (optional)</label>
      <textarea cols="62" rows="4" id="qemu.comment_on_change" name="qemu.comment_on_change"></textarea>
    </div>
    <div>
      <label style="font-weight: normal">
        <input type="checkbox" name="subscribe" id="subscribe" value="Subscribe" />
        Email me about changes to this bug report
      </label>
    </div>
  </div>
  
</form>
</td>
    </tr>
  


        
      </tbody>

    </table>



<div class="actions">
  
    <span id="also-affects-product" class="">
    <a class="menu-link-addupstream sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+choose-affected-product">Also affects project</a>
        <a href="/+help-bugs/also-affects-project-help.html" target="help" class="sprite maybe action-icon">(?)</a>
    </span>
    <span id="also-affects-package" class="">
    <a class="menu-link-adddistro sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+distrotask">Also affects distribution/package</a>
    </span>
    <a class="menu-link-nominate sprite milestone" href="https://bugs.launchpad.net/qemu/+bug/1886362/+nominate">Nominate for series</a>
    
  

</div>




      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>Hello,<br />
This reproducer causes a heap-use-after free. QEMU Built with --enable-<wbr />sanitizers:<br />
cat &lt;&lt; EOF | ./i386-<wbr />softmmu/<wbr />qemu-system-<wbr />i386 -M q35,accel=qtest \<br />
-qtest stdio -nographic -monitor none -serial none<br />
outl 0xcf8 0x80001010<br />
outl 0xcfc 0xe1020000<br />
outl 0xcf8 0x80001014<br />
outl 0xcf8 0x80001004<br />
outw 0xcfc 0x7<br />
outl 0xcf8 0x800010a2<br />
write 0xe102003b 0x1 0xff<br />
write 0xe1020103 0x1e 0xffffff055c5e5<wbr />c30be4511d084ff<wbr />fffffffffffffff<wbr />fffffffffffffff<wbr />ff<br />
write 0xe1020420 0x4 0xffffffff<br />
write 0xe1020424 0x4 0xffffffff<br />
write 0xe102042b 0x1 0xff<br />
write 0xe1020430 0x4 0x055c5e5c<br />
write 0x5c041 0x1 0x04<br />
write 0x5c042 0x1 0x02<br />
write 0x5c043 0x1 0xe1<br />
write 0x5c048 0x1 0x8a<br />
write 0x5c04a 0x1 0x31<br />
write 0x5c04b 0x1 0xff<br />
write 0xe1020403 0x1 0xff<br />
EOF</p>
<p>The Output:<br />
==22689==ERROR: AddressSanitizer: heap-use-after-free on address 0x62500026800e at pc 0x55b93bb18bfa bp 0x7fffdbe844f0 sp 0x7fffdbe83cb8<br />
READ of size 2 at 0x62500026800e thread T0<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0  in __asan_memcpy (/build/<wbr />i386-softmmu/<wbr />qemu-system-<wbr />i386+)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1  in lduw_he_p /include/<wbr />qemu/bswap.<wbr />h:332:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2  in ldn_he_p /include/<wbr />qemu/bswap.<wbr />h:550:1<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3  in flatview_<wbr />write_continue /exec.c:3145:19<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4  in flatview_write /exec.c:3186:14<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5  in address_space_write /exec.c:3280:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6  in address_space_rw /exec.c:3290:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7  in dma_memory_<wbr />rw_relaxed /include/<wbr />sysemu/<wbr />dma.h:87:<wbr />18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8  in dma_memory_rw /include/<wbr />sysemu/<wbr />dma.h:113:<wbr />12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9  in pci_dma_rw /include/<wbr />hw/pci/<wbr />pci.h:789:<wbr />5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10  in pci_dma_write /include/<wbr />hw/pci/<wbr />pci.h:802:<wbr />12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11  in e1000e_<wbr />write_to_<wbr />rx_buffers /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1412:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12  in e1000e_<wbr />write_packet_<wbr />to_guest /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1582:21<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13  in e1000e_receive_iov /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1709:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14  in e1000e_<wbr />nc_receive_<wbr />iov /hw/net/<wbr />e1000e.<wbr />c:213:12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15  in net_tx_pkt_sendv /hw/net/<wbr />net_tx_<wbr />pkt.c:544:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16  in net_tx_pkt_send /hw/net/<wbr />net_tx_<wbr />pkt.c:620:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17  in net_tx_<wbr />pkt_send_<wbr />loopback /hw/net/<wbr />net_tx_<wbr />pkt.c:633:<wbr />11<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18  in e1000e_tx_pkt_send /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />664:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#19  in e1000e_<wbr />process_<wbr />tx_desc /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />743:17<br />
&nbsp;&nbsp;&nbsp;&nbsp;#20  in e1000e_start_xmit /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />934:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#21  in e1000e_set_tctl /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />2431:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#22  in e1000e_core_write /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />3265:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#23  in e1000e_mmio_write /hw/net/<wbr />e1000e.<wbr />c:109:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#24  in memory_<wbr />region_<wbr />write_accessor /memory.c:483:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#25  in access_<wbr />with_adjusted_<wbr />size /memory.c:544:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#26  in memory_<wbr />region_<wbr />dispatch_<wbr />write /memory.c:1476:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#27  in flatview_<wbr />write_continue /exec.c:3146:23<br />
&nbsp;&nbsp;&nbsp;&nbsp;#28  in flatview_write /exec.c:3186:14<br />
&nbsp;&nbsp;&nbsp;&nbsp;#29  in address_space_write /exec.c:3280:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#30  in qtest_process_<wbr />command /qtest.c:567:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#31  in qtest_process_inbuf /qtest.c:710:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#32  in qtest_read /qtest.c:722:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#33  in qemu_chr_<wbr />be_write_<wbr />impl /chardev/<wbr />char.c:<wbr />188:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#34  in qemu_chr_be_write /chardev/<wbr />char.c:<wbr />200:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#35  in fd_chr_read /chardev/<wbr />char-fd.<wbr />c:68:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#36  in qio_channel_<wbr />fd_source_<wbr />dispatch /io/channel-<wbr />watch.c:<wbr />84:12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#37  in g_main_<wbr />context_<wbr />dispatch (/usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />libglib-<wbr />2.0.so.<wbr />0+)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#38  in glib_pollfds_poll /util/main-<wbr />loop.c:<wbr />219:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#39  in os_host_<wbr />main_loop_<wbr />wait /util/main-<wbr />loop.c:<wbr />242:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#40  in main_loop_wait /util/main-<wbr />loop.c:<wbr />518:11<br />
&nbsp;&nbsp;&nbsp;&nbsp;#41  in qemu_main_loop /softmmu/<wbr />vl.c:1664:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#42  in main /softmmu/<wbr />main.c:<wbr />52:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#43  in __libc_start_main (/lib/x86_<wbr />64-linux-<wbr />gnu/libc.<wbr />so.6+)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#44  in _start (/build/<wbr />i386-softmmu/<wbr />qemu-system-<wbr />i386+)</p>
<p>0x62500026800e is located 14 bytes inside of 138-byte region [0x625000268000<wbr />,0x62500026808a<wbr />)<br />
freed by thread T0 here:<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0  in free (/build/<wbr />i386-softmmu/<wbr />qemu-system-<wbr />i386+)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1  in qemu_vfree /util/oslib-<wbr />posix.c:<wbr />238:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2  in address_space_unmap /exec.c:3616:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3  in dma_memory_unmap /include/<wbr />sysemu/<wbr />dma.h:148:<wbr />5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4  in pci_dma_unmap /include/<wbr />hw/pci/<wbr />pci.h:839:<wbr />5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5  in net_tx_pkt_reset /hw/net/<wbr />net_tx_<wbr />pkt.c:453:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6  in e1000e_<wbr />process_<wbr />tx_desc /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />749:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7  in e1000e_start_xmit /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />934:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8  in e1000e_set_tctl /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />2431:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9  in e1000e_core_write /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />3265:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10  in e1000e_mmio_write /hw/net/<wbr />e1000e.<wbr />c:109:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11  in memory_<wbr />region_<wbr />write_accessor /memory.c:483:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12  in access_<wbr />with_adjusted_<wbr />size /memory.c:544:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13  in memory_<wbr />region_<wbr />dispatch_<wbr />write /memory.c:1476:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14  in flatview_<wbr />write_continue /exec.c:3146:23<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15  in flatview_write /exec.c:3186:14<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16  in address_space_write /exec.c:3280:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17  in address_space_rw /exec.c:3290:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18  in dma_memory_<wbr />rw_relaxed /include/<wbr />sysemu/<wbr />dma.h:87:<wbr />18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#19  in dma_memory_rw /include/<wbr />sysemu/<wbr />dma.h:113:<wbr />12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#20  in pci_dma_rw /include/<wbr />hw/pci/<wbr />pci.h:789:<wbr />5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#21  in pci_dma_write /include/<wbr />hw/pci/<wbr />pci.h:802:<wbr />12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#22  in e1000e_<wbr />write_to_<wbr />rx_buffers /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1412:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#23  in e1000e_<wbr />write_packet_<wbr />to_guest /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1582:21<br />
&nbsp;&nbsp;&nbsp;&nbsp;#24  in e1000e_receive_iov /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />1709:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#25  in e1000e_<wbr />nc_receive_<wbr />iov /hw/net/<wbr />e1000e.<wbr />c:213:12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#26  in net_tx_pkt_sendv /hw/net/<wbr />net_tx_<wbr />pkt.c:544:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#27  in net_tx_pkt_send /hw/net/<wbr />net_tx_<wbr />pkt.c:620:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#28  in net_tx_<wbr />pkt_send_<wbr />loopback /hw/net/<wbr />net_tx_<wbr />pkt.c:633:<wbr />11<br />
&nbsp;&nbsp;&nbsp;&nbsp;#29  in e1000e_tx_pkt_send /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />664:16</p>
<p>previously allocated by thread T0 here:<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0  in posix_memalign (/build/<wbr />i386-softmmu/<wbr />qemu-system-<wbr />i386+)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1  in qemu_try_memalign /util/oslib-<wbr />posix.c:<wbr />198:11<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2  in qemu_memalign /util/oslib-<wbr />posix.c:<wbr />214:27<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3  in address_space_map /exec.c:3558:25<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4  in dma_memory_map /include/<wbr />sysemu/<wbr />dma.h:138:<wbr />9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5  in pci_dma_map /include/<wbr />hw/pci/<wbr />pci.h:832:<wbr />11<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6  in net_tx_<wbr />pkt_add_<wbr />raw_fragment /hw/net/<wbr />net_tx_<wbr />pkt.c:391:<wbr />24<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7  in e1000e_<wbr />process_<wbr />tx_desc /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />731:14<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8  in e1000e_start_xmit /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />934:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9  in e1000e_set_tctl /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />2431:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10  in e1000e_core_write /hw/net/<wbr />e1000e_<wbr />core.c:<wbr />3265:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11  in e1000e_mmio_write /hw/net/<wbr />e1000e.<wbr />c:109:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12  in memory_<wbr />region_<wbr />write_accessor /memory.c:483:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13  in access_<wbr />with_adjusted_<wbr />size /memory.c:544:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14  in memory_<wbr />region_<wbr />dispatch_<wbr />write /memory.c:1476:16<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15  in flatview_<wbr />write_continue /exec.c:3146:23<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16  in flatview_write /exec.c:3186:14<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17  in address_space_write /exec.c:3280:18<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18  in qtest_process_<wbr />command /qtest.c:567:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#19  in qtest_process_inbuf /qtest.c:710:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#20  in qtest_read /qtest.c:722:5<br />
&nbsp;&nbsp;&nbsp;&nbsp;#21  in qemu_chr_<wbr />be_write_<wbr />impl /chardev/<wbr />char.c:<wbr />188:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#22  in qemu_chr_be_write /chardev/<wbr />char.c:<wbr />200:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#23  in fd_chr_read /chardev/<wbr />char-fd.<wbr />c:68:9<br />
&nbsp;&nbsp;&nbsp;&nbsp;#24  in qio_channel_<wbr />fd_source_<wbr />dispatch /io/channel-<wbr />watch.c:<wbr />84:12<br />
&nbsp;&nbsp;&nbsp;&nbsp;#25  in g_main_<wbr />context_<wbr />dispatch (/usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />libglib-<wbr />2.0.so.<wbr />0+)</p>
<p>-Alex</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            
          </span>
          <span id="tag-list">
          </span>
          <a href="+edit" title="Add tags" id="tags-trigger" class="sprite add">Add tags</a>
          
          <a href="/+help-bugs/tag-help.html" target="help" class="sprite maybe action-icon">Tag help</a>
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~philmd" class="sprite person">Philippe Mathieu-Daudé (philmd)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-07T04:52:52.238983+00:00" title="2020-07-07 04:52:52 UTC">on 2020-07-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  <a href="https://bugs.launchpad.net/qemu/+bug/1886362/comments/1/+download">Download full text</a> (8.0 KiB)
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Running with &#x27;-trace e1000\*&#x27;:</p>
<p>e1000e_<wbr />cb_pci_<wbr />realize E1000E PCI realize entry<br />
e1000e_<wbr />mac_set_<wbr />permanent Set permanent MAC: 52:54:00:12:34:56<br />
e1000e_<wbr />cfg_support_<wbr />virtio Virtio header supported: 0<br />
e1000e_rx_set_cso RX CSO state set to 0<br />
e1000e_<wbr />cb_qdev_<wbr />reset E1000E qdev reset entry<br />
e1000x_mac_indicate Indicating MAC to guest: 52:54:00:12:34:56<br />
e1000x_<wbr />rx_can_<wbr />recv_disabled link_up: 1, rx_enabled 0, pci_master 0<br />
e1000x_<wbr />rx_can_<wbr />recv_disabled link_up: 1, rx_enabled 0, pci_master 0<br />
e1000e_<wbr />vm_state_<wbr />running VM state is running<br />
[R +0.094581] outl 0xcf8 0x80001010<br />
[S +0.094604] OK<br />
[R +0.094632] outl 0xcfc 0xe1020000<br />
[S +0.094654] OK<br />
[R +0.094668] outl 0xcf8 0x80001014<br />
[S +0.094675] OK<br />
[R +0.094694] outl 0xcf8 0x80001004<br />
[S +0.094702] OK<br />
[R +0.094712] outw 0xcfc 0x7<br />
e1000e_<wbr />rx_start_<wbr />recv<br />
[S +0.096938] OK<br />
[R +0.096960] outl 0xcf8 0x800010a2<br />
[S +0.096972] OK<br />
[R +0.096986] write 0xe102003b 0x1 0xff<br />
e1000e_core_write Write to register 0x38, 4 byte(s), value: 0xff<br />
e1000e_vlan_vet Setting VLAN ethernet type 0xFF<br />
[S +0.097019] OK<br />
[R +0.097034] write 0xe1020103 0x1e 0xffffff055c5e5<wbr />c30be4511d084ff<wbr />fffffffffffffff<wbr />fffffffffffffff<wbr />ff<br />
e1000e_core_write Write to register 0x100, 4 byte(s), value: 0xff<br />
e1000e_rx_set_rctl RCTL = 0xff<br />
e1000e_<wbr />rx_desc_<wbr />buff_sizes buffer sizes: [2048, 0, 0, 0]<br />
e1000e_rx_desc_len RX descriptor length: 16<br />
e1000e_<wbr />rx_start_<wbr />recv<br />
e1000e_<wbr />wrn_regs_<wbr />write_unknown WARNING: Write to unknown register 0x104, 4 byte(s), value: 0x5c05ffff<br />
e1000e_core_write Write to register 0x2820, 4 byte(s), value: 0xbe305c5e<br />
e1000e_<wbr />irq_rdtr_<wbr />fpd_not_<wbr />running FPD written while RDTR was not running<br />
e1000e_<wbr />wrn_regs_<wbr />write_unknown WARNING: Write to unknown register 0x10c, 4 byte(s), value: 0x84d01145<br />
e1000e_core_write Write to register 0x2800, 4 byte(s), value: 0xffffffff<br />
e1000e_core_write Write to register 0x2804, 4 byte(s), value: 0xffffffff<br />
e1000e_core_write Write to register 0x2808, 4 byte(s), value: 0xffffffff<br />
e1000e_<wbr />wrn_regs_<wbr />write_unknown WARNING: Write to unknown register 0x11c, 4 byte(s), value: 0xffffffff<br />
e1000e_core_write Write to register 0x2810, 4 byte(s), value: 0xff<br />
[S +0.097143] OK<br />
[R +0.097159] write 0xe1020420 0x4 0xffffffff<br />
e1000e_core_write Write to register 0x3800, 4 byte(s), value: 0xffffffff<br />
[S +0.097173] OK<br />
[R +0.097183] write 0xe1020424 0x4 0xffffffff<br />
e1000e_core_write Write to register 0x3804, 4 byte(s), value: 0xffffffff<br />
[S +0.097196] OK<br />
[R +0.097208] write 0xe102042b 0x1 0xff<br />
e1000e_core_write Write to register 0x3808, 4 byte(s), value: 0xff<br />
[S +0.097221] OK<br />
[R +0.097231] write 0xe1020430 0x4 0x055c5e5c<br />
e1000e_core_write Write to register 0x3810, 4 byte(s), value: 0x5c5e5c05<br />
[S +0.097243] OK<br />
[R +0.097253] write 0x5c041 0x1 0x04<br />
[S +0.097914] OK<br />
[R +0.097942] write 0x5c042 0x1 0x02<br />
[S +0.097953] OK<br />
[R +0.097964] write 0x5c043 0x1 0xe1<br />
[S +0.097972] OK<br />
[R +0.097984] write 0x5c048 0x1 0x8a<br />
[S +0.097992] OK<br />
[R +0.098003] write 0x5c04a 0x1 0x31<br />
[S +0.098011] OK<br />
[R +0.098022] write 0x5c04b 0x1 0xff<br />
[S +0.098029] OK<br />
[R +0.098040] write 0xe1020403 0x1 0xff<br />
e1000e_core_write Write to register 0x400, 4 byte(s), value: 0xff<br />
e1000e_tx_descr 0xe1020400 : ff31008a 0<br />
e1000e_core_read Read from register 0x400, 4 byte(s), value: 0xff<br />
e1000e_<wbr />wrn_regs_<wbr />read_unknown WARNING: Rea...</p></div>
    
    <p>
      <a href="/qemu/+bug/1886362/comments/1">Read more...</a>
    </p>
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Running with '-trace e1000\*':

e1000e_cb_pci_realize E1000E PCI realize entry
e1000e_mac_set_permanent Set permanent MAC: 52:54:00:12:34:56
e1000e_cfg_support_virtio Virtio header supported: 0
e1000e_rx_set_cso RX CSO state set to 0
e1000e_cb_qdev_reset E1000E qdev reset entry
e1000x_mac_indicate Indicating MAC to guest: 52:54:00:12:34:56
e1000x_rx_can_recv_disabled link_up: 1, rx_enabled 0, pci_master 0
e1000x_rx_can_recv_disabled link_up: 1, rx_enabled 0, pci_master 0
e1000e_vm_state_running VM state is running
[R +0.094581] outl 0xcf8 0x80001010
[S +0.094604] OK
[R +0.094632] outl 0xcfc 0xe1020000
[S +0.094654] OK
[R +0.094668] outl 0xcf8 0x80001014
[S +0.094675] OK
[R +0.094694] outl 0xcf8 0x80001004
[S +0.094702] OK
[R +0.094712] outw 0xcfc 0x7
e1000e_rx_start_recv 
[S +0.096938] OK
[R +0.096960] outl 0xcf8 0x800010a2
[S +0.096972] OK
[R +0.096986] write 0xe102003b 0x1 0xff
e1000e_core_write Write to register 0x38, 4 byte(s), value: 0xff
e1000e_vlan_vet Setting VLAN ethernet type 0xFF
[S +0.097019] OK
[R +0.097034] write 0xe1020103 0x1e 0xffffff055c5e5c30be4511d084ffffffffffffffffffffffffffffffffff
e1000e_core_write Write to register 0x100, 4 byte(s), value: 0xff
e1000e_rx_set_rctl RCTL = 0xff
e1000e_rx_desc_buff_sizes buffer sizes: [2048, 0, 0, 0]
e1000e_rx_desc_len RX descriptor length: 16
e1000e_rx_start_recv 
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x104, 4 byte(s), value: 0x5c05ffff
e1000e_core_write Write to register 0x2820, 4 byte(s), value: 0xbe305c5e
e1000e_irq_rdtr_fpd_not_running FPD written while RDTR was not running
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x10c, 4 byte(s), value: 0x84d01145
e1000e_core_write Write to register 0x2800, 4 byte(s), value: 0xffffffff
e1000e_core_write Write to register 0x2804, 4 byte(s), value: 0xffffffff
e1000e_core_write Write to register 0x2808, 4 byte(s), value: 0xffffffff
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x11c, 4 byte(s), value: 0xffffffff
e1000e_core_write Write to register 0x2810, 4 byte(s), value: 0xff
[S +0.097143] OK
[R +0.097159] write 0xe1020420 0x4 0xffffffff
e1000e_core_write Write to register 0x3800, 4 byte(s), value: 0xffffffff
[S +0.097173] OK
[R +0.097183] write 0xe1020424 0x4 0xffffffff
e1000e_core_write Write to register 0x3804, 4 byte(s), value: 0xffffffff
[S +0.097196] OK
[R +0.097208] write 0xe102042b 0x1 0xff
e1000e_core_write Write to register 0x3808, 4 byte(s), value: 0xff
[S +0.097221] OK
[R +0.097231] write 0xe1020430 0x4 0x055c5e5c
e1000e_core_write Write to register 0x3810, 4 byte(s), value: 0x5c5e5c05
[S +0.097243] OK
[R +0.097253] write 0x5c041 0x1 0x04
[S +0.097914] OK
[R +0.097942] write 0x5c042 0x1 0x02
[S +0.097953] OK
[R +0.097964] write 0x5c043 0x1 0xe1
[S +0.097972] OK
[R +0.097984] write 0x5c048 0x1 0x8a
[S +0.097992] OK
[R +0.098003] write 0x5c04a 0x1 0x31
[S +0.098011] OK
[R +0.098022] write 0x5c04b 0x1 0xff
[S +0.098029] OK
[R +0.098040] write 0xe1020403 0x1 0xff
e1000e_core_write Write to register 0x400, 4 byte(s), value: 0xff
e1000e_tx_descr 0xe1020400 : ff31008a 0
e1000e_core_read Read from register 0x400, 4 byte(s), value: 0xff
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x404, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x408, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x40c, 4 byte(s)
e1000e_core_read Read from register 0x410, 4 byte(s), value: 0x602008
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x414, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x418, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x41c, 4 byte(s)
e1000e_core_read Read from register 0x3800, 4 byte(s), value: 0xfffffff0
e1000e_core_read Read from register 0x3804, 4 byte(s), value: 0xffffffff
e1000e_core_read Read from register 0x3808, 4 byte(s), value: 0x80
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x42c, 4 byte(s)
e1000e_core_read Read from register 0x3810, 4 byte(s), value: 0x5c05
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x434, 4 byte(s)
e1000e_core_read Read from register 0x3818, 4 byte(s), value: 0x0
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x43c, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x3820, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x444, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x448, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x44c, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x450, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x454, 4 byte(s)
e1000e_core_read Read from register 0x458, 4 byte(s), value: 0x0
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x45c, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x460, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x464, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x468, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x46c, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x470, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x474, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x478, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x47c, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x480, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x484, 4 byte(s)
e1000e_wrn_regs_read_unknown WARNING: Read from unknown register 0x488, 4 byte(s)
e1000e_rx_receive_iov Received vector of 4 fragments
e1000x_vlan_is_vlan_pkt Is VLAN packet: 0, ETH proto: 0x0, VET: 0xFF
e1000e_rx_rss_started Starting RSS processing
e1000e_rx_rss_disabled RSS is disabled
e1000e_rx_rss_dispatched_to_queue Packet being dispatched to queue 0
e1000e_ring_free_space ring #0: LEN: 1048448, DH: 255, DT: 0
e1000e_rx_has_buffers ring #0: free descr: 65273, packet size 142, descr buffer size 2048
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0xfe0, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0xff0, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0x1000, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0x1010, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
[...]
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0x5c020, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0x5c030, length: 16
e1000e_rx_null_descriptor Null RX descriptor!!
e1000e_rx_descr Next RX descriptor: ring #0, PA: 0x5c040, length: 16
e1000e_rx_desc_buff_write buffer #0, addr: 0xe1020400, offset: 0, from: 0x631000028830, length: 14
e1000e_core_write Write to register 0x400, 4 byte(s), value: 0xff
e1000e_tx_descr 0xe1020400 : ff31008a 0
e1000e_irq_rearm_timer Mitigation timer armed for register 0x3820, delay 0 ns
e1000e_irq_set_cause_entry Going to set IRQ cause 0x2, ICR: 0x0
e1000e_irq_set_cause_exit Set IRQ cause 0x3, ICR: 0x3
e1000e_irq_fix_icr_asserted ICR_ASSERTED bit fixed: 0x80000003
e1000e_irq_pending_interrupts ICR PENDING: 0x0 (ICR: 0x80000003, IMS: 0x0)
e1000e_irq_legacy_notify IRQ line state: 0
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x404, 4 byte(s), value: 0x0
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x408, 4 byte(s), value: 0x0
e1000e_wrn_regs_write_unknown WARNING: Write to unknown register 0x40c, 4 byte(s), value: 0x0
e1000e_rx_desc_buff_write buffer #0, addr: 0xe1020400, offset: 14, from: 0x62500024200e, length: 124
=================================================================
==32103==ERROR: AddressSanitizer: heap-use-after-free on address 0x62500024200e at pc 0x55cd3c40c9aa bp 0x7ffd97112bf0 sp 0x7ffd971123a0</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jasowang" class="sprite person">Jason Wang (jasowang)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-14T08:56:05+00:00" title="2020-07-14 08:56:05 UTC">on 2020-07-14</time><span class="editable-message-last-edit-date">:
              </span>
              <a href="/qemu/+bug/1886362/comments/2">
                <strong>Re: [Bug 1886362] [NEW] Heap use-after-free in lduw_he_p through e1000e_write_to_rx_buffers</strong>
              </a>
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 2020/7/10 下午6:37, Li Qiang wrote:<br />
<span class="foldable-quoted">
&gt; Paolo Bonzini &lt;email address hidden&gt; 于2020年7月10日周五 上午1:36写道：<br />
&gt;&gt; On 09/07/20 17:51, Li Qiang wrote:<br />
&gt;&gt;&gt; Maybe we should check whether the address is a RAM address in &#x27;dma_memory_rw&#x27;?<br />
&gt;&gt;&gt; But it is a hot path. I&#x27;m not sure it is right. Hope more discussion.<br />
&gt;&gt; Half of the purpose of dma-helpers.c (as opposed to address_space_*<br />
&gt;&gt; functions in exec.c) is exactly to support writes to MMIO.  This is<br />
&gt; Hi Paolo,<br />
&gt;<br />
&gt; Could you please explain more about this(to support writes to MMIO).<br />
&gt; I can just see the dma helpers with sg DMA, not related with MMIO.
</span></p>
<p>Please refer doc/devel/<wbr />memory.<wbr />rst.</p>
<p>The motivation of memory API is to allow support modeling different<br />
memory regions. DMA to MMIO is allowed in hardware so Qemu should<br />
emulate this behaviour.</p>
<p><span class="foldable-quoted">&gt;<br />
&gt;<br />
&gt;&gt; especially true of dma_blk_io, which takes care of doing the DMA via a<br />
&gt;&gt; bounce buffer, possibly in multiple steps and even blocking due to<br />
&gt;&gt; cpu_register_<wbr />map_client.<br />
&gt;&gt;<br />
&gt;&gt; For dma_memory_rw this is not needed, so it only needs to handle<br />
&gt;&gt; QEMUSGList, but I think the design should be the same.<br />
&gt;&gt;<br />
&gt;&gt; However, this is indeed a nightmare for re-entrancy.  The easiest<br />
&gt;&gt; solution is to delay processing of descriptors to a bottom half whenever<br />
&gt;&gt; MMIO is doing something complicated.  This is also better for latency<br />
&gt;&gt; because it will free the vCPU thread more quickly and leave the work to<br />
&gt;&gt; the I/O thread.<br />
&gt; Do you mean we define a per-e1000e bottom half. And in the MMIO write<br />
&gt; or packet send<br />
&gt; trigger this bh?
</span></p>
<p>Probably a TX bh.</p>
<p><span class="foldable-quoted">&gt; So even if we again trigger the MMIO write, then<br />
&gt; second bh will not be executed?
</span></p>
<p>Bh is serialized so no re-entrancy issue.</p>
<p>Thanks</p>
<p><span class="foldable-quoted">&gt;<br />
&gt;<br />
&gt; Thanks,<br />
&gt; Li Qiang<br />
&gt;<br />
&gt;&gt; Paolo<br />
&gt;&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
On 2020/7/10 下午6:37, Li Qiang wrote:
&gt; Paolo Bonzini &lt;pbonzini@redhat.com&gt; 于2020年7月10日周五 上午1:36写道：
&gt;&gt; On 09/07/20 17:51, Li Qiang wrote:
&gt;&gt;&gt; Maybe we should check whether the address is a RAM address in 'dma_memory_rw'?
&gt;&gt;&gt; But it is a hot path. I'm not sure it is right. Hope more discussion.
&gt;&gt; Half of the purpose of dma-helpers.c (as opposed to address_space_*
&gt;&gt; functions in exec.c) is exactly to support writes to MMIO.  This is
&gt; Hi Paolo,
&gt;
&gt; Could you please explain more about this(to support writes to MMIO).
&gt; I can just see the dma helpers with sg DMA, not related with MMIO.


Please refer doc/devel/memory.rst.

The motivation of memory API is to allow support modeling different 
memory regions. DMA to MMIO is allowed in hardware so Qemu should 
emulate this behaviour.


&gt;
&gt;
&gt;&gt; especially true of dma_blk_io, which takes care of doing the DMA via a
&gt;&gt; bounce buffer, possibly in multiple steps and even blocking due to
&gt;&gt; cpu_register_map_client.
&gt;&gt;
&gt;&gt; For dma_memory_rw this is not needed, so it only needs to handle
&gt;&gt; QEMUSGList, but I think the design should be the same.
&gt;&gt;
&gt;&gt; However, this is indeed a nightmare for re-entrancy.  The easiest
&gt;&gt; solution is to delay processing of descriptors to a bottom half whenever
&gt;&gt; MMIO is doing something complicated.  This is also better for latency
&gt;&gt; because it will free the vCPU thread more quickly and leave the work to
&gt;&gt; the I/O thread.
&gt; Do you mean we define a per-e1000e bottom half. And in the MMIO write
&gt; or packet send
&gt; trigger this bh?


Probably a TX bh.


&gt; So even if we again trigger the MMIO write, then
&gt; second bh will not be executed?


Bh is serialized so no re-entrancy issue.

Thanks


&gt;
&gt;
&gt; Thanks,
&gt; Li Qiang
&gt;
&gt;&gt; Paolo
&gt;&gt;

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jasowang" class="sprite person">Jason Wang (jasowang)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-15T08:35:09+00:00" title="2020-07-15 08:35:09 UTC">on 2020-07-15</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 2020/7/14 下午6:48, Li Qiang wrote:<br />
<span class="foldable-quoted">
&gt; Jason Wang &lt;email address hidden&gt; 于2020年7月14日周二 下午4:56写道：<br />
&gt;&gt;<br />
&gt;&gt; On 2020/7/10 下午6:37, Li Qiang wrote:<br />
&gt;&gt;&gt; Paolo Bonzini &lt;email address hidden&gt; 于2020年7月10日周五 上午1:36写道：<br />
&gt;&gt;&gt;&gt; On 09/07/20 17:51, Li Qiang wrote:<br />
&gt;&gt;&gt;&gt;&gt; Maybe we should check whether the address is a RAM address in &#x27;dma_memory_rw&#x27;?<br />
&gt;&gt;&gt;&gt;&gt; But it is a hot path. I&#x27;m not sure it is right. Hope more discussion.<br />
&gt;&gt;&gt;&gt; Half of the purpose of dma-helpers.c (as opposed to address_space_*<br />
&gt;&gt;&gt;&gt; functions in exec.c) is exactly to support writes to MMIO.  This is<br />
&gt;&gt;&gt; Hi Paolo,<br />
&gt;&gt;&gt;<br />
&gt;&gt;&gt; Could you please explain more about this(to support writes to MMIO).<br />
&gt;&gt;&gt; I can just see the dma helpers with sg DMA, not related with MMIO.<br />
&gt;&gt;<br />
&gt;&gt; Please refer doc/devel/<wbr />memory.<wbr />rst.<br />
&gt;&gt;<br />
&gt;&gt; The motivation of memory API is to allow support modeling different<br />
&gt;&gt; memory regions. DMA to MMIO is allowed in hardware so Qemu should<br />
&gt;&gt; emulate this behaviour.<br />
&gt;&gt;<br />
&gt; I just read the code again.<br />
&gt; So the dma_blk_io is used for some device that will need DMA to<br />
&gt; MMIO(may be related with<br />
&gt; device spec).  But for most of the devices(networking card for<br />
&gt; example) there is no need this DMA to MMIO.<br />
&gt; So we just ksuse dma_memory_rw.  Is this understanding right?<br />
&gt;<br />
&gt; Then another question.<br />
&gt; Though the dma helpers uses a bouncing buffer, it finally write to the<br />
&gt; device addressspace in &#x27;address_<wbr />space_unmap&#x27;<wbr />.<br />
&gt; Is there any posibility that we can again write to the MMIO like this issue?
</span></p>
<p>I think the point is to make DMA to MMIO work as real hardware. For<br />
e1000e and other networking devices we need make sure such DMA doesn&#x27;t<br />
break anything.</p>
<p>Thanks</p>
<p><span class="foldable-quoted">&gt;<br />
&gt;<br />
&gt;&gt;&gt;<br />
&gt;&gt;&gt;&gt; especially true of dma_blk_io, which takes care of doing the DMA via a<br />
&gt;&gt;&gt;&gt; bounce buffer, possibly in multiple steps and even blocking due to<br />
&gt;&gt;&gt;&gt; cpu_register_<wbr />map_client.<br />
&gt;&gt;&gt;&gt;<br />
&gt;&gt;&gt;&gt; For dma_memory_rw this is not needed, so it only needs to handle<br />
&gt;&gt;&gt;&gt; QEMUSGList, but I think the design should be the same.<br />
&gt;&gt;&gt;&gt;<br />
&gt;&gt;&gt;&gt; However, this is indeed a nightmare for re-entrancy.  The easiest<br />
&gt;&gt;&gt;&gt; solution is to delay processing of descriptors to a bottom half whenever<br />
&gt;&gt;&gt;&gt; MMIO is doing something complicated.  This is also better for latency<br />
&gt;&gt;&gt;&gt; because it will free the vCPU thread more quickly and leave the work to<br />
&gt;&gt;&gt;&gt; the I/O thread.<br />
&gt;&gt;&gt; Do you mean we define a per-e1000e bottom half. And in the MMIO write<br />
&gt;&gt;&gt; or packet send<br />
&gt;&gt;&gt; trigger this bh?<br />
&gt;&gt;<br />
&gt;&gt; Probably a TX bh.<br />
&gt;&gt;<br />
&gt; I will try to write this tx bh to strength my understanding in this part.<br />
&gt; Maybe reference the virtio-net implementation I think.<br />
&gt;<br />
&gt;<br />
&gt;<br />
&gt; Thanks,<br />
&gt; Li Qiang<br />
&gt;<br />
&gt;&gt;&gt; So even if we again trigger the MMIO write, then<br />
&gt;&gt;&gt; second bh will not be executed?<br />
&gt;&gt;<br />
&gt;&gt; Bh is serialized so no re-entrancy issue.<br />
&gt;&gt;<br />
&gt;&gt; Thanks<br />
&gt;&gt;<br />
&gt;&gt;<br />
&gt;&gt;&gt;<br />
&gt;&gt;&gt; Thanks,<br />
&gt;&gt;&gt; Li Qiang<br />
&gt;&gt;&gt;<br />
&gt;&gt;&gt;&gt; Paolo<br />
&gt;&gt;&gt;&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
On 2020/7/14 下午6:48, Li Qiang wrote:
&gt; Jason Wang &lt;jasowang@redhat.com&gt; 于2020年7月14日周二 下午4:56写道：
&gt;&gt;
&gt;&gt; On 2020/7/10 下午6:37, Li Qiang wrote:
&gt;&gt;&gt; Paolo Bonzini &lt;pbonzini@redhat.com&gt; 于2020年7月10日周五 上午1:36写道：
&gt;&gt;&gt;&gt; On 09/07/20 17:51, Li Qiang wrote:
&gt;&gt;&gt;&gt;&gt; Maybe we should check whether the address is a RAM address in 'dma_memory_rw'?
&gt;&gt;&gt;&gt;&gt; But it is a hot path. I'm not sure it is right. Hope more discussion.
&gt;&gt;&gt;&gt; Half of the purpose of dma-helpers.c (as opposed to address_space_*
&gt;&gt;&gt;&gt; functions in exec.c) is exactly to support writes to MMIO.  This is
&gt;&gt;&gt; Hi Paolo,
&gt;&gt;&gt;
&gt;&gt;&gt; Could you please explain more about this(to support writes to MMIO).
&gt;&gt;&gt; I can just see the dma helpers with sg DMA, not related with MMIO.
&gt;&gt;
&gt;&gt; Please refer doc/devel/memory.rst.
&gt;&gt;
&gt;&gt; The motivation of memory API is to allow support modeling different
&gt;&gt; memory regions. DMA to MMIO is allowed in hardware so Qemu should
&gt;&gt; emulate this behaviour.
&gt;&gt;
&gt; I just read the code again.
&gt; So the dma_blk_io is used for some device that will need DMA to
&gt; MMIO(may be related with
&gt; device spec).  But for most of the devices(networking card for
&gt; example) there is no need this DMA to MMIO.
&gt; So we just ksuse dma_memory_rw.  Is this understanding right?
&gt;
&gt; Then another question.
&gt; Though the dma helpers uses a bouncing buffer, it finally write to the
&gt; device addressspace in 'address_space_unmap'.
&gt; Is there any posibility that we can again write to the MMIO like this issue?


I think the point is to make DMA to MMIO work as real hardware. For 
e1000e and other networking devices we need make sure such DMA doesn't 
break anything.

Thanks


&gt;
&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; especially true of dma_blk_io, which takes care of doing the DMA via a
&gt;&gt;&gt;&gt; bounce buffer, possibly in multiple steps and even blocking due to
&gt;&gt;&gt;&gt; cpu_register_map_client.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; For dma_memory_rw this is not needed, so it only needs to handle
&gt;&gt;&gt;&gt; QEMUSGList, but I think the design should be the same.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; However, this is indeed a nightmare for re-entrancy.  The easiest
&gt;&gt;&gt;&gt; solution is to delay processing of descriptors to a bottom half whenever
&gt;&gt;&gt;&gt; MMIO is doing something complicated.  This is also better for latency
&gt;&gt;&gt;&gt; because it will free the vCPU thread more quickly and leave the work to
&gt;&gt;&gt;&gt; the I/O thread.
&gt;&gt;&gt; Do you mean we define a per-e1000e bottom half. And in the MMIO write
&gt;&gt;&gt; or packet send
&gt;&gt;&gt; trigger this bh?
&gt;&gt;
&gt;&gt; Probably a TX bh.
&gt;&gt;
&gt; I will try to write this tx bh to strength my understanding in this part.
&gt; Maybe reference the virtio-net implementation I think.
&gt;
&gt;
&gt;
&gt; Thanks,
&gt; Li Qiang
&gt;
&gt;&gt;&gt; So even if we again trigger the MMIO write, then
&gt;&gt;&gt; second bh will not be executed?
&gt;&gt;
&gt;&gt; Bh is serialized so no re-entrancy issue.
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt;
&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Li Qiang
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Paolo
&gt;&gt;&gt;&gt;

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-21T12:14:08.233160+00:00" title="2020-07-21 12:14:08 UTC">on 2020-07-21</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Another reproducer: (just to record)</p>
<p>cat &lt;&lt; EOF | ./i386-<wbr />softmmu/<wbr />qemu-system-<wbr />i386 -M pc-q35-5.0 \<br />
-netdev user,id=qtest-bn0 -device e1000e,<wbr />netdev=<wbr />qtest-bn0 \<br />
-display none -nodefaults -nographic -qtest stdio<br />
outl 0xcf8 0x80000810<br />
outl 0xcfc 0xe0000000<br />
outl 0xcf8 0x80000804<br />
outw 0xcfc 0x7<br />
write 0xe0000758 0x4 0xfffff1ff<br />
write 0xe0000760 0x6 0xffffdf000000<br />
write 0xe0000768 0x4 0x0efffff1<br />
write 0xe0005008 0x4 0x18ffff27<br />
write 0xe0000c 0x1 0x66<br />
write 0xe03320 0x1 0xff<br />
write 0xe03620 0x1 0xff<br />
write 0xe00000f3 0x1 0xdf<br />
write 0xe0000100 0x6 0xdfffffdf0000<br />
write 0xe0000110 0x5 0xdfffffdf00<br />
write 0xe000011a 0x3 0xffffff<br />
write 0xe0000128 0x5 0x7e00ffffff<br />
write 0xe0000403 0x1 0xdf<br />
write 0xe0000420 0x4 0xdfffffdf<br />
write 0xe000042a 0x3 0xffffff<br />
write 0xe0000438 0x1 0x7e<br />
EOF</p>
<p>-&gt; <a rel="nofollow" href="https://lists.gnu.org/archive/html/qemu-devel/2020-07/msg05709.html">https:/<wbr />/lists.<wbr />gnu.org/<wbr />archive/<wbr />html/qemu-<wbr />devel/2020-<wbr />07/msg05709.<wbr />html</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Another reproducer: (just to record)

cat &lt;&lt; EOF | ./i386-softmmu/qemu-system-i386 -M pc-q35-5.0 \
-netdev user,id=qtest-bn0 -device e1000e,netdev=qtest-bn0 \
-display none -nodefaults -nographic -qtest stdio
outl 0xcf8 0x80000810
outl 0xcfc 0xe0000000
outl 0xcf8 0x80000804
outw 0xcfc 0x7
write 0xe0000758 0x4 0xfffff1ff
write 0xe0000760 0x6 0xffffdf000000
write 0xe0000768 0x4 0x0efffff1
write 0xe0005008 0x4 0x18ffff27
write 0xe0000c 0x1 0x66
write 0xe03320 0x1 0xff
write 0xe03620 0x1 0xff
write 0xe00000f3 0x1 0xdf
write 0xe0000100 0x6 0xdfffffdf0000
write 0xe0000110 0x5 0xdfffffdf00
write 0xe000011a 0x3 0xffffff
write 0xe0000128 0x5 0x7e00ffffff
write 0xe0000403 0x1 0xdf
write 0xe0000420 0x4 0xdfffffdf
write 0xe000042a 0x3 0xffffff
write 0xe0000438 0x1 0x7e
EOF

-&gt; https://lists.gnu.org/archive/html/qemu-devel/2020-07/msg05709.html</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pmaydell" class="sprite person">Peter Maydell (pmaydell)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-21T12:31:57+00:00" title="2020-07-21 12:31:57 UTC">on 2020-07-21</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; I think the point is to make DMA to MMIO work as real hardware.
</span></p>
<p>I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
of a real h/w device is going to be decoupled somewhat from<br />
the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
it probably wasn&#x27;t something the designers were actively<br />
thinking about either...</p>
<p><span class="foldable-quoted">&gt; For<br />
&gt; e1000e and other networking devices we need make sure such DMA doesn&#x27;t<br />
&gt; break anything.
</span></p>
<p>Yeah, this is the interesting part for QEMU. How should we<br />
structure devices that do DMA so that we can be sure that<br />
the device emulation at least doesn&#x27;t crash? We could have<br />
a rule that all devices that do DMA must always postpone<br />
all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
refactoring of a lot of device code...</p>
<p>thanks<br />
-- PMM</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt; I think the point is to make DMA to MMIO work as real hardware.

I wouldn't care to give a 100% guarantee that asking a real
h/w device to DMA to itself didn't cause it to misbehave :-)
It's more likely to happen-to-work because the DMA engine bit
of a real h/w device is going to be decoupled somewhat from
the respond-to-memory-transactions-for-registers logic, but
it probably wasn't something the designers were actively
thinking about either...

&gt; For
&gt; e1000e and other networking devices we need make sure such DMA doesn't
&gt; break anything.

Yeah, this is the interesting part for QEMU. How should we
structure devices that do DMA so that we can be sure that
the device emulation at least doesn't crash? We could have
a rule that all devices that do DMA must always postpone
all of that DMA to a bottom-half, but that's a lot of
refactoring of a lot of device code...

thanks
-- PMM
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jasowang" class="sprite person">Jason Wang (jasowang)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-21T13:21:20+00:00" title="2020-07-21 13:21:20 UTC">on 2020-07-21</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 2020/7/21 下午8:31, Peter Maydell wrote:<br />
<span class="foldable-quoted">
&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.<br />
&gt; I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
&gt; h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
&gt; It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
&gt; of a real h/w device is going to be decoupled somewhat from<br />
&gt; the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
&gt; it probably wasn&#x27;t something the designers were actively<br />
&gt; thinking about either...
</span></p>
<p>I think some device want such peer to peer transactions:</p>
<p><a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst">https:/<wbr />/git.kernel.<wbr />org/pub/<wbr />scm/linux/<wbr />kernel/<wbr />git/torvalds/<wbr />linux.git/<wbr />tree/Documentat<wbr />ion/driver-<wbr />api/pci/<wbr />p2pdma.<wbr />rst</a></p>
<p><span class="foldable-quoted">&gt;<br />
&gt;&gt; For<br />
&gt;&gt; e1000e and other networking devices we need make sure such DMA doesn&#x27;t<br />
&gt;&gt; break anything.<br />
&gt; Yeah, this is the interesting part for QEMU. How should we<br />
&gt; structure devices that do DMA so that we can be sure that<br />
&gt; the device emulation at least doesn&#x27;t crash? We could have<br />
&gt; a rule that all devices that do DMA must always postpone<br />
&gt; all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
&gt; refactoring of a lot of device code...
</span></p>
<p>It looks to me the issue happens only for device with loopback</p>
<p>Simply git grep loopback in hw/net tells me we probably need only to<br />
audit dp8393x and rtl8139.</p>
<p>Qiang, want to help to audit those devices?</p>
<p>Thanks</p>
<p><span class="foldable-quoted">&gt;<br />
&gt; thanks<br />
&gt; -- PMM<br />
&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
On 2020/7/21 下午8:31, Peter Maydell wrote:
&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.
&gt; I wouldn't care to give a 100% guarantee that asking a real
&gt; h/w device to DMA to itself didn't cause it to misbehave :-)
&gt; It's more likely to happen-to-work because the DMA engine bit
&gt; of a real h/w device is going to be decoupled somewhat from
&gt; the respond-to-memory-transactions-for-registers logic, but
&gt; it probably wasn't something the designers were actively
&gt; thinking about either...


I think some device want such peer to peer transactions:

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst


&gt;
&gt;&gt; For
&gt;&gt; e1000e and other networking devices we need make sure such DMA doesn't
&gt;&gt; break anything.
&gt; Yeah, this is the interesting part for QEMU. How should we
&gt; structure devices that do DMA so that we can be sure that
&gt; the device emulation at least doesn't crash? We could have
&gt; a rule that all devices that do DMA must always postpone
&gt; all of that DMA to a bottom-half, but that's a lot of
&gt; refactoring of a lot of device code...


It looks to me the issue happens only for device with loopback

Simply git grep loopback in hw/net tells me we probably need only to 
audit dp8393x and rtl8139.

Qiang, want to help to audit those devices?

Thanks


&gt;
&gt; thanks
&gt; -- PMM
&gt;

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pmaydell" class="sprite person">Peter Maydell (pmaydell)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-21T13:44:37+00:00" title="2020-07-21 13:44:37 UTC">on 2020-07-21</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:<br />
&gt; &gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt; &gt;&gt; I think the point is to make DMA to MMIO work as real hardware.<br />
&gt; &gt; I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
&gt; &gt; h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
&gt; &gt; It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
&gt; &gt; of a real h/w device is going to be decoupled somewhat from<br />
&gt; &gt; the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
&gt; &gt; it probably wasn&#x27;t something the designers were actively<br />
&gt; &gt; thinking about either...
</span></p>
<p><span class="foldable-quoted">&gt; I think some device want such peer to peer transactions:<br />
&gt;<br />
&gt; <a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst">https:/<wbr />/git.kernel.<wbr />org/pub/<wbr />scm/linux/<wbr />kernel/<wbr />git/torvalds/<wbr />linux.git/<wbr />tree/Documentat<wbr />ion/driver-<wbr />api/pci/<wbr />p2pdma.<wbr />rst</a>
</span></p>
<p>That&#x27;s a device DMAing to another device, not DMAing to *itself*<br />
(device-<wbr />to-another-<wbr />device DMA should work fine in QEMU). And only<br />
a very few devices will ever be sensible targets of the DMA --<br />
basically things like nvme that have a looks-like-memory area,<br />
or special cases like doorbell registers.</p>
<p><span class="foldable-quoted">&gt; &gt; Yeah, this is the interesting part for QEMU. How should we<br />
&gt; &gt; structure devices that do DMA so that we can be sure that<br />
&gt; &gt; the device emulation at least doesn&#x27;t crash? We could have<br />
&gt; &gt; a rule that all devices that do DMA must always postpone<br />
&gt; &gt; all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
&gt; &gt; refactoring of a lot of device code...<br />
&gt;<br />
&gt;<br />
&gt; It looks to me the issue happens only for device with loopback
</span></p>
<p>I think in principle we have a problem for any device that<br />
(a) has memory mapped registers and (b) does DMA reads<br />
whose address is guest-controlled. Loopback isn&#x27;t a<br />
requirement -- if the guest programs, say, an RX descriptor<br />
base address to point at the device&#x27;s own registers, you<br />
get exactly the same kind of unexpected-<wbr />reentrancy.</p>
<p>thanks<br />
-- PMM</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:
&gt; &gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt; &gt;&gt; I think the point is to make DMA to MMIO work as real hardware.
&gt; &gt; I wouldn't care to give a 100% guarantee that asking a real
&gt; &gt; h/w device to DMA to itself didn't cause it to misbehave :-)
&gt; &gt; It's more likely to happen-to-work because the DMA engine bit
&gt; &gt; of a real h/w device is going to be decoupled somewhat from
&gt; &gt; the respond-to-memory-transactions-for-registers logic, but
&gt; &gt; it probably wasn't something the designers were actively
&gt; &gt; thinking about either...

&gt; I think some device want such peer to peer transactions:
&gt;
&gt; https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst

That's a device DMAing to another device, not DMAing to *itself*
(device-to-another-device DMA should work fine in QEMU). And only
a very few devices will ever be sensible targets of the DMA --
basically things like nvme that have a looks-like-memory area,
or special cases like doorbell registers.

&gt; &gt; Yeah, this is the interesting part for QEMU. How should we
&gt; &gt; structure devices that do DMA so that we can be sure that
&gt; &gt; the device emulation at least doesn't crash? We could have
&gt; &gt; a rule that all devices that do DMA must always postpone
&gt; &gt; all of that DMA to a bottom-half, but that's a lot of
&gt; &gt; refactoring of a lot of device code...
&gt;
&gt;
&gt; It looks to me the issue happens only for device with loopback

I think in principle we have a problem for any device that
(a) has memory mapped registers and (b) does DMA reads
whose address is guest-controlled. Loopback isn't a
requirement -- if the guest programs, say, an RX descriptor
base address to point at the device's own registers, you
get exactly the same kind of unexpected-reentrancy.

thanks
-- PMM
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/8" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~a1xndr" class="sprite person">Alexander Bulekov (a1xndr)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-21T14:37:28+00:00" title="2020-07-21 14:37:28 UTC">on 2020-07-21</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/8"> #8</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 200721 1444, Peter Maydell wrote:<br />
<span class="foldable-quoted">
&gt; On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt; &gt; On 2020/7/21 下午8:31, Peter Maydell wrote:<br />
&gt; &gt; &gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt; &gt; &gt;&gt; I think the point is to make DMA to MMIO work as real hardware.<br />
&gt; &gt; &gt; I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
&gt; &gt; &gt; h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
&gt; &gt; &gt; It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
&gt; &gt; &gt; of a real h/w device is going to be decoupled somewhat from<br />
&gt; &gt; &gt; the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
&gt; &gt; &gt; it probably wasn&#x27;t something the designers were actively<br />
&gt; &gt; &gt; thinking about either...<br />
&gt;<br />
</span>

I searched around but couldn&#x27;t find anything talking about this case for<br />
real hardware. I also looked at some HDL code for FPGAs that do DMA, but<br />
it seems most of the PCI DMA components are contained in proprietary<br />
IPs, though maybe I&#x27;m missing something (I&#x27;ve never programmed<br />
a DMA-capable FPGA).</p>
<p><span class="foldable-quoted">&gt; &gt; I think some device want such peer to peer transactions:<br />
&gt; &gt;<br />
&gt; &gt; <a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst">https:/<wbr />/git.kernel.<wbr />org/pub/<wbr />scm/linux/<wbr />kernel/<wbr />git/torvalds/<wbr />linux.git/<wbr />tree/Documentat<wbr />ion/driver-<wbr />api/pci/<wbr />p2pdma.<wbr />rst</a><br />
&gt;<br />
&gt; That&#x27;s a device DMAing to another device, not DMAing to *itself*<br />
&gt; (device-<wbr />to-another-<wbr />device DMA should work fine in QEMU). And only<br />
&gt; a very few devices will ever be sensible targets of the DMA --<br />
&gt; basically things like nvme that have a looks-like-memory area,<br />
&gt; or special cases like doorbell registers.<br />
&gt;<br />
&gt; &gt; &gt; Yeah, this is the interesting part for QEMU. How should we<br />
&gt; &gt; &gt; structure devices that do DMA so that we can be sure that<br />
&gt; &gt; &gt; the device emulation at least doesn&#x27;t crash? We could have<br />
&gt; &gt; &gt; a rule that all devices that do DMA must always postpone<br />
&gt; &gt; &gt; all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
&gt; &gt; &gt; refactoring of a lot of device code...<br />
&gt; &gt;<br />
&gt; &gt;<br />
&gt; &gt; It looks to me the issue happens only for device with loopback<br />
&gt;<br />
&gt; I think in principle we have a problem for any device that<br />
&gt; (a) has memory mapped registers and (b) does DMA reads<br />
&gt; whose address is guest-controlled. Loopback isn&#x27;t a<br />
&gt; requirement -- if the guest programs, say, an RX descriptor<br />
&gt; base address to point at the device&#x27;s own registers, you<br />
&gt; get exactly the same kind of unexpected-<wbr />reentrancy.
</span></p>
<p>Could this be something that we check for in the<br />
pci_dma_* functions in hw/pci/pci.h? There we still have context about<br />
the source device for the dma read/write and could, compare addr against<br />
the device&#x27;s PCI BARr&#x27;s. Not sure about:<br />
1.) How to do this without the overhead of convering the addr<br />
to a MemoryRegion, which is normally done, once, at the flatview_write<br />
stage.<br />
2.) What to do if we catch such a DMA request? Quietly drop it?<br />
3.) Non-PCI devices.</p>
<p>I think this still doesn&#x27;t cover the even crazier case where:<br />
CPU writes to DEV_A&#x27;s MMIO<br />
DEV_A writes to DEV_B&#x27;s MMIO<br />
DEV_B writes to DEV_A&#x27;s MMIO<br />
and neither DEV_A or DEV_B use BHs...</p>
<p>-Alex</p>
<p><span class="foldable-quoted">&gt; thanks<br />
&gt; -- PMM<br />
&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On 200721 1444, Peter Maydell wrote:
&gt; On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt; &gt; On 2020/7/21 下午8:31, Peter Maydell wrote:
&gt; &gt; &gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt; &gt; &gt;&gt; I think the point is to make DMA to MMIO work as real hardware.
&gt; &gt; &gt; I wouldn't care to give a 100% guarantee that asking a real
&gt; &gt; &gt; h/w device to DMA to itself didn't cause it to misbehave :-)
&gt; &gt; &gt; It's more likely to happen-to-work because the DMA engine bit
&gt; &gt; &gt; of a real h/w device is going to be decoupled somewhat from
&gt; &gt; &gt; the respond-to-memory-transactions-for-registers logic, but
&gt; &gt; &gt; it probably wasn't something the designers were actively
&gt; &gt; &gt; thinking about either...
&gt;
I searched around but couldn't find anything talking about this case for
real hardware. I also looked at some HDL code for FPGAs that do DMA, but
it seems most of the PCI DMA components are contained in proprietary
IPs, though maybe I'm missing something (I've never programmed
a DMA-capable FPGA).

&gt; &gt; I think some device want such peer to peer transactions:
&gt; &gt;
&gt; &gt; https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst
&gt; 
&gt; That's a device DMAing to another device, not DMAing to *itself*
&gt; (device-to-another-device DMA should work fine in QEMU). And only
&gt; a very few devices will ever be sensible targets of the DMA --
&gt; basically things like nvme that have a looks-like-memory area,
&gt; or special cases like doorbell registers.
&gt; 
&gt; &gt; &gt; Yeah, this is the interesting part for QEMU. How should we
&gt; &gt; &gt; structure devices that do DMA so that we can be sure that
&gt; &gt; &gt; the device emulation at least doesn't crash? We could have
&gt; &gt; &gt; a rule that all devices that do DMA must always postpone
&gt; &gt; &gt; all of that DMA to a bottom-half, but that's a lot of
&gt; &gt; &gt; refactoring of a lot of device code...
&gt; &gt;
&gt; &gt;
&gt; &gt; It looks to me the issue happens only for device with loopback
&gt; 
&gt; I think in principle we have a problem for any device that
&gt; (a) has memory mapped registers and (b) does DMA reads
&gt; whose address is guest-controlled. Loopback isn't a
&gt; requirement -- if the guest programs, say, an RX descriptor
&gt; base address to point at the device's own registers, you
&gt; get exactly the same kind of unexpected-reentrancy.

Could this be something that we check for in the
pci_dma_* functions in hw/pci/pci.h? There we still have context about
the source device for the dma read/write and could, compare addr against
the device's PCI BARr's. Not sure about:
1.) How to do this without the overhead of convering the addr
to a MemoryRegion, which is normally done, once, at the flatview_write
stage.
2.) What to do if we catch such a DMA request? Quietly drop it?
3.) Non-PCI devices.

I think this still doesn't cover the even crazier case where:
CPU writes to DEV_A's MMIO
DEV_A writes to DEV_B's MMIO
DEV_B writes to DEV_A's MMIO
and neither DEV_A or DEV_B use BHs...

-Alex

&gt; thanks
&gt; -- PMM
&gt; 
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/9" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jasowang" class="sprite person">Jason Wang (jasowang)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-22T03:25:32+00:00" title="2020-07-22 03:25:32 UTC">on 2020-07-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/9"> #9</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 2020/7/21 下午9:44, Peter Maydell wrote:<br />
<span class="foldable-quoted">
&gt; On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt;&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:<br />
&gt;&gt;&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt;&gt;&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.<br />
&gt;&gt;&gt; I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
&gt;&gt;&gt; h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
&gt;&gt;&gt; It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
&gt;&gt;&gt; of a real h/w device is going to be decoupled somewhat from<br />
&gt;&gt;&gt; the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
&gt;&gt;&gt; it probably wasn&#x27;t something the designers were actively<br />
&gt;&gt;&gt; thinking about either...<br />
&gt;&gt; I think some device want such peer to peer transactions:<br />
&gt;&gt;<br />
&gt;&gt; <a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst">https:/<wbr />/git.kernel.<wbr />org/pub/<wbr />scm/linux/<wbr />kernel/<wbr />git/torvalds/<wbr />linux.git/<wbr />tree/Documentat<wbr />ion/driver-<wbr />api/pci/<wbr />p2pdma.<wbr />rst</a><br />
&gt; That&#x27;s a device DMAing to another device, not DMAing to *itself*<br />
&gt; (device-<wbr />to-another-<wbr />device DMA should work fine in QEMU). And only<br />
&gt; a very few devices will ever be sensible targets of the DMA --<br />
&gt; basically things like nvme that have a looks-like-memory area,<br />
&gt; or special cases like doorbell registers.
</span></p>
<p>Well, my understanding is:</p>
<p>- it&#x27;s not about whether or not we have an actual device that can do DMA<br />
into itself but whether it&#x27;s allowed by PCI spec<br />
- it&#x27;s not really matter whether or not it tries to DMA into itself.<br />
Devices could be taught to DMA into each other&#x27;s RX:</p>
<p>e1000e(1) RX DMA to e1000e(2) MMIO (RX)<br />
e1000e(2) RX DMA to e1000e(1) RX</p>
<p>So we get re-reentrancy again.</p>
<p><span class="foldable-quoted">&gt;<br />
&gt;&gt;&gt; Yeah, this is the interesting part for QEMU. How should we<br />
&gt;&gt;&gt; structure devices that do DMA so that we can be sure that<br />
&gt;&gt;&gt; the device emulation at least doesn&#x27;t crash? We could have<br />
&gt;&gt;&gt; a rule that all devices that do DMA must always postpone<br />
&gt;&gt;&gt; all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
&gt;&gt;&gt; refactoring of a lot of device code...<br />
&gt;&gt;<br />
&gt;&gt; It looks to me the issue happens only for device with loopback<br />
&gt; I think in principle we have a problem for any device that<br />
&gt; (a) has memory mapped registers and (b) does DMA reads<br />
&gt; whose address is guest-controlled. Loopback isn&#x27;t a<br />
&gt; requirement -- if the guest programs, say, an RX descriptor<br />
&gt; base address to point at the device&#x27;s own registers, you<br />
&gt; get exactly the same kind of unexpected-<wbr />reentrancy.
</span></p>
<p>Right, so about the solution, instead of refactoring DMA I wonder we can<br />
simply detect and fail the RX by device itself.</p>
<p>Thanks</p>
<p><span class="foldable-quoted">&gt;<br />
&gt; thanks<br />
&gt; -- PMM<br />
&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
On 2020/7/21 下午9:44, Peter Maydell wrote:
&gt; On Tue, 21 Jul 2020 at 14:21, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt;&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:
&gt;&gt;&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt;&gt;&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.
&gt;&gt;&gt; I wouldn't care to give a 100% guarantee that asking a real
&gt;&gt;&gt; h/w device to DMA to itself didn't cause it to misbehave :-)
&gt;&gt;&gt; It's more likely to happen-to-work because the DMA engine bit
&gt;&gt;&gt; of a real h/w device is going to be decoupled somewhat from
&gt;&gt;&gt; the respond-to-memory-transactions-for-registers logic, but
&gt;&gt;&gt; it probably wasn't something the designers were actively
&gt;&gt;&gt; thinking about either...
&gt;&gt; I think some device want such peer to peer transactions:
&gt;&gt;
&gt;&gt; https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst
&gt; That's a device DMAing to another device, not DMAing to *itself*
&gt; (device-to-another-device DMA should work fine in QEMU). And only
&gt; a very few devices will ever be sensible targets of the DMA --
&gt; basically things like nvme that have a looks-like-memory area,
&gt; or special cases like doorbell registers.


Well, my understanding is:

- it's not about whether or not we have an actual device that can do DMA 
into itself but whether it's allowed by PCI spec
- it's not really matter whether or not it tries to DMA into itself. 
Devices could be taught to DMA into each other's RX:

e1000e(1) RX DMA to e1000e(2) MMIO (RX)
e1000e(2) RX DMA to e1000e(1) RX

So we get re-reentrancy again.


&gt;
&gt;&gt;&gt; Yeah, this is the interesting part for QEMU. How should we
&gt;&gt;&gt; structure devices that do DMA so that we can be sure that
&gt;&gt;&gt; the device emulation at least doesn't crash? We could have
&gt;&gt;&gt; a rule that all devices that do DMA must always postpone
&gt;&gt;&gt; all of that DMA to a bottom-half, but that's a lot of
&gt;&gt;&gt; refactoring of a lot of device code...
&gt;&gt;
&gt;&gt; It looks to me the issue happens only for device with loopback
&gt; I think in principle we have a problem for any device that
&gt; (a) has memory mapped registers and (b) does DMA reads
&gt; whose address is guest-controlled. Loopback isn't a
&gt; requirement -- if the guest programs, say, an RX descriptor
&gt; base address to point at the device's own registers, you
&gt; get exactly the same kind of unexpected-reentrancy.


Right, so about the solution, instead of refactoring DMA I wonder we can 
simply detect and fail the RX by device itself.

Thanks


&gt;
&gt; thanks
&gt; -- PMM
&gt;

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/10" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jasowang" class="sprite person">Jason Wang (jasowang)</a>
            wrote
            <time itemprop="commentTime" datetime="2020-07-22T03:27:06+00:00" title="2020-07-22 03:27:06 UTC">on 2020-07-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/10"> #10</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 2020/7/21 下午9:46, Li Qiang wrote:<br />
<span class="foldable-quoted">
&gt; Jason Wang &lt;email address hidden&gt; 于2020年7月21日周二 下午9:21写道：<br />
&gt;&gt;<br />
&gt;&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:<br />
&gt;&gt;&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;email address hidden&gt; wrote:<br />
&gt;&gt;&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.<br />
&gt;&gt;&gt; I wouldn&#x27;t care to give a 100% guarantee that asking a real<br />
&gt;&gt;&gt; h/w device to DMA to itself didn&#x27;t cause it to misbehave :-)<br />
&gt;&gt;&gt; It&#x27;s more likely to happen-to-work because the DMA engine bit<br />
&gt;&gt;&gt; of a real h/w device is going to be decoupled somewhat from<br />
&gt;&gt;&gt; the respond-<wbr />to-memory-<wbr />transactions-<wbr />for-registers logic, but<br />
&gt;&gt;&gt; it probably wasn&#x27;t something the designers were actively<br />
&gt;&gt;&gt; thinking about either...<br />
&gt;&gt;<br />
&gt;&gt; I think some device want such peer to peer transactions:<br />
&gt;&gt;<br />
&gt;&gt; <a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst">https:/<wbr />/git.kernel.<wbr />org/pub/<wbr />scm/linux/<wbr />kernel/<wbr />git/torvalds/<wbr />linux.git/<wbr />tree/Documentat<wbr />ion/driver-<wbr />api/pci/<wbr />p2pdma.<wbr />rst</a><br />
&gt;&gt;<br />
&gt;&gt;<br />
&gt;&gt;&gt;&gt; For<br />
&gt;&gt;&gt;&gt; e1000e and other networking devices we need make sure such DMA doesn&#x27;t<br />
&gt;&gt;&gt;&gt; break anything.<br />
&gt;&gt;&gt; Yeah, this is the interesting part for QEMU. How should we<br />
&gt;&gt;&gt; structure devices that do DMA so that we can be sure that<br />
&gt;&gt;&gt; the device emulation at least doesn&#x27;t crash? We could have<br />
&gt;&gt;&gt; a rule that all devices that do DMA must always postpone<br />
&gt;&gt;&gt; all of that DMA to a bottom-half, but that&#x27;s a lot of<br />
&gt;&gt;&gt; refactoring of a lot of device code...<br />
&gt;&gt;<br />
&gt;&gt; It looks to me the issue happens only for device with loopback<br />
&gt; IMO I think this is not related-loopback.<br />
&gt;<br />
&gt; It happens when the guest write the MMIO address to the device&#x27;s<br />
&gt; DMA-related registers.<br />
&gt; The one we see UAF occurs in loopback device because the same<br />
&gt; structure uses in re-entry.<br />
&gt; But we can&#x27;t say there are no issue for non-loopback device.
</span></p>
<p>Yes.</p>
<p><span class="foldable-quoted">&gt;&gt; Simply git grep loopback in hw/net tells me we probably need only to<br />
&gt;&gt; audit dp8393x and rtl8139.<br />
&gt;&gt;<br />
&gt;&gt; Qiang, want to help to audit those devices?<br />
&gt; No problem. Once I finish the e1000e patch I will try to audit those and<br />
&gt; also try to audit some no-loopback device re-entry issue.
</span></p>
<p>Thanks.</p>
<p><span class="foldable-quoted">&gt;<br />
&gt; Thanks,<br />
&gt; Li Qiang<br />
&gt;<br />
&gt;&gt; Thanks<br />
&gt;&gt;<br />
&gt;&gt;<br />
&gt;&gt;&gt; thanks<br />
&gt;&gt;&gt; -- PMM<br />
&gt;&gt;&gt;
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
On 2020/7/21 下午9:46, Li Qiang wrote:
&gt; Jason Wang &lt;jasowang@redhat.com&gt; 于2020年7月21日周二 下午9:21写道：
&gt;&gt;
&gt;&gt; On 2020/7/21 下午8:31, Peter Maydell wrote:
&gt;&gt;&gt; On Wed, 15 Jul 2020 at 09:36, Jason Wang &lt;jasowang@redhat.com&gt; wrote:
&gt;&gt;&gt;&gt; I think the point is to make DMA to MMIO work as real hardware.
&gt;&gt;&gt; I wouldn't care to give a 100% guarantee that asking a real
&gt;&gt;&gt; h/w device to DMA to itself didn't cause it to misbehave :-)
&gt;&gt;&gt; It's more likely to happen-to-work because the DMA engine bit
&gt;&gt;&gt; of a real h/w device is going to be decoupled somewhat from
&gt;&gt;&gt; the respond-to-memory-transactions-for-registers logic, but
&gt;&gt;&gt; it probably wasn't something the designers were actively
&gt;&gt;&gt; thinking about either...
&gt;&gt;
&gt;&gt; I think some device want such peer to peer transactions:
&gt;&gt;
&gt;&gt; https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/driver-api/pci/p2pdma.rst
&gt;&gt;
&gt;&gt;
&gt;&gt;&gt;&gt; For
&gt;&gt;&gt;&gt; e1000e and other networking devices we need make sure such DMA doesn't
&gt;&gt;&gt;&gt; break anything.
&gt;&gt;&gt; Yeah, this is the interesting part for QEMU. How should we
&gt;&gt;&gt; structure devices that do DMA so that we can be sure that
&gt;&gt;&gt; the device emulation at least doesn't crash? We could have
&gt;&gt;&gt; a rule that all devices that do DMA must always postpone
&gt;&gt;&gt; all of that DMA to a bottom-half, but that's a lot of
&gt;&gt;&gt; refactoring of a lot of device code...
&gt;&gt;
&gt;&gt; It looks to me the issue happens only for device with loopback
&gt; IMO I think this is not related-loopback.
&gt;
&gt; It happens when the guest write the MMIO address to the device's
&gt; DMA-related registers.
&gt; The one we see UAF occurs in loopback device because the same
&gt; structure uses in re-entry.
&gt; But we can't say there are no issue for non-loopback device.


Yes.


&gt;&gt; Simply git grep loopback in hw/net tells me we probably need only to
&gt;&gt; audit dp8393x and rtl8139.
&gt;&gt;
&gt;&gt; Qiang, want to help to audit those devices?
&gt; No problem. Once I finish the e1000e patch I will try to audit those and
&gt; also try to audit some no-loopback device re-entry issue.


Thanks.


&gt;
&gt; Thanks,
&gt; Li Qiang
&gt;
&gt;&gt; Thanks
&gt;&gt;
&gt;&gt;
&gt;&gt;&gt; thanks
&gt;&gt;&gt; -- PMM
&gt;&gt;&gt;

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/11" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~th-huth" class="sprite person">Thomas Huth (th-huth)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-05-26T14:34:33.822345+00:00" title="2021-05-26 14:34:33 UTC">on 2021-05-26</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/11"> #11</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I can reproduce this problem with QEMU v5.0, but with the current<br />
version, it does not run into this assertion anymore. Seems like this<br />
problem got fixed in the course of time? Could you please check whether<br />
you could still reproduce this?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I can reproduce this problem with QEMU v5.0, but with the current
version, it does not run into this assertion anymore. Seems like this
problem got fixed in the course of time? Could you please check whether
you could still reproduce this?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in qemu: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Incomplete
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/12" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~a1xndr" class="sprite person">Alexander Bulekov (a1xndr)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-06-14T23:40:09.999397+00:00" title="2021-06-14 23:40:09 UTC">on 2021-06-14</time><span class="editable-message-last-edit-date">
                <a href="#" class="editable-message-last-edit-link">(last edit <time itemprop="editTime" datetime="2021-06-14T23:41:28.539140+00:00" title="2021-06-14 23:41:28 UTC">on 2021-06-14</time>)</a>:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/12"> #12</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This should have been fixed by the qemu_receive_<wbr />packet/<wbr />network loopback patches from a few months ago</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">This should have been fixed by the qemu_receive_packet/network loopback patches from a few months ago</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1886362/comments/13" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~th-huth" class="sprite person">Thomas Huth (th-huth)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-06-15T18:19:39.675360+00:00" title="2021-06-15 18:19:39 UTC">on 2021-06-15</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1886362/comments/13"> #13</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Ok, let&#x27;s mark this as fixed.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Ok, let's mark this as fixed.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in qemu: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        Incomplete &#8594; Fix Released
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/qemu/+bug/1886362/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/qemu/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public</strong>
         information
     </span>&nbsp;<a class="sprite edit action-icon" id="privacy-link" href="/qemu/+bug/1886362/+secrecy">Edit</a>

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    <li class="sprite bug-dupe">
    <span id="mark-duplicate-text">
    <a class="menu-link-mark-dupe" href="/qemu/+bug/1886362/+duplicate">Mark as duplicate</a>
    </span>
    </li>
    
    <li><a class="menu-link-createquestion sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+create-question">Convert to a question</a></li>
    
    <li><a class="menu-link-addbranch sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+addbranch">Link a related branch</a></li>
    <li><a class="menu-link-linktocve sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+linkcve">Link to <abbr title="Common Vulnerabilities and Exposures Index">CVE</abbr></a></li>
    
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/qemu/+bug/1886362/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/qemu/+bug/1886362/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/qemu/+bug/1886362/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  
  


      

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"bug_is_private": false, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1886362", "web_link": "https://bugs.launchpad.net/bugs/1886362", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 1886362, "private": false, "information_type": "Public", "name": null, "title": "Heap use-after-free in lduw_he_p through e1000e_write_to_rx_buffers", "description": "Hello,\nThis reproducer causes a heap-use-after free. QEMU Built with --enable-sanitizers:\ncat \u003c\u003c EOF | ./i386-softmmu/qemu-system-i386 -M q35,accel=qtest \\\n-qtest stdio -nographic -monitor none -serial none\noutl 0xcf8 0x80001010\noutl 0xcfc 0xe1020000\noutl 0xcf8 0x80001014\noutl 0xcf8 0x80001004\noutw 0xcfc 0x7\noutl 0xcf8 0x800010a2\nwrite 0xe102003b 0x1 0xff\nwrite 0xe1020103 0x1e 0xffffff055c5e5c30be4511d084ffffffffffffffffffffffffffffffffff\nwrite 0xe1020420 0x4 0xffffffff\nwrite 0xe1020424 0x4 0xffffffff\nwrite 0xe102042b 0x1 0xff\nwrite 0xe1020430 0x4 0x055c5e5c\nwrite 0x5c041 0x1 0x04\nwrite 0x5c042 0x1 0x02\nwrite 0x5c043 0x1 0xe1\nwrite 0x5c048 0x1 0x8a\nwrite 0x5c04a 0x1 0x31\nwrite 0x5c04b 0x1 0xff\nwrite 0xe1020403 0x1 0xff\nEOF\n\nThe Output:\n==22689==ERROR: AddressSanitizer: heap-use-after-free on address 0x62500026800e at pc 0x55b93bb18bfa bp 0x7fffdbe844f0 sp 0x7fffdbe83cb8\nREAD of size 2 at 0x62500026800e thread T0\n    #0  in __asan_memcpy (/build/i386-softmmu/qemu-system-i386+)\n    #1  in lduw_he_p /include/qemu/bswap.h:332:5\n    #2  in ldn_he_p /include/qemu/bswap.h:550:1\n    #3  in flatview_write_continue /exec.c:3145:19\n    #4  in flatview_write /exec.c:3186:14\n    #5  in address_space_write /exec.c:3280:18\n    #6  in address_space_rw /exec.c:3290:16\n    #7  in dma_memory_rw_relaxed /include/sysemu/dma.h:87:18\n    #8  in dma_memory_rw /include/sysemu/dma.h:113:12\n    #9  in pci_dma_rw /include/hw/pci/pci.h:789:5\n    #10  in pci_dma_write /include/hw/pci/pci.h:802:12\n    #11  in e1000e_write_to_rx_buffers /hw/net/e1000e_core.c:1412:9\n    #12  in e1000e_write_packet_to_guest /hw/net/e1000e_core.c:1582:21\n    #13  in e1000e_receive_iov /hw/net/e1000e_core.c:1709:9\n    #14  in e1000e_nc_receive_iov /hw/net/e1000e.c:213:12\n    #15  in net_tx_pkt_sendv /hw/net/net_tx_pkt.c:544:9\n    #16  in net_tx_pkt_send /hw/net/net_tx_pkt.c:620:9\n    #17  in net_tx_pkt_send_loopback /hw/net/net_tx_pkt.c:633:11\n    #18  in e1000e_tx_pkt_send /hw/net/e1000e_core.c:664:16\n    #19  in e1000e_process_tx_desc /hw/net/e1000e_core.c:743:17\n    #20  in e1000e_start_xmit /hw/net/e1000e_core.c:934:9\n    #21  in e1000e_set_tctl /hw/net/e1000e_core.c:2431:9\n    #22  in e1000e_core_write /hw/net/e1000e_core.c:3265:9\n    #23  in e1000e_mmio_write /hw/net/e1000e.c:109:5\n    #24  in memory_region_write_accessor /memory.c:483:5\n    #25  in access_with_adjusted_size /memory.c:544:18\n    #26  in memory_region_dispatch_write /memory.c:1476:16\n    #27  in flatview_write_continue /exec.c:3146:23\n    #28  in flatview_write /exec.c:3186:14\n    #29  in address_space_write /exec.c:3280:18\n    #30  in qtest_process_command /qtest.c:567:9\n    #31  in qtest_process_inbuf /qtest.c:710:9\n    #32  in qtest_read /qtest.c:722:5\n    #33  in qemu_chr_be_write_impl /chardev/char.c:188:9\n    #34  in qemu_chr_be_write /chardev/char.c:200:9\n    #35  in fd_chr_read /chardev/char-fd.c:68:9\n    #36  in qio_channel_fd_source_dispatch /io/channel-watch.c:84:12\n    #37  in g_main_context_dispatch (/usr/lib/x86_64-linux-gnu/libglib-2.0.so.0+)\n    #38  in glib_pollfds_poll /util/main-loop.c:219:9\n    #39  in os_host_main_loop_wait /util/main-loop.c:242:5\n    #40  in main_loop_wait /util/main-loop.c:518:11\n    #41  in qemu_main_loop /softmmu/vl.c:1664:9\n    #42  in main /softmmu/main.c:52:5\n    #43  in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+)\n    #44  in _start (/build/i386-softmmu/qemu-system-i386+)\n\n0x62500026800e is located 14 bytes inside of 138-byte region [0x625000268000,0x62500026808a)\nfreed by thread T0 here:\n    #0  in free (/build/i386-softmmu/qemu-system-i386+)\n    #1  in qemu_vfree /util/oslib-posix.c:238:5\n    #2  in address_space_unmap /exec.c:3616:5\n    #3  in dma_memory_unmap /include/sysemu/dma.h:148:5\n    #4  in pci_dma_unmap /include/hw/pci/pci.h:839:5\n    #5  in net_tx_pkt_reset /hw/net/net_tx_pkt.c:453:9\n    #6  in e1000e_process_tx_desc /hw/net/e1000e_core.c:749:9\n    #7  in e1000e_start_xmit /hw/net/e1000e_core.c:934:9\n    #8  in e1000e_set_tctl /hw/net/e1000e_core.c:2431:9\n    #9  in e1000e_core_write /hw/net/e1000e_core.c:3265:9\n    #10  in e1000e_mmio_write /hw/net/e1000e.c:109:5\n    #11  in memory_region_write_accessor /memory.c:483:5\n    #12  in access_with_adjusted_size /memory.c:544:18\n    #13  in memory_region_dispatch_write /memory.c:1476:16\n    #14  in flatview_write_continue /exec.c:3146:23\n    #15  in flatview_write /exec.c:3186:14\n    #16  in address_space_write /exec.c:3280:18\n    #17  in address_space_rw /exec.c:3290:16\n    #18  in dma_memory_rw_relaxed /include/sysemu/dma.h:87:18\n    #19  in dma_memory_rw /include/sysemu/dma.h:113:12\n    #20  in pci_dma_rw /include/hw/pci/pci.h:789:5\n    #21  in pci_dma_write /include/hw/pci/pci.h:802:12\n    #22  in e1000e_write_to_rx_buffers /hw/net/e1000e_core.c:1412:9\n    #23  in e1000e_write_packet_to_guest /hw/net/e1000e_core.c:1582:21\n    #24  in e1000e_receive_iov /hw/net/e1000e_core.c:1709:9\n    #25  in e1000e_nc_receive_iov /hw/net/e1000e.c:213:12\n    #26  in net_tx_pkt_sendv /hw/net/net_tx_pkt.c:544:9\n    #27  in net_tx_pkt_send /hw/net/net_tx_pkt.c:620:9\n    #28  in net_tx_pkt_send_loopback /hw/net/net_tx_pkt.c:633:11\n    #29  in e1000e_tx_pkt_send /hw/net/e1000e_core.c:664:16\n\npreviously allocated by thread T0 here:\n    #0  in posix_memalign (/build/i386-softmmu/qemu-system-i386+)\n    #1  in qemu_try_memalign /util/oslib-posix.c:198:11\n    #2  in qemu_memalign /util/oslib-posix.c:214:27\n    #3  in address_space_map /exec.c:3558:25\n    #4  in dma_memory_map /include/sysemu/dma.h:138:9\n    #5  in pci_dma_map /include/hw/pci/pci.h:832:11\n    #6  in net_tx_pkt_add_raw_fragment /hw/net/net_tx_pkt.c:391:24\n    #7  in e1000e_process_tx_desc /hw/net/e1000e_core.c:731:14\n    #8  in e1000e_start_xmit /hw/net/e1000e_core.c:934:9\n    #9  in e1000e_set_tctl /hw/net/e1000e_core.c:2431:9\n    #10  in e1000e_core_write /hw/net/e1000e_core.c:3265:9\n    #11  in e1000e_mmio_write /hw/net/e1000e.c:109:5\n    #12  in memory_region_write_accessor /memory.c:483:5\n    #13  in access_with_adjusted_size /memory.c:544:18\n    #14  in memory_region_dispatch_write /memory.c:1476:16\n    #15  in flatview_write_continue /exec.c:3146:23\n    #16  in flatview_write /exec.c:3186:14\n    #17  in address_space_write /exec.c:3280:18\n    #18  in qtest_process_command /qtest.c:567:9\n    #19  in qtest_process_inbuf /qtest.c:710:9\n    #20  in qtest_read /qtest.c:722:5\n    #21  in qemu_chr_be_write_impl /chardev/char.c:188:9\n    #22  in qemu_chr_be_write /chardev/char.c:200:9\n    #23  in fd_chr_read /chardev/char-fd.c:68:9\n    #24  in qio_channel_fd_source_dispatch /io/channel-watch.c:84:12\n    #25  in g_main_context_dispatch (/usr/lib/x86_64-linux-gnu/libglib-2.0.so.0+)\n\n-Alex", "owner_link": "https://bugs.launchpad.net/api/devel/~a1xndr", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/bug_tasks", "duplicate_of_link": null, "date_created": "2020-07-06T02:44:58.066918+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/subscriptions", "date_last_updated": "2021-06-15T18:19:45.138811+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 8, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/cves", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/attachments", "security_related": false, "latest_patch_uploaded": null, "tags": [], "date_last_message": "2021-06-15T18:19:39.675360+00:00", "number_of_duplicates": 0, "message_count": 14, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/messages", "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1886362/linked_merge_proposals", "http_etag": "\"bc1bd45865fc9cdd2012c1ba382e3c59b221a822-02afc4c85b7570febb67c5b6dc1049685746064a\""}, "total_comments_and_activity": 16, "related_features": {}, "information_type_data": {"PUBLIC": {"is_private": false, "name": "Public", "order": 0, "description": "Everyone can see this information.\n", "value": "PUBLIC", "description_css_class": "choice-description"}, "PRIVATESECURITY": {"is_private": true, "name": "Private Security", "order": 2, "description": "Only the security group can see this information.\n ", "value": "PRIVATESECURITY", "description_css_class": "choice-description"}, "PUBLICSECURITY": {"is_private": false, "name": "Public Security", "order": 1, "description": "Everyone can see this security related information.\n", "value": "PUBLICSECURITY", "description_css_class": "choice-description"}, "USERDATA": {"is_private": true, "name": "Private", "order": 3, "description": "Only shared with users permitted to see private user information.\n", "value": "USERDATA", "description_css_class": "choice-description"}}, "context": {"self_link": "https://bugs.launchpad.net/api/devel/qemu/+bug/1886362", "web_link": "https://bugs.launchpad.net/qemu/+bug/1886362", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/1886362", "milestone_link": null, "status": "Fix Released", "importance": "Undecided", "assignee_link": null, "bug_target_display_name": "QEMU", "bug_target_name": "qemu", "bug_watch_link": null, "date_assigned": null, "date_created": "2020-07-06T02:44:58.066918+00:00", "date_confirmed": "2021-06-15T18:19:44.480223+00:00", "date_incomplete": null, "date_in_progress": "2021-06-15T18:19:44.480223+00:00", "date_closed": "2021-06-15T18:19:44.480223+00:00", "date_left_new": "2021-05-26T14:34:39.824185+00:00", "date_triaged": "2021-06-15T18:19:44.480223+00:00", "date_fix_committed": "2021-06-15T18:19:44.480223+00:00", "date_fix_released": "2021-06-15T18:19:44.480223+00:00", "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~a1xndr", "target_link": "https://bugs.launchpad.net/api/devel/qemu", "title": "Bug #1886362 in QEMU: \"Heap use-after-free in lduw_he_p through e1000e_write_to_rx_buffers\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/qemu/+bug/1886362/related_tasks", "is_complete": true, "http_etag": "\"2aa7285b699be34e923b36bc37d1e8565c00e204-784584c1ce1c8ae0d39e2e53d085c39f5db0fd81\""}, "bugtask_data": {"2618839": {"delete_link": "https://bugs.launchpad.net/qemu/+bug/1886362/+delete", "bug_title": "Heap use-after-free in lduw_he_p through e1000e_write_to_rx_buffers", "user_can_unassign": false, "importance_value": "Undecided", "user_can_edit_importance": false, "assignee_vocabulary": "AllUserTeamsParticipation", "hide_assignee_team_selection": true, "user_can_edit_status": true, "user_can_delete": false, "row_id": "tasksummary2618839", "target_is_product": true, "user_can_edit_milestone": false, "prefix": "qemu", "bugtask_path": "/qemu/+bug/1886362", "id": 2618839, "milestone_value": null, "status_widget_items": "[]", "milestone_widget_items": "[]", "form_row_id": "task2618839", "targetname": "QEMU", "assignee_is_team": null, "assignee_vocabulary_filters": [], "user_can_edit_assignee": false, "importance_widget_items": "[]", "assignee_value": null, "status_value": "Fix Released"}}, "subscribers_portlet_url_data": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1886362", "web_link": "https://bugs.launchpad.net/bugs/1886362"}, "initial_comment_batch_offset": 41, "first visible_recent_comment": -27};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 54 queries/external actions issued in 1.39 seconds

    Features: {'app.maintenance_message': None, 'hard_timeout': '9000', 'js.yui_version': None, 'app.mainsite_only.canonical_url': None, 'disclosure.dsp_picker.enabled': 'on', 'baselayout.careers_link.disabled': None, 'bugs.affected_count_includes_dupes.disabled': None, 'visible_render_time': None, 'profiling.enabled': None, 'bugs.nominations.bug_supervisors_can_target': 'on'}

    r0d8de2b

    -->

</html>

