<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">

      <meta name="referrer" content="origin">
<script type="text/javascript" src="page.cgi?1635552583&amp;id=bayotbase/fielddefs.js"></script>




<script type="text/javascript">var BB_CONFIG = ({"defaults":{"severity":"Unspecified","priority":"Unspecified","op_sys":"Unspecified","platform":"Unspecified","bugentry_fields":["summary","product","component","rh_sub_components","severity","priority","comment"]},"user":{"logged_in":false,"enterable_products":[],"groups":[]}});</script><script type="text/javascript">
var classifications = '[ { "name": "Red Hat", "description": "Red Hat Products"},{ "name": "Workflows", "description": "User driven workflows"},{ "name": "JBoss", "description": "JBoss Products"},{ "name": "CentOS", "description": "CentOS Projects"},{ "name": "Fedora", "description": "Fedora Products"},{ "name": "Community", "description": "Community Projects"},{ "name": "oVirt", "description": "oVirt Virtualization Management Projects"},{ "name": "Internal", "description": "Internal Projects."},{ "name": "Other", "description": "Other Miscellaneous Products"},{ "name": "Unclassified", "description": "Not assigned to any classification"},{ "name": "Retired", "description": "Products that have reached end of life, or were never released."} ]';
var c_optgroups = JSON.parse(classifications);
</script>
    <title>456282 &ndash; (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="js/yui/assets/skins/sam/autocomplete.css" rel="stylesheet" type="text/css"><link href="js/yui/assets/skins/sam/calendar.css" rel="stylesheet" type="text/css"><link href="skins/standard/global.css" rel="stylesheet" type="text/css"><link href="extensions/BayotBase/web/css/base.css" rel="stylesheet" type="text/css"><link href="extensions/BayotBase/web/jquery-ui-1.12.1.custom/jquery-ui.min.css" rel="stylesheet" type="text/css"><link href="skins/standard/bug.css" rel="stylesheet" type="text/css"><link href="extensions/Voting/web/style.css" rel="stylesheet" type="text/css"><link href="extensions/ExternalBugs/web/css/global.css" rel="stylesheet" type="text/css"><link href="extensions/FontAwesome/web/css/all.min.css" rel="stylesheet" type="text/css"><link href="extensions/RedHat/web/css/redhat.css" rel="stylesheet" type="text/css"><link href="extensions/RedHat/web/DataTables/datatables.min.css" rel="stylesheet" type="text/css"><link href="extensions/RedHat/web/alertify/css/alertify.min.css" rel="stylesheet" type="text/css"><link href="extensions/RedHat/web/alertify/css/themes/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="extensions/SelectizeJS/web/css/selectize.bootstrap3.css" rel="stylesheet" type="text/css"><link href="extensions/SelectizeJS/web/css/SelectizeJS.css" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="js/yui/yahoo-dom-event/yahoo-dom-event.js"></script><script type="text/javascript" src="js/yui/cookie/cookie-min.js"></script><script type="text/javascript" src="extensions/BayotBase/web/js/jquery-3.6.0.min.js"></script><script type="text/javascript" src="extensions/BayotBase/web/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script><script type="text/javascript" src="extensions/BayotBase/web/js/jquery.cookie.js"></script><script type="text/javascript" src="extensions/BayotBase/web/js/jquery.jsonrpc.js"></script><script type="text/javascript" src="extensions/BayotBase/web/js/Base.js"></script><script type="text/javascript" src="extensions/BayotBase/web/js/bayot.util.js"></script><script type="text/javascript" src="js/yui/datasource/datasource-min.js"></script><script type="text/javascript" src="js/yui/connection/connection-min.js"></script><script type="text/javascript" src="js/yui/json/json-min.js"></script><script type="text/javascript" src="js/yui/autocomplete/autocomplete-min.js"></script><script type="text/javascript" src="js/yui/calendar/calendar-min.js"></script><script type="text/javascript" src="js/global.js"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 5,
                maxattachmentsize: 20000
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug.",
                group_required:
                    "You must select at least one group for bugs in this product."
            }
            
              , api_token: ''
            
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "456282 – (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock",
                             "show_bug.cgi?id=456282" );
        document.title = "456282 – (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "456282 – (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="js/util.js"></script><script type="text/javascript" src="js/field.js"></script><script type="text/javascript" src="extensions/ExternalBugs/web/js/external_bugs.js"></script><script type="text/javascript" src="extensions/RedHat/web/DataTables/datatables.min.js"></script><script type="text/javascript" src="extensions/RedHat/web/alertify/alertify.min.js"></script><script type="text/javascript" src="extensions/RedHat/web/colResize/dataTables.colResize.js"></script><script type="text/javascript" src="extensions/RedHat/web/js/redhat.js"></script><script type="text/javascript" src="extensions/SelectizeJS/web/js/standalone/selectize.min.js"></script><script type="text/javascript" src="extensions/SelectizeJS/web/js/SelectizeJS.js"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Red Hat Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="/extensions/RedHat/web/css/favicons/production.ico?v=0">
  </head>

  <body 
        class="bugzilla-redhat-com status_colours_pastel
                 bz_bug
                 bz_status_CLOSED
                 bz_product_Security_Response
                 bz_component_vulnerability
                 bz_bug_456282 yui-skin-sam">

  <div id="header"><div id="banner">
   <ul id="loginin_launcher"><a href="#" onclick="$('#loginin_launcher').addClass('bz_default_hidden');$('#login_container').removeClass('bz_default_hidden');"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;&nbsp;Login</a></ul>
   <ul id="login_container" class="bz_default_hidden">
    <a href="#" id="hide_mini_login" onclick="$('#login_container').addClass('bz_default_hidden');$('#loginin_launcher').removeClass('bz_default_hidden');">[x]</a>
     
    <li id="mini_login_container"><div id="saml2_container">
    Log in using an account from:
  <div id="saml2auth_login_Fedora Account System">
    <a href="saml2_login.cgi?idp=Fedora%20Account%20System&amp;target=show_bug.cgi%3Fid%3D456282"><i class="fa fa-cogs" aria-hidden="true"></i>&nbsp;&nbsp;Fedora Account System</a>
  </div>
  <div id="saml2auth_login_Red Hat Associate">
    <a href="saml2_login.cgi?idp=Red%20Hat%20Associate&amp;target=show_bug.cgi%3Fid%3D456282"><i class="fa fa-user-secret" aria-hidden="true"></i>&nbsp;&nbsp;Red Hat Associate</a>
  </div>
  <div id="saml2auth_login_Red Hat Customer">
    <a href="saml2_login.cgi?idp=Red%20Hat%20Customer&amp;target=show_bug.cgi%3Fid%3D456282"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;&nbsp;Red Hat Customer</a>
  </div>
  Or login using a Red Hat Bugzilla account
  <div>

  <form action="show_bug.cgi?id=456282" method="POST"
        class="mini_login "
        id="mini_login">
    <input id="Bugzilla_login" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in">
  </form>
</li>
<li id="forgot_container">
  <a id="forgot_link" href="#forgot"
     onclick="return show_forgot_form('')"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;&nbsp;Forgot&nbsp;Password</a>
  <form action="token.cgi" method="post" id="forgot_form"
        class="mini_forgot bz_default_hidden">
    <label for="login">Login:</label>
    <input name="loginname" size="20" id="login" required
        type="email" placeholder="Your Email Address">
    <input id="forgot_button" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <input type="hidden" id="token" name="token"
           value="1635627030-l8tjSgFXjFXk3y9VlM8EbHYCk82ajVd_k5bX4iIow7A">
    <p>
    <a href="#" onclick="return hide_forgot_form('')"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;&nbsp;Hide Forgot</a>
  </form>
</li>
<li>
  <a href="createaccount.cgi"><span><i class="fas fa-plus" aria-hidden="true"></i>&nbsp;&nbsp;Create an Account</span></a>
</li>
    
   </ul>
  </div>

    <div id="titles">
      <span id="title">Red Hat Bugzilla &ndash; Bug&nbsp;456282</span>


    </div>


    <div id="common_links"><ul class="links">
  <li class="form">
    
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>
  <li><a href="./" title="Home"><i class="fas fa-home"></i></a></li>
  <li><a href="enter_bug.cgi">New</a></li>
  <li class="submenu">
    <a href="#" title="Search"><i class="fas fa-search"></i> <span class="fa fa-caret-down"></span></a>
    <div>
      <ul>
        <li><a href="query.cgi?format=specific">Simple Search</a></li>
        <li><a href="query.cgi?format=advanced">Advanced Search</a></li>
      </ul>
    </div>
  </li>
  <li class="submenu">
   <a href="#">My Links <span class="fa fa-caret-down"></span></a>
   <div>
    <ul>
      <li><a href="describecomponents.cgi">Browse</a></li>
      <li>
            <a href="request.cgi">Requests</a></li>
      <li class="submenu">
        <a  href="report.cgi">Reports <span class="fa fa-caret-right"></span></a>
        <div>
          <ul>
            </li>
            <li class="submenu">
              <a  href="#">Current State <span class="fa fa-caret-right"></span></a>
              <div>
                <ul>
                  <li id="report_search">
                    <a href="query.cgi">Search</a>
                  </li>
                  <li id="report_tabular">
                      <a href="query.cgi?format=report-table">Tabular reports</a>
                  </li>
                    <li id="report_graphical">
                        <a href="query.cgi?format=report-graph">Graphical reports</a>
                    </li>
                  <li id="report_duplicates">
                    <a href="duplicates.cgi">Duplicates</a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="submenu">
              <a  href="#">Other Reports <span class="fa fa-caret-right"></span></a>
              <div>
                <ul>
                  <li>
                      <a href="https://bugzilla.redhat.com/page.cgi?id=user_activity.html">User Changes</a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="submenu">
              <a  href="#">Plotly Reports <span class="fa fa-caret-right"></span></a>
              <div>
                <ul>
                  <li>
                      <a href="https://bugzilla.redhat.com/page.cgi?id=bug_status.html">Bug Status</a>
                  </li>
                  <li>
                      <a href="https://bugzilla.redhat.com/page.cgi?id=bug_severity.html">Bug Severity</a>
                  </li>
                  <li>
                      <a href="https://bugzilla.redhat.com/page.cgi?id=non_defaults.html">Non-Defaults</a>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </li><li><span class="separator"> | </span><a href="page.cgi?id=productdashboard.html">Product Dashboard</a></li>
    </ul>
   </div>
  </li>

  <li class="submenu">
   <a href="#">Help <span class="fa fa-caret-down"></span></a>
   <div>
    <ul><li><a href="docs/en/html/using/understanding.html" >Page Help!</a></li>
      <li><a href="page.cgi?id=bug-writing.html">Bug Writing Guidelines</a></li> 
      <li><a href="page.cgi?id=whats-new.html">What's new</a></li>
      <li><a href="https://access.redhat.com/help/browsers">Browser Support Policy</a></li>
      <li><a href="page.cgi?id=release-notes.html">5.0.4.rh64 Release notes</a></li>
      <li><a href="page.cgi?id=faq.html">FAQ</a></li>
      <li><a href="docs/en/html/index.html">Guides index</a></li>
      <li><a href="docs/en/html/using/index.html">User guide</a></li>
      <li><a href="docs/en/html/integrating/api/Bugzilla/WebService/Bug.html">Web Services</a></li>
      <li><a href="page.cgi?id=redhat/contact.html" >Contact</a></li> 
      <li><a href="page.cgi?id=terms-conditions.html" >Legal</a></li> 
    </ul>
   </div>
  </li>



</ul>
    </div>
  </div>


  <div id="bugzilla-body">



<noscript>
      <div id="no-js-message">This site requires JavaScript to be enabled to function correctly, please enable it.</div>
</noscript>

<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=456282" title="Format For Printing"><i class="fa fa-print"></i></a></li>
    <li><a href="show_bug.cgi?ctype=xml&amp;id=456282" title="Export as XML"><i class="far fa-file-excel"></i></a></li>
    <li><a href="enter_bug.cgi?cloned_bug_id=456282" title="Clone This Bug"><i class="fa fa-clone"></i></a></li>
    <li>
      <a href="enter_bug.cgi?cloned_bug_id=456282&lite=1" title="Copy is a lite weight clone that only copies the summary &amp; description">
       <i class="far fa-clone"></i>
      </a>
    </li>


          
    <li>
      <a href="#c123" title="Last Comment">
         <i class="fas fa-arrow-down" aria-hidden="true"></i>
      </a>
    </li><li>
  <a href="buglist.cgi?bug_id=456282&amp;bug_id_type=anddependson&amp;format=tvp" title="TreeView+">
    <i class="fa fa-tree"></i>
  </a>
</li>
    </ul>
<script type="text/javascript">
<!--

//-->
</script>




<form name="changeform" id="changeform" method="post" action="process_bug.cgi">





  <input type="hidden" name="delta_ts" value="2019-09-29 12:25:21">
  <input type="hidden" name="id" value="456282">
  <input type="hidden" name="token" value="1635627030-twSqYmAwXYSkIXeBPFrp2D5AlXJe-9ecNmfAxK1EvRc">
<div class="bz_short_desc_container edit_form">
    
    

     <a href="show_bug.cgi?id=456282"><b>Bug&nbsp;456282</b></a> <span id="summary_container" class="bz_default_hidden">
        (<span id="alias_nonedit_display">CVE-2008-4307</span>)
      - <span id="short_desc_nonedit_display"><a href="https://access.redhat.com/security/cve/CVE-2008-4307">CVE-2008-4307</a> Kernel BUG() in locks_remove_flock</span>
     </span>

    
    

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

  
  
</span>CVE-2008-4307 Kernel BUG() in locks_remove_flock
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'CVE-2008-4307 Kernel BUG() in locks_remove_flock' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
      <th class="field_label">
        <a href="describekeywords.cgi">Keywords</a>:
      </th>
      <td>
        <div class="keywords_select">
          <select id="keywords" name="keywords"  disabled="disabled" multiple="multiple">
              <option value="Security"
                      title="Bugs with the &quot;Security&quot; keyword are those that relate to a security vulnerability with a Red Hat product or service. For further information on how to report a security vulnerability to Red Hat please see the &quot;Security Contacts and Procedures&quot; page at http://www.redhat.com/security/team/contact/"
                      selected="selected"
              >Security
              </option>
          </select>
        </div>
      </td>
    </tr>

  <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">CLOSED
          ERRATA
      </span>
    </td>
  </tr>

<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

  
  
</th>
    <td>CVE-2008-4307
    </td>
  </tr>

<tr>

<th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components. Select a Classification to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_product" >Security Response

</td>


    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_classification" >Other

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=Security Response"
  >Component:</a>

  
  
</th>
      <td>
        

            <input type="hidden" id="component" name="component" value="vulnerability">vulnerability
        
        
        <span class="show_others">
          <a href="buglist.cgi?component=vulnerability&amp;product=Security%20Response"
            title="Show other bugs for this component"><i class="fas fa-th-list"></i></a>
        
        
          <a href="enter_bug.cgi?component=vulnerability&amp;product=Security%20Response&amp;version=unspecified"
            title="Create a new bug for this component"><i class="fas fa-plus-circle"></i></a>
        
        </span>
      </td>
    </tr>
    <tr>
        <th id="bz_rh_sub_component_input_th"
            class="field_label bz_default_hidden">
          <label for="rh_sub_component">
            <a class="field_help_link" href="page.cgi?id=fields.html#rh_sub_components" title="The sub component of a specific component">Sub Component:</a>
          </label>
        </th>
        <td id="bz_rh_sub_component_input_td" class="bz_default_hidden">
          <input type="hidden" name="defined_rh_sub_component" id="defined_rh_sub_component" value="0">
          <select name="rh_sub_component" id="rh_sub_component"  disabled="disabled" onchange="assign_to_default();" >
            <option value="">---</option>
          </select>
          <script>
            $(document).ready(function () {
              init_sub_components();
            });
          </script>
        
          <span class="show_others">
            <a href="buglist.cgi?component=vulnerability&amp;product=Security%20Response" title="Show other bugs for this sub-component"><i class="fas fa-th-list"></i></a>
          
          </span>
        </td>
      </tr>

<script>
  function rh_check_sub_components () {
    var ret = '';
      var sub_comp_obj = document.getElementById('rh_sub_component');
        if ($('#defined_rh_sub_component').val() == 1 && !$("#rh_sub_component").selectize()[0].selectize.getValue()) {
          if (!ret) ret = sub_comp_obj;
          _sub_comps_errorFor(
            sub_comp_obj,
            "You must specify the sub component"
          );
      }

    return ret;
  }

  function _sub_comps_errorFor(field, error_text) {
      var new_node = document.createElement('div');
      YAHOO.util.Dom.addClass(new_node, 'validation_error_text');
      new_node.innerHTML = error_text;
      YAHOO.util.Dom.insertAfter(new_node, field);
      YAHOO.util.Dom.addClass(field, 'validation_error_field');
      new_node.scrollIntoView();
  }
</script>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

  
  
</th>
<td>
      <span id="version">unspecified
      </span></td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

  
  
</th>
      <td class="field_value">All
      </td>
    </tr>
    <tr><th class="field_label "
    id="field_label_op_sys">


  <a 
      title="The operating system the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#op_sys"
  >OS:</a>

  
  
</th>
      <td class="field_value">
        Linux
      </td>
    </tr>
          
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#priority">Priority:</a></label>
      </th>
      <td>high
      </td>
    </tr>
    <tr>
      <th class="field_label">
        <label ><a href="page.cgi?id=fields.html#bug_severity">Severity:</a>
        </label>
      </th>
      <td>
       high
      </td>
    </tr>

      <tr><th class="field_label "
    id="field_label_target_milestone">


  <a 
      title="The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it."
      class="field_help_link"
      href="page.cgi?id=fields.html#target_milestone"
  >Target Milestone:</a>

  
  
</th><td>
      <span id="target_milestone">---
      </span></td>
      </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

  
  
</th>
      <td><span class="vcard redhat_user"><span class="fn">Red Hat Product Security</span>
</span>
      </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_qa_contact">


  <a 
      title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#qa_contact"
  >QA Contact:</a>

  
  
</th>
      <td><span class="vcard ">
</span>
      </td>
    </tr>
    
    <tr><th class="field_label "
    id="field_label_docs_contact">

    <label for="docs_contact" accesskey="q">

  <a 
      title="The person responsible for documenting once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#docs_contact"
  >Docs Contact:</a>
</label>
  
  
</th>
      <td><span class="vcard ">
</span>
      </td>
    </tr>
    
    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'security-response-team\x40redhat.com',
        '',
        '');
    </script>
          
          
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

  
  
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>

    <tr><th class="field_label "
    id="field_label_status_whiteboard">


  <a 
      title="Each bug has a free-form single line text entry box for adding tags and status information."
      class="field_help_link"
      href="page.cgi?id=fields.html#status_whiteboard"
  >Whiteboard:</a>

  
  
</th><td>  
  </td>
    </tr>
          

          <tr>
    <th class="field_label">
      <label>Duplicates (3)</label>:
    </th>
    <td class="field_value">
      <span id="duplicates"><a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=464763">464763</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=491695">491695</a> <a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED DUPLICATE - Request to include (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock patch in RHEL4.x &amp; 5.x Kernel"
   href="show_bug.cgi?id=499089">499089</a> 
      </span>
      (<a href="buglist.cgi?bug_id=464763,491695,499089">view as bug list</a>)
    </td>
  </tr>
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends On:</a>

  
  
</th>

  <td>
    <span id="dependson_input_area">
    </span>
<a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456284">456284</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456285">456285</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456287">456287</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456288">456288</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456384">456384</a> <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=463870">463870</a> 
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

  
  
</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>

          <tr>
    <th class="field_label">TreeView+</th>
    <td>
        <a href="buglist.cgi?bug_id=456282&amp;bug_id_type=anddependson&amp;format=tvp">
        depends on</a> /
        <a href="buglist.cgi?bug_id=456282&amp;bug_id_type=andblocked&amp;format=tvp&amp;tvp_dir=blocked">
        blocked</a>
    </td>
    <td></td>
</tr>
          
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#reporter">Reported:</a>
    </th>
    <td>2008-07-22 16:32 UTC by <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#modified">Modified:</a>
    </th>
    <td>2019-09-29 12:25 UTC
      (<a href="show_activity.cgi?id=456282">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          <a href="page.cgi?id=fields.html#cclist">CC List:</a>
        </label>
      </th>
      <td>41 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="anton">anton</option>
                <option value="aviro">aviro</option>
                <option value="badiger">badiger</option>
                <option value="bernhard.furtmueller">bernhard.furtmueller</option>
                <option value="bmr">bmr</option>
                <option value="bstein">bstein</option>
                <option value="cmarthal">cmarthal</option>
                <option value="dhoward">dhoward</option>
                <option value="dmair">dmair</option>
                <option value="donald.harper">donald.harper</option>
                <option value="duck">duck</option>
                <option value="esandeen">esandeen</option>
                <option value="hklein">hklein</option>
                <option value="jjarvis">jjarvis</option>
                <option value="jkachuck">jkachuck</option>
                <option value="jko">jko</option>
                <option value="jlayton">jlayton</option>
                <option value="jpirko">jpirko</option>
                <option value="jplans">jplans</option>
                <option value="jwest">jwest</option>
                <option value="lgoncalv">lgoncalv</option>
                <option value="lwang">lwang</option>
                <option value="michael.hagmann">michael.hagmann</option>
                <option value="mjc">mjc</option>
                <option value="mzierer">mzierer</option>
                <option value="pbatkowski">pbatkowski</option>
                <option value="pradeepkumars">pradeepkumars</option>
                <option value="pveiga">pveiga</option>
                <option value="qcai">qcai</option>
                <option value="rearl">rearl</option>
                <option value="rwheeler">rwheeler</option>
                <option value="ryan.ordway">ryan.ordway</option>
                <option value="security-response-team">security-response-team</option>
                <option value="sglass">sglass</option>
                <option value="sputhenp">sputhenp</option>
                <option value="steved">steved</option>
                <option value="tao">tao</option>
                <option value="tjp">tjp</option>
                <option value="vgoyal">vgoyal</option>
                <option value="williams">williams</option>
                <option value="wmealing">wmealing</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>


 
<tr>
      <th class="field_label "
    id="field_label_cf_fixed_in">


  <a 
      title="The full package version. PGM uses to check if brew ..."
  >Fixed In Version:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_cf_fixed_in"  colspan="2">

</td>
    </tr>
    
    

    <tr>
      <th class="field_label "
    id="field_label_cf_doc_type">


  <a 
      title="Click the information icon to the right to see the description"
  >Doc Type:</a>

  
  <i class="fas fa-info-circle pop-text" onclick="alertify.alert('Doc Type', BB_FIELDS['cf_doc_type'].long_desc)" title="Click to see full description"></i>

  
</th>
  <td class="field_value "
      id="field_container_cf_doc_type"  colspan="2">Bug Fix

<span id="cf_doc_warn"></span></td>
    </tr>
    
    

    <tr>
      <th class="field_label "
    id="field_label_cf_release_notes">


  <a 
      title="Click the information icon to the right to see the description"
  >Doc Text:</a>

  
  <i class="fas fa-info-circle pop-text" onclick="alertify.alert('Doc Text', BB_FIELDS['cf_release_notes'].long_desc)" title="Click to see full description"></i>

  
</th>
  <td class="field_value "
      id="field_container_cf_release_notes"  colspan="2">
      <div class="uneditable_textarea"></div>

</td>
    </tr>
    
    

    
    

    <tr>
      <th class="field_label "
    id="field_label_cf_clone_of">


  <a 
      title="The bug listed here was the bug cloned to create thi..."
  >Clone Of:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_cf_clone_of"  colspan="2">

</td>
    </tr>
    
    

    <tr>
      <th class="field_label "
    id="field_label_cf_environment">


  <a 
      title="This field is used for unformatted text that helps t..."
  >Environment:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_cf_environment"  colspan="2">
      <div class="uneditable_textarea"></div>

</td>
    </tr>
    
    

    <tr>
      <th class="field_label "
    id="field_label_cf_last_closed">


  <a 
      title="When this bug was last marked as closed. Used for st..."
  >Last Closed:</a>

  
  
</th>
  <td class="field_value "
      id="field_container_cf_last_closed"  colspan="2">2010-12-24 00:08:10 UTC
    

</td>
    </tr>




        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    
    <th align="left">
      Attachments
    </th>
    <th colspan="2" align="right">
      <a href="page.cgi?id=terms-conditions.html">(Terms of Use)</a>
    </th>
    
  </tr>


      <tr id="a1" class="bz_contenttype_text_plain">
        <td>
            <a href="attachment.cgi?id=312392"
               title="View the content of the attachment">
          <b>Lock a file with fcntl/POSIX locking.</b></a>

          <span class="bz_attach_extra_info">
              (750 bytes,
                text/plain)

            <br>
            <a href="#attach_312392"
               title="Go to the comment associated with the attachment">2008-07-22 20:27 UTC</a>,

            <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=312392&amp;action=edit">Details</a>
        </td>
      </tr>
      <tr id="a2" class="bz_contenttype_text_plain">
        <td>
            <a href="attachment.cgi?id=312402"
               title="View the content of the attachment">
          <b>reproducer - lock file in one thread and close in another</b></a>

          <span class="bz_attach_extra_info">
              (1.25 KB,
                text/plain)

            <br>
            <a href="#attach_312402"
               title="Go to the comment associated with the attachment">2008-07-22 22:36 UTC</a>,

            <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=312402&amp;action=edit">Details</a>
        </td>
      </tr>
      <tr id="a3" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=314636"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">Patch to check for fcntl/close race and clean up POSIX locks</span></b></a>

          <span class="bz_attach_extra_info">
              (1.22 KB,
                patch)

            <br>
            <a href="#attach_314636"
               title="Go to the comment associated with the attachment">2008-08-20 16:27 UTC</a>,

            <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=314636&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=314636&amp;action=diff">Diff</a>
        </td>
      </tr>
      <tr id="a4" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=325729"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">Backport c4d7c402b788b73dc24f1e54a57f89d3dc5eb7bc to RHEL4</span></b></a>

          <span class="bz_attach_extra_info">
              (1.18 KB,
                patch)

            <br>
            <a href="#attach_325729"
               title="Go to the comment associated with the attachment">2008-12-04 19:21 UTC</a>,

            <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=325729&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=325729&amp;action=diff">Diff</a>
        </td>
      </tr>
      <tr id="a5" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=326611"
               title="View the content of the attachment">
          <b>revised patch</b></a>

          <span class="bz_attach_extra_info">
              (1.19 KB,
                patch)

            <br>
            <a href="#attach_326611"
               title="Go to the comment associated with the attachment">2008-12-11 13:05 UTC</a>,

            <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=326611&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=326611&amp;action=diff">Diff</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="3">
        <span class="bz_attach_view_hide">
            <a href="#a0" onclick="return toggle_display(this);">Show
              Obsolete</a> (2)
            <a id="view_all" href="attachment.cgi?bugid=456282&amp;action=viewall&amp;hide_obsolete=1">View All</a>
        </span>
        <a href="attachment.cgi?bugid=456282&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>

    

    <script>
  YAHOO.ExternalBugs.sUrlYUI = 'https://bugzilla.redhat.com/jsonrpc.cgi';
  YAHOO.ExternalBugs.sUrlRPC = 'https://bugzilla.redhat.com/xmlrpc.cgi';
  YAHOO.ExternalBugs.extRefreshList = [];
function _extbz_errorFor(field, error_text) {
    var new_node = document.createElement('div');
    YAHOO.util.Dom.addClass(new_node, 'validation_error_text');
    new_node.innerHTML = error_text;
    YAHOO.util.Dom.insertAfter(new_node, field);
    YAHOO.util.Dom.addClass(field, 'validation_error_field');
    return new_node;
}

function check_external_bugs (f) {
    var focus_me;
    var external_bugs = YAHOO.util.Dom.getElementsByClassName(
        'external_bug_id', null, f);
    for (var i = 0; i < external_bugs.length; i++) {
        var bug_id_key   = external_bugs[i].name;
        var bug_type_key = 'external_' + bug_id_key.substr(13);
        if($('#' + bug_id_key).length > 0) {
            var bug_id       = document.getElementById(bug_id_key).value;
            var bug_type     = document.getElementById(bug_type_key).value;
            if ((bug_type == '' || bug_type == '0') && bug_id != '') {
                focus_me = _extbz_errorFor(
                    document.getElementById(bug_type_key),
                    'You specified the external tracker id, but not the type'
                );
            }
            else if (bug_type != '' && bug_type != '0' && bug_id == '') {
                focus_me = _extbz_errorFor(
                    external_bugs[i],
                    'You specified the external tracker type, but not the id'
                );
            }
            else if (bug_type != '' && bug_id != '') {
            }
        }
    }

    return focus_me;
}

var bz_no_validate_enter_bug = false;
function validateChangeBug(changeform) {
    // This is for the "bookmarkable templates" button.
    if (bz_no_validate_enter_bug) {
        // Set it back to false for people who hit the "back" button
        bz_no_validate_enter_bug = false;
        return true;
    }

    var current_errors = YAHOO.util.Dom.getElementsByClassName(
        'validation_error_text', null, changeform);
    for (var i = 0; i < current_errors.length; i++) {
        current_errors[i].parentNode.removeChild(current_errors[i]);
    }
    var current_error_fields = YAHOO.util.Dom.getElementsByClassName(
        'validation_error_field', null, changeform);
    for (var i = 0; i < current_error_fields.length; i++) {
        var field = current_error_fields[i];
        YAHOO.util.Dom.removeClass(field, 'validation_error_field');
    }

    var focus_me;

    // REDHAT EXTENSION 1000743
    focus_me = check_external_bugs(changeform);

    if (focus_me) {
        focus_me.scrollIntoView(false);
        return false;
    }

    return true;
}

changeform.onsubmit = function() { return validateChangeBug(changeform)};
</script>

<br>
<table id="external_bugs_table" cellspacing="0" cellpadding="4">
  <caption name="et0" id="et0">Links</caption>
    <tr>
      <th>System</th>
      <th>ID</th>
      <th>Private</th>
      <th>Priority</th>
      <th>Status</th>
      <th>Summary</th>
      <th>Last Updated</th>
    </tr>

    
    <tr id="ext_row_650623" >
      <td>Red Hat Product Errata
      </td>
      <td>
        <a href="https://access.redhat.com/errata/RHSA-2009:0451">RHSA-2009:0451</a>
      </td>
      <td>
        <span id="ext_is_private_650623">0
        </span>
      </td>
      <td>
        <span id="ext_priority_650623">normal
        </span>
      </td>
      <td>
        <span id="ext_status_650623">SHIPPED_LIVE
        </span>
      </td>
      <td>
        <span id="ext_description_650623"
              title="Important: kernel-rt security and bug fix update">Important: kernel-rt security and bug fix update
        </span>
      </td>
      <td>
        <span id="ext_last_updated_650623">2009-04-29 09:28:23 UTC
        </span>
      </td>
    </tr>
    
    <tr id="ext_row_650651" >
      <td>Red Hat Product Errata
      </td>
      <td>
        <a href="https://access.redhat.com/errata/RHSA-2009:0459">RHSA-2009:0459</a>
      </td>
      <td>
        <span id="ext_is_private_650651">0
        </span>
      </td>
      <td>
        <span id="ext_priority_650651">normal
        </span>
      </td>
      <td>
        <span id="ext_status_650651">SHIPPED_LIVE
        </span>
      </td>
      <td>
        <span id="ext_description_650651"
              title="Important: kernel security and bug fix update">Important: kernel security and bug fix update
        </span>
      </td>
      <td>
        <span id="ext_last_updated_650651">2009-04-30 21:24:29 UTC
        </span>
      </td>
    </tr>
    
    <tr id="ext_row_650686" >
      <td>Red Hat Product Errata
      </td>
      <td>
        <a href="https://access.redhat.com/errata/RHSA-2009:0473">RHSA-2009:0473</a>
      </td>
      <td>
        <span id="ext_is_private_650686">0
        </span>
      </td>
      <td>
        <span id="ext_priority_650686">normal
        </span>
      </td>
      <td>
        <span id="ext_status_650686">SHIPPED_LIVE
        </span>
      </td>
      <td>
        <span id="ext_description_650686"
              title="Important: kernel security and bug fix update">Important: kernel security and bug fix update
        </span>
      </td>
      <td>
        <span id="ext_last_updated_650686">2009-05-07 10:53:11 UTC
        </span>
      </td>
    </tr>

</table>

<br>
    

  </td>

  <td class="groups">
  </td>
  </tr></table>

  
  <div id="comments"><script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c2" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 19:55:54 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This is the BUG on RHEL4 somewhat mangled by netconsole - will try to get a
cleaner version:

------------[ cut here ]------------
kernel BUG at fs/locks.c:1798!
invalid operand: 0000 [#1] SMP 
CPU:    0
Modules linked in: nfs lockd nfs_acl md5 ipv6 parport_pc lp parport netconsole
netdump autofs4 sunrpc dm_multipath usb_storage button battery ac uhci_hcd
ehci_hcd hw_random snd_azx snd_hda_codec sn
d_pcm_oss snd_mixer_oss snd_pcm snd_timer snd soundcore snd_page_alloc tg3
qla2xxx scsi_transport_fc dm_snapshot dm_zero dm_mirror ext3 jbd dm_mod ata_piix
libata sd_mod scsi_mod
Process locker (pid: 4908, threadinfo=f6256000 task=f686a8b0)
EIP:    0060:[&lt;c016efc4&gt;]    Not tainted VLI
EFLAGS: 00010246   (2.6.9-55.ELsmp) 
EIP is at locks_remove_flock+0xa1/0xe1
eax: f6b3612c   ebx: f6e414b4   ecx: 00000000   edx: 00000081
esi: 00000000   edi: f6e4140c   ebp: f67a7380   esp: f6256f28
ds: 007b   es: 007b   ss: 0068

Stack: 00000007 f67a7380 00000003 00000003 f667f00c 00000286 00000046 f667f00c 
       c01fd679 00000000 00000286 0000001e c01fe418 0000001e 0000001e 00000000 
       b7f57d42 c0202c45 f667f00c 00000001 00000000 00000246 00000000 f67a7380 
Pid: 4908, comm:               locker
EIP: 0060:[&lt;c016efc4&gt;] CPU: 0
EIP is at locks_remove_flock+0xa1/0xe1
 EFLAGS: 00010246    Not tainted  (2.6.9-55.ELsmp)
EAX: f6b3612c EBX: f6e414b4 ECX: 00000000 EDX: 00000081
ESI: 00000000 EDI: f6e4140c EBP: f67a7380 DS: 007b ES: 007b
CR0: 8005003b CR2: b7fa8000 CR3: 36fb6fa0 CR4: 000006f0
Code: 38 39 68 2c 75 2d 0f b6 50 30 f6 c2 02 74 09 89 d8 e8 9f df ff ff eb 1d f6
c2 20 74 0e ba 02 00 00 00 89 d8 e8 ba ec ff ff eb 0a &lt;0f&gt; 0b 06 07 33 ad 2e c0
89 c3 8b 03 eb c4 b8 00 f0 ff ff 21 
e0 
Call Trace:
 [&lt;c015bd82&gt;] __fput+0x41/0x100
 [&lt;c016ab21&gt;] sys_fcntl64+0x79/0x80
 [&lt;c02d5ee3&gt;] syscall_call+0x7/0xb


</pre>
    </div>

    <div id="c3" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 20:17:20 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This is a problem with how the RHEL4/5 kernels handle POSIX locks. It is
possible for an fcntl call to race with a close on the same file descriptor. A
similar problem was fixed recently but this appears to be a separate issue
(reproduced on 2.6.18-92.1.6.el5).

Acquiring a POSIX lock via fcntl goes like this:

sys_fcntl()
    fget()
    do_fcntl()
        fcntl_setlk()
    fput()
        if(!count) __fput()
            locks_remove_flock()

The fcntl_setlk() call can potentially block for long durations (SETLKW waiting,
slow/distant lockd) allowing another thread in the same process to e.g. close
the file descriptor.

And a close looks like this:

sys_close()
    filp_close()
        locks_remove_posix()
        fput()
            if(!count) __fput()
                locks_remove_flock()

If we close the file descriptor from one thread while another is still blocked
in fcntl_setlk but before the lock has been granted (and before the struct
file_lock is placed on the inode's i_lock list) the call to locks_remove_posix
in the close path will &quot;miss&quot; the POSIX lock. We also fail to call
locks_remove_flock at this point since the thread in fcntl_setlk is still
holding a reference on the file.

This causes the final fput from the sys_fcntl return path to trigger a BUG when
__fput calls locks_remove_flock:

/*
 * This function is called on the last close of an open file.
 */
void locks_remove_flock(struct file *filp)
{
 [...]
        while ((fl = *before) != NULL) {
                if (fl-&gt;fl_file == filp) {
                        if (IS_FLOCK(fl)) {
                                locks_delete_lock(before);
                                continue;
                        }
                        if (IS_LEASE(fl)) {
                                lease_modify(before, F_UNLCK);
                                continue;
                        }
                        if (IS_POSIX(fl))
                                continue;
                        /* What? */
                        BUG(); &lt;----
                }
                before = &amp;fl-&gt;fl_next;
        }
        unlock_kernel();
}


</pre>
    </div>

    <div id="c4" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 20:18:48 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Discussing this with Al Viro this appears similar to a problem fixed in our
trees back in May. 2.6.18-92.1.6.el5 should contain that fix however so this
appears to be something different.


</pre>
    </div>

    <div id="c5" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 20:27:31 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=312392" name="attach_312392" title="Lock a file with fcntl/POSIX locking.">attachment 312392</a> <a href="attachment.cgi?id=312392&amp;action=edit" title="Lock a file with fcntl/POSIX locking.">[details]</a></span>
Lock a file with fcntl/POSIX locking.

Lock a file with fcntl/POSIX locking.

</pre>
    </div>

    <div id="c7" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 20:35:36 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">I can reliably reproduce this with the code in <a href="show_bug.cgi?id=456282#c5">comment #5</a> and <a href="show_bug.cgi?id=456282#c6">comment #6</a>.

Steps to reproduce:

1. Mount a writable NFS volume from a remote host with nfslock running.
2. Compile the two test programs
gcc -pthread -Wall -o locker locker.c
gcc -Wall -o lockit lockit.c
3. In one terminal start lockit running on a file on the NFS volume:

# lockit /mnt/test

4. In a 2nd terminal start locker running on the same file:

# locker /mnt/test

5. Terminate lockit (CTRL-C)

Actual results:
# ./locker /mnt/locktest
pid 4907 main launching thread
pid 4907 thread 4908 in do_lock
pid 4907 thread 4908  locking
Read from remote host p380-1.gsslab: Connection reset by peer
Connection to p380-1.gsslab closed.

Host died with BUG() in <a href="show_bug.cgi?id=456282#c2">comment #2</a>

Expected results:
No bug.

Additional information:
Should be possible to trigger this with just one program but I found having
something already locking the file and then using SETLKW seemed to make it
easier to trigger.

</pre>
    </div>

    <div id="c8" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 21:47:01 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Reproducable locally:

Same steps as in <a href="show_bug.cgi?id=456282#c7">comment #7</a> but the nfs volume is exported locally from the test
machine:

kernel BUG at fs/locks.c:1798!
invalid operand: 0000 [#1]
SMP 
Modules linked in: netconsole netdump loop nfs nfsd exportfs lockd nfs_acl md5
ipv6 parport_pc lp parport autofs4 sunrpc dm_multipath usb_storage button
battery ac uhci_hcd ehci_hcd hw_random snd_azx snd_hda_codec snd_pcm_oss
snd_mixer_oss snd_pcm snd_timer snd soundcore snd_page_alloc tg3 qla2xxx
scsi_transport_fc dm_snapshot dm_zero dm_mirror ext3 jbd dm_mod ata_piix libata
sd_mod scsi_mod
CPU:    0
EIP:    0060:[&lt;c016efc4&gt;]    Not tainted VLI
EFLAGS: 00010246   (2.6.9-55.ELsmp) 
EIP is at locks_remove_flock+0xa1/0xe1
eax: f69068ac   ebx: f61294b4   ecx: 00000000   edx: 00000081
esi: 00000000   edi: f612940c   ebp: f6e4d180   esp: f62a2f28
ds: 007b   es: 007b   ss: 0068
Process locker (pid: 5333, threadinfo=f62a2000 task=f6d61230)
Stack: 00000007 f6e4d180 00000003 f62a2f5c c011cd42 00000286 f6f81680 f6f81430 
       f6ed5c80 f7e3d980 f6f8159c f5f9cec4 c02d3d56 f62a2fbc c02d3d86 00000000 
       b7fb5d42 f6f81430 f6f81430 00000001 00000000 00000246 00000000 f6e4d180 
Call Trace:
 [&lt;c011cd42&gt;] recalc_task_prio+0x128/0x133
 [&lt;c02d3d56&gt;] schedule+0x84e/0x8ec
 [&lt;c02d3d86&gt;] schedule+0x87e/0x8ec
 [&lt;c015bd82&gt;] __fput+0x41/0x100
 [&lt;c016ab21&gt;] sys_fcntl64+0x79/0x80
 [&lt;c02d5ee3&gt;] syscall_call+0x7/0xb
Code: 38 39 68 2c 75 2d 0f b6 50 30 f6 c2 02 74 09 89 d8 e8 9f df ff ff eb 1d f6
c2 20 74 0e ba 02 00 00 00 89 d8 e8 ba ec ff ff eb 0a &lt;0f&gt; 0b 06 07 33 ad 2e c0
89 c3 8b 03 eb c4 b8 00 f0 ff ff 21 e0 


</pre>
    </div>

    <div id="c9" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 21:48:32 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=312399" name="attach_312399" title="">attachment 312399</a> <a href="attachment.cgi?id=312399&amp;action=edit" title="">[details]</a></span>
log of BUG in <a href="show_bug.cgi?id=456282#c8">comment #8</a>

</pre>
    </div>

    <div id="c10" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 22:01:43 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This seems to be the same problem discussed here:

<a href="http://lkml.org/lkml/2006/2/17/135">http://lkml.org/lkml/2006/2/17/135</a>

And this was also reported back in 2004:

<a href="http://lkml.org/lkml/2004/10/1/116">http://lkml.org/lkml/2004/10/1/116</a>

Chris Wright provided a workaround patch for testing:

<a href="http://lkml.org/lkml/2004/10/1/276">http://lkml.org/lkml/2004/10/1/276</a>

The patch adds a check in the return path from sys_fcntl that the current entry
in the file table for our fd matches the file we're holding.



</pre>
    </div>

    <div id="c11" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 22:05:39 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=312401&amp;action=diff" name="attach_312401" title="">attachment 312401</a> <a href="attachment.cgi?id=312401&amp;action=edit" title="">[details]</a></span>
Patch from <a href="http://lkml.org/lkml/2004/10/1/276">http://lkml.org/lkml/2004/10/1/276</a>

</pre>
    </div>

    <div id="c12" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 22:29:18 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Discussed this with Al Viro who mentioned:

linux-2.6-fs-race-condition-in-dnotify.patch (and <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=443440">bug 443440</a> / <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=439759">bug 439759</a>)

Which fixes a similar fcntl/close race (I can't see the bugs but the patch
header describes a reordering bug updating i_flock).

I can't seem to trigger this on 2.6.9-78.EL with the steps in <a href="show_bug.cgi?id=456282#c7">comment #7</a> but I
think that might be down to the test case. This can be triggered using those
steps on 2.6.18-92.1.6.el5 which does contain this patch.

</pre>
    </div>

    <div id="c13" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-22 22:36:03 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=312402" name="attach_312402" title="reproducer - lock file in one thread and close in another">attachment 312402</a> <a href="attachment.cgi?id=312402&amp;action=edit" title="reproducer - lock file in one thread and close in another">[details]</a></span>
reproducer - lock file in one thread and close in another

Slightly less stupid test case. Still doesn't seem to trigger it on 2.6.9-78.EL
so it may already be fixed there?

</pre>
    </div>

    <div id="c15" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-23 06:31:35 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Used gcc-4.1.2-42.el5, and it complained &quot;locker.c:13: error: expected
declaration specifiers or '...' before 'gettid'&quot;. Modified locker.c as follows:

 13 /* _syscall0(pid_t,gettid); */
 14 pid_t gettid(void)
 15 {
 16         return syscall(__NR_gettid);
 17 }

</pre>
    </div>

    <div id="c16" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-23 07:26:19 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">So I tested this on 2.6.18-92.el5, and given the test scenario in <a href="show_bug.cgi?id=456282#c7">comment #7</a>, I
managed to trigger the problem after numerous tries.

intel-s5000phb-01.rhts.bos.redhat.com login: ------------[ cut here ]------------
kernel BUG at fs/locks.c:2054!
invalid opcode: 0000 [#1]
SMP 
last sysfs file:
/devices/pci0000:00/0000:00:02.0/0000:01:00.0/0000:02:02.0/0000:07:00.1/irq
Modules linked in: nfs fscache nfsd exportfs lockd nfs_acl auth_rpcgss autofs4
hidp rfcomm l2cap bluetooth sunrpc ipv6 xfrm_nalgo crypto_api dm_multipath video
sbs backlight i2c_ec button battery asus_acpi ac parport_pc lp parport sg
i5000_edac i2c_i801 ide_cd edac_mc cdrom i2c_core pcspkr e1000e serio_raw
dm_snapshot dm_zero dm_mirror dm_mod ata_piix libata mptsas mptscsih mptbase
scsi_transport_sas sd_mod scsi_mod ext3 jbd uhci_hcd ohci_hcd ehci_hcd
CPU:    3
EIP:    0060:[&lt;c0482513&gt;]    Not tainted VLI
EFLAGS: 00010246   (2.6.18-92.el5 #1) 
EIP is at locks_remove_flock+0xc1/0xde
eax: f6e5c41c   ebx: d88a89f0   ecx: 00000286   edx: 00000000
esi: f7b44cc0   edi: f7b44cc0   ebp: d88a8950   esp: da0fdf18
ds: 007b   es: 007b   ss: 0068
Process locker2 (pid: 16672, ti=da0fd000 task=c1a1b000 task.ti=da0fd000)
Stack: 00000000 00000000 00000000 00000000 00000000 f7b44cc0 0000411f 00000000 
       00000000 00000000 f7b44cc0 00000212 00000000 00000000 ffffffff 7fffffff 
       00000000 00000000 00000000 00000000 00000000 db1375a0 00100100 00200200 
Call Trace:
 [&lt;c047189b&gt;] __fput+0x88/0x167
 [&lt;c047fdf6&gt;] sys_fcntl64+0x79/0x80
 [&lt;c0404eff&gt;] syscall_call+0x7/0xb
 =======================
Code: 34 39 70 28 75 2d 0f b6 50 2c f6 c2 02 74 09 89 d8 e8 b7 fe ff ff eb 1d 80
e2 20 74 0e ba 02 00 00 00 89 d8 e8 12 ff ff ff eb 0a &lt;0f&gt; 0b 06 08 6d f4 62 c0
89 c3 8b 03 85 c0 75 c6 e8 12 71 18 00 
EIP: [&lt;c0482513&gt;] locks_remove_flock+0xc1/0xde SS:ESP 0068:da0fdf18
 &lt;0&gt;Kernel panic - not syncing: Fatal exception

</pre>
    </div>

    <div id="c17" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-23 07:54:31 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Bryn, I managed to trigger the problem on rhel-4 with kernel-2.6.9-78.ELsmp, so
it's not fixed. I am going to redo the test with the latest kernel to make sure.

dell-pesc420-01.rhts.bos.redhat.com login: ------------[ cut here ]------------
kernel BUG at fs/locks.c:1823!
invalid operand: 0000 [#1]
SMP 
Modules linked in: nfs lockd nfs_acl md5 ipv6 parport_pc lp parport autofs4
sunrpc cpufreq_powersave loop button battery ac uhci_hcd ehci_hcd tg3 floppy
dm_snapshot dm_zero dm_mirror ext3 jbd dm_mod ata_piix libata sd_mod scsi_mod
CPU:    0
EIP:    0060:[&lt;c0170a30&gt;]    Not tainted VLI
EFLAGS: 00010246   (2.6.9-78.ELsmp) 
EIP is at locks_remove_flock+0xa1/0xe1
eax: c2def78c   ebx: f6320214   ecx: 00000000   edx: 00000081
esi: 00000000   edi: f632016c   ebp: f6807a80   esp: d1253f24
ds: 007b   es: 007b   ss: 0068
Process locker2 (pid: 21124, threadinfo=d1253000 task=f71ce630)
Stack: f632016c 00000007 f6807a80 00000003 00000003 f426700c 00000286 00000046 
       f426700c c02014f4 00000000 00000286 00000020 c0202299 00000020 00000020 
       00000000 b7fb7d44 c0206b2f f426700c 00000001 00000246 00000000 f6807a80 
Call Trace:
 [&lt;c02014f4&gt;] tty_ldisc_deref+0x50/0x5f
 [&lt;c0202299&gt;] tty_write+0x258/0x262
 [&lt;c0206b2f&gt;] write_chan+0x0/0x1d0
 [&lt;c015d39a&gt;] __fput+0x45/0x11a
 [&lt;c016c4ed&gt;] sys_fcntl64+0x79/0x80
 [&lt;c02e09db&gt;] syscall_call+0x7/0xb
Code: 38 39 68 2c 75 2d 0f b6 50 30 f6 c2 02 74 09 89 d8 e8 ff de ff ff eb 1d f6
c2 20 74 0e ba 02 00 00 00 89 d8 e8 72 ec ff ff eb 0a &lt;0f&gt; 0b 1f 07 ec 5a 2f c0
89 c3 8b 03 eb c4 b8 00 f0 ff ff 21 e0 
 &lt;0&gt;Fatal exception: panic in 5 seconds
Kernel panic - not syncing: Fatal exception

</pre>
    </div>

    <div id="c23" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c23">Comment 23</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-07-23 16:52:02 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Eugene mentioned the revised test case was also failing on git HEAD with an
EBADF from locker. I guess I'll have to add real synchronisation between the
threads...  (it's hitting the close before the fcntl).


</pre>
    </div>

    <div id="c27" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c27">Comment 27</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-08-20 16:27:17 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=314636&amp;action=diff" name="attach_314636" title="Patch to check for fcntl/close race and clean up POSIX locks">attachment 314636</a> <a href="attachment.cgi?id=314636&amp;action=edit" title="Patch to check for fcntl/close race and clean up POSIX locks">[details]</a></span>
Patch to check for fcntl/close race and clean up POSIX locks

Chris's original patch from LKML ported to RHEL4 &amp; fcheck.

</pre>
    </div>

    <div id="c28" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c28">Comment 28</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-08-20 16:29:40 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Al, the patch in <a href="show_bug.cgi?id=456282#c27">comment #27</a> is still not pretty but it does seem like it should stop the BUG(). Any feedback on this? I see some not disimilar checks in related code but I don't have the experience with this part of the kernel to say if this is viable or not.

</pre>
    </div>

    <div id="c33" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c33">Comment 33</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Alexander Viro</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-08-27 07:34:56 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">I don't believe that it's going to help.  That patch is equivalent
to what's *already* done in locks.c.  Do we have it reproduced on
mainline kernel?

</pre>
    </div>

    <div id="c37" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c37">Comment 37</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-09-15 11:24:25 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">We seem to have some positive testing results with the patch in <a href="show_bug.cgi?id=456282#c27">comment #27</a>.

</pre>
    </div>

    <div id="c38" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c38">Comment 38</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-09-16 17:15:14 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Eugene - I was about to post this to LKML but I realised we don't actually have testing on current upstream (my last test was from git about a month ago &amp; I've long thrown that kernel away).

I have a build from last night's git ready to go on x86_64 but you/Harald seem to be the ones who can trigger this.. I'll give it some testing here and see if I can get it to go but failing that would be great if you or Harald can try it.

Harald's latest results are for 78.0.1.EL vs. 78.0.1.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.EL (just the patch from <a href="show_bug.cgi?id=456282#c27">comment #27</a>). He can reliably trigger the BUG on the former but has been unable to trigger it on 78.0.1.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.EL. I'm looking into a console message he reported with only the patched kernel now:

    nlmclnt_lock: VFS is out of sync with lock manager!

Will update with further information when I have it.

</pre>
    </div>

    <div id="c48" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c48">Comment 48</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-24 11:22:40 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Output from a kernel with the lockdump patch applied:

Oct 24 10:56:23  [...network console startup...]
Oct 24 10:56:44 192.168.122.67  fs/locks.c: invalid struct file_lock at c1950530
Oct 24 10:56:44 192.168.122.67  {   
Oct 24 10:56:44 192.168.122.67               fl_next 00000000
Oct 24 10:56:44 192.168.122.67               fl_link (next=c19503e4, prev=c037358c)
Oct 24 10:56:44 192.168.122.67              fl_block (next=c195053c, prev=c195053c)
Oct 24 10:56:44 192.168.122.67              fl_owner e5e01900
Oct 24 10:56:44 192.168.122.67                fl_pid 6232
Oct 24 10:56:44 192.168.122.67               fl_file e5b7e340
Oct 24 10:56:44 192.168.122.67              fl_flags 0x81
Oct 24 10:56:44 192.168.122.67               fl_type F_WRLCK
Oct 24 10:56:44 192.168.122.67              fl_start 0
Oct 24 10:56:44 192.168.122.67                fl_end 0
Oct 24 10:56:44 192.168.122.67             fl_fasync 00000000
Oct 24 10:56:44 192.168.122.67         fl_break_time 0
Oct 24 10:56:44 192.168.122.67                fl_ops f8b12a8c []
Oct 24 10:56:44 192.168.122.67              fl_lmops 00000000 []
Oct 24 10:56:44 192.168.122.67           fl_u.nfs_fl { state = 0, flags = 0x0 (), owner = dcd72ee0 }
Oct 24 10:56:44 192.168.122.67  }
Oct 24 10:56:44  ------------[ cut here ]------------
Oct 24 10:56:44  kernel BUG at fs/locks.c:1871!
Oct 24 10:56:44  invalid operand: 0000 [#1]
Oct 24 10:56:44  Modules linked in: nfs lockd nfs_acl netconsole parport_pc lp parport autofs4 sunrpc ib_srp scsi_mod ib_sdp ib_ipoib md5 ipv6 rdma_ucm rdma_cm ib_local_sa iw_cm ib_addr ib_umad ib_ucm ib_uverbs ib_cm ib_sa ib_mad ib_core loop button battery ac uhci_hcd 8139cp mii floppy dm_snapshot dm_zero dm_mirror ext3 jbd dm_mod
Oct 24 10:56:44  CPU:    0
Oct 24 10:56:44  EIP:    0060:[&lt;c018653b&gt;]    Not tainted VLI
Oct 24 10:56:44  EFLAGS: 00010292   (2.6.9-67.0.15.0.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.bmr0.EL)
Oct 24 10:56:44  EIP is at locks_remove_flock+0x11e/0x1b9
Oct 24 10:56:44  eax: 0000004b   ebx: c1950530   ecx: c0333136   edx: dae9cee0
Oct 24 10:56:45  esi: daed2bf8   edi: daed2b20   ebp: e5b7e340   esp: dae9cf18
Oct 24 10:56:45  ds: 007b   es: 007b   ss: 0068
Oct 24 10:56:45  Process locker (pid: 6233, threadinfo=dae9c000 task=dae9a2b0)
Oct 24 10:56:45  Stack: 00000003 fffffe00 c0185b4b daed2b20 00000007 e5b7e340 00000003 00000000
Oct 24 10:56:45 192.168.122.67        00000046 f631100c 00000286 00000000 c022d46d 00000286 0000001e f6311000
Oct 24 10:56:45 192.168.122.67        c022e843 0000001e b7f5cd42 c0234c2a f631100c 0000001e b7f5cd24 00000001
Oct 24 10:56:45  Call Trace:
Oct 24 10:56:45 192.168.122.67  [&lt;c0185b4b&gt;] fcntl_setlk+0x3e2/0x3ec
Oct 24 10:56:45 192.168.122.67  [&lt;c022d46d&gt;] tty_ldisc_deref+0xc8/0x139
Oct 24 10:56:45 192.168.122.67  [&lt;c022e843&gt;] tty_write+0x381/0x38b
Oct 24 10:56:45 192.168.122.67  [&lt;c0234c2a&gt;] write_chan+0x0/0x1d5
Oct 24 10:56:45 192.168.122.67  [&lt;c016e066&gt;] __fput+0x41/0xee
Oct 24 10:56:45 192.168.122.67  [&lt;c018145e&gt;] sys_fcntl64+0x79/0x80
Oct 24 10:56:45 192.168.122.67  [&lt;c031e103&gt;] syscall_call+0x7/0xb
Oct 24 10:56:45  Code: 32 0f b6 43 40 a8 02 74 09 89 f0 e8 02 d5 ff ff eb 23 a8 20 74 0e ba 02 00 00 00 89 f0 e8 b0 e5 ff ff eb 11 89 d8 e8 a7 fd ff ff &lt;0f&gt; 0b 4f 07 fa 2e 33 c0 89 de 8b 1e eb bf b8 00 f0 ff ff 21 e0
Oct 24 10:56:45 192.168.122.67  &lt;0&gt;Fatal exception: panic in 5 seconds
Oct 24 10:56:49  Kernel panic - not syncing: Fatal exception

</pre>
    </div>

    <div id="c49" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c49">Comment 49</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-24 11:35:53 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">fl_flags 0x81 == FL_POSIX | FL_SLEEP

</pre>
    </div>

    <div id="c50" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c50">Comment 50</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-24 15:48:34 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Another crash with the debug kernel. This time I added calls to dump_struct_lock_info() inside locks_remove_posix as well. The lock that we end up BUG()ging on was not removed by locks_remove_posix (despite being having fl_flags == 0x81):

Oct 24 16:58:14  locks_remove_posix: NOT removing lock at c194ebc0
Oct 24 16:58:14  fs/locks.c: dumping struct file_lock at c194ebc0
Oct 24 16:58:14  {
Oct 24 16:58:14               fl_next 00000000
Oct 24 16:58:14               fl_link (next=c194e224, prev=c037458c)
Oct 24 16:58:14              fl_block (next=c194ebcc, prev=c194ebcc)
Oct 24 16:58:15              fl_owner e6700200
Oct 24 16:58:15                fl_pid 3928
Oct 24 16:58:15               fl_file e4ae9400
Oct 24 16:58:15              fl_flags 0x81
Oct 24 16:58:15               fl_type F_RDLCK
Oct 24 16:58:15              fl_start 4
Oct 24 16:58:15                fl_end 4
Oct 24 16:58:15             fl_fasync 00000000
Oct 24 16:58:15         fl_break_time 0
Oct 24 16:58:15                fl_ops 00000000 []
Oct 24 16:58:15              fl_lmops 00000000 []
Oct 24 16:58:15           fl_u.nfs_fl { state = 0, flags = 0x0 (n/a), owner = 00000000 }
Oct 24 16:58:15  }
[...]
Oct 24 16:59:06  fs/locks.c:locks_remove_flock() invalid file_lock
Oct 24 16:59:06  fs/locks.c: dumping struct file_lock at c194ebc0
Oct 24 16:59:06  {
Oct 24 16:59:06               fl_next 00000000
Oct 24 16:59:06               fl_link (next=c194e224, prev=c037458c)
Oct 24 16:59:06              fl_block (next=c194ebcc, prev=c194ebcc)
Oct 24 16:59:06              fl_owner e6700040
Oct 24 16:59:06                fl_pid 4647
Oct 24 16:59:06               fl_file e40623c0
Oct 24 16:59:06              fl_flags 0x81
Oct 24 16:59:06               fl_type F_WRLCK
Oct 24 16:59:06              fl_start 0
Oct 24 16:59:06                fl_end 0
Oct 24 16:59:06             fl_fasync 00000000
Oct 24 16:59:06         fl_break_time 0
Oct 24 16:59:06                fl_ops f8b12a8c []
Oct 24 16:59:06              fl_lmops 00000000 []
Oct 24 16:59:06           fl_u.nfs_fl { state = 0, flags = 0x0 (n/a), owner = e455c4e0 }
Oct 24 16:59:06  }
Oct 24 16:59:06  ------------[ cut here ]------------
Oct 24 16:59:06  kernel BUG at fs/locks.c:1876!
Oct 24 16:59:06  invalid operand: 0000 [#1]
Oct 24 16:59:06  Modules linked in: nfs lockd nfs_acl netconsole parport_pc lp parport autofs4 sunrpc ib_srp scsi_mod ib_sdp ib_ipoib md5 ipv6 rdma_ucm rdma_cm ib_local_sa iw_cm ib_addr ib_umad ib_ucm ib_uverbs ib_cm ib_sa ib_mad ib_core loop button battery ac uhci_hcd 8139cp mii floppy dm_snapshot dm_zero dm_mirror ext3 jbd dm_mod
Oct 24 16:59:07  CPU:    0
Oct 24 16:59:07  EIP:    0060:[&lt;c018656b&gt;]    Not tainted VLI
Oct 24 16:59:07  EFLAGS: 00010286   (2.6.9-67.0.15.0.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.bmr1.EL)
Oct 24 16:59:07  EIP is at locks_remove_flock+0x128/0x1c4
Oct 24 16:59:07  eax: 0000004f   ebx: c194ebc0   ecx: c033315a   edx: dae2fedc
Oct 24 16:59:07  esi: db5f15a0   edi: db5f14c8   ebp: e40623c0   esp: dae2ff14
Oct 24 16:59:07  ds: 007b   es: 007b   ss: 0068
Oct 24 16:59:07  Process locker (pid: 4653, threadinfo=dae2f000 task=dae8d1a0)
Oct 24 16:59:07  Stack: c03331ff 00000003 fffffe00 c0185b4b db5f14c8 00000007 e40623c0 00000003
Oct 24 16:59:07        00000000 00000046 e898000c 00000286 00000000 c022d49d 00000286 0000001e
Oct 24 16:59:07        e8980000 c022e873 eab64e10 dae2ff88 c011f43a e898000c 0000001e b7f03d24
Oct 24 16:59:07  Call Trace:
Oct 24 16:59:07  [&lt;c0185b4b&gt;] fcntl_setlk+0x3e2/0x3ec
Oct 24 16:59:07  [&lt;c022d49d&gt;] tty_ldisc_deref+0xc8/0x139
Oct 24 16:59:07  [&lt;c022e873&gt;] tty_write+0x381/0x38b
Oct 24 16:59:07  [&lt;c011f43a&gt;] recalc_task_prio+0x128/0x133
Oct 24 16:59:07  [&lt;c016e066&gt;] __fput+0x41/0xee
Oct 24 16:59:07  [&lt;c018145e&gt;] sys_fcntl64+0x79/0x80
Oct 24 16:59:07  [&lt;c031e133&gt;] syscall_call+0x7/0xb
Oct 24 16:59:07  Code: f0 e8 dc d4 ff ff eb 2e a8 20 74 0e ba 02 00 00 00 89 f0 e8 8a e5 ff ff eb 1c 68 ff 31 33 c0 e8 a9 e3 f9 ff 89 d8 e8 6d fb ff ff &lt;0f&gt; 0b 54 07 19 2f 33 c0 59 89 de 8b 1e eb b4 b8 00 f0 ff ff 21
Oct 24 16:59:07  &lt;0&gt;Fatal exception: panic in 5 seconds
Oct 24 16:59:11  Kernel panic - not syncing: Fatal exception

Since we know that IS_POSIX() for this lock will return true, this must have been because posix_same_owner(fl, &amp;lock) for the two locks returned false:

        while (*before != NULL) {
                struct file_lock *fl = *before;
                if (IS_POSIX(fl) &amp;&amp; posix_same_owner(fl, &amp;lock)) {
                        printk(KERN_WARNING &quot;locks_remove_posix: removing lock at %p&quot;, fl);
                        dump_struct_file_lock(fl);
                        locks_delete_lock(before);
                        continue;
                }
                printk(KERN_WARNING &quot;locks_remove_posix: NOT removing lock at %p&quot;, fl);
                dump_struct_file_lock(fl);
                before = &amp;fl-&gt;fl_next;
        }

Just trying to get a vmcore from one of these crashes so I can take a look at the state of the lock list in more detail.

</pre>
    </div>

    <div id="c51" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c51">Comment 51</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-24 16:06:08 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">So, I don't really understand this code, so please forgive my ignorance but I don't understand how this block of code can skip cleaning up some POSIX locks:

                struct file_lock *fl = *before;
                if (IS_POSIX(fl) &amp;&amp; posix_same_owner(fl, &amp;lock)) {
                        printk(KERN_WARNING &quot;locks_remove_posix: removing lock
at %p&quot;, fl);
                        dump_struct_file_lock(fl);
                        locks_delete_lock(before);
                        continue;
                }

If we're going to not clean up these locks due to the posix_same_owner() check then we *know* that we will bug on one of those locks when this fd is shut down by the final call to fput().

I guess I don't understand when it would be valid to be returning from sys_close() -&gt; locks_remove_posix() leaving FL_POSIX locks remaining on the list.

</pre>
    </div>

    <div id="c52" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c52">Comment 52</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-24 16:14:17 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Because it also gets called from nfs4state.c:release_stateid() I guess

</pre>
    </div>

    <div id="c59" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c59">Comment 59</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Harald Klein</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-30 16:04:35 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">I've just tried to crash 78.0.1.0.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a> (see <a href="show_bug.cgi?id=456282#c38">comment 38</a>) again. No chance.

best regards,
Hari

</pre>
    </div>

    <div id="c60" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c60">Comment 60</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-31 01:30:17 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c59">comment #59</a>)
<span class="quote">&gt; I've just tried to crash 78.0.1.0.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a> (see <a href="show_bug.cgi?id=456282#c38">comment 38</a>) again. No chance.</span >

Thanks Hari. Did you try to trigger it on the latest upstream kernel?

Eugene

</pre>
    </div>

    <div id="c61" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c61">Comment 61</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Harald Klein</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-31 14:49:41 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c60">comment #60</a>)
just tested with 2.6.27.4 on 32bit. No crash, but I noticed those messages:

mount used greatest stack depth: 1824 bytes left
locker used greatest stack depth: 1788 bytes left
locker used greatest stack depth: 1732 bytes left
locker used greatest stack depth: 1660 bytes left

Hari

</pre>
    </div>

    <div id="c62" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c62">Comment 62</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Eric Sandeen</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-31 16:45:25 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Those messages are generally harmless; each time a thread hits a new high-water (low-water?) mark, it prints this message.  1k+ is still a bit of room....    (though if this was on x86_64, with 8k of stack, that may be worrisome for x86, with only 4k)

</pre>
    </div>

    <div id="c63" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c63">Comment 63</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Harald Klein</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-10-31 16:58:10 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">test in <a href="show_bug.cgi?id=456282#c61">comment #61</a> was done on a 32bit KVM instance.

</pre>
    </div>

    <div id="c65" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c65">Comment 65</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 16:09:19 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">*** <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=464763">Bug 464763</a> has been marked as a duplicate of this bug. ***

</pre>
    </div>

    <div id="c66" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c66">Comment 66</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 16:20:31 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Copying over Uli's problem description from <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=464763">bug 464763</a>:

<a href="show_bug.cgi?id=456282#c1">Comment #1</a> From  Ulrich Obergfell (<a href="mailto:uobergfe&#64;redhat.com">uobergfe&#64;redhat.com</a>)  2008-09-30 07:52:28

problem description
-------------------


Kernel panics reproducibly with the following footprint:


kernel BUG at fs/locks.c:1823!
invalid operand: 0000 [#1]
SMP
Modules linked in: nfs nfsd exportfs
lockd nfs_acl parport_pc lp parport autofs4 i2c_dev i2c_core sunrpc loop button 
battery ac md5 ipv6 pcnet32 mii floppy dm_snapshot dm_zero dm_mirror ext3 jbd
dm
_mod ata_piix libata mptscsih mptsas mptspi mptscsi mptbase sd_mod scsi_mod
CPU:    1
EIP:    0060:[&lt;c0170a30&gt;]    Not tainted VLI
EFLAGS: 00010246   (2.6.9-78.ELsmp)
EIP is at locks_remove_flock+0xa1/0xe1
eax: cf029c0c   ebx: ca64936c   ecx: 00000000   edx: 00000001
esi: 00000000   edi: ced6940c   ebp: c6580ec0   esp: ce107f24
ds: 007b   es: 007b   ss: 0068
Process flocktest (pid: 15982, threadinfo=ce107000 task=c63ef6b0)
Stack: ced6940c 00000006 c6580ec0
00000003 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 00000000 00000246 00000000 c6580ec0
Call Trace:
 [&lt;c015d39a&gt;] __fput+0x45/0x11a
 [&lt;c016c4ed&gt;] sys_fcntl64+0x79/0x80
 [&lt;c02e09db&gt;] syscall_call+0x7/0xb
Code: 38 39 68 2c 75 2d 0f b6 50 30 f6 c2 02 74 09 89 d8 e8 ff de ff ff eb 1d
f6
 c2 20 74 0e ba 02 00 00 00 89 d8 e8 72 ec ff ff eb 0a &lt;0f&gt; 0b 1f 07 d9 5a 2f
c0
 89 c3 8b 03 eb c4 b8 00 f0 ff ff 21 e0
 &lt;0&gt;Fatal exception: panic in 5 seconds


The multithreaded &quot;flocktest&quot; process opens files via NFS and uses the fcntl()
system call to lock ranges of bytes in those files. The flow of execution thru
the fcntl() system call that is suspected to cause the problem is as follows:


sys_fcntl
  filp = fget(fd)
           increment f_count

  do_fcntl
  {
    switch (cmd)
    case F_SETLK:
         fcntl_setlk
         {
          again:

           // filp-&gt;f_op-&gt;lock
           nfs_lock
           {
             do_setlk
             {
               // NFS_PROTO(inode)-&gt;lock
               nfs3_proc_lock
                 nlmclnt_proc - nlmclnt_lock - nlmclnt_call - rpc_call_sync

               if (&quot;NFS_PROTO(inode)-&gt;lock&quot; returned -EINTR)
                  posix_lock_file_wait
                    Create a local FL_POSIX lock. ...........................
                                                                            :
               return (status from &quot;NFS_PROTO(inode)-&gt;lock&quot;)                :
             }                                                              :
           }                                                                :
                                                                            :
           // Attempt to detect a close/fcntl race and recover by releasing :
           // the lock that was just acquired.                              :
                                                                            :
           if (&quot;do_setlk/nfs_lock&quot; returned zero &amp;&amp; file has been closed)   :
              set l_type = F_UNLCK                                          :
              goto again                                                    :
         }                                                                  :
  }                                                                         :
                                                                            :
  fput(filp)                                                                :
    decrement f_count                                                       :
    if (f_count is zero)                                                    :
       __fput                                                               :
         locks_remove_flock                                                 :
           BUG() because the local FL_POSIX lock created by do_setlk() .....:
                 still exists.


One thread in the process executes the fcntl() system call. sys_fcntl() calls
fget() which increments the reference count &quot;f_count&quot; of the file structure.
Let's assume that &quot;f_count&quot; is now equal two. The thread subsequently issues
an RPC call in nfs3_proc_lock() and gets blocked while waiting for a response
from the NFS server.

Another thread in the process closes the file. filp_close() calls fput() which
decrements &quot;f_count&quot; but does not call __fput() because the reference count is
still greater than zero (there is a reference from sys_fcntl()).

The thread that is waiting for a response from the NFS server is interrupted
by a signal, so &quot;NFS_PROTO(inode)-&gt;lock&quot; returns -EINTR and do_setlk() calls
posix_lock_file_wait() in order to create a local FL_POSIX lock. fcntl_setlk()
executes the following code after &quot;filp-&gt;f_op-&gt;lock&quot; returns:


        spin_lock(&amp;current-&gt;files-&gt;file_lock);
        f = fcheck(fd);
        spin_unlock(&amp;current-&gt;files-&gt;file_lock);
        if (!error &amp;&amp;
             ^^^^^ is -EINTR
            cmd != F_UNLCK &amp;&amp; f != filp &amp;&amp; flock.l_type != F_UNLCK) {
                flock.l_type = F_UNLCK;
                goto again;
        }


The fragment of code from fcntl_setlk() attempts to detect a close/fcntl race
and recover by releasing the lock that was just acquired. However, since error
is -EINTR in the scenario outlined above, the body of the &quot;if&quot; statement is not
executed and thus the local FL_POSIX lock created by do_setlk() is not
released.

When sys_fcntl() subsequently calls fput() &quot;f_count&quot; goes down to zero (no more
references). locks_remove_flock() BUG's because the local FL_POSIX lock created
by do_setlk() still exists.

</pre>
    </div>

    <div id="c67" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c67">Comment 67</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 16:22:00 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text"><a href="show_bug.cgi?id=456282#c2">Comment #2</a> From  Ulrich Obergfell (<a href="mailto:uobergfe&#64;redhat.com">uobergfe&#64;redhat.com</a>)  2008-09-30 07:57:43 EDT

The problem exists in kernel 2.6.9-78 (RHEL 4.7) and in 2.6.18-53 (RHEL 5.1).
Panic is reproducible on a lab machine with an instrumented 2.6.18-53 kernel.


Please find below:

1. description of instrumentation
2. description of method used to reproduce
3. details from a vmcore
4. source code of test program &quot;t.c&quot;



1. instrumentation
   ---------------


The instrumentation consists of a printk() in do_setlk() and three printk()'s
in fcntl_setlk() in order to trace the flow of execution through the suspected
code.


-  code fragment from fs/nfs/file.c:

static int do_setlk(struct file *filp, int cmd, struct file_lock *fl)
{
        ...
        if (!(NFS_SERVER(inode)-&gt;flags &amp; NFS_MOUNT_NONLM)) {
                status = NFS_PROTO(inode)-&gt;lock(filp, cmd, fl);
                ...
                if (status == -EINTR || status == -ERESTARTSYS) {
                        printk(&quot;do_setlk: status=%d\n&quot;, status); &lt;-------- (1)
                        do_vfs_lock(filp, fl);
                }
        } else
                status = do_vfs_lock(filp, fl);
        ...
        if (status &lt; 0)
                goto out;
        ...
out:
        return status;
}


-  code fragment from fs/locks.c:

int fcntl_setlk(unsigned int fd, struct file *filp, unsigned int cmd,
                struct flock __user *l)
{
        ...
        if (filp-&gt;f_op &amp;&amp; filp-&gt;f_op-&gt;lock != NULL) {
                error = filp-&gt;f_op-&gt;lock(filp, cmd, file_lock);
                if (error)
                        printk(&quot;fcntl_setlk: error=%d\n&quot;, error); &lt;------- (2)
        }
        else {
                ...
        }
        ...
        if ( error &amp;&amp; fcheck(fd) != filp &amp;&amp; flock.l_type != F_UNLCK)
                printk(&quot;fcntl_setlk: *no* 'goto again'\n&quot;); &lt;------------- (3)

        if (!error &amp;&amp; fcheck(fd) != filp &amp;&amp; flock.l_type != F_UNLCK) {
                flock.l_type = F_UNLCK;
                printk(&quot;fcntl_setlk: 'goto again'\n&quot;);
                goto again;
        }       ^^^^^^^^^^
        ...    not executed
}



2. method
   ------


Note :

The messages from do_setlk() and fcntl_setlk() indicate that the printk()'s at
(1), (2), and (3) were actually executed. The error / status was -4 == -EINTR.
The body of the &quot;if&quot; statement that contains the &quot;goto again&quot; was not executed.


# echo &quot;test&quot; &gt; /tmp/testfile

# mount -o intr,hard localhost:/tmp /mnt

# ./t /mnt/testfile

Shutting down NFS mountd: [  OK  ]
Shutting down NFS daemon:
nfsd: last server has exited
nfsd: unexporting all filesystems
[  OK  ]
Shutting down NFS quotas: [  OK  ]
Shutting down NFS services:  [  OK  ]

do_setlk: status=-4
fcntl_setlk: error=-4
fcntl_setlk: *no* 'goto again'

----------- [cut here ] --------- [please bite here ] ---------
Kernel BUG at fs/locks.c:1999
invalid opcode: 0000 [1] SMP 
last sysfs file: /kernel/kexec_crash_loaded
CPU 6 
Modules linked in: nfs(U) fscache(U) nfsd(U) exportfs(U) lockd(U) nfs_acl(U)
aut
ofs4(U) hidp(U) rfcomm(U) l2cap(U) bluetooth(U) sunrpc(U) bonding(U) ipv6(U)
dm_
multipath(U) video(U) sbs(U) backlight(U) i2c_ec(U) i2c_core(U) button(U)
batter
y(U) asus_acpi(U) acpi_memhotplug(U) ac(U) parport_pc(U) lp(U) parport(U)
joydev
(U) shpchp(U) pcspkr(U) bnx2(U) ide_cd(U) cdrom(U) sg(U) dm_snapshot(U)
dm_zero(
U) dm_mirror(U) dm_mod(U) ata_piix(U) libata(U) megaraid_sas(U) sd_mod(U)
scsi_m
od(U) ext3(U) jbd(U) ehci_hcd(U) ohci_hcd(U) uhci_hcd(U)
Pid: 4618, comm: t Not tainted 2.6.18-53.el5_UliO_Test #9
RIP: 0010:[&lt;ffffffff80027074&gt;]  [&lt;ffffffff80027074&gt;]
locks_remove_flock+0xe4/0x122
RSP: 0018:ffff8109a6905e48  EFLAGS: 00010246
RAX: ffff8109a6815298 RBX: ffff8109a639b2f8 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000286 RDI: ffffffff802fee80
RBP: ffff8109bcd89380 R08: ffff8109b2824580 R09: 0000000000000020
R10: 0000000000000000 R11: 0000000000000000 R12: ffff8109a639b1f8
R13: ffff8109a639b1f8 R14: ffff8101222ae480 R15: ffff8109a6ca4a98
FS:  0000000040a00940(0063) GS:ffff8109bfc44b40(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
CR2: 000000360c66c0c7 CR3: 00000009af07b000 CR4: 00000000000006e0
Process t (pid: 4618, threadinfo ffff8109a6904000, task ffff8109bcf23080)
Stack:  0000000000000000 0000000000000000 0000000000000000 0000000000000000
 0000000000000000 ffff8109bcd89380 00000000000011e1 0000000000000000
 0000000000000000 0000000000000000 ffff8109bcd89380 0000000000000212
Call Trace:
 [&lt;ffffffff80012302&gt;] __fput+0x94/0x198
 [&lt;ffffffff8002e2d2&gt;] sys_fcntl+0x2d0/0x2dc
 [&lt;ffffffff8005c28d&gt;] tracesys+0xd5/0xe0

Code: 0f 0b 68 aa ee 28 80 c2 cf 07 48 89 c3 48 8b 03 48 85 c0 75 
RIP  [&lt;ffffffff80027074&gt;] locks_remove_flock+0xe4/0x122
 RSP &lt;ffff8109a6905e48&gt;



3. details from a vmore
   --------------------


   1963 void locks_remove_flock(struct file *filp)
   1964 {
     :
   1985         lock_kernel();
   1986         before = &amp;inode-&gt;i_flock;
   1987 
   1988         while ((fl = *before) != NULL) {
   1989                 if (fl-&gt;fl_file == filp) {
   1990                         if (IS_FLOCK(fl)) {
   1991                                 locks_delete_lock(before);
   1992                                 continue;
   1993                         }
   1994                         if (IS_LEASE(fl)) {
   1995                                 lease_modify(before, F_UNLCK);
   1996                                 continue;
   1997                         }
   1998                         /* What? */
-&gt; 1999 &lt;-                      BUG();
   2000                 }
   2001                 before = &amp;fl-&gt;fl_next;
   2002         }
   2003         unlock_kernel();
   2004 }


crash&gt; sys
      KERNEL: vmlinux
    DUMPFILE: vmcore
        CPUS: 16
        DATE: Mon Sep 29 12:00:29 2008
      UPTIME: 00:04:45
LOAD AVERAGE: 0.40, 0.38, 0.18
       TASKS: 249
    NODENAME: ibm-x3850m2-1
     RELEASE: 2.6.18-53.el5_UliO_Test
     VERSION: #9 SMP Mon Sep 29 11:46:37 EDT 2008
     MACHINE: x86_64  (2932 Mhz)
      MEMORY: 37.5 GB
       PANIC: &quot;&quot;


crash&gt; log | grep _setlk
do_setlk: status=-4
fcntl_setlk: error=-4
fcntl_setlk: *no* 'goto again'

crash&gt; log | grep BUG
Kernel BUG at fs/locks.c:1999


crash&gt; bt
PID: 4618   TASK: ffff8109bcf23080  CPU: 6   COMMAND: &quot;t&quot;
 #0 [ffff8109a6905ca0] die at ffffffff8006a681
 #1 [ffff8109a6905cd0] do_invalid_op at ffffffff8006ac37
 #2 [ffff8109a6905d90] error_exit at ffffffff8005cde9
    [exception RIP: locks_remove_flock+228]
    RIP: ffffffff80027074  RSP: ffff8109a6905e48  RFLAGS: 00010246
    RAX: ffff8109a6815298  RBX: ffff8109a639b2f8  RCX: 0000000000000000
    RDX: 0000000000000000  RSI: 0000000000000286  RDI: ffffffff802fee80
    RBP: ffff8109bcd89380   R8: ffff8109b2824580   R9: 0000000000000020
    R10: 0000000000000000  R11: 0000000000000000  R12: ffff8109a639b1f8
    R13: ffff8109a639b1f8  R14: ffff8101222ae480  R15: ffff8109a6ca4a98
    ORIG_RAX: ffffffffffffffff  CS: 0010  SS: 0018
 #3 [ffff8109a6905e40] locks_remove_flock at ffffffff80027045
 #4 [ffff8109a6905f10] __fput at ffffffff80012302
 #5 [ffff8109a6905f50] sys_fcntl at ffffffff8002e2d2
 #6 [ffff8109a6905f80] tracesys at ffffffff8005c28d (via system_call)
    RIP: 000000360d20cddf  RSP: 0000000040a00010  RFLAGS: 00000297
    RAX: ffffffffffffffda  RBX: ffffffff8005c28d  RCX: ffffffffffffffff
    RDX: 0000000040a00110  RSI: 0000000000000006  RDI: 0000000000000003
    RBP: 0000000040a01000   R8: 0000000040a00940   R9: 0000000000000000
    R10: 0000000000000000  R11: 0000000000000297  R12: 0000000000000000
    R13: 0000000000000000  R14: 0000000000000003  R15: 0000000040a00110
    ORIG_RAX: 0000000000000048  CS: 0033  SS: 002b


crash&gt; px ((struct task_struct *)0xffff8109bcf23080)-&gt;thread_info.flags
$1 = 0x84
        ^ TIF_SIGPENDING is set

crash&gt; px ((struct task_struct *)0xffff8109bcf23080)-&gt;pending.signal.sig
$2 = {0x100}
        ^ SIGKILL is pending


crash&gt; dis 0xffffffff800122fa 3                 // rdi = rbp (file)
0xffffffff800122fa &lt;__fput+140&gt;:                mov    %rbp,%rdi
                                                // locks_remove_flock()
0xffffffff800122fd &lt;__fput+143&gt;:                callq  0xffffffff80026f90
0xffffffff80012302 &lt;__fput+148&gt;:                mov    0x20(%rbp),%rax

crash&gt; dis locks_remove_flock 2
0xffffffff80026f90 &lt;locks_remove_flock&gt;:        push   %r12
                                                // save rbp (file)
0xffffffff80026f92 &lt;locks_remove_flock+2&gt;:      push   %rbp


crash&gt; bt -f
PID: 4618   TASK: ffff8109bcf23080  CPU: 6   COMMAND: &quot;t&quot;
...
 #3 [ffff8109a6905e40] locks_remove_flock at ffffffff80027045
    ffff8109a6905e48: 0000000000000000 0000000000000000
...                                    saved rbp (file)
    ffff8109a6905ef8: 0000000000000010 ffff8109bcd89380 
    ffff8109a6905f08: ffff8109a639b1f8 ffffffff80012302 
...


crash&gt; px *((struct file *)0xffff8109bcd89380)-&gt;f_dentry-&gt;d_inode-&gt;i_flock
$3 = {                               ^
  fl_next = 0x0,                     |
...                                  |
  fl_pid = 0x11e1 = 4577,            |
...                                  |
  fl_file = 0xffff8109bcd89380, -----+
  fl_flags = 0x1, 
               ^ FL_POSIX lock exists for &quot;testfile&quot;
  fl_type = 0x0, 
  fl_start = 0x0, 
  fl_end = 0x0, 
...
}


crash&gt; ps -g 4577
PID: 4577   TASK: ffff8109bac7c080  CPU: 6   COMMAND: &quot;t&quot;
  PID: 4618   TASK: ffff8109bcf23080  CPU: 6   COMMAND: &quot;t&quot;


crash&gt; bt 4577
PID: 4577   TASK: ffff8109bac7c080  CPU: 6   COMMAND: &quot;t&quot;
 #0 [ffff8109a6ca7e38] schedule at ffffffff80061f29
 #1 [ffff8109a6ca7f20] do_exit at ffffffff80015579
 #2 [ffff8109a6ca7f80] tracesys at ffffffff8005c28d (via system_call)
    RIP: 000000360c69585f  RSP: 00007fff9bee28b8  RFLAGS: 00000246
    RAX: ffffffffffffffda  RBX: ffffffff8005c28d  RCX: ffffffffffffffff
    RDX: 0000000000000000  RSI: 000000000000003c  RDI: 0000000000000000
    RBP: 000000360c946878   R8: 00000000000000e7   R9: ffffffffffffffb0
    R10: 0000000000000000  R11: 0000000000000246  R12: 0000000000000000
    R13: 000000360c946878  R14: ffffffff80046f0e  R15: 00007fff9bee29b0
    ORIG_RAX: 00000000000000e7  CS: 0033  SS: 002b



4. source code of test program
   ---------------------------


Note: compile with &quot;cc t.c -lpthread -o t&quot;


#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;pthread.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;

int fd;

pthread_t other_thread;

void *other_thread_routine(void *dummy_arg)
{
    struct flock fl;

    fl.l_type   = F_RDLCK;
    fl.l_whence = SEEK_SET;
    fl.l_start  = 0;
    fl.l_len    = 1;

    if (fcntl(fd, F_SETLK, &amp;fl) == -1) {
        perror(&quot;fcntl lock&quot;);
        goto out;
    }

    fl.l_type   = F_UNLCK;

    if (fcntl(fd, F_SETLK, &amp;fl) == -1)
        perror(&quot;fcntl unlock&quot;);
out:
    return (void *)0;
}

main(int argc, char *argv[])
{
    pid_t pid;
    int i, ret;

    if ((fd = open(argv[1], O_RDONLY)) == -1) {
        perror(&quot;open&quot;);
        exit(1);
    }

    system(&quot;service nfs stop&quot;);

    ret = pthread_create(&amp;other_thread,
                         (pthread_attr_t *)0,
                         other_thread_routine,
                         (void *)0);
    if (ret) {
        perror(&quot;pthread_create&quot;);
        exit(1);
    }

    sleep(1);

    if (close(fd) == -1) {
        perror(&quot;close&quot;);
        exit(1);
    }
}

</pre>
    </div>

    <div id="c68" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c68">Comment 68</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 16:37:15 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">commit c4d7c402b788b73dc24f1e54a57f89d3dc5eb7bc
Author: Trond Myklebust &lt;<a href="mailto:Trond.Myklebust&#64;netapp.com">Trond.Myklebust&#64;netapp.com</a>&gt;
Date:   Tue Apr 1 20:26:52 2008 -0400

    NFS: Remove the buggy lock-if-signalled case from do_setlk()
    
    Both NLM and NFSv4 should be able to clean up adequately in the case where
    the user interrupts the RPC call...
    
    Signed-off-by: Trond Myklebust &lt;<a href="mailto:Trond.Myklebust&#64;netapp.com">Trond.Myklebust&#64;netapp.com</a>&gt;

diff --git a/fs/nfs/file.c b/fs/nfs/file.c
index 10e8b80..742cb74 100644
--- a/fs/nfs/file.c
+++ b/fs/nfs/file.c
&#64;&#64; -566,17 +566,9 &#64;&#64; static int do_setlk(struct file *filp, int cmd, struct file_lock *fl)
 
        lock_kernel();
        /* Use local locking if mounted with &quot;-onolock&quot; */
-       if (!(NFS_SERVER(inode)-&gt;flags &amp; NFS_MOUNT_NONLM)) {
+       if (!(NFS_SERVER(inode)-&gt;flags &amp; NFS_MOUNT_NONLM))
                status = NFS_PROTO(inode)-&gt;lock(filp, cmd, fl);
-               /* If we were signalled we still need to ensure that
-                * we clean up any state on the server. We therefore
-                * record the lock call as having succeeded in order to
-                * ensure that locks_remove_posix() cleans it out when
-                * the process exits.
-                */
-               if (status == -EINTR || status == -ERESTARTSYS)
-                       do_vfs_lock(filp, fl);
-       } else
+       else
                status = do_vfs_lock(filp, fl);
        unlock_kernel();
        if (status &lt; 0)

</pre>
    </div>

    <div id="c69" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c69">Comment 69</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 19:21:54 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=325729&amp;action=diff" name="attach_325729" title="Backport c4d7c402b788b73dc24f1e54a57f89d3dc5eb7bc to RHEL4">attachment 325729</a> <a href="attachment.cgi?id=325729&amp;action=edit" title="Backport c4d7c402b788b73dc24f1e54a57f89d3dc5eb7bc to RHEL4">[details]</a></span>
Backport c4d7c402b788b73dc24f1e54a57f89d3dc5eb7bc to RHEL4

Backport Trond's patch to remove bogus signal-detection check from do_setlk(). This check is useless (the locking module should be able to clean up properly after being interrupted by a signal) and causes problems since it can leave a half-baked POSIX lock lying around for locks_remove_flock to trip over in the return path from sys_fcntl (after racing with close()).

The original patch uses do_vfs_lock() which is an NFS helper routine not present in RHEL4's 2.6.9 kernel (introduced in 2.6.12). All this does is to make the appropriate posix_lock_file_wait()/flock_lock_file_wait() call and log a warning if the lock manager returns an error. This version just calls posix_lock_file_wait directly and prints the warning directly from do_setlk().

</pre>
    </div>

    <div id="c71" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c71">Comment 71</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-04 20:10:19 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Upstream patch applies OK to RHEL5

</pre>
    </div>

    <div id="c72" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c72">Comment 72</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-05 03:37:47 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Tested with 2.6.9-78.0.1.2.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.EL (see <a href="show_bug.cgi?id=456282#c67">comment #67</a>):
[root&#64;rhel4-as-i386 ~]# ./t /mnt/testfile
Shutting down RPC svcgssd:                                 [FAILED]
Shutting down NFS mountd:                                  [  OK  ]
Shutting down NFS daemon:                                  [  OK  ]
Shutting down NFS quotas:                                  [  OK  ]
Shutting down NFS services:                                [  OK  ]

[...]
nfsd: last server has exited
nfsd: unexporting all filesystems
do_setlk: VFS is out of sync with lock manager!

Can't trigger the BUG().

</pre>
    </div>

    <div id="c73" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c73">Comment 73</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-05 04:02:23 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Can't trigger the BUG() using the testcase in <a href="show_bug.cgi?id=456282#c7">comment #7</a> too.

</pre>
    </div>

    <div id="c74" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c74">Comment 74</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-05 07:15:41 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Hmm. So I added the patch, and brew built a rhel-5 kernel. Did you see this before?

[root&#64;rhel5-server-i386 ~]# ./t /mnt/testfile
Shutting down NFS mountd:                                  [  OK  ]
Shutting down NFS daemon:                                  [  OK  ]
Shutting down NFS services:                                [  OK  ]

nfsd: last server has exited
nfsd: unexporting all filesystems
lockd: cannot monitor 127.0.0.1
lockd: failed to monitor 127.0.0.1
portmap: server localhost not responding, timed out
RPC: failed to contact portmap (errno -5).
BUG: unable to handle kernel paging request at virtual address 205c1e7f
 printing eip:
c0431a3f
*pde = 00000000
Oops: 0000 [#1]
SMP 
last sysfs file: /block/dm-1/range
Modules linked in: nfs fscache nfsd exportfs lockd nfs_acl auth_rpcgss sunrpc ipt_REJECT ip6t_REJECT xt_tcpudp ip6table_filter ip6_tables x_tables ipv6 xfrm_nalgo crypto_api dm_multipath scsi_dh video hwmon backlight sbs i2c_ec button battery asus_acpi ac parport_pc lp parport floppy pcspkr ide_cd i2c_piix4 i2c_core 8139too serio_raw 8139cp mii cdrom dm_snapshot dm_zero dm_mirror dm_log dm_mod ata_piix libata sd_mod scsi_mod ext3 jbd uhci_hcd ohci_hcd ehci_hcd
CPU:    1
EIP:    0060:[&lt;c0431a3f&gt;]    Not tainted VLI
EFLAGS: 00010297   (2.6.18-125.el5.<a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=456288">bz456288</a> #1) 
EIP is at flush_workqueue+0x3f/0x66
eax: 205c1e7f   ebx: 00000000   ecx: 00000286   edx: 00000000
esi: de78f340   edi: 00000000   ebp: 00000801   esp: dc705ee0
ds: 007b   es: 007b   ss: 0068
Process rpc.nfsd (pid: 1862, ti=dc705000 task=df63e000 task.ti=dc705000)
Stack: e0baf320 de78f340 c0431a87 dd9d80e0 00000000 e0b9b4fd c060fce7 dd9d80c0 
       dd9d80e0 dd9d80c0 00000007 e0b874e5 dd9d80c0 fffffdff e0b11055 e0bad768 
       e0b8749a dfc89a40 00000008 e0b8792a 00000000 e0b87aef e0ba07c0 dfc89a40 
Call Trace:
 [&lt;c0431a87&gt;] cancel_rearming_delayed_workqueue+0x21/0x23
 [&lt;e0b9b4fd&gt;] nfs4_state_shutdown+0x19/0x155 [nfsd]
 [&lt;c060fce7&gt;] _spin_lock_bh+0x8/0x18
 [&lt;e0b874e5&gt;] nfsd_last_thread+0x39/0x62 [nfsd]
 [&lt;e0b11055&gt;] svc_destroy+0x66/0x95 [sunrpc]
 [&lt;e0b8749a&gt;] nfsd_svc+0x1aa/0x1bc [nfsd]
 [&lt;e0b8792a&gt;] write_svc+0x0/0x18 [nfsd]
 [&lt;e0b87aef&gt;] nfsctl_transaction_write+0x36/0x60 [nfsd]
 [&lt;c0497245&gt;] sys_nfsservctl+0x13d/0x17c
 [&lt;c0471319&gt;] do_sys_open+0xa6/0xae
 [&lt;c0404f17&gt;] syscall_call+0x7/0xb
 =======================
Code: 15 94 88 7a c0 5b 5e f7 d0 8b 04 90 e9 54 ff ff ff b8 fc fc 67 c0 e8 69 d4 1d 00 b8 e0 ef 6e c0 e8 83 44 0b 00 eb 18 8b 06 f7 d0 &lt;8b&gt; 04 98 e8 32 ff ff ff ba e0 ef 6e c0 89 d8 e8 83 44 0b 00 83 
EIP: [&lt;c0431a3f&gt;] flush_workqueue+0x3f/0x66 SS:ESP 0068:dc705ee0
 &lt;0&gt;Kernel panic - not syncing: Fatal exception

</pre>
    </div>

    <div id="c76" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c76">Comment 76</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-05 07:45:57 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c74">comment #74</a>)
<span class="quote">&gt; Hmm. So I added the patch, and brew built a rhel-5 kernel. Did you see this
&gt; before?
&gt; 
&gt; [root&#64;rhel5-server-i386 ~]# ./t /mnt/testfile
&gt; Shutting down NFS mountd:                                  [  OK  ]
&gt; Shutting down NFS daemon:                                  [  OK  ]
&gt; Shutting down NFS services:                                [  OK  ]
&gt; 
&gt; nfsd: last server has exited
&gt; nfsd: unexporting all filesystems
&gt; lockd: cannot monitor 127.0.0.1
&gt; lockd: failed to monitor 127.0.0.1
&gt; portmap: server localhost not responding, timed out
&gt; RPC: failed to contact portmap (errno -5).
&gt; BUG: unable to handle kernel paging request at virtual address 205c1e7f</span >

2.6.27.5-117.fc10.x86_64 seems ok.

</pre>
    </div>

    <div id="c77" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c77">Comment 77</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Harald Klein</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-05 09:10:03 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">tested with kernel-2.6.9-78.0.1.2.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.EL.i686.rpm (patch from <a href="show_bug.cgi?id=456282#c69">comment #69</a>), was not able to crash. Plenty of those:
do_setlk: VFS is out of sync with lock manager!

br, Hari

</pre>
    </div>

    <div id="c79" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c79">Comment 79</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-11 13:05:44 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=326611&amp;action=diff" name="attach_326611" title="revised patch">attachment 326611</a> <a href="attachment.cgi?id=326611&amp;action=edit" title="revised patch">[details]</a></span>
revised patch

</pre>
    </div>

    <div id="c80" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c80">Comment 80</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Harald Klein</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-12 12:01:19 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">tested with kernel-2.6.9-78.0.1.3.<a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED ERRATA - CVE-2008-4307 Kernel BUG() in locks_remove_flock"
   href="show_bug.cgi?id=456282">bz456282</a>.EL.i686.rpm (patch from comment
#79) and the original reproducer, was not able to crash. I did not get any &quot;out of sync&quot; messages.

br, Hari

</pre>
    </div>

    <div id="c87" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c87">Comment 87</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Tony Procaccini</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-01-28 20:14:27 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Can someone please repost the tester code from <a href="show_bug.cgi?id=456282#c5">comment #5</a> no perms to view it.  I am seeing this crash in 2.6.9-42.0.2 rhel4u4 randomly while running a custom application that dont know enough about what it is doing to comment on.  I have applied the revised patch from <a href="show_bug.cgi?id=456282#c79">comment #79</a> and the issue persists.  I would like to be able to replicate with a set of test code since will not be able to determine what our application is doing when it crashes.  Does this patch depend on any previous patches being applied - as i had a hard time issuing the patch since locks.c was already being modified by a previous patch in 2.6.9-42src tree?  We also have 2.6.9-67 that i can try but looking at the src it is relatively the same code.  Please advise if any insight.  Thanks

</pre>
    </div>

    <div id="c88" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c88">Comment 88</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-01-29 10:02:56 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">The code is in <a href="show_bug.cgi?id=456282#c5">comment #5</a> and <a href="show_bug.cgi?id=456282#c13">comment #13</a>. Steps to reproduce are listed in <a href="show_bug.cgi?id=456282#c7">comment #7</a>. None of these are private and I've checked the permissions are correct on the attachments themselves.

</pre>
    </div>

    <div id="c89" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c89">Comment 89</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Tony Procaccini</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-01-29 20:16:52 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Thanks, I canNOT get the server to crash with the test code from <a href="show_bug.cgi?id=456282#c5">comment #5</a>/#13 on UNpatched kernel versions 2.6.9-42.02/-67/and -78.  I CAN get to crash using <a href="show_bug.cgi?id=456282#c5">comment #5</a> lockit and <a href="show_bug.cgi?id=456282#c67">comment #67</a> t.c code.  The patched verion of 2.6.9-42.0.2 seems to ride through both test cases.  However I have had an operational crash with the same bug on this patched kernel so I am still try to understand why, maybe locking files differently with application code.

</pre>
    </div>

    <div id="c90" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c90">Comment 90</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-01-30 10:47:34 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">There are several other problems in the locking code in older kernels that can lead to a panic with the same BUG message and backtrace, it's quite possible that you are hitting one of those.

</pre>
    </div>

    <div id="c91" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c91">Comment 91</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Jeff Layton</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-01-30 16:38:41 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c87">comment #87</a>)
<span class="quote">&gt; Can someone please repost the tester code from <a href="show_bug.cgi?id=456282#c5">comment #5</a> no perms to view it. 
&gt; I am seeing this crash in 2.6.9-42.0.2 rhel4u4 randomly while running a custom
&gt; application that dont know enough about what it is doing to comment on.  I have
&gt; applied the revised patch from <a href="show_bug.cgi?id=456282#c79">comment #79</a> and the issue persists.  I would
&gt; like to be able to replicate with a set of test code since will not be able to
&gt; determine what our application is doing when it crashes.  Does this patch
&gt; depend on any previous patches being applied - as i had a hard time issuing the
&gt; patch since locks.c was already being modified by a previous patch in
&gt; 2.6.9-42src tree?  We also have 2.6.9-67 that i can try but looking at the src
&gt; it is relatively the same code.  Please advise if any insight.  Thanks</span >

The crash signature in this situation is unfortunately somewhat &quot;generic&quot;. There are a lot of potential root causes for this problem but the panic will look the same. We've fixed several of these sorts of problems in earlier kernels.

This BZ has been opened specifically to address the problem/reproducer that Bryn and Uli described in <a href="show_bug.cgi?id=456282#c67">comment 67</a>. If you're still seeing panics that look like this, my suggestion would be to try and reproduce them on as recent a kernel as possible.

Even better, if you have a non-critical place to do so would be to test the kernels on my people.redhat.com page:

<a href="http://people.redhat.com/jlayton/">http://people.redhat.com/jlayton/</a>

They have patches that are slated for RHEL4.8. If you can still reproduce this panic with those, then please open another BZ. It's probable that the underlying cause is different than the one reported here.

</pre>
    </div>

    <div id="c94" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c94">Comment 94</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Corey Marthaler</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-02-04 20:28:19 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">I appear to be hitting this issue in RHEL5, is there a clone of this bug open for RHEL5?

</pre>
    </div>

    <div id="c101" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c101">Comment 101</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-02-18 07:44:49 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c94">comment #94</a>)
<span class="quote">&gt; I appear to be hitting this issue in RHEL5, is there a clone of this bug open
&gt; for RHEL5?</span >

Yes, but the bugs are for tracking purposes. Please use this bug for reporting the problem you experienced. Thanks.

</pre>
    </div>

    <div id="c110" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c110">Comment 110</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Eugene Teo (Security Response)</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-14 03:07:49 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">*** <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=491695">Bug 491695</a> has been marked as a duplicate of this bug. ***

</pre>
    </div>

    <div id="c114" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c114">Comment 114</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">errata-xmlrpc</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-29 09:28:42 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This issue has been addressed in following products:

  MRG for RHEL-5

Via RHSA-2009:0451 <a href="https://rhn.redhat.com/errata/RHSA-2009-0451.html">https://rhn.redhat.com/errata/RHSA-2009-0451.html</a>

</pre>
    </div>

    <div id="c115" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c115">Comment 115</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Ryan Ordway</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 07:10:05 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">I am running into this issue on 5.2. I am getting terrible performance on an NFS mount because of the problem. Will this be fixed prior to 5.4, or will I have to wait until 5.4 for an official kernel package?

</pre>
    </div>

    <div id="c116" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c116">Comment 116</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 14:48:18 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Hello Ryan,

Are you sure that this is the problem you are experiencing? This problem does not result in performance degradation per-se. When it triggers it causes the NFS client to panic with a BUG message (I guess though that if it is causing your nodes to reboot frequently that's going to cause poor perceived performance overall).

Due to the security concerns and wide impact of this bug it is planned to be addressed via an async errata release for all supported RHEL products where this problem exists. A fix for this issue has been proposed and is now undergoing quality assurance and verification prior to final release.

If you have active Red Hat Enterprise Linux support entitlements, please file a case with your Red Hat Global Support Services contacts who will be able to assist you and advise on the availability of fixed packages for affected releases.

Regards,

</pre>
    </div>

    <div id="c117" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c117">Comment 117</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">J. Ryan Earl</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 14:57:58 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This issue does not trigger node reboots, the reduced application performance is from reduced NFS performance.  We have empirically measured NFS performance to be low, specifically in the area of lock acquisition.  Processes are blocking for significantly longer waiting on locks when this condition triggers, specifically the one (1) lock that the error condition is being triggered on.

We're using a Kernel we built with the patch, there's simply no other option.  We couldn't wait for a fix.  With 100% assurance I can say that this patch fixed our performance problems with multiple processes synchronizing on an NFS file lock.

</pre>
    </div>

    <div id="c118" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c118">Comment 118</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">J. Ryan Earl</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 15:07:39 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=456282#c117">comment #117</a>)
<span class="quote">&gt; This issue does not trigger node reboots, the reduced application performance
&gt; is from reduced NFS performance.  We have empirically measured NFS performance
&gt; to be low, specifically in the area of lock acquisition.  Processes are
&gt; blocking for significantly longer waiting on locks when this condition
&gt; triggers, specifically the one (1) lock that the error condition is being
&gt; triggered on.
&gt; 
&gt; We're using a Kernel we built with the patch, there's simply no other option. 
&gt; We couldn't wait for a fix.  With 100% assurance I can say that this patch
&gt; fixed our performance problems with multiple processes synchronizing on an NFS
&gt; file lock.  </span >

This comment is a bit out of context, I thought I was replying to a different bug (<a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=491695">https://bugzilla.redhat.com/show_bug.cgi?id=491695</a>) which happened to be marked as a duplicate of this bug.  I got confused, I only had 1 bug open and thought I was replying to that one so while it's the same issue the response is a bit out of context.

I was only referring to my setup/tests in which I produced the other bug which has the same code solution in the kernel: ie <a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=491695">Bug #491695</a>

In my setup, application performance is affected by a dramatic decline in locking performance on NFS.  Not just locking performance, locking correctness I should add.  strace will show a return that a process has successfully acquired a lock, yet it will still be stuck in the fcntl64() call somehow...

</pre>
    </div>

    <div id="c119" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c119">Comment 119</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">Bryn M. Reeves</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 15:10:34 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Interesting - that's completely believable. We do have reports of multiple
different NFS problems that are addressed by the patch for this problem
(although this bugzilla is specific to client-side crashes triggered by the
BUG() macro in locks_remove_flock). This is the first report we have of a
significant performance degradation related to this change (e.g. we have
reports of inconsistent lock status between the VFS and NLM leading to locks
that can never be released).

</pre>
    </div>

    <div id="c120" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c120">Comment 120</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Ryan Ordway</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 18:00:37 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">Yeah, sorry to muddy the waters. My problem is the same as J. Ryan's (<a class="bz_bug_link
          bz_secure
    "
   title=""
   href="show_bug.cgi?id=491695">Bug #491695</a>), which was marked as a duplicate of this bug. I'm lucky in the fact that I can work around it by using &quot;nolock&quot;, which does fix the problem for me. I don't need locking on *these* clients, because they are just compute nodes that work on different files for each node.

</pre>
    </div>

    <div id="c121" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c121">Comment 121</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">errata-xmlrpc</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-04-30 21:25:09 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This issue has been addressed in following products:

  Red Hat Enterprise Linux 4

Via RHSA-2009:0459 <a href="https://rhn.redhat.com/errata/RHSA-2009-0459.html">https://rhn.redhat.com/errata/RHSA-2009-0459.html</a>

</pre>
    </div>

    <div id="c122" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c122">Comment 122</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard redhat_user"><span class="fn">errata-xmlrpc</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-05-07 10:53:28 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">This issue has been addressed in following products:

  Red Hat Enterprise Linux 5

Via RHSA-2009:0473 <a href="https://rhn.redhat.com/errata/RHSA-2009-0473.html">https://rhn.redhat.com/errata/RHSA-2009-0473.html</a>

</pre>
    </div>

    <div id="c123" class="bz_comment
            "
    >

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=456282#c123">Comment 123</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard "><span class="fn">Linda Wang</span>
</span>
        </span>

        
        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-05-13 02:36:57 UTC
        </span>

      </div>

      


      
      



<pre class="bz_comment_text">*** <a class="bz_bug_link
          
          bz_status_CLOSED  bz_closed
                              
    "
   title="CLOSED DUPLICATE - Request to include (CVE-2008-4307) CVE-2008-4307 Kernel BUG() in locks_remove_flock patch in RHEL4.x &amp; 5.x Kernel"
   href="show_bug.cgi?id=499089">Bug 499089</a> has been marked as a duplicate of this bug. ***

</pre>
    </div>


  <script>
$(document).ready(function() {
  var mysel = document.getElementsByClassName('flag_type-415')[0];
  var relnotes = document.getElementById('cf_release_notes');
  if ( mysel && relnotes &&
      relnotes.value != '' &&
      relnotes.value != cf_doc_type_text[document.getElementById('cf_doc_type').value] &&
      mysel.options[mysel.selectedIndex].value != '+'
    )
      document.getElementById('cf_doc_warn').innerHTML = '<div class="warning "><b>Warning: Doc Text is not yet verified as correct</b></div>';
});
</script>

</td>
<td>
</td>
</tr></table>
  </div>

    <hr><div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=456282&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=456282" title="Format For Printing"><i class="fa fa-print"></i></a></li>
    <li><a href="show_bug.cgi?ctype=xml&amp;id=456282" title="Export as XML"><i class="far fa-file-excel"></i></a></li>
    <li><a href="enter_bug.cgi?cloned_bug_id=456282" title="Clone This Bug"><i class="fa fa-clone"></i></a></li>
    <li>
      <a href="enter_bug.cgi?cloned_bug_id=456282&lite=1" title="Copy is a lite weight clone that only copies the summary &amp; description">
       <i class="far fa-clone"></i>
      </a>
    </li><li>
  <a href="buglist.cgi?bug_id=456282&amp;bug_id_type=anddependson&amp;format=tvp" title="TreeView+">
    <i class="fa fa-tree"></i>
  </a>
</li>
    <li>
      <a href="#" title="Top of page">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
      </a>
    </li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li class="form">
    
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>
<script type="text/javascript">
function dt_submit() {
  var tables = $.fn.dataTable.tables( { visible: true, api: true } );
  $.each(tables.context, function() {
    var $myform = this.nTable.closest('form');

    // Checked checkboxes
    $.each(this.oInstance.$('input:checked'), function() {
      add_hidden(this.name, this.value, $myform)
    });

    // Inputs in selected rows
    $.each(this.oInstance.$('tr.selected'), function() {
      $(this).find('input').each( function() {
        add_hidden(this.name, this.value, $myform)
      });
    });

    // select boxes
    $.each(this.oInstance.$('select'), function() {
      if(($(this).val()!=="") && ($(this).val() !== 0)) {
        add_hidden(this.name, this.value, $myform);
      }
    });
  });
}

function add_hidden(nm, val, $frm) {
        $('<input />').attr('type', 'hidden')
          .attr('name', nm)
          .attr('value', val)
          .appendTo($frm);
}

$(document).ready(function() {
    $('form').submit(function( event ) {
        dt_submit();
        if( $(this).attr('id') === 'changeform') {
          return(validateEnterBug(this));
        }
    });
});

if (window.self !== window.top) {
    $('#header').addClass('bz_default_hidden');
    $('#footer').addClass('bz_default_hidden');
    $('.navigation').addClass('bz_default_hidden');
    $('body').css('background-image', 'none');
}
</script><script type="text/javascript">
$(document).ready(function() {
    $('select').not('.custom_search_condition select, #member_template select, #available_columns, #p2_component, #select_user_verify_class, #inclusion_to_remove, #exclusion_to_remove, #cc, #hide, #ack_col_edit #show, .noselectize, #j_top').each(function() {
        if(! $(this).hasClass('selectized')) {
            $(this).selectize({
                plugins: ['remove_button', 'minimum_search_length', 'extra_keys_control', 'related_fields', 'load_from_js'],
                selectOnTab: true,
                maxOptions: 'nolimit',
                minimum_search_length: 2,
                render: {
                    option: function(item, escape) {
                        var classes = "option";
                        var selected = this.items.indexOf(item.value) !== -1;
                        if(item.disabled) {
                            classes = classes + " bz_default_hidden" ;
                        }

                        return '<div class="' +  classes  + '" title="' + escape(item.title) + '" id="' + escape(item.id) + '" data-value="' + escape(item.value) + '">' +
                                    '<span>' + escape(item.text) + '</span>' +
                                '</div>';
                    }
                },
            });
        }
    });
});
</script>
  </body>
</html>