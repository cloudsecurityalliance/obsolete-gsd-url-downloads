<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #74782 - RDF' href='rss/bug.php?id=74782'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #74782 - RSS 2.0' href='rss/bug.php?id=74782&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #74782 :: Reflected XSS in .phar 404 page</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=74782">Sec Bug</a>&nbsp;#74782</th>
            <td id="summary" colspan="5">Reflected XSS in .phar 404 page</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2017-06-19 18:15 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2018-01-16 09:06 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.30</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5712" target="_blank">2018-5712</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=74782&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=74782&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=74782&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1497896156">&nbsp;</a><strong>[2017-06-19 18:15 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Hi,

When creating a .phar file and configuring apache to handle phar files using php, when accessing invalid page the page name is reflected back to the user in the 404 response. this user input is not being sanitized and therefor it is vulnerable to a reflected XSS.

meaning, every site which configured to run .phar files using php is vulnerable.


</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=74782&amp;patch=74782patch&amp;revision=latest" >74782patch</a>
(last revision 2018-10-22 05:52 UTC by 1246196870 &#x61;&#116; qq &#x64;&#111;&#x74; com)
<br><p><a href='patch-add.php?bug_id=74782'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=74782'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1497907481">&nbsp;</a><strong>[2017-06-19 21:24 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Could you provide some details about how Apache was configured, maybe Apache config directives, so we could be sure we're checking the same configuration?
</pre>
</div><div class='comment type_comment' ><a name="1497940817">&nbsp;</a><strong>[2017-06-20 06:40 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>I just added the (ar) file to the php5.6.conf file in the apache mods-enabled dir as follows:

&lt;FilesMatch &quot;.+\.ph(ar|p[3457]?|t|tml)$&quot;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;


Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1497944113">&nbsp;</a><strong>[2017-06-20 07:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Thank you, could you also provide a message that you are seeing in the response?
</pre>
</div><div class='comment type_log' ><a name="1497944127">&nbsp;</a><strong>[2017-06-20 07:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_log' ><a name="1497945508">&nbsp;</a><strong>[2017-06-20 07:58 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Open</span>
</div></div></div><div class='comment type_comment' ><a name="1497945508">&nbsp;</a><strong>[2017-06-20 07:58 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>REQUEST:
-----------------------

GET /myapp.phar/%3cscript%3ealert()%3c/script%3e HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 6.3; rv:36.0) Gecko/20100101 Firefox/36.04
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1


RESPONSE:
--------------
HTTP/1.0 404 Not Found
Date: Tue, 20 Jun 2017 07:52:21 GMT
Server: Apache/2.4.7 (Ubuntu)
Content-Length: 138
Connection: close
Content-Type: text/html; charset=UTF-8

&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;File Not Found&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
  &lt;h1&gt;404 - File /&lt;script&gt;alert()&lt;/script&gt; Not Found&lt;/h1&gt;
 &lt;/body&gt;
&lt;/html&gt;


The root cause of the vulnerability is when php generates .phar files it also adds a piece of code that handles the case where the requested file in the archive couldn't be found, as can be seen in the following code snippet:

$a = realpath(Extract_Phar::$temp . DIRECTORY_SEPARATOR . $pt);
if (!$a || strlen(dirname($a)) &lt; strlen(Extract_Phar::$temp)) {
header('HTTP/1.0 404 Not Found');
echo &quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;File Not Found&lt;title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;404 - File &quot;, $pt, &quot; Not Found&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;;
exit;
}

$pt variable contains the user's requested page, and as can be seen it is being echoed back as is in the 404 response.
</pre>
</div><div class='comment type_comment' ><a name="1497945937">&nbsp;</a><strong>[2017-06-20 08:05 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Some more info, this is how i created the phar file:

&lt;?php
$srcRoot = &quot;~/myapp/src&quot;;
$buildRoot = &quot;~/myapp/build&quot;;
 
$phar = new Phar($buildRoot . &quot;/myapp.phar&quot;, 
	FilesystemIterator::CURRENT_AS_FILEINFO |     	FilesystemIterator::KEY_AS_FILENAME, &quot;myapp.phar&quot;);
$phar[&quot;index.php&quot;] = file_get_contents($srcRoot . &quot;/index.php&quot;);
$phar[&quot;common.php&quot;] = file_get_contents($srcRoot . &quot;/common.php&quot;);
$phar-&gt;setStub($phar-&gt;createDefaultStub(&quot;index.php&quot;));

copy($srcRoot . &quot;/config.ini&quot;, $buildRoot . &quot;/config.ini&quot;);
</pre>
</div><div class='comment type_comment' ><a name="1498938685">&nbsp;</a><strong>[2017-07-01 19:51 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi, any news regarding this? thanks.
</pre>
</div><div class='comment type_comment' ><a name="1499027570">&nbsp;</a><strong>[2017-07-02 20:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as 68ba96895d73a3e6fb0cbf004f2a62add9926737 and in <a href="https://gist.github.com/70d2f6bac8db576d6386bd79c1e6e081" rel="nofollow">https://gist.github.com/70d2f6bac8db576d6386bd79c1e6e081</a>

Please verify.
</pre>
</div><div class='comment type_log' ><a name="1499027580">&nbsp;</a><strong>[2017-07-02 20:33 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1499071328">&nbsp;</a><strong>[2017-07-03 08:42 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Yes, i can confirm that the provided fix would solve the problem.
</pre>
</div><div class='comment type_comment' ><a name="1499071440">&nbsp;</a><strong>[2017-07-03 08:44 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Are you going to issue a CVE identifier for this vulnerability? thanks.
</pre>
</div><div class='comment type_comment' ><a name="1501484028">&nbsp;</a><strong>[2017-07-31 06:53 UTC] passownz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi, any update?
</pre>
</div><div class='comment type_log' ><a name="1514865276">&nbsp;</a><strong>[2018-01-02 03:54 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_svn' ><a name="1514867266">&nbsp;</a><strong>[2018-01-02 04:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=73ca9b37731dd9690ffd9706333b17eaf90ea091" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=73ca9b37731dd9690ffd9706333b17eaf90ea091</a>
Log: Fix <a href='bug.php?id=74782'>bug #74782</a>: remove file name from output to avoid XSS
</pre>
</div><div class='comment type_log' ><a name="1514867267">&nbsp;</a><strong>[2018-01-02 04:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1514870756">&nbsp;</a><strong>[2018-01-02 05:25 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=73ca9b37731dd9690ffd9706333b17eaf90ea091" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=73ca9b37731dd9690ffd9706333b17eaf90ea091</a>
Log: Fix <a href='bug.php?id=74782'>bug #74782</a>: remove file name from output to avoid XSS
</pre>
</div><div class='comment type_svn' ><a name="1514874772">&nbsp;</a><strong>[2018-01-02 06:32 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e1532dd868a5bc80c85dcbdfb537035978234499" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e1532dd868a5bc80c85dcbdfb537035978234499</a>
Log: Fix <a href='bug.php?id=74782'>bug #74782</a>: remove file name from output to avoid XSS
</pre>
</div><div class='comment type_svn' ><a name="1514930784">&nbsp;</a><strong>[2018-01-02 22:06 UTC] <a href="//people.php.net/pollita">pollita@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=c269b1042343881576d26d2f81875bd6940bc620" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=c269b1042343881576d26d2f81875bd6940bc620</a>
Log: Fix <a href='bug.php?id=74782'>bug #74782</a>: remove file name from output to avoid XSS
</pre>
</div><div class='comment type_svn' ><a name="1514945010">&nbsp;</a><strong>[2018-01-03 02:03 UTC] <a href="//people.php.net/pollita">pollita@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=4e3f55c36272a5f29b50e1924b78e9db1b23f214" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4e3f55c36272a5f29b50e1924b78e9db1b23f214</a>
Log: Fix <a href='bug.php?id=74782'>bug #74782</a>: remove file name from output to avoid XSS
</pre>
</div><div class='comment type_log' ><a name="1516093570">&nbsp;</a><strong>[2018-01-16 09:06 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2018-5712</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
