<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #74435 - RDF' href='rss/bug.php?id=74435'>
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #74435 - RSS 2.0' href='rss/bug.php?id=74435&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #74435 :: Buffer over-read into uninitialized memory</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=74435">Sec Bug</a>&nbsp;#74435</th>
            <td id="summary" colspan="5">Buffer over-read into uninitialized memory</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2017-04-13 16:34 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2017-07-05 04:12 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>admin &#x61;&#116; replay &#x64;&#111;&#x74; gg</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=cmb">cmb</a> (<a href="https://people.php.net/cmb">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=GD+related">GD related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.1.3</td>
            <th class="details">OS:</th>
            <td>All</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7890" target="_blank">2017-7890</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=74435&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=74435&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=74435&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1492101290">&nbsp;</a><strong>[2017-04-13 16:34 UTC] admin &#x61;&#116; replay &#x64;&#111;&#x74; gg</strong>
<pre class='note'>Description:
------------
The GIF decoding function gdImageCreateFromGifCtx in gd_gif_in.c (which can be reached with a call to the imagecreatefromstring() function) uses constant-sized color tables of size 3 * 256, but does not zero-out these arrays before use.

An attacker could craft a GIF image with the smallest global color table of size 2, but have color data which indexes the max 256 possibly distinct colors. As a result, the decoded image will contain pixels who's RGB colors will represent whatever data was in the 762 non-initialized bytes from the color table (ColorMap array), which is on the stack.

If the image is then saved and can be accessed, the attacker can use the RGB values of the pixels in the image to read 762 bytes that were on the stack at the time the image was parsed. This could cause sensitive server data such as private keys to be read by the attacker.

If the decoded image is saved in a lossless PNG format, byte-perfect data recovery is trivial. If the decoded image is saved in the JPEG format with the standard 8x8 block DCT, the attacker could craft a GIF image with 16x16 solid-color blocks (to account for CbCr channel down-sampling) which would preserve the pixel data through the quantization process, and again allow for byte-perfect data recovery. 

Currently all websites and applications that rely on PHP's imagecreatefromstring() or imagecreatefromgif() function to decode and save GIF images are vulnerable to this bug.

The appropriate solution is to zero both ColorMap and localColorMap arrays before use.

This bug has been confirmed by the current maintainers of the official LibGD branch.

-----
Matviy Kotoniy

Test script:
---------------
GIF file with color table size set to 0 in the descriptor, and image data which indexes 256 different colors in the color table.

Expected result:
----------------
Error, or solid color for invalid color indexes

Actual result:
--------------
RGB color data representing ~700 bytes of uninitialized data above the current stack frame. <a href="http://i.imgur.com/OsT7HFP.jpg" rel="nofollow">http://i.imgur.com/OsT7HFP.jpg</a>

</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=74435&amp;patch=fix-74435-php-7.0&amp;revision=latest" >fix-74435-php-7.0</a>
(last revision 2017-06-20 14:47 UTC by cmb@php.net)
<br><p><a href='patch-add.php?bug_id=74435'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=74435'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1492101449">&nbsp;</a><strong>[2017-04-13 16:37 UTC] admin &#x61;&#116; replay &#x64;&#111;&#x74; gg</strong>
<pre class='note'>An easy way to test the bug is to create a gradient GIF image with 256 different colors, and then hex edit the last 3 bits of the logical screen descriptor to zero. Process and save the image using the vulnerable function, and you'll see the stack data in the saved image.
</pre>
</div><div class='comment type_log' ><a name="1492350633">&nbsp;</a><strong>[2017-04-16 13:50 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Verified</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_comment' ><a name="1492350633">&nbsp;</a><strong>[2017-04-16 13:50 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this issue also here! I'll prepare a patch
for PHP's bundled libgd ASAP.

However, it would be best to release the patch for external libgd
and the bundled libgd simultaneously, but unfortunately the
release of GD 2.2.4 has been delayed.
</pre>
</div><div class='comment type_comment' ><a name="1492444975">&nbsp;</a><strong>[2017-04-17 16:02 UTC] admin &#x61;&#116; replay &#x64;&#111;&#x74; gg</strong>
<pre class='note'>The CVE for this has been assigned: CVE-2017-7890
</pre>
</div><div class='comment type_log' ><a name="1492447826">&nbsp;</a><strong>[2017-04-17 16:50 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2017-7890</span>
</div></div></div><div class='comment type_comment' ><a name="1497942871">&nbsp;</a><strong>[2017-06-20 07:14 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Anything happened with this since April?
</pre>
</div><div class='comment type_patch' ><a name="1497970040">&nbsp;</a><strong>[2017-06-20 14:47 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: fix-74435-php-7.0
Revision:   1497970038
URL:        <a href="https://bugs.php.net/patch-display.php?bug=74435&amp;patch=fix-74435-php-7.0&amp;revision=1497970038" rel="nofollow">https://bugs.php.net/patch-display.php?bug=74435&amp;patch=fix-74435-php-7.0&amp;revision=1497970038</a>
</pre>
</div><div class='comment type_comment' ><a name="1497970179">&nbsp;</a><strong>[2017-06-20 14:49 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>I've provided a patch for PHP 7.0. I assume this should be fixed
in PHP 5.6 as well, though. Anyhow, I can't say when libgd 2.2.5
will be released, where this issue also has to be fixed.
</pre>
</div><div class='comment type_svn' ><a name="1499228013">&nbsp;</a><strong>[2017-07-05 04:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8dc4f4dc9e44d1cbfe4654aa6e0dc27c94913938" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8dc4f4dc9e44d1cbfe4654aa6e0dc27c94913938</a>
Log: Fix #74435: Buffer over-read into uninitialized memory
</pre>
</div><div class='comment type_log' ><a name="1499228013">&nbsp;</a><strong>[2017-07-05 04:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Verified</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1499228620">&nbsp;</a><strong>[2017-07-05 04:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8dc4f4dc9e44d1cbfe4654aa6e0dc27c94913938" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8dc4f4dc9e44d1cbfe4654aa6e0dc27c94913938</a>
Log: Fix #74435: Buffer over-read into uninitialized memory
</pre>
</div><div class='comment type_svn' ><a name="1499323473">&nbsp;</a><strong>[2017-07-06 06:44 UTC] <a href="//people.php.net/krakjoe">krakjoe@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=018092125538782b25d3ab6b036f0c8d5968f757" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=018092125538782b25d3ab6b036f0c8d5968f757</a>
Log: Fix #74435: Buffer over-read into uninitialized memory
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
