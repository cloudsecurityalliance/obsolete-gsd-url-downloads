<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Diff - 74adca9^! - platform/frameworks/av - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/frameworks/av/%2B/74adca9%255E%2521/">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/">frameworks</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/av/">av</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/av/+/74adca9%5E%21/">74adca9^!</a> / <span class="Breadcrumbs-crumb">.</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>74adca9ad30b7f8a70d40c5237bade0d16c4ea58</td><td><span>[<a href="/platform/frameworks/av/+log/74adca9/">log</a>]</span> <span>[<a href="/platform/frameworks/av/+archive/74adca9/.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Eric Laurent &lt;elaurent@google.com&gt;</td><td>Wed Nov 05 12:15:36 2014 -0800</td></tr><tr><th class="Metadata-title">committer</th><td>Eric Laurent &lt;elaurent@google.com&gt;</td><td>Wed Nov 05 12:33:59 2014 -0800</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/frameworks/av/+/74adca9/">13e642689e945e69b76ac095a6bec978debf4084</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/frameworks/av/+/74adca9%5E">ed1e55c5276a1c031e9b2f016387c7d2fe7bc47f</a> <span>[<a href="/platform/frameworks/av/+/74adca9%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">IAudioPolicyService: bound array size in queryDefaultPreProcessing

Bug: 18226810.
Change-Id: <a href="https://android-review.googlesource.com/#/q/Ib8e2bfe835a8681aac50bf23161db14e50c9a124">Ib8e2bfe835a8681aac50bf23161db14e50c9a124</a>
</pre><pre class="u-pre u-monospace Diff"><a name="F0" class="Diff-fileIndex"></a>diff --git <a href="/platform/frameworks/av/+/ed1e55c5276a1c031e9b2f016387c7d2fe7bc47f/include/media/AudioEffect.h">a/include/media/AudioEffect.h</a> <a href="/platform/frameworks/av/+/74adca9ad30b7f8a70d40c5237bade0d16c4ea58/include/media/AudioEffect.h">b/include/media/AudioEffect.h</a>
index 4932d40..583695d 100644
--- a/include/media/AudioEffect.h
+++ b/include/media/AudioEffect.h
</pre><pre class="u-pre u-monospace Diff-unified"><span class="Diff-hunk">@@ -133,10 +133,11 @@
</span><span class="Diff-change">      *</span>
<span class="Diff-change">      * Returned value</span>
<span class="Diff-change">      *   *descriptor updated with descriptors of pre processings enabled by default</span>
<span class="Diff-delete">-     *   *count      number of descriptors returned if returned status is N_ERROR.</span>
<span class="Diff-insert">+     *   *count      number of descriptors returned if returned status is NO_ERROR.</span>
<span class="Diff-change">      *               total number of pre processing enabled by default if returned status is</span>
<span class="Diff-change">      *               NO_MEMORY. This happens if the count passed as input is less than the number</span>
<span class="Diff-delete">-     *               of descriptors to return</span>
<span class="Diff-insert">+     *               of descriptors to return.</span>
<span class="Diff-insert">+     *               *count is limited to kMaxPreProcessing on return.</span>
<span class="Diff-change">      */</span>
<span class="Diff-change">     static status_t queryDefaultPreProcessing(int audioSession,</span>
<span class="Diff-change">                                               effect_descriptor_t *descriptors,</span>
<span class="Diff-hunk">@@ -391,6 +392,10 @@
</span><span class="Diff-change">       */</span>
<span class="Diff-change">      static status_t guidToString(const effect_uuid_t *guid, char *str, size_t maxLen);</span>
<span class="Diff-change"> </span>
<span class="Diff-insert">+     // kMaxPreProcessing is a reasonable value for the maximum number of preprocessing effects</span>
<span class="Diff-insert">+     // that can be applied simultaneously.</span>
<span class="Diff-insert">+     static const uint32_t kMaxPreProcessing = 10;</span>
<span class="Diff-insert">+</span>
<span class="Diff-change"> protected:</span>
<span class="Diff-change">      bool                    mEnabled;           // enable state</span>
<span class="Diff-change">      int32_t                 mSessionId;         // audio session ID</span>
</pre><pre class="u-pre u-monospace Diff"><a name="F1" class="Diff-fileIndex"></a>diff --git <a href="/platform/frameworks/av/+/ed1e55c5276a1c031e9b2f016387c7d2fe7bc47f/media/libmedia/IAudioPolicyService.cpp">a/media/libmedia/IAudioPolicyService.cpp</a> <a href="/platform/frameworks/av/+/74adca9ad30b7f8a70d40c5237bade0d16c4ea58/media/libmedia/IAudioPolicyService.cpp">b/media/libmedia/IAudioPolicyService.cpp</a>
index 256cb3f..180f5fb 100644
--- a/media/libmedia/IAudioPolicyService.cpp
+++ b/media/libmedia/IAudioPolicyService.cpp
</pre><pre class="u-pre u-monospace Diff-unified"><span class="Diff-hunk">@@ -23,6 +23,7 @@
</span><span class="Diff-change"> </span>
<span class="Diff-change"> #include &lt;binder/Parcel.h&gt;</span>
<span class="Diff-change"> </span>
<span class="Diff-insert">+#include &lt;media/AudioEffect.h&gt;</span>
<span class="Diff-change"> #include &lt;media/IAudioPolicyService.h&gt;</span>
<span class="Diff-change"> </span>
<span class="Diff-change"> #include &lt;system/audio.h&gt;</span>
<span class="Diff-hunk">@@ -916,16 +917,18 @@
</span><span class="Diff-change">             CHECK_INTERFACE(IAudioPolicyService, data, reply);</span>
<span class="Diff-change">             int audioSession = data.readInt32();</span>
<span class="Diff-change">             uint32_t count = data.readInt32();</span>
<span class="Diff-insert">+            if (count &gt; AudioEffect::kMaxPreProcessing) {</span>
<span class="Diff-insert">+                count = AudioEffect::kMaxPreProcessing;</span>
<span class="Diff-insert">+            }</span>
<span class="Diff-change">             uint32_t retCount = count;</span>
<span class="Diff-delete">-            effect_descriptor_t *descriptors =</span>
<span class="Diff-delete">-                    (effect_descriptor_t *)new char[count * sizeof(effect_descriptor_t)];</span>
<span class="Diff-insert">+            effect_descriptor_t *descriptors = new effect_descriptor_t[count];</span>
<span class="Diff-change">             status_t status = queryDefaultPreProcessing(audioSession, descriptors, &amp;retCount);</span>
<span class="Diff-change">             reply-&gt;writeInt32(status);</span>
<span class="Diff-change">             if (status != NO_ERROR &amp;&amp; status != NO_MEMORY) {</span>
<span class="Diff-change">                 retCount = 0;</span>
<span class="Diff-change">             }</span>
<span class="Diff-change">             reply-&gt;writeInt32(retCount);</span>
<span class="Diff-delete">-            if (retCount) {</span>
<span class="Diff-insert">+            if (retCount != 0) {</span>
<span class="Diff-change">                 if (retCount &lt; count) {</span>
<span class="Diff-change">                     count = retCount;</span>
<span class="Diff-change">                 }</span>
</pre></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>