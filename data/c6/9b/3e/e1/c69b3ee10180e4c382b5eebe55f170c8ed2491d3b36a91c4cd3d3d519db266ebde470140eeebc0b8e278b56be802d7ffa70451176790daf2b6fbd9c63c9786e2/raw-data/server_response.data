<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='mbstring related Bug #77367 - RDF' href='rss/bug.php?id=77367'>
        <link rel='alternate' type='application/rss+xml' title='mbstring related Bug #77367 - RSS 2.0' href='rss/bug.php?id=77367&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #77367 :: Negative size parameter in mb_split</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=77367">Sec Bug</a>&nbsp;#77367</th>
            <td id="summary" colspan="5">Negative size parameter in mb_split</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2018-12-29 02:43 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-02-22 23:17 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>hugh &#x61;&#116; allthethings &#x64;&#111;&#x74; co &#x64;&#111;&#x74; nz</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=mbstring+related">mbstring related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.3.0</td>
            <th class="details">OS:</th>
            <td>Linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9025" target="_blank">2019-9025</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=77367&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=77367&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=77367&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1546051408">&nbsp;</a><strong>[2018-12-29 02:43 UTC] hugh &#x61;&#116; allthethings &#x64;&#111;&#x74; co &#x64;&#111;&#x74; nz</strong>
<pre class='note'>Description:
------------
mb_split doesn't correctly detect the length when the $string has an unfinished multibyte character at the end of the string. This causes a crash due to a negative parameter to add_next_index_stringl, which calls zend_string_init and memcpy.

This could be used to cause memory corruption/leakage.


configure options are:
./configure --enable-static --enable-cli --enable-mbstring --disable-shared --disable-all CFLAGS=&quot;-fPIC -Og -g3&quot; LIBS=-ldl


Could reproduce on master. Couldn't reproduce on 5.6.39, 7.0.33, 7.1.25 and 7.2.13, though the same code exists (a different fuzz may produce the same).

Caused by comparison of unsigned number (size_t) to 0 to test whether it is positive. Fixed by altering the comparison to not test for negative, but instead check whether value to subtract is less than.

Patch at <a href="https://gist.github.com/hughdavenport/5128662f237d8b54d2e2b22dc7d18d5e" rel="nofollow">https://gist.github.com/hughdavenport/5128662f237d8b54d2e2b22dc7d18d5e</a>

Interestingly, it doesn't crash with &quot;[[:word:]]&quot;, but does with &quot;\w&quot;, so the docs at <a href="https://secure.php.net/manual/en/regexp.reference.character-classes.php" rel="nofollow">https://secure.php.net/manual/en/regexp.reference.character-classes.php</a> may be slightly incorrect.

Test script:
---------------
php -r 'var_dump(mb_split(&quot;\w&quot;,&quot;\xfc&quot;));'

Expected result:
----------------
No crash


Actual result:
--------------
$ gdb --args ./php-7.3.0/sapi/cli/php-mbstring-afl-fast -r 'var_dump(mb_split(&quot;\w&quot;,&quot;\xfc&quot;));'
GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;<a href="http://gnu.org/licenses/gpl.html" rel="nofollow">http://gnu.org/licenses/gpl.html</a>&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;<a href="http://www.gnu.org/software/gdb/bugs/" rel="nofollow">http://www.gnu.org/software/gdb/bugs/</a>&gt;.
Find the GDB manual and other documentation resources online at:
&lt;<a href="http://www.gnu.org/software/gdb/documentation/" rel="nofollow">http://www.gnu.org/software/gdb/documentation/</a>&gt;.
For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
Reading symbols from ./php-7.3.0/sapi/cli/php-mbstring-afl-fast...done.
(gdb) r
Starting program: /home/hugh/php-7.3.0/sapi/cli/php-mbstring-afl-fast -r var_dump\(mb_split\(\&quot;\\w\&quot;,\&quot;\\xfc\&quot;\)\)\;
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.

Program received signal SIGSEGV, Segmentation fault.
__memmove_avx_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:526
526     ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S: No such file or directory.
(gdb) bt
#0  __memmove_avx_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:526
#1  0x0000000000a72a5a in zend_string_init (str=0x122821e &quot;&quot;, len=18446744073709551611, persistent=0) at Zend/zend_string.h:157
#2  add_next_index_stringl (arg=0x7ffff661c080, str=0x122821e &quot;&quot;, length=18446744073709551611) at Zend/zend_API.c:1595
#3  0x000000000072bf72 in zif_mb_split (execute_data=&lt;optimized out&gt;, return_value=&lt;optimized out&gt;) at ext/mbstring/php_mbregex.c:1303
#4  0x0000000000c4d418 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER (execute_data=0x7ffff661c030) at Zend/zend_vm_execute.h:690
#5  0x0000000000b3e39e in execute_ex (ex=0x7ffff661c030) at Zend/zend_vm_execute.h:55287
#6  0x0000000000b3e8db in zend_execute (op_array=0x7ffff667d2a0, return_value=&lt;optimized out&gt;) at Zend/zend_vm_execute.h:60834
#7  0x0000000000a36222 in zend_eval_stringl (str=&lt;optimized out&gt;, str_len=&lt;optimized out&gt;, retval_ptr=&lt;optimized out&gt;, string_name=&lt;optimized out&gt;) at Zend/zend_execute_API.c:1018
#8  0x0000000000a365fb in zend_eval_stringl_ex (str=0x121ae20 &quot;var_dump(mb_split(\&quot;\\w\&quot;,\&quot;\\xfc\&quot;));&quot;, str_len=140737327259816, retval_ptr=0x0, string_name=0xf0c436 &quot;Command line code&quot;,
    handle_exceptions=1) at Zend/zend_execute_API.c:1059
#9  zend_eval_string_ex (str=0x121ae20 &quot;var_dump(mb_split(\&quot;\\w\&quot;,\&quot;\\xfc\&quot;));&quot;, retval_ptr=0xfffffffffffa1ef8, string_name=0x11ca0f6 &lt;stage3_table_html5_1D500+774&gt; &quot;&quot;, handle_exceptions=1)
    at Zend/zend_execute_API.c:1070
#10 0x0000000000ce5c66 in do_cli (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at sapi/cli/php_cli.c:1030
#11 0x0000000000ce407b in main (argc=3, argv=&lt;optimized out&gt;) at sapi/cli/php_cli.c:1392


$ ./php-7.3.0/sapi/cli/php-mbstring-asan-fast -r 'var_dump(mb_split(&quot;\w&quot;,&quot;\xfc&quot;));'
=================================================================
==9942==ERROR: AddressSanitizer: negative-size-param: (size=-5)
    #0 0x4db2e5 in __asan_memcpy (/home/hugh/php-7.3.0/sapi/cli/php-mbstring-asan-fast+0x4db2e5)
    #1 0x1083844 in zend_string_init /home/hugh/php-7.3.0/Zend/zend_string.h:157:2
    #2 0x1083844 in add_next_index_stringl /home/hugh/php-7.3.0/Zend/zend_API.c:1595
    #3 0xa7648f in zif_mb_split /home/hugh/php-7.3.0/ext/mbstring/php_mbregex.c
    #4 0x1410c05 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER /home/hugh/php-7.3.0/Zend/zend_vm_execute.h:690:2
    #5 0x11fee0d in execute_ex /home/hugh/php-7.3.0/Zend/zend_vm_execute.h:55287:7
    #6 0x11ff661 in zend_execute /home/hugh/php-7.3.0/Zend/zend_vm_execute.h:60834:2
    #7 0x1012390 in zend_eval_stringl /home/hugh/php-7.3.0/Zend/zend_execute_API.c:1018:4
    #8 0x1012c1a in zend_eval_stringl_ex /home/hugh/php-7.3.0/Zend/zend_execute_API.c:1059:11
    #9 0x1012c1a in zend_eval_string_ex /home/hugh/php-7.3.0/Zend/zend_execute_API.c:1070
    #10 0x153d7c6 in do_cli /home/hugh/php-7.3.0/sapi/cli/php_cli.c:1030:5
    #11 0x153a6de in main /home/hugh/php-7.3.0/sapi/cli/php_cli.c:1392:18
    #12 0x7fb02af8cb96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #13 0x43aa99 in _start (/home/hugh/php-7.3.0/sapi/cli/php-mbstring-asan-fast+0x43aa99)

0x6030000032fe is located 30 bytes inside of 32-byte region [0x6030000032e0,0x603000003300)
allocated by thread T0 here:
    #0 0x4f00f0 in malloc (/home/hugh/php-7.3.0/sapi/cli/php-mbstring-asan-fast+0x4f00f0)
    #1 0xf66f9c in __zend_malloc /home/hugh/php-7.3.0/Zend/zend_alloc.c:2904:14

SUMMARY: AddressSanitizer: negative-size-param (/home/hugh/php-7.3.0/sapi/cli/php-mbstring-asan-fast+0x4db2e5) in __asan_memcpy
==9942==ABORTING




</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=77367'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=77367'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1546087391">&nbsp;</a><strong>[2018-12-29 12:43 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Verified</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_comment' ><a name="1546087391">&nbsp;</a><strong>[2018-12-29 12:43 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this bug.  I can confirm the described issue,
and also that your patch fixes it.  PHP-7.2 and older are not affected,
since `n` had been declared as int there.

&gt; Interestingly, it doesn't crash with &quot;[[:word:]]&quot;, but does with
&gt; &quot;\w&quot;, so the docs at
&gt; <a href="https://secure.php.net/manual/en/regexp.reference.character-classes.php" rel="nofollow">https://secure.php.net/manual/en/regexp.reference.character-classes.php</a>
&gt; may be slightly incorrect.

These docs are about the PCRE extension; mb_split() and the other
mbregex functions use the Oniguruma engine which uses a somewhat
different pattern syntax.
</pre>
</div><div class='comment type_log' ><a name="1546089754">&nbsp;</a><strong>[2018-12-29 13:22 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Verified</span>
<span class="added">+Status:      Analyzed</span>
<span class="removed">-Assigned To: cmb</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1546089754">&nbsp;</a><strong>[2018-12-29 13:22 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Stas, can you please apply the formatted patch[1] to the security
repo (PHP-7.3 and up)?

[1] &lt;<a href="https://gist.github.com/cmb69/a2be4dd4240bbee11ce4cb801c60d6ab" rel="nofollow">https://gist.github.com/cmb69/a2be4dd4240bbee11ce4cb801c60d6ab</a>&gt;
</pre>
</div><div class='comment type_comment' ><a name="1546112522">&nbsp;</a><strong>[2018-12-29 19:42 UTC] hugh &#x61;&#116; allthethings &#x64;&#111;&#x74; co &#x64;&#111;&#x74; nz</strong>
<pre class='note'>Ah yeh, being an int in previous versions makes sense. Thought I was going mad!

That makes sense with the docs. I'm not sure any of the function pages describe what syntax Oniguruma uses. Would it be worth me creating another bug for that to get written at some point?

Cheers,

Hugh
</pre>
</div><div class='comment type_log' ><a name="1546139547">&nbsp;</a><strong>[2018-12-30 03:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_comment' ><a name="1546139547">&nbsp;</a><strong>[2018-12-30 03:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>In security repo as ee30a1fa4c05a5e3d53898296ed9bdb6a1d63239
</pre>
</div><div class='comment type_comment' ><a name="1546209373">&nbsp;</a><strong>[2018-12-30 22:36 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>&gt; That makes sense with the docs. I'm not sure any of the function
&gt; pages describe what syntax Oniguruma uses. Would it be worth me
&gt; creating another bug for that to get written at some point?

A quick search for existing Oniguruma pattern syntax in the manual
brought up nothing, so indeed this should be filed as
documentation problem.  The syntax is documented in
&lt;<a href="https://github.com/kkos/oniguruma/blob/master/doc/RE" rel="nofollow">https://github.com/kkos/oniguruma/blob/master/doc/RE</a>&gt;.
</pre>
</div><div class='comment type_comment' ><a name="1546209751">&nbsp;</a><strong>[2018-12-30 22:42 UTC] hugh &#x61;&#116; allthethings &#x64;&#111;&#x74; co &#x64;&#111;&#x74; nz</strong>
<pre class='note'>File <a href='bug.php?id=77383'>bug #77383</a> for the doc issue
</pre>
</div><div class='comment type_svn' ><a name="1546849251">&nbsp;</a><strong>[2019-01-07 08:20 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e617f03066ce81d26f56c06d6bd7787c7de08703" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e617f03066ce81d26f56c06d6bd7787c7de08703</a>
Log: Fix #77367: Negative size parameter in mb_split
</pre>
</div><div class='comment type_log' ><a name="1546849251">&nbsp;</a><strong>[2019-01-07 08:20 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Analyzed</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1546849266">&nbsp;</a><strong>[2019-01-07 08:21 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e617f03066ce81d26f56c06d6bd7787c7de08703" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e617f03066ce81d26f56c06d6bd7787c7de08703</a>
Log: Fix #77367: Negative size parameter in mb_split
</pre>
</div><div class='comment type_svn' ><a name="1546867054">&nbsp;</a><strong>[2019-01-07 13:17 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=11ce508ee3390d4e68542c9fdae1277e3e75a573" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=11ce508ee3390d4e68542c9fdae1277e3e75a573</a>
Log: Fix #77367: Negative size parameter in mb_split
</pre>
</div><div class='comment type_log' ><a name="1550877428">&nbsp;</a><strong>[2019-02-22 23:17 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2019-9025</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
