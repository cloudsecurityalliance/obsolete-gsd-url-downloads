<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
<link rel="icon" href="/favicon.png">
<title>#808730 - stalin: CVE-2015-8697: Insecure use of temporary files - Debian Bug report logs</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/bugs.css" type="text/css">

<link rel="canonical" href="&lt;a href=&quot;bugreport.cgi?bug=808730&quot;&gt;808730&lt;/a&gt;">
<script type="text/javascript">
<!--
function toggle_infmessages()
{
        allDivs=document.getElementsByTagName("div");
        for (var i = 0 ; i < allDivs.length ; i++ )
        {
                if (allDivs[i].className == "infmessage")
                {
                        allDivs[i].style.display=(allDivs[i].style.display == 'none' | allDivs[i].style.display == '') ? 'block' : 'none';
                }
        }
}
-->
</script>
</head>
<body>
<h1>Debian Bug report logs - 
<a href="mailto:808730@bugs.debian.org">#808730</a><br>
stalin: CVE-2015-8697: Insecure use of temporary files</h1>
<div class="versiongraph"><a href="version.cgi?info=1;found=stalin%2F0.11-5;collapse=1;absolute=0;package=stalin"><img alt="version graph" src="version.cgi?found=stalin%2F0.11-5;height=2;width=2;package=stalin;absolute=0;collapse=1"></a></div>
<div class="pkginfo">
  <p>Package:
     <a class="submitter" href="pkgreport.cgi?package=stalin">stalin</a>;
Maintainer for <a href="pkgreport.cgi?package=stalin">stalin</a> is <a href="pkgreport.cgi?maint=rlb%40defaultvalue.org">Rob Browning &lt;rlb@defaultvalue.org&gt;</a>; Source for <a href="pkgreport.cgi?package=stalin">stalin</a> is <a href="pkgreport.cgi?src=stalin">src:stalin</a> (<a href="https://tracker.debian.org/pkg/stalin">PTS</a>, <a href="https://buildd.debian.org/stalin">buildd</a>, <a href="https://qa.debian.org/popcon.php?package=stalin">popcon</a>). </p>

</div>

<div class="buginfo">
  <p>Reported by: <a href="pkgreport.cgi?submitter=steve%40steve.org.uk">Steve Kemp &lt;steve@steve.org.uk&gt;</a></p>
  <p>Date: Tue, 22 Dec 2015 10:42:01 UTC</p>

<p>Severity: important</p>
<p>Tags: security</p>

<p>Found in version stalin/0.11-5</p>



</div>

<p><a href="mailto:808730@bugs.debian.org">Reply</a> or <a href="mailto:808730-subscribe@bugs.debian.org">subscribe</a> to this bug.</p>
<p><a href="javascript:toggle_infmessages();">Toggle useless messages</a></p><div class="msgreceived"><p>View this report as an <a href="bugreport.cgi?bug=808730;mbox=yes">mbox folder</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;mboxstatus=yes">status mbox</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;mboxmaint=yes">maintainer mbox</a></p></div>

<div class="infmessage"><hr><p>
<a name="1"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Rob Browning &lt;rlb@defaultvalue.org&gt; -->
<!-- time:1450780925 -->
<strong>Report forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Rob Browning &lt;rlb@defaultvalue.org&gt;</code>:<br>
<code>Bug#808730</code>; Package <code>stalin</code>.
 (Tue, 22 Dec 2015 10:42:05 GMT) (<a href="bugreport.cgi?bug=808730;msg=2">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=2">mbox</a>, <a href="#1">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="3"></a>
<!-- request_addr: Steve Kemp &lt;steve@steve.org.uk&gt; -->
<!-- time:1450780925 -->
<strong>Acknowledgement sent</strong>
to <code>Steve Kemp &lt;steve@steve.org.uk&gt;</code>:<br>
New Bug report received and forwarded.  Copy sent to <code>Rob Browning &lt;rlb@defaultvalue.org&gt;</code>.
 (Tue, 22 Dec 2015 10:42:05 GMT) (<a href="bugreport.cgi?bug=808730;msg=4">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=4">mbox</a>, <a href="#3">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="5"></a><a name="msg5"></a><a href="#5">Message #5</a> received at submit@bugs.debian.org (<a href="bugreport.cgi?bug=808730;msg=5">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=5">mbox</a>, <a href="mailto:808730@bugs.debian.org?In-Reply-To=%3C20151222103854.GA6788%40steve.org.uk%3E&amp;subject=Re%3A%20stalin%3A%20Insecure%20use%20of%20temporary%20files&amp;body=On%20Tue%2C%2022%20Dec%202015%2010%3A38%3A54%20%2B0000%20Steve%20Kemp%20%3Csteve%40steve.org.uk%3E%20wrote%3A%0A%3E%20%0A%3E%20Package%3A%20stalin%0A%3E%20Version%3A%200.11-5%0A%3E%20Severity%3A%20critical%0A%3E%20Tags%3A%20security%0A%3E%20%0A%3E%20%0A%3E%20When%20%60stalin%60%20launches%20it%20attempts%20to%20detect%20its%20environment%20via%0A%3E%20the%20following%20code%20in%20%2Fusr%2Flib%2Fstalin%2FQobiScheme.sc%3A%0A%3E%20%0A%3E%20%20%20%20%0A%3E%20%20%20%20%20%28system%20%22uname%20-m%20%3E%2Ftmp%2FQobiScheme.tmp%22%29%0A%3E%20%20%20%20%20...%0A%3E%20%20%20%20%20%28system%20%22rm%20-f%20%2Ftmp%2FQobiScheme.tmp%22%29%29%0A%3E%20%0A%3E%20This%20is%20a%20prime%20example%20of%20the%20insecure%20use%20of%20temporary%20files%2C%0A%3E%20and%20allows%20overwriting%20any%20file%20owned%20by%20the%20user%20who%20invokes%0A%3E%20stalin.%0A%3E%20%0A%3E%20Trivial%20demonstration%3A%0A%3E%20%0A%3E%20%0A%3E%20%20%20%20%20%24%20ln%20-s%20%2Fhome%2Fsteve%2FHACK%20%2Ftmp%2FQobiScheme.tmp%0A%3E%20%20%20%20%20%24%20ls%20-l%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%20%20%20%20ls%3A%20cannot%20access%20%2Fhome%2Fsteve%2FHACK%3A%20No%20such%20file%20or%20directory%0A%3E%20%0A%3E%20Now%20run%20the%20sample%20code%3A%0A%3E%20%0A%3E%20%20%20%20%20%0A%3E%20%20%20%20%20%24%20cd%20%2Ftmp%2Fstalin-0.11%2Fbenchmarks%0A%3E%20%20%20%20%20%24%20.%2Fmake-hello%0A%3E%20%0A%3E%20And%20we%20see%20this%3A%0A%3E%20%0A%3E%20%20%20%20%20%24%20ls%20-l%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%20%20%20%20-rw-r--r--%201%20steve%20steve%206%20Dec%2022%2008%3A30%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%0A%3E%20%0A%3E%20%0A%3E%20--%20System%20Information%3A%0A%3E%20Debian%20Release%3A%208.2%0A%3E%20%20%20APT%20prefers%20stable-updates%0A%3E%20%20%20APT%20policy%3A%20%28500%2C%20%27stable-updates%27%29%2C%20%28500%2C%20%27stable%27%29%0A%3E%20Architecture%3A%20amd64%20%28x86_64%29%0A%3E%20%0A%3E%20Kernel%3A%20Linux%203.16.0-4-amd64%20%28SMP%20w%2F4%20CPU%20cores%29%0A%3E%20Locale%3A%20LANG%3Den_US.UTF-8%2C%20LC_CTYPE%3Den_US.UTF-8%20%28charmap%3DUTF-8%29%20%28ignored%3A%20LC_ALL%20set%20to%20en_US.UTF8%29%0A%3E%20Shell%3A%20%2Fbin%2Fsh%20linked%20to%20%2Fbin%2Fdash%0A%3E%20Init%3A%20systemd%20%28via%20%2Frun%2Fsystemd%2Fsystem%29%0A%3E%20%0A%3E%20Versions%20of%20packages%20stalin%20depends%20on%3A%0A%3E%20ii%20%20dpkg-dev%20%20%201.17.26%0A%3E%20ii%20%20libc6%20%20%20%20%20%202.19-18%2Bdeb8u1%0A%3E%20ii%20%20libgc-dev%20%201%3A7.2d-6.4%0A%3E%20%0A%3E%20stalin%20recommends%20no%20packages.%0A%3E%20%0A%3E%20stalin%20suggests%20no%20packages.%0A%3E%20%0A%3E%20--%20no%20debconf%20information%0A&amp;References=%3C20151222103854.GA6788%40steve.org.uk%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=steve%40steve.org.uk" alt="">
<div class="header"><span class="headerfield">From:</span> Steve Kemp &lt;steve@steve.org.uk&gt;</div>
<div class="header"><span class="headerfield">To:</span> submit@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> stalin: Insecure use of temporary files</div>
<div class="header"><span class="headerfield">Date:</span> Tue, 22 Dec 2015 10:38:54 +0000</div>
</div>
<pre class="message">
Package: stalin
Version: 0.11-5
Severity: critical
Tags: security


When `stalin` launches it attempts to detect its environment via
the following code in /usr/lib/stalin/QobiScheme.sc:

   
    (system &quot;uname -m &gt;/tmp/QobiScheme.tmp&quot;)
    ...
    (system &quot;rm -f /tmp/QobiScheme.tmp&quot;))

This is a prime example of the insecure use of temporary files,
and allows overwriting any file owned by the user who invokes
stalin.

Trivial demonstration:


    $ ln -s /home/steve/HACK /tmp/QobiScheme.tmp
    $ ls -l /home/steve/HACK
    ls: cannot access /home/steve/HACK: No such file or directory

Now run the sample code:

    
    $ cd /tmp/stalin-0.11/benchmarks
    $ ./make-hello

And we see this:

    $ ls -l /home/steve/HACK
    -rw-r--r-- 1 steve steve 6 Dec 22 08:30 /home/steve/HACK



-- System Information:
Debian Release: 8.2
  APT prefers stable-updates
  APT policy: (500, &#39;stable-updates&#39;), (500, &#39;stable&#39;)
Architecture: amd64 (x86_64)

Kernel: Linux 3.16.0-4-amd64 (SMP w/4 CPU cores)
Locale: LANG=en_US.UTF-8, LC_CTYPE=en_US.UTF-8 (charmap=UTF-8) (ignored: LC_ALL set to en_US.UTF8)
Shell: /bin/sh linked to /bin/dash
Init: systemd (via /run/systemd/system)

Versions of packages stalin depends on:
ii  dpkg-dev   1.17.26
ii  libc6      2.19-18+deb8u1
ii  libgc-dev  1:7.2d-6.4

stalin recommends no packages.

stalin suggests no packages.

-- no debconf information


Steve
-- 



</pre>

<div class="infmessage"><hr><p>
<a name="6"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org -->
<!-- time:1450809724 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org</code>:<br>
<code>Bug#808730</code>; Package <code>stalin</code>.
 (Tue, 22 Dec 2015 18:42:04 GMT) (<a href="bugreport.cgi?bug=808730;msg=7">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=7">mbox</a>, <a href="#6">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="8"></a>
<!-- request_addr: Rob Browning &lt;rlb@defaultvalue.org&gt; -->
<!-- time:1450809724 -->
<strong>Acknowledgement sent</strong>
to <code>Rob Browning &lt;rlb@defaultvalue.org&gt;</code>:<br>
Extra info received and forwarded to list.
 (Tue, 22 Dec 2015 18:42:04 GMT) (<a href="bugreport.cgi?bug=808730;msg=9">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=9">mbox</a>, <a href="#8">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="10"></a><a name="msg10"></a><a href="#10">Message #10</a> received at 808730@bugs.debian.org (<a href="bugreport.cgi?bug=808730;msg=10">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=10">mbox</a>, <a href="mailto:808730@bugs.debian.org?In-Reply-To=%3C87wps6fhvt.fsf%40trouble.defaultvalue.org%3E&amp;subject=Re%3A%20Bug%23808730%3A%20stalin%3A%20Insecure%20use%20of%20temporary%20files&amp;body=On%20Tue%2C%2022%20Dec%202015%2012%3A38%3A46%20-0600%20Rob%20Browning%20%3Crlb%40defaultvalue.org%3E%20wrote%3A%0A%3E%20Steve%20Kemp%20%3Csteve%40steve.org.uk%3E%20writes%3A%0A%3E%20%0A%3E%20%3E%20Package%3A%20stalin%0A%3E%20%3E%20Version%3A%200.11-5%0A%3E%20%3E%20Severity%3A%20critical%0A%3E%20%3E%20Tags%3A%20security%0A%3E%20%3E%0A%3E%20%3E%0A%3E%20%3E%20When%20%60stalin%60%20launches%20it%20attempts%20to%20detect%20its%20environment%20via%0A%3E%20%3E%20the%20following%20code%20in%20%2Fusr%2Flib%2Fstalin%2FQobiScheme.sc%3A%0A%3E%20%3E%0A%3E%20%3E%20%20%20%20%0A%3E%20%3E%20%20%20%20%20%28system%20%22uname%20-m%20%3E%2Ftmp%2FQobiScheme.tmp%22%29%0A%3E%20%3E%20%20%20%20%20...%0A%3E%20%3E%20%20%20%20%20%28system%20%22rm%20-f%20%2Ftmp%2FQobiScheme.tmp%22%29%29%0A%3E%20%0A%3E%20Thanks%20-%20working%20on%20an%20update.%0A%3E%20%0A%3E%20--%20%0A%3E%20Rob%20Browning%0A%3E%20rlb%20%40defaultvalue.org%20and%20%40debian.org%0A%3E%20GPG%20as%20of%202011-07-10%20E6A9%20DA3C%20C9FD%201FF8%20C676%20D2C4%20C0F0%2039E9%20ED1B%20597A%0A%3E%20GPG%20as%20of%202002-11-03%2014DD%20432F%20AE39%20534D%20B592%20F9A0%2025C8%20D377%208C7E%2073A4%0A%3E%20%0A%3E%20%0A&amp;References=%3C20151222103854.GA6788%40steve.org.uk%3E%0A%20%3C87wps6fhvt.fsf%40trouble.defaultvalue.org%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=rlb%40defaultvalue.org" alt="">
<div class="header"><span class="headerfield">From:</span> Rob Browning &lt;rlb@defaultvalue.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> Steve Kemp &lt;steve@steve.org.uk&gt;, 808730@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Re: Bug#808730: stalin: Insecure use of temporary files</div>
<div class="header"><span class="headerfield">Date:</span> Tue, 22 Dec 2015 12:38:46 -0600</div>
</div>
<pre class="message">Steve Kemp &lt;steve@steve.org.uk&gt; writes:

&gt; Package: stalin
&gt; Version: 0.11-5
&gt; Severity: critical
&gt; Tags: security
&gt;
&gt;
&gt; When `stalin` launches it attempts to detect its environment via
&gt; the following code in /usr/lib/stalin/QobiScheme.sc:
&gt;
&gt;    
&gt;     (system &quot;uname -m &gt;/tmp/QobiScheme.tmp&quot;)
&gt;     ...
&gt;     (system &quot;rm -f /tmp/QobiScheme.tmp&quot;))

Thanks - working on an update.

-- 
Rob Browning
rlb @defaultvalue.org and @debian.org
GPG as of 2011-07-10 E6A9 DA3C C9FD 1FF8 C676 D2C4 C0F0 39E9 ED1B 597A
GPG as of 2002-11-03 14DD 432F AE39 534D B592 F9A0 25C8 D377 8C7E 73A4


</pre>

<div class="infmessage"><hr><p>
<a name="11"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org -->
<!-- time:1450903330 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org</code>:<br>
<code>Bug#808730</code>; Package <code>stalin</code>.
 (Wed, 23 Dec 2015 20:42:10 GMT) (<a href="bugreport.cgi?bug=808730;msg=12">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=12">mbox</a>, <a href="#11">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="13"></a>
<!-- request_addr: Rob Browning &lt;rlb@defaultvalue.org&gt; -->
<!-- time:1450903330 -->
<strong>Acknowledgement sent</strong>
to <code>Rob Browning &lt;rlb@defaultvalue.org&gt;</code>:<br>
Extra info received and forwarded to list.
 (Wed, 23 Dec 2015 20:42:10 GMT) (<a href="bugreport.cgi?bug=808730;msg=14">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=14">mbox</a>, <a href="#13">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="15"></a><a name="msg15"></a><a href="#15">Message #15</a> received at 808730@bugs.debian.org (<a href="bugreport.cgi?bug=808730;msg=15">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=15">mbox</a>, <a href="mailto:808730@bugs.debian.org?References=%3C20151222103854.GA6788%40steve.org.uk%3E%0A%20%3C87k2o4gbbc.fsf%40trouble.defaultvalue.org%3E&amp;body=On%20Wed%2C%2023%20Dec%202015%2014%3A27%3A35%20-0600%20Rob%20Browning%20%3Crlb%40defaultvalue.org%3E%20wrote%3A%0A%3E%20Steve%20Kemp%20%3Csteve%40steve.org.uk%3E%20writes%3A%0A%3E%20%0A%3E%20%3E%20Package%3A%20stalin%0A%3E%20%3E%20Version%3A%200.11-5%0A%3E%20%3E%20Severity%3A%20critical%0A%3E%20%3E%20Tags%3A%20security%0A%3E%20%3E%0A%3E%20%3E%0A%3E%20%3E%20When%20%60stalin%60%20launches%20it%20attempts%20to%20detect%20its%20environment%20via%0A%3E%20%3E%20the%20following%20code%20in%20%2Fusr%2Flib%2Fstalin%2FQobiScheme.sc%3A%0A%3E%20%3E%0A%3E%20%3E%20%20%20%20%0A%3E%20%3E%20%20%20%20%20%28system%20%22uname%20-m%20%3E%2Ftmp%2FQobiScheme.tmp%22%29%0A%3E%20%3E%20%20%20%20%20...%0A%3E%20%3E%20%20%20%20%20%28system%20%22rm%20-f%20%2Ftmp%2FQobiScheme.tmp%22%29%29%0A%3E%20%0A%3E%20I%20have%20a%20possible%20fix%20for%20this%2C%20which%20should%20affect%20all%20versions%20in%0A%3E%20Debian%20%280.11-6%20in%20stretch%2Fsid%2C%200.11-5%20in%20wheezy%2Fjessie%29%2C%20and%20I%20think%20I%0A%3E%20will%20be%20able%20to%20generate%20patches%20%28and%2For%20packages%29%20if%20it%20seems%0A%3E%20acceptable.%0A%3E%20%0A%3E%20The%20current%20fix%20requires%20two%20primary%20changes%2C%20one%20is%20to%20stop%20overriding%0A%3E%20the%20gcc%20optimization%20level%20on%20amd64%20%28to%20revert%20to%20the%20default%20-O2%2C%0A%3E%20instead%20of%20-O0%29.%20%20Otherwise%20gcc%20will%20segfault%20%28tested%20against%205.3.1-3%2C%0A%3E%204.9.3-10%2C%20and%204.6.4-7%29%2C%20and%20we%20won%27t%20be%20able%20to%20build%20the%20package.%0A%3E%20%0A%3E%20The%20second%20requires%20changes%20to%20the%20Scheme%20compiler%20itself%20to%20add%20support%0A%3E%20for%20a%20few%20new%20functions%20%28debian-popen-in%2C%20debian-popen-out%2C%20etc.%29%2C%20and%0A%3E%20to%20then%20use%20them%20in%20stalin.sc%20and%20QobiScheme.sc%20to%3A%0A%3E%20%0A%3E%20%20%20-%20rework%20the%20%28tmp%20%22foo%22%29%20function%20to%20use%20mktemp%0A%3E%20%0A%3E%20%20%20-%20replace%20all%20uses%20of%20fixed%20%2Ftmp%2F%20paths%20with%20use%20of%20mktemp%2C%20either%20via%0A%3E%20%20%20%20%20the%20updated%20%28tmp%20%22foo%22%29%2C%20or%20via%20a%20%22mktemp%20-d%20...%22%20%20temporary%0A%3E%20%20%20%20%20directory.%0A%3E%20%0A%3E%20Potential%20concerns%3A%0A%3E%20%0A%3E%20%20%20-%20This%20introduces%20new%20bindings%2C%20though%20I%20suspect%20the%0A%3E%20%20%20%20%20%22debian-%22%20prefixes%20mitigate%20the%20likelihood%20of%20collisions%20with%0A%3E%20%20%20%20%20any%20existing%20use.%0A%3E%20%0A%3E%20%20%20-%20The%20new%20code%20may%20not%20be%20heavily%20tested%20%28though%20I%20suspect%20should%20be%0A%3E%20%20%20%20%20safer%20than%20what%20we%20have%20now%29.%20%20For%20example%2C%20some%20of%20the%20changes%0A%3E%20%20%20%20%20involve%20functions%20that%20call%20mpeg_play%2C%20which%20doesn%27t%20appear%20to%20be%20in%0A%3E%20%20%20%20%20Debian%20%28anymore%29.%0A%3E%20%0A%3E%20%20%20-%20This%20will%20require%20rebuilding%20the%20pregenerated%5B1%5D%20C%20versions%20of%20the%0A%3E%20%20%20%20%20compiler%20%2820MB%20each%2C%20one%20per%20arch%29.%20%20In%20the%20newer%20release%2C%20they%27re%0A%3E%20%20%20%20%20in%20debian%2Fprebuilt-src%2F.%20%20In%20the%20older%2C%20they%20were%20at%20the%20top%20level.%0A%3E%20%20%20%20%20This%20will%20result%20in%20a%20%2Avery%2A%20large%20diff%20against%20the%20previous%0A%3E%20%20%20%20%20versions.%0A%3E%20%0A%3E%20%5B1%5D%20NB%3A%20the%20reason%20we%20have%20the%20pregenerated%20files%20is%20because%20creating%0A%3E%20%20%20%20%20them%20requires%20~2GB%20RAM%20and%20about%20an%20hour%20each%20on%20a%20fairly%20recent%20amd64%0A%3E%20%20%20%20%20machine.%20%20Though%20I%27d%20be%20happy%20to%20dispense%20with%20them%20if%2Fwhen%20we%20think%0A%3E%20%20%20%20%20it%27s%20reasonable.%0A%3E%20%0A%3E%20In%20any%20case%2C%20I%20wanted%20to%20contact%20the%20security%20team%20now%2C%20to%20get%20an%20idea%0A%3E%20of%20how%20you%20might%20want%20to%20proceed%2C%20before%20I%20spend%20more%20time%20on%20the%20code.%0A&amp;subject=Re%3A%20Bug%23808730%3A%20stalin%3A%20Insecure%20use%20of%20temporary%20files&amp;In-Reply-To=%3C87k2o4gbbc.fsf%40trouble.defaultvalue.org%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=rlb%40defaultvalue.org" alt="">
<div class="header"><span class="headerfield">From:</span> Rob Browning &lt;rlb@defaultvalue.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> team@security.debian.org, Steve Kemp &lt;steve@steve.org.uk&gt;, 808730@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Re: Bug#808730: stalin: Insecure use of temporary files</div>
<div class="header"><span class="headerfield">Date:</span> Wed, 23 Dec 2015 14:27:35 -0600</div>
</div>
<pre class="message">Steve Kemp &lt;steve@steve.org.uk&gt; writes:

&gt; Package: stalin
&gt; Version: 0.11-5
&gt; Severity: critical
&gt; Tags: security
&gt;
&gt;
&gt; When `stalin` launches it attempts to detect its environment via
&gt; the following code in /usr/lib/stalin/QobiScheme.sc:
&gt;
&gt;    
&gt;     (system &quot;uname -m &gt;/tmp/QobiScheme.tmp&quot;)
&gt;     ...
&gt;     (system &quot;rm -f /tmp/QobiScheme.tmp&quot;))

I have a possible fix for this, which should affect all versions in
Debian (0.11-6 in stretch/sid, 0.11-5 in wheezy/jessie), and I think I
will be able to generate patches (and/or packages) if it seems
acceptable.

The current fix requires two primary changes, one is to stop overriding
the gcc optimization level on amd64 (to revert to the default -O2,
instead of -O0).  Otherwise gcc will segfault (tested against 5.3.1-3,
4.9.3-10, and 4.6.4-7), and we won&#39;t be able to build the package.

The second requires changes to the Scheme compiler itself to add support
for a few new functions (debian-popen-in, debian-popen-out, etc.), and
to then use them in stalin.sc and QobiScheme.sc to:

  - rework the (tmp &quot;foo&quot;) function to use mktemp

  - replace all uses of fixed /tmp/ paths with use of mktemp, either via
    the updated (tmp &quot;foo&quot;), or via a &quot;mktemp -d ...&quot;  temporary
    directory.

Potential concerns:

  - This introduces new bindings, though I suspect the
    &quot;debian-&quot; prefixes mitigate the likelihood of collisions with
    any existing use.

  - The new code may not be heavily tested (though I suspect should be
    safer than what we have now).  For example, some of the changes
    involve functions that call mpeg_play, which doesn&#39;t appear to be in
    Debian (anymore).

  - This will require rebuilding the pregenerated[1] C versions of the
    compiler (20MB each, one per arch).  In the newer release, they&#39;re
    in debian/prebuilt-src/.  In the older, they were at the top level.
    This will result in a *very* large diff against the previous
    versions.

[1] NB: the reason we have the pregenerated files is because creating
    them requires ~2GB RAM and about an hour each on a fairly recent amd64
    machine.  Though I&#39;d be happy to dispense with them if/when we think
    it&#39;s reasonable.

In any case, I wanted to contact the security team now, to get an idea
of how you might want to proceed, before I spend more time on the code.
I&#39;ve nearly finished hacking up a first pass, but it&#39;s not likely to be
quite ready yet.

Thanks
-- 
Rob Browning
rlb @defaultvalue.org and @debian.org
GPG as of 2011-07-10 E6A9 DA3C C9FD 1FF8 C676 D2C4 C0F0 39E9 ED1B 597A
GPG as of 2002-11-03 14DD 432F AE39 534D B592 F9A0 25C8 D377 8C7E 73A4


</pre>

<div class="infmessage"><hr><p>
<a name="16"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Rob Browning &lt;rlb@defaultvalue.org&gt; -->
<!-- time:1451207883 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Rob Browning &lt;rlb@defaultvalue.org&gt;</code>:<br>
<code>Bug#808730</code>; Package <code>stalin</code>.
 (Sun, 27 Dec 2015 09:18:03 GMT) (<a href="bugreport.cgi?bug=808730;msg=17">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=17">mbox</a>, <a href="#16">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="18"></a>
<!-- request_addr: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- time:1451207884 -->
<strong>Acknowledgement sent</strong>
to <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>:<br>
Extra info received and forwarded to list.  Copy sent to <code>Rob Browning &lt;rlb@defaultvalue.org&gt;</code>.
 (Sun, 27 Dec 2015 09:18:04 GMT) (<a href="bugreport.cgi?bug=808730;msg=19">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=19">mbox</a>, <a href="#18">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="20"></a><a name="msg20"></a><a href="#20">Message #20</a> received at 808730@bugs.debian.org (<a href="bugreport.cgi?bug=808730;msg=20">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=20">mbox</a>, <a href="mailto:808730@bugs.debian.org?body=On%20Sun%2C%2027%20Dec%202015%2010%3A15%3A47%20%2B0100%20Salvatore%20Bonaccorso%20%3Ccarnil%40debian.org%3E%20wrote%3A%0A%3E%20Hi%20Steve%2C%0A%3E%20%0A%3E%20On%20Tue%2C%20Dec%2022%2C%202015%20at%2010%3A38%3A54AM%20%2B0000%2C%20Steve%20Kemp%20wrote%3A%0A%3E%20%3E%20%0A%3E%20%3E%20Package%3A%20stalin%0A%3E%20%3E%20Version%3A%200.11-5%0A%3E%20%3E%20Severity%3A%20critical%0A%3E%20%3E%20Tags%3A%20security%0A%3E%20%3E%20%0A%3E%20%3E%20%0A%3E%20%3E%20When%20%60stalin%60%20launches%20it%20attempts%20to%20detect%20its%20environment%20via%0A%3E%20%3E%20the%20following%20code%20in%20%2Fusr%2Flib%2Fstalin%2FQobiScheme.sc%3A%0A%3E%20%3E%20%0A%3E%20%3E%20%20%20%20%0A%3E%20%3E%20%20%20%20%20%28system%20%22uname%20-m%20%3E%2Ftmp%2FQobiScheme.tmp%22%29%0A%3E%20%3E%20%20%20%20%20...%0A%3E%20%3E%20%20%20%20%20%28system%20%22rm%20-f%20%2Ftmp%2FQobiScheme.tmp%22%29%29%0A%3E%20%3E%20%0A%3E%20%3E%20This%20is%20a%20prime%20example%20of%20the%20insecure%20use%20of%20temporary%20files%2C%0A%3E%20%3E%20and%20allows%20overwriting%20any%20file%20owned%20by%20the%20user%20who%20invokes%0A%3E%20%3E%20stalin.%0A%3E%20%3E%20%0A%3E%20%3E%20Trivial%20demonstration%3A%0A%3E%20%3E%20%0A%3E%20%3E%20%0A%3E%20%3E%20%20%20%20%20%24%20ln%20-s%20%2Fhome%2Fsteve%2FHACK%20%2Ftmp%2FQobiScheme.tmp%0A%3E%20%3E%20%20%20%20%20%24%20ls%20-l%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%3E%20%20%20%20%20ls%3A%20cannot%20access%20%2Fhome%2Fsteve%2FHACK%3A%20No%20such%20file%20or%20directory%0A%3E%20%3E%20%0A%3E%20%3E%20Now%20run%20the%20sample%20code%3A%0A%3E%20%3E%20%0A%3E%20%3E%20%20%20%20%20%0A%3E%20%3E%20%20%20%20%20%24%20cd%20%2Ftmp%2Fstalin-0.11%2Fbenchmarks%0A%3E%20%3E%20%20%20%20%20%24%20.%2Fmake-hello%0A%3E%20%3E%20%0A%3E%20%3E%20And%20we%20see%20this%3A%0A%3E%20%3E%20%0A%3E%20%3E%20%20%20%20%20%24%20ls%20-l%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%3E%20%20%20%20%20-rw-r--r--%201%20steve%20steve%206%20Dec%2022%2008%3A30%20%2Fhome%2Fsteve%2FHACK%0A%3E%20%0A%3E%20I%20have%20requested%20a%20CVE%20here%0A%3E%20http%3A%2F%2Fwww.openwall.com%2Flists%2Foss-security%2F2015%2F12%2F27%2F1%0A%3E%20%0A%3E%20I%20think%20the%20severity%20though%20can%20be%20downgraded%20%28unless%20I%20miss%0A%3E%20something%29%2C%20since%20on%20Default%20Debian%20GNU%2FLinux%20installations%20Linux%20has%0A%3E%20fs.protected_symlinks%3D1%20which%20mitigates%20the%20attack%20vector.%0A%3E%20%0A%3E%20Regards%2C%0A%3E%20Salvatore%0A%3E%20%0A%3E%20%0A&amp;In-Reply-To=%3C20151227091547.GA4286%40eldamar.local%3E&amp;subject=Re%3A%20Bug%23808730%3A%20stalin%3A%20Insecure%20use%20of%20temporary%20files&amp;References=%3C20151222103854.GA6788%40steve.org.uk%3E%0A%20%3C20151227091547.GA4286%40eldamar.local%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=carnil%40debian.org" alt="">
<div class="header"><span class="headerfield">From:</span> Salvatore Bonaccorso &lt;carnil@debian.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> Steve Kemp &lt;steve@steve.org.uk&gt;, 808730@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Re: Bug#808730: stalin: Insecure use of temporary files</div>
<div class="header"><span class="headerfield">Date:</span> Sun, 27 Dec 2015 10:15:47 +0100</div>
</div>
<pre class="message">Hi Steve,

On Tue, Dec 22, 2015 at 10:38:54AM +0000, Steve Kemp wrote:
&gt; 
&gt; Package: stalin
&gt; Version: 0.11-5
&gt; Severity: critical
&gt; Tags: security
&gt; 
&gt; 
&gt; When `stalin` launches it attempts to detect its environment via
&gt; the following code in /usr/lib/stalin/QobiScheme.sc:
&gt; 
&gt;    
&gt;     (system &quot;uname -m &gt;/tmp/QobiScheme.tmp&quot;)
&gt;     ...
&gt;     (system &quot;rm -f /tmp/QobiScheme.tmp&quot;))
&gt; 
&gt; This is a prime example of the insecure use of temporary files,
&gt; and allows overwriting any file owned by the user who invokes
&gt; stalin.
&gt; 
&gt; Trivial demonstration:
&gt; 
&gt; 
&gt;     $ ln -s /home/steve/HACK /tmp/QobiScheme.tmp
&gt;     $ ls -l /home/steve/HACK
&gt;     ls: cannot access /home/steve/HACK: No such file or directory
&gt; 
&gt; Now run the sample code:
&gt; 
&gt;     
&gt;     $ cd /tmp/stalin-0.11/benchmarks
&gt;     $ ./make-hello
&gt; 
&gt; And we see this:
&gt; 
&gt;     $ ls -l /home/steve/HACK
&gt;     -rw-r--r-- 1 steve steve 6 Dec 22 08:30 /home/steve/HACK

I have requested a CVE here
<a href="http://www.openwall.com/lists/oss-security/2015/12/27/1">http://www.openwall.com/lists/oss-security/2015/12/27/1</a>

I think the severity though can be downgraded (unless I miss
something), since on Default Debian GNU/Linux installations Linux has
fs.protected_symlinks=1 which mitigates the attack vector.

Regards,
Salvatore


</pre>

<div class="msgreceived"><hr><p>
<a name="21"></a>
<!-- command:title -->
<!-- requester: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- request_addr: control@bugs.debian.org -->
<!-- time:1451235428 -->
<!-- new_data:
$new_data = {
              &#39;subject&#39; =&gt; &#39;stalin: CVE-2015-8697: Insecure use of temporary files&#39;
            };
-->
<!-- old_data:
$old_data = {
              &#39;subject&#39; =&gt; &#39;stalin: Insecure use of temporary files&#39;
            };
-->
<strong>Changed Bug title to &#39;stalin: CVE-2015-8697: Insecure use of temporary files&#39; from &#39;stalin: Insecure use of temporary files&#39;</strong>
Request was from <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>
to <code>control@bugs.debian.org</code>.
 (Sun, 27 Dec 2015 16:57:08 GMT) (<a href="bugreport.cgi?bug=808730;msg=22">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=22">mbox</a>, <a href="#21">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="23"></a>
<!-- requester: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- request_addr: control@bugs.debian.org -->
<!-- time:1453354388 -->
<strong>Severity set to &#39;important&#39; from &#39;critical&#39;</strong>
Request was from <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>
to <code>control@bugs.debian.org</code>.
 (Thu, 21 Jan 2016 05:33:08 GMT) (<a href="bugreport.cgi?bug=808730;msg=24">full text</a>, <a href="bugreport.cgi?bug=808730;mbox=yes;msg=24">mbox</a>, <a href="#23">link</a>).</p></p></div>

<hr>
<p class="msgreceived">Send a report that <a href="https://bugs.debian.org/cgi-bin/bugspam.cgi?bug=808730">this bug log contains spam</a>.</p>
<hr>
<ADDRESS>Debian bug tracking system administrator &lt;<A HREF="mailto:owner@bugs.debian.org">owner@bugs.debian.org</A>&gt;.
Last modified:
<!--timestamp-->Sat Oct 30 18:32:08 2021<!--end timestamp-->; 
Machine Name:
<!--machinename-->buxtehude<!--machinename-->
<P>
<A HREF="https://www.debian.org/Bugs/">Debian Bug tracking system</A>
</p>
<p>
  Debbugs is free software and licensed under the terms of the GNU
  Public License version 2. The current version can be obtained
  from <a href="https://bugs.debian.org/debbugs-source/">https://bugs.debian.org/debbugs-source/</a>.
</p>
<p>
Copyright © 1999 Darren O. Benham,
1997,2003 nCipher Corporation Ltd,
1994-97 Ian Jackson,
2005-2017 Don Armstrong, and many other contributors.
</p>
</ADDRESS>

</body>
</html>
