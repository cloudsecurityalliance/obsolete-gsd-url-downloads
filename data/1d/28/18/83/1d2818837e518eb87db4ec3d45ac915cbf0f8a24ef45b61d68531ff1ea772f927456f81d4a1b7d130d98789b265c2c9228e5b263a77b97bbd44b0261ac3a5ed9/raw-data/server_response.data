<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>77c955200ddd1761d6ed7a6c1578349fedbb55e4 - platform/external/skia - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/external/skia/%2B/77c955200ddd1761d6ed7a6c1578349fedbb55e4">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/external/">external</a> / <a class="Breadcrumbs-crumb" href="/platform/external/skia/">skia</a> / <span class="Breadcrumbs-crumb">77c955200ddd1761d6ed7a6c1578349fedbb55e4</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>77c955200ddd1761d6ed7a6c1578349fedbb55e4</td><td><span>[<a href="/platform/external/skia/+log/77c955200ddd1761d6ed7a6c1578349fedbb55e4">log</a>]</span> <span>[<a href="/platform/external/skia/+archive/77c955200ddd1761d6ed7a6c1578349fedbb55e4.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Mike Reed &lt;reed@google.com&gt;</td><td>Fri Jan 05 11:20:10 2018 -0500</td></tr><tr><th class="Metadata-title">committer</th><td>android-build-team Robot &lt;android-build-team-robot@google.com&gt;</td><td>Thu Aug 16 01:23:07 2018 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/">208f41733764440fd0f00b213bfb4c99744b3573</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E">5d1778b530aa0b845b8d6996815665f7cc44bf38</a> <span>[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">RESTRICT AUTOMERGE: Cherry-pick &quot;begin cleanup of malloc porting layer&quot;

Bug: 78354855
Test: Not feasible

Original description:
========================================================================
1. Merge some of the allocators into sk_malloc_flags by redefining a flag to mean zero-init
2. Add more private helpers to simplify our call-sites (and handle some overflow mul checks)
3. The 2-param helpers rely on the saturating SkSafeMath::Mul to pass max_size_t as the request,
which should always fail.

chromium: 508641
Reviewed-on: <a href="https://skia-review.googlesource.com/90940">https://skia-review.googlesource.com/90940</a>
Commit-Queue: Mike Reed &lt;reed@google.com&gt;
Reviewed-by: Robert Phillips &lt;robertphillips@google.com&gt;
Reviewed-by: Stephan Altmueller &lt;stephana@google.com&gt;
========================================================================

Conflicts:
- include/private/SkMalloc.h
Simply removed the old definitions of SK_MALLOC_TEMP and SK_MALLOC_THROW.
- public.bzl
Copied SK_SUPPORT_LEGACY_MALLOC_PORTING_LAYER into the old defines.
- src/codec/SkIcoCodec.cpp
Drop a change where we were not using malloc yet.
- src/codec/SkBmpBaseCodec.cpp
- src/core/SkBitmapCache.cpp
These files weren&#39;t yet using malloc (and SkBmpBaseCodec hadn&#39;t been
factored out).
- src/core/SkMallocPixelRef.cpp
These were still using New rather than Make (return raw pointer). Leave
them unchanged, as sk_malloc_flags is still valid.
- src/lazy/SkDiscardableMemoryPool.cpp
Leave this unchanged; sk_malloc_flags is still valid

In addition, pull in SkSafeMath.h, which was originally introduced in
<a href="https://skia-review.googlesource.com/c/skia/+/33721.">https://skia-review.googlesource.com/c/skia/+/33721.</a> This is required
for the new sk_malloc calls.

Also pull in SkSafeMath::Add and SkSafeMath::Mul, introduced in
<a href="https://skia-review.googlesource.com/88581">https://skia-review.googlesource.com/88581</a>

Also add SK_MaxSizeT, which the above depends on, introduced in
<a href="https://skia-review.googlesource.com/57084">https://skia-review.googlesource.com/57084</a>

Also, modify NewFromStream to use sk_malloc_canfail, matching pi and
avoiding a build break

Change-Id: <a href="https://android-review.googlesource.com/#/q/Ib320484673a865460fc1efb900f611209e088edb">Ib320484673a865460fc1efb900f611209e088edb</a>
(cherry picked from commit a12cc3e14ea6734c7efe76aa6a19239909830b28)
</pre><ul class="DiffTree"><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/include/core/SkTypes.h">include/core/SkTypes.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F0">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/include/private/SkMalloc.h">include/private/SkMalloc.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F1">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/include/private/SkTArray.h">include/private/SkTArray.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F2">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/include/private/SkTemplates.h">include/private/SkTemplates.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F3">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/public.bzl">public.bzl</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F4">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/codec/SkIcoCodec.cpp">src/codec/SkIcoCodec.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F5">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkAutoMalloc.h">src/core/SkAutoMalloc.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F6">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkAutoPixmapStorage.cpp">src/core/SkAutoPixmapStorage.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F7">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkMallocPixelRef.cpp">src/core/SkMallocPixelRef.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F8">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkMath.cpp">src/core/SkMath.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F9">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkRegion_path.cpp">src/core/SkRegion_path.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F10">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/core/SkSafeMath.h">src/core/SkSafeMath.h</a><span class="DiffTree-action DiffTree-action--add">[Added - <a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F11">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/gpu/GrBuffer.cpp">src/gpu/GrBuffer.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F12">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/ports/SkMemory_malloc.cpp">src/ports/SkMemory_malloc.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F13">diff</a>]</span></li><li><a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/ports/SkMemory_mozalloc.cpp">src/ports/SkMemory_mozalloc.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4%5E%21/#F14">diff</a>]</span></li></ul><div class="DiffSummary">15 files changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: 208f41733764440fd0f00b213bfb4c99744b3573</div><ol class="FileList"><li class="FileList-item FileList-item--regularFile" title="Regular file - .clang-format"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/.clang-format">.clang-format</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitignore"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/.gitignore">.gitignore</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gn"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/.gn">.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - AUTHORS"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/AUTHORS">AUTHORS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.bp"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/Android.bp">Android.bp</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - BUILD.gn"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/BUILD.gn">BUILD.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CONTRIBUTING"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/CONTRIBUTING">CONTRIBUTING</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CQ_COMMITTERS"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/CQ_COMMITTERS">CQ_COMMITTERS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CleanSpec.mk"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/CleanSpec.mk">CleanSpec.mk</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - DATA/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/DATA/">DATA/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - DEPS"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/DEPS">DEPS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Doxyfile"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/Doxyfile">Doxyfile</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - LICENSE"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/LICENSE">LICENSE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - MODULE_LICENSE_BSD"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/MODULE_LICENSE_BSD">MODULE_LICENSE_BSD</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - NOTICE"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/NOTICE">NOTICE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - PRESUBMIT.py"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/PRESUBMIT.py">PRESUBMIT.py</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/README">README</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README.android"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/README.android">README.android</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README.chromium"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/README.chromium">README.chromium</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - animations/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/animations/">animations/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - bench/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/bench/">bench/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - bin/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/bin/">bin/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - codereview.settings"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/codereview.settings">codereview.settings</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - debugger/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/debugger/">debugger/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - dm/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/dm/">dm/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - example/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/example/">example/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - experimental/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/experimental/">experimental/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - fuzz/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/fuzz/">fuzz/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - gm/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/gm/">gm/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - gn/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/gn/">gn/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - include/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/include/">include/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - infra/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/infra/">infra/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - platform_tools/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/platform_tools/">platform_tools/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - public.bzl"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/public.bzl">public.bzl</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - resources/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/resources/">resources/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - samplecode/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/samplecode/">samplecode/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - site/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/site/">site/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - src/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/src/">src/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tests/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/tests/">tests/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - third_party/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/third_party/">third_party/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tools/"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/tools/">tools/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - whitespace.txt"><a class="FileList-itemLink" href="/platform/external/skia/+/77c955200ddd1761d6ed7a6c1578349fedbb55e4/whitespace.txt">whitespace.txt</a></li></ol></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>