<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #73342 - RDF' href='rss/bug.php?id=73342'>
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #73342 - RSS 2.0' href='rss/bug.php?id=73342&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #73342 :: Vulnerability in php-fpm by changing stdin to non-blocking</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=73342">Sec Bug</a>&nbsp;#73342</th>
            <td id="summary" colspan="5">Vulnerability in php-fpm by changing stdin to non-blocking</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-10-18 20:02 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-07-18 13:06 UTC</td>
            <td rowspan="6">

                <table id="votes">
                    <tr><th class="details">Votes:</th><td>23</td></tr>
                    <tr><th class="details">Avg. Score:</th><td>4.7 &plusmn; 0.6</td></tr>
                    <tr><th class="details">Reproduced:</th><td>22 of 22 (100.0%)</td></tr>
                    <tr><th class="details">Same Version:</th><td>8 (36.4%)</td></tr>
                    <tr><th class="details">Same OS:</th><td>6 (27.3%)</td></tr>
                </table>

            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>xuavis &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=bukka">bukka</a> (<a href="https://people.php.net/bukka">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=FPM+related">FPM related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.0Git-2016-10-18 (Git)</td>
            <th class="details">OS:</th>
            <td>Ubuntu 16.04</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=73342&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=73342&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=73342&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1476820968">&nbsp;</a><strong>[2016-10-18 20:02 UTC] xuavis &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Tested on php 5.6 and 7.0 on both Ubuntu and FreeBSD.

When changing STDIN to non-blocking (see test script), php-fpm child processes start crashing.

This causes rapid restarting of child processes with high cpu load. This can be exploited for denial of service. Also scripts start getting cut off during execution.

Sometimes the master php-fpm process also stops responding to a restart/stop and requires a SIGKILL to stop.

Test script:
---------------
&lt;?php

stream_set_blocking(fopen('php://stdin', 'r'), false);

Expected result:
----------------
strace of child:

write(3, &quot;\1\6\0\1\0S\5\0X-Powered-By: PHP/5.6.27&quot;..., 112) = 112
shutdown(3, SHUT_WR)                    = 0
recvfrom(3, &quot;\1\5\0\1\0\0\0\0&quot;, 8, 0, NULL, NULL) = 8
recvfrom(3, &quot;&quot;, 8, 0, NULL, NULL)       = 0
close(3)                                = 0
setitimer(ITIMER_PROF, {it_interval={0, 0}, it_value={0, 0}}, NULL) = 0
accept(0, strace: Process 19005 detached

clean php-fpm log

Actual result:
--------------
strace of child:

write(3, &quot;\1\6\0\1\0S\5\0X-Powered-By: PHP/5.6.27&quot;..., 112) = 112
shutdown(3, SHUT_WR)                    = 0
recvfrom(3, &quot;\1\5\0\1\0\0\0\0&quot;, 8, 0, NULL, NULL) = 8
recvfrom(3, &quot;&quot;, 8, 0, NULL, NULL)       = 0
close(3)                                = 0
setitimer(ITIMER_PROF, {it_interval={0, 0}, it_value={0, 0}}, NULL) = 0
accept(0, 0x7ffeb7a996c0, 0x7ffeb7a996b0) = -1 EAGAIN (Resource temporarily unavailable)

php-fpm log:

[17-Oct-2016 23:28:49.808690] NOTICE: pid 748, fpm_children_bury(), line 252: [pool www] child 6300 exited with code 0 after 0.001693 seconds from start
[17-Oct-2016 23:28:49.808927] NOTICE: pid 748, fpm_children_make(), line 421: [pool www] child 6301 started
[17-Oct-2016 23:28:49.808946] DEBUG: pid 748, fpm_event_loop(), line 419: event module triggered 1 events
[17-Oct-2016 23:28:49.810581] DEBUG: pid 748, fpm_got_signal(), line 76: received SIGCHLD
[17-Oct-2016 23:28:49.810611] NOTICE: pid 748, fpm_children_bury(), line 252: [pool www] child 6301 exited with code 0 after 0.001690 seconds from start
[17-Oct-2016 23:28:49.810833] NOTICE: pid 748, fpm_children_make(), line 421: [pool www] child 6302 started
[17-Oct-2016 23:28:49.810852] DEBUG: pid 748, fpm_event_loop(), line 419: event module triggered 1 events
[17-Oct-2016 23:28:49.812501] DEBUG: pid 748, fpm_got_signal(), line 76: received SIGCHLD
[17-Oct-2016 23:28:49.812533] NOTICE: pid 748, fpm_children_bury(), line 252: [pool www] child 6302 exited with code 0 after 0.001706 seconds from start
[17-Oct-2016 23:28:49.812750] NOTICE: pid 748, fpm_children_make(), line 421: [pool www] child 6303 started
[17-Oct-2016 23:28:49.812771] DEBUG: pid 748, fpm_event_loop(), line 419: event module triggered 1 events
[17-Oct-2016 23:28:49.814332] DEBUG: pid 748, fpm_got_signal(), line 76: received SIGCHLD
[17-Oct-2016 23:28:49.814362] NOTICE: pid 748, fpm_children_bury(), line 252: [pool www] child 6303 exited with code 0 after 0.001618 seconds from start
[17-Oct-2016 23:28:49.814585] NOTICE: pid 748, fpm_children_make(), line 421: [pool www] child 6304 started

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=73342'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=73342'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1476821797">&nbsp;</a><strong>[2016-10-18 20:16 UTC] xuavis &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>The patch I think I added doesn't show for me. You can also find it at <a href="https://gist.github.com/anonymous/080bdb43fe9a0eb57609a93e9e4dd093" rel="nofollow">https://gist.github.com/anonymous/080bdb43fe9a0eb57609a93e9e4dd093</a>
</pre>
</div><div class='comment type_log' ><a name="1476855234">&nbsp;</a><strong>[2016-10-19 05:33 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: fat</span>
</div></div></div><div class='comment type_comment' ><a name="1476855235">&nbsp;</a><strong>[2016-10-19 05:33 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Not sure how it's security issue. If you can run code on this server, you have already crossed security border.
</pre>
</div><div class='comment type_comment' ><a name="1476855461">&nbsp;</a><strong>[2016-10-19 05:37 UTC] <a href="//people.php.net/krakjoe">krakjoe@php.net</a></strong>
<pre class='note'>Agree with stas, not a sec issue.
</pre>
</div><div class='comment type_comment' ><a name="1476862594">&nbsp;</a><strong>[2016-10-19 07:36 UTC] xuavis &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>The case I could think of (and the reason I did choose Security as type) was due to shared hosting providers; Running multiple users on the same server where a single user can, as far as I know, (almost) undetectable use this to cause high load leading to a Denial of Service which affects other users.
</pre>
</div><div class='comment type_log' ><a name="1476903834">&nbsp;</a><strong>[2016-10-19 19:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_log' ><a name="1477416312">&nbsp;</a><strong>[2016-10-25 17:25 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Assigned</span>
<span class="added">+Status:      Open</span>
<span class="removed">-Assigned To: fat</span>
<span class="added">+Assigned To:</span>
</div></div></div><div class='comment type_comment' ><a name="1477416312">&nbsp;</a><strong>[2016-10-25 17:25 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Unassigning from Jérôme, since his latest commit has been more
than 4 years ago. Hopefully, somebody else will tackle this issue
this way.
</pre>
</div><div class='comment type_comment' ><a name="1494925509">&nbsp;</a><strong>[2017-05-16 09:05 UTC] yago &#x64;&#111;&#x74; riveiro &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>This bug with Centos 7.0 and php 7 can be reproduced too
</pre>
</div><div class='comment type_comment' ><a name="1500225317">&nbsp;</a><strong>[2017-07-16 17:15 UTC] matt &#x61;&#116; datacodesolutions &#x64;&#111;&#x74; com</strong>
<pre class='note'>This bug is causing issues on our server (Centos 7 / WHM / PHP 70) as well - high load which in turn cause extremely slow performance.  We use shell_exec to generate PDFs and it seems like this is causing the PHP-FPM service to get stuck in an endless loop of trying to start and then exiting.

<a href="https://serverfault.com/questions/839135/nginx-php-fpm-child-exited-with-code-0" rel="nofollow">https://serverfault.com/questions/839135/nginx-php-fpm-child-exited-with-code-0</a>

[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62666 exited with code 0 after 0.103145 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62675 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62665 exited with code 0 after 0.108670 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62676 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62667 exited with code 0 after 0.111453 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62677 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62668 exited with code 0 after 0.112478 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62678 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62669 exited with code 0 after 0.098957 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62679 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62671 exited with code 0 after 0.094954 seconds from start
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62680 started
[16-Jul-2017 12:49:45] NOTICE: [pool mysite_com] child 62670 exited with code 0 after 0.101192 seconds from start
</pre>
</div><div class='comment type_related' ><a name="1519404863">&nbsp;</a><strong>[2018-02-23 16:54 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=75968'>Bug #75968</a>
</pre>
</div><div class='comment type_related' ><a name="1519404863">&nbsp;</a><strong>[2018-02-23 16:54 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=75968'>Bug #75968</a>
</pre>
</div><div class='comment type_related' ><a name="1519404915">&nbsp;</a><strong>[2018-02-23 16:55 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=70185'>Bug #70185</a>
</pre>
</div><div class='comment type_log' ><a name="1519405269">&nbsp;</a><strong>[2018-02-23 17:01 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Verified</span>
</div></div></div><div class='comment type_log' ><a name="1519410373">&nbsp;</a><strong>[2018-02-23 18:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: bukka</span>
</div></div></div><div class='comment type_comment' ><a name="1519418500">&nbsp;</a><strong>[2018-02-23 20:41 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>I think the patch from the first comment only works around the problem ... the real question is this: Why does FPM care about STDIN at all?

After some looking around, this seems to be what happens:
 * wp-&gt;listening_socket is what we actually want to listen on.
 * fpm_globals.listening_socket is always 0 (effectively STDIN), because that's what the global is initialized to. It's never changed.
 * fpm_run() always returns fpm_globals.listening_socket and that's what fcgi listens on.
 * to make things line up fpm_stdio_init_child() does a dup2(wp-&gt;listening_socket, STDIN_FILENO).

So effectively we take the listening socket, dup2 it to STDIN and then listen on STDIN. The following patch removes the indirection through STDIN:

diff --git a/sapi/fpm/fpm/fpm_children.c b/sapi/fpm/fpm/fpm_children.c
index b48fa54..4ee316b 100644
--- a/sapi/fpm/fpm/fpm_children.c
+++ b/sapi/fpm/fpm/fpm_children.c
@@ -146,6 +146,7 @@ static struct fpm_child_s *fpm_child_find(pid_t pid) /* {{{ */
 static void fpm_child_init(struct fpm_worker_pool_s *wp) /* {{{ */
 {
 	fpm_globals.max_requests = wp-&gt;config-&gt;pm_max_requests;
+	fpm_globals.listening_socket = dup(wp-&gt;listening_socket);
 
 	if (0 &gt; fpm_stdio_init_child(wp)  ||
 	    0 &gt; fpm_log_init_child(wp)    ||
diff --git a/sapi/fpm/fpm/fpm_stdio.c b/sapi/fpm/fpm/fpm_stdio.c
index 4072017..76e8b32 100644
--- a/sapi/fpm/fpm/fpm_stdio.c
+++ b/sapi/fpm/fpm/fpm_stdio.c
@@ -103,12 +103,6 @@ int fpm_stdio_init_child(struct fpm_worker_pool_s *wp) /* {{{ */
 	fpm_globals.error_log_fd = -1;
 	zlog_set_fd(-1);
 
-	if (wp-&gt;listening_socket != STDIN_FILENO) {
-		if (0 &gt; dup2(wp-&gt;listening_socket, STDIN_FILENO)) {
-			zlog(ZLOG_SYSERROR, &quot;failed to init child stdio: dup2()&quot;);
-			return -1;
-		}
-	}
 	return 0;
 }
 /* }}} */

This also resolves the issue for me. However, I don't know if this has any side-effects, because something else relies on the STDIN mapping.
</pre>
</div><div class='comment type_related' ><a name="1519418932">&nbsp;</a><strong>[2018-02-23 20:48 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=73056'>Bug #73056</a>
</pre>
</div><div class='comment type_related' ><a name="1519420252">&nbsp;</a><strong>[2018-02-23 21:10 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=67796'>Bug #67796</a>
</pre>
</div><div class='comment type_comment' ><a name="1519586460">&nbsp;</a><strong>[2018-02-25 19:21 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>@nikic I think that the reason why FPM cares about STDIN is to conform FastCGI spec - namely section 2.2 ( <a href="http://www.mit.edu/~yandros/doc/specs/fcgi-spec.html#S2.2" rel="nofollow">http://www.mit.edu/~yandros/doc/specs/fcgi-spec.html#S2.2</a> ) that states &quot;FCGI_LISTENSOCK_FILENO equals STDIN_FILENO&quot;.

I guess it's because maybe some FastCGI application could access the data directly from the record but not really sure why. I can't really see the reason for that in the PHP case. I don't see any side effects of the patch at the moment but it might need a bit more thinking and testing.
</pre>
</div><div class='comment type_comment' ><a name="1520414548">&nbsp;</a><strong>[2018-03-07 09:22 UTC] kenny &#x61;&#116; kennynet &#x64;&#111;&#x74; co &#x64;&#111;&#x74; uk</strong>
<pre class='note'>We've deployed the suggested patch removing the use of STDIN internally (currently in testing pending production deployment). I'll update this bug report if we see any problems caused by it.
</pre>
</div><div class='comment type_comment' ><a name="1524550205">&nbsp;</a><strong>[2018-04-24 06:10 UTC] gksalil &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hello

   Is the patch working and fix the issue ? Can I apply this patch safely ?

Thanks
~S
</pre>
</div><div class='comment type_comment' ><a name="1528720763">&nbsp;</a><strong>[2018-06-11 12:39 UTC] alex &#x61;&#116; sirensclef &#x64;&#111;&#x74; com</strong>
<pre class='note'>I'm under some pressure to put together a production PHP 7.2 + FPM setup, but then I ran head first into this bug. I don't know what's worse... that a critical subset of PHP functionality is incompatible with PHP-FPM, or that this has been known for so long and nothing has been done.

Is anyone aware of a workaround (other than this patch being evaluated)? I've got more of a mod_php background so I'm only just developing an understanding of the options here, but I've had no luck making adjustments to neutralize the issue. I've tested an option, for a dev server, that uses a cron to check the php-fpm log every minute and restart the service whenever the issue arises, but I can't put that into production. Worried this setup is simply a non-starter.
</pre>
</div><div class='comment type_comment' ><a name="1528722414">&nbsp;</a><strong>[2018-06-11 13:06 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>@bukka: What's the ETA on getting this merged? I saw that you submitted the PR for the fpm test revamp, so I assume that we'll start landing outstanding fpm patches soon?
</pre>
</div><div class='comment type_comment' ><a name="1528794225">&nbsp;</a><strong>[2018-06-12 09:03 UTC] kenny &#x61;&#116; kennynet &#x64;&#111;&#x74; co &#x64;&#111;&#x74; uk</strong>
<pre class='note'>We've seen no problems yet with the proposed patch in our internal infrastructure and we've applied it against both 7.0 and 7.2.
</pre>
</div><div class='comment type_comment' ><a name="1528818420">&nbsp;</a><strong>[2018-06-12 15:47 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>@nikic Yep that's sort of the plan. I want to finish the fpm logging changes and then will try to look on this one and other stuff. Can't really give you an ETA but hopefully it won't take too long. Will see. ;)
</pre>
</div><div class='comment type_comment' ><a name="1528821277">&nbsp;</a><strong>[2018-06-12 16:34 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>@bukka: Thanks for the update. That sounds like things might still take a while, in which case I will go ahead and merge this patch now. We can't afford to delay this issue by an indeterminate amount of time, and given the production testing by kenny at kennynet dot co dot uk, I believe we can be sufficiently confident in the correctness of the change.
</pre>
</div><div class='comment type_comment' ><a name="1528822298">&nbsp;</a><strong>[2018-06-12 16:51 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>@nikic Please can you create a PR first. I will try to look at it this week and if I don't find a time, go ahead but I think I should have time. Also a test should be present - that should be quite easy to do in the new tests...
</pre>
</div><div class='comment type_comment' ><a name="1528822501">&nbsp;</a><strong>[2018-06-12 16:55 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>Btw. I would a bit careful as we are breaking FastCGI &quot;spec&quot; (it's not really a spec though and it doesn't seem to be a useful part anywya) so maybe we should just target 7.2 first and then possibly back port it. WDT?
</pre>
</div><div class='comment type_comment' ><a name="1528824883">&nbsp;</a><strong>[2018-06-12 17:34 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>I just merged the test revamp. Think that the test for this could be similar to the one for fastcgi_finish_request - <a href="https://git.io/vhrAj" rel="nofollow">https://git.io/vhrAj</a> . Of course the PHP code will be different (as test script) and there should be probably two requests and possibly some other changes - not exactly sure atm. as I would have to try it but think you will get the idea ;)
</pre>
</div><div class='comment type_comment' ><a name="1528825540">&nbsp;</a><strong>[2018-06-12 17:45 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>@bukka: I can't remember writing it, but I have this test against the old infrastructure lying around: <a href="https://gist.github.com/nikic/5904446746a7f90f98e856e6dda592ee" rel="nofollow">https://gist.github.com/nikic/5904446746a7f90f98e856e6dda592ee</a> I'll port it and submit a PR.
</pre>
</div><div class='comment type_comment' ><a name="1528828932">&nbsp;</a><strong>[2018-06-12 18:42 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>@bukka: PR up at <a href="https://github.com/php/php-src/pull/3287." rel="nofollow">https://github.com/php/php-src/pull/3287.</a>
</pre>
</div><div class='comment type_comment' ><a name="1529490174">&nbsp;</a><strong>[2018-06-20 10:22 UTC] DEBANANDA &#x64;&#111;&#x74; PAL &#x61;&#116; GMAIL &#x64;&#111;&#x74; COM</strong>
<pre class='note'>Hi

Our current php5 version is 5.6.34.
Pls let me know, if we can apply the patch (described in below link) to php5 5.6.34 

<a href="https://bugs.php.net/bug.php?id=73342&amp;thanks=3" rel="nofollow">https://bugs.php.net/bug.php?id=73342&amp;thanks=3</a>

Thanks,
D Pal
</pre>
</div><div class='comment type_svn' ><a name="1529490819">&nbsp;</a><strong>[2018-06-20 10:33 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of nikita.ppv@gmail.com
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=69dee5c732fe982c82edb17d0dbc3e79a47748d8" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=69dee5c732fe982c82edb17d0dbc3e79a47748d8</a>
Log: Fixed <a href='bug.php?id=73342'>bug #73342</a>
</pre>
</div><div class='comment type_log' ><a name="1529490819">&nbsp;</a><strong>[2018-06-20 10:33 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Verified</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_log' ><a name="1529491028">&nbsp;</a><strong>[2018-06-20 10:37 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:         Closed</span>
<span class="added">+Status:         Re-Opened</span>
<span class="removed">-Type:           Bug</span>
<span class="added">+Type:           Security</span>
<span class="removed">-Private report: No</span>
<span class="added">+Private report: Yes</span>
</div></div></div><div class='comment type_comment' ><a name="1529491029">&nbsp;</a><strong>[2018-06-20 10:37 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Reopening with security classification to track backports to PHP 5.6 and PHP 7.0.
</pre>
</div><div class='comment type_comment' ><a name="1529493518">&nbsp;</a><strong>[2018-06-20 11:18 UTC] <a href="//people.php.net/bukka">bukka@php.net</a></strong>
<pre class='note'>I don't think this is a security issue. It can cause issue just for the same pool running under same user. Basically it can't leak any information from the different pool. That actually reminds me <a href="https://bugs.php.net/bug.php?id=76067&amp;edit=1" rel="nofollow">https://bugs.php.net/bug.php?id=76067&amp;edit=1</a> that had similar discussion and should be also changed to just a bug.
</pre>
</div><div class='comment type_comment' ><a name="1530868811">&nbsp;</a><strong>[2018-07-06 09:20 UTC] zoolyka &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>The issue still exists (7.2.7-1+ubuntu16.04.1+deb.sury.org+1), and its very annoying. As a workaround append &quot; &amp;&gt;/dev/null&quot; to the executed command.
</pre>
</div><div class='comment type_comment' ><a name="1530898828">&nbsp;</a><strong>[2018-07-06 17:40 UTC] zoolyka &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Sorry, that &quot;&amp;&gt;/dev/null&quot; did not worked out. Using the following method instead of exec, shell_exec, etc. prevents the crashing loop:

$command = 'command to execute...';
$pipes = array();
$process = proc_open(
  $command,
  array(
     0 =&gt; array('pipe', 'r'),
     1 =&gt; array('pipe', 'w'),
     2 =&gt; array('pipe', 'w'),
  ),
  $pipes
);

stream_set_blocking($pipes[1], true);
stream_set_blocking($pipes[2], true);

if (
  is_resource($process)
) {

  $output = stream_get_contents($pipes[1]);
  $error = stream_get_contents($pipes[2]);

  fclose($pipes[1]);
  fclose($pipes[2]);

  proc_close($process);

}
</pre>
</div><div class='comment type_comment' ><a name="1553538950">&nbsp;</a><strong>[2019-03-25 18:35 UTC] marc &#x61;&#116; palaueb &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi!
I've been struggling my head from last week, seriosly, about a behavior that makes no sense. We have some servers with debian7 and a script that sends &quot;kill -USR2 `cat pid_file`&quot; and reloads the php-fpm configurations gracefully.

Well, I'm being implementing the same configuration with debian9 (drived by systemD) and ... it don't works, I must do 'systemctl kill -s USR2 php-fpm.service', if not, it won't work.

And how I have arribed here?

Well, I have been compiling revisions of 7.1 and 7.2 since I have found the revisions that have a shared point, this bugfix.

Well, I don't know if I must open a new bug to solve the fix of this bug, because no one has commented it anyway on the Internet (3 full days of researching).

Maybe there is a command to configure systemD to accept the kill sent to the childrens (I have not try it yet).

Well, anyway, I just want to make you know that this bugfix generated a new one.

How to test it:

On a Debian 9 machine, configure the service into systemD, then open a new terminal and watch the behavior:

'watch -n.1 &quot;systemctl status php72.service&quot;'

Then send 'kill -USR2 PID_MASTER_PROCESS' and see, nothing happends (if you wait till process_control_timeout passes it hard kills all the childrens).
Now send: 'systemctl kill -s USR2 php72.service' and watch how it reloads childrens.

Ok, now try with php-fpm revisions 7.1.19 or 7.2.7. It works without problem.
</pre>
</div><div class='comment type_log' ><a name="1563455186">&nbsp;</a><strong>[2019-07-18 13:06 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Re-Opened</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1563455186">&nbsp;</a><strong>[2019-07-18 13:06 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>Closing this as the time for 5.6/7.0 backports has already long since passed, and this fix is in 7.1.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
