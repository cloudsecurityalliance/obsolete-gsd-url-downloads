<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='SPL related Bug #67538 - RDF' href='rss/bug.php?id=67538'>
        <link rel='alternate' type='application/rss+xml' title='SPL related Bug #67538 - RSS 2.0' href='rss/bug.php?id=67538&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #67538 :: SPL Iterators use-after-free</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=67538">Bug</a>&nbsp;#67538</th>
            <td id="summary" colspan="5">SPL Iterators use-after-free</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2014-06-29 14:54 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2014-07-03 02:49 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>research &#x61;&#116; insighti &#x64;&#111;&#x74; org</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=laruence">laruence</a> (<a href="https://people.php.net/laruence">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=SPL+related">SPL related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>Irrelevant</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-4670" target="_blank">2014-4670</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=67538&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=67538&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=67538&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1404053640">&nbsp;</a><strong>[2014-06-29 14:54 UTC] research &#x61;&#116; insighti &#x64;&#111;&#x74; org</strong>
<pre class='note'>Description:
------------
SPL provides a set of iterators to traverse over objects (including internal iterators).
Changes in the object are not projected to the object iterators.
This results in iterators pointing to freed memory.
Calling next on the iterator triggers use-after-free.

Please use CVE-2014-4670 for this bug.

Test script:
---------------
&lt;?php
$list = new SplDoublyLinkedList();
$list-&gt;push('a');
$list-&gt;push('b');

$list-&gt;rewind();
$list-&gt;offsetUnset(0);
$list-&gt;push('c');
$list-&gt;offsetUnset(0);
$list-&gt;next();

Actual result:
--------------
$ USE_ZEND_ALLOC=0 valgrind /opt/php/5.5.14/bin/php test.php
==14274== Memcheck, a memory error detector
==14274== Copyright (C) 2002-2011, and GNU GPL'd, by Julian Seward et al.
==14274== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==14274== Command: /opt/php/5.5.14/bin/php test.php
==14274==
==14274== Invalid read of size 4
==14274==    at 0x8367BCC: spl_dllist_it_helper_move_forward (spl_dllist.c:989)
==14274==    by 0x852E1B1: zend_do_fcall_common_helper_SPEC (zend_vm_execute.h:550)
==14274==    by 0x84F0935: execute_ex (zend_vm_execute.h:363)
==14274==    by 0x8488C71: zend_execute_scripts (zend.c:1316)
==14274==    by 0x842943A: php_execute_script (main.c:2506)
==14274==    by 0x8531447: do_cli (php_cli.c:994)
==14274==    by 0x808149B: main (php_cli.c:1378)
==14274==  Address 0x716b748 is 8 bytes inside a block of size 16 free'd
==14274==    at 0x402750C: free (vg_replace_malloc.c:427)
==14274==    by 0x83688FF: zim_spl_SplDoublyLinkedList_offsetUnset (spl_dllist.c:922)
==14274==    by 0x852E1B1: zend_do_fcall_common_helper_SPEC (zend_vm_execute.h:550)
==14274==    by 0x84F0935: execute_ex (zend_vm_execute.h:363)
==14274==    by 0x8488C71: zend_execute_scripts (zend.c:1316)
==14274==    by 0x842943A: php_execute_script (main.c:2506)
==14274==    by 0x8531447: do_cli (php_cli.c:994)
==14274==    by 0x808149B: main (php_cli.c:1378)

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=67538'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=67538'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1404069639">&nbsp;</a><strong>[2014-06-29 19:20 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_svn' ><a name="1404295139">&nbsp;</a><strong>[2014-07-02 09:58 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_log' ><a name="1404295139">&nbsp;</a><strong>[2014-07-02 09:58 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1404305130">&nbsp;</a><strong>[2014-07-02 12:45 UTC] research &#x61;&#116; insighti &#x64;&#111;&#x74; org</strong>
<pre class='note'>Please use CVE-2014-4670, the bug is in fact exploitable - not sure why was it made public before release of a patched version.

It's not remotely exploitable, however, shared environments relying on PHP security features (open_basedir, safe_mode in older PHPs, disable_functions and similar) are affected. We're ready to provide PoC is needed.
</pre>
</div><div class='comment type_log' ><a name="1404355731">&nbsp;</a><strong>[2014-07-03 02:48 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: laruence</span>
</div></div></div><div class='comment type_log' ><a name="1404355767">&nbsp;</a><strong>[2014-07-03 02:49 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2014-4670</span>
</div></div></div><div class='comment type_svn' ><a name="1404746525">&nbsp;</a><strong>[2014-07-07 15:22 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1405935073">&nbsp;</a><strong>[2014-07-21 09:31 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1405936960">&nbsp;</a><strong>[2014-07-21 10:02 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1406267958">&nbsp;</a><strong>[2014-07-25 05:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1406713943">&nbsp;</a><strong>[2014-07-30 09:52 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1406713962">&nbsp;</a><strong>[2014-07-30 09:52 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=df78c48354f376cf419d7a97f88ca07d572f00fb</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1407140806">&nbsp;</a><strong>[2014-08-04 08:26 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1407141789">&nbsp;</a><strong>[2014-08-04 08:43 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1407146393">&nbsp;</a><strong>[2014-08-04 09:59 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1412723626">&nbsp;</a><strong>[2014-10-07 23:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div><div class='comment type_svn' ><a name="1412724294">&nbsp;</a><strong>[2014-10-07 23:24 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of laruence
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=61e0f8599d4e2a222ec49781e5be90fbbc1cd65b</a>
Log: Fixed <a href='bug.php?id=67538'>Bug #67538</a> (SPL Iterators use-after-free)
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
