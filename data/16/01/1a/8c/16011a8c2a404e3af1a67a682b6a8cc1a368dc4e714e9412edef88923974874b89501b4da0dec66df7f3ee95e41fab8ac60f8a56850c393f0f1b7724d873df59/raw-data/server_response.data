<!DOCTYPE html>
<html lang='en'>
<head>
<title>exempi - Exempi 2.0. XMP metadata handling library based on Adobe XMP reference implementation.  (mirrored from https://gitlab.freedesktop.org/libopenraw/exempi)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/exempi/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/libopenraw/exempi' title='exempi Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='exempi' href='/exempi/'>exempi</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'/><select name='h' onchange='this.form.submit();'>
<option value='adobe-sdk'>adobe-sdk</option>
<option value='exempi-2.0-branch'>exempi-2.0-branch</option>
<option value='exempi-2.2-branch'>exempi-2.2-branch</option>
<option value='exempi-2.3-branch'>exempi-2.3-branch</option>
<option value='exempi-2.4-branch'>exempi-2.4-branch</option>
<option value='exempi-2.5-branch'>exempi-2.5-branch</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Exempi 2.0. XMP metadata handling library based on Adobe XMP reference implementation.  (mirrored from https://gitlab.freedesktop.org/libopenraw/exempi)</td><td class='sub right'>hub</td></tr></table>
<table class='tabs'><tr><td>
<a href='/exempi/'>summary</a><a href='/exempi/refs/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>refs</a><a href='/exempi/log/'>log</a><a href='/exempi/tree/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>tree</a><a class='active' href='/exempi/commit/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>commit</a><a href='/exempi/diff/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>diff</a></td><td class='form'><form class='right' method='get' action='/exempi/log/'>
<input type='hidden' name='id' value='c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Hubert Figuière &lt;hub@figuiere.net&gt;</td><td class='right'>2017-03-26 01:10:11 -0400</td></tr>
<tr><th>committer</th><td>Hubert Figuière &lt;hub@figuiere.net&gt;</td><td class='right'>2017-03-26 01:10:11 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/exempi/commit/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>c26d5beb60a5a85f76259f50ed3e08c8169b0a0c</a> (<a href='/exempi/patch/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/exempi/tree/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>cd28fed64fb68de415c8b4b9b0b604f46595f6b1</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/exempi/commit/?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>6f0104309b9daed4a51a07e593bcfdc529fdb5a4</a> (<a href='/exempi/diff/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c&amp;id2=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>diff</a>)</td></tr></table>
<div class='commit-subject'>Bug 100397 - Fix crash on malformed JPEG file</div><div class='commit-msg'>- Check the buffer doesn't overrun for the TIFF tag
- Fix a use-after-free in exception handling
- Fix two invalid memcpy() on overlapping memory
</div><div class='diffstat-header'><a href='/exempi/diff/?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/XMPFiles/source/FormatSupport/ReconcileTIFF.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/ReconcileTIFF.cpp</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 2.6%;'/><td class='rem' style='width: 2.6%;'/><td class='none' style='width: 94.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 17.9%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 74.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/XMPFiles/source/FormatSupport/TIFF_Support.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/TIFF_Support.hpp</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 17.9%;'/><td class='rem' style='width: 2.6%;'/><td class='none' style='width: 79.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/exempi/exempi.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>exempi/exempi.cpp</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 5.1%;'/><td class='rem' style='width: 10.3%;'/><td class='none' style='width: 84.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/public/include/XMP_Const.h?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>public/include/XMP_Const.h</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 56.4%;'/><td class='rem' style='width: 5.1%;'/><td class='none' style='width: 38.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/public/include/client-glue/WXMP_Common.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>public/include/client-glue/WXMP_Common.hpp</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 87.2%;'/><td class='rem' style='width: 12.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/exempi/diff/source/XMP_LibUtils.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>source/XMP_LibUtils.hpp</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 30.8%;'/><td class='rem' style='width: 30.8%;'/><td class='none' style='width: 38.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>7 files changed, 85 insertions, 28 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/XMPFiles/source/FormatSupport/ReconcileTIFF.cpp b/XMPFiles/source/FormatSupport/ReconcileTIFF.cpp<br/>index aa4aea6..7e89b0e 100644<br/>--- a/<a href='/exempi/tree/XMPFiles/source/FormatSupport/ReconcileTIFF.cpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>XMPFiles/source/FormatSupport/ReconcileTIFF.cpp</a><br/>+++ b/<a href='/exempi/tree/XMPFiles/source/FormatSupport/ReconcileTIFF.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/ReconcileTIFF.cpp</a></div><div class='hunk'>@@ -233,7 +233,7 @@ static XMP_Uns32 GatherInt ( const char * strPtr, size_t count )</div><div class='ctx'> </div><div class='ctx'> static size_t TrimTrailingSpaces ( char * firstChar, size_t origLen )</div><div class='ctx'> {</div><div class='del'>-	if ( origLen == 0 ) return 0;</div><div class='add'>+	if ( !firstChar || origLen == 0 ) return 0;</div><div class='ctx'> </div><div class='ctx'> 	char * lastChar  = firstChar + origLen - 1;</div><div class='ctx'> 	if ( (*lastChar != ' ') &amp;&amp; (*lastChar != 0) ) return origLen;	// Nothing to do.</div><div class='head'>diff --git a/XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp b/XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp<br/>index ea1b686..fcf9e43 100644<br/>--- a/<a href='/exempi/tree/XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp</a><br/>+++ b/<a href='/exempi/tree/XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/TIFF_MemoryReader.cpp</a></div><div class='hunk'>@@ -70,7 +70,7 @@ void TIFF_MemoryReader::SortIFD ( TweakedIFDInfo* thisIFD )</div><div class='ctx'> 		} else if ( thisTag == prevTag ) {</div><div class='ctx'> </div><div class='ctx'> 			// Duplicate tag, keep the 2nd copy, move the tail of the array up, prevTag is unchanged.</div><div class='del'>-			memcpy ( &amp;ifdEntries[i-1], &amp;ifdEntries[i], 12*(tagCount-i) );	// AUDIT: Safe, moving tail forward, i &gt;= 1.</div><div class='add'>+			memmove ( &amp;ifdEntries[i-1], &amp;ifdEntries[i], 12*(tagCount-i) ); // may overlap -- Hub</div><div class='ctx'> 			--tagCount;</div><div class='ctx'> 			--i; // ! Don't move forward in the array, we've moved the unseen part up.</div><div class='ctx'> </div><div class='hunk'>@@ -86,7 +86,7 @@ void TIFF_MemoryReader::SortIFD ( TweakedIFDInfo* thisIFD )</div><div class='ctx'> </div><div class='ctx'> 				// Out of order duplicate, move it to position j, move the tail of the array up.</div><div class='ctx'> 				ifdEntries[j] = ifdEntries[i];</div><div class='del'>-				memcpy ( &amp;ifdEntries[i], &amp;ifdEntries[i+1], 12*(tagCount-(i+1)) );	// AUDIT: Safe, moving tail forward, i &gt;= 1.</div><div class='add'>+				memmove ( &amp;ifdEntries[i], &amp;ifdEntries[i+1], 12*(tagCount-(i+1)) );	// may overlap -- Hub</div><div class='ctx'> 				--tagCount;</div><div class='ctx'> 				--i; // ! Don't move forward in the array, we've moved the unseen part up.</div><div class='ctx'> </div><div class='hunk'>@@ -232,7 +232,11 @@ bool TIFF_MemoryReader::GetTag ( XMP_Uns8 ifd, XMP_Uns16 id, TagInfo* info ) con</div><div class='ctx'> 		info-&gt;dataLen = thisBytes;</div><div class='ctx'> </div><div class='ctx'> 		info-&gt;dataPtr = this-&gt;GetDataPtr ( thisTag );</div><div class='del'>-</div><div class='add'>+		// Here we know that if it is NULL, it is wrong. -- Hub</div><div class='add'>+		// GetDataPtr will return NULL in case of overflow.</div><div class='add'>+		if (info-&gt;dataPtr == NULL) {</div><div class='add'>+			return false;</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return true;</div><div class='head'>diff --git a/XMPFiles/source/FormatSupport/TIFF_Support.hpp b/XMPFiles/source/FormatSupport/TIFF_Support.hpp<br/>index d4e2f4d..e3e458b 100644<br/>--- a/<a href='/exempi/tree/XMPFiles/source/FormatSupport/TIFF_Support.hpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>XMPFiles/source/FormatSupport/TIFF_Support.hpp</a><br/>+++ b/<a href='/exempi/tree/XMPFiles/source/FormatSupport/TIFF_Support.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>XMPFiles/source/FormatSupport/TIFF_Support.hpp</a></div><div class='hunk'>@@ -786,7 +786,13 @@ private:</div><div class='ctx'> 		{ if ( GetUns32AsIs(&amp;tifdEntry-&gt;bytes) &lt;= 4 ) {</div><div class='ctx'> 		  	return &amp;tifdEntry-&gt;dataOrPos;</div><div class='ctx'> 		  } else {</div><div class='del'>-		  	return (this-&gt;tiffStream + GetUns32AsIs(&amp;tifdEntry-&gt;dataOrPos));</div><div class='add'>+			XMP_Uns32 pos = GetUns32AsIs(&amp;tifdEntry-&gt;dataOrPos);</div><div class='add'>+			if (pos + GetUns32AsIs (&amp;tifdEntry-&gt;bytes) &gt; this-&gt;tiffLength) {</div><div class='add'>+				// Invalid file.</div><div class='add'>+				// The data is past the length of the TIFF.</div><div class='add'>+				return NULL;</div><div class='add'>+			}</div><div class='add'>+			return (this-&gt;tiffStream + pos);</div><div class='ctx'> 		  }</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='head'>diff --git a/exempi/exempi.cpp b/exempi/exempi.cpp<br/>index 6857df9..584aaf1 100644<br/>--- a/<a href='/exempi/tree/exempi/exempi.cpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>exempi/exempi.cpp</a><br/>+++ b/<a href='/exempi/tree/exempi/exempi.cpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>exempi/exempi.cpp</a></div><div class='hunk'>@@ -195,10 +195,8 @@ bool xmp_init()</div><div class='ctx'>     RESET_ERROR;</div><div class='ctx'>     try {</div><div class='ctx'>         // no need to initialize anything else.</div><div class='del'>-        // XMP SDK 5.1.2 needs this because it has been lobotomized of local</div><div class='del'>-        // text</div><div class='del'>-        // conversion</div><div class='del'>-        // the one that was done in Exempi with libiconv.</div><div class='add'>+        // XMP SDK 5.1.2 needs this because it has been stripped off local</div><div class='add'>+        // text conversion the one that was done in Exempi with libiconv.</div><div class='ctx'>         bool result = SXMPFiles::Initialize(kXMPFiles_IgnoreLocalText);</div><div class='ctx'>         SXMPMeta::SetDefaultErrorCallback(&amp;_xmp_error_callback, nullptr, 1);</div><div class='ctx'>         return result;</div><div class='head'>diff --git a/public/include/XMP_Const.h b/public/include/XMP_Const.h<br/>index 4b72404..aa05e89 100644<br/>--- a/<a href='/exempi/tree/public/include/XMP_Const.h?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>public/include/XMP_Const.h</a><br/>+++ b/<a href='/exempi/tree/public/include/XMP_Const.h?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>public/include/XMP_Const.h</a></div><div class='hunk'>@@ -12,6 +12,8 @@</div><div class='ctx'> #include "XMP_Environment.h"</div><div class='ctx'> </div><div class='ctx'>    #include &lt;stddef.h&gt;</div><div class='add'>+   #include &lt;string.h&gt;</div><div class='add'>+   #include &lt;stdlib.h&gt;</div><div class='ctx'> </div><div class='ctx'> #if XMP_MacBuild | XMP_iOSBuild	// ! No stdint.h on Windows and some UNIXes.</div><div class='ctx'>     #include &lt;stdint.h&gt;</div><div class='hunk'>@@ -1313,7 +1315,25 @@ public:</div><div class='ctx'> 	///</div><div class='ctx'> 	/// @param _errMsg The descriptive string, for debugging use only. It must not be shown to users</div><div class='ctx'> 	/// in a final product. It is written for developers, not users, and never localized.</div><div class='del'>-	XMP_Error ( XMP_Int32 _id, XMP_StringPtr _errMsg ) : id(_id), errMsg(_errMsg), notified(false) {};</div><div class='add'>+	XMP_Error ( XMP_Int32 _id, XMP_StringPtr _errMsg ) : id(_id), errMsg(NULL), notified(false) {</div><div class='add'>+		if (_errMsg) {</div><div class='add'>+			errMsg = strdup(_errMsg);</div><div class='add'>+		}</div><div class='add'>+	};</div><div class='add'>+	/// @brief Copy constructor for an XMP_Error.</div><div class='add'>+	///</div><div class='add'>+	/// Because we rethrow it.</div><div class='add'>+	XMP_Error (const XMP_Error&amp; e)</div><div class='add'>+		: id(e.id), errMsg(NULL), notified(e.notified) {</div><div class='add'>+		if (e.errMsg) {</div><div class='add'>+			errMsg = strdup(e.errMsg);</div><div class='add'>+		}</div><div class='add'>+	};</div><div class='add'>+	~XMP_Error() {</div><div class='add'>+		if (errMsg) {</div><div class='add'>+			free(errMsg);</div><div class='add'>+		}</div><div class='add'>+	};</div><div class='ctx'> </div><div class='ctx'> 	/// Retrieves the numeric code from an XMP_Error.</div><div class='ctx'> 	inline XMP_Int32     GetID() const     { return id; };</div><div class='hunk'>@@ -1332,7 +1352,7 @@ private:</div><div class='ctx'> 	XMP_Int32     id;</div><div class='ctx'> 	/// Descriptive string, for debugging use only. It must not be shown to users in a final</div><div class='ctx'> 	/// product. It is written for developers, not users, and never localized.</div><div class='del'>-	XMP_StringPtr errMsg;</div><div class='add'>+	char* errMsg;</div><div class='ctx'> 	/// Variable to store whether this particular error is notified to user or not</div><div class='ctx'> 	XMP_Bool notified;</div><div class='ctx'> };</div><div class='head'>diff --git a/public/include/client-glue/WXMP_Common.hpp b/public/include/client-glue/WXMP_Common.hpp<br/>index 97fb9fc..0aef5ba 100644<br/>--- a/<a href='/exempi/tree/public/include/client-glue/WXMP_Common.hpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>public/include/client-glue/WXMP_Common.hpp</a><br/>+++ b/<a href='/exempi/tree/public/include/client-glue/WXMP_Common.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>public/include/client-glue/WXMP_Common.hpp</a></div><div class='hunk'>@@ -9,6 +9,9 @@</div><div class='ctx'> // of the Adobe license agreement accompanying it.</div><div class='ctx'> // =================================================================================================</div><div class='ctx'> </div><div class='add'>+#include &lt;stdlib.h&gt;</div><div class='add'>+#include &lt;string.h&gt;</div><div class='add'>+</div><div class='ctx'> #ifndef XMP_Inline</div><div class='ctx'> 	#if TXMP_EXPAND_INLINE</div><div class='ctx'> 		#define XMP_Inline inline</div><div class='hunk'>@@ -24,12 +27,38 @@ typedef void (* SetClientStringProc) ( void * clientPtr, XMP_StringPtr valuePtr,</div><div class='ctx'> typedef void (* SetClientStringVectorProc) ( void * clientPtr, XMP_StringPtr * arrayPtr, XMP_Uns32 stringCount );</div><div class='ctx'> </div><div class='ctx'> struct WXMP_Result {</div><div class='del'>-    XMP_StringPtr errMessage;</div><div class='add'>+private:</div><div class='add'>+    char*         errMessage;</div><div class='add'>+public:</div><div class='ctx'>     void *        ptrResult;</div><div class='ctx'>     double        floatResult;</div><div class='ctx'>     XMP_Uns64     int64Result;</div><div class='ctx'>     XMP_Uns32     int32Result;</div><div class='del'>-	WXMP_Result() : errMessage(0),ptrResult(NULL),floatResult(0),int64Result(0),int32Result(0){};</div><div class='add'>+	WXMP_Result() : errMessage(NULL),ptrResult(NULL),floatResult(0),int64Result(0),int32Result(0){};</div><div class='add'>+	~WXMP_Result()</div><div class='add'>+	{</div><div class='add'>+		if (errMessage) {</div><div class='add'>+			free(errMessage);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+	void SetErrMessage(const char* msg)</div><div class='add'>+		{</div><div class='add'>+			if (errMessage) {</div><div class='add'>+				free(errMessage);</div><div class='add'>+				errMessage = NULL;</div><div class='add'>+			}</div><div class='add'>+			if (msg) {</div><div class='add'>+				errMessage = strdup(msg);</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='add'>+	const char* GetErrMessage() const</div><div class='add'>+		{</div><div class='add'>+			return errMessage;</div><div class='add'>+		}</div><div class='add'>+private:</div><div class='add'>+	// We should avoid automatic copy.</div><div class='add'>+	WXMP_Result(const WXMP_Result&amp;);</div><div class='add'>+	WXMP_Result&amp; operator=(const WXMP_Result&amp;);</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> #if __cplusplus</div><div class='hunk'>@@ -37,7 +66,7 @@ extern "C" {</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> #define PropagateException(res)	\</div><div class='del'>-	if ( res.errMessage != 0 ) throw XMP_Error ( res.int32Result, res.errMessage );</div><div class='add'>+	if ( res.GetErrMessage() != 0 ) throw XMP_Error ( res.int32Result, res.GetErrMessage() );</div><div class='ctx'> </div><div class='ctx'> #ifndef XMP_TraceClientCalls</div><div class='ctx'> 	#define XMP_TraceClientCalls		0</div><div class='hunk'>@@ -55,10 +84,10 @@ extern "C" {</div><div class='ctx'>     	WXMP_Result wResult;                                                                                 \</div><div class='ctx'>     	fprintf ( xmpClientLog, "WXMP calling: %s\n", #WCallProto ); fflush ( xmpClientLog );                \</div><div class='ctx'>     	WCallProto;                                                                                          \</div><div class='del'>-    	if ( wResult.errMessage == 0 ) {                                                                     \</div><div class='add'>+	if ( wResult.GetErrMessage() == 0 ) {				\</div><div class='ctx'> 			fprintf ( xmpClientLog, "WXMP back, no error\n" ); fflush ( xmpClientLog );                      \</div><div class='ctx'>     	} else {                                                                                             \</div><div class='del'>-			fprintf ( xmpClientLog, "WXMP back, error: %s\n", wResult.errMessage ); fflush ( xmpClientLog ); \</div><div class='add'>+			fprintf ( xmpClientLog, "WXMP back, error: %s\n", wResult.GetErrMessage() ); fflush ( xmpClientLog ); \</div><div class='ctx'>     	}                                                                                                    \</div><div class='ctx'> 		PropagateException ( wResult )</div><div class='ctx'> #endif</div><div class='head'>diff --git a/source/XMP_LibUtils.hpp b/source/XMP_LibUtils.hpp<br/>index 6b6a96a..3fa7a8b 100644<br/>--- a/<a href='/exempi/tree/source/XMP_LibUtils.hpp?id=6f0104309b9daed4a51a07e593bcfdc529fdb5a4'>source/XMP_LibUtils.hpp</a><br/>+++ b/<a href='/exempi/tree/source/XMP_LibUtils.hpp?id=c26d5beb60a5a85f76259f50ed3e08c8169b0a0c'>source/XMP_LibUtils.hpp</a></div><div class='hunk'>@@ -444,13 +444,13 @@ private:</div><div class='ctx'> #define XMP_ENTER_NoLock(Proc)		\</div><div class='ctx'> 	AnnounceStaticEntry ( Proc );	\</div><div class='ctx'> 	try {							\</div><div class='del'>-		wResult-&gt;errMessage = 0;</div><div class='add'>+		wResult-&gt;SetErrMessage(0);</div><div class='ctx'> </div><div class='ctx'> #define XMP_ENTER_Static(Proc)				\</div><div class='ctx'> 	AnnounceStaticEntry ( Proc );			\</div><div class='ctx'> 	AcquireLibraryLock ( sLibraryLock );	\</div><div class='ctx'> 	try {									\</div><div class='del'>-		wResult-&gt;errMessage = 0;</div><div class='add'>+		wResult-&gt;SetErrMessage(0);</div><div class='ctx'> </div><div class='ctx'> #define XMP_ENTER_ObjRead(XMPClass,Proc)				\</div><div class='ctx'> 	AnnounceObjectEntry ( Proc, "reader" );				\</div><div class='hunk'>@@ -458,7 +458,7 @@ private:</div><div class='ctx'> 	const XMPClass &amp; thiz = *((XMPClass*)xmpObjRef);	\</div><div class='ctx'> 	XMP_AutoLock objLock ( &amp;thiz.lock, kXMP_ReadLock );	\</div><div class='ctx'> 	try {												\</div><div class='del'>-		wResult-&gt;errMessage = 0;</div><div class='add'>+		wResult-&gt;SetErrMessage(0);</div><div class='ctx'> </div><div class='ctx'> #define XMP_ENTER_ObjWrite(XMPClass,Proc)					\</div><div class='ctx'> 	AnnounceObjectEntry ( Proc, "writer" );					\</div><div class='hunk'>@@ -466,7 +466,7 @@ private:</div><div class='ctx'> 	XMPClass * thiz = (XMPClass*)xmpObjRef;					\</div><div class='ctx'> 	XMP_AutoLock objLock ( &amp;thiz-&gt;lock, kXMP_WriteLock );	\</div><div class='ctx'> 	try {													\</div><div class='del'>-		wResult-&gt;errMessage = 0;</div><div class='add'>+		wResult-&gt;SetErrMessage(0);</div><div class='ctx'> </div><div class='ctx'> #define XMP_EXIT			\</div><div class='ctx'> 	XMP_CATCH_EXCEPTIONS	\</div><div class='hunk'>@@ -483,18 +483,18 @@ private:</div><div class='ctx'> 	} catch ( XMP_Error &amp; xmpErr ) {								\</div><div class='ctx'> 		wResult-&gt;int32Result = xmpErr.GetID(); 						\</div><div class='ctx'> 		wResult-&gt;ptrResult   = (void*)"XMP";						\</div><div class='del'>-		wResult-&gt;errMessage  = xmpErr.GetErrMsg();					\</div><div class='del'>-		if ( wResult-&gt;errMessage == 0 ) wResult-&gt;errMessage = "";	\</div><div class='del'>-		AnnounceCatch ( wResult-&gt;errMessage );						\</div><div class='add'>+		wResult-&gt;SetErrMessage(xmpErr.GetErrMsg());             \</div><div class='add'>+		if ( wResult-&gt;GetErrMessage() == 0 ) wResult-&gt;SetErrMessage(""); \</div><div class='add'>+		AnnounceCatch ( wResult-&gt;GetErrMessage() );             \</div><div class='ctx'> 	} catch ( std::exception &amp; stdErr ) {							\</div><div class='ctx'> 		wResult-&gt;int32Result = kXMPErr_StdException; 				\</div><div class='del'>-		wResult-&gt;errMessage  = stdErr.what(); 						\</div><div class='del'>-		if ( wResult-&gt;errMessage == 0 ) wResult-&gt;errMessage = "";	\</div><div class='del'>-		AnnounceCatch ( wResult-&gt;errMessage );						\</div><div class='add'>+		wResult-&gt;SetErrMessage(stdErr.what());                  \</div><div class='add'>+		if ( wResult-&gt;GetErrMessage() == 0 ) wResult-&gt;SetErrMessage(""); \</div><div class='add'>+		AnnounceCatch ( wResult-&gt;GetErrMessage() );             \</div><div class='ctx'> 	} catch ( ... ) {												\</div><div class='ctx'> 		wResult-&gt;int32Result = kXMPErr_UnknownException; 			\</div><div class='del'>-		wResult-&gt;errMessage  = "Caught unknown exception";			\</div><div class='del'>-		AnnounceCatch ( wResult-&gt;errMessage );						\</div><div class='add'>+		wResult-&gt;SetErrMessage("Caught unknown exception");     \</div><div class='add'>+		AnnounceCatch ( wResult-&gt;GetErrMessage() );                \</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> #if XMP_DebugBuild</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:07 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
