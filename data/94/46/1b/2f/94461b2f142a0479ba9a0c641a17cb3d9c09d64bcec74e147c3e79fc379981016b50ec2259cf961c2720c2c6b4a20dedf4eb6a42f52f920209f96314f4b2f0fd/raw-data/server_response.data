<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='XSLT related Bug #54446 - RDF' href='rss/bug.php?id=54446'>
        <link rel='alternate' type='application/rss+xml' title='XSLT related Bug #54446 - RSS 2.0' href='rss/bug.php?id=54446&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #54446 :: Arbitrary file creation via libxslt 'output' extension</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=54446">Bug</a>&nbsp;#54446</th>
            <td id="summary" colspan="5">Arbitrary file creation via libxslt 'output' extension</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2011-04-01 17:09 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2012-01-18 17:09 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>nicolas &#x64;&#111;&#x74; gregoire &#x61;&#116; agarri &#x64;&#111;&#x74; fr</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=chregu">chregu</a> (<a href="https://people.php.net/chregu">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=XSLT+related">XSLT related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.3.6</td>
            <th class="details">OS:</th>
            <td>All</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0057" target="_blank">2012-0057</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=54446&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=54446&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=54446&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1301677798">&nbsp;</a><strong>[2011-04-01 17:09 UTC] nicolas &#x64;&#111;&#x74; gregoire &#x61;&#116; agarri &#x64;&#111;&#x74; fr</strong>
<pre class='note'>Description:
------------
Current version of PHP5 allow creation of arbitrary files when processing XSLT content. This was tested on the following releases :
- PHP 5.3.2-1ubuntu4.7 with Suhosin-Patch (cli) (built: Jan 12 2011 18:36:08) 
- PHP 5.3.6 (cli) (built: Apr  1 2011 11:26:17)

The problem lies in the unrestricted use of libxslt. The attached patch will forbid some operations like the creation of files or directories, by calling the libxslt security API.



Test script:
---------------
&lt;?php 

$sXml = '&lt;xml&gt;&lt;foo&gt;Hello from XML&lt;/foo&gt;&lt;/xml&gt;';
 
$sXsl = &lt;&lt;&lt;EOT
&lt;xsl:stylesheet version=&quot;1.0&quot;
	xmlns:xsl=&quot;<a href="http://www.w3.org/1999/XSL/Transform&quot;" rel="nofollow">http://www.w3.org/1999/XSL/Transform&quot;</a>
	xmlns:sax=&quot;<a href="http://icl.com/saxon&quot;" rel="nofollow">http://icl.com/saxon&quot;</a>
	extension-element-prefixes=&quot;sax&quot;&gt;

	&lt;xsl:template match=&quot;//foo&quot;&gt;
		&lt;sax:output href=&quot;0wn3d.php&quot; method=&quot;text&quot;&gt;
			&lt;xsl:value-of select=&quot;'0wn3d via PHP and libxslt ...'&quot;/&gt;
			&lt;xsl:apply-templates/&gt;
		&lt;/sax:output&gt;
	&lt;/xsl:template&gt;

&lt;/xsl:stylesheet&gt;
EOT;

# LOAD XML FILE 
$XML = new DOMDocument(); 
$XML-&gt;loadXML( $sXml ); 

# LOAD XSLT FILE 
$XSL = new DOMDocument(); 
$XSL-&gt;loadXML( $sXsl );

# START XSLT 
$xslt = new XSLTProcessor(); 
$xslt-&gt;importStylesheet( $XSL ); 

# TRASNFORM &amp; PRINT 
print $xslt-&gt;transformToXML( $XML ); 

?&gt;

Expected result:
----------------
File isn't created and PHP displays some warnings :

Warning: XSLTProcessor::transformToXml(): runtime error: file /somewhere/ line 7 element output in /somewhere/simple_xslt.php on line 34
Warning: XSLTProcessor::transformToXml(): File write for 0wn3d.php refused in /somewhere/simple_xslt.php on line 34
Warning: XSLTProcessor::transformToXml(): runtime error: file /somewhere/ line 7 element output in /somewhere/simple_xslt.php on line 34
Warning: XSLTProcessor::transformToXml(): xsltDocumentElem: write rights for 0wn3d.php denied in /somewhere/simple_xslt.php on line 34


Actual result:
--------------
File '0wn3d.php' is created


</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=54446&amp;patch=libxslt_54446_2&amp;revision=latest" >libxslt_54446_2</a>
(last revision 2011-04-18 10:01 UTC by chregu@php.net)
<br><a href="patch-display.php?bug_id=54446&amp;patch=libxslt_54446.patch&amp;revision=latest"  style="background-color: yellow; text-decoration: line-through;" >libxslt_54446.patch</a>
(last revision 2011-04-03 22:35 UTC by cataphract@php.net)
<br><p><a href='patch-add.php?bug_id=54446'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=54446'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1301876500">&nbsp;</a><strong>[2011-04-04 00:21 UTC] <a href="//people.php.net/cataphract">cataphract@php.net</a></strong>
<pre class='note'>&gt; he attached patch will forbid some operations

You seem to have forgotten to attach it.
</pre>
</div><div class='comment type_patch' ><a name="1301877338">&nbsp;</a><strong>[2011-04-04 00:35 UTC] <a href="//people.php.net/cataphract">cataphract@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: libxslt_54446.patch
Revision:   1301870138
URL:        <a href="http://bugs.php.net/patch-display.php?bug=54446&amp;patch=libxslt_54446.patch&amp;revision=1301870138" rel="nofollow">http://bugs.php.net/patch-display.php?bug=54446&amp;patch=libxslt_54446.patch&amp;revision=1301870138</a>
</pre>
</div><div class='comment type_comment' ><a name="1301877361">&nbsp;</a><strong>[2011-04-04 00:36 UTC] <a href="//people.php.net/cataphract">cataphract@php.net</a></strong>
<pre class='note'>I've attached the patch the reporter has sent me by e-mail.
</pre>
</div><div class='comment type_log' ><a name="1302971636">&nbsp;</a><strong>[2011-04-16 16:33 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Assigned</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: chregu</span>
</div></div></div><div class='comment type_comment' ><a name="1302971636">&nbsp;</a><strong>[2011-04-16 16:33 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<pre class='note'>1) I can't add anything to ticket #54446, even if my password allows me
to read it, so I used security@
2) The ticket actually includes a test case and a patch
3) This is clearly a backwards incompatible change
4) You may decide to restrict READ_FILE and READ_NETWORK too
5) You may want to make this behavior configurable (accept nothing,
accept read-only, accept read/write)
6) Actually, it is trivial to get code execution on any PHP application
accepting untrusted XSLT
7) This bug will be publicly disclosed in June, and I hope that a patch
will be released before
</pre>
</div><div class='comment type_comment' ><a name="1303112837">&nbsp;</a><strong>[2011-04-18 07:47 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>This is basically a well known feature, you can write files with XSLT since &quot;forever&quot;, it's IMHO perfectly in the boundaries of what it's supposed to do and not a &quot;newly found security&quot; hole.

But I guess even I didn't always clean untrusted XSLT properly for all the possible cases. That's why I think it's a good thing to disable write-access for XSLT by default. Not many are using that feature. I'll try to come up with something for added protection.

PS. We should disable write access for SQL by default, too, it's the same line of thought ;) &lt;/sarcasm&gt;
</pre>
</div><div class='comment type_patch' ><a name="1303128097">&nbsp;</a><strong>[2011-04-18 12:01 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: libxslt_54446_2
Revision:   1303120896
URL:        <a href="http://bugs.php.net/patch-display.php?bug=54446&amp;patch=libxslt_54446_2&amp;revision=1303120896" rel="nofollow">http://bugs.php.net/patch-display.php?bug=54446&amp;patch=libxslt_54446_2&amp;revision=1303120896</a>
</pre>
</div><div class='comment type_comment' ><a name="1303128168">&nbsp;</a><strong>[2011-04-18 12:02 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>Added a new patch with 2 new methods:

setSecurityPrefs and getSecurityPrefs

default is

 XSL_SECPREF_WRITE_FILE |  XSL_SECPREF_WRITE_NETWORK | XSL_SECPREF_CREATE_DIRECTORY;

please review
</pre>
</div><div class='comment type_comment' ><a name="1304009873">&nbsp;</a><strong>[2011-04-28 16:57 UTC] nicolas &#x64;&#111;&#x74; gregoire &#x61;&#116; agarri &#x64;&#111;&#x74; fr</strong>
<pre class='note'>I just tested your patch against my test script and it successfully blocked the file creation attempt. Tested too the two configuration methods.

OK for me ...
</pre>
</div><div class='comment type_comment' ><a name="1305647815">&nbsp;</a><strong>[2011-05-17 15:56 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>I'll commit the page in the next few days. will be on holiday next week
</pre>
</div><div class='comment type_comment' ><a name="1307202837">&nbsp;</a><strong>[2011-06-04 15:53 UTC] nicolas &#x64;&#111;&#x74; gregoire &#x61;&#116; agarri &#x64;&#111;&#x74; fr</strong>
<pre class='note'>When will the patch be committed ?
</pre>
</div><div class='comment type_comment' ><a name="1307540681">&nbsp;</a><strong>[2011-06-08 13:44 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>The patch should be committed soon. We have a problem for the 5.3 branch since it changes a struct and therefore breaks binary compatibility. I don't have a solution for that now.
</pre>
</div><div class='comment type_comment' ><a name="1309719500">&nbsp;</a><strong>[2011-07-03 18:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<pre class='note'>Christian, can you commit it for 5.4+?
</pre>
</div><div class='comment type_comment' ><a name="1310028963">&nbsp;</a><strong>[2011-07-07 08:56 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>It's on my personal todo since weeks. I'll try to do it in the next few days (have to write a decent NEWS entry mainly)
</pre>
</div><div class='comment type_log' ><a name="1310368702">&nbsp;</a><strong>[2011-07-11 07:18 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Assigned</span>
<span class="added">+Status:      To be documented</span>
<span class="removed">-Assigned To: chregu</span>
<span class="added">+Assigned To:</span>
</div></div></div><div class='comment type_comment' ><a name="1310368702">&nbsp;</a><strong>[2011-07-11 07:18 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>This is now fixed in trunk and therefore 5.4
</pre>
</div><div class='comment type_svn' ><a name="1310432315">&nbsp;</a><strong>[2011-07-12 00:58 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of chregu
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=313160" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=313160</a>
Log: Added XsltProcessor::setSecurityPrefs($options) and getSecurityPrefs()
to define forbidden operations within XSLT stylesheets, default is not to
enable any write operations from XSLT anymore. <a href='bug.php?id=54446'>Bug #54446</a>

(second iteration of the code for trunk, first commit for 5.4 branch)
</pre>
</div><div class='comment type_svn' ><a name="1315831474">&nbsp;</a><strong>[2011-09-12 12:44 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of chregu
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=316530" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=316530</a>
Log: Added test for XSL <a href='bug.php?id=54446'>bug 54446</a>
</pre>
</div><div class='comment type_svn' ><a name="1317808539">&nbsp;</a><strong>[2011-10-05 09:55 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of chregu
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=317759" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=317759</a>
Log: Added xsl.security_prefs ini option to define forbidden operations within XSLT
stylesheets, default is not to enable write operations. This option won't be
in 5.4, since there's a new method. <a href='bug.php?id=54446'>Bug #54446</a>
</pre>
</div><div class='comment type_svn' ><a name="1317838266">&nbsp;</a><strong>[2011-10-05 18:11 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of chregu
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=317801" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=317801</a>
Log: Added test for <a href='bug.php?id=54446'>Bug 54446</a>
Init a variable to a default value to avoid issues
</pre>
</div><div class='comment type_log' ><a name="1318309783">&nbsp;</a><strong>[2011-10-11 05:09 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      To be documented</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: chregu</span>
</div></div></div><div class='comment type_comment' ><a name="1318309783">&nbsp;</a><strong>[2011-10-11 05:09 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>It's now als in the PHP 5.3.x branch (will be in 5.3.9). We couldn't use the same approach as in PHP 5.4 due to ABI compatibility problems. We had to introduce an ini option. Here's a code example, which works in 5.3 (actually anything &gt;= 5.0) and 5.4 for writing from within XSLT. 


***
$xsl = new XSLTProcessor();

//if you want to write from within the XSLT
if (version_compare(PHP_VERSION,'5.4',&quot;&lt;&quot;)) {
    $oldval = ini_set(&quot;xsl.security_prefs&quot;,XSL_SECPREFS_NONE);
} else {
    $oldval = $xsl-&gt;setSecurityPreferences(XSL_SECPREFS_NONE);
}

$xsl-&gt;transformToXml(...);

//go back to the old setting. Better safe than sorry
if (version_compare(PHP_VERSION,'5.4',&quot;&lt;&quot;)) {
    ini_set(&quot;xsl.security_prefs&quot;,$oldval);
} else {
    $xsl-&gt;setSecurityPreferences($oldval);
    //or just do
    // $xsl = null;
    // to get away of this object
}
</pre>
</div><div class='comment type_log' ><a name="1318310293">&nbsp;</a><strong>[2011-10-11 05:18 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Closed</span>
<span class="added">+Status: To be documented</span>
</div></div></div><div class='comment type_comment' ><a name="1318310293">&nbsp;</a><strong>[2011-10-11 05:18 UTC] <a href="//people.php.net/chregu">chregu@php.net</a></strong>
<pre class='note'>This bug has been fixed in SVN.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1318546845">&nbsp;</a><strong>[2011-10-13 23:00 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_log' ><a name="1326906576">&nbsp;</a><strong>[2012-01-18 17:09 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2012-0057</span>
</div></div></div><div class='comment type_comment' ><a name="1328025466">&nbsp;</a><strong>[2012-01-31 15:57 UTC] daniel &#x61;&#116; dnaielcraig &#x64;&#111;&#x74; me</strong>
<pre class='note'>Since the fix for this came through debian repos (today) i'm getting the error:
Warning: XSLTProcessor::transformToXml(): Can't set libxslt security properties, not doing transformation for security reasons
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
