<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PCRE related Bug #78338 - RDF' href='rss/bug.php?id=78338'>
        <link rel='alternate' type='application/rss+xml' title='PCRE related Bug #78338 - RSS 2.0' href='rss/bug.php?id=78338&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #78338 :: Array cross-border reading/global variable coverage in PCRE</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=78338">Sec Bug</a>&nbsp;#78338</th>
            <td id="summary" colspan="5">Array cross-border reading/global variable coverage in PCRE</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2019-07-28 04:17 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-07-29 22:01 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>3556158925 &#x61;&#116; qq &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PCRE+related">PCRE related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.3.8</td>
            <th class="details">OS:</th>
            <td>Ubuntu 18.04.1 LTS</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=78338&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=78338&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=78338&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1564287478">&nbsp;</a><strong>[2019-07-28 04:17 UTC] 3556158925 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Get the lastest version of PHP:
git clone <a href="https://github.com/php/php-src" rel="nofollow">https://github.com/php/php-src</a>

Configure PHP:
./configure
PCRE is the default extension in PHP, even if use &quot;./configure --disable-all&quot;,
you can still trigger the following bugs.

The test script is very easy:
&lt;?php
$fuzz=file_get_contents($argv[1]);
preg_match($fuzz,$fuzz);

The input file you can download here:
<a href="http://47.104.189.187/input.zip" rel="nofollow">http://47.104.189.187/input.zip</a>
Unzip this file and use the &quot;input_file.txt&quot; as input file

Then
./php-src/sapi/cli/php ./test.php ./input_file.txt
you will see &quot;Segmentation fault (core dumped)&quot;

Use gdb to see the details:
Program received signal SIGSEGV, Segmentation fault.
0x0000555555710367 in do_extuni_no_utf (args=0x7fffffffa110, 
    cc=0x7ffff3a58868 &quot;\377\066\250\250\250\066\066\066zzzz=*\377/\n&quot;)
    at /home/daige/Desktop/test/php-src/ext/pcre/pcre2lib/pcre2_jit_compile.c:8546
8546	lgb = UCD_GRAPHBREAK(c);

I analyse this crash,it is caused by array cross-border reading, then I use AFL to fuzz PHP,it reports some global variable coverage,you can see the crash cases in &quot;input.zip&quot;.

Test script:
---------------
The test script is very easy:
&lt;?php
$fuzz=file_get_contents($argv[1]);
preg_match($fuzz,$fuzz);

The input file you can download here:
<a href="http://47.104.189.187/input.zip" rel="nofollow">http://47.104.189.187/input.zip</a>
Unzip this file and use the &quot;input_file.txt&quot; as input file

Then
./php-src/sapi/cli/php ./test.php ./input_file.txt
you will see &quot;Segmentation fault (core dumped)&quot;

Actual result:
--------------
Program received signal SIGSEGV, Segmentation fault.
0x0000555555710367 in do_extuni_no_utf (args=0x7fffffffa110, 
    cc=0x7ffff3a58868 &quot;\377\066\250\250\250\066\066\066zzzz=*\377/\n&quot;)
    at /home/daige/Desktop/test/php-src/ext/pcre/pcre2lib/pcre2_jit_compile.c:8546
8546	lgb = UCD_GRAPHBREAK(c);

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=78338'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=78338'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1564287674">&nbsp;</a><strong>[2019-07-28 04:21 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>This looks like segfault inside PCRE library. Did you report it to the PCRE maintainers?
</pre>
</div><div class='comment type_comment' ><a name="1564298578">&nbsp;</a><strong>[2019-07-28 07:22 UTC] 3556158925 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>I send this report to PRCE maintainer just now, thanks.
</pre>
</div><div class='comment type_comment' ><a name="1564391556">&nbsp;</a><strong>[2019-07-29 09:12 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>&gt; I send this report to PRCE maintainer just now, thanks.

For reference: &lt;<a href="https://bugs.exim.org/show_bug.cgi?id=2421" rel="nofollow">https://bugs.exim.org/show_bug.cgi?id=2421</a>&gt;
</pre>
</div><div class='comment type_log' ><a name="1564420639">&nbsp;</a><strong>[2019-07-29 17:17 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Analyzed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1564420639">&nbsp;</a><strong>[2019-07-29 17:17 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>This issue has already been fixed upstream.  Since it is caused by
erroneous treatment of the subject (which may be user supplied),
we should consider to apply the following patch to our bundled
pcre2 (PHP-7.3+):

 ext/pcre/pcre2lib/pcre2_jit_compile.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/ext/pcre/pcre2lib/pcre2_jit_compile.c b/ext/pcre/pcre2lib/pcre2_jit_compile.c
index 1f21bfb6ad..283aeff83c 100644
--- a/ext/pcre/pcre2lib/pcre2_jit_compile.c
+++ b/ext/pcre/pcre2lib/pcre2_jit_compile.c
@@ -8538,7 +8538,7 @@ int lgb, rgb, ricount;
 PCRE2_SPTR bptr;
 uint32_t c;
 
-GETCHARINC(c, cc);
+c = *cc++;
 #if PCRE2_CODE_UNIT_WIDTH == 32
 if (c &gt;= 0x110000)
   return NULL;
</pre>
</div><div class='comment type_comment' ><a name="1564421598">&nbsp;</a><strong>[2019-07-29 17:33 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Formatted patch including regression test:
&lt;<a href="https://gist.github.com/cmb69/3878eb568ea5d894f765a2703e5693e2" rel="nofollow">https://gist.github.com/cmb69/3878eb568ea5d894f765a2703e5693e2</a>&gt;.
</pre>
</div><div class='comment type_log' ><a name="1564437695">&nbsp;</a><strong>[2019-07-29 22:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Analyzed</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1564437695">&nbsp;</a><strong>[2019-07-29 22:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.
If you are still experiencing this bug, try to check out latest source from <a href="https://github.com/php/php-src" rel="nofollow">https://github.com/php/php-src</a> and re-test.
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1564437714">&nbsp;</a><strong>[2019-07-29 22:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.4Git-2019-07-28 (Git)</span>
<span class="added">+PHP Version: 7.3.8</span>
</div></div></div><div class='comment type_svn' ><a name="1564471039">&nbsp;</a><strong>[2019-07-30 07:17 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=9f6a5a027035d1fe7171a4fdd9b123cc4f439708" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=9f6a5a027035d1fe7171a4fdd9b123cc4f439708</a>
Log: Fix #78338: Array cross-border reading in PCRE
</pre>
</div><div class='comment type_related' ><a name="1564655737">&nbsp;</a><strong>[2019-08-01 10:35 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=78358'>Bug #78358</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
