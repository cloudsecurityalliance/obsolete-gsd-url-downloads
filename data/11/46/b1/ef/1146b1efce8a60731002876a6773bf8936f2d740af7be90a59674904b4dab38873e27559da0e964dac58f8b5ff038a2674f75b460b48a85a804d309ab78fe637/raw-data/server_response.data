<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head> <title>curl - SMTP send heap buffer overflow - CVE-2018-0500</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="stylesheet" type="text/css" href="/curl.css">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="icon" href="/logo/curl-symbol.svg" type="image/svg+xml">
<link rel="STYLESHEET" type="text/css" href="https://curl.se/manpage.css">
</head>
<body>
<div class="main">
<div class="menu">
<a href="/docs/" class="menuitem" title="Documentation Overview">Docs Overview</a>
<div class="dropdown">
  <a class="dropbtn" href="/docs/projdocs.html">Project</a>
  <div class="dropdown-content">
    <a href="/docs/bugbounty.html">Bug Bounty</a>
    <a href="/docs/bugs.html">Bug Report</a>
    <a href="/docs/code-of-conduct.html">Code of conduct</a>
    <a href="/docs/libs.html">Dependencies</a>
    <a href="/donation.html">Donate</a>
    <a href="/docs/faq.html">FAQ</a>
    <a href="/docs/features.html">Features</a>
    <a href="/docs/governance.html">Governance</a>
    <a href="/docs/history.html">History</a>
    <a href="/docs/install.html">Install</a>
    <a href="/docs/knownbugs.html">Known Bugs</a>
    <a href="/docs/todo.html">TODO</a>
    <a href="/about.html">Web Site Info</a>
  </div>
</div>
<div class="dropdown">
  <a class="dropbtn" href="/docs/protdocs.html">Protocols</a>
  <div class="dropdown-content">
    <a href="/docs/hsts.html">HSTS</a>
    <a href="/docs/http-cookies.html">HTTP cookies</a>
    <a href="/docs/http2.html">HTTP/2</a>
    <a href="/docs/http3.html">HTTP/3</a>
    <a href="/docs/mqtt.html">MQTT</a>
    <a href="/docs/sslcerts.html">SSL certs</a>
    <a href="/docs/caextract.html">CA Extract</a>
    <a href="/docs/ssl-compared.html">SSL libs compared</a>
    <a href="/docs/url-syntax.html">URL syntax</a>
  </div>
</div>
<div class="dropdown">
  <a class="dropbtn" href="/docs/reldocs.html">Releases</a>
  <div class="dropdown-content">
    <a href="/changes.html">Changelog</a>
    <a href="/docs/releases.html">Release Table</a>
    <a href="/docs/security.html">Security Problems</a>
    <a href="/docs/versions.html">Version Nums</a>
    <a href="/docs/vulnerabilities.html">Vulnerabilities</a>
  </div>
</div>
<div class="dropdown">
  <a class="dropbtn" href="/docs/tooldocs.html">Tool</a>
  <div class="dropdown-content">
    <a href="/docs/comparison-table.html">Comparison Table</a>
    <a href="/docs/manpage.html">curl man page</a>
    <a href="/docs/httpscripting.html">HTTP Scripting</a>
    <a href="/docs/mk-ca-bundle.html">mk-ca-bundle</a>
    <a href="/docs/manual.html">Tutorial</a>
  </div>
</div>
<div class="dropdown">
  <a class="dropbtn" href="/docs/whodocs.html">Who and Why</a>
  <div class="dropdown-content">
    <a href="/docs/companies.html">Companies</a>
    <a href="/docs/copyright.html">Copyright</a>
    <a href="/sponsors.html">Sponsors</a>
    <a href="/docs/thanks.html">Thanks</a>
    <a href="/docs/thename.html">The name</a>
  </div>
</div>
</div>
<div class="contents">
<div class="where"><a href="/">curl</a> / <a href="/docs/">Docs</a> / <a href="/docs/security.html">Security Problems</a> / <b>SMTP send heap buffer overflow</b></div>
<div class="relatedbox">
<b>Related:</b>
<br><a href="/docs/bugbounty.html">Bug Bounty</a>
<br><a href="/changes.html">Changelog</a>
<br><a href="/donation.html">Donate</a>
<br><a href="faq.html">FAQ</a>
<br><a href="security.html">Security Problems</a>
<br><a href="/dev/secprocess.html">Security Process</a>
<br><a href="vulnerabilities.html">Vulnerabilities Table</a>
</div>
<h1 id="smtp-send-heap-buffer-overflow">SMTP send heap buffer overflow</h1>
<p>Project curl Security Advisory, July 11th 2018 - <a href="https://curl.se/docs/CVE-2018-0500.html">Permalink</a></p>
<h2 id="vulnerability">VULNERABILITY</h2>
<p>curl might overflow a heap based memory buffer when sending data over SMTP and using a reduced read buffer.</p>
<p>When sending data over SMTP, curl allocates a separate &quot;scratch area&quot; on the heap to be able to escape the uploaded data properly if the uploaded data contains data that requires it.</p>
<p>The size of this temporary scratch area was mistakenly made to be <code>2 * sizeof(download_buffer)</code> when it should have been made <code>2 * sizeof(upload_buffer)</code>.</p>
<p>The upload and the download buffer sizes are identically sized by default (16KB) but since version <a href="vuln-7.54.1.html">7.54.1</a>, curl can resize the download buffer into a smaller buffer (as well as larger). If the download buffer size is set to a value smaller than 10923, the <code>Curl_smtp_escape_eob()</code> function might overflow the scratch buffer when sending contents of sufficient size and contents.</p>
<p>The curl command line tool lowers the buffer size when <code>--limit-rate</code> is set to a value smaller than 16KB.</p>
<p>We are not aware of any exploit of this flaw.</p>
<h2 id="test-cases">TEST CASES</h2>
<p>Here's a shell script</p>
<pre><code># Setup an SMTP end-point, make file, run curl
$ printf &#39;220 Hi\n250 SIZE 10000\n250 OK\n250 OK\n354 send data\n&#39; | nc -l -p 2525 &gt;/dev/null &amp;
$ printf &#39;%5000s&#39; &gt; mail.txt
$ curl -v smtp://localhost:2525 --mail-from me --mail-rcpt root@localhost --upload-file mail.txt --limit-rate 1024
</code></pre>
<p>PHP code:</p>
<pre><code>&lt;?php
$ch = curl_init();
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_URL.html">CURLOPT_URL</a>, &quot;smtp://localhost:2525&quot;);
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a>, 1024);
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_UPLOAD.html">CURLOPT_UPLOAD</a>, 1);
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_MAIL_FROM.html">CURLOPT_MAIL_FROM</a>, &quot;me&quot;);
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_MAIL_RCPT.html">CURLOPT_MAIL_RCPT</a>, [&quot;root@localhost&quot;]);
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_VERBOSE.html">CURLOPT_VERBOSE</a>, 1);
$eof = false;
curl_setopt($ch, <a href="https://curl.se/libcurl/c/CURLOPT_READFUNCTION.html">CURLOPT_READFUNCTION</a>, function($ch, $stream, $maxSize) {
    global $eof;
    echo &quot;Max Size: [$maxSize]\n&quot;;
    if ($eof) {
        return &quot;&quot;;
    }
    $eof = true;
    return str_repeat(&quot; &quot;, $maxSize);
});
curl_exec($ch);
curl_close($ch);
</code></pre>
<h2 id="info">INFO</h2>
<p>This bug was introduced in April 2017 in <a href="https://github.com/curl/curl/commit/e40e9d7f0decc79">this commit</a> when we introduced support for buffer resize. The scratch buffer was mistakenly made to use the dynamic size when it should kept using the fixed upload buffer size.</p>
<p>The Common Vulnerabilities and Exposures (CVE) project has assigned the name CVE-2018-0500 to this issue.</p>
<p>CWE-122: Heap-based Buffer Overflow</p>
<p>Severity: High</p>
<h2 id="affected-versions">AFFECTED VERSIONS</h2>
<ul>
<li>Affected versions: curl <a href="vuln-7.54.1.html">7.54.1</a> to and including curl <a href="vuln-7.60.0.html">7.60.0</a></li>
<li>Not affected versions: curl &lt; <a href="vuln-7.54.1.html">7.54.1</a> and curl &gt;= <a href="vuln-7.61.0.html">7.61.0</a></li>
</ul>
<p>libcurl is used by many applications, but not always advertised as such.</p>
<h2 id="the-solution">THE SOLUTION</h2>
<p>In curl version <a href="vuln-7.61.0.html">7.61.0</a>, curl will use the upload buffer size as base for the scratch area allocation.</p>
<p>A <a href="https://github.com/curl/curl/commit/ba1dbd78e5f1e.patch">patch for CVE-2018-0500</a> is available.</p>
<h2 id="recommendations">RECOMMENDATIONS</h2>
<p>We suggest you take one of the following actions immediately, in order of preference:</p>
<p>A - Upgrade curl to version <a href="vuln-7.61.0.html">7.61.0</a></p>
<p>B - Apply the patch to your version and rebuild</p>
<p>C - Avoid using SMTP uploads with <a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a> set below 10923</p>
<h2 id="time-line">TIME LINE</h2>
<p>It was reported to the curl project on June 11, 2018</p>
<p>We contacted distros@openwall on July 1, 2018.</p>
<p>curl <a href="vuln-7.61.0.html">7.61.0</a> was released on July 11 2018, coordinated with the publication of this advisory.</p>
<h2 id="credits">CREDITS</h2>
<p>Detected and researched by Peter Wu. Patch by Daniel Stenberg.</p>
<p>Thanks a lot!</p>
</div>
</div>
<script defer src="https://www.fastly-insights.com/insights.js?k=8cb1247c-87c2-4af9-9229-768b1990f90b" type="text/javascript"></script>
</body> </html>
