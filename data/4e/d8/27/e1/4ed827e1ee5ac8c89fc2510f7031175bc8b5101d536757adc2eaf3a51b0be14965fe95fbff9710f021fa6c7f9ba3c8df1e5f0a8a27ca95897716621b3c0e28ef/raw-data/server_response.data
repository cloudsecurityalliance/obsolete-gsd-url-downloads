<!DOCTYPE html>
<html lang="en">
  <head>
    <title>692492 &ndash; (CVE-2019-20384) sys-apps/portage: insecure temporary location (CVE-2019-20384)</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="data/assets/1dee87cdc229fb032852e53a39a3c8b5.css?1635279638" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1635279638"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 1000
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "692492 – (CVE-2019-20384) sys-apps\/portage: insecure temporary location (CVE-2019-20384)",
                             "show_bug.cgi?id=692492" );
        document.title = "692492 – (CVE-2019-20384) sys-apps\/portage: insecure temporary location (CVE-2019-20384)";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "692492 – (CVE-2019-20384) sys-apps\/portage: insecure temporary location (CVE-2019-20384)", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1635279638"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Gentoo's Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico"><script language="JavaScript" src="extensions/Gentoo/web/gentoo.js"></script>
  </head>

  <body 
        class="bugs-gentoo-org
                 bz_bug
                 bz_status_IN_PROGRESS
                 bz_product_Portage_Development
                 bz_component_Core
                 bz_bug_692492 yui-skin-sam">
<div id="gentoo-bar">
	<a href="/" title="Go to the Gentoo Bugzilla homepage" class="home-link">
		<img src="extensions/Gentoo/web/gentoo_org.png" alt="Gentoo Websites Logo" />
	</a>

	<div>
		Go to: 
		<a href="https://www.gentoo.org/">Gentoo Home</a>
		<a href="https://www.gentoo.org/support/documentation/">Documentation</a>
		<a href="https://forums.gentoo.org/">Forums</a>
		<a href="https://www.gentoo.org/get-involved/mailing-lists/">Lists</a>
		<a href="/" class="active">Bugs</a>
		<a href="https://planet.gentoo.org/">Planet</a>
		<a href="https://www.gentoo.org/inside-gentoo/stores/">Store</a>
		<a href="https://wiki.gentoo.org/">Wiki</a>
		<strong><a href="https://www.gentoo.org/downloads/">Get Gentoo!</a></strong>
	</div>
</div>

  <div id="header"><div id="banner">
  </div>

    <div id="titles">
      <span id="title">Gentoo's Bugzilla &ndash; Bug&nbsp;692492</span>

        <span id="subtitle" class="subheader">sys-apps/portage: insecure temporary location (CVE-2019-20384)</span>

        <span id="information" class="header_addl_info">Last modified: 2021-06-15 16:03:36 UTC node [gannet]</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi?format=guided">New</a>&ndash;<a href="enter_bug.cgi">[Ex]</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>
  <li><span class="separator">| </span><a href="https://wiki.gentoo.org/wiki/Foundation:Privacy_Policy">Privacy Policy</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="show_bug.cgi?id=692492&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>

  <form action="show_bug.cgi?id=692492" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_top">
    <input id="Bugzilla_login_top" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_top" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_top">
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>


  <li id="forgot_container_top">
    <span class="separator">| </span>
    <a id="forgot_link_top" href="show_bug.cgi?id=692492&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_top')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_top"
          class="mini_forgot bz_default_hidden">
      <label for="login_top">Login:</label>
      <input name="loginname" size="20" id="login_top" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_top" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_top" name="token"
             value="1635619191-DZwoyxg1U1zwezl7cfn9sKJRaxCJfv2JU6DVXlwGG4I">
      <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
    </form>
  </li>
</ul>
    </div>
  </div>

  <div id="bugzilla-body"><!--<div style="border: 1px solid #ebccd1; background-color: #f2dede; color: #a94442; padding: 0.4em; margin-bottom: 0.4em;">critical goes here ...</div>-->
<!--<div id="message">
Bugzilla DB migration completed. Please report issues to Infra team via email via infra@gentoo.org or IRC
</div>-->


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2021-06-15 16:03:36">
  <input type="hidden" name="id" value="692492">
  <input type="hidden" name="token" value="1635619191-YkzBe3Tuyr88LQpighEoQsUu_uZVL4qZgMLcdvZ_khY">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=692492"><b>Bug&nbsp;692492</b></a> <span id="summary_container" class="bz_default_hidden">
        (<span id="alias_nonedit_display">CVE-2019-20384</span>)
      - <span id="short_desc_nonedit_display">sys-apps/portage: insecure temporary location (CVE-2019-20384)</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>sys-apps/portage: insecure temporary location (CVE-2019-20384)
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'sys-apps\/portage: insecure temporary location (CVE-2019-20384)' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">IN_PROGRESS
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>CVE-2019-20384
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Portage Development

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=Portage Development"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >Core

  (<a href="buglist.cgi?component=Core&amp;product=Portage%20Development&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">All
        Linux
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>Normal
       normal<span id="votes_container">
    (<a href="page.cgi?id=voting/user.html&amp;bug_id=692492#vote_692492">vote</a>)
  </span>
      </td>
    </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Portage team</span>
</span>
      </td>
    </tr>

    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'dev-portage\x40gentoo.org',
        '');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>

    <tr><th class="field_label "
    id="field_label_status_whiteboard">


  <a 
      title="Each bug has a free-form single line text entry box for adding tags and status information."
      class="field_help_link"
      href="page.cgi?id=fields.html#status_whiteboard"
  >Whiteboard:</a>

</th><td>  
  </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >InVCS

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
<a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - [TRACKER] sys-apps/portage-2.3.99-r2"
   href="show_bug.cgi?id=711148">711148</a> 
  </td>
  </tr>

    <tr>
      <th>&nbsp;</th>

      <td id="show_dependency_tree_or_graph">
        Show dependency <a href="showdependencytree.cgi?id=692492&amp;hide_resolved=1">tree</a>

      </td>
    </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2019-08-19 01:54 UTC by <span class="vcard"><span class="fn">Michael Orlitzky</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2021-06-15 16:03 UTC
      (<a href="show_activity.cgi?id=692492">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>6 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="flow">flow</option>
                <option value="hanno">hanno</option>
                <option value="kfm">kfm</option>
                <option value="nobrowser">nobrowser</option>
                <option value="sam">sam</option>
                <option value="security">security</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 
<tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_stabilisation_atoms">


  <a 
      title="Contains a list of packages (and optionally, architectures) to keyword or stabilize. One fully qualified package per line, optionally followed by a space-delimited list of architectures for that package."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_stabilisation_atoms"
  >Package list:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_stabilisation_atoms" >
      <div class="uneditable_textarea"></div>

</td>
    </tr>
    <tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_runtime_testing_required">


  <a 
      title="Indicate if runtime testing is required for this stabilisation request, or if it is sufficient to stabilised with a build/tests/qa test."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_runtime_testing_required"
  >Runtime testing required:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_runtime_testing_required" >---

</td>
    </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="2" class="left">
      Attachments
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
        <a href="attachment.cgi?bugid=692492&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>
<div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=692492&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js?1635279621" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Michael Orlitzky</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2019-08-19 01:54:03 UTC
        </span>

      </div>




<pre class="bz_comment_text">Ebuilds do a lot of unsafe things in the src_* phases. In particular, they call chown/chmod via fowners/fperms on paths that may be user-controlled, and they install files (as root) from user-controlled paths. The ebuild author may not even be aware that these paths are user-controlled; many build systems set weird permissions on paths like /usr or /var (in $D) that are then ignored by src_install(), which ultimately has no visible effect on the live filesystem.

For an example of the latter situation, consider the still-unfixed CVE-2017-14312. A natural solution to that problem is to call &quot;fowners&quot; on the executables, to make them root:root again. But doing so leaves a substantial about of time where those executables are writable by the unprivileged user.

Which brings me to the point of this bug report: the temporary location that portage uses for its installation image is predictable, and it's fairly easy for a long-running unprivileged daemon to gain root by messing with /var/tmp/portage/&lt;predictable-path&gt;.

For a proof of concept, I can use my own nagios-core package. First we modify the ebuild to make it easy to exploit interactively,

        emake DESTDIR=&quot;${D}&quot; install-basic
+       echo &quot;${D}/usr/$(get_libdir)/nagios/plugins vulnerable, sleeping...&quot;
+       sleep 15
+       echo &quot;Fixing ownership on ${D}/usr/$(get_libdir)/nagios/plugins.&quot;
        fowners root:root /usr/$(get_libdir)/nagios/plugins

and then during that sleep interval,

$ sudo su -s /bin/sh nagios -c 'touch /var/tmp/portage/net-analyzer/nagios-core-4.4.4/image/usr/lib64/nagios/plugins/exploit.txt'

This leads to the exploit.txt being installed to a root-owned location:

  ...
  &gt;&gt;&gt; /usr/lib64/nagios/cgi-bin/tac.cgi
  &gt;&gt;&gt; /usr/lib64/nagios/cgi-bin/extinfo.cgi
  &gt;&gt;&gt; /usr/lib64/nagios/cgi-bin/config.cgi
  --- /usr/lib64/nagios/plugins/
  &gt;&gt;&gt; /usr/lib64/nagios/plugins/exploit.txt

This is a mild example, but is still pretty bad because that plugin directory is akin to /usr/bin for nagios users. If I made exploit.txt look legitimate and executable, root could conceivably run it. With some imagination, you can trick many ebuilds (especially with fowners) into giving you root directly.

Ultimately this is the fault of the ebuild: developers should know that when they're manipulating the installation image, they're doing it as root, and that all of the usual precautions apply. But, it's naive to rely on hundreds of developers to be so meticulous. It's also impractical: to fix the proof-of-concept above, I have to reimplement the &quot;make install&quot; command that installs the plugins, and I don't want to do that.

Portage is in a position to mitigate this entire class of vulnerabilities by e.g. making the temporary location unpredictable.</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Zac Medico</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2019-08-19 02:16:45 UTC
        </span>

      </div>




<pre class="bz_comment_text">Using an entirely unpredictable location would be problematic for current behavior of the ebuild(1) command since it can be invoked multiple times with the intention of operating on a predictable location.

How about if we set secure permissions on the parent directory? We've already got a secure default PORTAGE_WORKDIR_MODE=&quot;0700&quot; setting that applies to ${WORKDIR}, and we could apply it to the parent directory.</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Michael Orlitzky</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2019-08-19 02:25:23 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Zac Medico from <a href="show_bug.cgi?id=692492#c1">comment #1</a>)
<span class="quote">&gt; 
&gt; How about if we set secure permissions on the parent directory? We've
&gt; already got a secure default PORTAGE_WORKDIR_MODE=&quot;0700&quot; setting that
&gt; applies to ${WORKDIR}, and we could apply it to the parent directory.</span >

I think that should work too.</pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Daniel Robbins</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2020-01-21 05:13:07 UTC
        </span>

      </div>




<pre class="bz_comment_text">Couldn't the permissions of /var/tmp/portage simply be changed to deny all access to 'other' (chmod o-rwx)? This would deny access of arbitrary accounts to anything inside /var/tmp/portage.

The would limit access to the portage user and the portage group, which is generally much more tightly controlled and 'trusted'.</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Zac Medico</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2020-01-21 05:27:09 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Daniel Robbins from <a href="show_bug.cgi?id=692492#c3">comment #3</a>)
<span class="quote">&gt; Couldn't the permissions of /var/tmp/portage simply be changed to deny all
&gt; access to 'other' (chmod o-rwx)? This would deny access of arbitrary
&gt; accounts to anything inside /var/tmp/portage.
&gt; 
&gt; The would limit access to the portage user and the portage group, which is
&gt; generally much more tightly controlled and 'trusted'.</span >

Sure, that will give similar protection to the PORTAGE_WORKDIR_MODE approach from <a href="show_bug.cgi?id=692492#c1">comment #1</a>. I can't think of a reason not to apply PORTAGE_WORKDIR_MODE to PORTAGE_TMPDIR.</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Zac Medico</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2020-03-15 00:56:40 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Zac Medico from <a href="show_bug.cgi?id=692492#c4">comment #4</a>)
<span class="quote">&gt; (In reply to Daniel Robbins from <a href="show_bug.cgi?id=692492#c3">comment #3</a>)
&gt; &gt; Couldn't the permissions of /var/tmp/portage simply be changed to deny all
&gt; &gt; access to 'other' (chmod o-rwx)? This would deny access of arbitrary
&gt; &gt; accounts to anything inside /var/tmp/portage.
&gt; &gt; 
&gt; &gt; The would limit access to the portage user and the portage group, which is
&gt; &gt; generally much more tightly controlled and 'trusted'.
&gt; 
&gt; Sure, that will give similar protection to the PORTAGE_WORKDIR_MODE approach
&gt; from <a href="show_bug.cgi?id=692492#c1">comment #1</a>. I can't think of a reason not to apply PORTAGE_WORKDIR_MODE
&gt; to PORTAGE_TMPDIR.</span >

Actually, the default PORTAGE_WORKDIR_MODE=&quot;0700&quot; setting is a little too restrictive for PORTAGE_TMPDIR, since normally this directory is writable by trusted users in the portage group.

This patch will apply PORTAGE_WORKDIR_MODE to the PORTAGE_BUILDDIR parent directory, as suggested in <a href="show_bug.cgi?id=692492#c1">comment #1</a>:

<a href="https://archives.gentoo.org/gentoo-portage-dev/message/4aed84c475a00594be4d53ef94643220">https://archives.gentoo.org/gentoo-portage-dev/message/4aed84c475a00594be4d53ef94643220</a>
<a href="https://github.com/gentoo/portage/pull/533">https://github.com/gentoo/portage/pull/533</a></pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Larry the Git Cow</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2020-03-15 01:24:34 UTC
        </span>

      </div>




<pre class="bz_comment_text">The bug has been referenced in the following commit(s):

<a href="https://gitweb.gentoo.org/proj/portage.git/commit/?id=ef8c21e59953aa5fdd153f19b7bf04356e2164fe">https://gitweb.gentoo.org/proj/portage.git/commit/?id=ef8c21e59953aa5fdd153f19b7bf04356e2164fe</a>

commit ef8c21e59953aa5fdd153f19b7bf04356e2164fe
Author:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
AuthorDate: 2020-03-15 00:01:25 +0000
Commit:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
CommitDate: 2020-03-15 00:42:43 +0000

    _prepare_workdir: apply PORTAGE_WORKDIR_MODE to PORTAGE_BUILDDIR (<a class="bz_bug_link 
          bz_status_IN_PROGRESS "
   title="IN_PROGRESS - sys-apps/portage: insecure temporary location (CVE-2019-20384)"
   href="show_bug.cgi?id=692492">bug 692492</a>)
    
    Apply secure PORTAGE_WORKDIR_MODE permissions to PORTAGE_BUILDDIR,
    since the child directory ${D} and its children may have vulnerable
    permissions as reported in <a class="bz_bug_link 
          bz_status_IN_PROGRESS "
   title="IN_PROGRESS - sys-apps/portage: insecure temporary location (CVE-2019-20384)"
   href="show_bug.cgi?id=692492">bug 692492</a>.
    
    Bug: <a href="https://bugs.gentoo.org/692492">https://bugs.gentoo.org/692492</a>
    Signed-off-by: Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;

 lib/portage/package/ebuild/prepare_build_dirs.py | 21 ++++++++++++++-------
 1 file changed, 14 insertions(+), 7 deletions(-)</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Larry the Git Cow</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2020-03-15 01:29:35 UTC
        </span>

      </div>




<pre class="bz_comment_text">The bug has been referenced in the following commit(s):

<a href="https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=729dc030f6b318f84ca6336c7bd7dddaa7e48040">https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=729dc030f6b318f84ca6336c7bd7dddaa7e48040</a>

commit 729dc030f6b318f84ca6336c7bd7dddaa7e48040
Author:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
AuthorDate: 2020-03-15 01:23:23 +0000
Commit:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
CommitDate: 2020-03-15 01:29:25 +0000

    sys-apps/portage: Bump to version 2.3.94
    
     #692492 secure ebuild ${D} permissions
     #710444 omit zstd --long=31 for decompress on 32-bit arch
     #712298 respect emerge --deep=&lt;depth&gt; with --update
    
    Bug: <a href="https://bugs.gentoo.org/711148">https://bugs.gentoo.org/711148</a>
    Bug: <a href="https://bugs.gentoo.org/692492">https://bugs.gentoo.org/692492</a>
    Bug: <a href="https://bugs.gentoo.org/710444">https://bugs.gentoo.org/710444</a>
    Bug: <a href="https://bugs.gentoo.org/712298">https://bugs.gentoo.org/712298</a>
    Package-Manager: Portage-2.3.94, Repoman-2.3.20
    Signed-off-by: Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;

 sys-apps/portage/Manifest              |   1 +
 sys-apps/portage/portage-2.3.94.ebuild | 271 +++++++++++++++++++++++++++++++++
 2 files changed, 272 insertions(+)</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Larry the Git Cow</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="https://bugs.gentoo.org/images/ranks/bugs-rank-dev.png"
                 alt="gentoo-dev"
                 title="gentoo-dev - Gentoo Developers">
        </span>

        <span class="bz_comment_time">
          2020-05-25 00:45:49 UTC
        </span>

      </div>




<pre class="bz_comment_text">The bug has been referenced in the following commit(s):

<a href="https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=7f03ec4a46055a75eb13bf5fad85cf451822f589">https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=7f03ec4a46055a75eb13bf5fad85cf451822f589</a>

commit 7f03ec4a46055a75eb13bf5fad85cf451822f589
Author:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
AuthorDate: 2020-05-25 00:43:07 +0000
Commit:     Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;
CommitDate: 2020-05-25 00:43:23 +0000

    sys-apps/portage: Remove vulnerable 2.3.89-r3 for <a class="bz_bug_link 
          bz_status_IN_PROGRESS "
   title="IN_PROGRESS - sys-apps/portage: insecure temporary location (CVE-2019-20384)"
   href="show_bug.cgi?id=692492">bug 692492</a>
    
    Bug: <a href="https://bugs.gentoo.org/692492">https://bugs.gentoo.org/692492</a>
    Package-Manager: Portage-2.3.100, Repoman-2.3.22
    Signed-off-by: Zac Medico &lt;<a href="mailto:zmedico&#64;gentoo.org">zmedico&#64;gentoo.org</a>&gt;

 sys-apps/portage/Manifest                 |   1 -
 sys-apps/portage/portage-2.3.89-r3.ebuild | 271 ------------------------------
 2 files changed, 272 deletions(-)</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=692492">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=692492">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=692492">Clone This Bug</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=692492&product=Portage%20Development">Clone In The Same 
                        Product</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi?format=guided">New</a>&ndash;<a href="enter_bug.cgi">[Ex]</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>
  <li><span class="separator">| </span><a href="https://wiki.gentoo.org/wiki/Foundation:Privacy_Policy">Privacy Policy</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="show_bug.cgi?id=692492&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>

  <form action="show_bug.cgi?id=692492" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_bottom">
    <input id="Bugzilla_login_bottom" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_bottom" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_bottom">
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>


  <li id="forgot_container_bottom">
    <span class="separator">| </span>
    <a id="forgot_link_bottom" href="show_bug.cgi?id=692492&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_bottom')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_bottom"
          class="mini_forgot bz_default_hidden">
      <label for="login_bottom">Login:</label>
      <input name="loginname" size="20" id="login_bottom" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_bottom" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_bottom" name="token"
             value="1635619191-DZwoyxg1U1zwezl7cfn9sKJRaxCJfv2JU6DVXlwGG4I">
      <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
    </form>
  </li>
</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>

  </body>
</html>