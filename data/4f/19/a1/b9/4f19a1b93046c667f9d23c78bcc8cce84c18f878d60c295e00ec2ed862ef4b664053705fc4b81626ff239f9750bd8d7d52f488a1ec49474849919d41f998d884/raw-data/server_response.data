<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/ubuntu/+source/unzip/+bug/580961/comments/120/+index" />

    <meta charset="UTF-8" />
    <title>Comment #120 : Bug #580961 : Bugs : unzip package : Ubuntu</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    
    
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="I found a bug in this iconv patch: 04-unzip60-alt-iconv-utf8.
The problem is, this patch allocate buffer( which is for storing converted string ) twice the size of source string plus one byte.
As seen in line 81-84 of the patch.

+    slen = strlen(string);
+    s = string;
+    dlen = buflen = 2*slen;
+    d = buf = malloc(buflen + 1);

This cause conversion fails for some cases.
Because, in some character encodings, it requires more than twice the storage to represent a given character in o..." />
      <meta property="og:description" content="I found a bug in this iconv patch: 04-unzip60-alt-iconv-utf8.
The problem is, this patch allocate buffer( which is for storing converted string ) twice the size of source string plus one byte.
As seen in line 81-84 of the patch.

+    slen = strlen(string);
+    s = string;
+    dlen = buflen = 2*slen;
+    d = buf = malloc(buflen + 1);

This cause conversion fails for some cases.
Because, in some character encodings, it requires more than twice the storage to represent a given character in o..." />
    

    
    
      <meta property="og:title" content="Comment #120 : Bug #580961 : Bugs : unzip package : Ubuntu" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/ubuntu/+source/unzip/+bug/580961/comments/120/+index" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_only
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/ubuntu/+source/unzip/+bug/580961/comments/120/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/ubuntu"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/49558155/64_logo.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/ubuntu">Ubuntu</a><br /><a href="https://launchpad.net/ubuntu/+source/unzip">unzip package</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/ubuntu/+source/unzip">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/ubuntu/+source/unzip">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/ubuntu/+source/unzip">Bugs</a></li>
      
      
    
    
      
      
      <li class="specifications disabled-tab"><span>Blueprints</span></li>
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/ubuntu/+source/unzip">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/ubuntu/+source/unzip">Answers</a></li>
      
    
  </ul>

      </div>

      
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
              <ol itemprop="breadcrumb" class="breadcrumbs">


  <li>
    <a href="https://bugs.launchpad.net/ubuntu/+source/unzip/+bug/580961">Bug #580961</a>
  </li>


  <li>
    Comment #120
  </li>

</ol>

              <div id="registration" class="registering">
                
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div itemprop="mainContentOfPage">
      <h1>Comment 120 for bug 580961</h1>
      <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/unzip/+bug/580961/comments/120" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~boostcpp" class="sprite person">ryou ezoe (boostcpp)</a>
            wrote
            <time itemprop="commentTime" datetime="2012-04-04T21:00:05.978111+00:00" title="2012-04-04 21:00:05 UTC">on 2012-04-04</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/unzip/+bug/580961/comments/120"> #120</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I found a bug in this iconv patch: 04-unzip60-<wbr />alt-iconv-<wbr />utf8.<br />
The problem is, this patch allocate buffer( which is for storing converted string ) twice the size of source string plus one byte.<br />
As seen in line 81-84 of the patch.</p>
<p>+    slen = strlen(string);<br />
+    s = string;<br />
+    dlen = buflen = 2*slen;<br />
+    d = buf = malloc(buflen + 1);</p>
<p>This cause conversion fails for some cases.<br />
Because, in some character encodings, it requires more than twice the storage to represent a given character in other encodings(<wbr />especially UTF-8, Ubuntu&#x27;s default encoding).</p>
<p>For example, There are characters HALFWIDTH KATAKANA LETTER.<br />
In SHIFT_JIS and CP932 encoding, halfwidth  katakana letters are represented in one octet.<br />
But, in UTF-8, it requires three octets.</p>
<p>For example,<br />
&#x27;ｱ&#x27; ( U+FF71: HALFWIDTH KATAKANA LETTER A)<br />
is encoded to 0xB1 in Shift_JIS and CP932.<br />
This is one octet.<br />
But in UTF-8, it is encoded to 0xEF, 0xBD, 0xB1.<br />
This is three octets.</p>
<p>So, because current unzip just allocate twice the size of source string for buffer, it fails to handle zip file containing a file name  consisting all or a lot of half width katakana letter.</p>
<p>I suggest to change the size of buffer, four times the size of source string plus one byte.<br />
Because, Ubuntu&#x27;s default encoding is UTF-8 and the largest valid UTF-8 sequence of one character is 4 octet.</p>
<p>replace the line 83 of 04-unzip60-<wbr />alt-iconv-<wbr />utf8 to the following:<br />
+    dlen = buflen = 4*slen;</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I found a bug in this iconv patch: 04-unzip60-alt-iconv-utf8.
The problem is, this patch allocate buffer( which is for storing converted string ) twice the size of source string plus one byte.
As seen in line 81-84 of the patch.

+    slen = strlen(string);
+    s = string;
+    dlen = buflen = 2*slen;
+    d = buf = malloc(buflen + 1);

This cause conversion fails for some cases.
Because, in some character encodings, it requires more than twice the storage to represent a given character in other encodings(especially UTF-8, Ubuntu's default encoding).

For example, There are characters HALFWIDTH KATAKANA LETTER.
In SHIFT_JIS and CP932 encoding, halfwidth  katakana letters are represented in one octet.
But, in UTF-8, it requires three octets.

For example, 
'ｱ' ( U+FF71: HALFWIDTH KATAKANA LETTER A)
is encoded to 0xB1 in Shift_JIS and CP932.
This is one octet.
But in UTF-8, it is encoded to 0xEF, 0xBD, 0xB1.
This is three octets.

So, because current unzip just allocate twice the size of source string for buffer, it fails to handle zip file containing a file name  consisting all or a lot of half width katakana letter.

I suggest to change the size of buffer, four times the size of source string plus one byte.
Because, Ubuntu's default encoding is UTF-8 and the largest valid UTF-8 sequence of one character is 4 octet.

replace the line 83 of 04-unzip60-alt-iconv-utf8 to the following: 
+    dlen = buflen = 4*slen;
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <!-- yui-b side -->
        
      <!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"context": {"self_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/unzip/+bug/580961", "web_link": "https://bugs.launchpad.net/ubuntu/+source/unzip/+bug/580961", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/580961", "milestone_link": null, "status": "Fix Released", "importance": "Critical", "assignee_link": null, "bug_target_display_name": "unzip (Ubuntu)", "bug_target_name": "unzip (Ubuntu)", "bug_watch_link": null, "date_assigned": null, "date_created": "2010-05-15T13:45:05.840207+00:00", "date_confirmed": "2011-05-24T20:08:41.467385+00:00", "date_incomplete": null, "date_in_progress": "2014-02-02T18:38:41.287142+00:00", "date_closed": "2014-02-02T18:38:41.287142+00:00", "date_left_new": "2010-05-15T13:45:39.595924+00:00", "date_triaged": "2011-05-24T20:08:41.467385+00:00", "date_fix_committed": "2014-02-02T18:38:41.287142+00:00", "date_fix_released": "2014-02-02T18:38:41.287142+00:00", "date_left_closed": "2011-05-12T12:35:27.204375+00:00", "owner_link": "https://bugs.launchpad.net/api/devel/~r0lf", "target_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/unzip", "title": "Bug #580961 in unzip (Ubuntu): \"unzip fails to deal correctly with filename encodings\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/unzip/+bug/580961/related_tasks", "is_complete": true, "http_etag": "\"a893a44aa73a5ba0e3c5ccb5305d58a9983775cd-633a5537e45aaaa71ea680f2a827c2e66eee1fef\""}, "related_features": {}};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_only
    Has global search: True
    Has application tabs: True
    Has side portlets: False

    At least 20 queries/external actions issued in 0.31 seconds

    Features: {'js.yui_version': None, 'hard_timeout': '9000', 'baselayout.careers_link.disabled': None, 'profiling.enabled': None, 'app.mainsite_only.canonical_url': None, 'app.maintenance_message': None, 'visible_render_time': None}

    r0d8de2b

    -->

</html>

