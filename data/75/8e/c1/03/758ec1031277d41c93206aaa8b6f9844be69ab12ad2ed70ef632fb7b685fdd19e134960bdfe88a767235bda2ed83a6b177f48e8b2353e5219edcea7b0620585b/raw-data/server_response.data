<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #54681 - RDF' href='rss/bug.php?id=54681'>
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #54681 - RSS 2.0' href='rss/bug.php?id=54681&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #54681 :: addGlob() crashes on invalid flags</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=54681">Sec Bug</a>&nbsp;#54681</th>
            <td id="summary" colspan="5">addGlob() crashes on invalid flags</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2011-05-07 00:58 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2011-08-22 11:44 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>cxib &#x61;&#116; securityreason &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=pajoye">pajoye</a> (<a href="https://people.php.net/pajoye">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AGeneral+Issues">*General Issues</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.3.6</td>
            <th class="details">OS:</th>
            <td>NetBSD</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=54681&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=54681&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=54681&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1304729915">&nbsp;</a><strong>[2011-05-07 00:58 UTC] cxib &#x61;&#116; securityreason &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
For first function addGlob and addPattern are not described in manual
<a href="http://pl2.php.net/manual/en/class.ziparchive.php" rel="nofollow">http://pl2.php.net/manual/en/class.ziparchive.php</a>

ext/zip/php_zip.c
1629 	/* 1 == glob, 2==pcre */
1630 	if (type == 1) {
1631 	if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;s|la&quot;,
1632 	&amp;pattern, &amp;pattern_len, &amp;flags, &amp;options) == FAILURE) {
1633 	return;
1634 	}
1635 	} else {
1636 	if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;s|sa&quot;,
1637 	&amp;pattern, &amp;pattern_len, &amp;path, &amp;path_len, &amp;options) == FAILURE) {
1638 	return;
1639 	}
1640 	}
1641

There are no GLOB flags validation like in php/glob(). So limit flags only to
GLOB_MARK|GLOB_NOSORT|GLOB_NOCHECK|GLOB_NOESCAPE|GLOB_BRACE|GLOB_ONLYDIR|GLOB_ERR

like
<a href="http://pl2.php.net/manual/en/function.glob.php" rel="nofollow">http://pl2.php.net/manual/en/function.glob.php</a>

    * GLOB_MARK - Adds a slash to each directory returned
    * GLOB_NOSORT - Return files as they appear in the directory (no
sorting)
    * GLOB_NOCHECK - Return the search pattern if no files matching it
were found
    * GLOB_NOESCAPE - Backslashes do not quote metacharacters
    * GLOB_BRACE - Expands {a,b,c} to match 'a', 'b', or 'c'
    * GLOB_ONLYDIR - Return only directory entries which match the pattern
    * GLOB_ERR - Stop on read errors (like unreadable directories), by
default errors are ignored.



Test script:
---------------
The crash come, when we run libc/glob(3) function with incorrect flag.
Tested also on linux/ubuntu and (netbsd)

cx@cx64:~$ php -v
PHP 5.3.3-1ubuntu9.3 with Suhosin-Patch (cli) (built: Jan 12 2011 16:07:38)
Copyright (c) 1997-2009 The PHP Group
Zend Engine v2.3.0, Copyright (c) 1998-2010 Zend Technologies
cx@cx64:~$ uname -a
Linux cx64 2.6.35-28-generic #49-Ubuntu SMP Tue Mar 1 14:39:03 UTC 2011
x86_64 GNU/Linux
cx@cx64:/www$ cat zip.php
&lt;?php

unlink(&quot;empty.zip&quot;);

fopen(&quot;empty.zip&quot;,&quot;a&quot;);

$nx=new
ZipArchive();$nx-&gt;open(&quot;empty.zip&quot;);$nx-&gt;addGlob(str_repeat(&quot;*&quot;,333333),0x39);
?&gt;cx@cx64:/www$ php zip.php
Segmentation fault

Actual result:
--------------
Segmentation fault

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=54681'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=54681'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1304730046">&nbsp;</a><strong>[2011-05-07 01:00 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type:           Bug</span>
<span class="added">+Type:           Security</span>
<span class="removed">-Private report: No</span>
<span class="added">+Private report: Yes</span>
</div></div></div><div class='comment type_comment' ><a name="1304731638">&nbsp;</a><strong>[2011-05-07 01:27 UTC] cxib &#x61;&#116; securityreason &#x64;&#111;&#x74; com</strong>
<pre class='note'>use CVE-2011-1657
</pre>
</div><div class='comment type_log' ><a name="1304735172">&nbsp;</a><strong>[2011-05-07 02:26 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Assigned</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: pajoye</span>
</div></div></div><div class='comment type_log' ><a name="1304735208">&nbsp;</a><strong>[2011-05-07 02:26 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2011-1657</span>
</div></div></div><div class='comment type_log' ><a name="1304740698">&nbsp;</a><strong>[2011-05-07 03:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: addGlob addPattern buffer overflow</span>
<span class="added">+Summary: addGlob() crashes on invalid flags</span>
</div></div></div><div class='comment type_comment' ><a name="1304740698">&nbsp;</a><strong>[2011-05-07 03:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<pre class='note'>Hi, this is not a buffer overflow issue. But an error on glob() due the invalid (or unsupported) flags.

Anyway, the checks from glob() were added in the addGlob() method.


Thanks.
</pre>
</div><div class='comment type_svn' ><a name="1304740708">&nbsp;</a><strong>[2011-05-07 03:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of felipe
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=310814" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=310814</a>
Log: - Fixed <a href='bug.php?id=54681'>bug #54681</a> (addGlob() crashes on invalid flags)
</pre>
</div><div class='comment type_log' ><a name="1304740718">&nbsp;</a><strong>[2011-05-07 03:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1304740718">&nbsp;</a><strong>[2011-05-07 03:58 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<pre class='note'>This bug has been fixed in SVN.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_svn' ><a name="1304740754">&nbsp;</a><strong>[2011-05-07 03:59 UTC] <a href="//people.php.net/felipe">felipe@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of felipe
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=310815" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=310815</a>
Log: - BFN #54681
</pre>
</div><div class='comment type_comment' ><a name="1304802996">&nbsp;</a><strong>[2011-05-07 21:16 UTC] cxib &#x61;&#116; securityreason &#x64;&#111;&#x74; com</strong>
<pre class='note'>I agree with you that the issue is due the invalid (or unsupported) flags. Consequently, it can lead to many others symptoms. With glob(3) function in linux, we can get stack exhaustion like was discovered in fnmatch/php. 

<a href="http://svn.php.net/viewvc?view=revision&amp;revision=298881" rel="nofollow">http://svn.php.net/viewvc?view=revision&amp;revision=298881</a>

However, in my opinion, the GNU was responsible for this bug. Not PHP. 

There is a big difference between glob (3) in the Linux and BSD. However, uncontrolled 'flag' parameter to the function glob in both cases will generate different susceptibility.

Thanks for fix
</pre>
</div><div class='comment type_comment' ><a name="1313851929">&nbsp;</a><strong>[2011-08-20 14:52 UTC] max &#x61;&#116; cxib &#x64;&#111;&#x74; net</strong>
<pre class='note'>poc

<a href="http://pastebin.com/RTmWQaDY" rel="nofollow">http://pastebin.com/RTmWQaDY</a>
</pre>
</div><div class='comment type_comment' ><a name="1313927663">&nbsp;</a><strong>[2011-08-21 11:54 UTC] <a href="//people.php.net/pajoye">pajoye@php.net</a></strong>
<pre class='note'>@max at cxib dot net

Still happening with the fix?
</pre>
</div><div class='comment type_comment' ><a name="1314013493">&nbsp;</a><strong>[2011-08-22 11:44 UTC] cxib &#x61;&#116; securityreason &#x64;&#111;&#x74; com</strong>
<pre class='note'>no. just reported poc to confirm security problem under bsd
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
