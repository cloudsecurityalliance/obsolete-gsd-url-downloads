<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*URL Functions Bug #79329 - RDF' href='rss/bug.php?id=79329'>
        <link rel='alternate' type='application/rss+xml' title='*URL Functions Bug #79329 - RSS 2.0' href='rss/bug.php?id=79329&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #79329 :: get_headers() silently truncates after a null byte</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=79329">Sec Bug</a>&nbsp;#79329</th>
            <td id="summary" colspan="5">get_headers() silently truncates after a null byte</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2020-03-01 18:40 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2020-03-17 05:39 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>64796c6e69 &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AURL+Functions">*URL Functions</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>Irrelevant</td>
            <th class="details">OS:</th>
            <td>any</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7066" target="_blank">2020-7066</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=79329&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=79329&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=79329&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1583088030">&nbsp;</a><strong>[2020-03-01 18:40 UTC] 64796c6e69 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
get_headers() silently truncates anything after a null byte in the URL it uses.

This was tested on PHP 7.3, but the function has always had this bug.

The test script shows that this can cause well-written scripts to get headers for an unexpected domain. Those headers could leak sensitive information or unexpectedly contain attacker-controlled data.

Test script:
---------------
&lt;?php
// user input
$_GET['url'] = &quot;<a href="http://localhost\0.example.com&quot;;" rel="nofollow">http://localhost\0.example.com&quot;;</a>

$host = parse_url($_GET['url'], PHP_URL_HOST);
if (substr($host, -12) !== '.example.com') {
    die();
}
$headers = get_headers($_GET['url']);
var_dump($headers);

Expected result:
----------------
Warning: get_headers() expects parameter 1 to be a valid path, string given in php shell code on line 1
NULL

Actual result:
--------------
headers from <a href="http://localhost" rel="nofollow">http://localhost</a>

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=79329'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=79329'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1583138013">&nbsp;</a><strong>[2020-03-02 08:33 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1583138013">&nbsp;</a><strong>[2020-03-02 08:33 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, get_headers()'s $url has to be a valid path, because we're
passing it to php_stream_open_wrapper_ex().


 ext/standard/url.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/ext/standard/url.c b/ext/standard/url.c
index 57fd80cc1d..fe6d7f9de1 100644
--- a/ext/standard/url.c
+++ b/ext/standard/url.c
@@ -680,7 +680,7 @@ PHP_FUNCTION(get_headers)
 	php_stream_context *context;
 
 	ZEND_PARSE_PARAMETERS_START(1, 3)
-		Z_PARAM_STRING(url, url_len)
+		Z_PARAM_PATH(url, url_len)
 		Z_PARAM_OPTIONAL
 		Z_PARAM_LONG(format)
 		Z_PARAM_RESOURCE_EX(zcontext, 1, 0)


I don't see the need for an regression test (ZPP only).
</pre>
</div><div class='comment type_comment' ><a name="1583173928">&nbsp;</a><strong>[2020-03-02 18:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Note: the code in the test script is in no way secure. parse_url() does not guarantee the resulting URL is valid (or even HTTP URL) - it just tries its best to parse it in assumption it's valid. If you need URL validation (as you should if you importing external URLs) other methods should be used. 

That said. no reason for get_headers() to accept URLs with nulls, so it shouldn't.
</pre>
</div><div class='comment type_comment' ><a name="1583174897">&nbsp;</a><strong>[2020-03-02 18:48 UTC] 64796c6e69 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>@stas That's true. I may have oversimplified the example. My main point to get across was that even if validation exists, it wouldn't necessarily check the subdomain using a whitelist. There are too many characters valid in subdomains now:
<a href="https://stackoverflow.com/questions/7111881/what-are-the-allowed-characters-in-a-subdomain/22319900#22319900" rel="nofollow">https://stackoverflow.com/questions/7111881/what-are-the-allowed-characters-in-a-subdomain/22319900#22319900</a>
</pre>
</div><div class='comment type_log' ><a name="1584318559">&nbsp;</a><strong>[2020-03-16 00:29 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2020-7066</span>
</div></div></div><div class='comment type_svn' ><a name="1584423582">&nbsp;</a><strong>[2020-03-17 05:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0d139c5b94a5f485a66901919e51faddb0371c43" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0d139c5b94a5f485a66901919e51faddb0371c43</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_log' ><a name="1584423582">&nbsp;</a><strong>[2020-03-17 05:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1584423634">&nbsp;</a><strong>[2020-03-17 05:40 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=69fdc14152edefd75a33be7fe87d1194098c67f7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=69fdc14152edefd75a33be7fe87d1194098c67f7</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584423667">&nbsp;</a><strong>[2020-03-17 05:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=335547a04d133e757c044dfa7cd78ab685939924" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=335547a04d133e757c044dfa7cd78ab685939924</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584423783">&nbsp;</a><strong>[2020-03-17 05:43 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=2bc92a0cf79e52e2096e45987468740d5bc748ed" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=2bc92a0cf79e52e2096e45987468740d5bc748ed</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584433833">&nbsp;</a><strong>[2020-03-17 08:30 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f930ff52f45620eec2b2960f9e0a96d258ca1891" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f930ff52f45620eec2b2960f9e0a96d258ca1891</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584438489">&nbsp;</a><strong>[2020-03-17 09:48 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=69fdc14152edefd75a33be7fe87d1194098c67f7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=69fdc14152edefd75a33be7fe87d1194098c67f7</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584438490">&nbsp;</a><strong>[2020-03-17 09:48 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=335547a04d133e757c044dfa7cd78ab685939924" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=335547a04d133e757c044dfa7cd78ab685939924</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584439330">&nbsp;</a><strong>[2020-03-17 10:02 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0d139c5b94a5f485a66901919e51faddb0371c43" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0d139c5b94a5f485a66901919e51faddb0371c43</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div><div class='comment type_svn' ><a name="1584440560">&nbsp;</a><strong>[2020-03-17 10:22 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=a33d05b1474caee449b88f53d61bee720c57caf7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=a33d05b1474caee449b88f53d61bee720c57caf7</a>
Log: Fix <a href='bug.php?id=79329'>bug #79329</a> - get_headers should not accept \0
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
