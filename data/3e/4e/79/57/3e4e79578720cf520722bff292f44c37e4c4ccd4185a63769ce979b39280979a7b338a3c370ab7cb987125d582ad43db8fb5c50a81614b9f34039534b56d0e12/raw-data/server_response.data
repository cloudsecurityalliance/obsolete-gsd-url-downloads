<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://code.launchpad.net/%7Ecjwatson/click/audit-missing-dot-slash/+merge/274554/+index" />

    <meta charset="UTF-8" />
    <title>Merge into devel : audit-missing-dot-slash : Code : click</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    
    
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="Forbid installing packages with data tarball members whose names do not start with &quot;./&quot;.  These slipped past the dpkg path filtering because that filtering wasn't built for security purposes and assumes that paths start with &quot;./&quot;, starting its comparisons from the second character.  To fix this, we audit the file names before invoking dpkg." />
      <meta property="og:description" content="Forbid installing packages with data tarball members whose names do not start with &quot;./&quot; (LP: #1506467)." />
    

    
    
      <meta property="og:title" content="Merge into devel : audit-missing-dot-slash : Code : click" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://code.launchpad.net/%7Ecjwatson/click/audit-missing-dot-slash/+merge/274554/+index" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
  <style type="text/css">
    .menu-link-set_commit_message {
    margin-top: 1em;
    }
    #code-review-votes {
      margin: 1em 0;
    }
    #add-comment-form {
      max-width: 60em;
      padding-bottom: 3em;
    }
    #add-comment-form textarea{
      width: 100%;
      max-width: inherit;
    }
    #add-comment-form .actions {
      float: right;
      margin: 0 -0.5em;
    }
    #add-comment-review-fields {
      margin-top: 1em;
    }
    #add-comment-review-fields div {
      display: inline;
    }
    .yui3-publishdrafts:before {
      content: " ";
    }
    #proposal-summary th {
      font-weight: bold;
      color: #717171;
    }
    #proposal-summary td {
      padding-left: 0.5em;
    }
    .related-bugs-list {
      padding-left: 20px;
      padding-bottom: 10px;
    }
  </style>

    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-branches
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+merge/274554/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/click"><img alt="" width="64" height="64" src="/@@/product-logo" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/click">click</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/click">Overview</a></li>
      
    
    
      <li class="branches active"><a href="https://code.launchpad.net/click">Code</a></li>
      
      
    
    
      
      <li class="bugs"><a href="https://bugs.launchpad.net/click">Bugs</a></li>
      
    
    
      
      <li class="specifications"><a href="https://blueprints.launchpad.net/click">Blueprints</a></li>
      
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/click">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/click">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              <h1>Merge lp:~cjwatson/click/audit-missing-dot-slash into lp:click/devel</h1>
              <ol itemprop="breadcrumb" class="breadcrumbs">


  <li>
    <a href="https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash">audit-missing-dot-slash</a>
  </li>


  <li>
    Merge into devel
  </li>

</ol>

              <div id="registration" class="registering">
                
  Proposed by
  <a href="https://launchpad.net/~cjwatson" class="sprite person">Colin Watson</a>
  <time title="2015-10-15 12:56:06 UTC" datetime="2015-10-15T12:56:06.393784+00:00">on 2015-10-15</time>

              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

  <div class="yui-g first">
    <table id="proposal-summary">

  <tbody>
    
    <tr id="summary-row-1-status">
      <th>Status:</th>
      <td id="branchmergeproposal-status-value">

        
          
          <span class="value mergestatusMERGED">Merged</span>
            
        
      </td>
    </tr>
    
    
      
    
    
      
      <tr id="summary-row-7-merged-revision">
        <th>Merged at revision:</th>
        <td>
          
          587
          
        </td>
      </tr>
    
    <tr id="summary-row-8-source-branch">
      <th>Proposed branch:</th>
      <td><a href="/~cjwatson/click/audit-missing-dot-slash" class="sprite branch">lp:~cjwatson/click/audit-missing-dot-slash</a></td>
    </tr>
    <tr id="summary-row-9-target-branch">
      <th>Merge into:</th>
      <td><a href="/~click-hackers/click/devel" class="sprite branch">lp:click/devel</a></td>
    </tr>
    
    <tr id="summary-row-b-diff">
      <th>Diff against target:</th>
      <td>
        
  <a href="https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+merge/274554/+preview-diff/666086/+files/preview.diff" class="diff-link">125 lines (+60/-1)</a><div class="collapsible"><span>3 files modified</span><div>click/install.py (+10/-0)<br/>click/tests/test_install.py (+48/-1)<br/>debian/changelog (+2/-0)</div></div>
  


      </td>
    </tr>
    

    <tr id="summary-row-merge-instruction">
      <th>To merge this branch:</th>
      <td>bzr merge <span class="branch-url">lp:~cjwatson/click/audit-missing-dot-slash</span></td>
    </tr>
    <tr id="related-bugs">
      <th style="vertical-align: top;">Related bugs:</th>
      <td>
        <div id="buglinks">
          <div id="buglink-list">
            

  

  <table>
    
      <tr class="buglink-summary" id="buglink-1506467">
        <td class="first"><a href="https://bugs.launchpad.net/ubuntu/+source/click/+bug/1506467" class="sprite bug-critical" title="Critical - Fix Released">Bug #1506467: click install does not ignore shipped files without leading &#x27;./&#x27;</a></td>
        <td>
          <span class="importanceCRITICAL">Critical</span>
        </td>
        <td>
          <span class="statusFIXRELEASED">Fix Released</span>
        </td>
        <td>
          <a title="Remove link" class="delete-buglink" href="+unlinkbug?field.bugs=1506467" id="delete-buglink-1506467">
            <img src="/@@/remove" alt="Remove" />
          </a>
        </td>
      </tr>
    
  </table>


          </div>
          <div>
            <a id="linkbug" class="sprite add" href="https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+merge/274554/+linkbug">Link a bug report</a>
          </div>
        </div>
        <script type="text/javascript">
          LPJS.use('io-base', 'lp.code.branch.bugspeclinks', function(Y) {
            Y.on('domready', function() {
              var logged_in = LP.links['me'] !== undefined;

              if (logged_in) {
                var config = {
                  picker_activator: '#linkbug'
                };
                var linked_bug_picker = new
                  Y.lp.code.branch.bugspeclinks.LinkedBugPicker(config);
                linked_bug_picker.render();
                linked_bug_picker.hide();
              }
            });
          });
        </script>
      </td>
    </tr>
    
  </tbody>
</table>

  </div>

  <div class="yui-g">
    <div id="votes-target"><div id="code-review-votes">

<table class="listing compressed">
  <thead>
    <tr>
      <th>Reviewer</th>
      <th>Review Type</th>
      <th>Date Requested</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <!-- Current reviews -->
    <tr id="review-mvo">
      <td>
        <a href="https://launchpad.net/~mvo" class="sprite person">Michael Vogt</a>
        </td>
      <td></td>
      <td>
        
          <span title="Requested by Colin Watson">
            <time title="2015-10-15 12:56:06 UTC" datetime="2015-10-15T12:56:06.393784+00:00">2015-10-15</time>
          </span>
        
      </td>
      <td>
        <span class="voteAPPROVE">Approve</span>
        <time title="2015-10-15 13:00:17 UTC" datetime="2015-10-15T13:00:17.611877+00:00">on 2015-10-15</time>
        
      </td>
    </tr>
    <!-- Pending reviews -->
    <tr id="email-review">
      <td colspan="4" style="padding-top: 1em; patting-bottom: 0.5em">
        Review <a href="https://help.launchpad.net/Code/Review" class="help">via email</a>:
        <img src="/@@/mail" style="padding-left:0.5em" />
        <a href="mailto:mp+274554@code.launchpad.net">mp+274554@code.launchpad.net</a>
      </td>
    </tr>

    
  </tbody>
</table>

</div>
</div>
  </div>

  
  

  <div id="commit-message" class="yui-g">
    
    <div>
  <div class="lazr-multiline-edit" id="edit-commit_message">
  <div class="clearfix">
    

    <h3>Commit message</h3>
  </div>

  <div class="yui3-editable_text-text"><p>Forbid installing packages with data tarball members whose names do not start with &quot;./&quot; (LP: <a href="/bugs/1506467" class="bug-link">#1506467</a>).</p></div>
  </div>

  
</div>

  </div>

  <div id="description" class="yui-g">
    
    <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Description of the change</h3>
  </div>

  <div class="yui3-editable_text-text"><p>Forbid installing packages with data tarball members whose names do not start with &quot;./&quot;.  These slipped past the dpkg path filtering because that filtering wasn&#x27;t built for security purposes and assumes that paths start with &quot;./&quot;, starting its comparisons from the second character.  To fix this, we audit the file names before invoking dpkg.</p></div>
  </div>

  
</div>

  </div>

  <div class="yui-g">
    
      <div align="center" id="add-comment-login-first">
        To post a comment you must <a href="+login">log in</a>.
      </div>
    

    

    <div id="conversation">

  

   <div itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message " data-baseurl="/~cjwatson/click/audit-missing-dot-slash/+merge/274554/comments/693157">
    <div class="boardCommentDetails">

<div class="message-revision-container">
  <div class="message-revision-container-header">
    <span>Revision history for this message</span>
    <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
  </div>
  <script type="text/template">
    <div class='message-revision-item'>
      <div class='message-revision-title'>
          <a class="sprite remove action-icon message-revision-del-btn">
              Remove
          </a>
          <a class="js-action">
              Revision #{revision}, created at {date_created_display}
          </a>
      </div>
      <div class='message-revision-body'>{content}</div>
    </div>
  </script>
  <div class="message-revision-list"></div>
</div>

<table>
  <tbody>
    <tr>
    <td data-from-superseded="False">
      <span itemprop="creator"><a href="https://launchpad.net/~mvo" class="sprite person">Michael Vogt (mvo)</a></span>
        wrote
        <time itemprop="commentTime" datetime="2015-10-15T13:00:17.611877+00:00" title="2015-10-15 13:00:17 UTC">on 2015-10-15</time><span class="editable-message-last-edit-date">:
          </span>
        
      </td>

      <td>
        
      </td>
      <td>
        
      </td>
      <td class="bug-comment-index">
        <a itemprop="url" href="/~cjwatson/click/audit-missing-dot-slash/+merge/274554/comments/693157">#</a>
      </td>

    </tr>
  </tbody>
</table>

</div>
    <div class="boardCommentBody" itemprop="commentText">

  <div>

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Looks good, thanks!</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Looks good, thanks!</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>

</div>


</div>
    <div class="boardCommentActivity">

  <strong>review:</strong>
  <span class="voteAPPROVE">Approve</span>
  


</div>
    
  </div>




</div>
    
  </div>

  

  <div class="yui-g">
    
  </div>

  <div id="diff-area">
    
    
    
    <div id="review-diff">
      <h2>Preview Diff </h2>

      <div class="diff-navigator">
      </div>

      <div class="diff-content">
        

  <div class="boardComment attachment diff">
    
      <div class="boardCommentDetails filename">
        <div class="editorShortcutTip">[H/L] Next/Prev Comment, [J/K] Next/Prev File, [N/P] Next/Prev Hunk</div>
        <ul class="horizontal">
          <li>
            <a href="https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+merge/274554/+preview-diff/666086/+files/preview.diff">
              <img src="/@@/download" />
              Download diff
            </a>
          </li>
          <li>
            <a href="?ss=1">Side-by-side diff</a>
          </li>
          
        </ul>
      </div>
      <div class="attachmentBody">
        <table class="diff unidiff"><tr id="diff-line-1"><td class="line-no unselectable">1</td><td class="diff-file text">=== modified file &#x27;click/install.py&#x27;</td></tr><tr id="diff-line-2"><td class="line-no unselectable">2</td><td class="diff-header text">--- click/install.py	2015-09-17 19:20:07 +0000</td></tr><tr id="diff-line-3"><td class="line-no unselectable">3</td><td class="diff-header text">+++ click/install.py	2015-10-15 12:56:07 +0000</td></tr><tr id="diff-line-4"><td class="line-no unselectable">4</td><td class="diff-chunk text">@@ -276,6 +276,16 @@</td></tr><tr id="diff-line-5"><td class="line-no unselectable">5</td><td class="text">                             &#x27;with system architecture &quot;%s&quot;&#x27; %</td></tr><tr id="diff-line-6"><td class="line-no unselectable">6</td><td class="text">                             (architecture, dpkg_architecture))</td></tr><tr id="diff-line-7"><td class="line-no unselectable">7</td><td class="text"> </td></tr><tr id="diff-line-8"><td class="line-no unselectable">8</td><td class="diff-added text">+            # This isn&#x27;t ideally quick, since it has to decompress the data</td></tr><tr id="diff-line-9"><td class="line-no unselectable">9</td><td class="diff-added text">+            # part of the package, but dpkg&#x27;s path filtering code assumes</td></tr><tr id="diff-line-10"><td class="line-no unselectable">10</td><td class="diff-added text">+            # that all paths start with &quot;./&quot; so we must check it before</td></tr><tr id="diff-line-11"><td class="line-no unselectable">11</td><td class="diff-added text">+            # passing the package to dpkg.</td></tr><tr id="diff-line-12"><td class="line-no unselectable">12</td><td class="diff-added text">+            for data_name in package.data:</td></tr><tr id="diff-line-13"><td class="line-no unselectable">13</td><td class="diff-added text">+                if data_name != &quot;.&quot; and not data_name.startswith(&quot;./&quot;):</td></tr><tr id="diff-line-14"><td class="line-no unselectable">14</td><td class="diff-added text">+                    raise ClickInstallerAuditError(</td></tr><tr id="diff-line-15"><td class="line-no unselectable">15</td><td class="diff-added text">+                        &#x27;File name &quot;%s&quot; in package does not start with &quot;./&quot;&#x27; %</td></tr><tr id="diff-line-16"><td class="line-no unselectable">16</td><td class="diff-added text">+                        data_name)</td></tr><tr id="diff-line-17"><td class="line-no unselectable">17</td><td class="diff-added text">+</td></tr><tr id="diff-line-18"><td class="line-no unselectable">18</td><td class="text">             if slow:</td></tr><tr id="diff-line-19"><td class="line-no unselectable">19</td><td class="text">                 temp_dir = tempfile.mkdtemp(prefix=&quot;click&quot;)</td></tr><tr id="diff-line-20"><td class="line-no unselectable">20</td><td class="text">                 try:</td></tr><tr id="diff-line-21"><td class="line-no unselectable">21</td><td class="text"></td></tr><tr id="diff-line-22"><td class="line-no unselectable">22</td><td class="diff-file text">=== modified file &#x27;click/tests/test_install.py&#x27;</td></tr><tr id="diff-line-23"><td class="line-no unselectable">23</td><td class="diff-header text">--- click/tests/test_install.py	2014-12-03 12:42:21 +0000</td></tr><tr id="diff-line-24"><td class="line-no unselectable">24</td><td class="diff-header text">+++ click/tests/test_install.py	2015-10-15 12:56:07 +0000</td></tr><tr id="diff-line-25"><td class="line-no unselectable">25</td><td class="diff-chunk text">@@ -23,19 +23,24 @@</td></tr><tr id="diff-line-26"><td class="line-no unselectable">26</td><td class="text">     ]</td></tr><tr id="diff-line-27"><td class="line-no unselectable">27</td><td class="text"> </td></tr><tr id="diff-line-28"><td class="line-no unselectable">28</td><td class="text"> </td></tr><tr id="diff-line-29"><td class="line-no unselectable">29</td><td class="diff-removed text">-from contextlib import contextmanager</td></tr><tr id="diff-line-30"><td class="line-no unselectable">30</td><td class="diff-added text">+from contextlib import (</td></tr><tr id="diff-line-31"><td class="line-no unselectable">31</td><td class="diff-added text">+    closing,</td></tr><tr id="diff-line-32"><td class="line-no unselectable">32</td><td class="diff-added text">+    contextmanager,</td></tr><tr id="diff-line-33"><td class="line-no unselectable">33</td><td class="diff-added text">+    )</td></tr><tr id="diff-line-34"><td class="line-no unselectable">34</td><td class="text"> import hashlib</td></tr><tr id="diff-line-35"><td class="line-no unselectable">35</td><td class="text"> import json</td></tr><tr id="diff-line-36"><td class="line-no unselectable">36</td><td class="text"> import os</td></tr><tr id="diff-line-37"><td class="line-no unselectable">37</td><td class="text"> import shutil</td></tr><tr id="diff-line-38"><td class="line-no unselectable">38</td><td class="text"> import stat</td></tr><tr id="diff-line-39"><td class="line-no unselectable">39</td><td class="text"> import subprocess</td></tr><tr id="diff-line-40"><td class="line-no unselectable">40</td><td class="diff-added text">+import tarfile</td></tr><tr id="diff-line-41"><td class="line-no unselectable">41</td><td class="text"> </td></tr><tr id="diff-line-42"><td class="line-no unselectable">42</td><td class="text"> from unittest import skipUnless</td></tr><tr id="diff-line-43"><td class="line-no unselectable">43</td><td class="text"> </td></tr><tr id="diff-line-44"><td class="line-no unselectable">44</td><td class="text"> from debian.deb822 import Deb822</td></tr><tr id="diff-line-45"><td class="line-no unselectable">45</td><td class="text"> from gi.repository import Click</td></tr><tr id="diff-line-46"><td class="line-no unselectable">46</td><td class="text"> </td></tr><tr id="diff-line-47"><td class="line-no unselectable">47</td><td class="diff-added text">+from click.arfile import ArFile</td></tr><tr id="diff-line-48"><td class="line-no unselectable">48</td><td class="text"> from click.build import ClickBuilder</td></tr><tr id="diff-line-49"><td class="line-no unselectable">49</td><td class="text"> from click.install import (</td></tr><tr id="diff-line-50"><td class="line-no unselectable">50</td><td class="text">     ClickInstaller,</td></tr><tr id="diff-line-51"><td class="line-no unselectable">51</td><td class="diff-chunk text">@@ -50,6 +55,7 @@</td></tr><tr id="diff-line-52"><td class="line-no unselectable">52</td><td class="text">     TestCase,</td></tr><tr id="diff-line-53"><td class="line-no unselectable">53</td><td class="text">     touch,</td></tr><tr id="diff-line-54"><td class="line-no unselectable">54</td><td class="text"> )</td></tr><tr id="diff-line-55"><td class="line-no unselectable">55</td><td class="diff-added text">+from click.versions import spec_version</td></tr><tr id="diff-line-56"><td class="line-no unselectable">56</td><td class="text"> </td></tr><tr id="diff-line-57"><td class="line-no unselectable">57</td><td class="text"> </td></tr><tr id="diff-line-58"><td class="line-no unselectable">58</td><td class="text"> @contextmanager</td></tr><tr id="diff-line-59"><td class="line-no unselectable">59</td><td class="diff-chunk text">@@ -104,6 +110,7 @@</td></tr><tr id="diff-line-60"><td class="line-no unselectable">60</td><td class="text">                 script.write(contents)</td></tr><tr id="diff-line-61"><td class="line-no unselectable">61</td><td class="text">         Click.ensuredir(data_dir)</td></tr><tr id="diff-line-62"><td class="line-no unselectable">62</td><td class="text">         for name, path in data_files.items():</td></tr><tr id="diff-line-63"><td class="line-no unselectable">63</td><td class="diff-added text">+            Click.ensuredir(os.path.dirname(os.path.join(data_dir, name)))</td></tr><tr id="diff-line-64"><td class="line-no unselectable">64</td><td class="text">             if path is None:</td></tr><tr id="diff-line-65"><td class="line-no unselectable">65</td><td class="text">                 touch(os.path.join(data_dir, name))</td></tr><tr id="diff-line-66"><td class="line-no unselectable">66</td><td class="text">             elif os.path.isdir(path):</td></tr><tr id="diff-line-67"><td class="line-no unselectable">67</td><td class="diff-chunk text">@@ -320,6 +327,46 @@</td></tr><tr id="diff-line-68"><td class="line-no unselectable">68</td><td class="text">                     ])</td></tr><tr id="diff-line-69"><td class="line-no unselectable">69</td><td class="text">             self.assertEqual((&quot;test-package&quot;, &quot;1.0&quot;), installer.audit(path))</td></tr><tr id="diff-line-70"><td class="line-no unselectable">70</td><td class="text"> </td></tr><tr id="diff-line-71"><td class="line-no unselectable">71</td><td class="diff-added text">+    def test_audit_missing_dot_slash(self):</td></tr><tr id="diff-line-72"><td class="line-no unselectable">72</td><td class="diff-added text">+        # Manually construct a package with data paths that do not start</td></tr><tr id="diff-line-73"><td class="line-no unselectable">73</td><td class="diff-added text">+        # with &quot;./&quot;, which could be used to bypass path filtering.</td></tr><tr id="diff-line-74"><td class="line-no unselectable">74</td><td class="diff-added text">+        with self.run_in_subprocess(</td></tr><tr id="diff-line-75"><td class="line-no unselectable">75</td><td class="diff-added text">+                &quot;click_get_frameworks_dir&quot;) as (enter, preloads):</td></tr><tr id="diff-line-76"><td class="line-no unselectable">76</td><td class="diff-added text">+            enter()</td></tr><tr id="diff-line-77"><td class="line-no unselectable">77</td><td class="diff-added text">+            path = self.make_fake_package(</td></tr><tr id="diff-line-78"><td class="line-no unselectable">78</td><td class="diff-added text">+                control_fields={&quot;Click-Version&quot;: &quot;0.2&quot;},</td></tr><tr id="diff-line-79"><td class="line-no unselectable">79</td><td class="diff-added text">+                manifest={</td></tr><tr id="diff-line-80"><td class="line-no unselectable">80</td><td class="diff-added text">+                    &quot;name&quot;: &quot;test-package&quot;,</td></tr><tr id="diff-line-81"><td class="line-no unselectable">81</td><td class="diff-added text">+                    &quot;version&quot;: &quot;1.0&quot;,</td></tr><tr id="diff-line-82"><td class="line-no unselectable">82</td><td class="diff-added text">+                    &quot;framework&quot;: &quot;ubuntu-sdk-13.10&quot;,</td></tr><tr id="diff-line-83"><td class="line-no unselectable">83</td><td class="diff-added text">+                },</td></tr><tr id="diff-line-84"><td class="line-no unselectable">84</td><td class="diff-added text">+                control_scripts={&quot;preinst&quot;: static_preinst},</td></tr><tr id="diff-line-85"><td class="line-no unselectable">85</td><td class="diff-added text">+                data_files={&quot;.click/tmp.ci/manifest&quot;: None})</td></tr><tr id="diff-line-86"><td class="line-no unselectable">86</td><td class="diff-added text">+            # Repack without the leading &quot;./&quot;.</td></tr><tr id="diff-line-87"><td class="line-no unselectable">87</td><td class="diff-added text">+            data_dir = os.path.join(self.temp_dir, &quot;fake-package&quot;)</td></tr><tr id="diff-line-88"><td class="line-no unselectable">88</td><td class="diff-added text">+            data_tar_path = os.path.join(self.temp_dir, &quot;data.tar.gz&quot;)</td></tr><tr id="diff-line-89"><td class="line-no unselectable">89</td><td class="diff-added text">+            control_tar_path = os.path.join(self.temp_dir, &quot;control.tar.gz&quot;)</td></tr><tr id="diff-line-90"><td class="line-no unselectable">90</td><td class="diff-added text">+            package_path = &#x27;%s.click&#x27; % data_dir</td></tr><tr id="diff-line-91"><td class="line-no unselectable">91</td><td class="diff-added text">+            with closing(tarfile.TarFile.open(</td></tr><tr id="diff-line-92"><td class="line-no unselectable">92</td><td class="diff-added text">+                    name=data_tar_path, mode=&quot;w:gz&quot;, format=tarfile.GNU_FORMAT</td></tr><tr id="diff-line-93"><td class="line-no unselectable">93</td><td class="diff-added text">+                    )) as data_tar:</td></tr><tr id="diff-line-94"><td class="line-no unselectable">94</td><td class="diff-added text">+                data_tar.add(</td></tr><tr id="diff-line-95"><td class="line-no unselectable">95</td><td class="diff-added text">+                    os.path.join(data_dir, &quot;.click&quot;), arcname=&quot;.click&quot;)</td></tr><tr id="diff-line-96"><td class="line-no unselectable">96</td><td class="diff-added text">+            with ArFile(name=package_path, mode=&quot;w&quot;) as package:</td></tr><tr id="diff-line-97"><td class="line-no unselectable">97</td><td class="diff-added text">+                package.add_magic()</td></tr><tr id="diff-line-98"><td class="line-no unselectable">98</td><td class="diff-added text">+                package.add_data(&quot;debian-binary&quot;, b&quot;2.0\n&quot;)</td></tr><tr id="diff-line-99"><td class="line-no unselectable">99</td><td class="diff-added text">+                package.add_data(</td></tr><tr id="diff-line-100"><td class="line-no unselectable">100</td><td class="diff-added text">+                    &quot;_click-binary&quot;, (&quot;%s\n&quot; % spec_version).encode(&quot;UTF-8&quot;))</td></tr><tr id="diff-line-101"><td class="line-no unselectable">101</td><td class="diff-added text">+                package.add_file(&quot;control.tar.gz&quot;, control_tar_path)</td></tr><tr id="diff-line-102"><td class="line-no unselectable">102</td><td class="diff-added text">+                package.add_file(&quot;data.tar.gz&quot;, data_tar_path)</td></tr><tr id="diff-line-103"><td class="line-no unselectable">103</td><td class="diff-added text">+            self._setup_frameworks(preloads, frameworks=[&quot;ubuntu-sdk-13.10&quot;])</td></tr><tr id="diff-line-104"><td class="line-no unselectable">104</td><td class="diff-added text">+            with mock_quiet_subprocess_call():</td></tr><tr id="diff-line-105"><td class="line-no unselectable">105</td><td class="diff-added text">+                installer = ClickInstaller(self.db)</td></tr><tr id="diff-line-106"><td class="line-no unselectable">106</td><td class="diff-added text">+                self.assertRaisesRegex(</td></tr><tr id="diff-line-107"><td class="line-no unselectable">107</td><td class="diff-added text">+                    ClickInstallerAuditError,</td></tr><tr id="diff-line-108"><td class="line-no unselectable">108</td><td class="diff-added text">+                    &#x27;File name &quot;.click&quot; in package does not start with &quot;./&quot;&#x27;,</td></tr><tr id="diff-line-109"><td class="line-no unselectable">109</td><td class="diff-added text">+                    installer.audit, path)</td></tr><tr id="diff-line-110"><td class="line-no unselectable">110</td><td class="diff-added text">+</td></tr><tr id="diff-line-111"><td class="line-no unselectable">111</td><td class="text">     def test_audit_broken_md5sums(self):</td></tr><tr id="diff-line-112"><td class="line-no unselectable">112</td><td class="text">         with self.run_in_subprocess(</td></tr><tr id="diff-line-113"><td class="line-no unselectable">113</td><td class="text">                 &quot;click_get_frameworks_dir&quot;) as (enter, preloads):</td></tr><tr id="diff-line-114"><td class="line-no unselectable">114</td><td class="text"></td></tr><tr id="diff-line-115"><td class="line-no unselectable">115</td><td class="diff-file text">=== modified file &#x27;debian/changelog&#x27;</td></tr><tr id="diff-line-116"><td class="line-no unselectable">116</td><td class="diff-header text">--- debian/changelog	2015-10-15 11:47:35 +0000</td></tr><tr id="diff-line-117"><td class="line-no unselectable">117</td><td class="diff-header text">+++ debian/changelog	2015-10-15 12:56:07 +0000</td></tr><tr id="diff-line-118"><td class="line-no unselectable">118</td><td class="diff-chunk text">@@ -2,6 +2,8 @@</td></tr><tr id="diff-line-119"><td class="line-no unselectable">119</td><td class="text"> </td></tr><tr id="diff-line-120"><td class="line-no unselectable">120</td><td class="text">   * Fix spurious test_sync_without_user_db test failure.</td></tr><tr id="diff-line-121"><td class="line-no unselectable">121</td><td class="text">   * Fix test failures under Python 2.</td></tr><tr id="diff-line-122"><td class="line-no unselectable">122</td><td class="diff-added text">+  * Forbid installing packages with data tarball members whose names do not</td></tr><tr id="diff-line-123"><td class="line-no unselectable">123</td><td class="diff-added text">+    start with &quot;./&quot; (LP: #1506467).</td></tr><tr id="diff-line-124"><td class="line-no unselectable">124</td><td class="text"> </td></tr><tr id="diff-line-125"><td class="line-no unselectable">125</td><td class="text">  -- Colin Watson &lt;cjwatson@ubuntu.com&gt;  Thu, 15 Oct 2015 12:46:54 +0100</td></tr><tr id="diff-line-126"><td class="line-no unselectable">126</td><td class="text"> </td></tr></table>
        
        
      </div>
      
    
    
  </div>



      </div>
    </div>
  </div>

<script id='codereview-script' type='text/javascript'>
  conf = {"source_revid": "cjwatson@canonical.com-20151015125330-jz7ejrdcibgfx7jg", "status_widget_items": [{"description_css_class": "choice-description", "css_class": "mergestatusWORK_IN_PROGRESS", "style": "", "name": "Work in progress", "description": "", "help": "", "value": "Work in progress", "disabled": false}, {"description_css_class": "choice-description", "css_class": "mergestatusNEEDS_REVIEW", "style": "", "name": "Needs review", "description": "", "help": "", "value": "Needs review", "disabled": false}, {"description_css_class": "choice-description", "css_class": "mergestatusMERGED", "style": "", "name": "Merged", "description": "", "help": "", "value": "Merged", "disabled": false}], "user_can_edit_status": false, "status_value": "Merged"}
  LPJS.use('io-base', 'lp.code.branchmergeproposal.reviewcomment',
          'lp.code.branchmergeproposal.status', 'lp.app.comment',
          'lp.app.widgets.expander',
          'lp.code.branch.revisionexpander',
          'lp.code.branchmergeproposal.inlinecomments',
          'lp.services.messages.edit', function(Y) {

    Y.on('load', function() {
        var logged_in = LP.links['me'] !== undefined;
        var comment = null;
        if (logged_in) {
            comment = new Y.lp.app.comment.CodeReviewComment();
            comment.render();
        }

        var review_diff_node = Y.one('#review-diff');
        if (review_diff_node !== null) {
            var ic = Y.lp.code.branchmergeproposal.inlinecomments;
            var diffnav = new ic.DiffNav({srcNode: review_diff_node});
            if (comment !== null) {
                comment.on('CodeReviewComment.appended', function () {
                    diffnav.update_on_new_comment();
                });
                Y.lp.code.branchmergeproposal.status.connect_status(conf);
            }
            Y.lp.code.branchmergeproposal.reviewcomment.connect_links();
            diffnav.render();
        }

        LP.cache.comment_context = LP.cache.context;
        var cl = new Y.lp.app.comment.CommentList({
            comment_list_container: Y.one('#conversation')
        });
        if (comment !== null) {
            comment.on('CodeReviewComment.appended', cl.bind_new_comment);
        }
        cl.render();
    }, window);

    Y.on('domready', function() {
        Y.lp.app.widgets.expander.createByCSS(
            '.revision-group-diff',
            '.expander-icon',
            '.expander-content',
            false,
            Y.lp.code.branch.revisionexpander.bmp_diff_loader);
        Y.lp.services.messages.edit.setup();
    });
  });
</script>

</div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            

  
  <div class="portlet" id="portlet-subscribers">

  <h2 class="unnecessary">Subscribers</h2>

    <p>
      
        People
      
      
      subscribed via source and target branches
    </p>

    <div id="full-subscribers">
      <img src="/@@/mail" /> to all changes:
      <ul>
        <li><a href="https://launchpad.net/~cjwatson" class="sprite person">Colin Watson</a></li>
      </ul>
      <ul>
        <li><a href="https://launchpad.net/~ubuntu-security" class="bg-image" style="background-image: url(https://launchpadlibrarian.net/1575441/Lock.png)">Ubuntu Security Team</a></li>
      </ul>
      <ul>
        <li><a href="https://launchpad.net/~click-hackers" class="sprite team">click hackers</a></li>
      </ul>
    </div>

    
</div>




          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"related_features": {}, "branch_diff_link": "https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+diff/", "branch_name": "audit-missing-dot-slash", "context": {"self_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554", "web_link": "https://code.launchpad.net/~cjwatson/click/audit-missing-dot-slash/+merge/274554", "resource_type_link": "https://code.launchpad.net/api/devel/#branch_merge_proposal", "bugs_collection_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554/bugs", "private": false, "source_branch_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash", "source_git_repository_link": null, "source_git_path": null, "target_branch_link": "https://code.launchpad.net/api/devel/~click-hackers/click/devel", "target_git_repository_link": null, "target_git_path": null, "prerequisite_branch_link": null, "prerequisite_git_repository_link": null, "prerequisite_git_path": null, "registrant_link": "https://code.launchpad.net/api/devel/~cjwatson", "description": "Forbid installing packages with data tarball members whose names do not start with \"./\".  These slipped past the dpkg path filtering because that filtering wasn't built for security purposes and assumes that paths start with \"./\", starting its comparisons from the second character.  To fix this, we audit the file names before invoking dpkg.", "queue_status": "Merged", "reviewer_link": null, "preview_diffs_collection_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554/preview_diffs", "preview_diff_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554/+preview-diff/666086", "reviewed_revid": null, "commit_message": "Forbid installing packages with data tarball members whose names do not start with \"./\" (LP: #1506467).", "merged_revno": 587, "merged_revision_id": null, "date_merged": "2015-10-15T14:56:08.233000+00:00", "merge_reporter_link": null, "supersedes_link": null, "superseded_by_link": null, "date_created": "2015-10-15T12:56:06.393784+00:00", "date_review_requested": "2015-10-15T12:56:06.393784+00:00", "date_reviewed": null, "all_comments_collection_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554/all_comments", "address": "\u003cemail address hidden\u003e", "votes_collection_link": "https://code.launchpad.net/api/devel/~cjwatson/click/audit-missing-dot-slash/+merge/274554/votes", "http_etag": "\"831be2eaf0cc297d7d11b8de9c08db47e2993841-642aad6be12f74a668c5a9d621822505ab2afb56\""}};</script>

    
  

    
  </body>


  <!--
    Facet name: branches
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 67 queries/external actions issued in 1.17 seconds

    Features: {'app.maintenance_message': None, 'visible_render_time': None, 'app.mainsite_only.canonical_url': None, 'code.incremental_diffs.enabled': None, 'baselayout.careers_link.disabled': None, 'hard_timeout': '15000', 'js.yui_version': None, 'code.bzr.diff.disable_proxy': None, 'profiling.enabled': None}

    r0d8de2b

    -->

</html>

