<!DOCTYPE html>
<html lang="en">
  <head>
    <title>82820 &ndash; CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="data/assets/c60deb3d48830179eae269c9e65a7506.css?1462892334" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1462892331"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 1000
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "82820 – CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS",
                             "show_bug.cgi?id=82820" );
        document.title = "82820 – CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "82820 – CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1462892334"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico">
  </head>

  <body 
        class="bugs-freedesktop-org
                 bz_bug
                 bz_status_RESOLVED
                 bz_product_dbus
                 bz_component_core
                 bz_bug_82820 yui-skin-sam">

  <div id="header"><div id="banner">
  </div>

    <div id="titles">
      <span id="title">Bugzilla &ndash; Bug&nbsp;82820</span>

        <span id="subtitle" class="subheader">CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS</span>

        <span id="information" class="header_addl_info">Last modified: 2014-09-16 16:37:02 UTC</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>


</ul>
    </div>
  </div>

  <div id="bugzilla-body">


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2014-09-16 16:37:02">
  <input type="hidden" name="id" value="82820">
  <input type="hidden" name="token" value="1635619161-V96bbt9D9v114EHFvyaLRVs3r-Sv_n_ydY8E9ynGD9Y">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=82820"><b>Bug&nbsp;82820</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span><span title="CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS">CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEF...
        </span>
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'CVE-2014-3636: using all available file descriptors in dbus-daemon: limit DEFAULT_MESSAGE_UNIX_FDS' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >dbus

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=dbus"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >core

  (<a href="buglist.cgi?component=core&amp;product=dbus&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>
<td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">Other
        All
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>medium
       normal
      </td>
    </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Simon McVittie</span>
</span>
      </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_qa_contact">


  <a 
      title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#qa_contact"
  >QA Contact:</a>

</th>
      <td><span class="vcard"><span class="fn">Sjoerd Simons</span>
</span>
      </td>
    </tr>
    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'dbus\x40maint.invalid',
        'dbus\x40maint.invalid');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>

    <tr><th class="field_label "
    id="field_label_status_whiteboard">


  <a 
      title="Each bug has a free-form single line text entry box for adding tags and status information."
      class="field_help_link"
      href="page.cgi?id=fields.html#status_whiteboard"
  >Whiteboard:</a>

</th><td>review+  
  </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >patch, security

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2014-08-19 15:21 UTC by <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2014-09-16 16:37 UTC
      (<a href="show_activity.cgi?id=82820">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>2 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="thiago">thiago</option>
                <option value="walters">walters</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 
<tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_i915_platform">


  <a 
      title="Intel platforms affected by the bug"
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_i915_platform"
  >i915 platform:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_i915_platform" >

</td>
    </tr>
    <tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_i915_features">


  <a 
      title="Features of the i915 driver affected by the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_i915_features"
  >i915 features:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_i915_features" >

</td>
    </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="2" class="left">
      Attachments
    </th>
  </tr>


      <tr id="a1" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=104901"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16</span></b></a>

          <span class="bz_attach_extra_info">
              (2.50 KB,
                patch)

            <br>
            <a href="#attach_104901"
               title="Go to the comment associated with the attachment">2014-08-19 15:21 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=104901&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104901">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a2" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=104969"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16</span></b></a>

          <span class="bz_attach_extra_info">
              (2.58 KB,
                patch)

            <br>
            <a href="#attach_104969"
               title="Go to the comment associated with the attachment">2014-08-20 10:13 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=104969&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a3" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=105987"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16</span></b></a>

          <span class="bz_attach_extra_info">
              (3.55 KB,
                patch)

            <br>
            <a href="#attach_105987"
               title="Go to the comment associated with the attachment">2014-09-09 14:53 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=105987&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a4" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=106189"
               title="View the content of the attachment">
          <b>[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16</b></a>

          <span class="bz_attach_extra_info">
              (6.43 KB,
                patch)

            <br>
            <a href="#attach_106189"
               title="Go to the comment associated with the attachment">2014-09-12 15:02 UTC</a>,

            <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=106189&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106189">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a5" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=106190"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16</span></b></a>

          <span class="bz_attach_extra_info">
              (6.43 KB,
                patch)

            <br>
            <a href="#attach_106190"
               title="Go to the comment associated with the attachment">2014-09-12 15:36 UTC</a>,

            <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=106190&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106190">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a6" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=106196"
               title="View the content of the attachment">
          <b>[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16</b></a>

          <span class="bz_attach_extra_info">
              (6.08 KB,
                patch)

            <br>
            <a href="#attach_106196"
               title="Go to the comment associated with the attachment">2014-09-12 16:12 UTC</a>,

            <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=106196&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106196">
      Splinter Review</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
            <a href="#a0" onclick="return toggle_display(this);">Show
              Obsolete</a> (4)
            <a id="view_all" href="attachment.cgi?bugid=82820&amp;action=viewall&amp;hide_obsolete=1">View All</a>
        </span>
    </td>
  </tr>
</table>
<br>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js?1462891770" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-19 15:21:55 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=104901" name="attach_104901" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104901</a> <a href="attachment.cgi?id=104901&amp;action=edit" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104901'>[review]</a>
[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16

Before this patch, the system bus had the following default configuration:
- max_connections_per_user: 256
- DBUS_DEFAULT_MESSAGE_UNIX_FDS: usually 1024 (or 256 on QNX, see fd.o#61176)
  as defined by configure.ac
- max_incoming_unix_fds: DBUS_DEFAULT_MESSAGE_UNIX_FDS*4 = usually 4096
- max_outgoing_unix_fds: DBUS_DEFAULT_MESSAGE_UNIX_FDS*4 = usually 4096
- max_message_unix_fds: DBUS_DEFAULT_MESSAGE_UNIX_FDS = usually 1024

This means that a single user could create 256 connections and transmit
256*4096 = 1048576 file descriptors.

The file descriptors stay attached to the dbus-daemon process while they are
in the message loader, in the outgoing queue or waiting to be dispatched before
D-Bus activation.

dbus-daemon is usually limited to 65536 file descriptors (ulimit -n). If the
limit is reached and dbus-daemon needs to receive a message with a file
descriptor attached, this is signalled by recvfrom with the flag MSG_CTRUNC.
Dbus-daemon cannot recover from that error because the kernel does not have any
API to retrieve a file descriptor which has been discarded with MSG_CTRUNC.
Therefore, it closes the connection of the sender. This is not necessarily the
connection which generated the most file descriptors so it can lead to
denial-of-service attacks.

In order to prevent DoS issues, this patch reduces DEFAULT_MESSAGE_UNIX_FDS to
16:

max_connections_per_user * max_incoming_unix_fds = 256 * 64 = 16384

This is less than the usual &quot;ulimit -n&quot; (65536) with a good margin to
accomodate the other sources of file descriptors (stdin/stdout/stderr,
listening sockets, message loader, etc.)</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-19 15:54:27 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=104901" name="attach_104901" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104901</a> <a href="attachment.cgi?id=104901&amp;action=edit" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104901'>[review]</a>
[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=104901" name="attach_104901" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104901</a> <a href="attachment.cgi?id=104901&amp;action=edit" title="[PATCH] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104901'>[review]</a>:
-----------------------------------------------------------------

Looks good, but I'd remove the QNX extra case altogether.

::: configure.ac
&#64;&#64; +1241,3 &#64;&#64;
<span class="quote">&gt;  # Determine maximum number of Unix fds which may be passed
&gt;  AS_CASE([$host_os],
&gt;    [*qnx*],</span >

You should remove the case altogether.</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-20 10:13:56 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=104969" name="attach_104969" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104969</a> <a href="attachment.cgi?id=104969&amp;action=edit" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969'>[review]</a>
[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16

Thanks for the review.

v2:
- remove the case, as per Thiago's review
- add a reference to bugzilla in the commit log</pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-08-20 17:31:06 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=104969" name="attach_104969" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104969</a> <a href="attachment.cgi?id=104969&amp;action=edit" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969'>[review]</a>
[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=104969" name="attach_104969" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104969</a> <a href="attachment.cgi?id=104969&amp;action=edit" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969'>[review]</a>:
-----------------------------------------------------------------

Looks good, ship it.</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-03 17:12:50 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=104969" name="attach_104969" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104969</a> <a href="attachment.cgi?id=104969&amp;action=edit" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969'>[review]</a>
[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=104969" name="attach_104969" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 104969</a> <a href="attachment.cgi?id=104969&amp;action=edit" title="[PATCH v2] config: set DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=104969'>[review]</a>:
-----------------------------------------------------------------

(I'm back from &quot;nowhere near dbus&quot; and hoping to have considerably more time to deal with Alban's recent security work now.)

dbus-daemon does attempt to raise its fd limit to at least

    max_completed_connections +
    max_incomplete_connections +
    32 /* arbitrary number for pipes, inotify, misc */

but indeed that does not take into account that fd-passing can also increase the number of fds it needs.

If we're going to be doing an embargoed security release for at least one of Alban's embargoed things, which seems likely, then I think it makes sense to queue this for that release.</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-05 17:44:49 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c0">comment #0</a>)
<span class="quote">&gt; This means that a single user could create 256 connections and transmit
&gt; 256*4096 = 1048576 file descriptors.</span >

I was about to say: I think it's actually more complicated than that. The byte-limit on incoming messages is allowed to be exceeded by up to 1 read cycle (2 KiB) or 1 entire message, whichever is greater, minus 1 byte - this means we can still make forward progress if the limit on the size of a message is greater than the limit on incoming messages.

However, while investigating this I found that the same logic is not applied particularly consistently to fds, and that if you send a lot of fds in quick succession, you can end up with less space to read fds into than max_message_unix_fds (possibly down to zero), because _dbus_message_loader_get_unix_fds does not allocate (currently queued number + max_message_unix_fds) but just (max_message_unix_fds) of space in total; so you're more likely to get MSG_CTRUNC and be disconnected. I don't think this is a security bug, but it is potentially an ordinary functionality bug, and dropping this limit seems likely to exacerbate it. I'm not sure whether the author of our fd-passing code (Lennart?) had realised that for performance, we &quot;eagerly&quot; fill the DBusMessageLoader with as many messages as we can, rather than stopping at exactly 1 message.

If we go for the same &quot;may exceed by up to 1 maximal message&quot; logic, Alban's figures for the number of fds a uid can consume need to be multiplied by 5/4.

Alternatively, we could drop max_incoming_unix_fds to be closer to max_message_unix_fds?</pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 10:27:38 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c4">comment #4</a>)
<span class="quote">&gt; dbus-daemon does attempt to raise its fd limit to at least
&gt; 
&gt;     max_completed_connections +
&gt;     max_incomplete_connections +
&gt;     32 /* arbitrary number for pipes, inotify, misc */</span >

I have not seen that. This is in bus/bus.c raise_file_descriptor_limit(). But on my system, dbus-daemon runs as user &quot;messagebus&quot; and raise_file_descriptor_limit() skips the attempt when getuid () != 0.</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 11:07:13 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c6">comment #6</a>)
<span class="quote">&gt; I have not seen that. This is in bus/bus.c raise_file_descriptor_limit().
&gt; But on my system, dbus-daemon runs as user &quot;messagebus&quot; and
&gt; raise_file_descriptor_limit() skips the attempt when getuid () != 0.</span >

Hmm, yes. The systemd unit starts it as root and lets it do its own setuid() to messagebus, but the Debian sysvinit script starts it as messagebus.

I should maybe change the sysvinit script in Debian to start as root too.</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 14:07:59 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c5">comment #5</a>)
<span class="quote">&gt; If we go for the same &quot;may exceed by up to 1 maximal message&quot; logic, Alban's
&gt; figures for the number of fds a uid can consume need to be multiplied by 5/4.</span >

I am not sure I understand this correctly... With the patch applied, we have:

max_connections_per_user * max_incoming_unix_fds
 = 256 * DBUS_DEFAULT_MESSAGE_UNIX_FDS * 4
 = 256 * 16 * 4
 = 16384

Even multiplied by 5/4, we get 20480, which is less than 65536 (&quot;ulimit -n&quot;), so it's fine. Is it correct?</pre>
    </div>

    <div id="c9" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 14:14:48 UTC
        </span>

      </div>




<pre class="bz_comment_text">This patch might fix two security issues for the price of one :)

There is a limit I didn't know before: on Linux, it's not possible to send more than 253 fds in a single sendmsg() system call: sendmsg() would return -EINVAL.
#define SCM_MAX_FD      253
<a href="http://lxr.free-electrons.com/source/include/net/scm.h#L13">http://lxr.free-electrons.com/source/include/net/scm.h#L13</a>

Imagine a malicious D-Bus client sending a single D-Bus message by calling sendmsg() two times to send the two halves of the message separately. If the D-Bus message has 256 fds attached in total but each halves of the message has 128 fds attached, then the two sendmsg() calls will succeed. Dbus-daemon will receive the message successfully and attempt to forward it to the recipient in a single sendmsg() call. It will fail with -EINVAL and dbus-daemon will disconnect the recipient instead of blaming the sender. So a random client could disconnect a system service by sending this crafted message in two parts...

Do we need to add -EINVAL along with ETOOMANYREFS as explained in <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - CVE-2014-3532: kick any connection off the bus with fdpassing: denial of service"
   href="show_bug.cgi?id=80163#c3">Bug #80163 Comment #3</a>? If we keep max_incoming_unix_fds lower than SCM_MAX_FD, then we don't have to change the error management.

Do we need a new bug for that, or can I just edit the commit log in this patch?</pre>
    </div>

    <div id="c10" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 14:29:04 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c8">comment #8</a>)
<span class="quote">&gt; Even multiplied by 5/4, we get 20480, which is less than 65536 (&quot;ulimit
&gt; -n&quot;), so it's fine. Is it correct?</span >

Yes, I think so.

I think I need to do some testing on this stuff, it isn't sufficiently clear what's going on.

(In reply to <a href="show_bug.cgi?id=82820#c9">comment #9</a>)
<span class="quote">&gt; This patch might fix two security issues for the price of one :)</span >
...
<span class="quote">&gt; Imagine a malicious D-Bus client sending a single D-Bus message by calling
&gt; sendmsg() two times to send the two halves of the message separately.</span >

I can also imagine a malicious D-Bus client calling sendmsg() once per byte, so we can be given one fd per byte of message (header + padding + payload). We certainly want to allow multi-KiB messages.

<span class="quote">&gt; Dbus-daemon
&gt; will receive the message successfully and attempt to forward it to the
&gt; recipient in a single sendmsg() call. It will fail with -EINVAL and
&gt; dbus-daemon will disconnect the recipient instead of blaming the sender.</span >

Yes, I think you're right. So we need the limit on fds per message to be 253 or less, if we want dbus-daemon to be able to forward it in a single sendmsg(), which we do.

<span class="quote">&gt; Do we need to add -EINVAL along with ETOOMANYREFS as explained in <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - CVE-2014-3532: kick any connection off the bus with fdpassing: denial of service"
   href="show_bug.cgi?id=80163">Bug #80163</a>
&gt; <a href="show_bug.cgi?id=82820#c3">Comment #3</a>? If we keep max_incoming_unix_fds lower than SCM_MAX_FD, then we
&gt; don't have to change the error management.</span >

More precisely, we want to keep max_message_unix_fds &lt;= SCM_MAX_FD.

I don't think we need to add -EINVAL to the -ETOOMANYREFS handling for this reason, because your patch would already address this; and I don't really want to make -EINVAL non-fatal for the connection, because it's such a generic error code that it's anyone's guess what it means.

<span class="quote">&gt; Do we need a new bug for that, or can I just edit the commit log in this
&gt; patch?</span >

I think an edited commit message is fine.</pre>
    </div>

    <div id="c11" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-08 19:08:30 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c5">comment #5</a>)
<span class="quote">&gt; However, while investigating this I found that the same logic is not applied
&gt; particularly consistently to fds, and that if you send a lot of fds in quick
&gt; succession, you can end up with less space to read fds into than
&gt; max_message_unix_fds (possibly down to zero), because
&gt; _dbus_message_loader_get_unix_fds does not allocate (currently queued number
&gt; + max_message_unix_fds) but just (max_message_unix_fds) of space in total;
&gt; so you're more likely to get MSG_CTRUNC and be disconnected.</span >

In practice, as long as you start each new message with a new sendmsg(), I don't think you can hit this problem. So I think we're OK here.</pre>
    </div>

    <div id="c12" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-09 14:33:23 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c10">comment #10</a>)
<span class="quote">&gt; More precisely, we want to keep max_message_unix_fds &lt;= SCM_MAX_FD.</span >

SCM_MAX_FD changed value during Linux history:
- it used to be (OPEN_MAX-1)
- commit c09edd6eb (Jul 2007) changed it to 255
- commit bba14de98 (Nov 2010) changed it to 253

And it is not exported to userspace.

But I think that with the new value max_message_unix_fds=16, we are safe: even if SCM_MAX_FD is further reduced, we have some margin.</pre>
    </div>

    <div id="c13" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-09 14:53:37 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=105987" name="attach_105987" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 105987</a> <a href="attachment.cgi?id=105987&amp;action=edit" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987'>[review]</a>
[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16

v3: edit commit log to explain the two denials of service</pre>
    </div>

    <div id="c14" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-09 18:13:27 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=105987" name="attach_105987" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 105987</a> <a href="attachment.cgi?id=105987&amp;action=edit" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987'>[review]</a>
[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=105987" name="attach_105987" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 105987</a> <a href="attachment.cgi?id=105987&amp;action=edit" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987'>[review]</a>:
-----------------------------------------------------------------

Looks good to me.</pre>
    </div>

    <div id="c15" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 14:54:14 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=105987" name="attach_105987" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 105987</a> <a href="attachment.cgi?id=105987&amp;action=edit" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987'>[review]</a>
[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=105987" name="attach_105987" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 105987</a> <a href="attachment.cgi?id=105987&amp;action=edit" title="[PATCH v3] config: reduce DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=105987'>[review]</a>:
-----------------------------------------------------------------

::: configure.ac
&#64;&#64; +1238,5 &#64;&#64;
<span class="quote">&gt;    AC_DEFINE([WITH_VALGRIND], [1], [Define to add Valgrind instrumentation])
&gt;  fi
&gt;  
&gt; +# Keep the default low to avoid DoS issues, see fd.o #82820
&gt; +DEFAULT_MESSAGE_UNIX_FDS=16</span >

While backporting this to 1.6 I noticed that you didn't change the corresponding value in the cmake build system.

Now that we're not distinguishing between QNX and other Unixes, we can just hard-code, which is a simplification.</pre>
    </div>

    <div id="c16" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 15:02:22 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=106189" name="attach_106189" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106189</a> <a href="attachment.cgi?id=106189&amp;action=edit" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106189'>[review]</a>
[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16

Based on a patch by Alban Crequy. Now that it's the same on all
platforms, there's little point in it being set by configure/cmake.

This change fixes two distinct denials of service:

fd.o#82820, part A
------------------

Before this patch, the system bus had the following default configuration:

[... what Alban said ...]

This is less than the usual &quot;ulimit -n&quot; (65536) with a good margin to
accomodate the other sources of file descriptors (stdin/stdout/stderr,
listening sockets, message loader, etc.).

Distributors on non-Linux may need to configure a smaller limit in
system.conf, if their limit on the number of fds is smaller than
Linux's.

fd.o#82820, part B
------------------

On Linux, it's not possible to send more than 253 fds in a single sendmsg()
call: [... what Alban said ...]

---

v4:
* define DBUS_DEFAULT_MESSAGE_UNIX_FDS in dbus-sysdeps.h instead of
  configure.ac
  - already included by bus/config-parser.c
  - explicitly include that header in dbus/dbus-message.c

* make bus/session.conf.in just not override the default,
  so it doesn't have to get &#64;DEFAULT_MESSAGE_UNIX_FDS&#64; substituted

* mention in the commit message that non-Linux may need further reductions</pre>
    </div>

    <div id="c17" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 15:36:57 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=106190" name="attach_106190" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106190</a> <a href="attachment.cgi?id=106190&amp;action=edit" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106190'>[review]</a>
[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16

---

That constant is new in 1.8 so introduce it into 1.6.</pre>
    </div>

    <div id="c18" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 15:51:10 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class=""><a href="attachment.cgi?id=106189" name="attach_106189" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106189</a> <a href="attachment.cgi?id=106189&amp;action=edit" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106189'>[review]</a>
[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class=""><a href="attachment.cgi?id=106189" name="attach_106189" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106189</a> <a href="attachment.cgi?id=106189&amp;action=edit" title="[patch v4] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106189'>[review]</a>:
-----------------------------------------------------------------

When applying the patch on the master branch, a trivial conflict on configure.ac will need to be fixed.

The patch looks good to me.</pre>
    </div>

    <div id="c19" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c19">Comment 19</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 15:56:46 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=106190" name="attach_106190" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106190</a> <a href="attachment.cgi?id=106190&amp;action=edit" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106190'>[review]</a>
[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=106190" name="attach_106190" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106190</a> <a href="attachment.cgi?id=106190&amp;action=edit" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106190'>[review]</a>:
-----------------------------------------------------------------

<span class="quote">&gt; [patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16</span >

It does not seem to be the correct attachment for a backport to 1.6.</pre>
    </div>

    <div id="c20" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c20">Comment 20</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 16:10:05 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c18">comment #18</a>)
<span class="quote">&gt; When applying the patch on the master branch, a trivial conflict on
&gt; configure.ac will need to be fixed.</span >

I'm treating dbus-1.8 as the canonical version since that's what I'll have to use for the security release.</pre>
    </div>

    <div id="c21" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c21">Comment 21</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 16:10:56 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=82820#c19">comment #19</a>)
<span class="quote">&gt; It does not seem to be the correct attachment for a backport to 1.6.</span >

Oh, sorry, you're right. One moment.</pre>
    </div>

    <div id="c22" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c22">Comment 22</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 16:12:06 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=106196" name="attach_106196" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">attachment 106196</a> <a href="attachment.cgi?id=106196&amp;action=edit" title="[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=82820&amp;attachment=106196'>[review]</a>
[patch v4 backport to 1.6] config: change DEFAULT_MESSAGE_UNIX_FDS to 16

---

Actually the 1.6 version this time, not the 1.8 version.

Might assume that <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - CVE-2014-3638: Flooding dbus-daemon with pending replies: denial of service"
   href="show_bug.cgi?id=81053">Bug #81053</a> has been fixed first.</pre>
    </div>

    <div id="c23" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c23">Comment 23</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 22:17:10 UTC
        </span>

      </div>




<pre class="bz_comment_text">CVE-2014-3636 has been allocated for this vulnerability (including both part A, described in <a href="show_bug.cgi?id=82820#c0">Comment #0</a>, and part B, covered in <a href="show_bug.cgi?id=82820#c9">Comment #9</a>).</pre>
    </div>

    <div id="c24" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=82820#c24">Comment 24</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-16 16:37:02 UTC
        </span>

      </div>




<pre class="bz_comment_text">Vulnerability fixed in 1.8.8, making public</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=82820">Format For Printing</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>


</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>
<p align="center">
  Use of freedesktop.org services, including Bugzilla, is subject to our <a href="https://www.freedesktop.org/wiki/CodeOfConduct/">Code of Conduct</a>. How we collect and use information is described in our <a href="https://www.freedesktop.org/wiki/PrivacyPolicy">Privacy Policy</a>.
</p>
  </body>
</html>