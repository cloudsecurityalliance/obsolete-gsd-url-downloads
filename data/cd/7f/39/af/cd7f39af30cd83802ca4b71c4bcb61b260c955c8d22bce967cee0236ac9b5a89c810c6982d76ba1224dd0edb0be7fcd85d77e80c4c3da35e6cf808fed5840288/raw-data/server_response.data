<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='XSLT related Bug #69782 - RDF' href='rss/bug.php?id=69782'>
        <link rel='alternate' type='application/rss+xml' title='XSLT related Bug #69782 - RSS 2.0' href='rss/bug.php?id=69782&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #69782 :: NULL pointer dereference</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=69782">Sec Bug</a>&nbsp;#69782</th>
            <td id="summary" colspan="5">NULL pointer dereference</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-06-09 08:49 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-09-09 10:11 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>moltesalt &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=XSLT+related">XSLT related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.9</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-6838" target="_blank">2015-6838</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=69782&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=69782&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=69782&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1433839780">&nbsp;</a><strong>[2015-06-09 08:49 UTC] moltesalt &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
The XSLTProcessor class missed a few checks on the input from the libxslt library. The valuePop() function call able to return with NULL pointer and php does not check that.

These checks missed in xsltprocessor.c lines 304-305 and on lines 239-240 in the same function.
<a href="http://lxr.php.net/xref/PHP_5_6/ext/xsl/xsltprocessor.c#305" rel="nofollow">http://lxr.php.net/xref/PHP_5_6/ext/xsl/xsltprocessor.c#305</a>

All php versions affected, including trunk.

Expected result:
----------------
$ php -f xpath.php

Warning: XSLTProcessor::transformToXml(): xmlXPathCompOpEval: function d not found in xpath.php on line 31
Warning: XSLTProcessor::transformToXml(): Unregistered function in xpath.php on line 31
Warning: XSLTProcessor::transformToXml(): Stack usage errror in xpath.php on line 31

Actual result:
--------------
$ php -f xpath.php

Warning: XSLTProcessor::transformToXml(): xmlXPathCompOpEval: function d not found in xpath.php on line 31
Warning: XSLTProcessor::transformToXml(): Unregistered function in xpath.php on line 31
Warning: XSLTProcessor::transformToXml(): Stack usage errror in xpath.php on line 31
Segmentation fault

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=69782'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=69782'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1433861498">&nbsp;</a><strong>[2015-06-09 14:51 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type:           Bug</span>
<span class="added">+Type:           Security</span>
<span class="removed">-Private report: No</span>
<span class="added">+Private report: Yes</span>
</div></div></div><div class='comment type_comment' ><a name="1435930672">&nbsp;</a><strong>[2015-07-03 13:37 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Could you try the following patch: <a href="http://pastie.org/private/nmxwzf25qahxryfit542q" rel="nofollow">http://pastie.org/private/nmxwzf25qahxryfit542q</a>
</pre>
</div><div class='comment type_log' ><a name="1435930683">&nbsp;</a><strong>[2015-07-03 13:38 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1435931671">&nbsp;</a><strong>[2015-07-03 13:54 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Sorry, this should be the right patch, was a little too early on the trigger button: <a href="http://pastie.org/private/puvwu1gtr4qkextmrqmkmq" rel="nofollow">http://pastie.org/private/puvwu1gtr4qkextmrqmkmq</a> (thanks Anatol)
</pre>
</div><div class='comment type_comment' ><a name="1436009631">&nbsp;</a><strong>[2015-07-04 11:33 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>the original report had these attachments for reproducing the issue:
xpath.php :
&lt;?php

$language=trim(file_get_contents(&quot;php://stdin&quot;));

$xml = &quot;xpath.xml&quot;;
$xsl = &quot;xpath.xsl&quot;;

//$COUNTRY_PREFIX=&quot;string&quot;;

//$xsl = str_replace('$language', &quot;$language&quot;, file_get_contents(&quot;xpath.xsl&quot;));

function fileToDOMDoc($filename) {
    global $language;
    $dom= new DOMDocument;
    $xmldata = file_get_contents($filename);
    $xmldata = str_replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;, $xmldata);  // disguise &amp;s going IN to loadXML()
    $xmldata = str_replace('$language', &quot;$language&quot;, $xmldata);
    $dom-&gt;substituteEntities = true;  // collapse &amp;s going OUT to transformToXML()
    $dom-&gt;loadXML($xmldata);
    return $dom;
} 

$xmldoc = fileToDOMDoc($xml);
$xsldoc = fileToDOMDoc($xsl);

$proc = new XSLTProcessor();
//$proc-&gt;setParameter(&quot;&quot;, &quot;language&quot;, $language);
//$proc-&gt;setParameter(&quot;&quot;, &quot;COUNTRY_PREFIX&quot;, &quot;lofasz&quot;);
$proc-&gt;registerPHPFunctions();
$proc-&gt;importStyleSheet($xsldoc);
echo $proc-&gt;transformToXML($xmldoc);
?&gt; 

xpath.xml :
&lt;allusers&gt;
 &lt;user&gt;
  &lt;uid&gt;bob&lt;/uid&gt;
 &lt;/user&gt;
 &lt;user&gt;
  &lt;uid&gt;joe&lt;/uid&gt;
 &lt;/user&gt;
&lt;/allusers&gt;

xpath.xsl :
&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;
&lt;xsl:stylesheet version=&quot;1.0&quot;
     xmlns:xsl=&quot;<a href="http://www.w3.org/1999/XSL/Transform&quot;" rel="nofollow">http://www.w3.org/1999/XSL/Transform&quot;</a>
     xmlns:php=&quot;<a href="http://php.net/xsl&quot;" rel="nofollow">http://php.net/xsl&quot;</a>&gt;
 &lt;xsl:output method=&quot;xml&quot; encoding=&quot;iso-8859-15&quot; indent=&quot;yes&quot;/&gt;
 &lt;xsl:param name=&quot;COUNTRY_PREFIX&quot;/&gt;&lt;xsl:param name=&quot;COMPANY_ID&quot;/&gt;&lt;xsl:param name=&quot;FOOTER_TEXT&quot;/&gt;
 &lt;xsl:param name=&quot;language&quot; /&gt;
 &lt;xsl:template match=&quot;allusers&quot;&gt;
  &lt;html&gt;&lt;body&gt;
    &lt;h2&gt;Users&lt;/h2&gt;
    &lt;table&gt;
    &lt;xsl:for-each select=&quot;user&quot;&gt;
      &lt;tr&gt;&lt;td&gt;
        &lt;xsl:value-of disable-output-escaping=&quot;yes&quot;
             select=&quot;php:function('ucfirst', $language)&quot;/&gt;
      &lt;/td&gt;&lt;/tr&gt;
    &lt;/xsl:for-each&gt;
    &lt;/table&gt;
  &lt;/body&gt;&lt;/html&gt;
 &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div><div class='comment type_comment' ><a name="1436013332">&nbsp;</a><strong>[2015-07-04 12:35 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>the attached test scripts are a bit messy, they have unnecessary lines, could be made more simple, and it actually had a bug (seems that passing the language data was originally meant to happen through passing it via XSLTProcessor-&gt;setParameter but was replaced with a simple str_replace() when loading the xsl file, but that was bugged:
instead of
$xmldata = str_replace('$language', &quot;$language&quot;, $xmldata);
you need
$xmldata = str_replace('$language', &quot;'$language'&quot;, $xmldata);
then you can run the tests either interactively via typing en then sending ^D, or simply
echo en|php -f xpath.php

but here is the catch: I don't get the segmantation fault or any of those Warnings with 5.6.9
I suspect that the attached files are different what was actually used to reproduce the problem.
</pre>
</div><div class='comment type_comment' ><a name="1436674938">&nbsp;</a><strong>[2015-07-12 04:22 UTC] php-bugs &#x61;&#116; lists &#x64;&#111;&#x74; php &#x64;&#111;&#x74; net</strong>
<pre class='note'>No feedback was provided. The bug is being suspended because
we assume that you are no longer experiencing the problem.
If this is not the case and you are able to provide the
information that was requested earlier, please do so and
change the status of the bug back to &quot;Re-Opened&quot;. Thank you.
</pre>
</div><div class='comment type_log' ><a name="1436688403">&nbsp;</a><strong>[2015-07-12 08:06 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: No Feedback</span>
<span class="added">+Status: Re-Opened</span>
</div></div></div><div class='comment type_log' ><a name="1441134667">&nbsp;</a><strong>[2015-09-01 19:11 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Re-Opened</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1441134667">&nbsp;</a><strong>[2015-09-01 19:11 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1441793460">&nbsp;</a><strong>[2015-09-09 10:11 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-6838</span>
</div></div></div><div class='comment type_comment' ><a name="1441793460">&nbsp;</a><strong>[2015-09-09 10:11 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>This issue was assigned with two CVE: CVE-2015-6837 and CVE-2015-6838. Details at <a href="http://seclists.org/oss-sec/2015/q3/524" rel="nofollow">http://seclists.org/oss-sec/2015/q3/524</a>
</pre>
</div><div class='comment type_comment' ><a name="1442325287">&nbsp;</a><strong>[2015-09-15 13:54 UTC] pgajdos &#x61;&#116; suse &#x64;&#111;&#x74; cz</strong>
<pre class='note'>It seems there is another valuePop() occurence in the code:

<a href="http://git.php.net/?p=php-src.git;a=blob;f=ext/xsl/xsltprocessor.c;h=ee52336c4ebd46b2a42046a00b938dcff5461308;hb=HEAD#l234" rel="nofollow">http://git.php.net/?p=php-src.git;a=blob;f=ext/xsl/xsltprocessor.c;h=ee52336c4ebd46b2a42046a00b938dcff5461308;hb=HEAD#l234</a>

Shouldn't be the obj value checked there too?
</pre>
</div><div class='comment type_comment' ><a name="1444685671">&nbsp;</a><strong>[2015-10-12 21:34 UTC] thoger &#x61;&#116; redhat &#x64;&#111;&#x74; com</strong>
<pre class='note'>It seems PHP was making a correct assumption that valuePop() should not return NULL and was hitting a libxml2's bug:

<a href="https://git.gnome.org/browse/libxml2/commit/?id=03c6723043775122313f107695066e5744189a08" rel="nofollow">https://git.gnome.org/browse/libxml2/commit/?id=03c6723043775122313f107695066e5744189a08</a>

libxml2 fixed this issue in 2.9.2.  I could not reproduce this PHP crash with libxml2 2.9.2.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
