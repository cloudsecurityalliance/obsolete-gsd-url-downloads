<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #75571 - RDF' href='rss/bug.php?id=75571'>
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #75571 - RSS 2.0' href='rss/bug.php?id=75571&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #75571 :: Potential infinite loop in gdImageCreateFromGifCtx</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=75571">Sec Bug</a>&nbsp;#75571</th>
            <td id="summary" colspan="5">Potential infinite loop in gdImageCreateFromGifCtx</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2017-11-25 16:53 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2018-01-16 09:05 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>orange &#x61;&#116; chroot &#x64;&#111;&#x74; org</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=GD+related">GD related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.32</td>
            <th class="details">OS:</th>
            <td>Ubuntu 17.10</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5711" target="_blank">2018-5711</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=75571&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=75571&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=75571&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1511628820">&nbsp;</a><strong>[2017-11-25 16:53 UTC] orange &#x61;&#116; chroot &#x64;&#111;&#x74; org</strong>
<pre class='note'>Description:
------------
Hi, I found an infinity loop in GD GIF core parsing function. 

It is easy to trigger in web application if the web use GD as its image library. For example, It can be triggered by the following functions

* imagecreatefromgif
* imagecreatefromstring

This vulnerability will lead to a Denied of Service and exhausted the server resource.



There is a do-while in file `ext/gd/libgd/gd_gif_in.c` and function `LWZReadByte_`
```
do {
    sd-&gt;firstcode = sd-&gt;oldcode =
    GetCode(fd, &amp;sd-&gt;scd, sd-&gt;code_size, FALSE, ZeroDataBlockP);
} while (sd-&gt;firstcode == sd-&gt;clear_code);
```
<a href="https://github.com/php/php-src/blob/c5767db441e4db2a1e07b5880129ad7ce0b25b6f/ext/gd/libgd/gd_gif_in.c#L460" rel="nofollow">https://github.com/php/php-src/blob/c5767db441e4db2a1e07b5880129ad7ce0b25b6f/ext/gd/libgd/gd_gif_in.c#L460</a>


The implementation of `GetCode` is in `GetCode_`
```
static int
GetCode_(gdIOCtx *fd, CODE_STATIC_DATA *scd, int code_size, int flag, int *ZeroDataBlockP)
{
    int           i, j, ret;
    unsigned char count;

    ... 

    if ((count = GetDataBlock(fd, &amp;scd-&gt;buf[2], ZeroDataBlockP)) &lt;= 0)
        scd-&gt;done = TRUE;

    ...
}
```
<a href="https://github.com/php/php-src/blob/c5767db441e4db2a1e07b5880129ad7ce0b25b6f/ext/gd/libgd/gd_gif_in.c#L376" rel="nofollow">https://github.com/php/php-src/blob/c5767db441e4db2a1e07b5880129ad7ce0b25b6f/ext/gd/libgd/gd_gif_in.c#L376</a>

As you can see, `GetDataBlock` will read the image data and return the length. If EOF, returned -1. But the variable `count` is `unsigned char`, will always be positive value. So the line `scd-&gt;done = TRUE` will never be executed.


I think the easiest patch is change `unsigned char` to `int`.



Test script:
---------------
$ curl <a href="https://gist.githubusercontent.com/orangetw/adb0e2519df267eb54d8b68027a91d4c/raw/7a7d6938f59dd89e9a9b7304d71f8f6640609479/poc.gif.xxd" rel="nofollow">https://gist.githubusercontent.com/orangetw/adb0e2519df267eb54d8b68027a91d4c/raw/7a7d6938f59dd89e9a9b7304d71f8f6640609479/poc.gif.xxd</a> | xxd -r &gt; poc.gif

$ php -r 'imagecreatefromgif(&quot;poc.gif&quot;);'
hang here...



</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=75571&amp;patch=fix-75571&amp;revision=latest" >fix-75571</a>
(last revision 2017-11-29 18:54 UTC by cmb@php.net)
<br><p><a href='patch-add.php?bug_id=75571'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=75571'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1511889540">&nbsp;</a><strong>[2017-11-28 17:19 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_log' ><a name="1511981616">&nbsp;</a><strong>[2017-11-29 18:53 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary:     Infinity loop in GD GIF parsing function
              leads to Denied of Service</span>
<span class="added">+Summary:     Potential infinite loop in
              gdImageCreateFromGifCtx</span>
<span class="removed">-Status:      Assigned</span>
<span class="added">+Status:      Analyzed</span>
<span class="removed">-Assigned To: cmb</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1511981617">&nbsp;</a><strong>[2017-11-29 18:53 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this issue!  Indeed, this is an exploitable
Denial of Service vulnerability, and all PHP versions are
affected.  Furthermore, libgd is also affected; I have already
forwarded this issue to security@libgd.org including a respective
patch.

Stas, can you please commit the patch I'm going to attach to the
security repo (PHP-5.6 and up)?  It would be nice if it were
possible to sync the respective releases of GD and PHP.
</pre>
</div><div class='comment type_patch' ><a name="1511981665">&nbsp;</a><strong>[2017-11-29 18:54 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: fix-75571
Revision:   1511981663
URL:        <a href="https://bugs.php.net/patch-display.php?bug=75571&amp;patch=fix-75571&amp;revision=1511981663" rel="nofollow">https://bugs.php.net/patch-display.php?bug=75571&amp;patch=fix-75571&amp;revision=1511981663</a>
</pre>
</div><div class='comment type_comment' ><a name="1512165776">&nbsp;</a><strong>[2017-12-01 22:02 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as 07dd4c36e5b2bd6032a1e589f31e87ccde4334c1 and in <a href="https://gist.github.com/2c5331292f9e77e694ad9dd8901a3a11" rel="nofollow">https://gist.github.com/2c5331292f9e77e694ad9dd8901a3a11</a>
</pre>
</div><div class='comment type_log' ><a name="1512165791">&nbsp;</a><strong>[2017-12-01 22:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_log' ><a name="1514867234">&nbsp;</a><strong>[2018-01-02 04:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.2Git-2017-11-25 (Git)</span>
<span class="added">+PHP Version: 5.6.32</span>
</div></div></div><div class='comment type_svn' ><a name="1514867263">&nbsp;</a><strong>[2018-01-02 04:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8d6e9588671136837533fe3785657c31c5b52767" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8d6e9588671136837533fe3785657c31c5b52767</a>
Log: Fixed <a href='bug.php?id=75571'>bug #75571</a>: Potential infinite loop in gdImageCreateFromGifCtx
</pre>
</div><div class='comment type_log' ><a name="1514867263">&nbsp;</a><strong>[2018-01-02 04:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Analyzed</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1514870752">&nbsp;</a><strong>[2018-01-02 05:25 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8d6e9588671136837533fe3785657c31c5b52767" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8d6e9588671136837533fe3785657c31c5b52767</a>
Log: Fixed <a href='bug.php?id=75571'>bug #75571</a>: Potential infinite loop in gdImageCreateFromGifCtx
</pre>
</div><div class='comment type_svn' ><a name="1514874771">&nbsp;</a><strong>[2018-01-02 06:32 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=40d4118efe85b967b5ca2606f9d3009e013faf36" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=40d4118efe85b967b5ca2606f9d3009e013faf36</a>
Log: Fixed <a href='bug.php?id=75571'>bug #75571</a>: Potential infinite loop in gdImageCreateFromGifCtx
</pre>
</div><div class='comment type_svn' ><a name="1514930786">&nbsp;</a><strong>[2018-01-02 22:06 UTC] <a href="//people.php.net/pollita">pollita@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=3b50e238b2d7ec2a3d46aa428694e02479477b7a" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=3b50e238b2d7ec2a3d46aa428694e02479477b7a</a>
Log: Fixed <a href='bug.php?id=75571'>bug #75571</a>: Potential infinite loop in gdImageCreateFromGifCtx
</pre>
</div><div class='comment type_svn' ><a name="1514945011">&nbsp;</a><strong>[2018-01-03 02:03 UTC] <a href="//people.php.net/pollita">pollita@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f03943129b18fac7bbb0801eef8298e13cfce106" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f03943129b18fac7bbb0801eef8298e13cfce106</a>
Log: Fixed <a href='bug.php?id=75571'>bug #75571</a>: Potential infinite loop in gdImageCreateFromGifCtx
</pre>
</div><div class='comment type_log' ><a name="1516093552">&nbsp;</a><strong>[2018-01-16 09:05 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2018-5711</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
