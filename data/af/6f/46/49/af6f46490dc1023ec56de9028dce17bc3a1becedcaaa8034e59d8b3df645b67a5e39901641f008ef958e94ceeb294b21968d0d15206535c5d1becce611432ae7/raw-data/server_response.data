<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>3b6f84b77c30ec0bab5147b0cffc192c86ba2634 - platform/frameworks/base - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/frameworks/base/%2B/3b6f84b77c30ec0bab5147b0cffc192c86ba2634">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/">frameworks</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/base/">base</a> / <span class="Breadcrumbs-crumb">3b6f84b77c30ec0bab5147b0cffc192c86ba2634</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>3b6f84b77c30ec0bab5147b0cffc192c86ba2634</td><td><span>[<a href="/platform/frameworks/base/+log/3b6f84b77c30ec0bab5147b0cffc192c86ba2634">log</a>]</span> <span>[<a href="/platform/frameworks/base/+archive/3b6f84b77c30ec0bab5147b0cffc192c86ba2634.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Mihai Popa &lt;popam@google.com&gt;</td><td>Wed May 09 17:31:48 2018 +0100</td></tr><tr><th class="Metadata-title">committer</th><td>Mihai Popa &lt;popam@google.com&gt;</td><td>Mon Jun 04 16:22:05 2018 +0100</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/">a92e70e875a6e4c972570be0f94d6ceb3d68a6a8</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634%5E">857326e3731939f6ec7979e1d86585bf0ea484f4</a> <span>[<a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">Optimise the hit test algorithm

Layout#getOffsetForHorizontal was running in O(n^2) time, where n is the
length of the current line. The method is used when a touch event
happens on a text line, to compute the cursor offset (and the character)
where it happened. Although this is not an issue in common usecases,
where the number of characters on a line is relatively small, this can
be very inefficient as a consequence of Unicode containing 0-width
(invisible) characters. Specifically, there are characters defining the
text direction (LTR or RTL), which cause our algorithm to touch the
worst case quadratic runtime. For example, a person is able to send a
message containing a few visible characters, and also a lot of these
direction changing invisible ones. When the receiver touches the message
(causing the Layout#getOffsetForHorizontal method to be called), the
receiver&#39;s application would become not responsive.

This CL optimizes the method to run in O(n) worst case. This is achieved
by computing the measurements of all line prefixes at first, which can
be done in a single pass. Then, all the prefix measurement queries will
be answered in O(1), rather than O(n) as it was happening before.

Bug: 79215201
Test: manual testing
Change-Id: <a href="https://android-review.googlesource.com/#/q/Ib66ef392c19c937718e7101f6d48fac3abe51ad0">Ib66ef392c19c937718e7101f6d48fac3abe51ad0</a>
Merged-In: <a href="https://android-review.googlesource.com/#/q/Ib66ef392c19c937718e7101f6d48fac3abe51ad0">Ib66ef392c19c937718e7101f6d48fac3abe51ad0</a>
</pre><ul class="DiffTree"><li><a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/core/java/android/text/Layout.java">core/java/android/text/Layout.java</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634%5E%21/#F0">diff</a>]</span></li><li><a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/core/java/android/text/TextLine.java">core/java/android/text/TextLine.java</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634%5E%21/#F1">diff</a>]</span></li></ul><div class="DiffSummary">2 files changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: a92e70e875a6e4c972570be0f94d6ceb3d68a6a8</div><ol class="FileList"><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.mk"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/Android.mk">Android.mk</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CleanSpec.mk"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/CleanSpec.mk">CleanSpec.mk</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - MODULE_LICENSE_APACHE2"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/MODULE_LICENSE_APACHE2">MODULE_LICENSE_APACHE2</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - NOTICE"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/NOTICE">NOTICE</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - api/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/api/">api/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - cmds/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/cmds/">cmds/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - core/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/core/">core/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - data/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/data/">data/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - docs/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/docs/">docs/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - drm/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/drm/">drm/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - graphics/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/graphics/">graphics/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - include/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/include/">include/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - keystore/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/keystore/">keystore/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - libs/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/libs/">libs/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - location/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/location/">location/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - media/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/media/">media/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - native/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/native/">native/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - nfc-extras/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/nfc-extras/">nfc-extras/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - obex/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/obex/">obex/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - opengl/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/opengl/">opengl/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - packages/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/packages/">packages/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - preloaded-classes"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/preloaded-classes">preloaded-classes</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - rs/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/rs/">rs/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - samples/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/samples/">samples/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - sax/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/sax/">sax/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - services/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/services/">services/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - telecomm/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/telecomm/">telecomm/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - telephony/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/telephony/">telephony/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - test-runner/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/test-runner/">test-runner/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tests/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/tests/">tests/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tools/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/tools/">tools/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - wifi/"><a class="FileList-itemLink" href="/platform/frameworks/base/+/3b6f84b77c30ec0bab5147b0cffc192c86ba2634/wifi/">wifi/</a></li></ol></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>