<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>931418b16c7197ca2df34c2a5609e49791125abe - platform/system/netd - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/system/netd/%2B/931418b16c7197ca2df34c2a5609e49791125abe">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/system/">system</a> / <a class="Breadcrumbs-crumb" href="/platform/system/netd/">netd</a> / <span class="Breadcrumbs-crumb">931418b16c7197ca2df34c2a5609e49791125abe</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>931418b16c7197ca2df34c2a5609e49791125abe</td><td><span>[<a href="/platform/system/netd/+log/931418b16c7197ca2df34c2a5609e49791125abe">log</a>]</span> <span>[<a href="/platform/system/netd/+archive/931418b16c7197ca2df34c2a5609e49791125abe.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Bjoern Johansson &lt;bjoernj@google.com&gt;</td><td>Thu Jul 19 12:30:55 2018 -0700</td></tr><tr><th class="Metadata-title">committer</th><td>android-build-team Robot &lt;android-build-team-robot@google.com&gt;</td><td>Thu Aug 16 16:02:39 2018 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/">ac224f88b4e396cf812f77201b51af32623b14aa</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe%5E">412a7e50a9e9b88bee3f4154e49df7d975377194</a> <span>[<a href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">Set optlen for UDP-encap check in XfrmController

When setting the socket owner for an encap socket XfrmController will
first attempt to verify that the socket has the UDP-encap socket option
set. When doing so it would pass in an uninitialized optlen parameter
which could cause the call to not modify the option value if the optlen
happened to be too short. So for example if the stack happened to
contain a zero where optlen was located the check would fail and the
socket owner would not be changed.

Fix this by setting optlen to the size of the option value parameter.

Test: run cts -m CtsNetTestCases
BUG: 111650288
Change-Id: <a href="https://android-review.googlesource.com/#/q/I57b6e9dba09c1acda71e3ec2084652e961667bd9">I57b6e9dba09c1acda71e3ec2084652e961667bd9</a>
(cherry picked from commit fc42a105147310bd680952d4b71fe32974bd8506)
</pre><ul class="DiffTree"><li><a href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/server/XfrmController.cpp">server/XfrmController.cpp</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe%5E%21/#F0">diff</a>]</span></li></ul><div class="DiffSummary">1 file changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: ac224f88b4e396cf812f77201b51af32623b14aa</div><ol class="FileList"><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.bp"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/Android.bp">Android.bp</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.mk"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/Android.mk">Android.mk</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - MODULE_LICENSE_APACHE2"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/MODULE_LICENSE_APACHE2">MODULE_LICENSE_APACHE2</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - NOTICE"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/NOTICE">NOTICE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - OWNERS"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/OWNERS">OWNERS</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - bpfloader/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/bpfloader/">bpfloader/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - client/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/client/">client/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - include/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/include/">include/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - libbpf/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/libbpf/">libbpf/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - libnetdutils/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/libnetdutils/">libnetdutils/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - netutils_wrappers/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/netutils_wrappers/">netutils_wrappers/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - server/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/server/">server/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tests/"><a class="FileList-itemLink" href="/platform/system/netd/+/931418b16c7197ca2df34c2a5609e49791125abe/tests/">tests/</a></li></ol></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>