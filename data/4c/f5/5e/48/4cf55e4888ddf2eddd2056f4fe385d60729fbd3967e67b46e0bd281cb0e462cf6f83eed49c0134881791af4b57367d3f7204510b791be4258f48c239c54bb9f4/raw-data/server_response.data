<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #76409 - RDF' href='rss/bug.php?id=76409'>
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #76409 - RSS 2.0' href='rss/bug.php?id=76409&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #76409 :: heap use after free in _php_stream_free</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=76409">Sec Bug</a>&nbsp;#76409</th>
            <td id="summary" colspan="5">heap use after free in _php_stream_free</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2018-06-03 00:11 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2018-06-27 09:27 UTC</td>
            <td rowspan="6">

                <table id="votes">
                    <tr><th class="details">Votes:</th><td>1</td></tr>
                    <tr><th class="details">Avg. Score:</th><td>5.0 &plusmn; 0.0</td></tr>
                    <tr><th class="details">Reproduced:</th><td>1 of 1 (100.0%)</td></tr>
                    <tr><th class="details">Same Version:</th><td>1 (100.0%)</td></tr>
                    <tr><th class="details">Same OS:</th><td>1 (100.0%)</td></tr>
                </table>

            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=EXIF+related">EXIF related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.2Git-2018-06-02 (Git)</td>
            <th class="details">OS:</th>
            <td>Ubuntu 16 LTS</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-12882" target="_blank">2018-12882</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=76409&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=76409&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=76409&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1527984696">&nbsp;</a><strong>[2018-06-03 00:11 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>Description:
------------
USE_ZEND_ALLOC=0 ./php-e147eb2 -r 'exif_read_data(file_get_contents(&quot;/full/path/to/test.jpg&quot;));'

echo &quot;Lw==&quot; | base64 -d &gt; test.jpg

od -tx1 test.jpg
0000000 2f
0000001

Expected result:
----------------
No crash.

Actual result:
--------------
==15865==ERROR: AddressSanitizer: heap-use-after-free on address 0x611000000ad0 at pc 0x0000013d8100 bp 0x7fff9778bda0 sp 0x7fff9778bd98
READ of size 8 at 0x611000000ad0 thread T0
    #0 0x13d80ff in _php_stream_free /root/php-7.2.6/main/streams/streams.c:373:13
    #1 0xe4a08f in exif_read_from_file /root/php-7.2.6/ext/exif/exif.c:4411:2
    #2 0xe4a08f in zif_exif_read_data /root/php-7.2.6/ext/exif/exif.c:4482
    #3 0x18692f5 in ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER /root/php-7.2.6/Zend/zend_vm_execute.h:573:2
    #4 0x1683367 in execute_ex /root/php-7.2.6/Zend/zend_vm_execute.h:59723:7
    #5 0x1683aa5 in zend_execute /root/php-7.2.6/Zend/zend_vm_execute.h:63760:2
    #6 0x14fdb5c in zend_eval_stringl /root/php-7.2.6/Zend/zend_execute_API.c:1082:4
    #7 0x14fe3a7 in zend_eval_stringl_ex /root/php-7.2.6/Zend/zend_execute_API.c:1123:11
    #8 0x14fe3a7 in zend_eval_string_ex /root/php-7.2.6/Zend/zend_execute_API.c:1134
    #9 0x196fd32 in do_cli /root/php-7.2.6/sapi/cli/php_cli.c:1042:8
    #10 0x196dd4f in main /root/php-7.2.6/sapi/cli/php_cli.c:1404:18
    #11 0x7fb432b3382f in __libc_start_main /build/glibc-Cl5G7W/glibc-2.23/csu/../csu/libc-start.c:291
    #12 0x43bd68 in _start (/root/php-7.2.6/sapi/cli/php+0x43bd68)

0x611000000ad0 is located 144 bytes inside of 224-byte region [0x611000000a40,0x611000000b20)
freed by thread T0 here:
    #0 0x4e2c32 in free /b/build/slave/linux_upload_clang/build/src/third_party/llvm/compiler-rt/lib/asan/asan_malloc_linux.cc:78:3
    #1 0x13d7f53 in _php_stream_free /root/php-7.2.6/main/streams/streams.c:511:3

previously allocated by thread T0 here:
    #0 0x4e2f73 in __interceptor_malloc /b/build/slave/linux_upload_clang/build/src/third_party/llvm/compiler-rt/lib/asan/asan_malloc_linux.cc:98:3
    #1 0x147855a in __zend_malloc /root/php-7.2.6/Zend/zend_alloc.c:2829:14
    #2 0x13ed4b3 in _php_stream_fopen_from_fd_int /root/php-7.2.6/main/streams/plain_wrapper.c:186:9
    #3 0x13ed4b3 in _php_stream_fopen_from_fd /root/php-7.2.6/main/streams/plain_wrapper.c:248

SUMMARY: AddressSanitizer: heap-use-after-free /root/php-7.2.6/main/streams/streams.c:373:13 in _php_stream_free

</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=76409&amp;patch=avoid-double-free.patch&amp;revision=latest" >avoid-double-free.patch</a>
(last revision 2018-06-03 12:08 UTC by cmb@php.net)
<br><p><a href='patch-add.php?bug_id=76409'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=76409'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1528027701">&nbsp;</a><strong>[2018-06-03 12:08 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:  Open</span>
<span class="added">+Status:  Verified</span>
<span class="removed">-Package: Reproducible crash</span>
<span class="added">+Package: EXIF related</span>
</div></div></div><div class='comment type_comment' ><a name="1528027704">&nbsp;</a><strong>[2018-06-03 12:08 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this issue.

It seems to me the avoid-double-free.patch fixes the bug.
</pre>
</div><div class='comment type_patch' ><a name="1528027736">&nbsp;</a><strong>[2018-06-03 12:08 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: avoid-double-free.patch
Revision:   1528027735
URL:        <a href="https://bugs.php.net/patch-display.php?bug=76409&amp;patch=avoid-double-free.patch&amp;revision=1528027735" rel="nofollow">https://bugs.php.net/patch-display.php?bug=76409&amp;patch=avoid-double-free.patch&amp;revision=1528027735</a>
</pre>
</div><div class='comment type_svn' ><a name="1528561320">&nbsp;</a><strong>[2018-06-09 16:22 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=3fdde65617e9f954e2c964768aac8831005497e5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=3fdde65617e9f954e2c964768aac8831005497e5</a>
Log: Fix #76409: heap use after free in _php_stream_free
</pre>
</div><div class='comment type_log' ><a name="1528561322">&nbsp;</a><strong>[2018-06-09 16:22 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Verified</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_log' ><a name="1528561358">&nbsp;</a><strong>[2018-06-09 16:22 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_comment' ><a name="1528562374">&nbsp;</a><strong>[2018-06-09 16:39 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>FYI, this affects the 7.2.6 release as well, but I haven't tested other versions.
</pre>
</div><div class='comment type_comment' ><a name="1528563336">&nbsp;</a><strong>[2018-06-09 16:55 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, PHP-7.2 as well as master have been affected (but not
earlier version branches), and both have been fixed.
</pre>
</div><div class='comment type_comment' ><a name="1529981551">&nbsp;</a><strong>[2018-06-26 02:52 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>CVE-2018-12882 has been assigned to this bug.
</pre>
</div><div class='comment type_log' ><a name="1530002706">&nbsp;</a><strong>[2018-06-26 08:45 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To: cmb</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1530002706">&nbsp;</a><strong>[2018-06-26 08:45 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Requesting a CVE for a bug which had been reported and discussed
publicly is pretty strange.

Stas, would do you think?
</pre>
</div><div class='comment type_log' ><a name="1530056730">&nbsp;</a><strong>[2018-06-26 23:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Bug</span>
<span class="added">+Type: Security</span>
</div></div></div><div class='comment type_comment' ><a name="1530056730">&nbsp;</a><strong>[2018-06-26 23:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I don't think CVE has something to do with publicity. CVE is an issue identifier, which allows to track it across distributions, builds, etc. and which is issued for security issues. It doesn't matter whether it was disclosed publicly or not and which version fixes it - CVE allows to track security issues in every version and thus to have a picture which issue is fixed where. 
It looks like this one also should be a security issue since exif bugs usually deal with external data. Not sure where this fix has been applied and whether it need a backport, will check.
</pre>
</div><div class='comment type_log' ><a name="1530056741">&nbsp;</a><strong>[2018-06-26 23:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2018-12882</span>
</div></div></div><div class='comment type_comment' ><a name="1530091651">&nbsp;</a><strong>[2018-06-27 09:27 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>The fix has been committed to PHP-7.2 and master (older branches
are not affected); it has missed PHP 7.2.7, though, since it has
not been regarded as security fix.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
