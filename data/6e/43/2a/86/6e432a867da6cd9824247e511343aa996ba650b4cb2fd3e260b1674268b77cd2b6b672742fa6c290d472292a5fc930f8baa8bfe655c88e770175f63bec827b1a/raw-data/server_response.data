<!DOCTYPE html>
<html lang='en'>
<head>
<title>fontconfig - Font customization and configuration library  (mirrored from https://gitlab.freedesktop.org/fontconfig/fontconfig)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/fontconfig/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/fontconfig/fontconfig' title='fontconfig Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='fontconfig' href='/fontconfig/'>fontconfig</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'/><select name='h' onchange='this.form.submit();'>
<option value='2.3-branch'>2.3-branch</option>
<option value='fc-2-12'>fc-2-12</option>
<option value='fc-2_2_branch'>fc-2_2_branch</option>
<option value='fc-2_4-keithp'>fc-2_4-keithp</option>
<option value='fc-2_4_branch'>fc-2_4_branch</option>
<option value='fc_2-3'>fc_2-3</option>
<option value='main'>main</option>
<option value='master' selected='selected'>master</option>
<option value='ultra-weight'>ultra-weight</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Font customization and configuration library  (mirrored from https://gitlab.freedesktop.org/fontconfig/fontconfig)</td><td class='sub right'>keithp</td></tr></table>
<table class='tabs'><tr><td>
<a href='/fontconfig/'>summary</a><a href='/fontconfig/refs/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>refs</a><a href='/fontconfig/log/'>log</a><a href='/fontconfig/tree/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>tree</a><a class='active' href='/fontconfig/commit/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>commit</a><a href='/fontconfig/diff/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>diff</a></td><td class='form'><form class='right' method='get' action='/fontconfig/log/'>
<input type='hidden' name='id' value='7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;</td><td class='right'>2016-06-25 19:18:53 +0200</td></tr>
<tr><th>committer</th><td>Akira TAGOH &lt;akira@tagoh.org&gt;</td><td class='right'>2016-08-05 14:35:05 +0900</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/fontconfig/commit/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940</a> (<a href='/fontconfig/patch/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/fontconfig/tree/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>720df684a84090b2ca59146cf008405e09f73b3c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/fontconfig/commit/?id=99645ff9eecbf2178199aa940703fbe8ed275867'>99645ff9eecbf2178199aa940703fbe8ed275867</a> (<a href='/fontconfig/diff/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940&amp;id2=99645ff9eecbf2178199aa940703fbe8ed275867'>diff</a>)</td></tr></table>
<div class='commit-subject'>Properly validate offsets in cache files.</div><div class='commit-msg'>The cache files are insufficiently validated. Even though the magic
number at the beginning of the file as well as time stamps are checked,
it is not verified if contained offsets are in legal ranges or are
even pointers.

The lack of validation allows an attacker to trigger arbitrary free()
calls, which in turn allows double free attacks and therefore arbitrary
code execution. Due to the conversion from offsets into pointers through
macros, this even allows to circumvent ASLR protections.

This attack vector allows privilege escalation when used with setuid
binaries like fbterm. A user can create ~/.fonts or any other
system-defined user-private font directory, run fc-cache and adjust
cache files in ~/.cache/fontconfig. The execution of setuid binaries will
scan these files and therefore are prone to attacks.

If it's not about code execution, an endless loop can be created by
letting linked lists become circular linked lists.

This patch verifies that:

- The file is not larger than the maximum addressable space, which
  basically only affects 32 bit systems. This allows out of boundary
  access into unallocated memory.
- Offsets are always positive or zero
- Offsets do not point outside file boundaries
- No pointers are allowed in cache files, every "pointer or offset"
  field must be an offset or NULL
- Iterating linked lists must not take longer than the amount of elements
  specified. A violation of this rule can break a possible endless loop.

If one or more of these points are violated, the cache is recreated.
This is current behaviour.

Even though this patch fixes many issues, the use of mmap() shall be
forbidden in setuid binaries. It is impossible to guarantee with these
checks that a malicious user does not change cache files after
verification. This should be handled in a different patch.

Signed-off-by: Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;
</div><div class='diffstat-header'><a href='/fontconfig/diff/?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/fontconfig/diff/src/fccache.c?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>src/fccache.c</a></td><td class='right'>81</td><td class='graph'><table summary='file diffstat' width='81%'><tr><td class='add' style='width: 98.8%;'/><td class='rem' style='width: 1.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 80 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/fccache.c b/src/fccache.c<br/>index 71e8f03..02ec301 100644<br/>--- a/<a href='/fontconfig/tree/src/fccache.c?id=99645ff9eecbf2178199aa940703fbe8ed275867'>src/fccache.c</a><br/>+++ b/<a href='/fontconfig/tree/src/fccache.c?id=7a4a5bd7897d216f0794ca9dbce0a4a5c9d14940'>src/fccache.c</a></div><div class='hunk'>@@ -27,6 +27,7 @@</div><div class='ctx'> #include &lt;fcntl.h&gt;</div><div class='ctx'> #include &lt;dirent.h&gt;</div><div class='ctx'> #include &lt;string.h&gt;</div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;sys/types.h&gt;</div><div class='ctx'> #include &lt;sys/stat.h&gt;</div><div class='ctx'> #include &lt;assert.h&gt;</div><div class='hunk'>@@ -587,6 +588,82 @@ FcCacheTimeValid (FcConfig *config, FcCache *cache, struct stat *dir_stat)</div><div class='ctx'>     return cache-&gt;checksum == (int) dir_stat-&gt;st_mtime &amp;&amp; fnano;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static FcBool</div><div class='add'>+FcCacheOffsetsValid (FcCache *cache)</div><div class='add'>+{</div><div class='add'>+    char		*base = (char *)cache;</div><div class='add'>+    char		*end = base + cache-&gt;size;</div><div class='add'>+    intptr_t		*dirs;</div><div class='add'>+    FcFontSet		*fs;</div><div class='add'>+    int			 i, j;</div><div class='add'>+</div><div class='add'>+    if (cache-&gt;dir &lt; 0 || cache-&gt;dir &gt; cache-&gt;size - sizeof (intptr_t) ||</div><div class='add'>+        memchr (base + cache-&gt;dir, '\0', cache-&gt;size - cache-&gt;dir) == NULL)</div><div class='add'>+        return FcFalse;</div><div class='add'>+</div><div class='add'>+    if (cache-&gt;dirs &lt; 0 || cache-&gt;dirs &gt;= cache-&gt;size ||</div><div class='add'>+        cache-&gt;dirs_count &lt; 0 ||</div><div class='add'>+        cache-&gt;dirs_count &gt; (cache-&gt;size - cache-&gt;dirs) / sizeof (intptr_t))</div><div class='add'>+        return FcFalse;</div><div class='add'>+</div><div class='add'>+    dirs = FcCacheDirs (cache);</div><div class='add'>+    if (dirs)</div><div class='add'>+    {</div><div class='add'>+        for (i = 0; i &lt; cache-&gt;dirs_count; i++)</div><div class='add'>+        {</div><div class='add'>+            FcChar8	*dir;</div><div class='add'>+</div><div class='add'>+            if (dirs[i] &lt; 0 ||</div><div class='add'>+                dirs[i] &gt; end - (char *) dirs - sizeof (intptr_t))</div><div class='add'>+                return FcFalse;</div><div class='add'>+</div><div class='add'>+            dir = FcOffsetToPtr (dirs, dirs[i], FcChar8);</div><div class='add'>+            if (memchr (dir, '\0', end - (char *) dir) == NULL)</div><div class='add'>+                return FcFalse;</div><div class='add'>+         }</div><div class='add'>+    }</div><div class='add'>+</div><div class='add'>+    if (cache-&gt;set &lt; 0 || cache-&gt;set &gt; cache-&gt;size - sizeof (FcFontSet))</div><div class='add'>+        return FcFalse;</div><div class='add'>+</div><div class='add'>+    fs = FcCacheSet (cache);</div><div class='add'>+    if (fs)</div><div class='add'>+    {</div><div class='add'>+        if (fs-&gt;nfont &gt; (end - (char *) fs) / sizeof (FcPattern))</div><div class='add'>+            return FcFalse;</div><div class='add'>+</div><div class='add'>+        if (fs-&gt;fonts != 0 &amp;&amp; !FcIsEncodedOffset(fs-&gt;fonts))</div><div class='add'>+            return FcFalse;</div><div class='add'>+</div><div class='add'>+        for (i = 0; i &lt; fs-&gt;nfont; i++)</div><div class='add'>+        {</div><div class='add'>+            FcPattern		*font = FcFontSetFont (fs, i);</div><div class='add'>+            FcPatternElt	*e;</div><div class='add'>+            FcValueListPtr	 l;</div><div class='add'>+</div><div class='add'>+            if ((char *) font &lt; base ||</div><div class='add'>+                (char *) font &gt; end - sizeof (FcFontSet) ||</div><div class='add'>+                font-&gt;elts_offset &lt; 0 ||</div><div class='add'>+                font-&gt;elts_offset &gt; end - (char *) font ||</div><div class='add'>+                font-&gt;num &gt; (end - (char *) font - font-&gt;elts_offset) / sizeof (FcPatternElt))</div><div class='add'>+                return FcFalse;</div><div class='add'>+</div><div class='add'>+</div><div class='add'>+            e = FcPatternElts(font);</div><div class='add'>+            if (e-&gt;values != 0 &amp;&amp; !FcIsEncodedOffset(e-&gt;values))</div><div class='add'>+                return FcFalse;</div><div class='add'>+</div><div class='add'>+            for (j = font-&gt;num, l = FcPatternEltValues(e); j &gt;= 0 &amp;&amp; l; j--, l = FcValueListNext(l))</div><div class='add'>+                if (l-&gt;next != NULL &amp;&amp; !FcIsEncodedOffset(l-&gt;next))</div><div class='add'>+                    break;</div><div class='add'>+            if (j &lt; 0)</div><div class='add'>+                return FcFalse;</div><div class='add'>+        }</div><div class='add'>+    }</div><div class='add'>+</div><div class='add'>+    return FcTrue;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /*</div><div class='ctx'>  * Map a cache file into memory</div><div class='ctx'>  */</div><div class='hunk'>@@ -596,7 +673,8 @@ FcDirCacheMapFd (FcConfig *config, int fd, struct stat *fd_stat, struct stat *di</div><div class='ctx'>     FcCache	*cache;</div><div class='ctx'>     FcBool	allocated = FcFalse;</div><div class='ctx'> </div><div class='del'>-    if (fd_stat-&gt;st_size &lt; (int) sizeof (FcCache))</div><div class='add'>+    if (fd_stat-&gt;st_size &gt; INTPTR_MAX ||</div><div class='add'>+        fd_stat-&gt;st_size &lt; (int) sizeof (FcCache))</div><div class='ctx'> 	return NULL;</div><div class='ctx'>     cache = FcCacheFindByStat (fd_stat);</div><div class='ctx'>     if (cache)</div><div class='hunk'>@@ -652,6 +730,7 @@ FcDirCacheMapFd (FcConfig *config, int fd, struct stat *fd_stat, struct stat *di</div><div class='ctx'>     if (cache-&gt;magic != FC_CACHE_MAGIC_MMAP ||</div><div class='ctx'> 	cache-&gt;version &lt; FC_CACHE_VERSION_NUMBER ||</div><div class='ctx'> 	cache-&gt;size != (intptr_t) fd_stat-&gt;st_size ||</div><div class='add'>+        !FcCacheOffsetsValid (cache) ||</div><div class='ctx'> 	!FcCacheTimeValid (config, cache, dir_stat) ||</div><div class='ctx'> 	!FcCacheInsert (cache, fd_stat))</div><div class='ctx'>     {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:08 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
