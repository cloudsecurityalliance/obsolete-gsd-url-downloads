<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Bug 690202 – Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://bugzilla.gnome.org/" rel="Top"/>
<link href="showdependencytree.cgi?id=690202&amp;hide_resolved=1" rel="Show" title="Dependency Tree"/>
<link href="show_bug.cgi?format=multiple&amp;id=690202" rel="Show" title="Printer-Friendly Version"/>
<link href="skins/standard/global.css" rel="alternate stylesheet" title="Classic"/><link href="js/yui/assets/skins/sam/autocomplete.css" rel="stylesheet" type="text/css"/><link href="js/yui/assets/skins/sam/calendar.css" rel="stylesheet" type="text/css"/><link href="skins/standard/global.css" rel="stylesheet" type="text/css"/><link href="skins/standard/show_bug.css" rel="stylesheet" type="text/css"/><!--[if lte IE 7]>
      


  <link href="skins/standard/IE-fixes.css" rel="stylesheet"
        type="text/css" >
<![endif]-->
<link href="skins/contrib/Gnome/global.css" rel="stylesheet" title="Gnome" type="text/css"/>
<script src="js/yui/yahoo-dom-event/yahoo-dom-event.js" type="text/javascript"></script><script src="js/yui/cookie/cookie-min.js" type="text/javascript"></script><script src="js/yui/datasource/datasource-min.js" type="text/javascript"></script><script src="js/yui/connection/connection-min.js" type="text/javascript"></script><script src="js/yui/json/json-min.js" type="text/javascript"></script><script src="js/yui/autocomplete/autocomplete-min.js" type="text/javascript"></script><script src="js/yui/calendar/calendar-min.js" type="text/javascript"></script><script src="js/global.js" type="text/javascript"></script>
<script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 50
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    'You must enter a Description for this attachment.',
                component_required:
                    'You must select a Component for this bug.',
                description_required:
                    'You must enter a Description for this bug.',
                short_desc_required:
                    'You must enter a Summary for this bug.',
                version_required:
                    'You must select a Version for this bug.'
            }
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null, 
                             "Bug 690202 – Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT",  
                             "show_bug.cgi?id=690202" );
        document.title = "Bug 690202 – Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "Bug 690202 – Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();
    });
    // -->
    </script>
<script src="js/util.js" type="text/javascript"></script><script src="js/field.js" type="text/javascript"></script>
<link href="./search_plugin.cgi" rel="search" title="GNOME Bugzilla" type="application/opensearchdescription+xml"/>
<link href="images/favicon.ico" rel="shortcut icon"/><link href="extensions/TraceParser/web/style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="bugzilla-gnome-org bz_bug bz_status_RESOLVED bz_product_libxml2 bz_component_general bz_bug_690202 yui-skin-sam" onload="">
<div id="header">
<div id="banner">
</div>
<table border="0" cellpadding="0" cellspacing="0" id="titles">
<tr>
<td id="title">
<p>GNOME Bugzilla – Bug 690202</p>
</td>
<td id="subtitle">
<p class="subheader">Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT</p>
</td>
<td id="information">
<p class="header_addl_info">Last modified: 2021-07-05 13:25:57 UTC</p>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" class="bz_default_hidden" id="lang_links_container"><tr><td>
</td></tr></table>
<ul class="links"><li><a href="./">Home</a></li></ul>
</div>
<div id="bugzilla-body">
<div style="margin-bottom: 50px; margin-top: 50px; padding: 40px; text-align: center; background-color: rgb(74,134,207); border: rgb(57,104,161); color: rgb(255,255,255); line-height: 300%;">After an <a href="https://wiki.gnome.org/Initiatives/DevelopmentInfrastructure" style="color: rgb(255,255,255);">evaluation</a>, GNOME has moved from Bugzilla to <a href="https://gitlab.gnome.org/" style="color: rgb(255,255,255);">GitLab</a>. <a href="https://wiki.gnome.org/GitLab" style="color: rgb(255,255,255);">Learn more about GitLab</a>. <br/><span style="background-color: #EE0000; font-size: xx-large;"><b>No new issues can be reported in GNOME Bugzilla anymore.</b></span>
<br/><span style="background-color: #EE0000; font-size: xx-large;"><b>To report an issue in a GNOME project, <a href="https://gitlab.gnome.org/GNOME" style="color: rgb(255,255,255);">go to GNOME GitLab</a></b>.</span><br/>Do <b>not</b> go to GNOME Gitlab for: <a href="https://sourceforge.net/p/bluefish/tickets" style="color: rgb(255,255,255);">Bluefish</a>, <a href="https://github.com/doxygen/doxygen/issues" style="color: rgb(255,255,255);">Doxygen</a>, <a href="https://bugs.gnucash.org/" style="color: rgb(255,255,255);">GnuCash</a>, <a href="https://gitlab.freedesktop.org/gstreamer/" style="color: rgb(255,255,255);">GStreamer</a>, <a href="https://github.com/afcowie/java-gnome/issues" style="color: rgb(255,255,255);">java-gnome</a>, <a href="https://github.com/ldtp/ldtp2/issues" style="color: rgb(255,255,255);">LDTP</a>, <a href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager/issues" style="color: rgb(255,255,255);">NetworkManager</a>, <a href="https://github.com/tomboy-notes/tomboy/issues" style="color: rgb(255,255,255);">Tomboy</a>.</div>
<script type="text/javascript">
<!--

//-->
</script>
<form action="process_bug.cgi" id="changeform" method="post" name="changeform">
<input name="delta_ts" type="hidden" value="2021-07-05 13:25:57"/>
<input name="longdesclength" type="hidden" value="13"/>
<input name="id" type="hidden" value="690202"/>
<input name="token" type="hidden" value="1626095099-FMCMtk5LP2v-Oh1e-hjyVUGT6hI290EveAJq2i3HaoE"/>
<div class="bz_alias_short_desc_container edit_form">
<a href="show_bug.cgi?id=690202"><b>Bug 690202</b></a> -<span class="bz_default_hidden" id="summary_alias_container">
<span id="short_desc_nonedit_display">Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT</span>
</span>
<div id="summary_alias_input">
<table id="summary">
<tr>
<td colspan="2">
</td>
</tr>
<tr><th class="field_label" id="field_label_short_desc">
<label accesskey="s" for="short_desc">
<a class="field_help_link" href="page.cgi?id=fields.html#short_desc" title="The bug summary is a short sentence which succinctly describes what the bug is about.">Summary:</a>
</label>
</th>
<td>Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT
          </td>
</tr>
</table>
</div>
</div>
<script type="text/javascript">
    hideAliasAndSummary('Buffer overflow errors originating from xmlBufGetInputBase in 2.9.0, ToT', '');
  </script>
<table class="edit_form">
<tr>
<td class="bz_show_bug_column" id="bz_show_bug_column_1">
<table>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
<td id="bz_field_status">
<span id="static_bug_status">RESOLVED
          OBSOLETE
      </span>
</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_product">
<a class="field_help_link" href="describecomponents.cgi" title="Bugs are categorised into Products and Components. Select a Classification to narrow down this list.">Product:</a>
</th>
<td class="field_value" id="field_container_product">libxml2</td>
</tr>
<tr class="bz_default_hidden"><th class="field_label" id="field_label_classification">
<a class="field_help_link" href="page.cgi?id=fields.html#classification" title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.">Classification:</a>
</th>
<td class="field_value" id="field_container_classification">Platform</td>
</tr>
<tr><th class="field_label" id="field_label_component">
<a class="field_help_link" href="describecomponents.cgi?product=libxml2" title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.">Component:</a>
</th>
<td class="field_value" id="field_container_component">general</td>
</tr>
<tr><th class="field_label" id="field_label_version">
<label for="version">
<a class="field_help_link" href="page.cgi?id=fields.html#version" title="The version field defines the version of the software the bug was found in.">Version:</a>
</label>
</th>
<td>git master
  </td>
</tr>
<tr><th class="field_label" id="field_label_rep_platform">
<label accesskey="h" for="rep_platform">
<a class="field_help_link" href="page.cgi?id=fields.html#rep_platform" title='The hardware platform the bug was observed on. Note: When searching, selecting the option "All" only finds bugs whose value for this field is literally the word "All".'>Hardware:</a>
</label>
</th>
<td class="field_value">Other
       Linux
      </td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr>
<th class="field_label">
<label accesskey="i" for="priority">
<a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
<td>Normal
       normal
      </td>
</tr>
<tr>
<th class="field_label">
<label for="target_milestone">
<a href="page.cgi?id=fields.html#target_milestone">
            Target Milestone</a></label>:
        </th><td>---
  </td>
</tr>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#assigned_to">Assigned To</a>:
      </th>
<td><span class="vcard"><span class="fn">Daniel Veillard</span>
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_qa_contact">
<label accesskey="q" for="qa_contact">
<a class="field_help_link" href="page.cgi?id=fields.html#qa_contact" title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.">QA Contact:</a>
</label>
</th>
<td><span class="vcard"><span class="fn">libxml QA maintainers</span>
</span>
</td>
</tr>
<script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'daniel\x40veillard.com',
        'libxml-qa-maint\x40gnome.bugs');
    </script>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_bug_file_loc">
<label accesskey="u" for="bug_file_loc">
<a class="field_help_link" href="page.cgi?id=fields.html#bug_file_loc" title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.">URL:</a>
</label>
</th>
<td>
<span id="bz_url_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_status_whiteboard">
<label accesskey="w" for="status_whiteboard">
<a class="field_help_link" href="page.cgi?id=fields.html#status_whiteboard" title="Each bug has a free-form single line text entry box for adding tags and status information.">Whiteboard:</a>
</label>
</th><td colspan="2">
</td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_dependson">
<a class="field_help_link" href="page.cgi?id=fields.html#dependson" title="The bugs listed here must be resolved before this bug can be resolved.">Depends on:</a>
</th>
<td>
<span id="dependson_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_blocked">
<a class="field_help_link" href="page.cgi?id=fields.html#blocked" title="This bug must be resolved before the bugs listed in this field can be resolved.">Blocks:</a>
</th>
<td>
<span id="blocked_input_area">
</span>
</td>
</tr>
<tr>
<th> </th>

</tr>
</table>
</td>
<td>
<div class="bz_column_spacer"> </div>
</td>
<td class="bz_show_bug_column" id="bz_show_bug_column_2">
<table cellpadding="3" cellspacing="1">
<tr>
<th class="field_label">
      Reported:
    </th>
<td>2012-12-14 10:18 UTC by <span class="vcard"><span class="fn">Zan Dobersek</span>
</span>
</td>
</tr>
<tr>
<th class="field_label">
      Modified:
    </th>
<td>2021-07-05 13:25 UTC 
    </td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_see_also">
<a class="field_help_link" href="page.cgi?id=fields.html#see_also" title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.">See Also:</a>
</th>
<td class="field_value" id="field_container_see_also"></td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_target">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_target" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME target:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_target">---</td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_version">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_version" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME version:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_version">---</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
</table>
</td>
</tr>
<tr>
<td colspan="3">
<hr id="bz_top_half_spacer"/>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" id="bz_big_form_parts"><tr>
<td>
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>
<br/>
<table cellpadding="4" cellspacing="0" id="attachment_table">
<tr id="a0">
<th align="left" colspan="2">
      Attachments
    </th>
</tr>
<tr class="bz_contenttype_text_plain" id="a1">
<td valign="top">
<a href="attachment.cgi?id=231560" title="View the content of the attachment">
<b>GDB output</b></a>
<span class="bz_attach_extra_info">
              (7.44 KB,
                text/plain)

            <br/>
<a href="#attach_231560" title="Go to the comment associated with the attachment">2012-12-14 10:19 UTC</a>,

            <span class="vcard"><span class="fn">Zan Dobersek</span>
</span>
</span>
</td>
<td valign="top">
<a href="attachment.cgi?id=231560&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_application_octet-stream" id="a2">
<td valign="top">
<a href="attachment.cgi?id=234891" title="View the content of the attachment">
<b>Standalone reproducible case</b></a>
<span class="bz_attach_extra_info">
              (68.57 KB,
                application/octet-stream)

            <br/>
<a href="#attach_234891" title="Go to the comment associated with the attachment">2013-01-31 09:48 UTC</a>,

            <span class="vcard"><span class="fn">Mark Rowe</span>
</span>
</span>
</td>
<td valign="top">
<a href="attachment.cgi?id=234891&amp;action=edit">Details</a>
</td>
</tr>

</table>
<br/>
</td>
<td>
</td>
</tr></table>
<div id="comments"><script src="js/comments.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>
<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table cellpadding="0" cellspacing="0" class="bz_comment_table"><tr>
<td>
<div class="bz_comment bz_first_comment" id="c0">
<div class="bz_first_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c0">Description</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Zan Dobersek</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2012-12-14 10:18:10 UTC
        </span>
</div>
<pre class="bz_comment_text">WebKitGTK+ recently bumped the libxml2 dependency to 2.9.0, and immediately buffer overflow errors started appearing, signalled by the following stderr output in some test cases:
internal buffer error : No error message provided

The error was traced back into xmlBufGetInputBase. I'll upload the backtrace and memory examination shortly.</pre>
</div><div class="bz_comment" id="c1">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c1">Comment 1</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Zan Dobersek</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2012-12-14 10:19:37 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=231560" name="attach_231560" title="GDB output">attachment 231560</a> <a href="attachment.cgi?id=231560&amp;action=edit" title="GDB output">[details]</a></span>
GDB output</pre>
</div><div class="bz_comment" id="c2">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c2">Comment 2</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Zan Dobersek</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2012-12-14 11:35:27 UTC
        </span>
</div>
<pre class="bz_comment_text">The error is currently reported in two layout tests:
<a href="http://trac.webkit.org/browser/trunk/LayoutTests/http/tests/security/xss-DENIED-xsl-document-redirect.xml">http://trac.webkit.org/browser/trunk/LayoutTests/http/tests/security/xss-DENIED-xsl-document-redirect.xml</a>
<a href="http://trac.webkit.org/browser/trunk/LayoutTests/http/tests/security/xss-DENIED-xsl-external-entity-redirect.xml">http://trac.webkit.org/browser/trunk/LayoutTests/http/tests/security/xss-DENIED-xsl-external-entity-redirect.xml</a></pre>
</div><div class="bz_comment" id="c3">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c3">Comment 3</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Daniel Veillard</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2012-12-21 03:54:21 UTC
        </span>
</div>
<pre class="bz_comment_text">Hum, it seems that somehow WebKitGTK+ is messing up with the
parser input, probably doing so using the old xmlBuffer APIs.
As such the gdb output doesn't really help, the data were modified
before as part of WebKitGTK handling for those XSS cases.

As a result some of the additional checks added to the new buffer
code in xmlbuf.c fail.

Double check where and how WebKitGTK+ is modifying the current XML
parser input, the main change at the libxml2 level is:

<a href="http://git.gnome.org/browse/libxml2/commit/?id=65c7d3b2e6506283eecd19a23dcf0122fbcdac33">http://git.gnome.org/browse/libxml2/commit/?id=65c7d3b2e6506283eecd19a23dcf0122fbcdac33</a>

if you are touching ctxt-&gt;input-&gt;buf-&gt;buffer or ctxt-&gt;input-&gt;buf-&gt;raw
directly, well you probably should not modify the parser internal data
to handle those denied requests.

The following commit switching the XML parser internals to the new structure
<a href="http://git.gnome.org/browse/libxml2/commit/?id=768eb3b82d25f9635a68cc06385d9e64b3c4dd18">http://git.gnome.org/browse/libxml2/commit/?id=768eb3b82d25f9635a68cc06385d9e64b3c4dd18</a>

can probably give you hints on how to fix that code.

Daniel</pre>
</div><div class="bz_comment" id="c4">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c4">Comment 4</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Dan Winship</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2012-12-23 17:43:02 UTC
        </span>
</div>
<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=690202#c3">comment #3</a>)
<span class="quote">&gt; Double check where and how WebKitGTK+ is modifying the current XML
&gt; parser input, the main change at the libxml2 level is:
&gt; 
&gt; <a href="http://git.gnome.org/browse/libxml2/commit/?id=65c7d3b2e6506283eecd19a23dcf0122fbcdac33">http://git.gnome.org/browse/libxml2/commit/?id=65c7d3b2e6506283eecd19a23dcf0122fbcdac33</a>
&gt; 
&gt; if you are touching ctxt-&gt;input-&gt;buf-&gt;buffer or ctxt-&gt;input-&gt;buf-&gt;raw
&gt; directly, well you probably should not modify the parser internal data
&gt; to handle those denied requests.</span>

Hm. Nope, doesn't seem to be doing that.

The weirdest thing I see in the code is that apparently WebKit will have always already converted the XML to UTF-16 before libxml2 ever sees it, but the xml may still have some encoding="UTF-8" or whatever declaration in it, which libxml2 will try to take into account, and so WebKit hacks around this by calling xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_UTF16LE) before every xmlParseChunk() call. Could that cause problems? (And is there any saner way of dealing with this issue?)</pre>
</div><div class="bz_comment" id="c5">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c5">Comment 5</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Mark Rowe</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-01-31 09:48:06 UTC
        </span>
</div>
<pre class="bz_comment_text">I saw this while I was investigating <a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=692915" title="RESOLVED FIXED - libxml2 v2.9.0 emits spurious errors when dealing with large CDATA sections in UTF-16 input">bug 692915</a>. I've managed to construct a standalone, reproducible case of this outside of WebKit. It does appear to be related to the use of "xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_UTF16LE);", though in my standalone test case this is only called a single time before the intial chunk is passed to xmlParseChunk.

The attached standlone test case can be compiled with a command like:

cc -g -lxml2 -I/usr/include/libxml2 -o libxml2-decoding-bug-2 libxml2-decoding-bug-2.c

The output with libxml2 v2.9.0 and TOT looks like so:

Character count: 64400
startElement: root
xmlParseChunk result: 0
internal buffer error : No error message provided
Extra content at the end of the document
xmlParseChunk result: 5

With a debug malloc implementation, OS X's guard malloc, enabled I reproducibly see a crash inside xmlParseGetLasts prior to any overflow error being detected by libxml2.

-&gt; 10930		while ((tmp &gt;= ctxt-&gt;input-&gt;base) &amp;&amp; (*tmp != '&lt;')) tmp--;

ctxt-&gt;input-&gt;base and ctxt-&gt;input-&gt;end both appear to point to deallocated memory.

There's clearly some form of serious memory management bug here.</pre>
</div><div class="bz_comment" id="c6">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c6">Comment 6</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Mark Rowe</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-01-31 09:48:33 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=234891" name="attach_234891" title="Standalone reproducible case">attachment 234891</a> <a href="attachment.cgi?id=234891&amp;action=edit" title="Standalone reproducible case">[details]</a></span>
Standalone reproducible case</pre>
</div><div class="bz_comment" id="c7">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c7">Comment 7</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Mark Rowe</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-01-31 11:37:58 UTC
        </span>
</div>
<pre class="bz_comment_text">It looks like the input buffer is being grown by a call to xmlBufGrow within xmlCharEncInput. This results in realloc moving the buffer, while the base / end pointers still point in to the old buffer. I think the fix may look something like:

<span class="quote">&gt; diff --git a/parser.c b/parser.c
&gt; index 31f90d6..08f1a6b 100644
&gt; --- a/parser.c
&gt; +++ b/parser.c
&gt; @@ -12146,16 +12146,17 @@ xmldecl_done:
&gt;  
&gt;                 nbchars = xmlCharEncInput(in);
&gt;                 if (nbchars &lt; 0) {
&gt;                     /* TODO 2.6.0 */
&gt;                     xmlGenericError(xmlGenericErrorContext,
&gt;                                     "xmlParseChunk: encoder error\n");
&gt;                     return(XML_ERR_INVALID_ENCODING);
&gt;                 }
&gt; +               xmlBufResetInput(in-&gt;buffer, ctxt-&gt;input);
&gt;             }
&gt;         }
&gt;      }
&gt;      if (remain != 0) {
&gt;          xmlParseTryOrFinish(ctxt, 0);
&gt;      } else {
&gt;          if ((ctxt-&gt;input != NULL) &amp;&amp; (ctxt-&gt;input-&gt;buf != NULL))
&gt;              avail = xmlBufUse(ctxt-&gt;input-&gt;buf-&gt;buffer);
&gt; </span>

There's an almost identical codepath in HTMLparser.c that probably needs the same fix. There are a few other calls to xmlCharEncInput that aren't obviously followed by a call to xmlBufResetInput, which suggests they may be have the same problem.</pre>
</div><div class="bz_comment" id="c8">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c8">Comment 8</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Mark Rowe</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-02-15 22:13:25 UTC
        </span>
</div>
<pre class="bz_comment_text">This looks to have been fixed by &lt;<a href="http://git.gnome.org/browse/libxml2/commit/?id=de0cc20c29cb3f056062925395e0f68d2250a46f">http://git.gnome.org/browse/libxml2/commit/?id=de0cc20c29cb3f056062925395e0f68d2250a46f</a>&gt;.</pre>
</div><div class="bz_comment" id="c9">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c9">Comment 9</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Dan Winship</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-02-16 16:17:29 UTC
        </span>
</div>
<pre class="bz_comment_text">That patch fixes your test case, but I still see "internal buffer error : No error message provided" when running the tests from <a href="show_bug.cgi?id=690202#c2">comment 2</a>, so it doesn't seem to fix everything.</pre>
</div><div class="bz_comment" id="c10">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c10">Comment 10</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Daniel Veillard</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-03-27 03:30:26 UTC
        </span>
</div>
<pre class="bz_comment_text">My problem is that i don't see how to reproduce them outside of the
whole webkit, looking at the trace, i have tried to make the same input
and feed it to xmllint push parser but i don't get any trouble with it:

thinkpad:~/XML -&gt; iconv -f UTF-8 -t UTF-16 &lt; webkit.xml &gt; webkit_16.xml
thinkpad:~/XML -&gt; xmllint --push webkit_16.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;?xml-stylesheet type="text/xsl" href="resources/xsl-using-document-redirect.xsl"?&gt;
&lt;xml&gt;
FAIL: XML stylesheet did not run.
&lt;/xml&gt;
thinkpad:~/XML -&gt; xmllint --stream webkit_16.xml
thinkpad:~/XML -&gt; ls -l webkit_16.xml
-rw-rw-r--. 1 veillard veillard 342 Mar 27 11:24 webkit_16.xml
thinkpad:~/XML -&gt; ls -l webkit.xml
-rw-rw-r--. 1 veillard veillard 170 Mar 27 11:21 webkit.xml
thinkpad:~/XML -&gt;

 I'm afraid that without some kind of test case based on libxml2
I will have a hard time debugging this. This actually call for kind of
instrumentation of libxml2 allowing to reproduce the set of calls made
by an application but I can't guarantee I will get time to do this considering
my current crazy schedule !

Daniel</pre>
</div><div class="bz_comment" id="c11">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c11">Comment 11</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Gilboa Davara</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2013-05-26 16:29:56 UTC
        </span>
</div>
<pre class="bz_comment_text">Not sure if it's the same bug, but at least in my case, the same error was triggered when faced with large (&gt;64KB) XSL files. Breaking the large XSL into smaller ones solved the problem.</pre>
</div><div class="bz_comment" id="c12">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=690202#c12">Comment 12</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">GNOME Infrastructure Team</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2021-07-05 13:25:57 UTC
        </span>
</div>
<pre class="bz_comment_text">GNOME is going to shut down bugzilla.gnome.org in favor of gitlab.gnome.org.
As part of that, we are mass-closing older open tickets in bugzilla.gnome.org
which have not seen updates for a longer time (resources are unfortunately
quite limited so not every ticket can get handled).

If you can still reproduce the situation described in this ticket in a recent
and supported software version, then please follow
  <a href="https://wiki.gnome.org/GettingInTouch/BugReportingGuidelines">https://wiki.gnome.org/GettingInTouch/BugReportingGuidelines</a>
and create a new ticket at
  <a href="https://gitlab.gnome.org/GNOME/libxml2/-/issues/">https://gitlab.gnome.org/GNOME/libxml2/-/issues/</a>

Thank you for your understanding and your help.</pre>
</div>
<script type="text/javascript">
  function traceparser_toggle_trace(link, trace_id) {
    var trace = document.getElementById('trace_' + trace_id);
    bz_toggleClass(trace, 'bz_default_hidden');
    if (link.innerHTML == '+') { link.innerHTML = '&mdash;'; }
    else { link.innerHTML = '+'; }
  }
</script>
</td>
<td>
</td>
</tr></table>
</div>
<hr/>
</form>
<hr/>

<br/>
</div>
<div id="footer">
<div class="intro"></div>
<ul id="useful-links">
<li id="links-actions"><ul class="links">
<li><a href="./">Home</a></li>
<li><span class="separator">| </span><span style="text-decoration:line-through"><a href="">New</a></span></li>
<li><span class="separator">| </span><a href="page.cgi?id=browse.html&amp;product=libxml2">Browse</a></li>
<li><span class="separator">| </span><a href="query.cgi">Search</a></li>
<li class="form">
<span class="separator">| </span>
<form action="buglist.cgi" method="get" onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
<input id="no_redirect_bottom" name="no_redirect" type="hidden" value="0"/>
<script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
<input class="txt" id="quicksearch_bottom" name="quicksearch" title="Quick Search" type="text" value=""/>
<input class="btn" id="find_bottom" type="submit" value="Search"/></form>
<a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>
<li><span class="separator">| </span><a href="page.cgi?id=reports.html">Reports</a></li>
<li>
<span class="separator">| </span>
<a href="http://www.bugzilla.org/docs/4.4/en/html/bug_page.html" target="_blank">Help</a>
</li>
<li id="mini_login_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=690202&amp;GoAheadAndLogIn=1" id="login_link_bottom" onclick="return show_mini_login_form('_bottom')">Log In</a>
<form action="show_bug.cgi?id=690202" class="mini_login bz_default_hidden" id="mini_login_bottom" method="POST" onsubmit="return check_mini_login_fields( '_bottom' );">
<input class="bz_login" id="Bugzilla_login_bottom" name="Bugzilla_login" onfocus="mini_login_on_focus('_bottom')" title="Login"/>
<input class="bz_password" id="Bugzilla_password_bottom" name="Bugzilla_password" title="Password" type="password"/>
<input class="bz_password bz_default_hidden bz_mini_login_help" id="Bugzilla_password_dummy_bottom" onfocus="mini_login_on_focus('_bottom')" title="Password" type="text" value="password"/>
<input checked="" class="bz_remember" id="Bugzilla_remember_bottom" name="Bugzilla_remember" type="checkbox" value="on"/>
<label for="Bugzilla_remember_bottom">Remember</label>
<input name="Bugzilla_login_token" type="hidden" value=""/>
<input id="log_in_bottom" name="GoAheadAndLogIn" type="submit" value="Log in"/>
<script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
<a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
</form>
</li>
<li id="forgot_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=690202&amp;GoAheadAndLogIn=1#forgot" id="forgot_link_bottom" onclick="return show_forgot_form('_bottom')">Forgot Password</a>
<form action="token.cgi" class="mini_forgot bz_default_hidden" id="forgot_form_bottom" method="post">
<label for="login_bottom">Login:</label>
<input id="login_bottom" name="loginname" size="20" type="text"/>
<input id="forgot_button_bottom" type="submit" value="Reset Password"/>
<input name="a" type="hidden" value="reqpw"/>
<input id="token_bottom" name="token" type="hidden" value="1626095099-FKg7jvT6A9qXP3ULa-vSYWOi72yhCcH0yFEDpZcxhOc"/>
<a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
</form>
</li>
</ul>
</li>
</ul>
<div class="outro"></div>
</div>
</body>
</html>