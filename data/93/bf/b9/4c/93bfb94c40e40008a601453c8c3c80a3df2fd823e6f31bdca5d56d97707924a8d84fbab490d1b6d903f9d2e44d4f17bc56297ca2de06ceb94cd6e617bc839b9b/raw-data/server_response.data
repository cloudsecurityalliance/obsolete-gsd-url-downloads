<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+index" />

    <meta charset="UTF-8" />
    <title>Bug #1654676 “lxc-user-nic does not ensure that target netns is ...” : Bugs : lxc package : Ubuntu</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/1654676" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/1654676/bug.atom" title="Bug 1654676 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="The documentation for lxc-user-nic claims:

      It ensures that the calling
      user is privileged over the network namespace to which the interface
      will be attached.

Actually, the code only verifies that a process of the calling user is running in the network namespace to which the interface will be attached. To verify this:

 - As root, create a new bridge &quot;lxcbr0&quot;.
 - As root, add an entry like &quot;user veth lxcbr0 10&quot; to
   /etc/lxc/lxc-usernet.
 - As the user specified in /etc/lx..." />
      <meta property="og:description" content="The documentation for lxc-user-nic claims:

      It ensures that the calling
      user is privileged over the network namespace to which the interface
      will be attached.

Actually, the code only verifies that a process of the calling user is running in the network namespace to which the interface will be attached. To verify this:

 - As root, create a new bridge &quot;lxcbr0&quot;.
 - As root, add an entry like &quot;user veth lxcbr0 10&quot; to
   /etc/lxc/lxc-usernet.
 - As the user specified in /etc/lx..." />
    

    
    
      <meta property="og:title" content="Bug #1654676 “lxc-user-nic does not ensure that target netns is ...” : Bugs : lxc package : Ubuntu" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/1654676" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["a11y", "appstream", "bionic", "bisect-done", "bitesize", "cherry-pick", "community-security", "desktop-file", "disco", "dist-upgrade", "focal", "ftbfs", "groovy", "hirsute", "hw-specific", "impish", "jammy", "kernel-bug", "manpage", "metabug", "multiarch", "needs-bisect", "needs-design", "needs-packaging", "needs-reassignment", "package-conflict", "packaging", "patch", "patch-accepted-debian", "patch-accepted-upstream", "patch-forwarded-debian", "patch-forwarded-upstream", "patch-needswork", "patch-rejected", "patch-rejected-debian", "patch-rejected-upstream", "performing-bisect", "py2-removal", "qt4-removal", "regression-proposed", "regression-release", "regression-update", "string-fix", "suspend-resume", "systemd-boot", "testcase", "touch", "unmetdeps", "upgrade-software-version", "verification-done-bionic", "verification-done-focal", "verification-done-groovy", "verification-done-hirsute", "verification-done-impish", "verification-done-xenial", "verification-failed-bionic", "verification-failed-groovy", "verification-failed-impish", "verification-failed-xenial", "verification-needed-bionic", "verification-needed-focal", "verification-needed-groovy", "verification-needed-hirsute", "verification-needed-impish", "verification-needed-trusty", "verification-needed-xenial", "wayland", "xenial"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/ubuntu"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/49558155/64_logo.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/ubuntu">Ubuntu</a><br /><a href="https://launchpad.net/ubuntu/+source/lxc">lxc package</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/ubuntu/+source/lxc">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/ubuntu/+source/lxc">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/ubuntu/+source/lxc">Bugs</a></li>
      
      
    
    
      
      
      <li class="specifications disabled-tab"><span>Blueprints</span></li>
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/ubuntu/+source/lxc">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/ubuntu/+source/lxc">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    lxc-user-nic does not ensure that target netns is caller-owned
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #1654676 reported by
      <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account)</a>
      <time title="2017-01-06 22:58:38 UTC" datetime="2017-01-06T22:58:38.267959+00:00">on 2017-01-06</time>
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">260</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr class="highlight" id="tasksummary2185273">
    <td>
      <a class="bugtask-expander" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+editstatus">
        &#8203;
      </a>
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2185273">
        <span class="yui3-activator-data-box">
            <a class="sprite package-source" href="https://bugs.launchpad.net/ubuntu/+source/lxc" title="Latest release: 1:4.0.10-0ubuntu5, uploaded to universe on 2021-09-24 14:31:08.843633+00:00 by Lukas Märdian (slyon), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)">lxc (Ubuntu)</a>
        </span>
        <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
          Edit
        </button>
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        
        
          <a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+editstatus" style="float: left" class="value statusFIXRELEASED">Fix Released</a>
          <a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+editstatus" style="margin-left: 3px">
            <img class="editicon" src="/@@/edit" />
          </a>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2185273">
          <span class="yui3-activator-data-box">
            <a class="sprite person" href="https://launchpad.net/~cbrauner">Christian Brauner</a>
            
          </span>
          
          <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
            Edit
          </button>
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  
    <tr class="bugtask-collapsible-content hidden" id="task2185273">
     <td colspan="7"><form action="/ubuntu/+source/lxc/+bug/1654676/+editstatus" method="post" enctype="multipart/form-data">
  

  <p class="error message">
    You need to log in to change this bug's status.
  </p>
  
  <table class="summary" style="float: right; margin-left: 1em;">
    <tr>
      <th>Affecting:</th>
      <td><a href="/ubuntu/+source/lxc">lxc (Ubuntu)</a></td>
    </tr>
    <tr>
      <th>Filed here by:</th>
      <td><a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account)</a></td>
    </tr>
    <tr>
      <th>When:</th>
      <td>
        <time title="2017-01-06 22:58:38 UTC" datetime="2017-01-06T22:58:38.267959+00:00">2017-01-06</time>
      </td>
    </tr>
    <tr>
      <th>Confirmed:</th>
      <td>
        <time title="2017-03-09 16:01:21 UTC" datetime="2017-03-09T16:01:21.369259+00:00">2017-03-09</time>
      </td>
    </tr>
    <tr>
      <th>Assigned:</th>
      <td>
        <time title="2017-05-12 20:58:52 UTC" datetime="2017-05-12T20:58:52.592899+00:00">2017-05-12</time>
      </td>
    </tr>
    <tr>
      <th>Started work:</th>
      <td>
        <time title="2017-03-09 16:01:21 UTC" datetime="2017-03-09T16:01:21.369259+00:00">2017-03-09</time>
      </td>
    </tr>
    <tr>
      <th>Completed:</th>
      <td>
        <time title="2017-03-09 16:01:21 UTC" datetime="2017-03-09T16:01:21.369259+00:00">2017-03-09</time>
      </td>
    </tr>
  </table>
  <div class="field">
    <table>
      <tr>
        <td>
          <label for="ubuntu_lxc.target">Target</label>
        </td>
      </tr>
      <tr>
        <td>
          <table>
  <tr>
    <td>
      <label>
        <input class="radioType" checked="checked" id="ubuntu_lxc.target.option.package" name="ubuntu_lxc.target" type="radio" value="package" />
        Distribution
      </label>
    </td>
    <td>
      <select id="ubuntu_lxc.target.distribution" name="ubuntu_lxc.target.distribution" size="1" >
<option value="baltix">Baltix</option>
<option value="boss">BOSS</option>
<option value="charms">Juju Charms Collection</option>
<option value="elbuntu">Elbuntu</option>
<option value="guadalinex">Guadalinex</option>
<option value="guadalinexedu">Guadalinex Edu</option>
<option value="kiwilinux">Kiwi Linux</option>
<option value="nubuntu">nUbuntu</option>
<option value="pld-linux">PLD Linux</option>
<option value="tilix">Tilix</option>
<option value="tuxlab">tuXlab</option>
<option selected="selected" value="ubuntu">Ubuntu</option>
<option value="ubuntu-leb">Ubuntu Linaro Evaluation Build</option>
<option value="ubuntu-rtm">Ubuntu RTM</option>
</select>
<input name="ubuntu_lxc.target.distribution-empty-marker" type="hidden" value="1" />
    </td>
  </tr>
  <tr>
    <td align="right">
      <label for="ubuntu_lxc.target.option.package">
        Package
      </label>
    </td>
    <td>
      


    <input type="text" value="lxc" id="ubuntu_lxc.target.package"
                         name="ubuntu_lxc.target.package" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;ubuntu_lxc.target.option.package&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('ubuntu_lxc.target.package');
              var select_menu = Y.DOM.byId('ubuntu_lxc.target.package-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-ubuntu_lxc-target-package" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_remove_button": false, "header": "Select a package", "vocabulary_filters": [], "remove_team_text": "Remove team", "remove_person_text": "Remove person", "selected_value_metadata": null, "show_create_team": false, "picker_type": "default", "vocabulary_name": "DistributionPackage", "extra_no_results_message": null, "selected_value": "lxc", "show_assign_me_button": false, "show_widget_id": "show-widget-ubuntu_lxc-target-package", "step_title": "Search by name", "assign_me_text": "Pick me", "input_element": "ubuntu_lxc.target.package"};
        var show_widget_id = 'show-widget-ubuntu_lxc-target-package';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>

  <tr>
    <td>
      <label>
        <input class="radioType" id="ubuntu_lxc.target.option.product" name="ubuntu_lxc.target" type="radio" value="product" />
       Project
      </label>
    </td>
    <td>
      


    <input type="text" value="" id="ubuntu_lxc.target.product"
                         name="ubuntu_lxc.target.product" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;ubuntu_lxc.target.option.product&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('ubuntu_lxc.target.product');
              var select_menu = Y.DOM.byId('ubuntu_lxc.target.product-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-ubuntu_lxc-target-product" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_remove_button": false, "header": "Select a project", "vocabulary_filters": [], "remove_team_text": "Remove team", "remove_person_text": "Remove person", "selected_value_metadata": null, "show_create_team": false, "picker_type": "default", "vocabulary_name": "Product", "extra_no_results_message": null, "selected_value": null, "show_assign_me_button": false, "show_widget_id": "show-widget-ubuntu_lxc-target-product", "step_title": "Search", "assign_me_text": "Pick me", "input_element": "ubuntu_lxc.target.product"};
        var show_widget_id = 'show-widget-ubuntu_lxc-target-product';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>
</table>

          
        </td>
      </tr>
    </table>
    
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="ubuntu_lxc.status">Status</label>
        </td>
        <td>
          <label style="font-weight: bold" for="ubuntu_lxc.importance">Importance</label>
        </td>
        
      </tr>
      <tr>
        <td><div>
<div class="value">
<select id="ubuntu_lxc.status" name="ubuntu_lxc.status" size="1" >
<option selected="selected" value="Fix Released">Fix Released</option>
</select>
</div>
<input name="ubuntu_lxc.status-empty-marker" type="hidden" value="1" />
</div></td>
        <td title="Changeable only by a project maintainer or bug supervisor">
          <span class="sprite read-only"></span>
          <span class="importanceUNDECIDED">Undecided</span>
        </td>
        
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="ubuntu_lxc.assignee">Assigned to</label>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="white-space: nowrap">

  <table>
    
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" id="ubuntu_lxc.assignee.assign_to_me" name="ubuntu_lxc.assignee.option" value="ubuntu_lxc.assignee.assign_to_me" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="ubuntu_lxc.assignee.assign_to_me">
          Me
        </label>
      </td>
    </tr>
    
      
        <tr>
          <td style="padding: 0 2px 2px 0">
              <input type="radio" checked="checked" id="ubuntu_lxc.assignee.assigned_to" name="ubuntu_lxc.assignee.option" value="ubuntu_lxc.assignee.assigned_to" />
          </td>
          <td style="padding: 0">
            <label style="font-weight: normal" for="ubuntu_lxc.assignee.assigned_to">
              Christian Brauner (cbrauner)
            </label>
          </td>
        </tr>
      
    
    
  </table>


</td>
      </tr>
    </table>
    
  </div>
  <div class="field">
    <div>
      <label style="font-weight: bold" for="ubuntu_lxc.comment_on_change">Comment on this change (optional)</label>
      <textarea cols="62" rows="4" id="ubuntu_lxc.comment_on_change" name="ubuntu_lxc.comment_on_change"></textarea>
    </div>
    <div>
      <label style="font-weight: normal">
        <input type="checkbox" name="subscribe" id="subscribe" value="Subscribe" />
        Email me about changes to this bug report
      </label>
    </div>
  </div>
  
</form>
</td>
    </tr>
  


        
      </tbody>

    </table>



<div class="actions">
  
    <span id="also-affects-product" class="">
    <a class="menu-link-addupstream sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+choose-affected-product">Also affects project</a>
        <a href="/+help-bugs/also-affects-project-help.html" target="help" class="sprite maybe action-icon">(?)</a>
    </span>
    <span id="also-affects-package" class="">
    <a class="menu-link-adddistro sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+distrotask">Also affects distribution/package</a>
    </span>
    <a class="menu-link-nominate sprite milestone" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+nominate">Nominate for series</a>
    
  

</div>




      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>The documentation for lxc-user-nic claims:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It ensures that the calling<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user is privileged over the network namespace to which the interface<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will be attached.</p>
<p>Actually, the code only verifies that a process of the calling user is running in the network namespace to which the interface will be attached. To verify this:</p>
<p>&nbsp;- As root, create a new bridge &quot;lxcbr0&quot;.<br />
&nbsp;- As root, add an entry like &quot;user veth lxcbr0 10&quot; to<br />
&nbsp;&nbsp;&nbsp;/etc/<wbr />lxc/lxc-<wbr />usernet.<br />
&nbsp;- As the user specified in /etc/lxc/<wbr />lxc-usernet, run the following<br />
&nbsp;&nbsp;&nbsp;command:<br />
&nbsp;&nbsp;&nbsp;/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/lxc/<wbr />lxc-user-<wbr />nic a b $$ veth lxcbr0 foobar<br />
&nbsp;- Run &quot;ip link show foobar&quot;. The output shows that a network interface<br />
&nbsp;&nbsp;&nbsp;with the name &quot;foobar&quot; was created in the init namespace (in which the<br />
&nbsp;&nbsp;&nbsp;user is not privileged).</p>
<p>I suspect that it would also be possible to trick lxc-user-nic into operating on namespaces the caller can&#x27;t access by reassigning the PID while lxc-user-nic is running, between the access check and the netlink calls - this is probably quite hard to fix, considering that the netlink interface just uses a PID to identify the target namespace.</p>
<p>I haven&#x27;t found any way to actually exploit this; however, it seems interesting that this can e.g. be used to create network interfaces whose names contain special characters like dollar, semicolon and backtick. I&#x27;m not sure how dangerous that is - I&#x27;m reporting it as a security bug for now, but if you feel that this has no security impact, feel free to derestrict it.</p>
<p>One way to fix this might be to temporarily drop privileges (setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns() call. This way, the renaming could only succeed if the caller is actually privileged in the network namespace.</p>
<p>release: Ubuntu 16.10<br />
version: lxc-common: 2.0.6-0ubuntu1~<wbr />ubuntu16.<wbr />10.1</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          <span>See <a href="comments/0">original description</a></span>
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            
          </span>
          <span id="tag-list">
          </span>
          <a href="+edit" title="Add tags" id="tags-trigger" class="sprite add">Add tags</a>
          
          <a href="/+help-bugs/tag-help.html" target="help" class="sprite maybe action-icon">Tag help</a>
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        <div class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve">
              <a href="/bugs/cve/2017-5985" title="lxc-user-nic in Linux Containers (LXC...">2017-5985</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account) (jannh)</a>
    
    <time title="2017-01-06 23:00:48 UTC" datetime="2017-01-06T23:00:48.900896+00:00">on 2017-01-06</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>description</b>:
      </td>
      <td>
        updated
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~tyhicks" class="sprite person">Tyler Hicks (tyhicks)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-08T15:22:44.660534+00:00" title="2017-01-08 15:22:44 UTC">on 2017-01-08</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks for the report, Jann. I&#x27;ve subscribed the LXC security team to get their opinion.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks for the report, Jann. I've subscribed the LXC security team to get their opinion.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-09T16:31:49.613793+00:00" title="2017-01-09 16:31:49 UTC">on 2017-01-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hi,</p>
<p>thanks for taking a close look at this.  Indeed, this is one of the two pieces of unprivileged container startup which run with raised privilege, which we would much rather have running without.  There may be better ways to structure this, and perhaps we should brainstorm and discuss them during the upcoming lxc hackfest before FOSDEM.</p>
<p>Going over lxc-user-nic as it stands now, the specific concern you raise *appears* to be addressed by the use of &#x27;may_access_<wbr />netns(pid)<wbr />&#x27;, which ensures that the caller is privileged over the network namespace being manipulated.  If you see specific problems there, please let us know, but this should address exactly what is mentioned in this bug subject.</p>
<p>The other thing you mention is bad nic names.  This *shouldn&#x27;t* be an issue since the caller is privileged over his own network namespace (the target), so may confuse his tools however he likes;  however outside administrators may end up trying to look inside the container and get confused, so perhaps some sanity checks on special characters would be worthwhile.  The main counterpoint to that is that the container admin could always just re-add the special characters later, so we&#x27;re not really adding any security by preventing it at container startup.</p>
<p>I&#x27;m going to keep this bug open for now as we have this conversation.  Thanks again.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hi,

thanks for taking a close look at this.  Indeed, this is one of the two pieces of unprivileged container startup which run with raised privilege, which we would much rather have running without.  There may be better ways to structure this, and perhaps we should brainstorm and discuss them during the upcoming lxc hackfest before FOSDEM.

Going over lxc-user-nic as it stands now, the specific concern you raise *appears* to be addressed by the use of 'may_access_netns(pid)', which ensures that the caller is privileged over the network namespace being manipulated.  If you see specific problems there, please let us know, but this should address exactly what is mentioned in this bug subject.

The other thing you mention is bad nic names.  This *shouldn't* be an issue since the caller is privileged over his own network namespace (the target), so may confuse his tools however he likes;  however outside administrators may end up trying to look inside the container and get confused, so perhaps some sanity checks on special characters would be worthwhile.  The main counterpoint to that is that the container admin could always just re-add the special characters later, so we're not really adding any security by preventing it at container startup.

I'm going to keep this bug open for now as we have this conversation.  Thanks again.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account) (jannh)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-09T16:56:36.106854+00:00" title="2017-01-09 16:56:36 UTC">on 2017-01-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>may_access_<wbr />netns(pid) only checks whether the ruid has read access to /proc/$pid/ns/net. However, being able to open that special file does not imply any kind of privilege over the target namespace, it just implies privilege over the process that is inside the namespace. To test this, you can e.g. run the following command as a normal user:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;strace cat /proc/$$/ns/net 2&gt;&amp;1 | grep open.*ns/net</p>
<p>Have you tried running the commands from my bug report?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">may_access_netns(pid) only checks whether the ruid has read access to /proc/$pid/ns/net. However, being able to open that special file does not imply any kind of privilege over the target namespace, it just implies privilege over the process that is inside the namespace. To test this, you can e.g. run the following command as a normal user:

    strace cat /proc/$$/ns/net 2&gt;&amp;1 | grep open.*ns/net

Have you tried running the commands from my bug report?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-12T21:50:45.892235+00:00" title="2017-01-12 21:50:45 UTC">on 2017-01-12</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hey there,</p>
<p>Just wanted to update this issue to let you know that most of the LXC/LXD team is travelling this week and that we should be able to look into this much closer next week.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hey there,

Just wanted to update this issue to let you know that most of the LXC/LXD team is travelling this week and that we should be able to look into this much closer next week.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-13T02:44:48.904650+00:00" title="2017-01-13 02:44:48 UTC">on 2017-01-13</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hi,</p>
<p><span class="foldable-quoted">&gt;  Have you tried running the commands from my bug report?
</span></p>
<p>1 ✗ serge@sl ~ $ /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
Failed opening network namespace path for &#x27;28684&#x27;.Failed to rename the link<br />
1 ✗ serge@sl ~ $ ip link show foobar<br />
Device &quot;foobar&quot; does not exist.</p>
<p>I&#x27;m on Linux sl 4.4.0-59-generic #80-Ubuntu SMP Fri Jan 6 17:47:47 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>Which kernel did you test under?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hi,

&gt;  Have you tried running the commands from my bug report?

1 ✗ serge@sl ~ $ /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
Failed opening network namespace path for '28684'.Failed to rename the link
1 ✗ serge@sl ~ $ ip link show foobar
Device "foobar" does not exist.

I'm on Linux sl 4.4.0-59-generic #80-Ubuntu SMP Fri Jan 6 17:47:47 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux

Which kernel did you test under?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account) (jannh)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-13T10:49:08.404096+00:00" title="2017-01-13 10:49:08 UTC">on 2017-01-13</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  <a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/comments/6/+download">Download full text</a> (4.0 KiB)
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I&#x27;m testing on Ubuntu Server 16.10, with kernel 4.8.0-32-generic. In case it helps, here&#x27;s an execution with bridge setup and various pieces of system information.</p>
<p>Script started on Fri 13 Jan 2017 11:37:55 AM CET<br />
user@ubuntu:~$ sudo bash<br />
[sudo] password for user:<br />
root@ubuntu:~# ip link add name lxcbr0 type bridge<br />
root@ubuntu:~# ip link set lxcbr0 up<br />
root@ubuntu:~# exit<br />
user@ubuntu:~$ /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
foobar:vethQ1C4AQ<br />
user@ubuntu:~$ ip link show foobar<br />
6: foobar@vethQ1C4AQ: &lt;BROADCAST,<wbr />MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000<br />
&nbsp;&nbsp;&nbsp;&nbsp;link/ether 8e:6e:3b:96:66:c6 brd ff:ff:ff:ff:ff:ff<br />
user@ubuntu:~$ uname -a<br />
Linux ubuntu 4.8.0-32-generic #34-Ubuntu SMP Tue Dec 13 14:30:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux<br />
user@ubuntu:~$ cat /etc/lsb-release<br />
DISTRIB_ID=Ubuntu<br />
DISTRIB_<wbr />RELEASE=<wbr />16.10<br />
DISTRIB_<wbr />CODENAME=<wbr />yakkety<br />
DISTRIB_<wbr />DESCRIPTION=<wbr />&quot;Ubuntu 16.10&quot;<br />
user@ubuntu:~$ cat /etc/apt/<wbr />sources.<wbr />list<br />
#</p>
<p># deb cdrom:[<wbr />Ubuntu-<wbr />Server 16.10 _Yakkety Yak_ - Release amd64 (20161012.1)]/ yakkety main restricted</p>
<p>#deb cdrom:[<wbr />Ubuntu-<wbr />Server 16.10 _Yakkety Yak_ - Release amd64 (20161012.1)]/ yakkety main restricted</p>
<p># See <a rel="nofollow" href="http://help.ubuntu.com/community/UpgradeNotes">http://<wbr />help.ubuntu.<wbr />com/community/<wbr />UpgradeNotes</a> for how to upgrade to<br />
# newer versions of the distribution.<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety main restricted<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety main restricted</p>
<p>## Major bug fix updates produced after the final release of the<br />
## distribution.<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates main restricted<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates main restricted</p>
<p>## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu<br />
## team. Also, please note that software in universe WILL NOT receive any<br />
## review or updates from the Ubuntu security team.<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety universe<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety universe<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates universe<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates universe</p>
<p>## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu<br />
## team, and may not be under a free licence. Please satisfy yourself as to<br />
## your rights to use the software. Also, please note that software in<br />
## multiverse WILL NOT receive any review or updates from the Ubuntu<br />
## security team.<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety multiverse<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety multiverse<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates multiverse<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-updates multiverse</p>
<p>## N.B. software from this repository may not have been tested as<br />
## extensively as that contained in the main release, although it includes<br />
## newer versions of some applications which may provide useful features.<br />
## Also, please note that software in backports WILL NOT receive any review<br />
## or updates from the Ubuntu security team.<br />
deb <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu/">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu/</a> yakkety-backports main restricted universe multiverse<br />
# deb-src <a rel="nofollow" href="http://ch.archive.ubuntu.com/ubuntu">http://<wbr />ch.archive.<wbr />ubuntu.<wbr />com/ubuntu</a>...</p></div>
    
    <p>
      <a href="/ubuntu/+source/lxc/+bug/1654676/comments/6">Read more...</a>
    </p>
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I'm testing on Ubuntu Server 16.10, with kernel 4.8.0-32-generic. In case it helps, here's an execution with bridge setup and various pieces of system information.

Script started on Fri 13 Jan 2017 11:37:55 AM CET
user@ubuntu:~$ sudo bash
[sudo] password for user: 
root@ubuntu:~# ip link add name lxcbr0 type bridge
root@ubuntu:~# ip link set lxcbr0 up
root@ubuntu:~# exit
user@ubuntu:~$ /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
foobar:vethQ1C4AQ
user@ubuntu:~$ ip link show foobar
6: foobar@vethQ1C4AQ: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 8e:6e:3b:96:66:c6 brd ff:ff:ff:ff:ff:ff
user@ubuntu:~$ uname -a
Linux ubuntu 4.8.0-32-generic #34-Ubuntu SMP Tue Dec 13 14:30:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
user@ubuntu:~$ cat /etc/lsb-release 
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=16.10
DISTRIB_CODENAME=yakkety
DISTRIB_DESCRIPTION="Ubuntu 16.10"
user@ubuntu:~$ cat /etc/apt/sources.list
# 

# deb cdrom:[Ubuntu-Server 16.10 _Yakkety Yak_ - Release amd64 (20161012.1)]/ yakkety main restricted

#deb cdrom:[Ubuntu-Server 16.10 _Yakkety Yak_ - Release amd64 (20161012.1)]/ yakkety main restricted

# See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to
# newer versions of the distribution.
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety main restricted
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety main restricted

## Major bug fix updates produced after the final release of the
## distribution.
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates main restricted
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates main restricted

## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu
## team. Also, please note that software in universe WILL NOT receive any
## review or updates from the Ubuntu security team.
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety universe
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety universe
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates universe
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates universe

## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu 
## team, and may not be under a free licence. Please satisfy yourself as to 
## your rights to use the software. Also, please note that software in 
## multiverse WILL NOT receive any review or updates from the Ubuntu
## security team.
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety multiverse
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety multiverse
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates multiverse
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety-updates multiverse

## N.B. software from this repository may not have been tested as
## extensively as that contained in the main release, although it includes
## newer versions of some applications which may provide useful features.
## Also, please note that software in backports WILL NOT receive any review
## or updates from the Ubuntu security team.
deb http://ch.archive.ubuntu.com/ubuntu/ yakkety-backports main restricted universe multiverse
# deb-src http://ch.archive.ubuntu.com/ubuntu/ yakkety-backports main restricted universe multiverse

## Uncomment the following two lines to add software from Canonical's
## 'partner' repository.
## This software is not part of Ubuntu, but is offered by Canonical and the
## respective vendors as a service to Ubuntu users.
# deb http://archive.canonical.com/ubuntu yakkety partner
# deb-src http://archive.canonical.com/ubuntu yakkety partner

deb http://security.ubuntu.com/ubuntu yakkety-security main restricted
# deb-src http://security.ubuntu.com/ubuntu yakkety-security main restricted
deb http://security.ubuntu.com/ubuntu yakkety-security universe
# deb-src http://security.ubuntu.com/ubuntu yakkety-security universe
deb http://security.ubuntu.com/ubuntu yakkety-security multiverse
# deb-src http://security.ubuntu.com/ubuntu yakkety-security multiverse
user@ubuntu:~$ exit

Script done on Fri 13 Jan 2017 11:42:07 AM CET</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account) (jannh)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-13T11:08:36.174842+00:00" title="2017-01-13 11:08:36 UTC">on 2017-01-13</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I just tested it in a Ubuntu Desktop 16.04.1 LTS install with kernel 4.4.0-59-generic #80-Ubuntu (same one you used), and it also worked there.</p>
<p>Maybe you could try debugging it like this to figure out what&#x27;s going on? (Running strace as root ensures that setuid binaries still work properly because bprm-&gt;unsafe=<wbr />=LSM_UNSAFE_<wbr />PTRACE_<wbr />CAP instead of bprm-&gt;unsafe=<wbr />=LSM_UNSAFE_<wbr />PTRACE.<wbr />)</p>
<p>user@user-<wbr />VirtualBox:<wbr />~$ sudo strace -f sudo -u user /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 qux 2&gt;&amp;1 | grep /proc/<br />
open(&quot;/<wbr />proc/filesystem<wbr />s&quot;, O_RDONLY)     = 3<br />
open(&quot;/<wbr />proc/sys/<wbr />kernel/<wbr />ngroups_<wbr />max&quot;, O_RDONLY) = 3<br />
open(&quot;/<wbr />proc/2632/<wbr />stat&quot;, O_RDONLY)       = 3<br />
open(&quot;/<wbr />proc/sys/<wbr />kernel/<wbr />ngroups_<wbr />max&quot;, O_RDONLY) = 8<br />
readlink(<wbr />&quot;/proc/<wbr />self/fd/<wbr />0&quot;, &quot;/dev/pts/17&quot;, 31) = 11<br />
readlink(<wbr />&quot;/proc/<wbr />self/exe&quot;<wbr />, &quot;/usr/bin/sudo&quot;, 4096) = 13<br />
[pid  2633] open(&quot;/<wbr />proc/self/<wbr />fd&quot;, O_RDONLY|<wbr />O_NONBLOCK|<wbr />O_DIRECTORY|<wbr />O_CLOEXEC) = 4<br />
[pid  2633] open(&quot;/<wbr />proc/filesystem<wbr />s&quot;, O_RDONLY) = 3<br />
[pid  2633] open(&quot;/<wbr />proc/1/<wbr />cgroup&quot;<wbr />, O_RDONLY) = 3<br />
[pid  2633] open(&quot;/<wbr />proc/self/<wbr />mountinfo&quot;<wbr />, O_RDONLY) = 3<br />
[pid  2633] open(&quot;/<wbr />proc/self/<wbr />cgroup&quot;<wbr />, O_RDONLY) = 4<br />
[pid  2633] access(<wbr />&quot;/proc/<wbr />1739/ns/<wbr />net&quot;, R_OK) = 0<br />
[pid  2633] access(&quot;/proc/net&quot;, R_OK)   = 0<br />
[pid  2633] access(<wbr />&quot;/proc/<wbr />net/unix&quot;<wbr />, R_OK) = 0<br />
[pid  2633] open(&quot;/<wbr />proc/2633/<wbr />ns/net&quot;<wbr />, O_RDONLY|O_CLOEXEC) = 3<br />
[pid  2633] open(&quot;/<wbr />proc/1739/<wbr />ns/net&quot;<wbr />, O_RDONLY|O_CLOEXEC) = 4</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I just tested it in a Ubuntu Desktop 16.04.1 LTS install with kernel 4.4.0-59-generic #80-Ubuntu (same one you used), and it also worked there.

Maybe you could try debugging it like this to figure out what's going on? (Running strace as root ensures that setuid binaries still work properly because bprm-&gt;unsafe==LSM_UNSAFE_PTRACE_CAP instead of bprm-&gt;unsafe==LSM_UNSAFE_PTRACE.)

user@user-VirtualBox:~$ sudo strace -f sudo -u user /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 qux 2&gt;&amp;1 | grep /proc/
open("/proc/filesystems", O_RDONLY)     = 3
open("/proc/sys/kernel/ngroups_max", O_RDONLY) = 3
open("/proc/2632/stat", O_RDONLY)       = 3
open("/proc/sys/kernel/ngroups_max", O_RDONLY) = 8
readlink("/proc/self/fd/0", "/dev/pts/17", 31) = 11
readlink("/proc/self/exe", "/usr/bin/sudo", 4096) = 13
[pid  2633] open("/proc/self/fd", O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC) = 4
[pid  2633] open("/proc/filesystems", O_RDONLY) = 3
[pid  2633] open("/proc/1/cgroup", O_RDONLY) = 3
[pid  2633] open("/proc/self/mountinfo", O_RDONLY) = 3
[pid  2633] open("/proc/self/cgroup", O_RDONLY) = 4
[pid  2633] access("/proc/1739/ns/net", R_OK) = 0
[pid  2633] access("/proc/net", R_OK)   = 0
[pid  2633] access("/proc/net/unix", R_OK) = 0
[pid  2633] open("/proc/2633/ns/net", O_RDONLY|O_CLOEXEC) = 3
[pid  2633] open("/proc/1739/ns/net", O_RDONLY|O_CLOEXEC) = 4
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/8" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-13T14:30:20+00:00" title="2017-01-13 14:30:20 UTC">on 2017-01-13</time><span class="editable-message-last-edit-date">:
              </span>
              <a href="/ubuntu/+source/lxc/+bug/1654676/comments/8">
                <strong>Re: [Bug 1654676] Re: lxc-user-nic does not ensure that target netns is caller-owned</strong>
              </a>
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/8"> #8</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hi Jann,</p>
<p>I managed to reproduce this following the steps you outlined. I will wait for<br />
@Serge to figure out why he was not able to reproduce this.</p>
<p>Christian</p>
<p>On Fri, Jan 13, 2017 at 10:49:08AM -0000, Jann Horn (Google) wrote:<br />
<span class="foldable-quoted">
&gt; I&#x27;m testing on Ubuntu Server 16.10, with kernel 4.8.0-32-generic. In<br />
&gt; case it helps, here&#x27;s an execution with bridge setup and various pieces<br />
&gt; of system information.<br />
&gt;<br />
&gt; Script started on Fri 13 Jan 2017 11:37:55 AM CET<br />
&gt; user@ubuntu:~$ sudo bash<br />
&gt; [sudo] password for user:<br />
&gt; root@ubuntu:~# ip link add name lxcbr0 type bridge<br />
&gt; root@ubuntu:~# ip link set lxcbr0 up<br />
&gt; root@ubuntu:~# exit<br />
&gt; user@ubuntu:~$ /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
&gt; foobar:vethQ1C4AQ<br />
&gt; user@ubuntu:~$ ip link show foobar<br />
&gt; 6: foobar@vethQ1C4AQ: &lt;BROADCAST,<wbr />MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000<br />
&gt;     link/ether 8e:6e:3b:96:66:c6 brd ff:ff:ff:ff:ff:ff<br />
&gt; user@ubuntu:~$ uname -a<br />
&gt; Linux ubuntu 4.8.0-32-generic #34-Ubuntu SMP Tue Dec 13 14:30:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux<br />
&gt; user@ubuntu:~$ cat /etc/lsb-release<br />
&gt; DISTRIB_ID=Ubuntu<br />
&gt; DISTRIB_<wbr />RELEASE=<wbr />16.10<br />
&gt; DISTRIB_<wbr />CODENAME=<wbr />yakkety<br />
&gt; DISTRIB_<wbr />DESCRIPTION=<wbr />&quot;Ubuntu 16.10&quot;<br />
&gt; user@ubuntu:~$ cat /etc/apt/<wbr />sources.<wbr />list
</span></p>
<p>&lt;snip&gt;</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hi Jann,

I managed to reproduce this following the steps you outlined. I will wait for
@Serge to figure out why he was not able to reproduce this.

Christian

On Fri, Jan 13, 2017 at 10:49:08AM -0000, Jann Horn (Google) wrote:
&gt; I'm testing on Ubuntu Server 16.10, with kernel 4.8.0-32-generic. In
&gt; case it helps, here's an execution with bridge setup and various pieces
&gt; of system information.
&gt; 
&gt; Script started on Fri 13 Jan 2017 11:37:55 AM CET
&gt; user@ubuntu:~$ sudo bash
&gt; [sudo] password for user: 
&gt; root@ubuntu:~# ip link add name lxcbr0 type bridge
&gt; root@ubuntu:~# ip link set lxcbr0 up
&gt; root@ubuntu:~# exit
&gt; user@ubuntu:~$ /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
&gt; foobar:vethQ1C4AQ
&gt; user@ubuntu:~$ ip link show foobar
&gt; 6: foobar@vethQ1C4AQ: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
&gt;     link/ether 8e:6e:3b:96:66:c6 brd ff:ff:ff:ff:ff:ff
&gt; user@ubuntu:~$ uname -a
&gt; Linux ubuntu 4.8.0-32-generic #34-Ubuntu SMP Tue Dec 13 14:30:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
&gt; user@ubuntu:~$ cat /etc/lsb-release 
&gt; DISTRIB_ID=Ubuntu
&gt; DISTRIB_RELEASE=16.10
&gt; DISTRIB_CODENAME=yakkety
&gt; DISTRIB_DESCRIPTION="Ubuntu 16.10"
&gt; user@ubuntu:~$ cat /etc/apt/sources.list

&lt;snip&gt;
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/9" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-22T18:19:07.080997+00:00" title="2017-01-22 18:19:07 UTC">on 2017-01-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/9"> #9</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I can&#x27;t explain why it doesn&#x27;t work on my laptop.  In a fresh xenial container, using the same ppa I use on my laptop and same kernel, I can reproduce it.</p>
<p>So while it&#x27;s probably low priority as security issues go, I do think this is a security issue.</p>
<p>Christian, are you interested in floating a proposed fix for this here?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I can't explain why it doesn't work on my laptop.  In a fresh xenial container, using the same ppa I use on my laptop and same kernel, I can reproduce it.

So while it's probably low priority as security issues go, I do think this is a security issue.

Christian, are you interested in floating a proposed fix for this here?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/10" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-28T10:46:23.884423+00:00" title="2017-01-28 10:46:23 UTC">on 2017-01-28</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/10"> #10</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>So, yes, temporarily dropping privilege sounds fine. I&#x27;ll come up with a proposed patch.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">So, yes, temporarily dropping privilege sounds fine. I'll come up with a proposed patch.
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/11" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-28T12:11:57.142434+00:00" title="2017-01-28 12:11:57 UTC">on 2017-01-28</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/11"> #11</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4810035/+files/0001-security-ensure-target-netns-is-caller-owned.patch">0001-security-ensure-target-netns-is-caller-owned.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4810035">Edit</a>
        (4.8 KiB,
        text/plain)
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@Jann, @Serge, please take a look at the proposed patch I attached here. :)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@Jann, @Serge, please take a look at the proposed patch I attached here. :)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/12" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jannh" class="sprite person">Jann Horn (corp account) (jannh)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-28T22:58:42.904634+00:00" title="2017-01-28 22:58:42 UTC">on 2017-01-28</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/12"> #12</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Nit: It would be a little bit more robust to explicitly specify CLONE_NEWNET in the setns() call.</p>
<p>Apart from that, I think it looks fine.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Nit: It would be a little bit more robust to explicitly specify CLONE_NEWNET in the setns() call.

Apart from that, I think it looks fine.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/13" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T10:16:36.377455+00:00" title="2017-01-29 10:16:36 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/13"> #13</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@Jann, I&#x27;m going to do some more code-cleanup for lxc-user-nic and will likely add this as part of it.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@Jann, I'm going to do some more code-cleanup for lxc-user-nic and will likely add this as part of it.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/14" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T18:07:28+00:00" title="2017-01-29 18:07:28 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/14"> #14</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks!  Looking.</p>
<p>On Sun, Jan 29, 2017 at 10:16 AM, Christian Brauner<br />
&lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; @Jann, I&#x27;m going to do some more code-cleanup for lxc-user-nic and will<br />
&gt; likely add this as part of it.<br />
&gt;<br />
&gt; --<br />
&gt; You received this bug notification because you are a member of Ubuntu<br />
&gt; Container Security team, which is subscribed to the bug report.<br />
&gt; <a rel="nofollow" href="https://bugs.launchpad.net/bugs/1654676">https:/<wbr />/bugs.launchpad<wbr />.net/bugs/<wbr />1654676</a><br />
&gt;<br />
&gt; Title:<br />
&gt;   lxc-user-nic does not ensure that target netns is caller-owned<br />
&gt;<br />
&gt; Status in lxc package in Ubuntu:<br />
&gt;   New<br />
&gt;<br />
&gt; Bug description:<br />
&gt;   The documentation for lxc-user-nic claims:<br />
&gt;<br />
&gt;         It ensures that the calling<br />
&gt;         user is privileged over the network namespace to which the interface<br />
&gt;         will be attached.<br />
&gt;<br />
&gt;   Actually, the code only verifies that a process of the calling user is<br />
&gt;   running in the network namespace to which the interface will be<br />
&gt;   attached. To verify this:<br />
&gt;<br />
&gt;    - As root, create a new bridge &quot;lxcbr0&quot;.<br />
&gt;    - As root, add an entry like &quot;user veth lxcbr0 10&quot; to<br />
&gt;      /etc/lxc/<wbr />lxc-usernet.<br />
&gt;    - As the user specified in /etc/lxc/<wbr />lxc-usernet, run the following<br />
&gt;      command:<br />
&gt;      /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
&gt;    - Run &quot;ip link show foobar&quot;. The output shows that a network interface<br />
&gt;      with the name &quot;foobar&quot; was created in the init namespace (in which the<br />
&gt;      user is not privileged).<br />
&gt;<br />
&gt;   I suspect that it would also be possible to trick lxc-user-nic into<br />
&gt;   operating on namespaces the caller can&#x27;t access by reassigning the PID<br />
&gt;   while lxc-user-nic is running, between the access check and the<br />
&gt;   netlink calls - this is probably quite hard to fix, considering that<br />
&gt;   the netlink interface just uses a PID to identify the target<br />
&gt;   namespace.<br />
&gt;<br />
&gt;   I haven&#x27;t found any way to actually exploit this; however, it seems<br />
&gt;   interesting that this can e.g. be used to create network interfaces<br />
&gt;   whose names contain special characters like dollar, semicolon and<br />
&gt;   backtick. I&#x27;m not sure how dangerous that is - I&#x27;m reporting it as a<br />
&gt;   security bug for now, but if you feel that this has no security<br />
&gt;   impact, feel free to derestrict it.<br />
&gt;<br />
&gt;   One way to fix this might be to temporarily drop privileges<br />
&gt;   (setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns()<br />
&gt;   call. This way, the renaming could only succeed if the caller is<br />
&gt;   actually privileged in the network namespace.<br />
&gt;<br />
&gt;   release: Ubuntu 16.10<br />
&gt;   version: lxc-common: 2.0.6-0ubuntu1~<wbr />ubuntu16.<wbr />10.1<br />
&gt;<br />
&gt; To manage notifications about this bug go to:<br />
&gt; <a rel="nofollow" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+subscriptions">https:/<wbr />/bugs.launchpad<wbr />.net/ubuntu/<wbr />+source/<wbr />lxc/+bug/<wbr />1654676/<wbr />+subscriptions</a>
</span></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks!  Looking.

On Sun, Jan 29, 2017 at 10:16 AM, Christian Brauner
&lt;christian.brauner@canonical.com&gt; wrote:
&gt; @Jann, I'm going to do some more code-cleanup for lxc-user-nic and will
&gt; likely add this as part of it.
&gt;
&gt; --
&gt; You received this bug notification because you are a member of Ubuntu
&gt; Container Security team, which is subscribed to the bug report.
&gt; https://bugs.launchpad.net/bugs/1654676
&gt;
&gt; Title:
&gt;   lxc-user-nic does not ensure that target netns is caller-owned
&gt;
&gt; Status in lxc package in Ubuntu:
&gt;   New
&gt;
&gt; Bug description:
&gt;   The documentation for lxc-user-nic claims:
&gt;
&gt;         It ensures that the calling
&gt;         user is privileged over the network namespace to which the interface
&gt;         will be attached.
&gt;
&gt;   Actually, the code only verifies that a process of the calling user is
&gt;   running in the network namespace to which the interface will be
&gt;   attached. To verify this:
&gt;
&gt;    - As root, create a new bridge "lxcbr0".
&gt;    - As root, add an entry like "user veth lxcbr0 10" to
&gt;      /etc/lxc/lxc-usernet.
&gt;    - As the user specified in /etc/lxc/lxc-usernet, run the following
&gt;      command:
&gt;      /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
&gt;    - Run "ip link show foobar". The output shows that a network interface
&gt;      with the name "foobar" was created in the init namespace (in which the
&gt;      user is not privileged).
&gt;
&gt;   I suspect that it would also be possible to trick lxc-user-nic into
&gt;   operating on namespaces the caller can't access by reassigning the PID
&gt;   while lxc-user-nic is running, between the access check and the
&gt;   netlink calls - this is probably quite hard to fix, considering that
&gt;   the netlink interface just uses a PID to identify the target
&gt;   namespace.
&gt;
&gt;   I haven't found any way to actually exploit this; however, it seems
&gt;   interesting that this can e.g. be used to create network interfaces
&gt;   whose names contain special characters like dollar, semicolon and
&gt;   backtick. I'm not sure how dangerous that is - I'm reporting it as a
&gt;   security bug for now, but if you feel that this has no security
&gt;   impact, feel free to derestrict it.
&gt;
&gt;   One way to fix this might be to temporarily drop privileges
&gt;   (setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns()
&gt;   call. This way, the renaming could only succeed if the caller is
&gt;   actually privileged in the network namespace.
&gt;
&gt;   release: Ubuntu 16.10
&gt;   version: lxc-common: 2.0.6-0ubuntu1~ubuntu16.10.1
&gt;
&gt; To manage notifications about this bug go to:
&gt; https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+subscriptions
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/15" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T19:44:34.646257+00:00" title="2017-01-29 19:44:34 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/15"> #15</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks, Christian.  Is there a reason why you don&#x27;t set fret to -1 if the final setns fails?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks, Christian.  Is there a reason why you don't set fret to -1 if the final setns fails?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/16" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T21:46:53+00:00" title="2017-01-29 21:46:53 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/16"> #16</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On Sun, Jan 29, 2017 at 8:44 PM, Serge Hallyn<br />
&lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; Thanks, Christian.  Is there a reason why you don&#x27;t set fret to -1 if<br />
&gt; the final setns fails?
</span></p>
<p>If the setns() back to the original namespace fails but everything<br />
else succeeded I didn&#x27;t take it to be a security issue. lxc-user-nic<br />
is pretty short-lived and we don&#x27;t perform any interesting operations<br />
in the namespace after rename_in_ns() succeeded. We rather exit right<br />
away:</p>
<p>/* Now rename the link. */<br />
if (rename_in_ns(pid, cnic, &amp;vethname) &lt; 0) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;usernic_<wbr />error(&quot;<wbr />%s&quot;, &quot;Failed to rename the link.\n&quot;);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;exit(EXIT_<wbr />FAILURE)<wbr />;<br />
}</p>
<p>/* Write the name of the interface pair to the stdout - like<br />
* eth0:veth9MT2L4.<br />
*/<br />
fprintf(stdout, &quot;%s:%s\n&quot;, vethname, nicname);<br />
exit(EXIT_SUCCESS);</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On Sun, Jan 29, 2017 at 8:44 PM, Serge Hallyn
&lt;1654676@bugs.launchpad.net&gt; wrote:
&gt; Thanks, Christian.  Is there a reason why you don't set fret to -1 if
&gt; the final setns fails?

If the setns() back to the original namespace fails but everything
else succeeded I didn't take it to be a security issue. lxc-user-nic
is pretty short-lived and we don't perform any interesting operations
in the namespace after rename_in_ns() succeeded. We rather exit right
away:

/* Now rename the link. */
if (rename_in_ns(pid, cnic, &amp;vethname) &lt; 0) {
        usernic_error("%s", "Failed to rename the link.\n");
        exit(EXIT_FAILURE);
}

/* Write the name of the interface pair to the stdout - like
* eth0:veth9MT2L4.
*/
fprintf(stdout, "%s:%s\n", vethname, nicname);
exit(EXIT_SUCCESS);
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/17" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T21:59:34+00:00" title="2017-01-29 21:59:34 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/17"> #17</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  <a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/comments/17/+download">Download full text</a> (3.2 KiB)
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I understand, but it&#x27;s unexpected, therefore noteworthy.</p>
<p>Sent from my BlackBerry 10 smartphone.<br />
&nbsp;&nbsp;Original Message<br />
From: Christian Brauner<br />
Sent: Sunday, January 29, 2017 3:55 PM<br />
To: &lt;email address hidden&gt;<br />
Reply To: <a href="/bugs/1654676" class="bug-link">Bug 1654676</a><br />
Subject: Re: [<a href="/bugs/1654676" class="bug-link">Bug 1654676</a>] Re: lxc-user-nic does not ensure that target netns is caller-owned</p>
<p>On Sun, Jan 29, 2017 at 8:44 PM, Serge Hallyn<br />
&lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; Thanks, Christian. Is there a reason why you don&#x27;t set fret to -1 if<br />
&gt; the final setns fails?
</span></p>
<p>If the setns() back to the original namespace fails but everything<br />
else succeeded I didn&#x27;t take it to be a security issue. lxc-user-nic<br />
is pretty short-lived and we don&#x27;t perform any interesting operations<br />
in the namespace after rename_in_ns() succeeded. We rather exit right<br />
away:</p>
<p>/* Now rename the link. */<br />
if (rename_in_ns(pid, cnic, &amp;vethname) &lt; 0) {<br />
usernic_error(&quot;%s&quot;, &quot;Failed to rename the link.\n&quot;);<br />
exit(EXIT_FAILURE);<br />
}</p>
<p>/* Write the name of the interface pair to the stdout - like<br />
* eth0:veth9MT2L4.<br />
*/<br />
fprintf(stdout, &quot;%s:%s\n&quot;, vethname, nicname);<br />
exit(EXIT_SUCCESS);</p>
<p><span class="foldable">--<br />
You received this bug notification because you are a member of Ubuntu<br />
Container Security team, which is subscribed to the bug report.<br />
<a rel="nofollow" href="https://bugs.launchpad.net/bugs/1654676">https:/<wbr />/bugs.launchpad<wbr />.net/bugs/<wbr />1654676</a>
</span></p>
<p>Title:<br />
lxc-user-nic does not ensure that target netns is caller-owned</p>
<p>Status in lxc package in Ubuntu:<br />
New</p>
<p>Bug description:<br />
The documentation for lxc-user-nic claims:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It ensures that the calling<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user is privileged over the network namespace to which the interface<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will be attached.</p>
<p>Actually, the code only verifies that a process of the calling user is<br />
running in the network namespace to which the interface will be<br />
attached. To verify this:</p>
<p>&nbsp;- As root, create a new bridge &quot;lxcbr0&quot;.<br />
&nbsp;- As root, add an entry like &quot;user veth lxcbr0 10&quot; to<br />
/etc/lxc/<wbr />lxc-usernet.<br />
&nbsp;- As the user specified in /etc/lxc/<wbr />lxc-usernet, run the following<br />
command:<br />
&nbsp;&nbsp;/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/lxc/<wbr />lxc-user-<wbr />nic a b $$ veth lxcbr0 foobar<br />
&nbsp;- Run &quot;ip link show foobar&quot;. The output shows that a network interface<br />
with the name &quot;foobar&quot; was created in the init namespace (in which the<br />
user is not privileged).</p>
<p>I suspect that it would also be possible to trick lxc-user-nic into<br />
operating on namespaces the caller can&#x27;t access by reassigning the PID<br />
while lxc-user-nic is running, between the access check and the<br />
netlink calls - this is probably quite hard to fix, considering that<br />
the netlink interface just uses a PID to identify the target<br />
namespace.</p>
<p>I haven&#x27;t found any way to actually exploit this; however, it seems<br />
interesting that this can e.g. be used to create network interfaces<br />
whose names contain special characters like dollar, semicolon and<br />
backtick. I&#x27;m not sure how dangerous that is - I&#x27;m reporting it as a<br />
security bug for now, but if you feel that this has no security<br />
impact, feel free to derestrict it.</p>
<p>One way to fix this might be to temporarily drop privileges<br />
(setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns()<br />
call. This way, the renaming could only succeed if the caller is<br />
actually privileged in the network namespace.</p>
<p>release: Ubuntu 16.10<br />
version: lxc-common: 2.0.6-0ubuntu1~<wbr />ubuntu16.<wbr />10.1<br />
...</p></div>
    
    <p>
      <a href="/ubuntu/+source/lxc/+bug/1654676/comments/17">Read more...</a>
    </p>
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I understand, but it's unexpected, therefore noteworthy. 


Sent from my BlackBerry 10 smartphone.
  Original Message  
From: Christian Brauner
Sent: Sunday, January 29, 2017 3:55 PM
To: serge.hallyn@gmail.com
Reply To: Bug 1654676
Subject: Re: [Bug 1654676] Re: lxc-user-nic does not ensure that target netns is caller-owned

On Sun, Jan 29, 2017 at 8:44 PM, Serge Hallyn
&lt;1654676@bugs.launchpad.net&gt; wrote:
&gt; Thanks, Christian. Is there a reason why you don't set fret to -1 if
&gt; the final setns fails?

If the setns() back to the original namespace fails but everything
else succeeded I didn't take it to be a security issue. lxc-user-nic
is pretty short-lived and we don't perform any interesting operations
in the namespace after rename_in_ns() succeeded. We rather exit right
away:

/* Now rename the link. */
if (rename_in_ns(pid, cnic, &amp;vethname) &lt; 0) {
usernic_error("%s", "Failed to rename the link.\n");
exit(EXIT_FAILURE);
}

/* Write the name of the interface pair to the stdout - like
* eth0:veth9MT2L4.
*/
fprintf(stdout, "%s:%s\n", vethname, nicname);
exit(EXIT_SUCCESS);

-- 
You received this bug notification because you are a member of Ubuntu
Container Security team, which is subscribed to the bug report.
https://bugs.launchpad.net/bugs/1654676

Title:
lxc-user-nic does not ensure that target netns is caller-owned

Status in lxc package in Ubuntu:
New

Bug description:
The documentation for lxc-user-nic claims:

      It ensures that the calling
      user is privileged over the network namespace to which the interface
      will be attached.

Actually, the code only verifies that a process of the calling user is
running in the network namespace to which the interface will be
attached. To verify this:

 - As root, create a new bridge "lxcbr0".
 - As root, add an entry like "user veth lxcbr0 10" to
/etc/lxc/lxc-usernet.
 - As the user specified in /etc/lxc/lxc-usernet, run the following
command:
  /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
 - Run "ip link show foobar". The output shows that a network interface
with the name "foobar" was created in the init namespace (in which the
user is not privileged).

I suspect that it would also be possible to trick lxc-user-nic into
operating on namespaces the caller can't access by reassigning the PID
while lxc-user-nic is running, between the access check and the
netlink calls - this is probably quite hard to fix, considering that
the netlink interface just uses a PID to identify the target
namespace.

I haven't found any way to actually exploit this; however, it seems
interesting that this can e.g. be used to create network interfaces
whose names contain special characters like dollar, semicolon and
backtick. I'm not sure how dangerous that is - I'm reporting it as a
security bug for now, but if you feel that this has no security
impact, feel free to derestrict it.

One way to fix this might be to temporarily drop privileges
(setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns()
call. This way, the renaming could only succeed if the caller is
actually privileged in the network namespace.

release: Ubuntu 16.10
version: lxc-common: 2.0.6-0ubuntu1~ubuntu16.10.1

To manage notifications about this bug go to:
https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+subscriptions
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/18" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-29T22:07:45.231912+00:00" title="2017-01-29 22:07:45 UTC">on 2017-01-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/18"> #18</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On second thought, I&#x27;ve convinced myself on irc that there is a legitimate case where this would fail, which current lxc would not support.  If I create a container in a new userns without a separate netns (sharing the parent netns), then want to create a unpriv container in there, then the setns back to original will (if i&#x27;m thinking right) fail.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On second thought, I've convinced myself on irc that there is a legitimate case where this would fail, which current lxc would not support.  If I create a container in a new userns without a separate netns (sharing the parent netns), then want to create a unpriv container in there, then the setns back to original will (if i'm thinking right) fail.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/19" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-30T12:24:35.840583+00:00" title="2017-01-30 12:24:35 UTC">on 2017-01-30</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/19"> #19</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@Serge, I&#x27;m not entirely clear if by &quot;would not support&quot; you&#x27;re trying to imply<br />
that we should actually fail when setns() back fails.<br />
To me it feels like we want is what is happening in the patch,<br />
meaning we don&#x27;t want to fail.<br />
Given the premises in your argument, what I understand is:<br />
1) You&#x27;re in a new user namespace u1 but share the parent&#x27;s network namespace n0.<br />
2) You&#x27;re cloning a new user namespace u2 and a new network namespace n1 in user namespace u1.<br />
3) You&#x27;re then using setns(n1_fd, CLONE_NEWNET) and rename a veth device.<br />
4) You&#x27;re using setns(n0_fd, CLONE_NEWNET) to attach back to network namespace n0.</p>
<p>1)-3) should succeed.<br />
4) should fail.<br />
But 4) failing is not sufficient reason to ban the user from being successful<br />
in administering veth devices in a network namespace (here n1) where it has sufficient<br />
privileges, right?<br />
So I&#x27;d argue we should let the patch stand as it is, no?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@Serge, I'm not entirely clear if by "would not support" you're trying to imply
that we should actually fail when setns() back fails.
To me it feels like we want is what is happening in the patch,
meaning we don't want to fail.
Given the premises in your argument, what I understand is:
1) You're in a new user namespace u1 but share the parent's network namespace n0.
2) You're cloning a new user namespace u2 and a new network namespace n1 in user namespace u1.
3) You're then using setns(n1_fd, CLONE_NEWNET) and rename a veth device.
4) You're using setns(n0_fd, CLONE_NEWNET) to attach back to network namespace n0.

1)-3) should succeed.
4) should fail.
But 4) failing is not sufficient reason to ban the user from being successful
in administering veth devices in a network namespace (here n1) where it has sufficient
privileges, right?
So I'd argue we should let the patch stand as it is, no?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/20" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-30T15:58:01.480986+00:00" title="2017-01-30 15:58:01 UTC">on 2017-01-30</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/20"> #20</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>As i said,</p>
<p>&quot;I&#x27;ve convinced myself on irc that there is a legitimate case where this would fail, which current lxc would not support&quot;</p>
<p>It&#x27;s a tradeoff in my mind.  Remembering that lxc-user-nic runs as setuid-root, ignoring any unexpected failure is dangerous.  That was the real cause of the sendmail-<wbr />capabilities bug.</p>
<p>Actually, now I&#x27;ve just convinced myself that the above case is *not* legitimate.</p>
<p>If root is not able to setns() back to the original netns, then it also would not have been able to create a network device in that namespace, or attach it to the bridge in that namespace.</p>
<p>So there is, AFAICS, no legitimate case where setns(oldfd, 0) would fail, but execution should continue as normal.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">As i said,

"I've convinced myself on irc that there is a legitimate case where this would fail, which current lxc would not support"

It's a tradeoff in my mind.  Remembering that lxc-user-nic runs as setuid-root, ignoring any unexpected failure is dangerous.  That was the real cause of the sendmail-capabilities bug.

Actually, now I've just convinced myself that the above case is *not* legitimate.

If root is not able to setns() back to the original netns, then it also would not have been able to create a network device in that namespace, or attach it to the bridge in that namespace.

So there is, AFAICS, no legitimate case where setns(oldfd, 0) would fail, but execution should continue as normal.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/21" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-30T16:30:27+00:00" title="2017-01-30 16:30:27 UTC">on 2017-01-30</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/21"> #21</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4810923/+files/0002-security-ensure-target-netns-is-caller-owned.patch">0002-security-ensure-target-netns-is-caller-owned.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4810923">Edit</a>
        (5.4 KiB,
        text/x-patch; charset=US-ASCII; 
	name="0002-security-ensure-target-netns-is-caller-owned.patch")
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On Mon, Jan 30, 2017 at 4:58 PM, Serge Hallyn<br />
&lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; As i said,<br />
&gt;<br />
&gt; &quot;I&#x27;ve convinced myself on irc that there is a legitimate case where this<br />
&gt; would fail, which current lxc would not support&quot;<br />
&gt;<br />
&gt; It&#x27;s a tradeoff in my mind.  Remembering that lxc-user-nic runs as<br />
&gt; setuid-root, ignoring any unexpected failure is dangerous.  That was the<br />
&gt; real cause of the sendmail-<wbr />capabilities bug.<br />
&gt;<br />
&gt; Actually, now I&#x27;ve just convinced myself that the above case is *not*<br />
&gt; legitimate.<br />
&gt;<br />
&gt; If root is not able to setns() back to the original netns, then it also<br />
&gt; would not have been able to create a network device in that namespace,<br />
&gt; or attach it to the bridge in that namespace.
</span></p>
<p>That was my first conception but I was unable to console this with your first<br />
argument. Of course, this also implies that we error out in any case<br />
and the second setns(ofd, 0) still doesn&#x27;t matter. But the point about<br />
setuid is well<br />
taken. I adjusted the patch accordingly and also inserted the CLONE_NEWNET<br />
into the setns() calls like @Jann suggested. :)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On Mon, Jan 30, 2017 at 4:58 PM, Serge Hallyn
&lt;1654676@bugs.launchpad.net&gt; wrote:
&gt; As i said,
&gt;
&gt; "I've convinced myself on irc that there is a legitimate case where this
&gt; would fail, which current lxc would not support"
&gt;
&gt; It's a tradeoff in my mind.  Remembering that lxc-user-nic runs as
&gt; setuid-root, ignoring any unexpected failure is dangerous.  That was the
&gt; real cause of the sendmail-capabilities bug.
&gt;
&gt; Actually, now I've just convinced myself that the above case is *not*
&gt; legitimate.
&gt;
&gt; If root is not able to setns() back to the original netns, then it also
&gt; would not have been able to create a network device in that namespace,
&gt; or attach it to the bridge in that namespace.

That was my first conception but I was unable to console this with your first
argument. Of course, this also implies that we error out in any case
and the second setns(ofd, 0) still doesn't matter. But the point about
setuid is well
taken. I adjusted the patch accordingly and also inserted the CLONE_NEWNET
into the setns() calls like @Jann suggested. :)
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/22" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-01-30T16:55:00.952025+00:00" title="2017-01-30 16:55:00 UTC">on 2017-01-30</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/22"> #22</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks, looks good.</p>
<p>Somewhat related - but not a blocker for this bug - is that if we fail at this point, we perhaps should try to clean up the nics we had created on the host.  Maybe.  On the other hand, if we try to clean up but do so in a buggy way, we could really mess with the host&#x27;s network interfaces.  So not something to rush into.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks, looks good.

Somewhat related - but not a blocker for this bug - is that if we fail at this point, we perhaps should try to clean up the nics we had created on the host.  Maybe.  On the other hand, if we try to clean up but do so in a buggy way, we could really mess with the host's network interfaces.  So not something to rush into.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/23" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-02-01T10:53:19.233399+00:00" title="2017-02-01 10:53:19 UTC">on 2017-02-01</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/23"> #23</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Ok, so what we need from an upstream point of view is:<br />
&nbsp;- Patch for stable-1.0<br />
&nbsp;- Patch for stable-2.0<br />
&nbsp;- Patch for master</p>
<p>That will cover everything we care about and will let us prepare distribution uploads in the private security PPA.</p>
<p>Unless there is a rush on this, we&#x27;d like to delay the release of the security update by a couple of weeks to allow for the newly release LXD 2.0.7 to hit the various distributions and so we can then build the patched LXC on top of that rather than have to stop propagation of LXC 2.0.7 to push a patched 2.0.6.</p>
<p>Security team: Can we get a CVE for this?</p>
<p>Exploitation of this issue will allow an unprivileged LXC user with a valid lxc-usernet quota to create those interfaces in the host network namespace rather than inside a container.</p>
<p>In most cases this would merely pollute the host network namespace but be capped by the number of devices the user can create (lxc-usernet quota). The user won&#x27;t be granted any kind of actual access to the create devices and the host side of the veth pair will still be connected to an authorized bridge. The user also will not be able to choose the name of the create device so can&#x27;t use this to squat valid network device names on the host.</p>
<p>The one potential attack I can think of is if the host is somehow configured to auto-DHCP on any new network interface, in which case, the user would be able to create a normal LXC container, run a DHCP server there, trying to be faster than the one ran by LXC itself, and then create a veth in the host namespace, therefore allowing DHCP configuration of the host, potential attacks on the host DHCP client and routing host traffic through a container.</p>
<p>So as far as security issues go, I&#x27;d say this is a low priority one.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Ok, so what we need from an upstream point of view is:
 - Patch for stable-1.0
 - Patch for stable-2.0
 - Patch for master

That will cover everything we care about and will let us prepare distribution uploads in the private security PPA.


Unless there is a rush on this, we'd like to delay the release of the security update by a couple of weeks to allow for the newly release LXD 2.0.7 to hit the various distributions and so we can then build the patched LXC on top of that rather than have to stop propagation of LXC 2.0.7 to push a patched 2.0.6.

Security team: Can we get a CVE for this?

Exploitation of this issue will allow an unprivileged LXC user with a valid lxc-usernet quota to create those interfaces in the host network namespace rather than inside a container.

In most cases this would merely pollute the host network namespace but be capped by the number of devices the user can create (lxc-usernet quota). The user won't be granted any kind of actual access to the create devices and the host side of the veth pair will still be connected to an authorized bridge. The user also will not be able to choose the name of the create device so can't use this to squat valid network device names on the host.

The one potential attack I can think of is if the host is somehow configured to auto-DHCP on any new network interface, in which case, the user would be able to create a normal LXC container, run a DHCP server there, trying to be faster than the one ran by LXC itself, and then create a veth in the host namespace, therefore allowing DHCP configuration of the host, potential attacks on the host DHCP client and routing host traffic through a container.

So as far as security issues go, I'd say this is a low priority one.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/24" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-02-09T22:42:20.366854+00:00" title="2017-02-09 22:42:20 UTC">on 2017-02-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/24"> #24</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>So getting a CVE assigned to this may take a little while as the assignment process has changed in the past day or so and doesn&#x27;t seem to cover the issuance of CVE numbers for embargoed issues.</p>
<p>Our security team is getting in touch with MITRE to sort this out and we&#x27;ll get going with scheduling disclosure and preparing the various uploads once that&#x27;s sorted out.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">So getting a CVE assigned to this may take a little while as the assignment process has changed in the past day or so and doesn't seem to cover the issuance of CVE numbers for embargoed issues.

Our security team is getting in touch with MITRE to sort this out and we'll get going with scheduling disclosure and preparing the various uploads once that's sorted out.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/25" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-02-11T12:35:41+00:00" title="2017-02-11 12:35:41 UTC">on 2017-02-11</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/25"> #25</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4816965/+files/0001-security-ensure-target-netns-is-caller-owned_1point0.patch">0001-security-ensure-target-netns-is-caller-owned_1point0.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4816965">Edit</a>
        (5.8 KiB,
        text/x-patch; charset=US-ASCII; 
	name="0001-security-ensure-target-netns-is-caller-owned_1point0.patch")
      </li>
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4816966/+files/0001-security-ensure-target-netns-is-caller-owned.patch">0001-security-ensure-target-netns-is-caller-owned.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4816966">Edit</a>
        (5.4 KiB,
        text/x-patch; charset=US-ASCII; 
	name="0001-security-ensure-target-netns-is-caller-owned.patch")
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hi,</p>
<p>please find the necessary patches for all branches attached. Details<br />
about branch-specific patches<br />
can be found inline.</p>
<p>On Wed, Feb 1, 2017 at 11:53 AM, Stéphane Graber &lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; Ok, so what we need from an upstream point of view is:<br />
&gt;  - Patch for stable-1.0
</span></p>
<p>There is a separate patch attached:<br />
0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned_1point0.<wbr />patch</p>
<p>@Serge, @Jann, please give the patches another look if in case<br />
I messed something up.</p>
<p>Thanks again @Jann.<br />
Thanks @Stéphane and the security team for sorting the MITRE stuff out!</p>
<p>Christian</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hi,

please find the necessary patches for all branches attached. Details
about branch-specific patches
can be found inline.

On Wed, Feb 1, 2017 at 11:53 AM, Stéphane Graber &lt;stgraber@stgraber.org&gt; wrote:
&gt; Ok, so what we need from an upstream point of view is:
&gt;  - Patch for stable-1.0

There is a separate patch attached:
0001-security-ensure-target-netns-is-caller-owned_1point0.patch

@Serge, @Jann, please give the patches another look if in case
I messed something up.

Thanks again @Jann.
Thanks @Stéphane and the security team for sorting the MITRE stuff out!

Christian
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/26" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-02-14T06:01:02.961806+00:00" title="2017-02-14 06:01:02 UTC">on 2017-02-14</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/26"> #26</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>We got assigned CVE-2017-5985 for this issue.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">We got assigned CVE-2017-5985 for this issue.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/27" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~serge-hallyn" class="sprite person">Serge Hallyn (serge-hallyn)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-02-22T17:13:40+00:00" title="2017-02-22 17:13:40 UTC">on 2017-02-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/27"> #27</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  <a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/comments/27/+download">Download full text</a> (3.4 KiB)
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Sorry for the delay. These look great, thanks!<br />
‎</p>
<p>&nbsp;&nbsp;Original Message<br />
From: Christian Brauner<br />
Sent: Saturday, February 11, 2017 6:45 AM<br />
To: &lt;email address hidden&gt;<br />
Reply To: <a href="/bugs/1654676" class="bug-link">Bug 1654676</a><br />
Subject: Re: [<a href="/bugs/1654676" class="bug-link">Bug 1654676</a>] Re: lxc-user-nic does not ensure that target netns is caller-owned</p>
<p>Hi,</p>
<p>please find the necessary patches for all branches attached. Details<br />
about branch-specific patches<br />
can be found inline.</p>
<p>On Wed, Feb 1, 2017 at 11:53 AM, Stéphane Graber &lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt; Ok, so what we need from an upstream point of view is:<br />
&gt; - Patch for stable-1.0
</span></p>
<p>There is a separate patch attached:<br />
0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned_1point0.<wbr />patch</p>
<p>@Serge, @Jann, please give the patches another look if in case<br />
I messed something up.</p>
<p>Thanks again @Jann.<br />
Thanks @Stéphane and the security team for sorting the MITRE stuff out!</p>
<p>Christian</p>
<p>** Patch added: &quot;0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned_1point0.<wbr />patch&quot;<br />
<a rel="nofollow" href="https://bugs.launchpad.net/bugs/1654676/+attachment/4816965/+files/0001-security-ensure-target-netns-is-caller-owned_1point0.patch">https:/<wbr />/bugs.launchpad<wbr />.net/bugs/<wbr />1654676/<wbr />+attachment/<wbr />4816965/<wbr />+files/<wbr />0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned_1point0.<wbr />patch</a></p>
<p>** Patch added: &quot;0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned.patch&quot;<br />
<a rel="nofollow" href="https://bugs.launchpad.net/bugs/1654676/+attachment/4816966/+files/0001-security-ensure-target-netns-is-caller-owned.patch">https:/<wbr />/bugs.launchpad<wbr />.net/bugs/<wbr />1654676/<wbr />+attachment/<wbr />4816966/<wbr />+files/<wbr />0001-security-<wbr />ensure-<wbr />target-<wbr />netns-is-<wbr />caller-<wbr />owned.patch</a></p>
<p><span class="foldable">--<br />
You received this bug notification because you are a member of Ubuntu<br />
Container Security team, which is subscribed to the bug report.<br />
<a rel="nofollow" href="https://bugs.launchpad.net/bugs/1654676">https:/<wbr />/bugs.launchpad<wbr />.net/bugs/<wbr />1654676</a>
</span></p>
<p>Title:<br />
lxc-user-nic does not ensure that target netns is caller-owned</p>
<p>Status in lxc package in Ubuntu:<br />
New</p>
<p>Bug description:<br />
The documentation for lxc-user-nic claims:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It ensures that the calling<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user is privileged over the network namespace to which the interface<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will be attached.</p>
<p>Actually, the code only verifies that a process of the calling user is<br />
running in the network namespace to which the interface will be<br />
attached. To verify this:</p>
<p>&nbsp;- As root, create a new bridge &quot;lxcbr0&quot;.<br />
&nbsp;- As root, add an entry like &quot;user veth lxcbr0 10&quot; to<br />
/etc/lxc/<wbr />lxc-usernet.<br />
&nbsp;- As the user specified in /etc/lxc/<wbr />lxc-usernet, run the following<br />
command:<br />
&nbsp;&nbsp;/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/lxc/<wbr />lxc-user-<wbr />nic a b $$ veth lxcbr0 foobar<br />
&nbsp;- Run &quot;ip link show foobar&quot;. The output shows that a network interface<br />
with the name &quot;foobar&quot; was created in the init namespace (in which the<br />
user is not privileged).</p>
<p>I suspect that it would also be possible to trick lxc-user-nic into<br />
operating on namespaces the caller can&#x27;t access by reassigning the PID<br />
while lxc-user-nic is running, between the access check and the<br />
netlink calls - this is probably quite hard to fix, considering that<br />
the netlink interface just uses a PID to identify the target<br />
namespace.</p>
<p>I haven&#x27;t found any way to actually exploit this; however, it seems<br />
interesting that this can e.g. be used to create network interfaces<br />
whose names contain special characters like dollar, semicolon and<br />
backtick. I&#x27;m not sure how dangerous that is - I&#x27;m reporting it as a<br />
security bug for now, but if you feel that this has no security<br />
impact, feel free to derestrict it.</p>
<p>One way to fix this might be to temporarily drop privileges<br />
(setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns(...</p></div>
    
    <p>
      <a href="/ubuntu/+source/lxc/+bug/1654676/comments/27">Read more...</a>
    </p>
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Sorry for the delay. These look great, thanks!
‎

  Original Message  
From: Christian Brauner
Sent: Saturday, February 11, 2017 6:45 AM
To: serge.hallyn@gmail.com
Reply To: Bug 1654676
Subject: Re: [Bug 1654676] Re: lxc-user-nic does not ensure that target netns is caller-owned

Hi,

please find the necessary patches for all branches attached. Details
about branch-specific patches
can be found inline.

On Wed, Feb 1, 2017 at 11:53 AM, Stéphane Graber &lt;stgraber@stgraber.org&gt; wrote:
&gt; Ok, so what we need from an upstream point of view is:
&gt; - Patch for stable-1.0

There is a separate patch attached:
0001-security-ensure-target-netns-is-caller-owned_1point0.patch

@Serge, @Jann, please give the patches another look if in case
I messed something up.

Thanks again @Jann.
Thanks @Stéphane and the security team for sorting the MITRE stuff out!

Christian


** Patch added: "0001-security-ensure-target-netns-is-caller-owned_1point0.patch"
https://bugs.launchpad.net/bugs/1654676/+attachment/4816965/+files/0001-security-ensure-target-netns-is-caller-owned_1point0.patch

** Patch added: "0001-security-ensure-target-netns-is-caller-owned.patch"
https://bugs.launchpad.net/bugs/1654676/+attachment/4816966/+files/0001-security-ensure-target-netns-is-caller-owned.patch

-- 
You received this bug notification because you are a member of Ubuntu
Container Security team, which is subscribed to the bug report.
https://bugs.launchpad.net/bugs/1654676

Title:
lxc-user-nic does not ensure that target netns is caller-owned

Status in lxc package in Ubuntu:
New

Bug description:
The documentation for lxc-user-nic claims:

      It ensures that the calling
      user is privileged over the network namespace to which the interface
      will be attached.

Actually, the code only verifies that a process of the calling user is
running in the network namespace to which the interface will be
attached. To verify this:

 - As root, create a new bridge "lxcbr0".
 - As root, add an entry like "user veth lxcbr0 10" to
/etc/lxc/lxc-usernet.
 - As the user specified in /etc/lxc/lxc-usernet, run the following
command:
  /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
 - Run "ip link show foobar". The output shows that a network interface
with the name "foobar" was created in the init namespace (in which the
user is not privileged).

I suspect that it would also be possible to trick lxc-user-nic into
operating on namespaces the caller can't access by reassigning the PID
while lxc-user-nic is running, between the access check and the
netlink calls - this is probably quite hard to fix, considering that
the netlink interface just uses a PID to identify the target
namespace.

I haven't found any way to actually exploit this; however, it seems
interesting that this can e.g. be used to create network interfaces
whose names contain special characters like dollar, semicolon and
backtick. I'm not sure how dangerous that is - I'm reporting it as a
security bug for now, but if you feel that this has no security
impact, feel free to derestrict it.

One way to fix this might be to temporarily drop privileges
(setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns()
call. This way, the renaming could only succeed if the caller is
actually privileged in the network namespace.

release: Ubuntu 16.10
version: lxc-common: 2.0.6-0ubuntu1~ubuntu16.10.1

To manage notifications about this bug go to:
https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+subscriptions
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/28" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-04T20:01:38.915615+00:00" title="2017-03-04 20:01:38 UTC">on 2017-03-04</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/28"> #28</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Sorry for not following up on this before, we&#x27;ve been extremely busy fixing and pushing out a lot of LXD releases of the past couple of weeks.</p>
<p>So it looks like we all agree on the fix for this and I&#x27;ll be uploading fixed Ubuntu packages to our security PPA early next week.</p>
<p>So now we need to figure out a release date for this. I&#x27;m going to be away on vacation between the 11th and the 17th, so would like to avoid releasing during that time.</p>
<p>It looks like our best bet would be either this Thursday, 9th of March or Tuesday the 21st of March. I&#x27;m fine with either date though I&#x27;m a bit worried that the 9th may be too short notice for other distributions.</p>
<p>Security team: What&#x27;s your opinion on this? And once we agree on one of the two dates, can you take care of notifying the other distros?</p>
<p>Thanks</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Sorry for not following up on this before, we've been extremely busy fixing and pushing out a lot of LXD releases of the past couple of weeks.

So it looks like we all agree on the fix for this and I'll be uploading fixed Ubuntu packages to our security PPA early next week.


So now we need to figure out a release date for this. I'm going to be away on vacation between the 11th and the 17th, so would like to avoid releasing during that time.

It looks like our best bet would be either this Thursday, 9th of March or Tuesday the 21st of March. I'm fine with either date though I'm a bit worried that the 9th may be too short notice for other distributions.

Security team: What's your opinion on this? And once we agree on one of the two dates, can you take care of notifying the other distros?

Thanks</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/29" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~tyhicks" class="sprite person">Tyler Hicks (tyhicks)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-06T20:51:54+00:00" title="2017-03-06 20:51:54 UTC">on 2017-03-06</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/29"> #29</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On 03/04/2017 02:01 PM, Stéphane Graber wrote:<br />
<span class="foldable-quoted">
&gt; Sorry for not following up on this before, we&#x27;ve been extremely busy<br />
&gt; fixing and pushing out a lot of LXD releases of the past couple of<br />
&gt; weeks.<br />
&gt;<br />
&gt; So it looks like we all agree on the fix for this and I&#x27;ll be uploading<br />
&gt; fixed Ubuntu packages to our security PPA early next week.<br />
&gt;<br />
&gt;<br />
&gt; So now we need to figure out a release date for this. I&#x27;m going to be away on vacation between the 11th and the 17th, so would like to avoid releasing during that time.<br />
&gt;<br />
&gt; It looks like our best bet would be either this Thursday, 9th of March<br />
&gt; or Tuesday the 21st of March. I&#x27;m fine with either date though I&#x27;m a bit<br />
&gt; worried that the 9th may be too short notice for other distributions.<br />
&gt;<br />
&gt; Security team: What&#x27;s your opinion on this? And once we agree on one of<br />
&gt; the two dates, can you take care of notifying the other distros?
</span></p>
<p>I&#x27;ll suggest the 9th on the distros list. If it isn&#x27;t enough time,<br />
another distro can ask for a later date.</p>
<p>Tyler</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On 03/04/2017 02:01 PM, Stéphane Graber wrote:
&gt; Sorry for not following up on this before, we've been extremely busy
&gt; fixing and pushing out a lot of LXD releases of the past couple of
&gt; weeks.
&gt; 
&gt; So it looks like we all agree on the fix for this and I'll be uploading
&gt; fixed Ubuntu packages to our security PPA early next week.
&gt; 
&gt; 
&gt; So now we need to figure out a release date for this. I'm going to be away on vacation between the 11th and the 17th, so would like to avoid releasing during that time.
&gt; 
&gt; It looks like our best bet would be either this Thursday, 9th of March
&gt; or Tuesday the 21st of March. I'm fine with either date though I'm a bit
&gt; worried that the 9th may be too short notice for other distributions.
&gt; 
&gt; Security team: What's your opinion on this? And once we agree on one of
&gt; the two dates, can you take care of notifying the other distros?

I'll suggest the 9th on the distros list. If it isn't enough time,
another distro can ask for a later date.

Tyler

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/30" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-07T20:10:22.997925+00:00" title="2017-03-07 20:10:22 UTC">on 2017-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/30"> #30</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Packages for zesty, yakkety, xenial, vivid and trusty uploaded to the LXC security PPA:<br />
<a rel="nofollow" href="https://launchpad.net/~ubuntu-lxc-security/+archive/ubuntu/devirt-security/+packages">https:/<wbr />/launchpad.<wbr />net/~ubuntu-<wbr />lxc-security/<wbr />+archive/<wbr />ubuntu/<wbr />devirt-<wbr />security/<wbr />+packages</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Packages for zesty, yakkety, xenial, vivid and trusty uploaded to the LXC security PPA:
https://launchpad.net/~ubuntu-lxc-security/+archive/ubuntu/devirt-security/+packages</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/31" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-08T17:22:22.196152+00:00" title="2017-03-08 17:22:22 UTC">on 2017-03-08</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/31"> #31</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Reproducer for the issue and fix confirmation:<br />
```<br />
root@xen:~# vim /etc/lxc/<wbr />lxc-usernet<br />
root@xen:~# cat /etc/lxc/<wbr />lxc-usernet<br />
# USERNAME TYPE BRIDGE COUNT<br />
ubuntu veth lxcbr0 10<br />
root@xen:~# su ubuntu<br />
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.<br />
See &quot;man sudo_root&quot; for details.</p>
<p>ubuntu@xen:/root$ /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
foobar:vethHLBXWW</p>
<p>ubuntu@xen:/root$ ifconfig foobar<br />
foobar    Link encap:Ethernet  HWaddr 36:00:39:bb:a0:84<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BROADCAST MULTICAST  MTU:1500  Metric:1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;collisions:<wbr />0 txqueuelen:1000<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</p>
<p>ubuntu@xen:/root$ sudo ip link del foobar</p>
<p>root@xen:~# dpkg -i *.deb<br />
(Reading database ... 25966 files and directories currently installed.)<br />
Preparing to unpack liblxc1_<wbr />2.0.7-0ubuntu1-<wbr />16.04.2_<wbr />amd64.deb ...<br />
Unpacking liblxc1 (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) over (2.0.7-<wbr />0ubuntu1~<wbr />16.04.1) ...<br />
Preparing to unpack lxc-common_<wbr />2.0.7-0ubuntu1-<wbr />16.04.2_<wbr />amd64.deb ...<br />
Unpacking lxc-common (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) over (2.0.7-<wbr />0ubuntu1~<wbr />16.04.1) ...<br />
Preparing to unpack lxc-templates_<wbr />2.0.7-0ubuntu1-<wbr />16.04.2_<wbr />amd64.deb ...<br />
Unpacking lxc-templates (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) over (2.0.7-<wbr />0ubuntu1~<wbr />16.04.1) ...<br />
Preparing to unpack lxc1_2.<wbr />0.7-0ubuntu1-<wbr />16.04.2_<wbr />amd64.deb ...<br />
Unpacking lxc1 (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) over (2.0.7-<wbr />0ubuntu1~<wbr />16.04.1) ...<br />
Preparing to unpack python3-<wbr />lxc_2.0.<wbr />7-0ubuntu1-<wbr />16.04.2_<wbr />amd64.deb ...<br />
Unpacking python3-lxc (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) over (2.0.7-<wbr />0ubuntu1~<wbr />16.04.1) ...<br />
Setting up liblxc1 (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) ...<br />
Setting up lxc-common (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) ...<br />
Setting up python3-lxc (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) ...<br />
Setting up lxc1 (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) ...<br />
Setting up lxc dnsmasq configuration.<br />
Setting up lxc-templates (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) ...<br />
Processing triggers for libc-bin (2.23-0ubuntu5) ...<br />
Processing triggers for man-db (2.7.5-1) ...<br />
Processing triggers for ureadahead (0.100.0-19) ...</p>
<p>ubuntu@xen:/root$ /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic a b $$ veth lxcbr0 foobar<br />
lxc_user_nic.c: 743: rename_in_ns: Error -1 renaming netdev vethL7TJBTp to foobar in container.<br />
Failed to rename the link</p>
<p>ubuntu@xen:/root$ ifconfig foobar<br />
foobar: error fetching interface information: Device not found<br />
```</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Reproducer for the issue and fix confirmation:
```
root@xen:~# vim /etc/lxc/lxc-usernet 
root@xen:~# cat /etc/lxc/lxc-usernet
# USERNAME TYPE BRIDGE COUNT
ubuntu veth lxcbr0 10
root@xen:~# su ubuntu
To run a command as administrator (user "root"), use "sudo &lt;command&gt;".
See "man sudo_root" for details.

ubuntu@xen:/root$ /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
foobar:vethHLBXWW

ubuntu@xen:/root$ ifconfig foobar
foobar    Link encap:Ethernet  HWaddr 36:00:39:bb:a0:84  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

ubuntu@xen:/root$ sudo ip link del foobar

root@xen:~# dpkg -i *.deb
(Reading database ... 25966 files and directories currently installed.)
Preparing to unpack liblxc1_2.0.7-0ubuntu1-16.04.2_amd64.deb ...
Unpacking liblxc1 (2.0.7-0ubuntu1~16.04.2) over (2.0.7-0ubuntu1~16.04.1) ...
Preparing to unpack lxc-common_2.0.7-0ubuntu1-16.04.2_amd64.deb ...
Unpacking lxc-common (2.0.7-0ubuntu1~16.04.2) over (2.0.7-0ubuntu1~16.04.1) ...
Preparing to unpack lxc-templates_2.0.7-0ubuntu1-16.04.2_amd64.deb ...
Unpacking lxc-templates (2.0.7-0ubuntu1~16.04.2) over (2.0.7-0ubuntu1~16.04.1) ...
Preparing to unpack lxc1_2.0.7-0ubuntu1-16.04.2_amd64.deb ...
Unpacking lxc1 (2.0.7-0ubuntu1~16.04.2) over (2.0.7-0ubuntu1~16.04.1) ...
Preparing to unpack python3-lxc_2.0.7-0ubuntu1-16.04.2_amd64.deb ...
Unpacking python3-lxc (2.0.7-0ubuntu1~16.04.2) over (2.0.7-0ubuntu1~16.04.1) ...
Setting up liblxc1 (2.0.7-0ubuntu1~16.04.2) ...
Setting up lxc-common (2.0.7-0ubuntu1~16.04.2) ...
Setting up python3-lxc (2.0.7-0ubuntu1~16.04.2) ...
Setting up lxc1 (2.0.7-0ubuntu1~16.04.2) ...
Setting up lxc dnsmasq configuration.
Setting up lxc-templates (2.0.7-0ubuntu1~16.04.2) ...
Processing triggers for libc-bin (2.23-0ubuntu5) ...
Processing triggers for man-db (2.7.5-1) ...
Processing triggers for ureadahead (0.100.0-19) ...

ubuntu@xen:/root$ /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar
lxc_user_nic.c: 743: rename_in_ns: Error -1 renaming netdev vethL7TJBTp to foobar in container.
Failed to rename the link

ubuntu@xen:/root$ ifconfig foobar
foobar: error fetching interface information: Device not found
```</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/32" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-08T17:25:31.212561+00:00" title="2017-03-08 17:25:31 UTC">on 2017-03-08</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/32"> #32</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>One bug we should resolve after this is released is that &quot;lxc-user-nic&quot; doesn&#x27;t clean after itself on failure. It really ought to destroy any interface it created if it fails.</p>
<p>This means that even with this security fix, a trusted user will be able to create host veth device pairs but those devices will not be brought UP and the user will not be able to choose their name. The number of devices created will also be tracked and the quota enforced, so this can&#x27;t be used for DoS.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">One bug we should resolve after this is released is that "lxc-user-nic" doesn't clean after itself on failure. It really ought to destroy any interface it created if it fails.

This means that even with this security fix, a trusted user will be able to create host veth device pairs but those devices will not be brought UP and the user will not be able to choose their name. The number of devices created will also be tracked and the quota enforced, so this can't be used for DoS.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/33" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~stgraber" class="sprite person">Stéphane Graber (stgraber)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-08T17:36:58.747739+00:00" title="2017-03-08 17:36:58 UTC">on 2017-03-08</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/33"> #33</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Note that for LXC 1.x, you should use &quot;/usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />lxc/lxc-<wbr />user-nic $$ veth lxcbr0 foobar&quot; instead as LXC 1.0.x and LXC 1.1.x doesn&#x27;t take lxcpath and name as arguments.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Note that for LXC 1.x, you should use "/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic $$ veth lxcbr0 foobar" instead as LXC 1.0.x and LXC 1.1.x doesn't take lxcpath and name as arguments.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/34" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~tyhicks" class="sprite person">Tyler Hicks (tyhicks)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-08T23:55:17.900304+00:00" title="2017-03-08 23:55:17 UTC">on 2017-03-08</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/34"> #34</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I&#x27;ve finished my testing of the trusty, xenial, and yakkety packages on amd64 and i386. I&#x27;ll be publishing the updates for those releases on 2017-03-09 16:00:00 UTC. Thanks again for preparing the packages!</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I've finished my testing of the trusty, xenial, and yakkety packages on amd64 and i386. I'll be publishing the updates for those releases on 2017-03-09 16:00:00 UTC. Thanks again for preparing the packages!</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/36" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~janitor" class="sprite person-inactive">Launchpad Janitor (janitor)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-09T16:01:15.592755+00:00" title="2017-03-09 16:01:15 UTC">on 2017-03-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/36"> #36</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This bug was fixed in the package lxc - 2.0.7-0ubuntu1~<wbr />16.10.2</p>
<p>---------------<br />
lxc (2.0.7-<wbr />0ubuntu1~<wbr />16.10.2) yakkety-security; urgency=medium</p>
<p>&nbsp;&nbsp;* SECURITY UPDATE: lxc-user-nic doesn&#x27;t check netns ownership (LP: <a href="/bugs/1654676" class="bug-link">#1654676</a>)<br />
&nbsp;&nbsp;&nbsp;&nbsp;- Ensure target netns is caller-owned<br />
&nbsp;&nbsp;&nbsp;&nbsp;- CVE-2017-5985</p>
<p>&nbsp;-- Stéphane Graber &lt;email address hidden&gt;  Tue, 07 Mar 2017 14:36:12 -0500</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">This bug was fixed in the package lxc - 2.0.7-0ubuntu1~16.10.2

---------------
lxc (2.0.7-0ubuntu1~16.10.2) yakkety-security; urgency=medium

  * SECURITY UPDATE: lxc-user-nic doesn't check netns ownership (LP: #1654676)
    - Ensure target netns is caller-owned
    - CVE-2017-5985

 -- Stéphane Graber &lt;stgraber@ubuntu.com&gt;  Tue, 07 Mar 2017 14:36:12 -0500</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in lxc (Ubuntu): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/35" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~janitor" class="sprite person-inactive">Launchpad Janitor (janitor)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-09T16:01:17.057249+00:00" title="2017-03-09 16:01:17 UTC">on 2017-03-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/35"> #35</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This bug was fixed in the package lxc - 1.0.9-0ubuntu3</p>
<p>---------------<br />
lxc (1.0.9-0ubuntu3) trusty-security; urgency=medium</p>
<p>&nbsp;&nbsp;* SECURITY UPDATE: lxc-user-nic doesn&#x27;t check netns ownership (LP: <a href="/bugs/1654676" class="bug-link">#1654676</a>)<br />
&nbsp;&nbsp;&nbsp;&nbsp;- Ensure target netns is caller-owned<br />
&nbsp;&nbsp;&nbsp;&nbsp;- CVE-2017-5985</p>
<p>&nbsp;-- Stéphane Graber &lt;email address hidden&gt;  Tue, 07 Mar 2017 14:39:58 -0500</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">This bug was fixed in the package lxc - 1.0.9-0ubuntu3

---------------
lxc (1.0.9-0ubuntu3) trusty-security; urgency=medium

  * SECURITY UPDATE: lxc-user-nic doesn't check netns ownership (LP: #1654676)
    - Ensure target netns is caller-owned
    - CVE-2017-5985

 -- Stéphane Graber &lt;stgraber@ubuntu.com&gt;  Tue, 07 Mar 2017 14:39:58 -0500</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in lxc (Ubuntu): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/lxc/+bug/1654676/comments/37" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~janitor" class="sprite person-inactive">Launchpad Janitor (janitor)</a>
            wrote
            <time itemprop="commentTime" datetime="2017-03-09T16:01:19.350324+00:00" title="2017-03-09 16:01:19 UTC">on 2017-03-09</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/lxc/+bug/1654676/comments/37"> #37</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This bug was fixed in the package lxc - 2.0.7-0ubuntu1~<wbr />16.04.2</p>
<p>---------------<br />
lxc (2.0.7-<wbr />0ubuntu1~<wbr />16.04.2) xenial-security; urgency=medium</p>
<p>&nbsp;&nbsp;* SECURITY UPDATE: lxc-user-nic doesn&#x27;t check netns ownership (LP: <a href="/bugs/1654676" class="bug-link">#1654676</a>)<br />
&nbsp;&nbsp;&nbsp;&nbsp;- Ensure target netns is caller-owned<br />
&nbsp;&nbsp;&nbsp;&nbsp;- CVE-2017-5985</p>
<p>&nbsp;-- Stéphane Graber &lt;email address hidden&gt;  Tue, 07 Mar 2017 14:37:03 -0500</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">This bug was fixed in the package lxc - 2.0.7-0ubuntu1~16.04.2

---------------
lxc (2.0.7-0ubuntu1~16.04.2) xenial-security; urgency=medium

  * SECURITY UPDATE: lxc-user-nic doesn't check netns ownership (LP: #1654676)
    - Ensure target netns is caller-owned
    - CVE-2017-5985

 -- Stéphane Graber &lt;stgraber@ubuntu.com&gt;  Tue, 07 Mar 2017 14:37:03 -0500</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in lxc (Ubuntu): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~tyhicks" class="sprite person">Tyler Hicks (tyhicks)</a>
    
    <time title="2017-03-09 16:04:53 UTC" datetime="2017-03-09T16:04:53.040141+00:00">on 2017-03-09</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Private Security &#8594; Public Security
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~cbrauner" class="sprite person">Christian Brauner (cbrauner)</a>
    
    <time title="2017-05-12 20:58:52 UTC" datetime="2017-05-12T20:58:52.453421+00:00">on 2017-05-12</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in lxc (Ubuntu): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>assignee</b>:
      </td>
      <td>
        nobody &#8594; Christian Brauner (cbrauner)
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/ubuntu/+source/lxc/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public Security</strong>
         information
     </span>&nbsp;<a class="sprite edit action-icon" id="privacy-link" href="/ubuntu/+source/lxc/+bug/1654676/+secrecy">Edit</a>

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this security related information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    <li class="sprite bug-dupe">
    <span id="mark-duplicate-text">
    <a class="menu-link-mark-dupe" href="/ubuntu/+source/lxc/+bug/1654676/+duplicate">Mark as duplicate</a>
    </span>
    </li>
    
    <li><a class="menu-link-createquestion sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+create-question">Convert to a question</a></li>
    
    <li><a class="menu-link-addbranch sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+addbranch">Link a related branch</a></li>
    <li><a class="menu-link-linktocve sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+linkcve">Link to <abbr title="Common Vulnerabilities and Exposures Index">CVE</abbr></a></li>
    <li><a class="menu-link-unlinkcve sprite modify remove" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+unlinkcve">Remove CVE link</a></li>
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/ubuntu/+source/lxc/+bug/1654676/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  <div class="portlet" id="portlet-patches">
    <h2>Patches</h2>
    <ul>
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4810035/+files/0001-security-ensure-target-netns-is-caller-owned.patch">0001-security-ensure-target-netns-is-caller-owned.patch</a>
        <small>
          (<a href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4810035">edit</a>)
        </small>
      </li>
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4810923/+files/0002-security-ensure-target-netns-is-caller-owned.patch">0002-security-ensure-target-netns-is-caller-owned.patch</a>
        <small>
          (<a href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4810923">edit</a>)
        </small>
      </li>
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4816965/+files/0001-security-ensure-target-netns-is-caller-owned_1point0.patch">0001-security-ensure-target-netns-is-caller-owned_1point0.patch</a>
        <small>
          (<a href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4816965">edit</a>)
        </small>
      </li>
      <li class="download-attachment">
        <a class="sprite haspatch-icon" href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+attachment/4816966/+files/0001-security-ensure-target-netns-is-caller-owned.patch">0001-security-ensure-target-netns-is-caller-owned.patch</a>
        <small>
          (<a href="/ubuntu/+source/lxc/+bug/1654676/+attachment/4816966">edit</a>)
        </small>
      </li>
    </ul>
    <ul>
      <li>
        <a class="sprite add" href="/ubuntu/+source/lxc/+bug/1654676/+addcomment?field.patch=on">Add patch</a>
      </li>
    </ul>
  </div>
  


      

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"bug_is_private": false, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1654676", "web_link": "https://bugs.launchpad.net/bugs/1654676", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 1654676, "private": false, "information_type": "Public Security", "name": null, "title": "lxc-user-nic does not ensure that target netns is caller-owned", "description": "The documentation for lxc-user-nic claims:\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0It ensures that the calling\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0user is privileged over the network namespace to which the interface\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0will be attached.\n\nActually, the code only verifies that a process of the calling user is running in the network namespace to which the interface will be attached. To verify this:\n\n\u00a0- As root, create a new bridge \"lxcbr0\".\n\u00a0- As root, add an entry like \"user veth lxcbr0 10\" to\n   /etc/lxc/lxc-usernet.\n\u00a0- As the user specified in /etc/lxc/lxc-usernet, run the following\n   command:\n \u00a0\u00a0/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic a b $$ veth lxcbr0 foobar\n\u00a0- Run \"ip link show foobar\". The output shows that a network interface\n   with the name \"foobar\" was created in the init namespace (in which the\n   user is not privileged).\n\nI suspect that it would also be possible to trick lxc-user-nic into operating on namespaces the caller can't access by reassigning the PID while lxc-user-nic is running, between the access check and the netlink calls - this is probably quite hard to fix, considering that the netlink interface just uses a PID to identify the target namespace.\n\nI haven't found any way to actually exploit this; however, it seems interesting that this can e.g. be used to create network interfaces whose names contain special characters like dollar, semicolon and backtick. I'm not sure how dangerous that is - I'm reporting it as a security bug for now, but if you feel that this has no security impact, feel free to derestrict it.\n\nOne way to fix this might be to temporarily drop privileges (setresuid(ruid, ruid, 0)) in rename_in_ns() after the first setns() call. This way, the renaming could only succeed if the caller is actually privileged in the network namespace.\n\nrelease: Ubuntu 16.10\nversion: lxc-common: 2.0.6-0ubuntu1~ubuntu16.10.1", "owner_link": "https://bugs.launchpad.net/api/devel/~jannh", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/bug_tasks", "duplicate_of_link": null, "date_created": "2017-01-06T22:58:38.267959+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/subscriptions", "date_last_updated": "2017-05-12T20:58:54.348897+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 260, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/cves", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/attachments", "security_related": true, "latest_patch_uploaded": "2017-02-11T12:35:41+00:00", "tags": [], "date_last_message": "2017-03-09T16:01:19.350324+00:00", "number_of_duplicates": 0, "message_count": 38, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/messages", "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1654676/linked_merge_proposals", "http_etag": "\"e8f56c8955704200dc70f9e51315e770b31828b3-47c1bec5578699c41281d06602db4849564b0e40\""}, "total_comments_and_activity": 50, "related_features": {}, "information_type_data": {"PUBLIC": {"is_private": false, "name": "Public", "order": 0, "description": "Everyone can see this information.\n", "value": "PUBLIC", "description_css_class": "choice-description"}, "PRIVATESECURITY": {"is_private": true, "name": "Private Security", "order": 2, "description": "Only the security group can see this information.\n ", "value": "PRIVATESECURITY", "description_css_class": "choice-description"}, "PUBLICSECURITY": {"is_private": false, "name": "Public Security", "order": 1, "description": "Everyone can see this security related information.\n", "value": "PUBLICSECURITY", "description_css_class": "choice-description"}, "USERDATA": {"is_private": true, "name": "Private", "order": 3, "description": "Only shared with users permitted to see private user information.\n", "value": "USERDATA", "description_css_class": "choice-description"}}, "context": {"self_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/lxc/+bug/1654676", "web_link": "https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/1654676", "milestone_link": null, "status": "Fix Released", "importance": "Undecided", "assignee_link": "https://bugs.launchpad.net/api/devel/~cbrauner", "bug_target_display_name": "lxc (Ubuntu)", "bug_target_name": "lxc (Ubuntu)", "bug_watch_link": null, "date_assigned": "2017-05-12T20:58:52.592899+00:00", "date_created": "2017-01-06T22:58:38.267959+00:00", "date_confirmed": "2017-03-09T16:01:21.369259+00:00", "date_incomplete": null, "date_in_progress": "2017-03-09T16:01:21.369259+00:00", "date_closed": "2017-03-09T16:01:21.369259+00:00", "date_left_new": "2017-03-09T16:01:21.369259+00:00", "date_triaged": "2017-03-09T16:01:21.369259+00:00", "date_fix_committed": "2017-03-09T16:01:21.369259+00:00", "date_fix_released": "2017-03-09T16:01:21.369259+00:00", "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~jannh", "target_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/lxc", "title": "Bug #1654676 in lxc (Ubuntu): \"lxc-user-nic does not ensure that target netns is caller-owned\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/lxc/+bug/1654676/related_tasks", "is_complete": true, "http_etag": "\"b9f3451f7e2311039a0d9c25da3eba2fa98122ac-c8719ff211e660eaf560b90470039068890f46e5\""}, "bugtask_data": {"2185273": {"delete_link": "https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1654676/+delete", "bug_title": "lxc-user-nic does not ensure that target netns is caller-owned", "user_can_unassign": false, "importance_value": "Undecided", "user_can_edit_importance": false, "assignee_vocabulary": "AllUserTeamsParticipation", "hide_assignee_team_selection": true, "user_can_edit_status": true, "user_can_delete": false, "row_id": "tasksummary2185273", "target_is_product": false, "user_can_edit_milestone": false, "prefix": "ubuntu_lxc", "bugtask_path": "/ubuntu/+source/lxc/+bug/1654676", "id": 2185273, "milestone_value": null, "status_widget_items": "[]", "milestone_widget_items": "[]", "form_row_id": "task2185273", "targetname": "lxc (Ubuntu)", "assignee_is_team": false, "assignee_vocabulary_filters": [], "user_can_edit_assignee": false, "importance_widget_items": "[]", "assignee_value": "cbrauner", "status_value": "Fix Released"}}, "subscribers_portlet_url_data": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1654676", "web_link": "https://bugs.launchpad.net/bugs/1654676"}, "initial_comment_batch_offset": 41, "first visible_recent_comment": -3};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 62 queries/external actions issued in 0.87 seconds

    Features: {'app.maintenance_message': None, 'hard_timeout': '9000', 'js.yui_version': None, 'app.mainsite_only.canonical_url': None, 'disclosure.dsp_picker.enabled': 'on', 'baselayout.careers_link.disabled': None, 'bugs.affected_count_includes_dupes.disabled': None, 'visible_render_time': None, 'profiling.enabled': None, 'bugs.nominations.bug_supervisors_can_target': 'on'}

    r0d8de2b

    -->

</html>

