<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Bug 739133 – CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://bugzilla.gnome.org/" rel="Top"/>
<link href="showdependencytree.cgi?id=739133&amp;hide_resolved=1" rel="Show" title="Dependency Tree"/>
<link href="show_bug.cgi?format=multiple&amp;id=739133" rel="Show" title="Printer-Friendly Version"/>
<link href="skins/standard/global.css" rel="alternate stylesheet" title="Classic"/><link href="js/yui/assets/skins/sam/autocomplete.css" rel="stylesheet" type="text/css"/><link href="js/yui/assets/skins/sam/calendar.css" rel="stylesheet" type="text/css"/><link href="skins/standard/global.css" rel="stylesheet" type="text/css"/><link href="skins/standard/show_bug.css" rel="stylesheet" type="text/css"/><!--[if lte IE 7]>
      


  <link href="skins/standard/IE-fixes.css" rel="stylesheet"
        type="text/css" >
<![endif]-->
<link href="skins/contrib/Gnome/global.css" rel="stylesheet" title="Gnome" type="text/css"/>
<script src="js/yui/yahoo-dom-event/yahoo-dom-event.js" type="text/javascript"></script><script src="js/yui/cookie/cookie-min.js" type="text/javascript"></script><script src="js/yui/datasource/datasource-min.js" type="text/javascript"></script><script src="js/yui/connection/connection-min.js" type="text/javascript"></script><script src="js/yui/json/json-min.js" type="text/javascript"></script><script src="js/yui/autocomplete/autocomplete-min.js" type="text/javascript"></script><script src="js/yui/calendar/calendar-min.js" type="text/javascript"></script><script src="js/global.js" type="text/javascript"></script>
<script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 50
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    'You must enter a Description for this attachment.',
                component_required:
                    'You must select a Component for this bug.',
                description_required:
                    'You must enter a Description for this bug.',
                short_desc_required:
                    'You must enter a Summary for this bug.',
                version_required:
                    'You must select a Version for this bug.'
            }
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null, 
                             "Bug 739133 – CVE-2017-17785 Out of bounds write \/ heap overflow in the .fli importer \/ fli_read_brun",  
                             "show_bug.cgi?id=739133" );
        document.title = "Bug 739133 – CVE-2017-17785 Out of bounds write \/ heap overflow in the .fli importer \/ fli_read_brun";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "Bug 739133 – CVE-2017-17785 Out of bounds write \/ heap overflow in the .fli importer \/ fli_read_brun", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();
    });
    // -->
    </script>
<script src="js/util.js" type="text/javascript"></script><script src="js/field.js" type="text/javascript"></script>
<link href="./search_plugin.cgi" rel="search" title="GNOME Bugzilla" type="application/opensearchdescription+xml"/>
<link href="images/favicon.ico" rel="shortcut icon"/><link href="extensions/TraceParser/web/style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="bugzilla-gnome-org bz_bug bz_status_RESOLVED bz_product_GIMP bz_component_Plugins bz_bug_739133 yui-skin-sam" onload="">
<div id="header">
<div id="banner">
</div>
<table border="0" cellpadding="0" cellspacing="0" id="titles">
<tr>
<td id="title">
<p>GNOME Bugzilla – Bug 739133</p>
</td>
<td id="subtitle">
<p class="subheader">CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun</p>
</td>
<td id="information">
<p class="header_addl_info">Last modified: 2017-12-22 15:08:37 UTC</p>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" class="bz_default_hidden" id="lang_links_container"><tr><td>
</td></tr></table>
<ul class="links"><li><a href="./">Home</a></li></ul>
</div>
<div id="bugzilla-body">
<div style="margin-bottom: 50px; margin-top: 50px; padding: 40px; text-align: center; background-color: rgb(74,134,207); border: rgb(57,104,161); color: rgb(255,255,255); line-height: 300%;">After an <a href="https://wiki.gnome.org/Initiatives/DevelopmentInfrastructure" style="color: rgb(255,255,255);">evaluation</a>, GNOME has moved from Bugzilla to <a href="https://gitlab.gnome.org/" style="color: rgb(255,255,255);">GitLab</a>. <a href="https://wiki.gnome.org/GitLab" style="color: rgb(255,255,255);">Learn more about GitLab</a>. <br/><span style="background-color: #EE0000; font-size: xx-large;"><b>No new issues can be reported in GNOME Bugzilla anymore.</b></span>
<br/><span style="background-color: #EE0000; font-size: xx-large;"><b>To report an issue in a GNOME project, <a href="https://gitlab.gnome.org/GNOME" style="color: rgb(255,255,255);">go to GNOME GitLab</a></b>.</span><br/>Do <b>not</b> go to GNOME Gitlab for: <a href="https://sourceforge.net/p/bluefish/tickets" style="color: rgb(255,255,255);">Bluefish</a>, <a href="https://github.com/doxygen/doxygen/issues" style="color: rgb(255,255,255);">Doxygen</a>, <a href="https://bugs.gnucash.org/" style="color: rgb(255,255,255);">GnuCash</a>, <a href="https://gitlab.freedesktop.org/gstreamer/" style="color: rgb(255,255,255);">GStreamer</a>, <a href="https://github.com/afcowie/java-gnome/issues" style="color: rgb(255,255,255);">java-gnome</a>, <a href="https://github.com/ldtp/ldtp2/issues" style="color: rgb(255,255,255);">LDTP</a>, <a href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager/issues" style="color: rgb(255,255,255);">NetworkManager</a>, <a href="https://github.com/tomboy-notes/tomboy/issues" style="color: rgb(255,255,255);">Tomboy</a>.</div>
<script type="text/javascript">
<!--

//-->
</script>
<form action="process_bug.cgi" id="changeform" method="post" name="changeform">
<input name="delta_ts" type="hidden" value="2017-12-22 15:08:37"/>
<input name="longdesclength" type="hidden" value="18"/>
<input name="id" type="hidden" value="739133"/>
<input name="token" type="hidden" value="1626083759-c7_NH8WIMAoQUOOx0WmtH_PcCNMj3d-mANezCW0-IH4"/>
<div class="bz_alias_short_desc_container edit_form">
<a href="show_bug.cgi?id=739133"><b>Bug 739133</b></a> -<span class="bz_default_hidden" id="summary_alias_container"> 
        (<span id="alias_nonedit_display">CVE-2017-17785</span>) 
      <span id="short_desc_nonedit_display">CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun</span>
</span>
<div id="summary_alias_input">
<table id="summary">
<tr>
<td colspan="2">(CVE-2017-17785)
          </td>
</tr>
<tr><th class="field_label" id="field_label_short_desc">
<label accesskey="s" for="short_desc">
<a class="field_help_link" href="page.cgi?id=fields.html#short_desc" title="The bug summary is a short sentence which succinctly describes what the bug is about.">Summary:</a>
</label>
</th>
<td><span title="CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun">CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli...
        </span>
</td>
</tr>
</table>
</div>
</div>
<script type="text/javascript">
    hideAliasAndSummary('CVE-2017-17785 Out of bounds write \/ heap overflow in the .fli importer \/ fli_read_brun', 'CVE-2017-17785');
  </script>
<table class="edit_form">
<tr>
<td class="bz_show_bug_column" id="bz_show_bug_column_1">
<table>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
<td id="bz_field_status">
<span id="static_bug_status">RESOLVED
          FIXED
      </span>
</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_product">
<a class="field_help_link" href="describecomponents.cgi" title="Bugs are categorised into Products and Components. Select a Classification to narrow down this list.">Product:</a>
</th>
<td class="field_value" id="field_container_product">GIMP</td>
</tr>
<tr class="bz_default_hidden"><th class="field_label" id="field_label_classification">
<a class="field_help_link" href="page.cgi?id=fields.html#classification" title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.">Classification:</a>
</th>
<td class="field_value" id="field_container_classification">Other</td>
</tr>
<tr><th class="field_label" id="field_label_component">
<a class="field_help_link" href="describecomponents.cgi?product=GIMP" title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.">Component:</a>
</th>
<td class="field_value" id="field_container_component">Plugins</td>
</tr>
<tr><th class="field_label" id="field_label_version">
<label for="version">
<a class="field_help_link" href="page.cgi?id=fields.html#version" title="The version field defines the version of the software the bug was found in.">Version:</a>
</label>
</th>
<td>2.8.14
  </td>
</tr>
<tr><th class="field_label" id="field_label_rep_platform">
<label accesskey="h" for="rep_platform">
<a class="field_help_link" href="page.cgi?id=fields.html#rep_platform" title='The hardware platform the bug was observed on. Note: When searching, selecting the option "All" only finds bugs whose value for this field is literally the word "All".'>Hardware:</a>
</label>
</th>
<td class="field_value">Other
       All
      </td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr>
<th class="field_label">
<label accesskey="i" for="priority">
<a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
<td>Normal
       blocker
      </td>
</tr>
<tr>
<th class="field_label">
<label for="target_milestone">
<a href="page.cgi?id=fields.html#target_milestone">
            Target Milestone</a></label>:
        </th><td>2.10
  </td>
</tr>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#assigned_to">Assigned To</a>:
      </th>
<td><span class="vcard"><span class="fn">GIMP Bugs</span>
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_qa_contact">
<label accesskey="q" for="qa_contact">
<a class="field_help_link" href="page.cgi?id=fields.html#qa_contact" title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.">QA Contact:</a>
</label>
</th>
<td><span class="vcard"><span class="fn">GIMP Bugs</span>
</span>
</td>
</tr>
<script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'bugs\x40gimp.org',
        'bugs\x40gimp.org');
    </script>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_bug_file_loc">
<label accesskey="u" for="bug_file_loc">
<a class="field_help_link" href="page.cgi?id=fields.html#bug_file_loc" title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.">URL:</a>
</label>
</th>
<td>
<span id="bz_url_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_status_whiteboard">
<label accesskey="w" for="status_whiteboard">
<a class="field_help_link" href="page.cgi?id=fields.html#status_whiteboard" title="Each bug has a free-form single line text entry box for adding tags and status information.">Whiteboard:</a>
</label>
</th><td colspan="2">CVE-2017-17785  
  </td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_dependson">
<a class="field_help_link" href="page.cgi?id=fields.html#dependson" title="The bugs listed here must be resolved before this bug can be resolved.">Depends on:</a>
</th>
<td>
<span id="dependson_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_blocked">
<a class="field_help_link" href="page.cgi?id=fields.html#blocked" title="This bug must be resolved before the bugs listed in this field can be resolved.">Blocks:</a>
</th>
<td>
<span id="blocked_input_area">
</span>
</td>
</tr>
<tr>
<th> </th>

</tr>
</table>
</td>
<td>
<div class="bz_column_spacer"> </div>
</td>
<td class="bz_show_bug_column" id="bz_show_bug_column_2">
<table cellpadding="3" cellspacing="1">
<tr>
<th class="field_label">
      Reported:
    </th>
<td>2014-10-24 14:37 UTC by <span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</td>
</tr>
<tr>
<th class="field_label">
      Modified:
    </th>
<td>2017-12-22 15:08 UTC 
    </td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_see_also">
<a class="field_help_link" href="page.cgi?id=fields.html#see_also" title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.">See Also:</a>
</th>
<td class="field_value" id="field_container_see_also"></td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_target">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_target" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME target:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_target">---</td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_version">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_version" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME version:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_version">---</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
</table>
</td>
</tr>
<tr>
<td colspan="3">
<hr id="bz_top_half_spacer"/>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" id="bz_big_form_parts"><tr>
<td>
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>
<br/>
<table cellpadding="4" cellspacing="0" id="attachment_table">
<tr id="a0">
<th align="left" colspan="3">
      Attachments
    </th>
</tr>
<tr class="bz_contenttype_video_x-flic" id="a1">
<td valign="top">
<a href="attachment.cgi?id=289275" title="View the content of the attachment">
<b>sample fli exposing out of bounds write</b></a>
<span class="bz_attach_extra_info">
              (6.93 KB,
                video/x-flic)

            <br/>
<a href="#attach_289275" title="Go to the comment associated with the attachment">2014-10-24 14:37 UTC</a>,

            <span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">
             
          </td>
<td valign="top">
<a href="attachment.cgi?id=289275&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain" id="a2">
<td valign="top">
<a href="attachment.cgi?id=289276" title="View the content of the attachment">
<b>address sanitizer output</b></a>
<span class="bz_attach_extra_info">
              (2.21 KB,
                text/plain)

            <br/>
<a href="#attach_289276" title="Go to the comment associated with the attachment">2014-10-24 14:38 UTC</a>,

            <span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">
             
          </td>
<td valign="top">
<a href="attachment.cgi?id=289276&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain" id="a3">
<td valign="top">
<a href="attachment.cgi?id=289277" title="View the content of the attachment">
<b>address sanitizer output decoded / symbolized</b></a>
<span class="bz_attach_extra_info">
              (2.64 KB,
                text/plain)

            <br/>
<a href="#attach_289277" title="Go to the comment associated with the attachment">2014-10-24 14:38 UTC</a>,

            <span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">
             
          </td>
<td valign="top">
<a href="attachment.cgi?id=289277&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden" id="a4">
<td valign="top">
<a href="attachment.cgi?id=362488" title="View the content of the attachment">
<b><span class="bz_obsolete">gimp-fli.patch</span></b></a>
<span class="bz_attach_extra_info">
              (4.56 KB,
                patch)

            <br/>
<a href="#attach_362488" title="Go to the comment associated with the attachment">2017-10-29 14:28 UTC</a>,

            <span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">none
          </td>
<td valign="top">
<a href="attachment.cgi?id=362488&amp;action=edit">Details</a>  |
    <a href="review?bug=739133&amp;attachment=362488">Review</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain bz_patch" id="a5">
<td valign="top">
<a href="attachment.cgi?id=365798" title="View the content of the attachment">
<b>gimp-fli.patch</b></a>
<span class="bz_attach_extra_info">
              (4.56 KB,
                patch)

            <br/>
<a href="#attach_365798" title="Go to the comment associated with the attachment">2017-12-20 18:40 UTC</a>,

            <span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">reviewed
          </td>
<td valign="top">
<a href="attachment.cgi?id=365798&amp;action=edit">Details</a>  |
    <a href="review?bug=739133&amp;attachment=365798">Review</a>
</td>
</tr>

</table>
<br/>
</td>
<td>
</td>
</tr></table>
<div id="comments"><script src="js/comments.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>
<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table cellpadding="0" cellspacing="0" class="bz_comment_table"><tr>
<td>
<div class="bz_comment bz_first_comment" id="c0">
<div class="bz_first_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c0">Description</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-10-24 14:37:17 UTC
        </span>
</div>
<pre class="bz_comment_text">I discovered an out-of-bounds write / heap overflow in the fli importer of GIMP.
This can be triggered by the attached sample which has been generated by the zzuf fuzzing tool. It will crash the plugin if gimp has been compiled with -fsanitize=address.
I'll attach the sample and the output of address sanitizer. This may be a security issue if a user opens files from untrusted sources.</pre>
</div><div class="bz_comment" id="c1">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c1">Comment 1</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-10-24 14:37:45 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=289275" name="attach_289275" title="sample fli exposing out of bounds write">attachment 289275</a> <a href="attachment.cgi?id=289275&amp;action=edit" title="sample fli exposing out of bounds write">[details]</a></span>
sample fli exposing out of bounds write</pre>
</div><div class="bz_comment" id="c2">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c2">Comment 2</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-10-24 14:38:04 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=289276" name="attach_289276" title="address sanitizer output">attachment 289276</a> <a href="attachment.cgi?id=289276&amp;action=edit" title="address sanitizer output">[details]</a></span>
address sanitizer output</pre>
</div><div class="bz_comment" id="c3">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c3">Comment 3</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-10-24 14:38:29 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=289277" name="attach_289277" title="address sanitizer output decoded / symbolized">attachment 289277</a> <a href="attachment.cgi?id=289277&amp;action=edit" title="address sanitizer output decoded / symbolized">[details]</a></span>
address sanitizer output decoded / symbolized</pre>
</div><div class="bz_comment" id="c4">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c4">Comment 4</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Mukund Sivaraman</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-10-27 02:45:51 UTC
        </span>
</div>
<pre class="bz_comment_text">Hi Hanno

More than these specific bug reports, I'm very glad to see someone using fuzz testing on the file plug-ins. Please can you mail the gimp-developer list with a HOWTO to test a single file plug-in? I'm sure others will also pick this up.

If you can, can you test the following most frequently used formats:
* XCF
* JPEG
* PNG
* TIFF

If you have more time:
* GIF
* BMP
* PSD
* PDF
* PS</pre>
</div><div class="bz_comment" id="c5">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c5">Comment 5</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Michael Natterer</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-11-23 20:08:21 UTC
        </span>
</div>
<pre class="bz_comment_text">Hanno, do you plan to write patches for these problems?</pre>
</div><div class="bz_comment" id="c6">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c6">Comment 6</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2014-11-23 22:50:30 UTC
        </span>
</div>
<pre class="bz_comment_text">Not really, at least not any time soon. But I'll probably follow the request to post a quick how-to-fuzz-gimp-plugins to your dev list.</pre>
</div><div class="bz_comment" id="c7">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c7">Comment 7</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-10-29 14:28:39 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=362488" name="attach_362488" title="gimp-fli.patch">attachment 362488</a> <a href="attachment.cgi?id=362488&amp;action=edit" title="gimp-fli.patch">[details]</a></span> <a href="review?bug=739133&amp;attachment=362488">[review]</a>
gimp-fli.patch

Fixes given test case and more RLE issues in the code.</pre>
</div><div class="bz_comment" id="c8">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c8">Comment 8</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Michael Natterer</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-19 20:22:02 UTC
        </span>
</div>
<pre class="bz_comment_text">I assume the patch was tested on some files? If yes it should simply
be pushed to master.</pre>
</div><div class="bz_comment" id="c9">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c9">Comment 9</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Raphael Hertzog</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-20 08:46:24 UTC
        </span>
</div>
<pre class="bz_comment_text">FYI this security issue has been given the following CVE number: CVE-2017-17785</pre>
</div><div class="bz_comment" id="c10">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c10">Comment 10</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Jehan</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-20 14:44:42 UTC
        </span>
</div>
<pre class="bz_comment_text">Review of <span class="bz_obsolete"><a href="attachment.cgi?id=362488" name="attach_362488" title="gimp-fli.patch">attachment 362488</a> <a href="attachment.cgi?id=362488&amp;action=edit" title="gimp-fli.patch">[details]</a></span> <a href="review?bug=739133&amp;attachment=362488">[review]</a>:

I did a review, that looks good.

There is only this line I have been wondering about:

<span class="quote">&gt; +       if (numline &gt; fli_header-&gt;height || fli_header-&gt;height-numline &gt; firstline)
&gt; +               return;</span>

Are you sure about the test, in particular the second part? Maybe I don't understand what firstline and numline are meant to be (in this case, naming is not good), but if I do, I would think that firstline + numline should always be lesser than the height (therefore this test would always return TRUE for a valid file).
Do I misunderstand something?

Also same as Mitch, <a href="show_bug.cgi?id=739133#c8">comment 8</a>, has this been tested with the FLI files running the exploit?

As soon as you clarify my question on the if test and confirm that it has been thoroughly tested, I see no reason why not to push immediately.</pre>
</div><div class="bz_comment" id="c11">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c11">Comment 11</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-20 18:39:07 UTC
        </span>
</div>
<pre class="bz_comment_text">(In reply to Jehan from <a href="show_bug.cgi?id=739133#c10">comment #10</a>)
<span class="quote">&gt; &gt; +       if (numline &gt; fli_header-&gt;height || fli_header-&gt;height-numline &gt; firstline)
&gt; &gt; +               return;
&gt; 
&gt; Are you sure about the test, in particular the second part?</span>

You are correct, it's supposed to be larger or equal, therefore the test must check the "lesser than" case.</pre>
</div><div class="bz_comment" id="c12">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c12">Comment 12</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-20 18:40:08 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=365798" name="attach_365798" title="gimp-fli.patch">attachment 365798</a> <a href="attachment.cgi?id=365798&amp;action=edit" title="gimp-fli.patch">[details]</a></span> <a href="review?bug=739133&amp;attachment=365798">[review]</a>
gimp-fli.patch

Updated patch</pre>
</div><div class="bz_comment" id="c13">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c13">Comment 13</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Jehan</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-21 12:14:29 UTC
        </span>
</div>
<pre class="bz_comment_text">Review of <span class=""><a href="attachment.cgi?id=365798" name="attach_365798" title="gimp-fli.patch">attachment 365798</a> <a href="attachment.cgi?id=365798&amp;action=edit" title="gimp-fli.patch">[details]</a></span> <a href="review?bug=739133&amp;attachment=365798">[review]</a>:

Hmmmm…
Sorry to be boring, but:

<span class="quote">&gt; +       if (numline &gt; fli_header-&gt;height || fli_header-&gt;height-numline &lt; firstline)</span>

Shouldn't there be an '=' now?

<span class="quote">&gt; +       if (numline &gt; fli_header-&gt;height || fli_header-&gt;height-numline &lt;= firstline)</span>

I mean if firstline starts at 0 (which I assume it does as it should!), then it should be '&lt;=' because then being at height is already out of bounds!

Also you didn't answer if this has been tested with actual files too. This is an important question. :-)</pre>
</div><div class="bz_comment" id="c14">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c14">Comment 14</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Tobias Stoeckmann</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-21 19:05:52 UTC
        </span>
</div>
<pre class="bz_comment_text">(In reply to Jehan from <a href="show_bug.cgi?id=739133#c13">comment #13</a>)
<span class="quote">&gt; Shouldn't there be an '=' now?
&gt; 
&gt; &gt; +       if (numline &gt; fli_header-&gt;height || fli_header-&gt;height-numline &lt;= firstline)</span>

No, being equal is a good condition. Imagine that height is 1 and firstline is 0. Then numline (the amount of iterations through the for-loop) can be 1, as that's a valid range.

<span class="quote">&gt; Also you didn't answer if this has been tested with actual files too. This
&gt; is an important question. :-)</span>

I have no real fli files. I was unable to reproduce the crash/exploit with applied patch, but then again, the initial patch broke the LC implementation as well.</pre>
</div><div class="bz_comment" id="c15">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c15">Comment 15</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Hanno Böck</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-22 12:07:59 UTC
        </span>
</div>
<pre class="bz_comment_text">FLI files: <a href="https://samples.ffmpeg.org/fli-flc/">https://samples.ffmpeg.org/fli-flc/</a>

I'll do some tests later.</pre>
</div><div class="bz_comment" id="c16">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c16">Comment 16</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Jehan</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-22 13:29:32 UTC
        </span>
</div>
<pre class="bz_comment_text"><span class="quote">&gt; No, being equal is a good condition.</span>

Indeed, you are right.

<span class="quote">&gt; I have no real fli files.</span>

I found this link: <a href="http://netghost.narod.ru/gff/sample/images/fli/index.htm">http://netghost.narod.ru/gff/sample/images/fli/index.htm</a>
I was able to properly open the 2 FLI files available there before and after the patch. And this patch looks good to me after the last review, and it would obviously fix some cases of out-of-bounds memory reading.

Pushed in master:

commit <a href="https://git.gnome.org/browse/GIMP/commit/?id=edb251a7ef1602d20a5afcbf23f24afb163de63b">edb251a7ef1602d20a5afcbf23f24afb163de63b</a> (HEAD -&gt; master, origin/master, origin/HEAD)
Author: Tobias Stoeckmann &lt;<a href="mailto:tobias@stoeckmann.org">tobias@stoeckmann.org</a>&gt;
Date:   Sun Oct 29 15:19:41 2017 +0100

    <a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=739133" title="RESOLVED FIXED - CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun">Bug 739133</a> - (CVE-2017-17785) Heap overflow while parsing FLI files.
    
    It is possible to trigger a heap overflow while parsing FLI files. The
    RLE decoder is vulnerable to out of boundary writes due to lack of
    boundary checks.
    
    The variable "framebuf" points to a memory area which was allocated
    with fli_header-&gt;width * fli_header-&gt;height bytes. The RLE decoder
    therefore must never write beyond that limit.
    
    If an illegal frame is detected, the parser won't stop, which means
    that the next valid sequence is properly parsed again. This should
    allow GIMP to parse FLI files as good as possible even if they are
    broken by an attacker or by accident.
    
    While at it, I changed the variable xc to be of type size_t, because
    the multiplication of width and height could overflow a 16 bit type.
    
    Signed-off-by: Tobias Stoeckmann &lt;<a href="mailto:tobias@stoeckmann.org">tobias@stoeckmann.org</a>&gt;

In 2.8:

commit <a href="https://git.gnome.org/browse/GIMP/commit/?id=1882bac996a20ab5c15c42b0c5e8f49033a1af54">1882bac996a20ab5c15c42b0c5e8f49033a1af54</a> (HEAD -&gt; gimp-2-8, origin/gimp-2-8)
Author: Tobias Stoeckmann &lt;<a href="mailto:tobias@stoeckmann.org">tobias@stoeckmann.org</a>&gt;
Date:   Sun Oct 29 15:19:41 2017 +0100

    <a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=739133" title="RESOLVED FIXED - CVE-2017-17785 Out of bounds write / heap overflow in the .fli importer / fli_read_brun">Bug 739133</a> - (CVE-2017-17785) Heap overflow while parsing FLI files.
    
    It is possible to trigger a heap overflow while parsing FLI files. The
    RLE decoder is vulnerable to out of boundary writes due to lack of
    boundary checks.
    
    The variable "framebuf" points to a memory area which was allocated
    with fli_header-&gt;width * fli_header-&gt;height bytes. The RLE decoder
    therefore must never write beyond that limit.
    
    If an illegal frame is detected, the parser won't stop, which means
    that the next valid sequence is properly parsed again. This should
    allow GIMP to parse FLI files as good as possible even if they are
    broken by an attacker or by accident.
    
    While at it, I changed the variable xc to be of type size_t, because
    the multiplication of width and height could overflow a 16 bit type.
    
    Signed-off-by: Tobias Stoeckmann &lt;<a href="mailto:tobias@stoeckmann.org">tobias@stoeckmann.org</a>&gt;
    (cherry picked from commit <a href="https://git.gnome.org/browse/GIMP/commit/?id=edb251a7ef1602d20a5afcbf23f24afb163de63b">edb251a7ef1602d20a5afcbf23f24afb163de63b</a>)

 plug-ins/file-fli/fli.c | 50 +++++++++++++++++++++++++++++++++++---------------
 1 file changed, 35 insertions(+), 15 deletions(-)

Thanks for the patches!</pre>
</div><div class="bz_comment" id="c17">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=739133#c17">Comment 17</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Jehan</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2017-12-22 15:08:37 UTC
        </span>
</div>
<pre class="bz_comment_text">For information: after checking that we had no pending patch related to FLI support (and actually no bug report even, it would seem), I just cleaned up the whole FLI plug-in to follow our coding style.
Previous style was a huge compressed mess which was very hard to read (and a bit suffocating IMO!).

There should be absolutely no code difference before and after (and if there is, that is a mistake from me), only coding style fix (spaces and such). Yet that touches the whole file. So if you were planning to do more stuff on this file, don't forget to push. Working on previous code will likely not merge well. :-)

Of course I tested afterwards with a bunch of FLI files (from the link I gave in <a href="show_bug.cgi?id=739133#c16">comment 16</a> as well as from the link Hanno gave in <a href="show_bug.cgi?id=739133#c15">comment 15</a>) and it looks I didn't break anything by mistake. :-P</pre>
</div>
<script type="text/javascript">
  function traceparser_toggle_trace(link, trace_id) {
    var trace = document.getElementById('trace_' + trace_id);
    bz_toggleClass(trace, 'bz_default_hidden');
    if (link.innerHTML == '+') { link.innerHTML = '&mdash;'; }
    else { link.innerHTML = '+'; }
  }
</script>
</td>
<td>
</td>
</tr></table>
</div>
<hr/>
</form>
<hr/>

<br/>
</div>
<div id="footer">
<div class="intro"></div>
<ul id="useful-links">
<li id="links-actions"><ul class="links">
<li><a href="./">Home</a></li>
<li><span class="separator">| </span><span style="text-decoration:line-through"><a href="">New</a></span></li>
<li><span class="separator">| </span><a href="page.cgi?id=browse.html&amp;product=GIMP">Browse</a></li>
<li><span class="separator">| </span><a href="query.cgi">Search</a></li>
<li class="form">
<span class="separator">| </span>
<form action="buglist.cgi" method="get" onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
<input id="no_redirect_bottom" name="no_redirect" type="hidden" value="0"/>
<script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
<input class="txt" id="quicksearch_bottom" name="quicksearch" title="Quick Search" type="text" value=""/>
<input class="btn" id="find_bottom" type="submit" value="Search"/></form>
<a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>
<li><span class="separator">| </span><a href="page.cgi?id=reports.html">Reports</a></li>
<li>
<span class="separator">| </span>
<a href="http://www.bugzilla.org/docs/4.4/en/html/bug_page.html" target="_blank">Help</a>
</li>
<li id="mini_login_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=739133&amp;GoAheadAndLogIn=1" id="login_link_bottom" onclick="return show_mini_login_form('_bottom')">Log In</a>
<form action="show_bug.cgi?id=739133" class="mini_login bz_default_hidden" id="mini_login_bottom" method="POST" onsubmit="return check_mini_login_fields( '_bottom' );">
<input class="bz_login" id="Bugzilla_login_bottom" name="Bugzilla_login" onfocus="mini_login_on_focus('_bottom')" title="Login"/>
<input class="bz_password" id="Bugzilla_password_bottom" name="Bugzilla_password" title="Password" type="password"/>
<input class="bz_password bz_default_hidden bz_mini_login_help" id="Bugzilla_password_dummy_bottom" onfocus="mini_login_on_focus('_bottom')" title="Password" type="text" value="password"/>
<input checked="" class="bz_remember" id="Bugzilla_remember_bottom" name="Bugzilla_remember" type="checkbox" value="on"/>
<label for="Bugzilla_remember_bottom">Remember</label>
<input name="Bugzilla_login_token" type="hidden" value=""/>
<input id="log_in_bottom" name="GoAheadAndLogIn" type="submit" value="Log in"/>
<script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
<a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
</form>
</li>
<li id="forgot_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=739133&amp;GoAheadAndLogIn=1#forgot" id="forgot_link_bottom" onclick="return show_forgot_form('_bottom')">Forgot Password</a>
<form action="token.cgi" class="mini_forgot bz_default_hidden" id="forgot_form_bottom" method="post">
<label for="login_bottom">Login:</label>
<input id="login_bottom" name="loginname" size="20" type="text"/>
<input id="forgot_button_bottom" type="submit" value="Reset Password"/>
<input name="a" type="hidden" value="reqpw"/>
<input id="token_bottom" name="token" type="hidden" value="1626083759-TJknJ54mvztrJDWYXpEwoMpkFJSjjr4Hrx4M87khZHI"/>
<a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
</form>
</li>
</ul>
</li>
</ul>
<div class="outro"></div>
</div>
</body>
</html>