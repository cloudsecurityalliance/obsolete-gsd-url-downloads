<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Bug 598476 – gnome-screensaver crashes when entering password incorrectly 5 times</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://bugzilla.gnome.org/" rel="Top"/>
<link href="showdependencytree.cgi?id=598476&amp;hide_resolved=1" rel="Show" title="Dependency Tree"/>
<link href="show_bug.cgi?format=multiple&amp;id=598476" rel="Show" title="Printer-Friendly Version"/>
<link href="skins/standard/global.css" rel="alternate stylesheet" title="Classic"/><link href="js/yui/assets/skins/sam/autocomplete.css" rel="stylesheet" type="text/css"/><link href="js/yui/assets/skins/sam/calendar.css" rel="stylesheet" type="text/css"/><link href="skins/standard/global.css" rel="stylesheet" type="text/css"/><link href="skins/standard/show_bug.css" rel="stylesheet" type="text/css"/><!--[if lte IE 7]>
      


  <link href="skins/standard/IE-fixes.css" rel="stylesheet"
        type="text/css" >
<![endif]-->
<link href="skins/contrib/Gnome/global.css" rel="stylesheet" title="Gnome" type="text/css"/>
<script src="js/yui/yahoo-dom-event/yahoo-dom-event.js" type="text/javascript"></script><script src="js/yui/cookie/cookie-min.js" type="text/javascript"></script><script src="js/yui/datasource/datasource-min.js" type="text/javascript"></script><script src="js/yui/connection/connection-min.js" type="text/javascript"></script><script src="js/yui/json/json-min.js" type="text/javascript"></script><script src="js/yui/autocomplete/autocomplete-min.js" type="text/javascript"></script><script src="js/yui/calendar/calendar-min.js" type="text/javascript"></script><script src="js/global.js" type="text/javascript"></script>
<script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 50
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    'You must enter a Description for this attachment.',
                component_required:
                    'You must select a Component for this bug.',
                description_required:
                    'You must enter a Description for this bug.',
                short_desc_required:
                    'You must enter a Summary for this bug.',
                version_required:
                    'You must select a Version for this bug.'
            }
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null, 
                             "Bug 598476 – gnome-screensaver crashes when entering password incorrectly 5 times",  
                             "show_bug.cgi?id=598476" );
        document.title = "Bug 598476 – gnome-screensaver crashes when entering password incorrectly 5 times";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "Bug 598476 – gnome-screensaver crashes when entering password incorrectly 5 times", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();
    });
    // -->
    </script>
<script src="js/util.js" type="text/javascript"></script><script src="js/field.js" type="text/javascript"></script>
<link href="./search_plugin.cgi" rel="search" title="GNOME Bugzilla" type="application/opensearchdescription+xml"/>
<link href="images/favicon.ico" rel="shortcut icon"/><link href="extensions/TraceParser/web/style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="bugzilla-gnome-org bz_bug bz_status_RESOLVED bz_product_gtk+ bz_component_Backend:_X11 bz_bug_598476 yui-skin-sam" onload="">
<div id="header">
<div id="banner">
</div>
<table border="0" cellpadding="0" cellspacing="0" id="titles">
<tr>
<td id="title">
<p>GNOME Bugzilla – Bug 598476</p>
</td>
<td id="subtitle">
<p class="subheader">gnome-screensaver crashes when entering password incorrectly 5 times</p>
</td>
<td id="information">
<p class="header_addl_info">Last modified: 2010-02-05 18:18:26 UTC</p>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" class="bz_default_hidden" id="lang_links_container"><tr><td>
</td></tr></table>
<ul class="links"><li><a href="./">Home</a></li></ul>
</div>
<div id="bugzilla-body">
<div style="margin-bottom: 50px; margin-top: 50px; padding: 40px; text-align: center; background-color: rgb(74,134,207); border: rgb(57,104,161); color: rgb(255,255,255); line-height: 300%;">After an <a href="https://wiki.gnome.org/Initiatives/DevelopmentInfrastructure" style="color: rgb(255,255,255);">evaluation</a>, GNOME has moved from Bugzilla to <a href="https://gitlab.gnome.org/" style="color: rgb(255,255,255);">GitLab</a>. <a href="https://wiki.gnome.org/GitLab" style="color: rgb(255,255,255);">Learn more about GitLab</a>. <br/><span style="background-color: #EE0000; font-size: xx-large;"><b>No new issues can be reported in GNOME Bugzilla anymore.</b></span>
<br/><span style="background-color: #EE0000; font-size: xx-large;"><b>To report an issue in a GNOME project, <a href="https://gitlab.gnome.org/GNOME" style="color: rgb(255,255,255);">go to GNOME GitLab</a></b>.</span><br/>Do <b>not</b> go to GNOME Gitlab for: <a href="https://sourceforge.net/p/bluefish/tickets" style="color: rgb(255,255,255);">Bluefish</a>, <a href="https://github.com/doxygen/doxygen/issues" style="color: rgb(255,255,255);">Doxygen</a>, <a href="https://bugs.gnucash.org/" style="color: rgb(255,255,255);">GnuCash</a>, <a href="https://gitlab.freedesktop.org/gstreamer/" style="color: rgb(255,255,255);">GStreamer</a>, <a href="https://github.com/afcowie/java-gnome/issues" style="color: rgb(255,255,255);">java-gnome</a>, <a href="https://github.com/ldtp/ldtp2/issues" style="color: rgb(255,255,255);">LDTP</a>, <a href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager/issues" style="color: rgb(255,255,255);">NetworkManager</a>, <a href="https://github.com/tomboy-notes/tomboy/issues" style="color: rgb(255,255,255);">Tomboy</a>.</div>
<script type="text/javascript">
<!--

//-->
</script>
<form action="process_bug.cgi" id="changeform" method="post" name="changeform">
<input name="delta_ts" type="hidden" value="2010-02-05 18:18:26"/>
<input name="longdesclength" type="hidden" value="20"/>
<input name="id" type="hidden" value="598476"/>
<input name="token" type="hidden" value="1626080127-pQcgw48RkdByf8fDR5otB4bbB46uS869-J7ujLJfkSU"/>
<div class="bz_alias_short_desc_container edit_form">
<a href="show_bug.cgi?id=598476"><b>Bug 598476</b></a> -<span class="bz_default_hidden" id="summary_alias_container">
<span id="short_desc_nonedit_display">gnome-screensaver crashes when entering password incorrectly 5 times</span>
</span>
<div id="summary_alias_input">
<table id="summary">
<tr>
<td colspan="2">
</td>
</tr>
<tr><th class="field_label" id="field_label_short_desc">
<label accesskey="s" for="short_desc">
<a class="field_help_link" href="page.cgi?id=fields.html#short_desc" title="The bug summary is a short sentence which succinctly describes what the bug is about.">Summary:</a>
</label>
</th>
<td>gnome-screensaver crashes when entering password incorrectly 5 times
          </td>
</tr>
</table>
</div>
</div>
<script type="text/javascript">
    hideAliasAndSummary('gnome-screensaver crashes when entering password incorrectly 5 times', '');
  </script>
<table class="edit_form">
<tr>
<td class="bz_show_bug_column" id="bz_show_bug_column_1">
<table>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
<td id="bz_field_status">
<span id="static_bug_status">RESOLVED
          FIXED
      </span>
</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_product">
<a class="field_help_link" href="describecomponents.cgi" title="Bugs are categorised into Products and Components. Select a Classification to narrow down this list.">Product:</a>
</th>
<td class="field_value" id="field_container_product">gtk+</td>
</tr>
<tr class="bz_default_hidden"><th class="field_label" id="field_label_classification">
<a class="field_help_link" href="page.cgi?id=fields.html#classification" title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.">Classification:</a>
</th>
<td class="field_value" id="field_container_classification">Platform</td>
</tr>
<tr><th class="field_label" id="field_label_component">
<a class="field_help_link" href="describecomponents.cgi?product=gtk+" title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.">Component:</a>
</th>
<td class="field_value" id="field_container_component">Backend: X11</td>
</tr>
<tr><th class="field_label" id="field_label_version">
<label for="version">
<a class="field_help_link" href="page.cgi?id=fields.html#version" title="The version field defines the version of the software the bug was found in.">Version:</a>
</label>
</th>
<td>2.18.x
  </td>
</tr>
<tr><th class="field_label" id="field_label_rep_platform">
<label accesskey="h" for="rep_platform">
<a class="field_help_link" href="page.cgi?id=fields.html#rep_platform" title='The hardware platform the bug was observed on. Note: When searching, selecting the option "All" only finds bugs whose value for this field is literally the word "All".'>Hardware:</a>
</label>
</th>
<td class="field_value">Other
       Linux
      </td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr>
<th class="field_label">
<label accesskey="i" for="priority">
<a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
<td>Normal
       blocker
      </td>
</tr>
<tr>
<th class="field_label">
<label for="target_milestone">
<a href="page.cgi?id=fields.html#target_milestone">
            Target Milestone</a></label>:
        </th><td>---
  </td>
</tr>
<tr>
<th class="field_label">
<a href="page.cgi?id=fields.html#assigned_to">Assigned To</a>:
      </th>
<td><span class="vcard">gtk-bugs
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_qa_contact">
<label accesskey="q" for="qa_contact">
<a class="field_help_link" href="page.cgi?id=fields.html#qa_contact" title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.">QA Contact:</a>
</label>
</th>
<td><span class="vcard">gtk-bugs
</span>
</td>
</tr>
<script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'gtk-bugs\x40gtk.org',
        'gtk-bugs\x40gtk.org');
    </script>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_bug_file_loc">
<label accesskey="u" for="bug_file_loc">
<a class="field_help_link" href="page.cgi?id=fields.html#bug_file_loc" title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.">URL:</a>
</label>
</th>
<td>
<span id="bz_url_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_status_whiteboard">
<label accesskey="w" for="status_whiteboard">
<a class="field_help_link" href="page.cgi?id=fields.html#status_whiteboard" title="Each bug has a free-form single line text entry box for adding tags and status information.">Whiteboard:</a>
</label>
</th><td colspan="2">
</td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr>
<th class="field_label">
<label for="duplicates">Duplicates</label>:
    </th>
<td class="field_value" colspan="2">
<span id="duplicates"><a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=603652" title="RESOLVED DUPLICATE - Sporadic crashes with GtkSocket">603652</a>
</span>
      (<a href="buglist.cgi?bug_id=603652">view as bug list</a>)
    </td>
</tr>
<tr><th class="field_label" id="field_label_dependson">
<a class="field_help_link" href="page.cgi?id=fields.html#dependson" title="The bugs listed here must be resolved before this bug can be resolved.">Depends on:</a>
</th>
<td>
<span id="dependson_input_area">
</span>
</td>
</tr>
<tr><th class="field_label" id="field_label_blocked">
<a class="field_help_link" href="page.cgi?id=fields.html#blocked" title="This bug must be resolved before the bugs listed in this field can be resolved.">Blocks:</a>
</th>
<td>
<span id="blocked_input_area">
</span>
<a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=603652" title="RESOLVED DUPLICATE - Sporadic crashes with GtkSocket">603652</a>
</td>
</tr>
<tr>
<th> </th>

</tr>
</table>
</td>
<td>
<div class="bz_column_spacer"> </div>
</td>
<td class="bz_show_bug_column" id="bz_show_bug_column_2">
<table cellpadding="3" cellspacing="1">
<tr>
<th class="field_label">
      Reported:
    </th>
<td>2009-10-14 18:19 UTC by <span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</td>
</tr>
<tr>
<th class="field_label">
      Modified:
    </th>
<td>2010-02-05 18:18 UTC 
    </td>
</tr>

<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
<tr><th class="field_label" id="field_label_see_also">
<a class="field_help_link" href="page.cgi?id=fields.html#see_also" title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.">See Also:</a>
</th>
<td class="field_value" id="field_container_see_also"></td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_target">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_target" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME target:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_target">---</td>
</tr>
<tr><th class="field_label" id="field_label_cf_gnome_version">
<a class="field_help_link" href="page.cgi?id=fields.html#cf_gnome_version" title="A custom Drop Down field in this installation of GNOME Bugzilla.">GNOME version:</a>
</th>
<td class="field_value" colspan="2" id="field_container_cf_gnome_version">---</td>
</tr>
<tr>
<td class="bz_section_spacer" colspan="2"></td>
</tr>
</table>
</td>
</tr>
<tr>
<td colspan="3">
<hr id="bz_top_half_spacer"/>
</td>
</tr>
</table>
<table cellpadding="0" cellspacing="0" id="bz_big_form_parts"><tr>
<td>
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>
<br/>
<table cellpadding="4" cellspacing="0" id="attachment_table">
<tr id="a0">
<th align="left" colspan="3">
      Attachments
    </th>
</tr>
<tr class="bz_contenttype_text_plain" id="a1">
<td valign="top">
<a href="attachment.cgi?id=145446" title="View the content of the attachment">
<b>Debug output from gnome-screensaver leading up to the crash</b></a>
<span class="bz_attach_extra_info">
              (311.70 KB,
                text/plain)

            <br/>
<a href="#attach_145446" title="Go to the comment associated with the attachment">2009-10-14 18:21 UTC</a>,

            <span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">
             
          </td>
<td valign="top">
<a href="attachment.cgi?id=145446&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain bz_patch" id="a2">
<td valign="top">
<a href="attachment.cgi?id=146788" title="View the content of the attachment">
<b>gs_dont_crash_on_invalid_password.patch</b></a>
<span class="bz_attach_extra_info">
              (3.85 KB,
                patch)

            <br/>
<a href="#attach_146788" title="Go to the comment associated with the attachment">2009-11-02 23:46 UTC</a>,

            <span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">committed
          </td>
<td valign="top">
<a href="attachment.cgi?id=146788&amp;action=edit">Details</a>  |
    <a href="review?bug=598476&amp;attachment=146788">Review</a>
</td>
</tr>
<tr class="bz_contenttype_application_x-lzma" id="a3">
<td valign="top">
<a href="attachment.cgi?id=149284" title="View the content of the attachment">
<b>xtrace log</b></a>
<span class="bz_attach_extra_info">
              (81.51 KB,
                application/x-lzma)

            <br/>
<a href="#attach_149284" title="Go to the comment associated with the attachment">2009-12-07 18:13 UTC</a>,

            <span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">
             
          </td>
<td valign="top">
<a href="attachment.cgi?id=149284&amp;action=edit">Details</a>
</td>
</tr>
<tr class="bz_contenttype_text_plain bz_patch" id="a4">
<td valign="top">
<a href="attachment.cgi?id=149335" title="View the content of the attachment">
<b>Possible gtk fix</b></a>
<span class="bz_attach_extra_info">
              (735 bytes,
                patch)

            <br/>
<a href="#attach_149335" title="Go to the comment associated with the attachment">2009-12-08 14:53 UTC</a>,

            <span class="vcard"><span class="fn">Alexander Larsson</span>
</span>
</span>
</td>
<td class="bz_attach_status" valign="top">committed
          </td>
<td valign="top">
<a href="attachment.cgi?id=149335&amp;action=edit">Details</a>  |
    <a href="review?bug=598476&amp;attachment=149335">Review</a>
</td>
</tr>

</table>
<br/>
</td>
<td>
</td>
</tr></table>
<div id="comments"><script src="js/comments.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>
<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table cellpadding="0" cellspacing="0" class="bz_comment_table"><tr>
<td>
<div class="bz_comment bz_first_comment" id="c0">
<div class="bz_first_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c0">Description</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-10-14 18:19:44 UTC
        </span>
</div>
<pre class="bz_comment_text">As reported here: <a href="https://bugs.edge.launchpad.net/ubuntu/+source/gnome-screensaver/+bug/446395">https://bugs.edge.launchpad.net/ubuntu/+source/gnome-screensaver/+bug/446395</a>

We're seeing several users reporting that their screen unlocks successfully when they enter their password incorrectly 5 times. What seems to be happening is that gnome-screensaver is actually crashing. I can trigger it sometimes (although I have to be quite persistent), and this is the backtrace I got (breaking on gdk_x_error):

</pre>
<p class="trace_link" title="See Full Trace">
<a class="trace_toggle_box" href="#" onclick="traceparser_toggle_trace(this, 218314); return false;" title="Expand/Collapse Trace">+</a>
<a href="page.cgi?id=traceparser/trace.html&amp;trace_id=218314">Trace
    218314</a></p>
<table border="0" cellpadding="0" cellspacing="0"><tr><td>
<div class="trace bz_default_hidden" id="trace_218314">
<ul class="frames">
<li class="frame">
<span class="frame_number">#0</span>
<span class="frame_function">gdk_x_error</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/x11/gdkmain-x11.c</span>
                  line
                  <span class="frame_line">438</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#1</span>
<span class="frame_function">_XError</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/XlibInt.c</span>
                  line
                  <span class="frame_line">2924</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#2</span>
<span class="frame_function">process_responses</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/xcb_io.c</span>
                  line
                  <span class="frame_line">207</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#3</span>
<span class="frame_function">_XReply</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/xcb_io.c</span>
                  line
                  <span class="frame_line">457</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#4</span>
<span class="frame_function">XSync</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/Sync.c</span>
                  line
                  <span class="frame_line">48</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#5</span>
<span class="frame_function">_XSyncFunction</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/Synchro.c</span>
                  line
                  <span class="frame_line">37</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#6</span>
<span class="frame_function">XFreePixmap</span>
<div class="frame_file_container">
                at <span class="frame_file">../../src/FreePix.c</span>
                  line
                  <span class="frame_line">43</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#7</span>
<span class="frame_function">gdk_pixmap_impl_x11_dispose</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/x11/gdkpixmap-x11.c</span>
                  line
                  <span class="frame_line">103</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#8</span>
<span class="frame_function">IA__g_object_unref</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/gobject/gobject.c</span>
                  line
                  <span class="frame_line">2441</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#9</span>
<span class="frame_function">gdk_pixmap_finalize</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/gdkpixmap.c</span>
                  line
                  <span class="frame_line">231</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#10</span>
<span class="frame_function">IA__g_object_unref</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/gobject/gobject.c</span>
                  line
                  <span class="frame_line">2472</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#11</span>
<span class="frame_function">gdk_window_end_implicit_paint</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/gdkwindow.c</span>
                  line
                  <span class="frame_line">2630</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#12</span>
<span class="frame_function">gdk_window_process_updates_internal</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/gdkwindow.c</span>
                  line
                  <span class="frame_line">5241</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#13</span>
<span class="frame_function">IA__gdk_window_process_all_updates</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/gdkwindow.c</span>
                  line
                  <span class="frame_line">5328</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#14</span>
<span class="frame_function">gtk_container_idle_sizer</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gtk/gtkcontainer.c</span>
                  line
                  <span class="frame_line">1353</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#15</span>
<span class="frame_function">gdk_threads_dispatch</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gdk/gdk.c</span>
                  line
                  <span class="frame_line">506</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#16</span>
<span class="frame_function">g_main_dispatch</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">1960</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#17</span>
<span class="frame_function">IA__g_main_context_dispatch</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2513</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#18</span>
<span class="frame_function">g_main_context_iterate</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2591</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#19</span>
<span class="frame_function">IA__g_main_context_iteration</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2654</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#20</span>
<span class="frame_function">IA__gtk_main_iteration</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gtk/gtkmain.c</span>
                  line
                  <span class="frame_line">1304</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#21</span>
<span class="frame_function">shake_dialog</span>
<div class="frame_file_container">
                at <span class="frame_file">gs-window-x11.c</span>
                  line
                  <span class="frame_line">1420</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#22</span>
<span class="frame_function">lock_command_watch</span>
<div class="frame_file_container">
                at <span class="frame_file">gs-window-x11.c</span>
                  line
                  <span class="frame_line">1456</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#23</span>
<span class="frame_function">g_main_dispatch</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">1960</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#24</span>
<span class="frame_function">IA__g_main_context_dispatch</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2513</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#25</span>
<span class="frame_function">g_main_context_iterate</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2591</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#26</span>
<span class="frame_function">IA__g_main_loop_run</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/glib2.0-2.22.2/glib/gmain.c</span>
                  line
                  <span class="frame_line">2799</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#27</span>
<span class="frame_function">IA__gtk_main</span>
<div class="frame_file_container">
                at <span class="frame_file">/build/buildd/gtk+2.0-2.18.2/gtk/gtkmain.c</span>
                  line
                  <span class="frame_line">1216</span>
</div>
</li>
<li class="frame">
<span class="frame_number">#28</span>
<span class="frame_function">main</span>
<div class="frame_file_container">
                at <span class="frame_file">gnome-screensaver.c</span>
                  line
                  <span class="frame_line">111</span>
</div>
</li>
</ul>
</div>
</td></tr></table>
<pre class="bz_comment_text">


The X error is:

The program 'gnome-screensaver' received an X Window System error.
This probably reflects a bug in the program.
The error was 'BadDrawable (invalid Pixmap or Window parameter)'.
  (Details: serial 33949 error_code 9 request_code 53 minor_code 0)
  (Note to programmers: normally, X errors are reported asynchronously;
   that is, you will receive the error a while after causing it.
   To debug your program, run it with the --sync command line
   option to change this behavior. You can then get a meaningful
   backtrace from your debugger if you break on the gdk_x_error() function.)</pre>
</div><div class="bz_comment" id="c1">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c1">Comment 1</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-10-14 18:21:10 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=145446" name="attach_145446" title="Debug output from gnome-screensaver leading up to the crash">attachment 145446</a> <a href="attachment.cgi?id=145446&amp;action=edit" title="Debug output from gnome-screensaver leading up to the crash">[details]</a></span>
Debug output from gnome-screensaver leading up to the crash</pre>
</div><div class="bz_comment" id="c2">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c2">Comment 2</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-10-16 07:34:15 UTC
        </span>
</div>
<pre class="bz_comment_text">We've just committed a change in Ubuntu which fixes this issue: <a href="http://bazaar.launchpad.net/~ubuntu-desktop/gnome-screensaver/ubuntu/revision/42#debian/patches/08_gs_dialog_request_to_exit.patch">http://bazaar.launchpad.net/~ubuntu-desktop/gnome-screensaver/ubuntu/revision/42#debian/patches/08_gs_dialog_request_to_exit.patch</a>

Basically, what is happening is that gnome-screensaver-dialog exits after the 5th failed attempt at unlocking the screen, but before the shake animation finishes. If the timing is slightly unlucky, this results in gnome-screensaver accessing X resources that have already been destroyed (I ran it through xtrace, and that showed this happening)

My patch fixes this by making gnome-screensaver-dialog request to gnome-screensaver that it be terminated after the 5th failed attempt (rather than exitting straight away, although there is a fallback timeout too). gnome-screensaver then terminates the dialog after it is finished with the shake animation, to avoid the race condition that is currently making it crash.</pre>
</div><div class="bz_comment" id="c3">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c3">Comment 3</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Matthias Clasen</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-10-17 18:11:08 UTC
        </span>
</div>
<pre class="bz_comment_text">Wouldn't it be much simpler to just ignore X errors in the shaker ?</pre>
</div><div class="bz_comment" id="c4">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c4">Comment 4</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-10-17 22:21:29 UTC
        </span>
</div>
<pre class="bz_comment_text">It would be simpler - but you still occasionally end up with quite a few g_critical messages on the console if you do it this way (although I can't tell you exactly what they are yet until I trigger it again).

The method I've used avoids this, and also means that the dialog only disappears after the shaker has finished (although that is mainly cosmetic)</pre>
</div><div class="bz_comment" id="c5">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c5">Comment 5</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">William Jon McCann</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-11-02 21:41:54 UTC
        </span>
</div>
<pre class="bz_comment_text">Can you please attach the patch here for review.  It doesn't look quite right to me.</pre>
</div><div class="bz_comment" id="c6">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c6">Comment 6</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-11-02 21:56:44 UTC
        </span>
</div>
<pre class="bz_comment_text">don't you need to queue a SIGTERM after the shake finishes if the request comes in while the shake is happening?  Also, I don't think this makes sense:

+ g_timeout_add (5000, (GSourceFunc)quit_timeout_cb, NULL);

There's no reason to second guess the daemon.</pre>
</div><div class="bz_comment" id="c7">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c7">Comment 7</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-11-02 21:58:56 UTC
        </span>
</div>
<pre class="bz_comment_text">Also, we should have the gdk_error_trap_push/gdk_display_sync/gdk_error_trap_pop calls <a href="show_bug.cgi?id=598476#c3">comment 3</a> alluded to regardless for general robustness reasons.</pre>
</div><div class="bz_comment" id="c8">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c8">Comment 8</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-11-02 23:46:14 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=146788" name="attach_146788" title="gs_dont_crash_on_invalid_password.patch">attachment 146788</a> <a href="attachment.cgi?id=146788&amp;action=edit" title="gs_dont_crash_on_invalid_password.patch">[details]</a></span> <a href="review?bug=598476&amp;attachment=146788">[review]</a>
gs_dont_crash_on_invalid_password.patch

Here is the version of the patch which is currently applied in Ubuntu.

+ g_timeout_add (5000, (GSourceFunc)quit_timeout_cb, NULL);

This part was added to handle upgrades where the user might be running the old daemon but have a new gnome-screensaver-dialog process. Without this, the user is left with a hung dialog if they enter their password incorrectly 5 times after they upgraded, but before restarting their session.

I agree that we should probably have the gdk_error_trap_push/gdk_display_sync/gdk_error_trap_pop in addition to the change I've already made.

I removed the SIGTERM handler in our Ubuntu patch, as that caused other issues (such as the dialog hanging when it times out)</pre>
</div><div class="bz_comment" id="c9">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c9">Comment 9</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-04 19:46:48 UTC
        </span>
</div>
<pre class="bz_comment_text">So looking at this further, I think we may be missing the boat here.  Or at least, not entirely understanding the problem.

Trace 218314

shows the BadDrawable is a locally created pixmap that's internal to gtk, used for its expose handling.

Also, if you look at the more complete trace in launchpad (<a href="http://paste.ubuntu.com/293307/">http://paste.ubuntu.com/293307/</a>):

</pre>
<p class="trace_link" title="See Full Trace">
<a class="trace_toggle_box" href="#" onclick="traceparser_toggle_trace(this, 219456); return false;" title="Expand/Collapse Trace">+</a>
<a href="page.cgi?id=traceparser/trace.html&amp;trace_id=219456">Trace
    219456</a></p>
<table border="0" cellpadding="0" cellspacing="0"><tr><td>
<div class="trace bz_default_hidden" id="trace_219456">
<ul class="frames">
<li class="frame">
<span class="frame_number">#6</span>
<span class="frame_function">XFreePixmap</span>
</li>
</ul>
</div>
</td></tr></table>
<pre class="bz_comment_text">

it shows the pixmap being passed to XFreePixmap is bogus

That leads me to think we're dealing with some sort of memory corruption here.

Note I've spent some time trying to reproduce and have been unable to do so, so far.  

I also tried to induce the original race condition by adding sleep statements in the expose handler, by removing the sleeps in the shake function, by making it shaking indefinitly instead of 9 times, and by making the lock dialog exit after 1 failure instead of 5.

I also ran the screensaver through valgrind and haven't hit any issues yet.  Chris, can you:

1) try backing out your patch
2) make sure you can still reproduce the problem
3) export G_SLICE=always-malloc
4) run valgrind --log-file=/tmp/screensaver.log gnome-scrensaver --no-daemon
5) reproduce

and see if the valgrind log shows anything?</pre>
</div><div class="bz_comment" id="c10">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c10">Comment 10</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-07 18:13:17 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=149284" name="attach_149284" title="xtrace log">attachment 149284</a> <a href="attachment.cgi?id=149284&amp;action=edit" title="xtrace log">[details]</a></span>
xtrace log

As discussed on IRC, here is a xtrace log I saved when initially debugging this issue some time ago. It's quite big, so I'll pick out the interesting bits here (and sorry for the compression, but it was the only way I could get it to below 100kB):

The errors that make it crash can be seen at the end of the file:

000:&lt;:06be: 16: Request(53): CreatePixmap depth=0x18 pid=0x02e000fe drawable=0x05400020 width=550 height=362
000:&lt;:06bf:  8: Request(54): FreePixmap drawable=0x02e000fe
000:&lt;:06c0: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={cursor=None(0x00000000)}
000:&lt;:06c1: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}
000:&lt;:06c2:  8: Request(10): UnmapWindow window=0x02e00060
000:&lt;:06c3: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
000:&lt;:06c4: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}
000:&lt;:06c5:  8: Request(10): UnmapWindow window=0x02e00060
000:&lt;:06c6: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
000:&lt;:06c7: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}
000:&lt;:06c8: 16: SHAPE-Request(141,1): ShapeRectangles operation=Set(0x00) destination kind=Bounding(0x00) ordering=YXBanded(0x03) destination window=0x02e00060 x-offset=0 y-offset=0 rectangles=;
000:&lt;:06c9: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
000:&lt;:06ca:  8: Request(4): DestroyWindow window=0x02e00060
000:&lt;:06cb: 16: Request(53): CreatePixmap depth=0x18 pid=0x02e000ff drawable=0x02e00024 width=1680 height=1050
000:&lt;:06cc: 28: Request(55): CreateGC cid=0x02e00100 drawable=0x02e000ff  values={fill-style=Tiled(0x01) tile=0x02e0004e graphics-exposures=false(0x00)}
000:&lt;:06cd: 20: Request(59): SetClipRectangles ordering=YXBanded(0x03) gc=0x02e00100 clip-x-origin=0 clip-y-origin=0 rectangles ={x=0 y=0 w=1680 h=1050};
000:&lt;:06ce: 20: Request(70): PolyFillRectangle drawable=0x02e000ff gc=0x02e00100 rectangles={x=0 y=0 w=1680 h=1050};
000:&lt;:06cf:  8: Request(60): FreeGC gc=0x02e00100
000:&lt;:06d0: 16: Request(2): ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
000:&lt;:06d1: 28: Request(55): CreateGC cid=0x02e00101 drawable=0x02e000ff  values={fill-style=Tiled(0x01) tile=0x02e0004e graphics-exposures=false(0x00)}
000:&lt;:06d2: 20: Request(59): SetClipRectangles ordering=YXBanded(0x03) gc=0x02e00101 clip-x-origin=0 clip-y-origin=0 rectangles ={x=0 y=0 w=1680 h=1050};
000:&lt;:06d3: 20: Request(70): PolyFillRectangle drawable=0x02e000ff gc=0x02e00101 rectangles={x=0 y=0 w=1680 h=1050};
000:&lt;:06d4:  8: Request(60): FreeGC gc=0x02e00101
000:&lt;:06d5: 20: Request(59): SetClipRectangles ordering=YXBanded(0x03) gc=0x02e00056 clip-x-origin=0 clip-y-origin=0 rectangles ={x=0 y=0 w=1680 h=1050};
000:&lt;:06d6: 28: Request(62): CopyArea src-drawable=0x02e000ff dst-drawable=0x02e00024 gc=0x02e00056 src-x=0 src-y=0 dst-x=0 dst-y=0 width=1680 height=1050
000:&lt;:06d7: 16: Request(56): ChangeGC gc=0x02e00056  values={clip-mask=None(0x00000000)}
000:&lt;:06d8:  8: Request(54): FreePixmap drawable=0x02e000ff
000:&gt;:6be:Error 9=Drawable: major=0, minor=53, bad=88080416
000:&gt;:6bf:Error 4=Pixmap: major=0, minor=54, bad=48234750

The first bad call is a CreatePixmap, which passes drawable=0x05400020. If you look above this in the log file, you will see that the server already sent out a DestroyNotify for this drawable:

000:&gt;:06af: Event UnmapNotify(18) event=0x05400020 window=0x05400020 from-configure=false(0x00)
000:&gt;:06af: Event UnmapNotify(18) event=0x02e00060 window=0x05400020 from-configure=false(0x00)
000:&gt;:06af: Event Expose(12) window=0x02e00060 x=0 y=0 width=550 height=362 count=0x0000
000:&gt;:06af: Event EnterNotify(7) detail=Inferior(0x02) mode=Normal(0x00) flags=same-screen time=0x02809425 root=0x0000013c event=0x02e00060 child=None(0x00000000) root-x=921 root-y=685 event-x=371 event-y=341 state=Mod2
000:&gt;:06af: Event DestroyNotify(17) event=0x05400020 window=0x05400020
000:&gt;:06af: Event DestroyNotify(17) event=0x02e00060 window=0x05400020

Looking further up in the log file, this particular drawable was created here:

003:&lt;:00cc:  8: Request(17): GetAtomName atom=0xc7(unrecognized atom)
003:&gt;:00cc:44: Reply to GetAtomName:  name='Mouse Keys'
003:&lt;:00cd: 52: Request(1): CreateWindow depth=0x18 window=0x05400020 parent=0x0000013c x=0 y=0 width=1 height=1 border-width=0 class=InputOutput(0x0001) visual=0x00000021  value-list={background-pixel=0x00000000 border-pixel=0x00000000 bit-gravity=NorthWest(0x01) event-mask=KeyPress,KeyRelease,ButtonPress,ButtonRelease,EnterWindow,LeaveWindow,PointerMotion,Exposure,VisibilityChange,StructureNotify,PropertyChange colormap=0x00000020}
003:&lt;:00ce: 48: Request(18): ChangeProperty mode=Replace(0x00) window=0x05400020 property=0x100("_NET_WM_NAME") type=0xf1("UTF8_STRING")     data=0x67,0x6e,0x6f,0x6d,0x65,0x2d,0x73,0x63,0x72,0x65,0x65,0x6e,0x73,0x61,0x76,0x65,0x72,0x2d,0x64,0x69,0x61,0x6c,0x6f,0x67;
003:&lt;:00cf: 48: Request(18): ChangeProperty mode=Replace(0x00) window=0x05400020 property=0x27("WM_NAME") type=0x1f("STRING")    data='gnome-screensaver-dialog'
003:&lt;:00d0: 48: Request(18): ChangeProperty mode=Replace(0x00) window=0x05400020 property=0xff("_NET_WM_ICON_NAME") type=0xf1("UTF8_STRING")     data=0x67,0x6e,0x6f,0x6d,0x65,0x2d,0x73,0x63,0x72,0x65,0x65,0x6e,0x73,0x61,0x76,0x65,0x72,0x2d,0x64,0x69,0x61,0x6c,0x6f,0x67;

The numbers on the left there indicate that these calls were from a different process, and the ChangeProperty calls show that gnome-screensaver-dialog created this window.

Basically, what seems to be happening is that the GdkWindow passed to gdk_window_process_updates_internal() is actually the newly destroyed foreign window belonging to gnome-screensaver-dialog, and this is where the 2 failed calls shown in the xtrace log come from (CreatePixmap in gdk_window_begin_implicit_paint, and FreePixmap in gdk_window_end_implicit_paint).</pre>
</div><div class="bz_comment" id="c11">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c11">Comment 11</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-07 22:57:49 UTC
        </span>
</div>
<pre class="bz_comment_text"><span class="quote">&gt; CreateWindow depth=0x18 window=0x02e00024 parent=0x0000013c x=0 y=0 width=1680 height=1050 border-width=0 class=InputOutput(0x0001) visual=0x00000021  value-list={background-pixel=0x00000000 border-pixel=0x00000000 bit-gravity=NorthWest(0x01) override-redirect=true(0x01) save-under=true(0x01) event-mask=KeyPress,KeyRelease,ButtonPress,ButtonRelease,EnterWindow,LeaveWindow,PointerMotion,Exposure,VisibilityChange,StructureNotify,FocusChange,PropertyChange colormap=0x02e00023}
&gt; ChangeProperty mode=Replace(0x00) window=0x02e00024 property=0x100("_NET_WM_NAME") type=0xf1("UTF8_STRING")     data=0x67,0x6e,0x6f,0x6d,0x65,0x2d,0x73,0x63,0x72,0x65,0x65,0x6e,0x73,0x61,0x76,0x65,0x72;
&gt; ChangeProperty mode=Replace(0x00) window=0x02e00024 property=0x27("WM_NAME") type=0x1f("STRING")    data='gnome-screensaver'</span>

So 0x02e00024 is the fullscreen screensaver window

[...]
<span class="quote">&gt; CreateWindow depth=0x18 window=0x05400020 parent=0x0000013c x=0 y=0 width=1 height=1 border-width=0 class=InputOutput(0x0001) visual=0x00000021  value-list={background-pixel=0x00000000 border-pixel=0x00000000 bit-gravity=NorthWest(0x01) event-mask=KeyPress,KeyRelease,ButtonPress,ButtonRelease,EnterWindow,LeaveWindow,PointerMotion,Exposure,VisibilityChange,StructureNotify,PropertyChange colormap=0x00000020}</span>
[...]
<span class="quote">&gt; ChangeProperty mode=Replace(0x00) window=0x05400020 property=0x27("WM_NAME") type=0x1f("STRING")    data='gnome-screensaver-dialog'</span>
And 0x05400020 is the lock dialog running in a subprocess.

[...]
<span class="quote">&gt; CreateWindow depth=0x18 window=0x02e00060 parent=0x02e00024 x=-1 y=-1 width=1 height=1 border-width=0 class=InputOutput(0x0001) visual=0x00000021  value-list={background-pixel=0x00e6ddd5 border-pixel=0x00000000 bit-gravity=NorthWest(0x01) event-mask=EnterWindow,LeaveWindow,Exposure,VisibilityChange,StructureNotify,FocusChange,PropertyChange colormap=0x02e00023}</span>
Here we create a child of the fullscreen screensaver window

[...]
<span class="quote">&gt; ReparentWindow window=0x05400020 parent=0x02e00060 x=0 y=0
&gt; InternAtom only-if-exists=false(0x00)  name='_XEMBED_INFO'</span>
And here we reparent the lock dialog from the subprocess into that child of the fullscreen window.
This means the child of the fullscreen screensaver window (0x02e00060) is a gtk socket.

So now we know who the players are:
0x02e00024 - fullscreen screensaver window
0x02e00060 - gtk socket in the parent
0x05400020 - lock dialog plug

[...]
<span class="quote">&gt; CreatePixmap depth=0x18 pid=0x02e000fb drawable=0x02e00024 width=1680 height=1050</span>
Here we create a backing pixmap 0x02e000fb for the fullscreen screensaver window

[...]
<span class="quote">&gt; PolyFillRectangle drawable=0x02e000fb gc=0x02e000fc rectangles={x=0 y=0 w=1680 h=1050};</span>
[...]
<span class="quote">&gt; PolyFillRectangle drawable=0x02e000fb gc=0x02e000fd rectangles={x=0 y=0 w=1680 h=1050};</span>
Here we fill the backing pixmap with data

[...]
<span class="quote">&gt; CopyArea src-drawable=0x02e000fb dst-drawable=0x02e00024 gc=0x02e00056 src-x=0 src-y=0 dst-x=0 dst-y=0 width=1680 height=1050</span>
[...]
<span class="quote">&gt; FreePixmap drawable=0x02e000fb</span>
Here we copy the data from the backing pixmap to the fullscreen screensaver window and then free
the backing pixmap, so this was just a bit of double buffered drawing.

[...]
<span class="quote">&gt; CreatePixmap depth=0x18 pid=0x02e0004e drawable=0x02e00024 width=1 height=1
&gt; CreateGC cid=0x02e0004f drawable=0x02e0004e  values={graphics-exposures=false(0x00)}
&gt; PolyPoint coordinate-mode=Origin(0x00) drawable=0x02e0004e gc=0x02e0004f points={x=0 y=0};</span>
Here we create a 1x1 solid tile pixmap that gets used later

[...]
<span class="quote">&gt; CreatePixmap depth=0x18 pid=0x02e000fe drawable=0x05400020 width=550 height=362</span>
Here we create (from the parent process) a backing pixmap 0x2e000fe for the
lock dialog plug (which is running in the child process)

<span class="quote">&gt; FreePixmap drawable=0x02e000fe</span>
Here we immediately free the backing pixmap.  Note we did no double buffered drawing,
at all.  This sort of makes sense.  The child is doing the drawing not us.  GTK+ probably
shouldn't have made the back pixmap in the first place, though.

[...]
<span class="quote">&gt; ChangeWindowAttributes window=0x02e00024  value-list={cursor=None(0x00000000)}
&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}</span>
Here we're messing around with the screensaver window again, not fooling with the lock dialog anymore
<span class="quote">&gt; UnmapWindow window=0x02e00060
&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}</span>
Here we unmap the socket.  We must have gotten a lock-plug-removed signal.
The handler for that does:

        gtk_widget_hide (widget);

which would ultimately cause an UnmapWindow.

<span class="quote">&gt; UnmapWindow window=0x02e00060
&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=None(0x00000000)}</span>
rinse and repeat? Huh?

<span class="quote">&gt; ShapeRectangles operation=Set(0x00) destination kind=Bounding(0x00) ordering=YXBanded(0x03) destination window=0x02e00060 x-offset=0 y-offset=0 rectangles=;</span>
Then we set the shape of the socket window to be empty (no rectangles in the list),
even though it's unmapped.  I think this means if it were mapped again it wouldn't show up
at all.  That's sort of strange, but it's probably some subtle toolkit magic to
prevent some misbehavior from happening or something.  Maybe it's a workaround for a
buggy window manager.  I'm not sure.  I dont' think it's related to our problem, though.

<span class="quote">&gt; ChangeWindowAttributes window=0x02e00024  value-list={background-pixmap=0x02e0004e}
&gt; DestroyWindow window=0x02e00060</span>
We now explicitly destroy the socket window.  That's probably from this line in the
lock-plugin-removed handler:

        gtk_container_remove (GTK_CONTAINER (window-&gt;priv-&gt;vbox),
                              GTK_WIDGET (window-&gt;priv-&gt;lock_box));

We remove the socket from the parent window, which drops the socket's ref count to 0, causing
the socket to get destroyed.

<span class="quote">&gt; CreatePixmap depth=0x18 pid=0x02e000ff drawable=0x02e00024 width=1680 height=1050</span>
[...]
<span class="quote">&gt; PolyFillRectangle drawable=0x02e000ff gc=0x02e00100 rectangles={x=0 y=0 w=1680 h=1050};</span>
[...]
<span class="quote">&gt; PolyFillRectangle drawable=0x02e000ff gc=0x02e00101 rectangles={x=0 y=0 w=1680 h=1050};</span>
[...]
<span class="quote">&gt; CopyArea src-drawable=0x02e000ff dst-drawable=0x02e00024 gc=0x02e00056 src-x=0 src-y=0 dst-x=0 dst-y=0 width=1680 height=1050
&gt; FreePixmap drawable=0x02e000ff</span>
We do another round of double-buffered drawing to the fullscreen screensaver window

At this point we must have gone back to the main loop because the next line says ...

<span class="quote">&gt; Error 9=Drawable: major=0, minor=53, bad=88080416</span>
Uh oh, X error.  88080416 is 0x5400020 in hex, that's our lock dialog plug
minor=53 is CreatePixmap

<span class="quote">&gt; Error 4=Pixmap: major=0, minor=54, bad=48234750</span>
Uh oh, another X error.  48234750 is 0x02e000fe in hex, thats the backing pixmap
for the lock dialog plug we created and free'd immediately afterward without doing anything
to it.

minor=54 is FreePixmap

So the FreePixmap request is failing because the CreatePixmap request failed initially.

Okay, so the problem is gtk is calling CreatePixmap and passing in a foreign drawable that
no longer exists.  Let's look at the code probably at fault:

static void
gdk_window_process_updates_internal (GdkWindow *window)
{
   ...
   end_implicit = gdk_window_begin_implicit_paint (window, &amp;clipbox) {
       ...
       paint-&gt;pixmap = gdk_pixmap_new (window, clipbox-&gt;width, clipbox-&gt;height, -1) {
           ...
           pixmap-&gt;xid = XCreatePixmap (display, window, clipbox-&gt;width, clipbox-&gt;height, -1);
           pixmap-&gt;is_foreign = FALSE;
           ...
           return pixmap;
       }
       ...
       return paint;
   }
   ...
   gdk_window_end_implicit_paint (window) {
       ...
       g_object_unref (paint-&gt;pixmap) {
           ...
           if (!pixmap-&gt;is_foreign) {
              XFreePixmap (display, pixmap-&gt;xid);
           }
           ...
       }
   }
   ...
}

So the socket's plug window must be getting added to the list of windows to process by
gdk_window_process_updates_internal.  I don't know if that's right or not.

If it is right, maybe it should have a if (FOREIGN) gdk_error_trap pop / push wrapping the function.

Or maybe this is just something we're supposed to deal with on the screensaver side.  Alex, do you have any insight here?</pre>
</div><div class="bz_comment" id="c12">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c12">Comment 12</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-08 13:48:20 UTC
        </span>
</div>
<pre class="bz_comment_text">I found alex, conversation below:

&lt;halfline&gt; alex: basically the screensaver has a lock dialog plug that fits into a socket in the fullscreen screensaver window
&lt;halfline&gt; alex: if the lock dialog process quits, the plug disappears           
&lt;halfline&gt; alex: if that happens under the right circumstances then gtk will generate an X error becuase it's trying to create a backing pixmap using the plug as a reference drawable
&lt;halfline&gt; alex: so i'm wondering 1) should gtk avoid using a foreign window as a reference drawable for the implicit paint pixmap ?
&lt;halfline&gt; 2) if not, should it add its own guards against that foreign window going away
&lt;halfline&gt; or                                                                
&lt;halfline&gt; should gnome-screensaver just deal                                
&lt;alex&gt; If the user specifies exposure events in the foreign window it'll get events and the will trigger the double buffering
&lt;alex&gt; gtk+ should handle this but i don't which of 1) or 2) is the best 
&lt;alex&gt; Technically i guess the child foreign window could have a different visual
&lt;alex&gt; which seems to imply that we want to do 2?
&lt;halfline&gt; sounds reasonable to me, but i'm probably not the best person to ask            
* alex is sort of busy right now so can't look into it in more detail at the moment                       
&lt;halfline&gt; okay, i'll paste this into the bug report
&lt;halfline&gt; what i really want to find out i guess is who is affected
&lt;halfline&gt; i'll dig a bit
&lt;alex&gt; how did it not happen before?
&lt;alex&gt; i guess the double buffering stuff changed
&lt;halfline&gt; everyone who's seen it has been running 2.18 afaict</pre>
</div><div class="bz_comment" id="c13">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c13">Comment 13</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Alexander Larsson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-08 14:53:21 UTC
        </span>
</div>
<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=149335" name="attach_149335" title="Possible gtk fix">attachment 149335</a> <a href="attachment.cgi?id=149335&amp;action=edit" title="Possible gtk fix">[details]</a></span> <a href="review?bug=598476&amp;attachment=149335">[review]</a>
Possible gtk fix

I think an easy solution might be to not do implicit painting for foreign windows, as its risky and is not useful.</pre>
</div><div class="bz_comment" id="c14">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c14">Comment 14</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Matthias Clasen</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2009-12-08 14:54:45 UTC
        </span>
</div>
<pre class="bz_comment_text">Looks like a good idea to me.</pre>
</div><div class="bz_comment" id="c15">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c15">Comment 15</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Michal Hruby</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2010-01-25 19:38:49 UTC
        </span>
</div>
<pre class="bz_comment_text">Shouldn't someone with the appropriate privileges change "Product" to gtk+?</pre>
</div><div class="bz_comment" id="c16">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c16">Comment 16</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Matthias Clasen</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2010-01-25 20:24:06 UTC
        </span>
</div>
<pre class="bz_comment_text">Comment on <span class=""><a href="attachment.cgi?id=149335" name="attach_149335" title="Possible gtk fix">attachment 149335</a> <a href="attachment.cgi?id=149335&amp;action=edit" title="Possible gtk fix">[details]</a></span> <a href="review?bug=598476&amp;attachment=149335">[review]</a>
Possible gtk fix

This has been committed a while ago</pre>
</div><div class="bz_comment" id="c17">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c17">Comment 17</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Chris Coulson</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2010-02-05 10:20:11 UTC
        </span>
</div>
<pre class="bz_comment_text">I dropped the Ubuntu patch for gnome-screensaver some time ago, and we have the GTK version with the above commit in. I don't see this crash any more (and I've not seen anybody report the issue again), so I'm closing this as fixed now. Thanks!</pre>
</div><div class="bz_comment" id="c18">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c18">Comment 18</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Michal Hruby</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2010-02-05 14:25:35 UTC
        </span>
</div>
<pre class="bz_comment_text">*** <a class="bz_bug_link bz_status_RESOLVED bz_closed" href="show_bug.cgi?id=603652" title="RESOLVED DUPLICATE - Sporadic crashes with GtkSocket">Bug 603652</a> has been marked as a duplicate of this bug. ***</pre>
</div><div class="bz_comment" id="c19">
<div class="bz_comment_head">
<span class="bz_comment_number">
<a href="show_bug.cgi?id=598476#c19">Comment 19</a>
</span>
<span class="bz_comment_user">
<span class="vcard"><span class="fn">Ray Strode [halfline]</span>
</span>
</span>
<span class="bz_comment_user_images">
</span>
<span class="bz_comment_time">
          2010-02-05 18:18:26 UTC
        </span>
</div>
<pre class="bz_comment_text">Comment on <span class=""><a href="attachment.cgi?id=146788" name="attach_146788" title="gs_dont_crash_on_invalid_password.patch">attachment 146788</a> <a href="attachment.cgi?id=146788&amp;action=edit" title="gs_dont_crash_on_invalid_password.patch">[details]</a></span> <a href="review?bug=598476&amp;attachment=146788">[review]</a>
gs_dont_crash_on_invalid_password.patch

FWIW, mccann commited your patch about a week ago:

<a href="http://git.gnome.org/browse/gnome-screensaver/commit/?id=ab08cc93f2dc6223c8c00bfa1ca4f2d89069dbe0">http://git.gnome.org/browse/gnome-screensaver/commit/?id=ab08cc93f2dc6223c8c00bfa1ca4f2d89069dbe0</a></pre>
</div>
<script type="text/javascript">
  function traceparser_toggle_trace(link, trace_id) {
    var trace = document.getElementById('trace_' + trace_id);
    bz_toggleClass(trace, 'bz_default_hidden');
    if (link.innerHTML == '+') { link.innerHTML = '&mdash;'; }
    else { link.innerHTML = '+'; }
  }
</script>
</td>
<td>
</td>
</tr></table>
</div>
<hr/>
</form>
<hr/>

<br/>
</div>
<div id="footer">
<div class="intro"></div>
<ul id="useful-links">
<li id="links-actions"><ul class="links">
<li><a href="./">Home</a></li>
<li><span class="separator">| </span><span style="text-decoration:line-through"><a href="">New</a></span></li>
<li><span class="separator">| </span><a href="page.cgi?id=browse.html&amp;product=gtk%2B">Browse</a></li>
<li><span class="separator">| </span><a href="query.cgi">Search</a></li>
<li class="form">
<span class="separator">| </span>
<form action="buglist.cgi" method="get" onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
<input id="no_redirect_bottom" name="no_redirect" type="hidden" value="0"/>
<script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
<input class="txt" id="quicksearch_bottom" name="quicksearch" title="Quick Search" type="text" value=""/>
<input class="btn" id="find_bottom" type="submit" value="Search"/></form>
<a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>
<li><span class="separator">| </span><a href="page.cgi?id=reports.html">Reports</a></li>
<li>
<span class="separator">| </span>
<a href="http://www.bugzilla.org/docs/4.4/en/html/bug_page.html" target="_blank">Help</a>
</li>
<li id="mini_login_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=598476&amp;GoAheadAndLogIn=1" id="login_link_bottom" onclick="return show_mini_login_form('_bottom')">Log In</a>
<form action="show_bug.cgi?id=598476" class="mini_login bz_default_hidden" id="mini_login_bottom" method="POST" onsubmit="return check_mini_login_fields( '_bottom' );">
<input class="bz_login" id="Bugzilla_login_bottom" name="Bugzilla_login" onfocus="mini_login_on_focus('_bottom')" title="Login"/>
<input class="bz_password" id="Bugzilla_password_bottom" name="Bugzilla_password" title="Password" type="password"/>
<input class="bz_password bz_default_hidden bz_mini_login_help" id="Bugzilla_password_dummy_bottom" onfocus="mini_login_on_focus('_bottom')" title="Password" type="text" value="password"/>
<input checked="" class="bz_remember" id="Bugzilla_remember_bottom" name="Bugzilla_remember" type="checkbox" value="on"/>
<label for="Bugzilla_remember_bottom">Remember</label>
<input name="Bugzilla_login_token" type="hidden" value=""/>
<input id="log_in_bottom" name="GoAheadAndLogIn" type="submit" value="Log in"/>
<script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
<a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
</form>
</li>
<li id="forgot_container_bottom">
<span class="separator">| </span>
<a href="show_bug.cgi?id=598476&amp;GoAheadAndLogIn=1#forgot" id="forgot_link_bottom" onclick="return show_forgot_form('_bottom')">Forgot Password</a>
<form action="token.cgi" class="mini_forgot bz_default_hidden" id="forgot_form_bottom" method="post">
<label for="login_bottom">Login:</label>
<input id="login_bottom" name="loginname" size="20" type="text"/>
<input id="forgot_button_bottom" type="submit" value="Reset Password"/>
<input name="a" type="hidden" value="reqpw"/>
<input id="token_bottom" name="token" type="hidden" value="1626080128-vQtiWHN6vOl9bZ6jj7jB8_T9qa9fCMxvXyrmvWe9Mwc"/>
<a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
</form>
</li>
</ul>
</li>
</ul>
<div class="outro"></div>
</div>
</body>
</html>