<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #72696 - RDF' href='rss/bug.php?id=72696'>
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #72696 - RSS 2.0' href='rss/bug.php?id=72696&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #72696 :: imagefilltoborder stackoverflow on truecolor images</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=72696">Sec Bug</a>&nbsp;#72696</th>
            <td id="summary" colspan="5">imagefilltoborder stackoverflow on truecolor images</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-07-28 06:11 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-12-13 11:50 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=cmb">cmb</a> (<a href="https://people.php.net/cmb">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=GD+related">GD related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.27</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-9933" target="_blank">2016-9933</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=72696&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=72696&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=72696&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1469686280">&nbsp;</a><strong>[2016-07-28 06:11 UTC] fernando &#x61;&#116; null-life &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Description:
------------
Invalid color causes stack exhaustion by recursive call to function gdImageFillToBorder when the image used is truecolor. This was tested on a 64 bits platform.

This is not the same as <a href='bug.php?id=72350'>bug #72350</a> but they are related.


GDB output
----------

gdb -q --args /home/operac/php-70-sinasan/sapi/cli/php -n poc.php
Reading symbols from /home/operac/php-70-sinasan/sapi/cli/php...done.
(gdb) b gd.c:1851
Breakpoint 1 at 0x54a354: gd.c:1851. (2 locations)
(gdb) b gd.c:1834
Breakpoint 2 at 0x54a287: gd.c:1834. (2 locations)
(gdb) r
Starting program: /home/operac/php-70-sinasan/sapi/cli/php -n poc.php


Breakpoint 1, php_gd_gdImageFillToBorder (im=0x7ffff2c77000, x=0, y=0, border=1, color=-2) at /home/operac/php-70-sinasan/ext/gd/libgd/gd.c:1851
1851                                            gdImageFillToBorder(im, i, y + 1, border, color);
(gdb) c
Continuing.

Breakpoint 2, php_gd_gdImageFillToBorder (im=0x7ffff2c77000, x=0, y=1, border=1, color=-2) at /home/operac/php-70-sinasan/ext/gd/libgd/gd.c:1834
1834                                            gdImageFillToBorder(im, i, y - 1, border, color);
(gdb) c
Continuing.

Breakpoint 1, php_gd_gdImageFillToBorder (im=0x7ffff2c77000, x=0, y=0, border=1, color=-2) at /home/operac/php-70-sinasan/ext/gd/libgd/gd.c:1851
1851                                            gdImageFillToBorder(im, i, y + 1, border, color);
(gdb) c
Continuing.

Breakpoint 2, php_gd_gdImageFillToBorder (im=0x7ffff2c77000, x=0, y=1, border=1, color=-2) at /home/operac/php-70-sinasan/ext/gd/libgd/gd.c:1834
1834                                            gdImageFillToBorder(im, i, y - 1, border, color);
(gdb) p/x color
$1 = 0xfffffffe

Test script:
---------------
&lt;?php

$imgs = imagecreatetruecolor(10, 10);
imagefilltoborder($imgs, 0, 0, 1, 9223372036854775806);

Expected result:
----------------
No crash

Actual result:
--------------
operac@hp2:~/crashes/067b65f5-filltoborder$ sh run.sh 

ASAN:SIGSEGV
=================================================================
==5658==ERROR: AddressSanitizer: stack-overflow on address 0x7ffd7b0bdf98 (pc 0x000000991208 bp 0x7ffd7b0be0e0 sp 0x7ffd7b0bdf98 T0)
    #0 0x991207 in php_gd_gdImageSetPixel /home/operac/php-70/ext/gd/libgd/gd.c:728
    #1 0x99cb00 in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1810
    #2 0x99d752 in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1834
    #3 0x99dbfa in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1851
    #4 0x99d752 in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1834
    #5 0x99dbfa in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1851
    #6 0x99d752 in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1834
    #7 0x99dbfa in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1851
    #8 0x99d752 in php_gd_gdImageFillToBorder /home/operac/php-70/ext/gd/libgd/gd.c:1834


</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=72696&amp;patch=fix-72696&amp;revision=latest" >fix-72696</a>
(last revision 2016-10-25 11:26 UTC by cmb@php.net)
<br><p><a href='patch-add.php?bug_id=72696'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=72696'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1470811556">&nbsp;</a><strong>[2016-08-10 06:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: pajoye</span>
</div></div></div><div class='comment type_comment' ><a name="1470811556">&nbsp;</a><strong>[2016-08-10 06:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Looks like bug in libgd, negative colors are not set but border fill relies on them to be set. Pierre, could you please take a look?
</pre>
</div><div class='comment type_log' ><a name="1471241010">&nbsp;</a><strong>[2016-08-15 06:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_log' ><a name="1477359674">&nbsp;</a><strong>[2016-10-25 01:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To: pajoye</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_patch' ><a name="1477394769">&nbsp;</a><strong>[2016-10-25 11:26 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: fix-72696
Revision:   1477394767
URL:        <a href="https://bugs.php.net/patch-display.php?bug=72696&amp;patch=fix-72696&amp;revision=1477394767" rel="nofollow">https://bugs.php.net/patch-display.php?bug=72696&amp;patch=fix-72696&amp;revision=1477394767</a>
</pre>
</div><div class='comment type_comment' ><a name="1477394819">&nbsp;</a><strong>[2016-10-25 11:26 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, filling with negative color values will not necessarily
work. For example, color -2 means gdStyled, and if no style is
set, no pixel will be drawn[1]. However, even if a style has been
set, the color that will be drawn is not necessarily the color
that gdImageFillToBorder() expects to be drawn.

Anyhow, this issue has already been fixed in libgd 2.2.3[2], where
it doesn't have been recognized as security issue, so I'm not sure
whether it should be regarded as security issue for PHP, or rather
as a programmer error.

Either way, the attached patch solves the issue and should be
applied against PHP 5.6+.

[1] &lt;<a href="https://github.com/php/php-src/blob/PHP-7.0.12/ext/gd/libgd/gd.c#L729-L732" rel="nofollow">https://github.com/php/php-src/blob/PHP-7.0.12/ext/gd/libgd/gd.c#L729-L732</a>&gt;
[2] &lt;<a href="https://github.com/libgd/libgd/commit/77f619d48259383628c3ec4654b1ad578e9eb40e" rel="nofollow">https://github.com/libgd/libgd/commit/77f619d48259383628c3ec4654b1ad578e9eb40e</a>&gt;
</pre>
</div><div class='comment type_log' ><a name="1477863135">&nbsp;</a><strong>[2016-10-30 21:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.0.9</span>
<span class="added">+PHP Version: 5.6.27</span>
</div></div></div><div class='comment type_comment' ><a name="1477863136">&nbsp;</a><strong>[2016-10-30 21:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as 863d37ea66d5c960db08d6f4a2cbd2518f0f80d1 and in <a href="https://gist.github.com/a3b8821719ca7d6e5386d735f4635cf1" rel="nofollow">https://gist.github.com/a3b8821719ca7d6e5386d735f4635cf1</a>

please verify
</pre>
</div><div class='comment type_comment' ><a name="1481545958">&nbsp;</a><strong>[2016-12-12 12:32 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>Fixed upstream in libgd 2.2.2, see <a href="https://libgd.github.io/release-2.2.2.html" rel="nofollow">https://libgd.github.io/release-2.2.2.html</a>
</pre>
</div><div class='comment type_log' ><a name="1481546163">&nbsp;</a><strong>[2016-12-12 12:36 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_log' ><a name="1481546927">&nbsp;</a><strong>[2016-12-12 12:48 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Closed</span>
<span class="added">+Status: Re-Opened</span>
</div></div></div><div class='comment type_comment' ><a name="1481546927">&nbsp;</a><strong>[2016-12-12 12:48 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>&gt; Fixed upstream in libgd 2.2.2, see <a href="https://libgd.github.io/release-2.2.2.html" rel="nofollow">https://libgd.github.io/release-2.2.2.html</a>

That is a closely related issue, but not the same as this ticket is about. CVE-2015-8874 has been reported for libgd[1] and PHP[2] and is resolved.

The fix for this issue has been released with libgd 2.2.3[3] (without CVE), but apparently it is not yet fixed in PHP's bundled libgd.

[1] &lt;<a href="https://github.com/libgd/libgd/issues/213" rel="nofollow">https://github.com/libgd/libgd/issues/213</a>&gt;
[2] &lt;<a href="https://bugs.php.net/bug.php?id=72350" rel="nofollow">https://bugs.php.net/bug.php?id=72350</a>&gt;
[3] &lt;<a href="https://github.com/libgd/libgd/commit/77f619d48259383628c3ec4654b1ad578e9eb40e" rel="nofollow">https://github.com/libgd/libgd/commit/77f619d48259383628c3ec4654b1ad578e9eb40e</a>&gt;
</pre>
</div><div class='comment type_comment' ><a name="1481550182">&nbsp;</a><strong>[2016-12-12 13:43 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>The patch you've mentioned as not applied in PHP is already done for PHP 5.6.28 at <a href="https://github.com/php/php-src/commit/863d37ea66d5c960db08d6f4a2cbd2518f0f80d1" rel="nofollow">https://github.com/php/php-src/commit/863d37ea66d5c960db08d6f4a2cbd2518f0f80d1</a> (with an older part applied in <a href="https://github.com/php/php-src/commit/6d3fa654b702c8762aa80ab795080f5c4464d677" rel="nofollow">https://github.com/php/php-src/commit/6d3fa654b702c8762aa80ab795080f5c4464d677</a> earlier this year).
</pre>
</div><div class='comment type_log' ><a name="1481550547">&nbsp;</a><strong>[2016-12-12 13:49 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Re-Opened</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1481550547">&nbsp;</a><strong>[2016-12-12 13:49 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, you're right. Thanks!
</pre>
</div><div class='comment type_log' ><a name="1481629803">&nbsp;</a><strong>[2016-12-13 11:50 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-9933</span>
</div></div></div><div class='comment type_comment' ><a name="1481629855">&nbsp;</a><strong>[2016-12-13 11:50 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>Use CVE-2016-9933. The scope of this CVE is only the missing &quot;color &lt; 0&quot; test in older versions.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
