<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='MySQL related Bug #47802 - RDF' href='rss/bug.php?id=47802'>
        <link rel='alternate' type='application/rss+xml' title='MySQL related Bug #47802 - RSS 2.0' href='rss/bug.php?id=47802&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #47802 :: PDO_MYSQL doesn't use the charset parameter</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=47802">Bug</a>&nbsp;#47802</th>
            <td id="summary" colspan="5">PDO_MYSQL doesn't use the charset parameter</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2009-03-27 08:53 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2012-03-06 01:44 UTC</td>
            <td rowspan="6">

                <table id="votes">
                    <tr><th class="details">Votes:</th><td>1</td></tr>
                    <tr><th class="details">Avg. Score:</th><td>3.0 &plusmn; 0.0</td></tr>
                    <tr><th class="details">Reproduced:</th><td>0 of 1 (0.0%)</td></tr>
                </table>

            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>disbursement &#x61;&#116; dublin &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=mysql">mysql</a> (<a href="https://people.php.net/mysql">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=MySQL+related">MySQL related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.2.9</td>
            <th class="details">OS:</th>
            <td>all</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=47802&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=47802&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=47802&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1238144038">&nbsp;</a><strong>[2009-03-27 08:53 UTC] disbursement &#x61;&#116; dublin &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
	static int pdo_mysql_handle_factory(pdo_dbh_t *dbh, zval *driver_options TSRMLS_DC) /* {{{ */
{
...
	struct pdo_data_src_parser vars[] = {
		{ &quot;charset&quot;,  NULL,	0 },
		{ &quot;dbname&quot;,   &quot;&quot;,	0 },
		{ &quot;host&quot;,   &quot;localhost&quot;,	0 },
		{ &quot;port&quot;,   &quot;3306&quot;,	0 },
		{ &quot;unix_socket&quot;,  PDO_MYSQL_UNIX_ADDR,	0 },
	};

The option &quot;charset&quot;/vars[0] is never used, but would be a nice feature.


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=47802'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=47802'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1293935809">&nbsp;</a><strong>[2011-01-02 02:36 UTC] <a href="//people.php.net/jani">jani@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Package: Feature/Change Request</span>
<span class="added">+Package: MySQL related</span>
</div></div></div><div class='comment type_svn' ><a name="1294414798">&nbsp;</a><strong>[2011-01-07 15:39 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of kalle
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307224" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307224</a>
Log: Implemented FR #47802, support for character sets in DSN strings for PDO_MYSQL
</pre>
</div><div class='comment type_log' ><a name="1294414832">&nbsp;</a><strong>[2011-01-07 15:40 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Assigned</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: kalle</span>
</div></div></div><div class='comment type_comment' ><a name="1294414832">&nbsp;</a><strong>[2011-01-07 15:40 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Implemented in trunk for now
</pre>
</div><div class='comment type_svn' ><a name="1294424311">&nbsp;</a><strong>[2011-01-07 18:18 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of kalle
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307228" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307228</a>
Log: Added test case for #47802 and fixed macro name after the move to mysql_options()
</pre>
</div><div class='comment type_svn' ><a name="1295261663">&nbsp;</a><strong>[2011-01-17 10:54 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Automatic comment from SVN on behalf of kalle
Revision: <a href="http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307529" rel="nofollow">http://svn.php.net/viewvc/?view=revision&amp;amp;revision=307529</a>
Log: MFT: Implemented FR #47802 (Support for setting character sets in DSN strings)
</pre>
</div><div class='comment type_log' ><a name="1295264760">&nbsp;</a><strong>[2011-01-17 11:46 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1295264760">&nbsp;</a><strong>[2011-01-17 11:46 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<pre class='note'>Will appear in PHP 5.3.6 :)
</pre>
</div><div class='comment type_comment' ><a name="1303166043">&nbsp;</a><strong>[2011-04-18 22:34 UTC] ircmaxell &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Re-opening this as it has security implications for 5.2.x.  It should be 
backported and re-released as a security fix for 5.2.x.

As it stands now, PDO::quote() does not protect against security vulnerabilities 
without the ability to set the character set in the C api.  5.3.6 closes this 
hole when supplied with the optional charset parameter (by appropriately setting 
the character set).  However this will need to be expressed in the documentation 
(I will file another issue on this topic).

Proof Of Concept Code:

$dsn = 'mysql:dbname=INFORMATION_SCHEMA;host=127.0.0.1;charset=GBK';
$pdo = new PDO($dsn, $user, $pass);
$pdo-&gt;exec('SET NAMES GBK');
$string = chr(0xbf) . chr(0x27) . ' OR 1 = 1; /*';
$sql = &quot;SELECT TABLE_NAME 
            FROM INFORMATION_SCHEMA.TABLES 
            WHERE TABLE_NAME LIKE &quot;.$pdo-&gt;quote($string).&quot;;&quot;;
$stmt = $pdo-&gt;query($sql);
var_dump($stmt-&gt;rowCount());

Expected: int(0)
Actual: the number of tables on the server
</pre>
</div><div class='comment type_log' ><a name="1303166328">&nbsp;</a><strong>[2011-04-18 22:38 UTC] <a href="//people.php.net/colder">colder@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Closed</span>
<span class="added">+Status: Re-Opened</span>
</div></div></div><div class='comment type_comment' ><a name="1303166328">&nbsp;</a><strong>[2011-04-18 22:38 UTC] <a href="//people.php.net/colder">colder@php.net</a></strong>
<pre class='note'>Re-opening because of 5_2 backport request by some user.
</pre>
</div><div class='comment type_log' ><a name="1303175240">&nbsp;</a><strong>[2011-04-19 01:07 UTC] <a href="//people.php.net/johannes">johannes@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Re-Opened</span>
<span class="added">+Status:      To be documented</span>
<span class="removed">-Assigned To: kalle</span>
<span class="added">+Assigned To:</span>
</div></div></div><div class='comment type_comment' ><a name="1303175240">&nbsp;</a><strong>[2011-04-19 01:07 UTC] <a href="//people.php.net/johannes">johannes@php.net</a></strong>
<pre class='note'>If a developer shots himself it is noting we can prevent. Tis does not justify a security release of PHP as the only one who can exploit this is the one writing code ...

This should however be made clear in the documentation: Executing SET NAMES doesn't tell anything to the client library (libmysql / mysqlnd used by PHP) so they can't do proper encoding. Therefore only Latin 1, Utf-8 and other encodings using lower 7 bits in an ASCII compatible way can be used safely. For other encodings the mentioned option, introduced later in 5.3.6 should be used.
</pre>
</div><div class='comment type_comment' ><a name="1303178305">&nbsp;</a><strong>[2011-04-19 01:58 UTC] ircmaxell &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>I won't argue the decision, but I'd like to clarify one point.  Right now, in 
5.2.x (and &lt;=5.3.5) it's impossible to write a secure query using PDO::quote.  So 
if you use another character set, it would automatically make all code vulnerable 
to SQL Injection (with no built-in method to fix it).  So that leaves existing 
the code 3 options: Switch to MySQLi, Implement their own quoting mechanism, or 
switch to prepared statements (the best solution).  But as it stands, the API 
does not deliver its promise. 

Just an observation...
</pre>
</div><div class='comment type_comment' ><a name="1303213115">&nbsp;</a><strong>[2011-04-19 11:38 UTC] <a href="//people.php.net/johannes">johannes@php.net</a></strong>
<pre class='note'>You can write secure code - if you are using a supported encoding (iso-8859-1/latin1, utf-8, ...)
</pre>
</div><div class='comment type_log' ><a name="1330998287">&nbsp;</a><strong>[2012-03-06 01:44 UTC] <a href="//people.php.net/johannes">johannes@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: mysql</span>
</div></div></div><div class='comment type_comment' ><a name="1330998287">&nbsp;</a><strong>[2012-03-06 01:44 UTC] <a href="//people.php.net/johannes">johannes@php.net</a></strong>
<pre class='note'>Thank you for your bug report. This issue has already been fixed
in the latest released version of PHP, which you can download at 
<a href="http://www.php.net/downloads.php" rel="nofollow">http://www.php.net/downloads.php</a>


</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
