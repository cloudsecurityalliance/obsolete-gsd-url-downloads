<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- social + seo -->
    <title>Local secret is more secure in Convos 4.20 - Convos</title>
    <meta content="Convos 4.20 has an important update - especially if you are running Convos in Docker." name="description">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@convosby">
    <meta property="og:type" content="object">
    <meta content="Convos" property="og:site_name">
    <meta content="https://convos.chat/" property="og:url">
    <meta content="Convos 4.20 has an important update - especially if you are running Convos in Docker." name="twitter:description" property="og:description">
    <meta content="https://convos.chat/images/2020-05-28-convos-chat.jpg" name="twitter:image:src" property="og:image">
    <meta content="Local secret is more secure in Convos 4.20" name="twitter:title" property="og:title">
    

    <!-- pwa -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="/cdn-cgi/apps/head/S6tvTRm_niU4-JjGuxofpPgdYdc.js"></script><link rel="apple-touch-icon" sizes="57x57" href="/asset/apple-touch-icon-57x57.e024a83e.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/asset/apple-touch-icon-60x60.51c5a95b.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/asset/apple-touch-icon-72x72.231a66c9.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/asset/apple-touch-icon-76x76.5e14b7a1.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/asset/apple-touch-icon-114x114.913c43db.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/asset/apple-touch-icon-120x120.52c691a9.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/asset/apple-touch-icon-144x144.eb857b3e.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/asset/apple-touch-icon-152x152.be6c9e4f.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/asset/apple-touch-icon-180x180.c1fe73dd.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/asset/favicon-32x32.2447df68.png">
    <link rel="icon" type="image/png" sizes="194x194" href="/asset/favicon-194x194.77dd0ed4.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/asset/android-chrome-192x192.02ee7244.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/asset/favicon-16x16.9e1affe1.png">
    <link rel="manifest" href="/asset/site.e3ea726b.webmanifest">
    <link rel="mask-icon" href="/asset/safari-pinned-tab.cb98a0d7.svg" color="#00451D">
    <meta name="msapplication-TileImage" content="/asset/mstile-144x144.a653fdfa.png">
    <meta name="msapplication-config" content="/asset/browserconfig.f80fd3df.xml">
    <meta name="msapplication-TileColor" content="#00451D">
    <meta name="theme-color" content="#00451D">

    <!-- convos settings -->
    <meta content="Convos" name="contactorganization">
    <meta content="https://convos.chat" name="contactnetworkaddress">
    <meta content="https://convos.chat/" name="convos:base_url">
    <meta content="bWFpbHRvOmpodGhvcnNlbkBjcGFuLm9yZw==" name="convos:contact">
    <meta content="no" name="convos:existing_user">
    <meta content="no" name="convos:first_user">
    <meta content="yes" name="convos:open_to_public">
    <meta content="" name="convos:start_app">
    <meta content="200" name="convos:status">
    <meta content="6.25" name="version">

    <!-- base style + themes -->
    <noscript><style>.has-js { display: none; }</style></noscript>
    <link href="/asset/convos.60f3803d.css" rel="stylesheet">
    <link href="/themes/convos_color-scheme-light.css?v=6.25" id="theme_primary" rel="stylesheet" title="Convos (light)" type="text/css">
    <link href="/themes/convos_color-scheme-dark.css?v=6.25" id="theme_alt__dark-convos" rel="alternate stylesheet" title="Convos (dark)" type="text/css">
    <link href="/themes/convos_color-scheme-light.css?v=6.25" id="theme_alt__light-convos" rel="alternate stylesheet" title="Convos (light)" type="text/css">
    <link href="/themes/desert.css?v=6.25" id="theme_alt__normal-desert" rel="alternate stylesheet" title="Desert" type="text/css">
    <link href="/themes/dracula.css?v=6.25" id="theme_alt__dark-dracula" rel="alternate stylesheet" title="Dracula (dark)" type="text/css">
    <link href="/themes/gnome_color-scheme-dark.css?v=6.25" id="theme_alt__dark-gnome" rel="alternate stylesheet" title="GNOME (dark)" type="text/css">
    <link href="/themes/hacker.css?v=6.25" id="theme_alt__normal-hacker" rel="alternate stylesheet" title="Hacker" type="text/css">
    <link href="/themes/high-contrast_color-scheme-dark.css?v=6.25" id="theme_alt__dark-high-contrast" rel="alternate stylesheet" title="High-contrast (dark)" type="text/css">
    <link href="/themes/high-contrast_color-scheme-light.css?v=6.25" id="theme_alt__light-high-contrast" rel="alternate stylesheet" title="High-contrast (light)" type="text/css">
    <link href="/themes/nord_color-scheme-dark.css?v=6.25" id="theme_alt__dark-nord" rel="alternate stylesheet" title="Nord (dark)" type="text/css">
    <link href="/themes/nord_color-scheme-light.css?v=6.25" id="theme_alt__light-nord" rel="alternate stylesheet" title="Nord (light)" type="text/css">
    <link href="/themes/south.css?v=6.25" id="theme_alt__normal-south" rel="alternate stylesheet" title="South" type="text/css">
    
  </head>

  <body class="no-js no-notify no-mouse no-touch for-cms">

<div class="cms-navbar--wrapper">
  <nav class="cms-navbar">
    <a class="cms-navbar__brand" href="/">
      <img alt="" class="cms-navbar__logo" src="/images/convos-light.png">
</a>
    <input type="checkbox" id="hamburger_checkbox_toggle" autocomplete="off" class="non-interactive">
    <label for="hamburger_checkbox_toggle" class="btn-hallow is-hamburger">
      <i class="fas fa-bars"></i>
      <i class="fas fa-times"></i>
      <span>Menu</span>
    </label>

    <div class="cms-navbar__links">
      <a href="/" class="is-primary-menu-item"><img alt="" src="/images/convos-icon-light.png">About</a>
      <a href="/doc/start"><i class="fas fa-running visible-sm"></i>Get started</a>
      <a href="/doc/"><i class="fas fa-book visible-sm"></i>Documentation</a>
      <a href="/blog"><i class="fas fa-glasses visible-sm"></i>Blog</a>
      <a href="https://github.com/convos-chat/convos/" class="pull-right"><i class="fab fa-github"></i><span class="visible-sm">Github</span></a>
      <a href="https://twitter.com/convosby/"><i class="fab fa-twitter"></i><span class="visible-sm">Twitter</span></a>
      <a href="https://www.google.com/search?q=site%3Aconvos.chat"><i class="fas fa-search"></i><span class="visible-sm">Search...</span></a>
    </div>
  </nav>
</div>



<article class="cms-main">
  <h1 class="cms-header">Local secret is more secure in Convos 4.20</h1>
  <div class="cms-meta">
    <span class="cms-meta__author">Posted by Jan Henning Thorsen</span>
    on
    <a class="cms-meta__date" href="/blog/2020/6/18/local-secret-got-more-secure">18. Jun, 2020</a>.
  </div>
  
  <p>Convos 4.20 has an important update - especially if you are running Convos in
Docker.</p>

<h2 id="secrets-in-convos">Secrets in Convos</h2>

<p>There are two secrets that is very important for the overall security of
Convos: <code>CONVOS_LOCAL_SECRET</code> and <code>CONVOS_SECRETS</code>.</p>

<ul>
<li><code>CONVOS_SECRETS</code> is used to check that the <a href="/doc/Mojolicious#secrets">session cookie</a>
is not altered on the client side. If this value is known to the public then a
hacker can change the session cookie and log in as any existing user.</li>
<li><code>CONVOS_LOCAL_SECRET</code> on the other hand is used by admins who generates either
a reset password link or an invite link.</li>
</ul>

<p>The initial value of these to secrets can be set in environment variables, but
after Convos has been started the first time they will be saved and read from
<code>$CONVOS_HOME/settings.json</code>.</p>

<h2 id="what-has-been-changed">What has been changed?</h2>

<p>The <code>CONVOS_SECRETS</code> setting was relatively safe before v4.20, since it used a
pseudo random number and a floating point timestamp. <code>CONVOS_LOCAL_SECRET</code> on
the other hand can be guessed by hacker, especially if you were running Convos
inside <a href="https://www.docker.com/">Docker</a>.</p>

<p>This security issue has now been patched in
<a href="https://github.com/convos-chat/convos/commit/54d1763ac65c05aad27ad454b4e5a62ba8352d39#diff-ea66a76f841b0b3c8843d07100b36304R134-R144">54d1763ac</a>.</p>

<p>The new way to calculate secrets is either...</p>

<ol start="1">
<li>Read some random bytes from <code>/dev/urandom</code>, if that device is available.</li>
<li>Fall back on using a pseudo random number and a floating point timestamp
for both <code>CONVOS_LOCAL_SECRET</code> and <code>CONVOS_SECRETS</code>.</li>
</ol>

<h2 id="what-should-you-do">What should you do?</h2>

<p>Either if you are running inside Docker or not, then we urge you to restart
Convos with a new secret right away. You can do so by following these steps:</p>

<ol start="1">
<li>Stop Convos</li>
<li><p>Generate new secrets either from
<a href="https://onlinehashtools.com/generate-random-sha1-hash">this website</a>
or even better with a command like this:</p>

<pre># Run this command twice
echo &quot;$(&lt; /dev/urandom tr -dc A-Za-z0-9 | head -c 40)&quot;</pre></li>
<li><p>Edit <code>$CONVOS_HOME/settings.json</code> and replace the existing value for
<code>local_secret</code> and <code>session_secrets</code>.</p></li>
<li>Start a fresh Convos that is more secure than before!</li>
</ol>

<p>Here is a sample <code>settings.json</code> file:</p>

<pre>{
  &quot;contact&quot;: &quot;&quot;,
  &quot;default_connection&quot;: &quot;&quot;,
  &quot;forced_connection&quot;: false,
  &quot;open_to_public&quot;: false,
  &quot;organization_name&quot;: &quot;&quot;,
  &quot;organization_url&quot;: &quot;&quot;,
  &quot;local_secret&quot;: &quot;710da2cf2fd8e3cf0f65f405293858e607d70bc7&quot;,
  &quot;session_secrets&quot;: [&quot;9563bcbd5853f7871f1f2585317aa9c573f7d9a6&quot;]
}</pre>

<h2 id="what-if-you-do-not-know-how-to-edit-settingsjson">What if you do not know how to edit settings.json?</h2>

<p>If you do not know how to change the values of the settings file, then simply
stop Convos, delete
<a href="/doc/faq#where-does-convos-store-logs-settings-and-uploaded-files"><code>$CONVOS_HOME/settings.json</code></a>
and start Convos again. You have to manually go to &quot;Settings&quot; in Convos to
restore your application settings, but that is a small price to pay.</p>

<h2 id="how-can-i-tell-if-my-system-has-been-exploited">How can I tell if my system has been exploited?</h2>

<p>If you do not have unexpected users <code>$CONVOS_HOME</code>, then your system has not
been exploited.</p>

<h2 id="for-the-future">For the future</h2>

<p>You might want to rotate your secrets from time to time. This means that you
follow the steps <a href="#what-should-you-do">above</a> every now and then to make sure
your secrets are indeed private to Convos.</p>

<h2 id="special-thanks">Special thanks</h2>

<p>Special thanks to <a href="https://github.com/stigtsp">Stig P</a> for pointing out how bad the
&quot;local_secret&quot; generator was inside Docker.</p>

</article>


<div class="footer--wrapper">
  <footer class="footer">
    <nav>
      <a href="https://convos.chat"><img alt="Convos" src="/images/convos-light.png"></a>
      <a href="https://convos.chat/blog"></i>Blog</a>
      <a href="https://github.com/convos-chat/convos/"><i class="fab fa-github"></i></a>
      <a href="https://twitter.com/convosby/"><i class="fab fa-twitter"></i></a>
    </nav>
    <p>
      Copyright (C) 2012-2021, <a href="https://github.com/convos-chat">Convos</a>.
    </p>
    <p>
      This program is free software, you can redistribute it and/or modify it under
      the terms of the Artistic License version 2.0.
    </p>
  </footer>
</div>


    <script src="/asset/convos.60f3803d.js"></script>
  </body>
</html>
