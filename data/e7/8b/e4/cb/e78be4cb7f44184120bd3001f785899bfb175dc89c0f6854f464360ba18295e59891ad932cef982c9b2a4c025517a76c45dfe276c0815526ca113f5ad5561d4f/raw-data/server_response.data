<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 1861253004: Check CSP before registering ServiceWorkers -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '97f1e112a156944ae7a86f8abbf2d155';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/1861253004%252526ust%25253D1608700133720280%252526usg%25253DAFQjCNFu1VIHyQKnehFGxbV7EUT4WtXyJw%26service%3Dah">Sign out</a>

</div>
<div class="counter">(285)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-1861253004">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/1861253004/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            1861253004</a>:
    Check CSP before registering ServiceWorkers  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            4 years, 8 months ago by <a href="/user/estark" onMouseOver="M_showUserInfoPopup(this)">estark</a>
          </div>
          <div><b>Modified:</b><br/>
            4 years, 8 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/falken" onMouseOver="M_showUserInfoPopup(this)">falken</a></span>, <span class='approval'><a href="/user/Mike%20West" onMouseOver="M_showUserInfoPopup(this)">Mike West</a></span>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, michaeln, mkwst+watchlist-csp_chromium.org, tzik, serviceworker-reviews, jsbell+serviceworker_chromium.org, nhiroki, falken, haraken, kinuko+serviceworker, blink-reviews, horo+watch_chromium.org
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Check CSP before registering ServiceWorkers

Service Worker registrations should be subject to the same CSP checks as
other workers. The spec doesn't say this explicitly
(<a href="https://www.w3.org/TR/CSP2/#directive-child-src-workers">https://www.w3.org/TR/CSP2/#directive-child-src-workers</a> says "Worker or
SharedWorker constructors"), but it seems to be in the spirit of things,
and it matches Firefox's behavior.

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=579801">579801</a>
Committed: <a href="https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57">https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57</a>
Cr-Commit-Position: refs/heads/master@{#385775}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/1861253004/#ps1"
       onclick="M_toggleSectionForPS('1861253004', '1')"
       class="toggled-section opentriangle">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-1"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 4 years, 8 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue1861253004_1.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/1861253004/1"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+45 lines, -0 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/1861253004/patch/1/10001">
            third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/resources/service-worker.js
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1861253004/diff/1/third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/resources/service-worker.js">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+1 line, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1861253004_1_10001.diff"
             title="Download patch for third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/resources/service-worker.js">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/1861253004/patch/1/10002">
            third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-allowed.html
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1861253004/diff/1/third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-allowed.html">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+14 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1861253004_1_10002.diff"
             title="Download patch for third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-allowed.html">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/1861253004/patch/1/10004">
            third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked.html
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1861253004/diff/1/third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked.html">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+15 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1861253004_1_10004.diff"
             title="Download patch for third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked.html">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/1861253004/patch/1/10003">
            third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked-expected.txt
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1861253004/diff/1/third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked-expected.txt">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+6 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1861253004_1_10003.diff"
             title="Download patch for third_party/WebKit/LayoutTests/http/tests/security/contentSecurityPolicy/service-worker-blocked-expected.txt">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1861253004/patch/1/10005">
            third_party/WebKit/Source/modules/serviceworkers/ServiceWorkerContainer.cpp
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1861253004/diff/1/third_party/WebKit/Source/modules/serviceworkers/ServiceWorkerContainer.cpp">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+9 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1861253004_1_10005.diff"
             title="Download patch for third_party/WebKit/Source/modules/serviceworkers/ServiceWorkerContainer.cpp">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 1;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 12 (3 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 12)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 12)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(12)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(12)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>estark</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          estark@chromium.org changed reviewers: + falken@chromium.org, mkwst@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-06 21:52:28 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            ><a href="mailto:estark@chromium.org">estark@chromium.org</a> changed reviewers:
+ <a href="mailto:falken@chromium.org">falken@chromium.org</a>, <a href="mailto:mkwst@chromium.org">mkwst@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>estark</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          falken, mkwst, PTAL?
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-06 21:52:29 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            >falken, mkwst, PTAL?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Marijn Kruisselbrink</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          I wonder how this would/should work for service workers installed via a Link: rel=serviceworker http ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-06 22:01:50 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            >I wonder how this would/should work for service workers installed via a Link:
rel=serviceworker http header (the code in
content/browser/service_worker/link_header_support.cc HandleServiceWorkerLink).
Maybe it is okay to not apply any kind of CSP checks there because if you can
inject a Link: header in the response you can also modify the CSPs?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>estark</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          On 2016/04/06 22:01:50, Marijn Kruisselbrink wrote: &gt; I wonder how this would/should work for service ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-06 23:13:11 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            >On 2016/04/06 22:01:50, Marijn Kruisselbrink wrote:
&gt; I wonder how this would/should work for service workers installed via a Link:
&gt; rel=serviceworker http header (the code in
&gt; content/browser/service_worker/link_header_support.cc
HandleServiceWorkerLink).
&gt; Maybe it is okay to not apply any kind of CSP checks there because if you can
&gt; inject a Link: header in the response you can also modify the CSPs?

Huh, I didn&#39;t know you could install a service worker via an HTTP header... I
agree with you that it&#39;s probably outside the threat model of CSP, but I&#39;m not
sure. Mike, maybe CSP3 should say something about how CSP should be applied when
loading the main script for a service worker? (If it doesn&#39;t already)

If we wanted to apply CSP checks for a SW loaded from an HTTP header, seems like
that would be tricky with how things are set up right now. We are planning to
move CSP checks into the browser process at some point, at which point it would
probably be much simpler to enforce them for SWs installed via Link.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>falken</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          lgtm with question Should we also check CSP on importScripts() in the service worker script? ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 05:06:08 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >lgtm with question

Should we also check CSP on importScripts() in the service worker script? That
may already work.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Mike West</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          On 2016/04/07 at 05:06:08, falken wrote: &gt; lgtm with question LGTM. I think we&#39;ll probably ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 08:42:32 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            >On 2016/04/07 at 05:06:08, falken wrote:
&gt; lgtm with question

LGTM. I think we&#39;ll probably want to split this out into a separate directive at
some point, but matching Firefox&#39;s behavior for the moment makes sense.

&gt; Should we also check CSP on importScripts() in the service worker script? That
may already work.

That should be covered by the Service Worker&#39;s `script-src` directive. I doubt
we have a test for it, but it Should Totally Work(tm).

&gt; I wonder how this would/should work for service workers installed via a Link:
rel=serviceworker http header

If/when we start processing CSP in the browser, we&#39;ll need to process it before
triggering requests via `Link` headers. This is more or less the same thing we
need to do for `frame-ancestor`, just in a different place. That&#39;s not something
we&#39;re capable of doing today, for better or worse.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>estark</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          Thanks both. On 2016/04/07 08:42:32, Mike West wrote: &gt; On 2016/04/07 at 05:06:08, falken wrote: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 15:28:40 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            >Thanks both.

On 2016/04/07 08:42:32, Mike West wrote:
&gt; On 2016/04/07 at 05:06:08, falken wrote:
&gt; &gt; lgtm with question
&gt; 
&gt; LGTM. I think we&#39;ll probably want to split this out into a separate directive
at
&gt; some point, but matching Firefox&#39;s behavior for the moment makes sense.
&gt; 
&gt; &gt; Should we also check CSP on importScripts() in the service worker script?
That
&gt; may already work.
&gt; 
&gt; That should be covered by the Service Worker&#39;s `script-src` directive. I doubt
&gt; we have a test for it, but it Should Totally Work(tm).

Au contraire!
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/service-worker-csp-worker.php" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/third_party/WebKit...</a>

&gt; 
&gt; &gt; I wonder how this would/should work for service workers installed via a
Link:
&gt; rel=serviceworker http header
&gt; 
&gt; If/when we start processing CSP in the browser, we&#39;ll need to process it
before
&gt; triggering requests via `Link` headers. This is more or less the same thing we
&gt; need to do for `frame-ancestor`, just in a different place. That&#39;s not
something
&gt; we&#39;re capable of doing today, for better or worse.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>estark</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          The CQ bit was checked by estark@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 15:28:53 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            >The CQ bit was checked by <a href="mailto:estark@chromium.org">estark@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/patch-status/1861253004/1 View timeline at https://chromium-cq-status.appspot.com/patch-timeline/1861253004/1
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 15:29:22 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >CQ is trying da patch. Follow status at
 <a href="https://chromium-cq-status.appspot.com/patch-status/1861253004/1" rel="nofollow">https://chromium-cq-status.appspot.com/patch-status/1861253004/1</a>
View timeline at
 <a href="https://chromium-cq-status.appspot.com/patch-timeline/1861253004/1" rel="nofollow">https://chromium-cq-status.appspot.com/patch-timeline/1861253004/1</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          Committed patchset #1 (id:1)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 16:14:53 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-9"
            >Committed patchset #1 (id:1)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   generated"
           style="display: none"
           id="generated-msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          Description was changed from ========== Check CSP before registering ServiceWorkers Service Worker registrations should be ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 16:16:53 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-10"
            >Description was changed from

==========
Check CSP before registering ServiceWorkers

Service Worker registrations should be subject to the same CSP checks as
other workers. The spec doesn&#39;t say this explicitly
(<a href="https://www.w3.org/TR/CSP2/#directive-child-src-workers" rel="nofollow">https://www.w3.org/TR/CSP2/#directive-child-src-workers</a> says &quot;Worker or
SharedWorker constructors&quot;), but it seems to be in the spirit of things,
and it matches Firefox&#39;s behavior.

BUG=579801
==========

to

==========
Check CSP before registering ServiceWorkers

Service Worker registrations should be subject to the same CSP checks as
other workers. The spec doesn&#39;t say this explicitly
(<a href="https://www.w3.org/TR/CSP2/#directive-child-src-workers" rel="nofollow">https://www.w3.org/TR/CSP2/#directive-child-src-workers</a> says &quot;Worker or
SharedWorker constructors&quot;), but it seems to be in the spirit of things,
and it matches Firefox&#39;s behavior.

BUG=579801

Committed: <a href="https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57" rel="nofollow">https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57</a>
Cr-Commit-Position: refs/heads/master@{#385775}
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-11">
                          Patchset 1 (id:??) landed as https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57 Cr-Commit-Position: refs/heads/master@{#385775}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 8 months ago
		(2016-04-07 16:16:54 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-11"
            >Patchset 1 (id:??) landed as
<a href="https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57" rel="nofollow">https://crrev.com/5289a5d4c98681e9a0f2d28da0c7aa35e282db57</a>
Cr-Commit-Position: refs/heads/master@{#385775}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 12)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 12)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(12)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(12)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 12;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 1861253004;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 1861253004: Check CSP before registering ServiceWorkers
     (Closed) </b><br/>
      Created 4 years, 8 months ago by estark<br/>
      Modified 4 years, 8 months ago<br/>
      Reviewers: Mike West, falken<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 0
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
