<!DOCTYPE html>
<html lang='en'>
<head>
<title>polkit - Authorization Manager  (mirrored from https://gitlab.freedesktop.org/polkit/polkit)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/polkit/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/polkit/polkit' title='polkit Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='polkit' href='/polkit/'>polkit</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bc7ffad5364'/><select name='h' onchange='this.form.submit();'>
<option value='gdbus'>gdbus</option>
<option value='master' selected='selected'>master</option>
<option value='mozjs52'>mozjs52</option>
<option value='polkit-0-96'>polkit-0-96</option>
<option value='revert-2c8287fb'>revert-2c8287fb</option>
<option value='wip/halfline/new-release'>wip/halfline/new-release</option>
<option value='wip/js-rule-files'>wip/js-rule-files</option>
<option value='wip/mozjs17'>wip/mozjs17</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Authorization Manager  (mirrored from https://gitlab.freedesktop.org/polkit/polkit)</td><td class='sub right'>root</td></tr></table>
<table class='tabs'><tr><td>
<a href='/polkit/'>summary</a><a href='/polkit/refs/?id=bc7ffad5364'>refs</a><a href='/polkit/log/'>log</a><a href='/polkit/tree/?id=bc7ffad5364'>tree</a><a class='active' href='/polkit/commit/?id=bc7ffad5364'>commit</a><a href='/polkit/diff/?id=bc7ffad5364'>diff</a></td><td class='form'><form class='right' method='get' action='/polkit/log/'>
<input type='hidden' name='id' value='bc7ffad5364'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bc7ffad5364'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Miloslav Trmač &lt;mitr@redhat.com&gt;</td><td class='right'>2018-06-25 19:24:06 +0200</td></tr>
<tr><th>committer</th><td>Miloslav Trmač &lt;mitr@redhat.com&gt;</td><td class='right'>2018-07-03 22:02:31 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/polkit/commit/?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>bc7ffad53643a9c80231fc41f5582d6a8931c32c</a> (<a href='/polkit/patch/?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/polkit/tree/?id=bc7ffad5364'>bfe9bcecbb4c90cf16e83e63d2f1c5c43ad21bdc</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/polkit/commit/?id=dda431905221a81921492b1d28b96b4bffb57700'>dda431905221a81921492b1d28b96b4bffb57700</a> (<a href='/polkit/diff/?id=bc7ffad5364&amp;id2=dda431905221a81921492b1d28b96b4bffb57700'>diff</a>)</td></tr></table>
<div class='commit-subject'>Fix CVE-2018-1116: Trusting client-supplied UID</div><div class='commit-msg'>As part of CVE-2013-4288, the D-Bus clients were allowed (and
encouraged) to submit the UID of the subject of authorization checks
to avoid races against UID changes (notably using executables
set-UID to root).

However, that also allowed any client to submit an arbitrary UID, and
that could be used to bypass "can only ask about / affect the same UID"
checks in CheckAuthorization / RegisterAuthenticationAgent /
UnregisterAuthenticationAgent.  This allowed an attacker:

- With CheckAuthorization, to cause the registered authentication
  agent in victim's session to pop up a dialog, or to determine whether
  the victim currently has a temporary authorization to perform an
  operation.

  (In principle, the attacker can also determine whether JavaScript
  rules allow the victim process to perform an operation; however,
  usually rules base their decisions on information determined from
  the supplied UID, so the attacker usually won't learn anything new.)

- With RegisterAuthenticationAgent, to prevent the victim's
  authentication agent to work (for a specific victim process),
  or to learn about which operations requiring authorization
  the victim is attempting.

To fix this, expose internal _polkit_unix_process_get_owner() /
obsolete polkit_unix_process_get_owner() as a private
polkit_unix_process_get_racy_uid__() (being more explicit about the
dangers on relying on it), and use it in
polkit_backend_session_monitor_get_user_for_subject() to return
a boolean indicating whether the subject UID may be caller-chosen.

Then, in the permission checks that require the subject to be
equal to the caller, fail on caller-chosen UIDs (and continue
through the pre-existing code paths which allow root, or root-designated
server processes, to ask about arbitrary subjects.)

Signed-off-by: Miloslav Trmač &lt;mitr@redhat.com&gt;
</div><div class='diffstat-header'><a href='/polkit/diff/?id=bc7ffad5364'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkit/polkitprivate.h?id=bc7ffad5364'>src/polkit/polkitprivate.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 3.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkit/polkitunixprocess.c?id=bc7ffad5364'>src/polkit/polkitunixprocess.c</a></td><td class='right'>61</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 83.6%;'/><td class='rem' style='width: 16.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkitbackend/polkitbackendinteractiveauthority.c?id=bc7ffad5364'>src/polkitbackend/polkitbackendinteractiveauthority.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 41.0%;'/><td class='rem' style='width: 23.0%;'/><td class='none' style='width: 36.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkitbackend/polkitbackendsessionmonitor-systemd.c?id=bc7ffad5364'>src/polkitbackend/polkitbackendsessionmonitor-systemd.c</a></td><td class='right'>38</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 55.7%;'/><td class='rem' style='width: 6.6%;'/><td class='none' style='width: 37.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkitbackend/polkitbackendsessionmonitor.c?id=bc7ffad5364'>src/polkitbackend/polkitbackendsessionmonitor.c</a></td><td class='right'>40</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 57.4%;'/><td class='rem' style='width: 8.2%;'/><td class='none' style='width: 34.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/polkit/diff/src/polkitbackend/polkitbackendsessionmonitor.h?id=bc7ffad5364'>src/polkitbackend/polkitbackendsessionmonitor.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='61%'><tr><td class='add' style='width: 1.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 148 insertions, 33 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/polkit/polkitprivate.h b/src/polkit/polkitprivate.h<br/>index 9f07063..c80142d 100644<br/>--- a/<a href='/polkit/tree/src/polkit/polkitprivate.h?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkit/polkitprivate.h</a><br/>+++ b/<a href='/polkit/tree/src/polkit/polkitprivate.h?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkit/polkitprivate.h</a></div><div class='hunk'>@@ -44,6 +44,8 @@ GVariant *polkit_action_description_to_gvariant (PolkitActionDescription *action</div><div class='ctx'> GVariant *polkit_subject_to_gvariant (PolkitSubject *subject);</div><div class='ctx'> GVariant *polkit_identity_to_gvariant (PolkitIdentity *identity);</div><div class='ctx'> </div><div class='add'>+gint polkit_unix_process_get_racy_uid__ (PolkitUnixProcess *process, GError **error);</div><div class='add'>+</div><div class='ctx'> PolkitSubject  *polkit_subject_new_for_gvariant (GVariant *variant, GError **error);</div><div class='ctx'> PolkitIdentity *polkit_identity_new_for_gvariant (GVariant *variant, GError **error);</div><div class='ctx'> </div><div class='head'>diff --git a/src/polkit/polkitunixprocess.c b/src/polkit/polkitunixprocess.c<br/>index d4ebf50..972b777 100644<br/>--- a/<a href='/polkit/tree/src/polkit/polkitunixprocess.c?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkit/polkitunixprocess.c</a><br/>+++ b/<a href='/polkit/tree/src/polkit/polkitunixprocess.c?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkit/polkitunixprocess.c</a></div><div class='hunk'>@@ -56,6 +56,14 @@</div><div class='ctx'>  * To uniquely identify processes, both the process id and the start</div><div class='ctx'>  * time of the process (a monotonic increasing value representing the</div><div class='ctx'>  * time since the kernel was started) is used.</div><div class='add'>+ *</div><div class='add'>+ * NOTE: This object stores, and provides access to, the real UID of the</div><div class='add'>+ * process.  That value can change over time (with set*uid*(2) and exec*(2)).</div><div class='add'>+ * Checks whether an operation is allowed need to take care to use the UID</div><div class='add'>+ * value as of the time when the operation was made (or, following the open()</div><div class='add'>+ * privilege check model, when the connection making the operation possible</div><div class='add'>+ * was initiated).  That is usually done by initializing this with</div><div class='add'>+ * polkit_unix_process_new_for_owner() with trusted data.</div><div class='ctx'>  */</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -90,9 +98,6 @@ static void subject_iface_init (PolkitSubjectIface *subject_iface);</div><div class='ctx'> static guint64 get_start_time_for_pid (gint    pid,</div><div class='ctx'>                                        GError **error);</div><div class='ctx'> </div><div class='del'>-static gint _polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='del'>-                                            GError            **error);</div><div class='del'>-</div><div class='ctx'> #if defined(HAVE_FREEBSD) || defined(HAVE_NETBSD) || defined(HAVE_OPENBSD)</div><div class='ctx'> static gboolean get_kinfo_proc (gint pid,</div><div class='ctx'> #if defined(HAVE_NETBSD)</div><div class='hunk'>@@ -182,7 +187,7 @@ polkit_unix_process_constructed (GObject *object)</div><div class='ctx'>     {</div><div class='ctx'>       GError *error;</div><div class='ctx'>       error = NULL;</div><div class='del'>-      process-&gt;uid = _polkit_unix_process_get_owner (process, &amp;error);</div><div class='add'>+      process-&gt;uid = polkit_unix_process_get_racy_uid__ (process, &amp;error);</div><div class='ctx'>       if (error != NULL)</div><div class='ctx'>         {</div><div class='ctx'>           process-&gt;uid = -1;</div><div class='hunk'>@@ -271,6 +276,12 @@ polkit_unix_process_class_init (PolkitUnixProcessClass *klass)</div><div class='ctx'>  * Gets the user id for @process. Note that this is the real user-id,</div><div class='ctx'>  * not the effective user-id.</div><div class='ctx'>  *</div><div class='add'>+ * NOTE: The UID may change over time, so the returned value may not match the</div><div class='add'>+ * current state of the underlying process; or the UID may have been set by</div><div class='add'>+ * polkit_unix_process_new_for_owner() or polkit_unix_process_set_uid(),</div><div class='add'>+ * in which case it may not correspond to the actual UID of the referenced</div><div class='add'>+ * process at all (at any point in time).</div><div class='add'>+ *</div><div class='ctx'>  * Returns: The user id for @process or -1 if unknown.</div><div class='ctx'>  */</div><div class='ctx'> gint</div><div class='hunk'>@@ -708,13 +719,20 @@ out:</div><div class='ctx'>   return start_time;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static gint</div><div class='del'>-_polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='del'>-                                GError            **error)</div><div class='add'>+/*</div><div class='add'>+ * Private: Return the "current" UID.  Note that this is inherently racy,</div><div class='add'>+ * and the value may already be obsolete by the time this function returns;</div><div class='add'>+ * this function only guarantees that the UID was valid at some point during</div><div class='add'>+ * its execution.</div><div class='add'>+ */</div><div class='add'>+gint</div><div class='add'>+polkit_unix_process_get_racy_uid__ (PolkitUnixProcess  *process,</div><div class='add'>+                                    GError            **error)</div><div class='ctx'> {</div><div class='ctx'>   gint result;</div><div class='ctx'>   gchar *contents;</div><div class='ctx'>   gchar **lines;</div><div class='add'>+  guint64 start_time;</div><div class='ctx'> #if defined(HAVE_FREEBSD) || defined(HAVE_OPENBSD)</div><div class='ctx'>   struct kinfo_proc p;</div><div class='ctx'> #elif defined(HAVE_NETBSD)</div><div class='hunk'>@@ -722,6 +740,7 @@ _polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='ctx'> #else</div><div class='ctx'>   gchar filename[64];</div><div class='ctx'>   guint n;</div><div class='add'>+  GError *local_error;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'>   g_return_val_if_fail (POLKIT_IS_UNIX_PROCESS (process), 0);</div><div class='hunk'>@@ -745,8 +764,10 @@ _polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='ctx'> </div><div class='ctx'> #if defined(HAVE_FREEBSD)</div><div class='ctx'>   result = p.ki_uid;</div><div class='add'>+  start_time = (guint64) p.ki_start.tv_sec;</div><div class='ctx'> #else</div><div class='ctx'>   result = p.p_uid;</div><div class='add'>+  start_time = (guint64) p.p_ustart_sec;</div><div class='ctx'> #endif</div><div class='ctx'> #else</div><div class='ctx'> </div><div class='hunk'>@@ -781,17 +802,37 @@ _polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='ctx'>       else</div><div class='ctx'>         {</div><div class='ctx'>           result = real_uid;</div><div class='del'>-          goto out;</div><div class='add'>+          goto found;</div><div class='ctx'>         }</div><div class='ctx'>     }</div><div class='del'>-</div><div class='ctx'>   g_set_error (error,</div><div class='ctx'>                POLKIT_ERROR,</div><div class='ctx'>                POLKIT_ERROR_FAILED,</div><div class='ctx'>                "Didn't find any line starting with `Uid:' in file %s",</div><div class='ctx'>                filename);</div><div class='add'>+  goto out;</div><div class='add'>+</div><div class='add'>+found:</div><div class='add'>+  /* The UID and start time are, sadly, not available in a single file.  So,</div><div class='add'>+   * read the UID first, and then the start time; if the start time is the same</div><div class='add'>+   * before and after reading the UID, it couldn't have changed.</div><div class='add'>+   */</div><div class='add'>+  local_error = NULL;</div><div class='add'>+  start_time = get_start_time_for_pid (process-&gt;pid, &amp;local_error);</div><div class='add'>+  if (local_error != NULL)</div><div class='add'>+    {</div><div class='add'>+      g_propagate_error (error, local_error);</div><div class='add'>+      goto out;</div><div class='add'>+    }</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+  if (process-&gt;start_time != start_time)</div><div class='add'>+    {</div><div class='add'>+      g_set_error (error, POLKIT_ERROR, POLKIT_ERROR_FAILED,</div><div class='add'>+		   "process with PID %d has been replaced", process-&gt;pid);</div><div class='add'>+      goto out;</div><div class='add'>+    }</div><div class='add'>+</div><div class='ctx'> out:</div><div class='ctx'>   g_strfreev (lines);</div><div class='ctx'>   g_free (contents);</div><div class='hunk'>@@ -810,5 +851,5 @@ gint</div><div class='ctx'> polkit_unix_process_get_owner (PolkitUnixProcess  *process,</div><div class='ctx'>                                GError            **error)</div><div class='ctx'> {</div><div class='del'>-  return _polkit_unix_process_get_owner (process, error);</div><div class='add'>+  return polkit_unix_process_get_racy_uid__ (process, error);</div><div class='ctx'> }</div><div class='head'>diff --git a/src/polkitbackend/polkitbackendinteractiveauthority.c b/src/polkitbackend/polkitbackendinteractiveauthority.c<br/>index 1cd60d3..cb6fdab 100644<br/>--- a/<a href='/polkit/tree/src/polkitbackend/polkitbackendinteractiveauthority.c?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkitbackend/polkitbackendinteractiveauthority.c</a><br/>+++ b/<a href='/polkit/tree/src/polkitbackend/polkitbackendinteractiveauthority.c?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkitbackend/polkitbackendinteractiveauthority.c</a></div><div class='hunk'>@@ -575,7 +575,7 @@ log_result (PolkitBackendInteractiveAuthority    *authority,</div><div class='ctx'>   if (polkit_authorization_result_get_is_authorized (result))</div><div class='ctx'>     log_result_str = "ALLOWING";</div><div class='ctx'> </div><div class='del'>-  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, NULL);</div><div class='add'>+  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, NULL, NULL);</div><div class='ctx'> </div><div class='ctx'>   subject_str = polkit_subject_to_string (subject);</div><div class='ctx'> </div><div class='hunk'>@@ -847,6 +847,7 @@ polkit_backend_interactive_authority_check_authorization (PolkitBackendAuthority</div><div class='ctx'>   gchar *subject_str;</div><div class='ctx'>   PolkitIdentity *user_of_caller;</div><div class='ctx'>   PolkitIdentity *user_of_subject;</div><div class='add'>+  gboolean user_of_subject_matches;</div><div class='ctx'>   gchar *user_of_caller_str;</div><div class='ctx'>   gchar *user_of_subject_str;</div><div class='ctx'>   PolkitAuthorizationResult *result;</div><div class='hunk'>@@ -892,7 +893,7 @@ polkit_backend_interactive_authority_check_authorization (PolkitBackendAuthority</div><div class='ctx'>            action_id);</div><div class='ctx'> </div><div class='ctx'>   user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor,</div><div class='del'>-                                                                        caller,</div><div class='add'>+                                                                        caller, NULL,</div><div class='ctx'>                                                                         &amp;error);</div><div class='ctx'>   if (error != NULL)</div><div class='ctx'>     {</div><div class='hunk'>@@ -907,7 +908,7 @@ polkit_backend_interactive_authority_check_authorization (PolkitBackendAuthority</div><div class='ctx'>   g_debug (" user of caller is %s", user_of_caller_str);</div><div class='ctx'> </div><div class='ctx'>   user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor,</div><div class='del'>-                                                                         subject,</div><div class='add'>+                                                                         subject, &amp;user_of_subject_matches,</div><div class='ctx'>                                                                          &amp;error);</div><div class='ctx'>   if (error != NULL)</div><div class='ctx'>     {</div><div class='hunk'>@@ -937,7 +938,10 @@ polkit_backend_interactive_authority_check_authorization (PolkitBackendAuthority</div><div class='ctx'>    * We only allow this if, and only if,</div><div class='ctx'>    *</div><div class='ctx'>    *  - processes may check for another process owned by the *same* user but not</div><div class='del'>-   *    if details are passed (otherwise you'd be able to spoof the dialog)</div><div class='add'>+   *    if details are passed (otherwise you'd be able to spoof the dialog);</div><div class='add'>+   *    the caller supplies the user_of_subject value, so we additionally</div><div class='add'>+   *    require it to match at least at one point in time (via</div><div class='add'>+   *    user_of_subject_matches).</div><div class='ctx'>    *</div><div class='ctx'>    *  - processes running as uid 0 may check anything and pass any details</div><div class='ctx'>    *</div><div class='hunk'>@@ -945,7 +949,9 @@ polkit_backend_interactive_authority_check_authorization (PolkitBackendAuthority</div><div class='ctx'>    *    then any uid referenced by that annotation is also allowed to check</div><div class='ctx'>    *    to check anything and pass any details</div><div class='ctx'>    */</div><div class='del'>-  if (!polkit_identity_equal (user_of_caller, user_of_subject) || has_details)</div><div class='add'>+  if (!user_of_subject_matches</div><div class='add'>+      || !polkit_identity_equal (user_of_caller, user_of_subject)</div><div class='add'>+      || has_details)</div><div class='ctx'>     {</div><div class='ctx'>       if (!may_identity_check_authorization (interactive_authority, action_id, user_of_caller))</div><div class='ctx'>         {</div><div class='hunk'>@@ -1110,9 +1116,10 @@ check_authorization_sync (PolkitBackendAuthority         *authority,</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-  /* every subject has a user */</div><div class='add'>+  /* every subject has a user; this is supplied by the client, so we rely</div><div class='add'>+   * on the caller to validate its acceptability. */</div><div class='ctx'>   user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor,</div><div class='del'>-                                                                         subject,</div><div class='add'>+                                                                         subject, NULL,</div><div class='ctx'>                                                                          error);</div><div class='ctx'>   if (user_of_subject == NULL)</div><div class='ctx'>       goto out;</div><div class='hunk'>@@ -2480,6 +2487,7 @@ polkit_backend_interactive_authority_register_authentication_agent (PolkitBacken</div><div class='ctx'>   PolkitSubject *session_for_caller;</div><div class='ctx'>   PolkitIdentity *user_of_caller;</div><div class='ctx'>   PolkitIdentity *user_of_subject;</div><div class='add'>+  gboolean user_of_subject_matches;</div><div class='ctx'>   AuthenticationAgent *agent;</div><div class='ctx'>   gboolean ret;</div><div class='ctx'>   gchar *caller_cmdline;</div><div class='hunk'>@@ -2532,7 +2540,7 @@ polkit_backend_interactive_authority_register_authentication_agent (PolkitBacken</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-  user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, caller, NULL);</div><div class='add'>+  user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, caller, NULL, NULL);</div><div class='ctx'>   if (user_of_caller == NULL)</div><div class='ctx'>     {</div><div class='ctx'>       g_set_error (error,</div><div class='hunk'>@@ -2541,7 +2549,7 @@ polkit_backend_interactive_authority_register_authentication_agent (PolkitBacken</div><div class='ctx'>                    "Cannot determine user of caller");</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='del'>-  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, NULL);</div><div class='add'>+  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, &amp;user_of_subject_matches, NULL);</div><div class='ctx'>   if (user_of_subject == NULL)</div><div class='ctx'>     {</div><div class='ctx'>       g_set_error (error,</div><div class='hunk'>@@ -2550,7 +2558,8 @@ polkit_backend_interactive_authority_register_authentication_agent (PolkitBacken</div><div class='ctx'>                    "Cannot determine user of subject");</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='del'>-  if (!polkit_identity_equal (user_of_caller, user_of_subject))</div><div class='add'>+  if (!user_of_subject_matches</div><div class='add'>+      || !polkit_identity_equal (user_of_caller, user_of_subject))</div><div class='ctx'>     {</div><div class='ctx'>       if (identity_is_root_user (user_of_caller))</div><div class='ctx'>         {</div><div class='hunk'>@@ -2643,6 +2652,7 @@ polkit_backend_interactive_authority_unregister_authentication_agent (PolkitBack</div><div class='ctx'>   PolkitSubject *session_for_caller;</div><div class='ctx'>   PolkitIdentity *user_of_caller;</div><div class='ctx'>   PolkitIdentity *user_of_subject;</div><div class='add'>+  gboolean user_of_subject_matches;</div><div class='ctx'>   AuthenticationAgent *agent;</div><div class='ctx'>   gboolean ret;</div><div class='ctx'>   gchar *scope_str;</div><div class='hunk'>@@ -2691,7 +2701,7 @@ polkit_backend_interactive_authority_unregister_authentication_agent (PolkitBack</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-  user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, caller, NULL);</div><div class='add'>+  user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, caller, NULL, NULL);</div><div class='ctx'>   if (user_of_caller == NULL)</div><div class='ctx'>     {</div><div class='ctx'>       g_set_error (error,</div><div class='hunk'>@@ -2700,7 +2710,7 @@ polkit_backend_interactive_authority_unregister_authentication_agent (PolkitBack</div><div class='ctx'>                    "Cannot determine user of caller");</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='del'>-  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, NULL);</div><div class='add'>+  user_of_subject = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor, subject, &amp;user_of_subject_matches, NULL);</div><div class='ctx'>   if (user_of_subject == NULL)</div><div class='ctx'>     {</div><div class='ctx'>       g_set_error (error,</div><div class='hunk'>@@ -2709,7 +2719,8 @@ polkit_backend_interactive_authority_unregister_authentication_agent (PolkitBack</div><div class='ctx'>                    "Cannot determine user of subject");</div><div class='ctx'>       goto out;</div><div class='ctx'>     }</div><div class='del'>-  if (!polkit_identity_equal (user_of_caller, user_of_subject))</div><div class='add'>+  if (!user_of_subject_matches</div><div class='add'>+      || !polkit_identity_equal (user_of_caller, user_of_subject))</div><div class='ctx'>     {</div><div class='ctx'>       if (identity_is_root_user (user_of_caller))</div><div class='ctx'>         {</div><div class='hunk'>@@ -2819,7 +2830,7 @@ polkit_backend_interactive_authority_authentication_agent_response (PolkitBacken</div><div class='ctx'>            identity_str);</div><div class='ctx'> </div><div class='ctx'>   user_of_caller = polkit_backend_session_monitor_get_user_for_subject (priv-&gt;session_monitor,</div><div class='del'>-                                                                        caller,</div><div class='add'>+                                                                        caller, NULL,</div><div class='ctx'>                                                                         error);</div><div class='ctx'>   if (user_of_caller == NULL)</div><div class='ctx'>     goto out;</div><div class='head'>diff --git a/src/polkitbackend/polkitbackendsessionmonitor-systemd.c b/src/polkitbackend/polkitbackendsessionmonitor-systemd.c<br/>index 2a6c739..b00cdbd 100644<br/>--- a/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor-systemd.c?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkitbackend/polkitbackendsessionmonitor-systemd.c</a><br/>+++ b/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor-systemd.c?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkitbackend/polkitbackendsessionmonitor-systemd.c</a></div><div class='hunk'>@@ -29,6 +29,7 @@</div><div class='ctx'> #include &lt;stdlib.h&gt;</div><div class='ctx'> </div><div class='ctx'> #include &lt;polkit/polkit.h&gt;</div><div class='add'>+#include &lt;polkit/polkitprivate.h&gt;</div><div class='ctx'> #include "polkitbackendsessionmonitor.h"</div><div class='ctx'> </div><div class='ctx'> /* &lt;internal&gt;</div><div class='hunk'>@@ -246,26 +247,40 @@ polkit_backend_session_monitor_get_sessions (PolkitBackendSessionMonitor *monito</div><div class='ctx'>  * polkit_backend_session_monitor_get_user:</div><div class='ctx'>  * @monitor: A #PolkitBackendSessionMonitor.</div><div class='ctx'>  * @subject: A #PolkitSubject.</div><div class='add'>+ * @result_matches: If not %NULL, set to indicate whether the return value matches current (RACY) state.</div><div class='ctx'>  * @error: Return location for error.</div><div class='ctx'>  *</div><div class='ctx'>  * Gets the user corresponding to @subject or %NULL if no user exists.</div><div class='ctx'>  *</div><div class='add'>+ * NOTE: For a #PolkitUnixProcess, the UID is read from @subject (which may</div><div class='add'>+ * come from e.g. a D-Bus client), so it may not correspond to the actual UID</div><div class='add'>+ * of the referenced process (at any point in time).  This is indicated by</div><div class='add'>+ * setting @result_matches to %FALSE; the caller may reject such subjects or</div><div class='add'>+ * require additional privileges. @result_matches == %TRUE only indicates that</div><div class='add'>+ * the UID matched the underlying process at ONE point in time, it may not match</div><div class='add'>+ * later.</div><div class='add'>+ *</div><div class='ctx'>  * Returns: %NULL if @error is set otherwise a #PolkitUnixUser that should be freed with g_object_unref().</div><div class='ctx'>  */</div><div class='ctx'> PolkitIdentity *</div><div class='ctx'> polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor  *monitor,</div><div class='ctx'>                                                      PolkitSubject                *subject,</div><div class='add'>+                                                     gboolean                     *result_matches,</div><div class='ctx'>                                                      GError                      **error)</div><div class='ctx'> {</div><div class='ctx'>   PolkitIdentity *ret;</div><div class='del'>-  guint32 uid;</div><div class='add'>+  gboolean matches;</div><div class='ctx'> </div><div class='ctx'>   ret = NULL;</div><div class='add'>+  matches = FALSE;</div><div class='ctx'> </div><div class='ctx'>   if (POLKIT_IS_UNIX_PROCESS (subject))</div><div class='ctx'>     {</div><div class='del'>-      uid = polkit_unix_process_get_uid (POLKIT_UNIX_PROCESS (subject));</div><div class='del'>-      if ((gint) uid == -1)</div><div class='add'>+      gint subject_uid, current_uid;</div><div class='add'>+      GError *local_error;</div><div class='add'>+</div><div class='add'>+      subject_uid = polkit_unix_process_get_uid (POLKIT_UNIX_PROCESS (subject));</div><div class='add'>+      if (subject_uid == -1)</div><div class='ctx'>         {</div><div class='ctx'>           g_set_error (error,</div><div class='ctx'>                        POLKIT_ERROR,</div><div class='hunk'>@@ -273,14 +288,24 @@ polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor</div><div class='ctx'>                        "Unix process subject does not have uid set");</div><div class='ctx'>           goto out;</div><div class='ctx'>         }</div><div class='del'>-      ret = polkit_unix_user_new (uid);</div><div class='add'>+      local_error = NULL;</div><div class='add'>+      current_uid = polkit_unix_process_get_racy_uid__ (POLKIT_UNIX_PROCESS (subject), &amp;local_error);</div><div class='add'>+      if (local_error != NULL)</div><div class='add'>+	{</div><div class='add'>+	  g_propagate_error (error, local_error);</div><div class='add'>+	  goto out;</div><div class='add'>+	}</div><div class='add'>+      ret = polkit_unix_user_new (subject_uid);</div><div class='add'>+      matches = (subject_uid == current_uid);</div><div class='ctx'>     }</div><div class='ctx'>   else if (POLKIT_IS_SYSTEM_BUS_NAME (subject))</div><div class='ctx'>     {</div><div class='ctx'>       ret = (PolkitIdentity*)polkit_system_bus_name_get_user_sync (POLKIT_SYSTEM_BUS_NAME (subject), NULL, error);</div><div class='add'>+      matches = TRUE;</div><div class='ctx'>     }</div><div class='ctx'>   else if (POLKIT_IS_UNIX_SESSION (subject))</div><div class='ctx'>     {</div><div class='add'>+      uid_t uid;</div><div class='ctx'> </div><div class='ctx'>       if (sd_session_get_uid (polkit_unix_session_get_session_id (POLKIT_UNIX_SESSION (subject)), &amp;uid) &lt; 0)</div><div class='ctx'>         {</div><div class='hunk'>@@ -292,9 +317,14 @@ polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor</div><div class='ctx'>         }</div><div class='ctx'> </div><div class='ctx'>       ret = polkit_unix_user_new (uid);</div><div class='add'>+      matches = TRUE;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='ctx'>  out:</div><div class='add'>+  if (result_matches != NULL)</div><div class='add'>+    {</div><div class='add'>+      *result_matches = matches;</div><div class='add'>+    }</div><div class='ctx'>   return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/src/polkitbackend/polkitbackendsessionmonitor.c b/src/polkitbackend/polkitbackendsessionmonitor.c<br/>index e1a9ab3..ed30755 100644<br/>--- a/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor.c?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkitbackend/polkitbackendsessionmonitor.c</a><br/>+++ b/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor.c?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkitbackend/polkitbackendsessionmonitor.c</a></div><div class='hunk'>@@ -27,6 +27,7 @@</div><div class='ctx'> #include &lt;glib/gstdio.h&gt;</div><div class='ctx'> </div><div class='ctx'> #include &lt;polkit/polkit.h&gt;</div><div class='add'>+#include &lt;polkit/polkitprivate.h&gt;</div><div class='ctx'> #include "polkitbackendsessionmonitor.h"</div><div class='ctx'> </div><div class='ctx'> #define CKDB_PATH "/var/run/ConsoleKit/database"</div><div class='hunk'>@@ -273,28 +274,40 @@ polkit_backend_session_monitor_get_sessions (PolkitBackendSessionMonitor *monito</div><div class='ctx'>  * polkit_backend_session_monitor_get_user:</div><div class='ctx'>  * @monitor: A #PolkitBackendSessionMonitor.</div><div class='ctx'>  * @subject: A #PolkitSubject.</div><div class='add'>+ * @result_matches: If not %NULL, set to indicate whether the return value matches current (RACY) state.</div><div class='ctx'>  * @error: Return location for error.</div><div class='ctx'>  *</div><div class='ctx'>  * Gets the user corresponding to @subject or %NULL if no user exists.</div><div class='ctx'>  *</div><div class='add'>+ * NOTE: For a #PolkitUnixProcess, the UID is read from @subject (which may</div><div class='add'>+ * come from e.g. a D-Bus client), so it may not correspond to the actual UID</div><div class='add'>+ * of the referenced process (at any point in time).  This is indicated by</div><div class='add'>+ * setting @result_matches to %FALSE; the caller may reject such subjects or</div><div class='add'>+ * require additional privileges. @result_matches == %TRUE only indicates that</div><div class='add'>+ * the UID matched the underlying process at ONE point in time, it may not match</div><div class='add'>+ * later.</div><div class='add'>+ *</div><div class='ctx'>  * Returns: %NULL if @error is set otherwise a #PolkitUnixUser that should be freed with g_object_unref().</div><div class='ctx'>  */</div><div class='ctx'> PolkitIdentity *</div><div class='ctx'> polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor  *monitor,</div><div class='ctx'>                                                      PolkitSubject                *subject,</div><div class='add'>+                                                     gboolean                     *result_matches,</div><div class='ctx'>                                                      GError                      **error)</div><div class='ctx'> {</div><div class='ctx'>   PolkitIdentity *ret;</div><div class='add'>+  gboolean matches;</div><div class='ctx'>   GError *local_error;</div><div class='del'>-  gchar *group;</div><div class='del'>-  guint32 uid;</div><div class='ctx'> </div><div class='ctx'>   ret = NULL;</div><div class='add'>+  matches = FALSE;</div><div class='ctx'> </div><div class='ctx'>   if (POLKIT_IS_UNIX_PROCESS (subject))</div><div class='ctx'>     {</div><div class='del'>-      uid = polkit_unix_process_get_uid (POLKIT_UNIX_PROCESS (subject));</div><div class='del'>-      if ((gint) uid == -1)</div><div class='add'>+      gint subject_uid, current_uid;</div><div class='add'>+</div><div class='add'>+      subject_uid = polkit_unix_process_get_uid (POLKIT_UNIX_PROCESS (subject));</div><div class='add'>+      if (subject_uid == -1)</div><div class='ctx'>         {</div><div class='ctx'>           g_set_error (error,</div><div class='ctx'>                        POLKIT_ERROR,</div><div class='hunk'>@@ -302,14 +315,26 @@ polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor</div><div class='ctx'>                        "Unix process subject does not have uid set");</div><div class='ctx'>           goto out;</div><div class='ctx'>         }</div><div class='del'>-      ret = polkit_unix_user_new (uid);</div><div class='add'>+      local_error = NULL;</div><div class='add'>+      current_uid = polkit_unix_process_get_racy_uid__ (POLKIT_UNIX_PROCESS (subject), &amp;local_error);</div><div class='add'>+      if (local_error != NULL)</div><div class='add'>+	{</div><div class='add'>+	  g_propagate_error (error, local_error);</div><div class='add'>+	  goto out;</div><div class='add'>+	}</div><div class='add'>+      ret = polkit_unix_user_new (subject_uid);</div><div class='add'>+      matches = (subject_uid == current_uid);</div><div class='ctx'>     }</div><div class='ctx'>   else if (POLKIT_IS_SYSTEM_BUS_NAME (subject))</div><div class='ctx'>     {</div><div class='ctx'>       ret = (PolkitIdentity*)polkit_system_bus_name_get_user_sync (POLKIT_SYSTEM_BUS_NAME (subject), NULL, error);</div><div class='add'>+      matches = TRUE;</div><div class='ctx'>     }</div><div class='ctx'>   else if (POLKIT_IS_UNIX_SESSION (subject))</div><div class='ctx'>     {</div><div class='add'>+      gint uid;</div><div class='add'>+      gchar *group;</div><div class='add'>+</div><div class='ctx'>       if (!ensure_database (monitor, error))</div><div class='ctx'>         {</div><div class='ctx'>           g_prefix_error (error, "Error getting user for session: Error ensuring CK database at " CKDB_PATH ": ");</div><div class='hunk'>@@ -328,9 +353,14 @@ polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor</div><div class='ctx'>       g_free (group);</div><div class='ctx'> </div><div class='ctx'>       ret = polkit_unix_user_new (uid);</div><div class='add'>+      matches = TRUE;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='ctx'>  out:</div><div class='add'>+  if (result_matches != NULL)</div><div class='add'>+    {</div><div class='add'>+      *result_matches = matches;</div><div class='add'>+    }</div><div class='ctx'>   return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/src/polkitbackend/polkitbackendsessionmonitor.h b/src/polkitbackend/polkitbackendsessionmonitor.h<br/>index 8f8a2ca..3972326 100644<br/>--- a/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor.h?id=dda431905221a81921492b1d28b96b4bffb57700'>src/polkitbackend/polkitbackendsessionmonitor.h</a><br/>+++ b/<a href='/polkit/tree/src/polkitbackend/polkitbackendsessionmonitor.h?id=bc7ffad53643a9c80231fc41f5582d6a8931c32c'>src/polkitbackend/polkitbackendsessionmonitor.h</a></div><div class='hunk'>@@ -47,6 +47,7 @@ GList                       *polkit_backend_session_monitor_get_sessions (Polkit</div><div class='ctx'> </div><div class='ctx'> PolkitIdentity              *polkit_backend_session_monitor_get_user_for_subject (PolkitBackendSessionMonitor *monitor,</div><div class='ctx'>                                                                                   PolkitSubject               *subject,</div><div class='add'>+                                                                                  gboolean                    *result_matches,</div><div class='ctx'>                                                                                   GError                     **error);</div><div class='ctx'> </div><div class='ctx'> PolkitSubject               *polkit_backend_session_monitor_get_session_for_subject (PolkitBackendSessionMonitor *monitor,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:10 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
