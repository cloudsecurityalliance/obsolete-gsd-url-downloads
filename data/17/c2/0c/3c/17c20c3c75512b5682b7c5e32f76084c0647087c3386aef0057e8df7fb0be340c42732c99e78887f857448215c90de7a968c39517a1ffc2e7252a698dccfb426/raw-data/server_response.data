<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #70019 - RDF' href='rss/bug.php?id=70019'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #70019 - RSS 2.0' href='rss/bug.php?id=70019&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #70019 :: Files extracted from archive may be placed outside of destination directory</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=70019">Sec Bug</a>&nbsp;#70019</th>
            <td id="summary" colspan="5">Files extracted from archive may be placed outside of destination directory</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-07-08 09:33 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-09-09 10:01 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>stewie &#x61;&#116; mail &#x64;&#111;&#x74; ru</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.10</td>
            <th class="details">OS:</th>
            <td>Windows 7 64bit, OSX 10.10</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-6833" target="_blank">2015-6833</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=70019&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=70019&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=70019&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1436347980">&nbsp;</a><strong>[2015-07-08 09:33 UTC] stewie &#x61;&#116; mail &#x64;&#111;&#x74; ru</strong>
<pre class='note'>Description:
------------
By modifying filenames in archive to contain paths like &quot;../somefile.ext&quot;, after extracting they may be placed in directories outer to destination directory

Test archive is at <a href="https://www.dropbox.com/s/yfk10bdmrwlj47l/TestFile.zip?dl=0" rel="nofollow">https://www.dropbox.com/s/yfk10bdmrwlj47l/TestFile.zip?dl=0</a>

Test script:
---------------
&lt;?php
    $phar = new PharData('TestFile.zip');
    $phar-&gt;extractTo('c:\php\test\test'); 
?&gt;

Expected result:
----------------
file placed under c:\php\test\test

Actual result:
--------------
file placed under c:\php\test

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=70019'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=70019'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1436365824">&nbsp;</a><strong>[2015-07-08 14:30 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Not a bug</span>
</div></div></div><div class='comment type_comment' ><a name="1436365824">&nbsp;</a><strong>[2015-07-08 14:30 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Thanks for the report.

The paragraph 4.4.17 of the zip file spec <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT" rel="nofollow">https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT</a> tells that a relative path is a valid item in a zip archive. Thus, it is expected behavior.

Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1436389906">&nbsp;</a><strong>[2015-07-08 21:11 UTC] stewie &#x61;&#116; mail &#x64;&#111;&#x74; ru</strong>
<pre class='note'>Please take a look at <a href="https://github.com/php/php-src/blob/master/ext/zip/php_zip.c#L158" rel="nofollow">https://github.com/php/php-src/blob/master/ext/zip/php_zip.c#L158</a>

That's about how path sanitizing is done in php_zip, so no files could be written outside the cwd.
</pre>
</div><div class='comment type_log' ><a name="1437145993">&nbsp;</a><strong>[2015-07-17 15:13 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Not a bug</span>
<span class="added">+Status: Analyzed</span>
</div></div></div><div class='comment type_comment' ><a name="1437145993">&nbsp;</a><strong>[2015-07-17 15:13 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>ACK. Sounds plausible to me, we should sync with the ext/zip behavior. Even if we break the spec in this case, it's a more secure way for specific PHP tasks.

Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1438495934">&nbsp;</a><strong>[2015-08-02 06:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>proposed fix: <a href="https://gist.github.com/smalyshev/2d63ef849583b3097560" rel="nofollow">https://gist.github.com/smalyshev/2d63ef849583b3097560</a>
</pre>
</div><div class='comment type_comment' ><a name="1438520390">&nbsp;</a><strong>[2015-08-02 12:59 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>I've checked the patch with master. There are a few issues.

- ZMM routines should be used
- for the Windows part, it has to retry (or maybe even try as first) with the backslash
- with the two above solved - the contents of the file is completely broken. While ext/zip extracted file contains &quot;test&quot;, the ext/phar extracted file contains just garbage

Cheers.
</pre>
</div><div class='comment type_comment' ><a name="1438520574">&nbsp;</a><strong>[2015-08-02 13:02 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>But the contents of the file part seems to be an unrelated issue, what I had to mention.

Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1438536402">&nbsp;</a><strong>[2015-08-02 17:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Anatol, I'm not sure I fully understand the comments.

&gt; - ZMM routines should be used

Where exactly?

&gt; - for the Windows part, it has to retry (or maybe even try as first) with the backslash

Why? Doesn't Windows accept backslash as path separator? Furthermore, if it started with \, wouldn't path like \Foo be intereted as \\foo, i.e. UNC path? That's not what we want.

&gt; - with the two above solved - the contents of the file is completely broken. While ext/zip extracted file contains &quot;test&quot;, the ext/phar extracted file contains just garbage

I don't think this is caused by the patch, unless I miss something. Does it work for other ZIP files without the patch?
</pre>
</div><div class='comment type_comment' ><a name="1438546767">&nbsp;</a><strong>[2015-08-02 20:19 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Hi Stas,

ZMM routines - yep, looks like all. I see now - it has changed in 5.6 when the virtual cwd was moved into Zend (just forgot it as it was a patch i took over). 5.5 inclusive uses plain CRT routines.

With the backslash - ok, see now it is the difference between ext/phar and ext/zip. The latter accepts both, maybe it lays on libzip, but i havent checked. Just as fact - the exctraction doesn't work when only '/' is checked on Windows. But it is also the part about the actual streams feature in handling paths. Fe ext/zip checks for IS_SLASH <a href="https://github.com/php/php-src/blob/master/ext/zip/php_zip.c#L96" rel="nofollow">https://github.com/php/php-src/blob/master/ext/zip/php_zip.c#L96</a> . Maybe it's just simpler to check for both back and forward slash to achieve the behavior identical to ext/zip.

With the file contents - it is strange. I've created one archive with file ../hello.txt containing the string &quot;hello&quot;. Then i've checked with and without the patch. Linux - both with and without patch file has broken content. Windows - broken file contents with the patch, correct contents without the patch. Seems the patch somehow affects this, but seems the main breakage is not caused by the patch itself, anyway.

Regards

Anatol
</pre>
</div><div class='comment type_comment' ><a name="1438548778">&nbsp;</a><strong>[2015-08-02 20:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I'm not sure what you're proposing with regard to slashes on Windows. Current patch does not &quot;check&quot; anything, it just expands the path, eliminating the .. and . elements. Doesn't it work on Windows? What is the result? Sorry, I don't have windows setup handy, so I can't check. Also can't check the broken extraction - on my machine, it's broken before and after patch.
</pre>
</div><div class='comment type_comment' ><a name="1438552270">&nbsp;</a><strong>[2015-08-02 21:51 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The garbage seems to be the result of <a href='bug.php?id=69279'>bug #69279</a>.
</pre>
</div><div class='comment type_comment' ><a name="1438554375">&nbsp;</a><strong>[2015-08-02 22:26 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Yep, in the current state, per test, it'll fail to unzip on winodws. What I refer to is that new_state.cwd[0] = '\\'; should be checked as well - either as a retry or prior to '/'. It only regards to the relative path evaluation and cleanup. Merely what is being evaluated is the pure path before it even gets extracted, so on windows both '\\' and '/' are valid.

The file contents is a different issue, as you point out, too. Good that there's one more confirmation for that.

Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1438558349">&nbsp;</a><strong>[2015-08-02 23:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I'm not sure I understand - if both / amd \ are valid, why code with / failing right now on Windows? What about UNC paths - if we just try it with \ on Windows, it would interpret a path beginning with \\ as UNC path, not?
</pre>
</div><div class='comment type_comment' ><a name="1438561810">&nbsp;</a><strong>[2015-08-03 00:30 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Now that i step through virtual_file_ex, the exact place causing it is <a href="http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.c#1238" rel="nofollow">http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.c#1238</a> because it checks for DEFAULT_SLASH. If it's '/', it'll run into the first if branch and implicitly an UNC path. That will be misinterpreted later at <a href="http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.c#1268" rel="nofollow">http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.c#1268</a>. This happens due to how <a href="http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.h#70" rel="nofollow">http://lxr.php.net/xref/PHP_TRUNK/Zend/zend_virtual_cwd.h#70</a> IS_UNC_PATH is declared, say &quot;\\/&quot; would be interpreted same as &quot;\\\\&quot; ... This part is same in all the versions of virtual_file_ex. Seems to me on Windows it has to be only '\\', maybe just new_state.cwd[0] = DEFAULT_SLASH.

Not sure whether it is possible to do a PR to the gist on github, but i've seen it is possible to fork. Maybe it were easier me to supply a forked version of your patches, so we can check and update them mutually?

Thanks.
</pre>
</div><div class='comment type_comment' ><a name="1438585714">&nbsp;</a><strong>[2015-08-03 07:08 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I'm fine with that.
</pre>
</div><div class='comment type_comment' ><a name="1438598196">&nbsp;</a><strong>[2015-08-03 10:36 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Hi Stas,

here's a modified patch <a href="https://gist.github.com/weltling/718ef2c5a1d9062e4e3a" rel="nofollow">https://gist.github.com/weltling/718ef2c5a1d9062e4e3a</a> , using the DEFAULT_SLASH approach and one more improvement for long file names tested in ext\phar\tests\*extract*.phpt. Applies to 5.4 and 5.5. For 5.6 and 7.0 it seems to apply and work as well, just need to replace malloc/free with emalloc/efree before.

Thanks.
</pre>
</div><div class='comment type_svn' ><a name="1438726930">&nbsp;</a><strong>[2015-08-04 22:22 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417</a>
Log: Fix <a href='bug.php?id=70019'>bug #70019</a> - limit extracted files to given directory
</pre>
</div><div class='comment type_log' ><a name="1438726931">&nbsp;</a><strong>[2015-08-04 22:22 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Analyzed</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1438727004">&nbsp;</a><strong>[2015-08-04 22:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417</a>
Log: Fix <a href='bug.php?id=70019'>bug #70019</a> - limit extracted files to given directory
</pre>
</div><div class='comment type_svn' ><a name="1438727404">&nbsp;</a><strong>[2015-08-04 22:30 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417</a>
Log: Fix <a href='bug.php?id=70019'>bug #70019</a> - limit extracted files to given directory
</pre>
</div><div class='comment type_svn' ><a name="1438759769">&nbsp;</a><strong>[2015-08-05 07:29 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417</a>
Log: Fix <a href='bug.php?id=70019'>bug #70019</a> - limit extracted files to given directory
</pre>
</div><div class='comment type_svn' ><a name="1438769541">&nbsp;</a><strong>[2015-08-05 10:12 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=dda81f0505217a95db065e6bf9cc2d81eb902417</a>
Log: Fix <a href='bug.php?id=70019'>bug #70019</a> - limit extracted files to given directory
</pre>
</div><div class='comment type_log' ><a name="1441792895">&nbsp;</a><strong>[2015-09-09 10:01 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID:      2015-6833</span>
</div></div></div><div class='comment type_comment' ><a name="1458738523">&nbsp;</a><strong>[2016-03-23 13:08 UTC] mustafa &#x61;&#116; yavuzm &#x64;&#111;&#x74; com</strong>
<pre class='note'>I had same problem. When I extraxt on desktop files are working normally but when I extract zip file with phar command (extractTo) although all files are extracted they are broken o not working.
</pre>
</div><div class='comment type_related' ><a name="1607439827">&nbsp;</a><strong>[2020-12-08 15:03 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=72412'>Bug #72412</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
