<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #48597 - RDF' href='rss/bug.php?id=48597'>
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #48597 - RSS 2.0' href='rss/bug.php?id=48597&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #48597 :: Unclosed array keys break space escaping in $_GET/POST/REQUEST</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=48597">Bug</a>&nbsp;#48597</th>
            <td id="summary" colspan="5">Unclosed array keys break space escaping in $_GET/POST/REQUEST</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2009-06-18 16:17 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-07-29 20:12 UTC</td>
            <td rowspan="6">

                <table id="votes">
                    <tr><th class="details">Votes:</th><td>4</td></tr>
                    <tr><th class="details">Avg. Score:</th><td>3.5 &plusmn; 1.7</td></tr>
                    <tr><th class="details">Reproduced:</th><td>3 of 3 (100.0%)</td></tr>
                    <tr><th class="details">Same Version:</th><td>0 (0.0%)</td></tr>
                    <tr><th class="details">Same OS:</th><td>0 (0.0%)</td></tr>
                </table>

            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>crmalibu &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td></td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Open</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AGeneral+Issues">*General Issues</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.*, 6CVS (2009-07-01)</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=48597&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=48597&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=48597&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>

<form id="vote" method="post" action="vote.php">
    <div class="sect">
        <fieldset>
            <legend>Have you experienced this issue?</legend>
            <div>
                <input type="radio" id="rep-y" name="reproduced" value="1" onchange="show('canreproduce')"> <label for="rep-y">yes</label>
                <input type="radio" id="rep-n" name="reproduced" value="0" onchange="hide('canreproduce')"> <label for="rep-n">no</label>
                <input type="radio" id="rep-d" name="reproduced" value="2" onchange="hide('canreproduce')" checked="checked"> <label for="rep-d">don't know</label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Rate the importance of this bug to you:</legend>
            <div>
                <label for="score-5">high</label>
                <input type="radio" id="score-5" name="score" value="2">
                <input type="radio" id="score-4" name="score" value="1">
                <input type="radio" id="score-3" name="score" value="0" checked="checked">
                <input type="radio" id="score-2" name="score" value="-1">
                <input type="radio" id="score-1" name="score" value="-2">
                <label for="score-1">low</label>
            </div>
        </fieldset>
    </div>
    <div id="canreproduce" class="sect" style="display: none">
        <fieldset>
            <legend>Are you using the same PHP version?</legend>
            <div>
                <input type="radio" id="ver-y" name="samever" value="1"> <label for="ver-y">yes</label>
                <input type="radio" id="ver-n" name="samever" value="0" checked="checked"> <label for="ver-n">no</label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Are you using the same operating system?</legend>
            <div>
                <input type="radio" id="os-y" name="sameos" value="1"> <label for="os-y">yes</label>
                <input type="radio" id="os-n" name="sameos" value="0" checked="checked"> <label for="os-n">no</label>
            </div>
        </fieldset>
    </div>
    <div id="submit" class="sect">
        <input type="hidden" name="id" value="48597">
        <input type="submit" value="Vote">
    </div>
</form>
<br clear="all">


<div class='comment type_comment' ><a name="1245341861">&nbsp;</a><strong>[2009-06-18 16:17 UTC] crmalibu &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
I marked the version as 5.2.9 but it looks like the relevant code is the same for 5.3 and php 6 as well.

I don't know c, so I struggle to read the source code, but I think I found something unexpected. In main/php_variables.c in php_register_variable_ex I think the parsing behaves inconsistent. 

After reading the comments in the source code, I would think a gpc variable name should not make it through which has ' ' or '.' or '[' character in the name. But I've found a way to do it. It seems the routine for recognizing and parsing the array syntax is at fault.

In particular, characters after the first occurrence of a '[' char will be left alone because it thinks it needs to parse it as the special array syntax. But while it does later recognize that it's not proper array syntax, it doesn't properly convert the remaining character to underscore.

I don't know if this is a bug, or if it's serious or what. But the source code comment about removing those chars  due to not being binary safe made me think someone needs to look at this.



Reproduce code:
---------------
&lt;form action=&gt;
&lt;input name=&quot;goodvar .[&quot;&gt;
&lt;input name=&quot;goodarray[foo]&quot;&gt;
&lt;input name=&quot;badvar[ . [&quot;&gt;
&lt;input type=submit&gt;
&lt;/form&gt;

&lt;?php
print_r($_GET);
?&gt;

Expected result:
----------------
Array
(
    [goodvar___] =&gt; 
    [goodarray] =&gt; Array
        (
            [foo] =&gt; 
        )

    [badvar_____] =&gt; 
)

Actual result:
--------------
Array
(
    [goodvar___] =&gt; 
    [goodarray] =&gt; Array
        (
            [foo] =&gt; 
        )

    [badvar_ . [] =&gt; 
)

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=48597'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=48597'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1246746175">&nbsp;</a><strong>[2009-07-04 22:22 UTC] <a href="//people.php.net/jani">jani@php.net</a></strong>
<pre class='note'>See also <a href='bug.php?id=48794'>bug #48794</a>
</pre>
</div><div class='comment type_comment' ><a name="1254019939">&nbsp;</a><strong>[2009-09-27 02:52 UTC] <a href="//people.php.net/jani">jani@php.net</a></strong>
<pre class='note'>See also <a href='bug.php?id=49683'>bug #49683</a>
</pre>
</div><div class='comment type_comment' ><a name="1255473407">&nbsp;</a><strong>[2009-10-13 22:36 UTC] chrisstocktonaz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Here is a fix.

Index: main/php_variables.c
===================================================================
--- main/php_variables.c	(revision 289602)
+++ main/php_variables.c	(working copy)
@@ -61,6 +61,7 @@
 {
 	char *p = NULL;
 	char *ip;		/* index pointer */
+	char *pmarker;		/* marker to index before */
 	char *index, *escaped_index = NULL;
 	char *var, *var_orig;
 	int var_len, index_len;
@@ -100,12 +101,19 @@
 		if (*p == ' ' || *p == '.') {
 			*p='_';
 		} else if (*p == '[') {
-			is_array = 1;
-			ip = p;
-			*p = 0;
-			break;
+			for(pmarker = p; *pmarker; pmarker++) {
+				if(*pmarker == ']') {
+					is_array = 1;
+					ip = p;
+					*p = 0;
+					goto var_continue;
+				}
+                        }
+			*p='_';
 		}
 	}
+
+	var_continue:
 	var_len = p - var;
 
 	if (var_len==0) { /* empty variable name, or variable name with a space in it */
</pre>
</div><div class='comment type_comment' ><a name="1255488159">&nbsp;</a><strong>[2009-10-14 02:42 UTC] chrisstocktonaz &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Sorry for extra noise.. it seems my patch mixed the case of something like: &lt;input name=&quot;badvar[[[. [ . . .]&gt;

So updated:
Index: main/php_variables.c
===================================================================
--- main/php_variables.c	(revision 289602)
+++ main/php_variables.c	(working copy)
@@ -61,6 +61,7 @@
 {
 	char *p = NULL;
 	char *ip;		/* index pointer */
+	char *pmarker;
 	char *index, *escaped_index = NULL;
 	char *var, *var_orig;
 	int var_len, index_len;
@@ -100,12 +101,18 @@
 		if (*p == ' ' || *p == '.') {
 			*p='_';
 		} else if (*p == '[') {
-			is_array = 1;
-			ip = p;
-			*p = 0;
-			break;
+			for(pmarker = p; *pmarker; pmarker++) {
+				if(*pmarker == ']') {
+					is_array = 1;
+					ip = p;
+					*p = 0;
+					goto var_continue;
+				}
+                        }
+			*p='_';
 		}
 	}
+	var_continue:
 	var_len = p - var;
 
 	if (var_len==0) { /* empty variable name, or variable name with a space in it */
@@ -225,6 +232,13 @@
 			} else {
 				escaped_index = index;
 			}
+			/* clean up the array index */
+			for (pmarker = escaped_index; *pmarker; pmarker++) {
+				if (*pmarker == '[' || *pmarker == ']'
+					|| *pmarker == '.' || isspace(*pmarker)) {
+					*pmarker = '_';
+				}
+			}
 			/* 
 			 * According to rfc2965, more specific paths are listed above the less specific ones.
 			 * If we encounter a duplicate cookie name, we should skip it, since it is not possible
</pre>
</div><div class='comment type_comment' ><a name="1256333293">&nbsp;</a><strong>[2009-10-23 21:28 UTC] e &#x64;&#111;&#x74; ehritt &#x61;&#116; web &#x64;&#111;&#x74; de</strong>
<pre class='note'>I left a report too. <a href="http://bugs.php.net/bug.php?id=49975" rel="nofollow">http://bugs.php.net/bug.php?id=49975</a>

If I follow the documentation, a key of an array is a string. That means, a key &quot;abc[des]&quot; is possible. (e. g. $a=array(&quot;abc[des]&quot;=&gt;'d'); )

&lt;form action=&quot;s.php&quot; method=&quot;post&quot;&gt;
                &lt;input name=&quot;a[b[c]]&quot; type=&quot;text&quot;/&gt;
                &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;

$_POST=array('a'=&gt;array('b[c]'=&gt;'d'));

Both should result in even structure, but it does not. There are no reason, why incoming datas could not follow the same rules as data in a script.
</pre>
</div><div class='comment type_related' ><a name="1386272507">&nbsp;</a><strong>[2013-12-05 19:41 UTC] <a href="//people.php.net/mike">mike@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=50314'>Bug #50314</a>
</pre>
</div><div class='comment type_comment' ><a name="1438200729">&nbsp;</a><strong>[2015-07-29 20:12 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>IMO this is not a bug (at least I won't fix it). The mangling of
some special characters may have made sense when variables were
automatically created from GPC parameters (register_globals), but
nowadays I'd rather get rid of the mangling at all.
</pre>
</div><div class='comment type_related' ><a name="1470593123">&nbsp;</a><strong>[2016-08-07 18:05 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=49683'>Bug #49683</a>
</pre>
</div><div class='comment type_related' ><a name="1470593248">&nbsp;</a><strong>[2016-08-07 18:07 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=50314'>Bug #50314</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
