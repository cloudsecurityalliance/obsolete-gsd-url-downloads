<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 2208483002: Fix extension bindings injection for iframes (reland) -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '2d2e2df6b4ded35a8e7bedfddaf197d6';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/2208483002%252526ust%25253D1608651942029943%252526usg%25253DAFQjCNF3WQ7MCfkTT0vUPhq1vxAJL1MsQQ%26service%3Dah">Sign out</a>

</div>
<div class="counter">(337)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-2208483002">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/2208483002/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            2208483002</a>:
    Fix extension bindings injection for iframes (reland)  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            4 years, 4 months ago by <a href="/user/asargent_no_longer_on_chrome" onMouseOver="M_showUserInfoPopup(this)">asargent_no_longer_on_chrome</a>
          </div>
          <div><b>Modified:</b><br/>
            4 years, 4 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/Devlin" onMouseOver="M_showUserInfoPopup(this)">Devlin</a></span>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, chromium-apps-reviews_chromium.org, extensions-reviews_chromium.org
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Fix extension bindings injection for iframes (reland)

For iframes, we don't want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely
indicates some kind of race condition in the test). I've added a fix for
bug 630928 but haven't been able to locally reproduce the test failure
under DrMemory, so I've added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix.

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=573131">573131</a>, <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=630928">630928</a>
Committed: <a href="https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5">https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5</a>
Cr-Commit-Position: refs/heads/master@{#409819}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/2208483002/#ps1"
       onclick="M_toggleSectionForPS('2208483002', '1')"
       class="toggled-section ">
      Patch Set 1
      : same as codereview.chromium.org/2151693002
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-40001-pointer"
       href="/2208483002/#ps40001"
       onclick="M_toggleSectionForPS('2208483002', '40001')"
       class="toggled-section ">
      Patch Set 2
      : add fix and test for bug 630928, and logging to existing test
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 9
      
    </div>
  

  <div id="ps-40001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-80001-pointer"
       href="/2208483002/#ps80001"
       onclick="M_toggleSectionForPS('2208483002', '80001')"
       class="toggled-section opentriangle">
      Patch Set 3
      : addressed review comments, fixed lint
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-80001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 4 years, 4 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue2208483002_80001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/2208483002/80001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+276 lines, -17 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90001">
            chrome/browser/extensions/extension_bindings_apitest.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/browser/extensions/extension_bindings_apitest.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+61 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90001.diff"
             title="Download patch for chrome/browser/extensions/extension_bindings_apitest.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90002">
            chrome/browser/extensions/extension_messages_apitest.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/browser/extensions/extension_messages_apitest.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/chrome/browser/extensions/extension_messages_apitest.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/2208483002/diff2/40001:80001/chrome/browser/extensions/extension_messages_apitest.cc"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+41 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90002.diff"
             title="Download patch for chrome/browser/extensions/extension_messages_apitest.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90003">
            chrome/test/data/extensions/api_test/bindings/external_message_listener/background.js
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/external_message_listener/background.js">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+32 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90003.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/external_message_listener/background.js">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90004">
            chrome/test/data/extensions/api_test/bindings/external_message_listener/manifest.json
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/external_message_listener/manifest.json">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+11 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90004.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/external_message_listener/manifest.json">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90005">
            chrome/test/data/extensions/api_test/bindings/frames_before_navigation.html
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/frames_before_navigation.html">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/chrome/test/data/extensions/api_test/bindings/frames_before_navigation.html"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+77 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90005.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/frames_before_navigation.html">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A +</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90006">
            chrome/test/data/extensions/api_test/bindings/message_sender/background.js
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/message_sender/background.js">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+2 lines, -2 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90006.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/message_sender/background.js">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90007">
            chrome/test/data/extensions/api_test/bindings/message_sender/manifest.json
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/message_sender/manifest.json">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+13 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90007.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/message_sender/manifest.json">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A +</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90008">
            chrome/test/data/extensions/api_test/bindings/message_sender/public.html
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/bindings/message_sender/public.html">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+1 line, -1 line</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90008.diff"
             title="Download patch for chrome/test/data/extensions/api_test/bindings/message_sender/public.html">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">A +</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90009">
            chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html"
             title="Delta from patch set 1">1</a>
        
          <a href="/2208483002/diff2/40001:80001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+4 lines, -9 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90009.diff"
             title="Download patch for chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90011">
            extensions/renderer/script_context.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/extensions/renderer/script_context.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/extensions/renderer/script_context.h"
             title="Delta from patch set 1">1</a>
        
          <a href="/2208483002/diff2/40001:80001/extensions/renderer/script_context.h"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+8 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90011.diff"
             title="Download patch for extensions/renderer/script_context.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90010">
            extensions/renderer/script_context.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/extensions/renderer/script_context.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/extensions/renderer/script_context.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/2208483002/diff2/40001:80001/extensions/renderer/script_context.cc"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">3 chunks</td>
          <td style="white-space: nowrap">+18 lines, -3 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90010.diff"
             title="Download patch for extensions/renderer/script_context.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2208483002/patch/80001/90012">
            extensions/renderer/script_context_set.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2208483002/diff/80001/extensions/renderer/script_context_set.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2208483002/diff2/1:80001/extensions/renderer/script_context_set.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/2208483002/diff2/40001:80001/extensions/renderer/script_context_set.cc"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+8 lines, -2 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2208483002_80001_90012.diff"
             title="Download patch for extensions/renderer/script_context_set.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 80001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 24 (17 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 24)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 24)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(24)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(24)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          Patchset #2 (id:20001) has been deleted
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:10:39 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            >Patchset #2 (id:20001) has been deleted</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          The CQ bit was checked by asargent@chromium.org to run a CQ dry run
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:11:00 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            >The CQ bit was checked by <a href="mailto:asargent@chromium.org">asargent@chromium.org</a> to run a CQ dry run</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          Dry run: CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/40001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:11:42 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            >Dry run: CQ is trying da patch. Follow status at
 
<a href="https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/40001" rel="nofollow">https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.or...</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          Description was changed from ========== Fix extension bindings injection for iframes (reland) For iframes, we ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:15:06 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            >Description was changed from

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as some DrMemory test
failures.

BUG=573131,630928
==========

to

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to reproduce the test failure reliably
enough to debug, so I&#39;ve added some extra logging to the test in cases
where it might fail.

BUG=573131,630928
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          Description was changed from ========== Fix extension bindings injection for iframes (reland) For iframes, we ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:20:00 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >Description was changed from

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to reproduce the test failure reliably
enough to debug, so I&#39;ve added some extra logging to the test in cases
where it might fail.

BUG=573131,630928
==========

to

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the test fails again without any actual memory errors,
please do not revert the entire CL (since it is an important security fix);
instead just disable the test or add it to a suppression file so I can 
iterate on a fix. 

BUG=573131,630928
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          Description was changed from ========== Fix extension bindings injection for iframes (reland) For iframes, we ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:21:06 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            >Description was changed from

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the test fails again without any actual memory errors,
please do not revert the entire CL (since it is an important security fix);
instead just disable the test or add it to a suppression file so I can 
iterate on a fix. 

BUG=573131,630928
==========

to

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix. 

BUG=573131,630928
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          asargent@chromium.org changed reviewers: + rdevlin.cronin@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:22:23 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            ><a href="mailto:asargent@chromium.org">asargent@chromium.org</a> changed reviewers:
+ <a href="mailto:rdevlin.cronin@chromium.org">rdevlin.cronin@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc File extensions/renderer/script_context.cc (right): https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode122 extensions/renderer/script_context.cc:122: : web_frame_-&gt;dataSource(); Note that there&#39;s a little duplication here ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 00:22:24 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            ><a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
File extensions/renderer/script_context.cc (right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode122" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
extensions/renderer/script_context.cc:122: : web_frame_-&gt;dataSource();
Note that there&#39;s a little duplication here with the code in
GetDataSourceURLForFrame - I didn&#39;t want to just re-use GetDataSourceURLForFrame
as-is since this code runs on every frame creation and I wanted to avoid the
overhead of taking a blink::WebURL, converting it to a GURL to return from
GetDataSourceURLForFrame, and then immediately converting it back to a WebURL to
do the security origin test. I suppose I could refactor things to have a common
method that returns a blink::WebURL and then use that in both places. Let me
know what you think.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          The CQ bit was unchecked by commit-bot@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 02:22:34 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >The CQ bit was unchecked by <a href="mailto:commit-bot@chromium.org">commit-bot@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          Dry run: This issue passed the CQ dry run.
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 02:22:35 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-9"
            >Dry run: This issue passed the CQ dry run.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Devlin</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc File chrome/browser/extensions/extension_messages_apitest.cc (right): https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc#newcode1041 chrome/browser/extensions/extension_messages_apitest.cc:1041: for (int i = 0; i &lt; browser()-&gt;tab_strip_model()-&gt;count(); i++) ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-03 16:16:49 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-10"
            ><a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensio...</a>
File chrome/browser/extensions/extension_messages_apitest.cc (right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc#newcode1041" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensio...</a>
chrome/browser/extensions/extension_messages_apitest.cc:1041: for (int i = 0; i
&lt; browser()-&gt;tab_strip_model()-&gt;count(); i++) {
This is a shame, because UrlLoadObserver could already know the web contents
that committed the url.  Instead, we should probably just put a web_contents()
accessor on the UrlLoadObserver().  If you don&#39;t want to do that in this patch
to keep it targeted, that&#39;s fine, but maybe add a TODO?  (feel free to
TODO(devlin))

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extens...</a>
File
chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html
(right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html#newcode7" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extens...</a>
chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html:7:
var url = location.href.replace(&quot;popup_opener.html&quot;, &quot;chromium.org.html&quot;);
nit: prefer single quotes.

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
File extensions/renderer/script_context.cc (right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode122" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
extensions/renderer/script_context.cc:122: : web_frame_-&gt;dataSource();
On 2016/08/03 00:22:24, Antony Sargent wrote:
&gt; Note that there&#39;s a little duplication here with the code in
&gt; GetDataSourceURLForFrame - I didn&#39;t want to just re-use
GetDataSourceURLForFrame
&gt; as-is since this code runs on every frame creation and I wanted to avoid the
&gt; overhead of taking a blink::WebURL, converting it to a GURL to return from
&gt; GetDataSourceURLForFrame, and then immediately converting it back to a WebURL
to
&gt; do the security origin test. I suppose I could refactor things to have a
common
&gt; method that returns a blink::WebURL and then use that in both places. Let me
&gt; know what you think. 

This also looks very similar to the new logic added in ScriptContextSet.  In
both cases we:
Get the document url
if that&#39;s empty, check the data source url
if the data source url is non-empty and the frame can access it, use the data
source url

This makes me think we should probably have a method at least to do that -
something like GetAccessCheckedFrameURL() (strawman name) that we can use in
both places.  There may also be some uses of GetDataSourceURL that should be
converted to that, but we can do that separately.

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode127" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
extensions/renderer/script_context.cc:127: if (url_.is_empty())
This can be an else, right?  Because we&#39;ll only set url_ above if weburl is
empty.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-11">
                          Patchset #3 (id:60001) has been deleted
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 05:42:53 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-11"
            >Patchset #3 (id:60001) has been deleted</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg13"
           name="12">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(12)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-12">
                          PTAL https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc File chrome/browser/extensions/extension_messages_apitest.cc (right): https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc#newcode1041 chrome/browser/extensions/extension_messages_apitest.cc:1041: for (int i = 0; i &lt; browser()-&gt;tab_strip_model()-&gt;count(); ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 05:47:18 UTC)
                <a href="#msg13">#13</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-12"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-12"
            >PTAL

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensio...</a>
File chrome/browser/extensions/extension_messages_apitest.cc (right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensions/extension_messages_apitest.cc#newcode1041" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/browser/extensio...</a>
chrome/browser/extensions/extension_messages_apitest.cc:1041: for (int i = 0; i
&lt; browser()-&gt;tab_strip_model()-&gt;count(); i++) {
On 2016/08/03 16:16:49, Devlin wrote:
&gt; This is a shame, because UrlLoadObserver could already know the web contents
&gt; that committed the url.  Instead, we should probably just put a web_contents()
&gt; accessor on the UrlLoadObserver().  If you don&#39;t want to do that in this patch
&gt; to keep it targeted, that&#39;s fine, but maybe add a TODO?  (feel free to
&gt; TODO(devlin))

Left a TODO, to try and get this CL in faster.

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extens...</a>
File
chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html
(right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html#newcode7" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/chrome/test/data/extens...</a>
chrome/test/data/extensions/api_test/messaging/externally_connectable/sites/popup_opener.html:7:
var url = location.href.replace(&quot;popup_opener.html&quot;, &quot;chromium.org.html&quot;);
On 2016/08/03 16:16:49, Devlin wrote:
&gt; nit: prefer single quotes.

Oops, sorry, old habits die hard. Fixed.

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
File extensions/renderer/script_context.cc (right):

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode122" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
extensions/renderer/script_context.cc:122: : web_frame_-&gt;dataSource();
On 2016/08/03 16:16:49, Devlin wrote:
&gt; On 2016/08/03 00:22:24, Antony Sargent wrote:
&gt; &gt; Note that there&#39;s a little duplication here with the code in
&gt; &gt; GetDataSourceURLForFrame - I didn&#39;t want to just re-use
&gt; GetDataSourceURLForFrame
&gt; &gt; as-is since this code runs on every frame creation and I wanted to avoid the
&gt; &gt; overhead of taking a blink::WebURL, converting it to a GURL to return from
&gt; &gt; GetDataSourceURLForFrame, and then immediately converting it back to a
WebURL
&gt; to
&gt; &gt; do the security origin test. I suppose I could refactor things to have a
&gt; common
&gt; &gt; method that returns a blink::WebURL and then use that in both places. Let me
&gt; &gt; know what you think. 
&gt; 
&gt; This also looks very similar to the new logic added in ScriptContextSet.  In
&gt; both cases we:
&gt; Get the document url
&gt; if that&#39;s empty, check the data source url
&gt; if the data source url is non-empty and the frame can access it, use the data
&gt; source url
&gt; 
&gt; This makes me think we should probably have a method at least to do that -
&gt; something like GetAccessCheckedFrameURL() (strawman name) that we can use in
&gt; both places.  There may also be some uses of GetDataSourceURL that should be
&gt; converted to that, but we can do that separately.

Done.

<a href="https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/script_context.cc#newcode127" rel="nofollow">https://codereview.chromium.org/2208483002/diff/40001/extensions/renderer/scr...</a>
extensions/renderer/script_context.cc:127: if (url_.is_empty())
On 2016/08/03 16:16:49, Devlin wrote:
&gt; This can be an else, right?  Because we&#39;ll only set url_ above if weburl is
&gt; empty.

Good point - I guess it doesn&#39;t help to assign to url_ from an empty weburl.
But, obsoleted by switching to a method.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg14"
           name="13">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(13)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-13">
                          The CQ bit was checked by asargent@chromium.org to run a CQ dry run
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 05:49:52 UTC)
                <a href="#msg14">#14</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-13"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-13"
            >The CQ bit was checked by <a href="mailto:asargent@chromium.org">asargent@chromium.org</a> to run a CQ dry run</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg15"
           name="14">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(14)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-14">
                          Dry run: CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/80001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 05:50:16 UTC)
                <a href="#msg15">#15</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-14"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-14"
            >Dry run: CQ is trying da patch. Follow status at
 
<a href="https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/80001" rel="nofollow">https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.or...</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg16"
           name="15">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(15)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-15">
                          The CQ bit was unchecked by commit-bot@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 07:06:20 UTC)
                <a href="#msg16">#16</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-15"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-15"
            >The CQ bit was unchecked by <a href="mailto:commit-bot@chromium.org">commit-bot@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg17"
           name="16">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(16)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-16">
                          Dry run: This issue passed the CQ dry run.
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 07:06:22 UTC)
                <a href="#msg17">#17</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-16"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-16"
            >Dry run: This issue passed the CQ dry run.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg18"
           name="17">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(17)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Devlin</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-17">
                          lgtm
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 16:26:14 UTC)
                <a href="#msg18">#18</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-17"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-17"
            >lgtm</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg19"
           name="18">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(18)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asargent_no_longer_on_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-18">
                          The CQ bit was checked by asargent@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:11:55 UTC)
                <a href="#msg19">#19</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-18"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-18"
            >The CQ bit was checked by <a href="mailto:asargent@chromium.org">asargent@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg20"
           name="19">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(19)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-19">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/80001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:12:24 UTC)
                <a href="#msg20">#20</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-19"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-19"
            >CQ is trying da patch. Follow status at
 
<a href="https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.org/2208483002/80001" rel="nofollow">https://chromium-cq-status.appspot.com/v2/patch-status/codereview.chromium.or...</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   generated"
           style="display: none"
           id="generated-msg21"
           name="20">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(20)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-20">
                          Description was changed from ========== Fix extension bindings injection for iframes (reland) For iframes, we ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:17:31 UTC)
                <a href="#msg21">#21</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-20"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-20"
            >Description was changed from

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix. 

BUG=573131,630928
==========

to

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix. 

BUG=573131,630928
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg22"
           name="21">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(21)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-21">
                          Committed patchset #3 (id:80001)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:17:32 UTC)
                <a href="#msg22">#22</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-21"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-21"
            >Committed patchset #3 (id:80001)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   generated"
           style="display: none"
           id="generated-msg23"
           name="22">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(22)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-22">
                          Description was changed from ========== Fix extension bindings injection for iframes (reland) For iframes, we ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:20:32 UTC)
                <a href="#msg23">#23</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-22"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-22"
            >Description was changed from

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely 
indicates some kind of race condition in the test). I&#39;ve added a fix for 
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix. 

BUG=573131,630928
==========

to

==========
Fix extension bindings injection for iframes (reland)

For iframes, we don&#39;t want to use the source url for determining the
associated extension because it starts out with an about:blank context
that is scriptable by its parent.

This originally landed in codereview.chromium.org/2151693002/ but
was reverted because of bug 630928 as well as the test failing under
DrMemory (not with memory errors; just not succeeding which likely
indicates some kind of race condition in the test). I&#39;ve added a fix for
bug 630928 but haven&#39;t been able to locally reproduce the test failure
under DrMemory, so I&#39;ve added some extra logging to the test to hopefully
better understand what might be going wrong.

Memory sheriffs: If the FramesExtensionBindingsApiTest.FramesBeforeNavigation
test fails again without any actual memory errors, please do not revert the
entire CL (since it is an important security fix); instead just disable the
test or add it to a suppression file so I can iterate on a fix.

BUG=573131,630928

Committed: <a href="https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5" rel="nofollow">https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5</a>
Cr-Commit-Position: refs/heads/master@{#409819}
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg24"
           name="23">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(23)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-23">
                          Patchset 3 (id:??) landed as https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5 Cr-Commit-Position: refs/heads/master@{#409819}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 4 months ago
		(2016-08-04 17:20:33 UTC)
                <a href="#msg24">#24</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-23"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-23"
            >Patchset 3 (id:??) landed as
<a href="https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5" rel="nofollow">https://crrev.com/79b64c3e741cc9c6afbb23885945831a45c6baa5</a>
Cr-Commit-Position: refs/heads/master@{#409819}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 24)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 24)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(24)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(24)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 24;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 2208483002;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 2208483002: Fix extension bindings injection for iframes (reland)
     (Closed) </b><br/>
      Created 4 years, 4 months ago by asargent_no_longer_on_chrome<br/>
      Modified 4 years, 4 months ago<br/>
      Reviewers: Devlin<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 9
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
