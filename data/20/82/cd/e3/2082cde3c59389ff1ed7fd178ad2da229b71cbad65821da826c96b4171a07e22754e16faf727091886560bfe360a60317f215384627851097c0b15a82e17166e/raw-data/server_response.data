<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 1071063005: Fix heap-use-after-free issue with WebAudioCapturerSource. -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '90effb4d35f727fe4ec2f6e1a85cc7aa';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/1071063005%252526ust%25253D1608725197163915%252526usg%25253DAFQjCNGt9D--LVfSVW8-UIMWGjt9mU9Aww%26service%3Dah">Sign out</a>

</div>
<div class="counter">(406)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-1071063005">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/1071063005/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            1071063005</a>:
    Fix heap-use-after-free issue with WebAudioCapturerSource.  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            5 years, 8 months ago by <a href="/user/Guido%20Urdaneta" onMouseOver="M_showUserInfoPopup(this)">Guido Urdaneta</a>
          </div>
          <div><b>Modified:</b><br/>
            5 years, 8 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/perkj_chrome" onMouseOver="M_showUserInfoPopup(this)">perkj_chrome</a></span>, <span class='approval'><a href="/user/henrika%20(OOO%20until%20Aug%2014)" onMouseOver="M_showUserInfoPopup(this)">henrika (OOO until Aug 14)</a></span>, <a href="/user/Raymond%20Toy" onMouseOver="M_showUserInfoPopup(this)">Raymond Toy</a>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, mlamouri+watch-content_chromium.org, posciak+watch_chromium.org, jam, mcasas+watch_chromium.org, feature-media-reviews_chromium.org, darin-cc_chromium.org, mkwst+moarreviews-renderer_chromium.org, wjia+watch_chromium.org, tommi (sloooow) - chr√∂me
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Fix heap-use-after-free issue with WebAudioCapturerSource.

WebAudioCapturerSource registers with a blink WebMediaStreamSource.
When the audio track was stopped, the WebAudioCapturerSource was
destroyed and the WebMediaStreamSource was left with a dangling
pointer, which it tried to use, resulting in access to freed
memory and usually a crashed tab.

This CL makes WebAudioCapturerSource aware of the WebMediaStreamSource
with which it is registered, so that it can be deregistered when the
audio track is stopped.

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=473253">473253</a>
TEST=See testcase.html in crbug.com/473253

Committed: <a href="https://crrev.com/228cd9447121ede4d32ab48c8dfe066736cfdae2">https://crrev.com/228cd9447121ede4d32ab48c8dfe066736cfdae2</a>
Cr-Commit-Position: refs/heads/master@{#324622}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/1071063005/#ps1"
       onclick="M_toggleSectionForPS('1071063005', '1')"
       class="toggled-section ">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 2
      
    </div>
  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-20001-pointer"
       href="/1071063005/#ps20001"
       onclick="M_toggleSectionForPS('1071063005', '20001')"
       class="toggled-section ">
      Patch Set 2
      : Minor style fix
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-20001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-40001-pointer"
       href="/1071063005/#ps40001"
       onclick="M_toggleSectionForPS('1071063005', '40001')"
       class="toggled-section ">
      Patch Set 3
      : Improvements in comments, as suggested by henrika@
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-40001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-60001-pointer"
       href="/1071063005/#ps60001"
       onclick="M_toggleSectionForPS('1071063005', '60001')"
       class="toggled-section ">
      Patch Set 4
      : Improvements in the comments, as suggested by henrika@
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 1
      
    </div>
  

  <div id="ps-60001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-80001-pointer"
       href="/1071063005/#ps80001"
       onclick="M_toggleSectionForPS('1071063005', '80001')"
       class="toggled-section opentriangle">
      Patch Set 5
      : Add thread check to WebAudioCapturerSourcer destructor
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-80001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 5 years, 8 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue1071063005_80001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/1071063005/80001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+31 lines, -4 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1071063005/patch/80001/90002">
            content/renderer/media/webaudio_capturer_source.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1071063005/diff/80001/content/renderer/media/webaudio_capturer_source.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1071063005/diff2/1:80001/content/renderer/media/webaudio_capturer_source.h"
             title="Delta from patch set 1">1</a>
        
          <a href="/1071063005/diff2/20001:80001/content/renderer/media/webaudio_capturer_source.h"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">4 chunks</td>
          <td style="white-space: nowrap">+11 lines, -1 line</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1071063005_80001_90002.diff"
             title="Download patch for content/renderer/media/webaudio_capturer_source.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1071063005/patch/80001/90001">
            content/renderer/media/webaudio_capturer_source.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1071063005/diff/80001/content/renderer/media/webaudio_capturer_source.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1071063005/diff2/1:80001/content/renderer/media/webaudio_capturer_source.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/1071063005/diff2/20001:80001/content/renderer/media/webaudio_capturer_source.cc"
             title="Delta from patch set 2">2</a>
        
          <a href="/1071063005/diff2/40001:80001/content/renderer/media/webaudio_capturer_source.cc"
             title="Delta from patch set 3">3</a>
        
          <a href="/1071063005/diff2/60001:80001/content/renderer/media/webaudio_capturer_source.cc"
             title="Delta from patch set 4">4</a>
        
        </td>
        
          <td style="white-space: nowrap">3 chunks</td>
          <td style="white-space: nowrap">+19 lines, -2 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1071063005_80001_90001.diff"
             title="Download patch for content/renderer/media/webaudio_capturer_source.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1071063005/patch/80001/90003">
            content/renderer/media/webrtc/peer_connection_dependency_factory.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1071063005/diff/80001/content/renderer/media/webrtc/peer_connection_dependency_factory.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+1 line, -1 line</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1071063005_80001_90003.diff"
             title="Download patch for content/renderer/media/webrtc/peer_connection_dependency_factory.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 80001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 14 (4 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 14)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 14)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(14)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(14)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          guidou@chromium.org changed reviewers: + henrika@chromium.org, perkj@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 11:28:48 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            ><a href="mailto:guidou@chromium.org">guidou@chromium.org</a> changed reviewers:
+ <a href="mailto:henrika@chromium.org">henrika@chromium.org</a>, <a href="mailto:perkj@chromium.org">perkj@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 11:46:49 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            ></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>henrika (OOO until Aug 14)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          henrika@chromium.org changed reviewers: + rtoy@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 11:48:22 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            ><a href="mailto:henrika@chromium.org">henrika@chromium.org</a> changed reviewers:
+ <a href="mailto:rtoy@chromium.org">rtoy@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>henrika (OOO until Aug 14)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          Nice work Guido. Some initial comments. https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.cc File content/renderer/media/webaudio_capturer_source.cc (right): https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.cc#newcode123 content/renderer/media/webaudio_capturer_source.cc:123: void WebAudioCapturerSource::removeFromBlinkSource() { ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 11:53:40 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            >Nice work Guido. Some initial comments.

<a href="https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.cc" rel="nofollow">https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/weba...</a>
File content/renderer/media/webaudio_capturer_source.cc (right):

<a href="https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.cc#newcode123" rel="nofollow">https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/weba...</a>
content/renderer/media/webaudio_capturer_source.cc:123: void
WebAudioCapturerSource::removeFromBlinkSource() {
Can you add some comments about what happens here exactly. And why it is needed.

<a href="https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.h" rel="nofollow">https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/weba...</a>
File content/renderer/media/webaudio_capturer_source.h (right):

<a href="https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/webaudio_capturer_source.h#newcode58" rel="nofollow">https://codereview.chromium.org/1071063005/diff/1/content/renderer/media/weba...</a>
content/renderer/media/webaudio_capturer_source.h:58: // This method removes
this object from a blink::WebMediaStreamSource with
Nit, Removes this object...</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          Note that I added a private method to WebAudioCapturerSource to deregister the WebAudioCapturerSource from blink, ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 13:10:54 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >Note that I added a private method to WebAudioCapturerSource to deregister the
WebAudioCapturerSource from blink, but I didn&#39;t add any method to register it
with the blink object.
I changed the constructor so that it receives a reference to the blink object,
but I left the registration exactly as it was in
PeerConnectionDependencyFactory::CreateWebAudioSource().
I did it that way in order to alter the existing code as little as possible. 

Do you think guys think this approach is OK, or would it be better to approach
it differently? For example, having a public method addToBlinkSource() that
takes the blink source and adds the WebAudioCapturerSource to it instead of
doing the registration in
PeerConnectionDependencyFactory::CreateWebAudioSource().</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>henrika (OOO until Aug 14)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          I think perkj@ is more suitable to answer your question. If your version solves the ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 13:16:34 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            >I think perkj@ is more suitable to answer your question. If your version solves
the problem I am fine as is.

LGTM</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>perkj_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc File content/renderer/media/webaudio_capturer_source.cc (right): https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc#newcode30 content/renderer/media/webaudio_capturer_source.cc:30: removeFromBlinkSource(); On what thread is this object destroyed? I ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-09 14:55:49 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            ><a href="https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc" rel="nofollow">https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/...</a>
File content/renderer/media/webaudio_capturer_source.cc (right):

<a href="https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc#newcode30" rel="nofollow">https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/...</a>
content/renderer/media/webaudio_capturer_source.cc:30: removeFromBlinkSource();
On what thread is this object destroyed? I don&#39;t think you can call
removeAudioConsumer(this) from other threads than the main thread.

If it is only ever just one thread add  
DCHECK(thread_checker_.CalledOnValidThread());</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          On 2015/04/09 14:55:49, perkj wrote: &gt; https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc &gt; File content/renderer/media/webaudio_capturer_source.cc (right): &gt; &gt; https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc#newcode30 &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 10:56:38 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            >On 2015/04/09 14:55:49, perkj wrote:
&gt;
<a href="https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc" rel="nofollow">https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/...</a>
&gt; File content/renderer/media/webaudio_capturer_source.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/webaudio_capturer_source.cc#newcode30" rel="nofollow">https://codereview.chromium.org/1071063005/diff/60001/content/renderer/media/...</a>
&gt; content/renderer/media/webaudio_capturer_source.cc:30:
removeFromBlinkSource();
&gt; On what thread is this object destroyed? I don&#39;t think you can call
&gt; removeAudioConsumer(this) from other threads than the main thread.
&gt; 
&gt; If it is only ever just one thread add  
&gt; DCHECK(thread_checker_.CalledOnValidThread());

I checked destruction via the JavaScript GC and it occurs on the main thread
(just like explicitly calling the stop() JavaScript method) so the DCHECK works.
Moreover, in the GC case, the object is destroyed anyway by a call to the Stop()
method. Stop() in this case is invoked by the destructor of
WebRtcLocalAudioTrack, which owns the WebAudioCapturerSource. That destructor
also has a DCHECK to ensure execution in the main thread.

In a separate patch I also made WebAudioCapturerSource a scoped_ptr instead of a
scoped_refptr. It seems to work, but it&#39;s not really necessary to fix this bug.
Should I integrate it in this patch?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>perkj_chrome</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          thanks lgtm I think you should keep the cls separate.
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 12:31:55 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >thanks
lgtm
I think you should keep the cls separate.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          The CQ bit was checked by guidou@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 12:57:22 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-9"
            >The CQ bit was checked by <a href="mailto:guidou@chromium.org">guidou@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Guido Urdaneta</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          The patchset sent to the CQ was uploaded after l-g-t-m from henrika@chromium.org Link to the ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 12:57:22 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-10"
            >The patchset sent to the CQ was uploaded after l-g-t-m from <a href="mailto:henrika@chromium.org">henrika@chromium.org</a>
Link to the patchset: <a href="https://codereview.chromium.org/1071063005/#ps80001" rel="nofollow">https://codereview.chromium.org/1071063005/#ps80001</a>
(title: &quot;Add thread check to WebAudioCapturerSourcer destructor&quot;)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-11">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/patch-status/1071063005/80001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 12:57:56 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-11"
            >CQ is trying da patch. Follow status at
 <a href="https://chromium-cq-status.appspot.com/patch-status/1071063005/80001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-status/1071063005/80001</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg13"
           name="12">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(12)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-12">
                          Committed patchset #5 (id:80001)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 13:00:47 UTC)
                <a href="#msg13">#13</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-12"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-12"
            >Committed patchset #5 (id:80001)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg14"
           name="13">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(13)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-13">
                          Patchset 5 (id:??) landed as https://crrev.com/228cd9447121ede4d32ab48c8dfe066736cfdae2 Cr-Commit-Position: refs/heads/master@{#324622}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 8 months ago
		(2015-04-10 13:01:39 UTC)
                <a href="#msg14">#14</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-13"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-13"
            >Patchset 5 (id:??) landed as
<a href="https://crrev.com/228cd9447121ede4d32ab48c8dfe066736cfdae2" rel="nofollow">https://crrev.com/228cd9447121ede4d32ab48c8dfe066736cfdae2</a>
Cr-Commit-Position: refs/heads/master@{#324622}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 14)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 14)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(14)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(14)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 14;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 1071063005;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 1071063005: Fix heap-use-after-free issue with WebAudioCapturerSource.
     (Closed) </b><br/>
      Created 5 years, 8 months ago by Guido Urdaneta<br/>
      Modified 5 years, 8 months ago<br/>
      Reviewers: perkj_chrome, henrika (OOO until Aug 14), Raymond Toy<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 3
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
