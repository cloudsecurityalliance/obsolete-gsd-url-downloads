<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 769043003: Sanitize headers in Proxy Authentication Required responses -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '48ee3c7d4f9dfba182a05c3441d5e4bc';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/769043003%252526ust%25253D1608713173368078%252526usg%25253DAFQjCNHvkGdkSqOqvbFFnV8KeggMSsDtKA%26service%3Dah">Sign out</a>

</div>
<div class="counter">(958)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-769043003">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/769043003/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            769043003</a>:
    Sanitize headers in Proxy Authentication Required responses  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            6 years ago by <a href="/user/Deprecated%20(see%20juliatuttle)" onMouseOver="M_showUserInfoPopup(this)">Deprecated (see juliatuttle)</a>
          </div>
          <div><b>Modified:</b><br/>
            5 years, 11 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/asanka" onMouseOver="M_showUserInfoPopup(this)">asanka</a></span>, <span class='approval'><a href="/user/Ryan%20Hamilton" onMouseOver="M_showUserInfoPopup(this)">Ryan Hamilton</a></span>, <span class='approval'><a href="/user/Ryan%20Sleevi" onMouseOver="M_showUserInfoPopup(this)">Ryan Sleevi</a></span>
          </div>
          
          <div><b>CC:</b><br/>
            cbentzel+watch_chromium.org, chromium-reviews
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Sanitize headers in Proxy Authentication Required responses

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=431504">431504</a>
Committed: <a href="https://crrev.com/7933c117fd16b192e70609c331641e9112af5e42">https://crrev.com/7933c117fd16b192e70609c331641e9112af5e42</a>
Cr-Commit-Position: refs/heads/master@{#310014}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/769043003/#ps1"
       onclick="M_toggleSectionForPS('769043003', '1')"
       class="toggled-section ">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-20001-pointer"
       href="/769043003/#ps20001"
       onclick="M_toggleSectionForPS('769043003', '20001')"
       class="toggled-section ">
      Patch Set 2
      : Rearrange some things
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 4
      
    </div>
  

  <div id="ps-20001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-40001-pointer"
       href="/769043003/#ps40001"
       onclick="M_toggleSectionForPS('769043003', '40001')"
       class="toggled-section ">
      Patch Set 3
      : Fix unittests
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-40001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-60001-pointer"
       href="/769043003/#ps60001"
       onclick="M_toggleSectionForPS('769043003', '60001')"
       class="toggled-section ">
      Patch Set 4
      : Fix net_unittests
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 24
      
    </div>
  

  <div id="ps-60001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-80001-pointer"
       href="/769043003/#ps80001"
       onclick="M_toggleSectionForPS('769043003', '80001')"
       class="toggled-section ">
      Patch Set 5
      :  
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 2
      
    </div>
  

  <div id="ps-80001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-100001-pointer"
       href="/769043003/#ps100001"
       onclick="M_toggleSectionForPS('769043003', '100001')"
       class="toggled-section ">
      Patch Set 6
      : Don&#39;t concatenate multiple Proxy-Auth headers
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-100001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-120001-pointer"
       href="/769043003/#ps120001"
       onclick="M_toggleSectionForPS('769043003', '120001')"
       class="toggled-section ">
      Patch Set 7
      : Make code actually compile :D
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-120001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-140001-pointer"
       href="/769043003/#ps140001"
       onclick="M_toggleSectionForPS('769043003', '140001')"
       class="toggled-section ">
      Patch Set 8
      : Fix Keep-Alive
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-140001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-160001-pointer"
       href="/769043003/#ps160001"
       onclick="M_toggleSectionForPS('769043003', '160001')"
       class="toggled-section ">
      Patch Set 9
      : Fix other unit test cases
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-160001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-180001-pointer"
       href="/769043003/#ps180001"
       onclick="M_toggleSectionForPS('769043003', '180001')"
       class="toggled-section ">
      Patch Set 10
      : Add a couple EXPECTs back
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 3
      
    </div>
  

  <div id="ps-180001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-200001-pointer"
       href="/769043003/#ps200001"
       onclick="M_toggleSectionForPS('769043003', '200001')"
       class="toggled-section ">
      Patch Set 11
      : Add test case for sanitizing proxy auth headers
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-200001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-220001-pointer"
       href="/769043003/#ps220001"
       onclick="M_toggleSectionForPS('769043003', '220001')"
       class="toggled-section ">
      Patch Set 12
      : rebase
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 5
      
    </div>
  

  <div id="ps-220001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-240001-pointer"
       href="/769043003/#ps240001"
       onclick="M_toggleSectionForPS('769043003', '240001')"
       class="toggled-section ">
      Patch Set 13
      : reformat something
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 12
      
    </div>
  

  <div id="ps-240001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-260001-pointer"
       href="/769043003/#ps260001"
       onclick="M_toggleSectionForPS('769043003', '260001')"
       class="toggled-section ">
      Patch Set 14
      : rebase and fix codereview issues
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 2
      
    </div>
  

  <div id="ps-260001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-280001-pointer"
       href="/769043003/#ps280001"
       onclick="M_toggleSectionForPS('769043003', '280001')"
       class="toggled-section opentriangle">
      Patch Set 15
      : Fix sleevi&#39;s nit
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-280001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 5 years, 11 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue769043003_280001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/769043003/280001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+150 lines, -44 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/769043003/patch/280001/290001">
            net/http/http_network_transaction_unittest.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/769043003/diff/280001/net/http/http_network_transaction_unittest.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/769043003/diff2/1:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/769043003/diff2/20001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 2">2</a>
        
          <a href="/769043003/diff2/40001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 3">3</a>
        
          <a href="/769043003/diff2/60001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 4">4</a>
        
          <a href="/769043003/diff2/80001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 5">5</a>
        
          <a href="/769043003/diff2/100001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 6">6</a>
        
          <a href="/769043003/diff2/120001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 7">7</a>
        
          <a href="/769043003/diff2/140001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 8">8</a>
        
          <a href="/769043003/diff2/160001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 9">9</a>
        
          <a href="/769043003/diff2/180001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 10">10</a>
        
          <a href="/769043003/diff2/200001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 11">11</a>
        
          <a href="/769043003/diff2/220001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 12">12</a>
        
          <a href="/769043003/diff2/240001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 13">13</a>
        
          <a href="/769043003/diff2/260001:280001/net/http/http_network_transaction_unittest.cc"
             title="Delta from patch set 14">14</a>
        
        </td>
        
          <td style="white-space: nowrap">4 chunks</td>
          <td style="white-space: nowrap">+75 lines, -12 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue769043003_280001_290001.diff"
             title="Download patch for net/http/http_network_transaction_unittest.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/769043003/patch/280001/290002">
            net/http/http_proxy_client_socket.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/769043003/diff/280001/net/http/http_proxy_client_socket.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/769043003/diff2/1:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/769043003/diff2/20001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 2">2</a>
        
          <a href="/769043003/diff2/40001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 3">3</a>
        
          <a href="/769043003/diff2/60001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 4">4</a>
        
          <a href="/769043003/diff2/80001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 5">5</a>
        
          <a href="/769043003/diff2/100001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 6">6</a>
        
          <a href="/769043003/diff2/120001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 7">7</a>
        
          <a href="/769043003/diff2/140001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 8">8</a>
        
          <a href="/769043003/diff2/160001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 9">9</a>
        
          <a href="/769043003/diff2/180001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 10">10</a>
        
          <a href="/769043003/diff2/200001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 11">11</a>
        
          <a href="/769043003/diff2/220001:280001/net/http/http_proxy_client_socket.cc"
             title="Delta from patch set 12">12</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+13 lines, -11 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue769043003_280001_290002.diff"
             title="Download patch for net/http/http_proxy_client_socket.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/769043003/patch/280001/290004">
            net/http/proxy_client_socket.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/769043003/diff/280001/net/http/proxy_client_socket.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+9 lines, -3 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue769043003_280001_290004.diff"
             title="Download patch for net/http/proxy_client_socket.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/769043003/patch/280001/290003">
            net/http/proxy_client_socket.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/769043003/diff/280001/net/http/proxy_client_socket.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/769043003/diff2/1:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/769043003/diff2/20001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 2">2</a>
        
          <a href="/769043003/diff2/40001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 3">3</a>
        
          <a href="/769043003/diff2/60001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 4">4</a>
        
          <a href="/769043003/diff2/80001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 5">5</a>
        
          <a href="/769043003/diff2/100001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 6">6</a>
        
          <a href="/769043003/diff2/120001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 7">7</a>
        
          <a href="/769043003/diff2/140001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 8">8</a>
        
          <a href="/769043003/diff2/160001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 9">9</a>
        
          <a href="/769043003/diff2/180001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 10">10</a>
        
          <a href="/769043003/diff2/200001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 11">11</a>
        
          <a href="/769043003/diff2/220001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 12">12</a>
        
          <a href="/769043003/diff2/240001:280001/net/http/proxy_client_socket.cc"
             title="Delta from patch set 13">13</a>
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+41 lines, -10 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue769043003_280001_290003.diff"
             title="Download patch for net/http/proxy_client_socket.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/769043003/patch/280001/290005">
            net/spdy/spdy_proxy_client_socket.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/769043003/diff/280001/net/spdy/spdy_proxy_client_socket.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/769043003/diff2/1:280001/net/spdy/spdy_proxy_client_socket.cc"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+12 lines, -8 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue769043003_280001_290005.diff"
             title="Download patch for net/spdy/spdy_proxy_client_socket.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 280001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 46 (2 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 46)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 46)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(46)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(46)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          ttuttle@chromium.org changed reviewers: + asanka@chromium.org, rch@chromium.org, rsleevi@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-01 21:17:19 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            ><a href="mailto:ttuttle@chromium.org">ttuttle@chromium.org</a> changed reviewers:
+ <a href="mailto:asanka@chromium.org">asanka@chromium.org</a>, <a href="mailto:rch@chromium.org">rch@chromium.org</a>, <a href="mailto:rsleevi@chromium.org">rsleevi@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          PTAL, folks.
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-01 21:17:20 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            >PTAL, folks.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78 net/http/proxy_client_socket.cc:78: return true; I have trouble convincing myself a blacklist ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-01 21:28:49 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            ><a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:78: return true;
I have trouble convincing myself a blacklist is the right approach here.

Why can you not strip out ALL headers except for WWW-Authenticate?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          Should we have test coverage for this new behavior? https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78 net/http/proxy_client_socket.cc:78: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 01:50:53 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            >Should we have test coverage for this new behavior?

<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:78: return true;
On 2014/12/01 21:28:49, Ryan Sleevi wrote:
&gt; I have trouble convincing myself a blacklist is the right approach here.
&gt; 
&gt; Why can you not strip out ALL headers except for WWW-Authenticate?

Sounds reasonable! You probably want Proxy-Authenticate, though, right?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asanka</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          Could someone +cc me on the bug? On 2014/12/02 01:50:53, Ryan Hamilton wrote: &gt; Should ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 19:55:28 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >Could someone +cc me on the bug?

On 2014/12/02 01:50:53, Ryan Hamilton wrote:
&gt; Should we have test coverage for this new behavior?

+1

&gt;
<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
&gt; File net/http/proxy_client_socket.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
&gt; net/http/proxy_client_socket.cc:78: return true;
&gt; On 2014/12/01 21:28:49, Ryan Sleevi wrote:
&gt; &gt; I have trouble convincing myself a blacklist is the right approach here.
&gt; &gt; 
&gt; &gt; Why can you not strip out ALL headers except for WWW-Authenticate?
&gt; 
&gt; Sounds reasonable! You probably want Proxy-Authenticate, though, right?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          On Tue, Dec 2, 2014 at 11:55 AM, &lt;asanka@chromium.org&gt; wrote: &gt; Could someone +cc me ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 20:01:53 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            >On Tue, Dec 2, 2014 at 11:55 AM, &lt;<a href="mailto:asanka@chromium.org">asanka@chromium.org</a>&gt; wrote:

&gt; Could someone +cc me on the bug?
&gt;

​Done​

To unsubscribe from this group and stop receiving emails from it, send an email
to <a href="mailto:chromium-reviews+unsubscribe@chromium.org">chromium-reviews+unsubscribe@chromium.org</a>.
</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78 net/http/proxy_client_socket.cc:78: return true; On 2014/12/02 01:50:52, Ryan Hamilton wrote: &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 20:10:21 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            ><a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:78: return true;
On 2014/12/02 01:50:52, Ryan Hamilton wrote:
&gt; On 2014/12/01 21:28:49, Ryan Sleevi wrote:
&gt; &gt; I have trouble convincing myself a blacklist is the right approach here.
&gt; &gt; 
&gt; &gt; Why can you not strip out ALL headers except for WWW-Authenticate?
&gt; 
&gt; Sounds reasonable! You probably want Proxy-Authenticate, though, right?

Yeah, agreed.

Is there a way that is more efficient than RemoveHeader-ing each of the
non-Proxy-Authenticate headers (which is O(n^2)) and less kludgey than
reassembling new fake raw headers with just the Proxy-Authenticate header?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78 net/http/proxy_client_socket.cc:78: return true; On 2014/12/02 20:10:21, ttuttle wrote: &gt; On ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 20:14:25 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            ><a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_socket.cc#newcode78" rel="nofollow">https://codereview.chromium.org/769043003/diff/20001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:78: return true;
On 2014/12/02 20:10:21, ttuttle wrote:
&gt; On 2014/12/02 01:50:52, Ryan Hamilton wrote:
&gt; &gt; On 2014/12/01 21:28:49, Ryan Sleevi wrote:
&gt; &gt; &gt; I have trouble convincing myself a blacklist is the right approach here.
&gt; &gt; &gt; 
&gt; &gt; &gt; Why can you not strip out ALL headers except for WWW-Authenticate?
&gt; &gt; 
&gt; &gt; Sounds reasonable! You probably want Proxy-Authenticate, though, right?
&gt; 
&gt; Yeah, agreed.
&gt; 
&gt; Is there a way that is more efficient than RemoveHeader-ing each of the
&gt; non-Proxy-Authenticate headers (which is O(n^2)) and less kludgey than
&gt; reassembling new fake raw headers with just the Proxy-Authenticate header?

As far as kludges go, the &quot;assemble new fake raw headers&quot; seems to be pretty
simple. Since it&#39;s what&#39;s done in SanitizeProxyRedirect, that seems like a good
approach to me.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asanka</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          I&#39;m good with sanitizing the response headers, but is there also an underlying problem where ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 20:29:01 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >I&#39;m good with sanitizing the response headers, but is there also an underlying
problem where the proxy tunnel response isn&#39;t distinguished from a server
response? I feel like sanitization shouldn&#39;t be necessary although it wouldn&#39;t
hurt.

I&#39;m not too worried about the proxy + HTTP (i.e. non-tunnel) case.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          On 2014/12/02 20:29:01, asanka wrote: &gt; I&#39;m good with sanitizing the response headers, but is ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 21:16:16 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-9"
            >On 2014/12/02 20:29:01, asanka wrote:
&gt; I&#39;m good with sanitizing the response headers, but is there also an underlying
&gt; problem where the proxy tunnel response isn&#39;t distinguished from a server
&gt; response? I feel like sanitization shouldn&#39;t be necessary although it wouldn&#39;t
&gt; hurt.
&gt; 
&gt; I&#39;m not too worried about the proxy + HTTP (i.e. non-tunnel) case.

In the non-tunnel case, the proxy totally 0wn the response. It writes the
response body and headers. If the proxy is malicious, you&#39;re totally screwed and
there is nothing that can be done. &quot;Thankfully&quot; HTTP is totally insecure so
anyone on your network also totally 0wns your http responses :&gt;</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          On 2014/12/02 21:16:16, Ryan Hamilton wrote: &gt; On 2014/12/02 20:29:01, asanka wrote: &gt; &gt; I&#39;m ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 21:25:03 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-10"
            >On 2014/12/02 21:16:16, Ryan Hamilton wrote:
&gt; On 2014/12/02 20:29:01, asanka wrote:
&gt; &gt; I&#39;m good with sanitizing the response headers, but is there also an
underlying
&gt; &gt; problem where the proxy tunnel response isn&#39;t distinguished from a server
&gt; &gt; response? I feel like sanitization shouldn&#39;t be necessary although it
wouldn&#39;t
&gt; &gt; hurt.
&gt; &gt; 
&gt; &gt; I&#39;m not too worried about the proxy + HTTP (i.e. non-tunnel) case.
&gt; 
&gt; In the non-tunnel case, the proxy totally 0wn the response. It writes the
&gt; response body and headers. If the proxy is malicious, you&#39;re totally screwed
and
&gt; there is nothing that can be done. &quot;Thankfully&quot; HTTP is totally insecure so
&gt; anyone on your network also totally 0wns your http responses :&gt;

Oh, you said &quot;not worried&quot;. *facepalm*</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-11">
                          On 2014/12/02 21:25:03, Ryan Hamilton wrote: &gt; On 2014/12/02 21:16:16, Ryan Hamilton wrote: &gt; &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 21:52:27 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-11"
            >On 2014/12/02 21:25:03, Ryan Hamilton wrote:
&gt; On 2014/12/02 21:16:16, Ryan Hamilton wrote:
&gt; &gt; On 2014/12/02 20:29:01, asanka wrote:
&gt; &gt; &gt; I&#39;m good with sanitizing the response headers, but is there also an
&gt; underlying
&gt; &gt; &gt; problem where the proxy tunnel response isn&#39;t distinguished from a server
&gt; &gt; &gt; response? I feel like sanitization shouldn&#39;t be necessary although it
&gt; wouldn&#39;t
&gt; &gt; &gt; hurt.
&gt; &gt; &gt; 
&gt; &gt; &gt; I&#39;m not too worried about the proxy + HTTP (i.e. non-tunnel) case.
&gt; &gt; 
&gt; &gt; In the non-tunnel case, the proxy totally 0wn the response. It writes the
&gt; &gt; response body and headers. If the proxy is malicious, you&#39;re totally screwed
&gt; and
&gt; &gt; there is nothing that can be done. &quot;Thankfully&quot; HTTP is totally insecure so
&gt; &gt; anyone on your network also totally 0wns your http responses :&gt;
&gt; 
&gt; Oh, you said &quot;not worried&quot;. *facepalm*

Everything is beautiful except for one spot in HttpNetworkTransaction that
deliberately undermines the separation between the layers.

I made a simple attempt at sanitizing the response by creating new raw headers,
but a bunch of unit tests are failing because I&#39;ve mangled things like
keep-alive headers and prevented us from displaying the proxy error pages in
cases where we expected to see them. Is it okay if I change these for the new
expected behavior? Does anyone see any repercussions that I might not?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg13"
           name="12">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(12)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-12">
                          I am long on the record of thinking that displaying proxy error pages over HTTPS ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 22:00:02 UTC)
                <a href="#msg13">#13</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-12"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-12"
            >I am long on the record of thinking that displaying proxy error pages over
HTTPS is bad news bears. But I have lost that battle long, long ago.

It is a Chrome-specific, non-standard behavior (e.g. FF doesn&#39;t do it for
their HTTPS proxies), so I say break any of that at will, and make the
proxies - which I think are just Google&#39;s internal corporate proxies -
learn to suck it up and work around it :)

(It can totally break things like content encoding, SDCH, etc if the proxy
uses these. To that, I say, &quot;too bad&quot;!)
On Dec 2, 2014 9:52 PM, &lt;<a href="mailto:ttuttle@chromium.org">ttuttle@chromium.org</a>&gt; wrote:

&gt; On 2014/12/02 21:25:03, Ryan Hamilton wrote:
&gt;
&gt;&gt; On 2014/12/02 21:16:16, Ryan Hamilton wrote:
&gt;&gt; &gt; On 2014/12/02 20:29:01, asanka wrote:
&gt;&gt; &gt; &gt; I&#39;m good with sanitizing the response headers, but is there also an
&gt;&gt; underlying
&gt;&gt; &gt; &gt; problem where the proxy tunnel response isn&#39;t distinguished from a
&gt;&gt; server
&gt;&gt; &gt; &gt; response? I feel like sanitization shouldn&#39;t be necessary although it
&gt;&gt; wouldn&#39;t
&gt;&gt; &gt; &gt; hurt.
&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt; I&#39;m not too worried about the proxy + HTTP (i.e. non-tunnel) case.
&gt;&gt; &gt;
&gt;&gt; &gt; In the non-tunnel case, the proxy totally 0wn the response. It writes
&gt;&gt; the
&gt;&gt; &gt; response body and headers. If the proxy is malicious, you&#39;re totally
&gt;&gt; screwed
&gt;&gt; and
&gt;&gt; &gt; there is nothing that can be done. &quot;Thankfully&quot; HTTP is totally
&gt;&gt; insecure so
&gt;&gt; &gt; anyone on your network also totally 0wns your http responses :&gt;
&gt;&gt;
&gt;
&gt;  Oh, you said &quot;not worried&quot;. *facepalm*
&gt;&gt;
&gt;
&gt; Everything is beautiful except for one spot in HttpNetworkTransaction that
&gt; deliberately undermines the separation between the layers.
&gt;
&gt; I made a simple attempt at sanitizing the response by creating new raw
&gt; headers,
&gt; but a bunch of unit tests are failing because I&#39;ve mangled things like
&gt; keep-alive headers and prevented us from displaying the proxy error pages
&gt; in
&gt; cases where we expected to see them. Is it okay if I change these for the
&gt; new
&gt; expected behavior? Does anyone see any repercussions that I might not?
&gt;
&gt; <a href="https://codereview.chromium.org/769043003/" rel="nofollow">https://codereview.chromium.org/769043003/</a>
&gt;

To unsubscribe from this group and stop receiving emails from it, send an email
to <a href="mailto:chromium-reviews+unsubscribe@chromium.org">chromium-reviews+unsubscribe@chromium.org</a>.
</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg14"
           name="13">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(13)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-13">
                          On Tue, Dec 2, 2014 at 2:00 PM, Ryan Sleevi &lt;rsleevi@chromium.org&gt; wrote: &gt; I am ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 22:22:25 UTC)
                <a href="#msg14">#14</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-13"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-13"
            >On Tue, Dec 2, 2014 at 2:00 PM, Ryan Sleevi &lt;<a href="mailto:rsleevi@chromium.org">rsleevi@chromium.org</a>&gt; wrote:

&gt; I am long on the record of thinking that displaying proxy error pages over
&gt; HTTPS is bad news bears. But I have lost that battle long, long ago.
&gt;
​I thought that while you may have initially lost that battle that you
subsequently won the rematch :&gt; Specifically, we no longer display proxy
errors for tunnel requests. We do follow 302s and of course we do handle
407s. But I think that, as this bug suggests, we handle 407s buggily. Do
you think we&#39;re still displaying proxy error pages in some codepath?

&gt; It is a Chrome-specific, non-standard behavior (e.g. FF doesn&#39;t do it for
&gt; their HTTPS proxies), so I say break any of that at will, and make the
&gt; proxies - which I think are just Google&#39;s internal corporate proxies -
&gt; learn to suck it up and work around it :)
&gt;
​Pretty sure they already did :&gt;​

&gt; (It can totally break things like content encoding, SDCH, etc if the proxy
&gt; uses these. To that, I say, &quot;too bad&quot;!)
&gt;
​Hear! Hear!​

To unsubscribe from this group and stop receiving emails from it, send an email
to <a href="mailto:chromium-reviews+unsubscribe@chromium.org">chromium-reviews+unsubscribe@chromium.org</a>.
</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg15"
           name="14">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(14)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-14">
                          Following up from an IM conversation, I believe this CL from ttutle (2 years ago) ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-02 22:43:41 UTC)
                <a href="#msg15">#15</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-14"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-14"
            >Following up from an IM conversation, I believe this CL from ttutle (2
years ago) removed the &quot;bad news bears&quot; code.

<a href="https://chromiumcodereview.appspot.com/10825030" rel="nofollow">https://chromiumcodereview.appspot.com/10825030</a>

If I had noticed the potential problem with 407s, that CL would have been a
good time to fix this bug too.

To unsubscribe from this group and stop receiving emails from it, send an email
to <a href="mailto:chromium-reviews+unsubscribe@chromium.org">chromium-reviews+unsubscribe@chromium.org</a>.
</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg16"
           name="15">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(15)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-15">
                          Okay, I&#39;ve patched the unittests for the new expectations (no response body, and ERR_TUNNEL_CONNECTION_FAILED instead ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-08 21:50:13 UTC)
                <a href="#msg16">#16</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-15"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-15"
            >Okay, I&#39;ve patched the unittests for the new expectations (no response body, and
ERR_TUNNEL_CONNECTION_FAILED instead of OK or ERR_PROXY_AUTH_UNSUPPORTED if you
try to read the body).

PTAL everyone.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg17"
           name="16">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(16)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-16">
                          I did some RFC confirmation (re: Proxy-Authenticate), but rch@ may be more familiar on the ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-08 22:04:40 UTC)
                <a href="#msg17">#17</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-16"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-16"
            >I did some RFC confirmation (re: Proxy-Authenticate), but rch@ may be more
familiar on the HTTP/1.1 response issue I call out below. Note that asanka@
should check out the comment I left on the unit test.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when
setting up an SSL tunnel.
Is my reading of your deletion of this test correct, in that we no longer use
the same proxy connection for multiple auth leg exchanges?

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode487" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:487: // We&#39;re not using an HTTPS proxy, or
we couldn&#39;t sanitize the redirect.
nit: &quot;Pronouns in Comments considered harmful&quot; -
<a href="https://groups.google.com/a/chromium.org/d/topic/chromium-dev/NH-S6KCkr2M/discussion" rel="nofollow">https://groups.google.com/a/chromium.org/d/topic/chromium-dev/NH-S6KCkr2M/dis...</a>

That said, this comment describes the code, which violates
<a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.html#Implementation_Comments" rel="nofollow">http://google-styleguide.googlecode.com/svn/trunk/cppguide.html#Implementatio...</a>

(That is, the if conditional says exactly what your plain english comment is
saying). So delete this comment.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode84" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:84: // ...but not more than one.
BUG: This is NOT required by the spec. Per RFC 7235, Proxy-Authenticate follows
the &lt;n&gt;&lt;m&gt;#list form
(see <a href="https://tools.ietf.org/html/rfc7235#section-4.3" rel="nofollow">https://tools.ietf.org/html/rfc7235#section-4.3</a> )

See also <a href="https://tools.ietf.org/html/rfc7230#section-7" rel="nofollow">https://tools.ietf.org/html/rfc7230#section-7</a> and
<a href="https://tools.ietf.org/html/rfc7230#section-3.2.2" rel="nofollow">https://tools.ietf.org/html/rfc7230#section-3.2.2</a>

Namely, a sender MAY take a #list and send across multiple headers. And the
client MAY coalesce.

So the right way to do it is to enumerate all of the header values, join them
into a single comma-separated value, and use that as the synthetic
Proxy-Authenticate response.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:111: &quot;HTTP/1.1 302 Found\n&quot;
Note: While this may seem trivial, it&#39;s going to require someone to go back to
the HTTP/1.1 spec and ensure our response is a fully conformant 1.1 response.
There are difference in requirements for requests (e.g. 1.1 requests MUST have a
Host header), and I haven&#39;t checked if 1.1 responses have similar requirements.

This may be the correct thing to do, but a reviewer needs to vet this is true.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg18"
           name="17">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(17)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-17">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480 net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when setting up an SSL tunnel. ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-08 22:51:59 UTC)
                <a href="#msg18">#18</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-17"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-17"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when
setting up an SSL tunnel.
On 2014/12/08 22:04:39, Ryan Sleevi wrote:
&gt; Is my reading of your deletion of this test correct, in that we no longer use
&gt; the same proxy connection for multiple auth leg exchanges?

... because that would be Bad (tm).

I broke this behavior in the past, I think, and it was Bad(tm)

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:500: return
ERR_HTTPS_PROXY_TUNNEL_RESPONSE;
I think you&#39;ve tried to make use of an early-return of the error here. Yay! I
love early-return. But I think you need to nuke the {}s at 492/497 and
refrormat?

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode91" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:91: &quot;Content-Length: 0\n&quot;
Looks like the content-length should not be 0, since there is actually a
response body.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode92" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:92: &quot;Connection: close\n&quot;
I&#39;m not sure that you want to make this connection close because that prevents
the socket from being reused, which I think you need for Negotiate/NTLM auth.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/spdy/spdy_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/spdy/spdy_proxy_clie...</a>
File net/spdy/spdy_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/spdy/spdy_proxy_client_socket.cc#newcode419" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/spdy/spdy_proxy_clie...</a>
net/spdy/spdy_proxy_client_socket.cc:419: return ERR_TUNNEL_CONNECTION_FAILED;
Early return for the win!</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg19"
           name="18">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(18)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-18">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111 net/http/proxy_client_socket.cc:111: &quot;HTTP/1.1 302 Found\n&quot; On 2014/12/08 22:04:40, Ryan Sleevi wrote: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-08 22:53:48 UTC)
                <a href="#msg19">#19</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-18"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-18"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:111: &quot;HTTP/1.1 302 Found\n&quot;
On 2014/12/08 22:04:40, Ryan Sleevi wrote:
&gt; Note: While this may seem trivial, it&#39;s going to require someone to go back to
&gt; the HTTP/1.1 spec and ensure our response is a fully conformant 1.1 response.
&gt; There are difference in requirements for requests (e.g. 1.1 requests MUST have
a
&gt; Host header), and I haven&#39;t checked if 1.1 responses have similar
requirements.
&gt; 
&gt; This may be the correct thing to do, but a reviewer needs to vet this is true.

From my reading, I think there are no required response headers:

       Response      = Status-Line               ; Section 6.1
                       *(( general-header        ; Section 4.5
                        | response-header        ; Section 6.2
                        | entity-header ) CRLF)  ; Section 7.1
                       CRLF
                       [ message-body ]          ; Section 7.2</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg20"
           name="19">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(19)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-19">
                          On 2014/12/08 22:53:48, Ryan Hamilton wrote: &gt; https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc &gt; File net/http/proxy_client_socket.cc (right): &gt; &gt; https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111 ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-08 22:58:06 UTC)
                <a href="#msg20">#20</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-19"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-19"
            >On 2014/12/08 22:53:48, Ryan Hamilton wrote:
&gt;
<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
&gt; File net/http/proxy_client_socket.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
&gt; net/http/proxy_client_socket.cc:111: &quot;HTTP/1.1 302 Found\n&quot;
&gt; On 2014/12/08 22:04:40, Ryan Sleevi wrote:
&gt; &gt; Note: While this may seem trivial, it&#39;s going to require someone to go back
to
&gt; &gt; the HTTP/1.1 spec and ensure our response is a fully conformant 1.1
response.
&gt; &gt; There are difference in requirements for requests (e.g. 1.1 requests MUST
have
&gt; a
&gt; &gt; Host header), and I haven&#39;t checked if 1.1 responses have similar
&gt; requirements.
&gt; &gt; 
&gt; &gt; This may be the correct thing to do, but a reviewer needs to vet this is
true.
&gt; 
&gt; From my reading, I think there are no required response headers:
&gt; 
&gt;        Response      = Status-Line               ; Section 6.1
&gt;                        *(( general-header        ; Section 4.5
&gt;                         | response-header        ; Section 6.2
&gt;                         | entity-header ) CRLF)  ; Section 7.1
&gt;                        CRLF
&gt;                        [ message-body ]          ; Section 7.2

Note: After the 7230-et-al updates, normative requirements are not expressed in
the ABNF but prosaically (e.g. <a href="https://tools.ietf.org/html/rfc7230#section-5.4" rel="nofollow">https://tools.ietf.org/html/rfc7230#section-5.4</a>
). That&#39;s why it&#39;ll require a careful eye :)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg21"
           name="20">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(20)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-20">
                          PTAL. https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480 net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when setting up an SSL ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-09 15:31:15 UTC)
                <a href="#msg21">#21</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-20"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-20"
            >PTAL.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when
setting up an SSL tunnel.
On 2014/12/08 22:04:39, Ryan Sleevi wrote:
&gt; Is my reading of your deletion of this test correct, in that we no longer use
&gt; the same proxy connection for multiple auth leg exchanges?

Yes; our fake response does not have a keep-alive header, so we don&#39;t. I could
try to preserve it, and then the &quot;drain body for auth response&quot; logic would
probably still work even if the headers are fake.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode487" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:487: // We&#39;re not using an HTTPS proxy, or
we couldn&#39;t sanitize the redirect.
On 2014/12/08 22:04:39, Ryan Sleevi wrote:
&gt; nit: &quot;Pronouns in Comments considered harmful&quot; -
&gt;
<a href="https://groups.google.com/a/chromium.org/d/topic/chromium-dev/NH-S6KCkr2M/discussion" rel="nofollow">https://groups.google.com/a/chromium.org/d/topic/chromium-dev/NH-S6KCkr2M/dis...</a>
&gt; 
&gt; That said, this comment describes the code, which violates
&gt;
<a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.html#Implementation_Comments" rel="nofollow">http://google-styleguide.googlecode.com/svn/trunk/cppguide.html#Implementatio...</a>
&gt; 
&gt; (That is, the if conditional says exactly what your plain english comment is
&gt; saying). So delete this comment.

Done.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:500: return
ERR_HTTPS_PROXY_TUNNEL_RESPONSE;
On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; I think you&#39;ve tried to make use of an early-return of the error here. Yay! I
&gt; love early-return. But I think you need to nuke the {}s at 492/497 and
&gt; refrormat?

What&#39;s wrong with the {}s? They&#39;re to prevent &quot;jumping past assignment&quot; errors
from the switch.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode91" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:91: &quot;Content-Length: 0\n&quot;
On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; Looks like the content-length should not be 0, since there is actually a
&gt; response body.

The goal was to avoid providing the response body, since it can contain scripts
that would execute as the origin we were trying to CONNECT to.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode92" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:92: &quot;Connection: close\n&quot;
On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; I&#39;m not sure that you want to make this connection close because that prevents
&gt; the socket from being reused, which I think you need for Negotiate/NTLM auth.

Sigh, okay.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode111" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:111: &quot;HTTP/1.1 302 Found\n&quot;
On 2014/12/08 22:04:40, Ryan Sleevi wrote:
&gt; Note: While this may seem trivial, it&#39;s going to require someone to go back to
&gt; the HTTP/1.1 spec and ensure our response is a fully conformant 1.1 response.
&gt; There are difference in requirements for requests (e.g. 1.1 requests MUST have
a
&gt; Host header), and I haven&#39;t checked if 1.1 responses have similar
requirements.
&gt; 
&gt; This may be the correct thing to do, but a reviewer needs to vet this is true.

I can make them both 1.0, but that would break keep-alive, which we need for
auth.

If you want, I can just leave *this* one 1.0.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg22"
           name="21">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(21)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asanka</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-21">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480 net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when setting up an SSL tunnel. ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-09 17:33:02 UTC)
                <a href="#msg22">#22</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-21"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-21"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when
setting up an SSL tunnel.
On 2014/12/09 at 15:31:15, ttuttle wrote:
&gt; On 2014/12/08 22:04:39, Ryan Sleevi wrote:
&gt; &gt; Is my reading of your deletion of this test correct, in that we no longer
use
&gt; &gt; the same proxy connection for multiple auth leg exchanges?
&gt; 
&gt; Yes; our fake response does not have a keep-alive header, so we don&#39;t. I could
try to preserve it, and then the &quot;drain body for auth response&quot; logic would
probably still work even if the headers are fake.

Respecting keep-alive is important for connection based authentication schemes
like NTLM / Negotiate. Unlike Basic, servers often maintain per connection state
to support multi-leg authentication handshakes and that state would be lost if
we use a new socket.

<a href="https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc#newcode84" rel="nofollow">https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:84: auth = auth + &quot;, &quot; + value;
Note that we consider proxy-authenticate to be a non-coalescing header (see
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_util.cc&amp;rcl=1418094088&amp;l=404" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_util...</a>).
Unfortunately we can&#39;t rely on HTTP auth headers not containing naked commas.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg23"
           name="22">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(22)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-22">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode91 net/http/proxy_client_socket.cc:91: &quot;Content-Length: 0\n&quot; On 2014/12/09 15:31:15, ttuttle wrote: &gt; On ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-10 19:53:42 UTC)
                <a href="#msg23">#23</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-22"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-22"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode91" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:91: &quot;Content-Length: 0\n&quot;
On 2014/12/09 15:31:15, ttuttle wrote:
&gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; Looks like the content-length should not be 0, since there is actually a
&gt; &gt; response body.
&gt; 
&gt; The goal was to avoid providing the response body, since it can contain
scripts
&gt; that would execute as the origin we were trying to CONNECT to.

Oh! I&#39;m sorry. I misread line 94 to be appending a response body via
auth.c_str() but in re-reading it&#39;s obvious that I was confused. Sorry!</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg24"
           name="23">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(23)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-23">
                          Okay, I think Keep-Alive works now. https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc#newcode84 net/http/proxy_client_socket.cc:84: auth = auth ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-10 20:36:19 UTC)
                <a href="#msg24">#24</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-23"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-23"
            >Okay, I think Keep-Alive works now.

<a href="https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_socket.cc#newcode84" rel="nofollow">https://codereview.chromium.org/769043003/diff/80001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:84: auth = auth + &quot;, &quot; + value;
On 2014/12/09 17:33:02, asanka wrote:
&gt; Note that we consider proxy-authenticate to be a non-coalescing header (see
&gt;
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_util.cc&amp;rcl=1418094088&amp;l=404" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_util...</a>).
&gt; Unfortunately we can&#39;t rely on HTTP auth headers not containing naked commas.

Oh, alright. I will reproduce each header as a separate one in the fake headers
then.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg25"
           name="24">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(24)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-24">
                          PTAL, folks. https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480 net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when setting up an ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-10 20:38:40 UTC)
                <a href="#msg25">#25</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-24"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-24"
            >PTAL, folks.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_transaction_unittest.cc#oldcode2480" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_network_tr...</a>
net/http/http_network_transaction_unittest.cc:2480: // proxy connection, when
setting up an SSL tunnel.
On 2014/12/09 17:33:02, asanka (gone till 12-22) wrote:
&gt; On 2014/12/09 at 15:31:15, ttuttle wrote:
&gt; &gt; On 2014/12/08 22:04:39, Ryan Sleevi wrote:
&gt; &gt; &gt; Is my reading of your deletion of this test correct, in that we no longer
&gt; use
&gt; &gt; &gt; the same proxy connection for multiple auth leg exchanges?
&gt; &gt; 
&gt; &gt; Yes; our fake response does not have a keep-alive header, so we don&#39;t. I
could
&gt; try to preserve it, and then the &quot;drain body for auth response&quot; logic would
&gt; probably still work even if the headers are fake.
&gt; 
&gt; Respecting keep-alive is important for connection based authentication schemes
&gt; like NTLM / Negotiate. Unlike Basic, servers often maintain per connection
state
&gt; to support multi-leg authentication handshakes and that state would be lost if
&gt; we use a new socket.

Gross, but fixed.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode91" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:91: &quot;Content-Length: 0\n&quot;
On 2014/12/10 19:53:42, Ryan Hamilton wrote:
&gt; On 2014/12/09 15:31:15, ttuttle wrote:
&gt; &gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; &gt; Looks like the content-length should not be 0, since there is actually a
&gt; &gt; &gt; response body.
&gt; &gt; 
&gt; &gt; The goal was to avoid providing the response body, since it can contain
&gt; scripts
&gt; &gt; that would execute as the origin we were trying to CONNECT to.
&gt; 
&gt; Oh! I&#39;m sorry. I misread line 94 to be appending a response body via
&gt; auth.c_str() but in re-reading it&#39;s obvious that I was confused. Sorry!

I&#39;ve removed the content-length header entirely, since we error out if the
caller reads the body anyway.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_socket.cc#newcode92" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/proxy_client_so...</a>
net/http/proxy_client_socket.cc:92: &quot;Connection: close\n&quot;
On 2014/12/09 15:31:15, ttuttle wrote:
&gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; I&#39;m not sure that you want to make this connection close because that
prevents
&gt; &gt; the socket from being reused, which I think you need for Negotiate/NTLM
auth.
&gt; 
&gt; Sigh, okay.

I&#39;ve passed along Connection headers along with the Proxy-Authenticate ones, so
keep-alive (or close, if the proxy wants) should work.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg26"
           name="25">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(25)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-25">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc File net/http/http_proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500 net/http/http_proxy_client_socket.cc:500: return ERR_HTTPS_PROXY_TUNNEL_RESPONSE; On 2014/12/09 15:31:15, ttuttle wrote: &gt; On ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-10 22:09:21 UTC)
                <a href="#msg26">#26</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-25"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-25"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:500: return
ERR_HTTPS_PROXY_TUNNEL_RESPONSE;
On 2014/12/09 15:31:15, ttuttle wrote:
&gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; I think you&#39;ve tried to make use of an early-return of the error here. Yay!
I
&gt; &gt; love early-return. But I think you need to nuke the {}s at 492/497 and
&gt; &gt; refrormat?
&gt; 
&gt; What&#39;s wrong with the {}s? 

They look ugly :&gt;

&gt; They&#39;re to prevent &quot;jumping past assignment&quot; errors
&gt; from the switch.

Ugh. I see. In that case, I would suggest one of two approaches:
1) simply inline the call to http_stream_parser_-&gt;IsConnectionReused()
2) put the {}s around the entire case 407: block, which I think is more common
than simply putting braces around two lines in the middle of a block.

<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:105: 
I&#39;m curious about the keep-alive behavior in the face of non-zero content-length
in the response. Perhaps this issue never comes up. But how do we ensure that we
drain the socket when the proxy replies back with a response body? If we
re-write the content-lenght, I think that we&#39;ll assume there is no more to read.
Then when we send the next request, we&#39;ll read the body of the previous response
as the headers for this new response.

Is that a problem?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg27"
           name="26">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(26)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-26">
                          https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105 net/http/proxy_client_socket.cc:105: On 2014/12/10 22:09:21, Ryan Hamilton wrote: &gt; I&#39;m curious ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-10 22:57:01 UTC)
                <a href="#msg27">#27</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-26"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-26"
            ><a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:105: 
On 2014/12/10 22:09:21, Ryan Hamilton wrote:
&gt; I&#39;m curious about the keep-alive behavior in the face of non-zero
content-length
&gt; in the response. Perhaps this issue never comes up. But how do we ensure that
we
&gt; drain the socket when the proxy replies back with a response body? If we
&gt; re-write the content-lenght, I think that we&#39;ll assume there is no more to
read.
&gt; Then when we send the next request, we&#39;ll read the body of the previous
response
&gt; as the headers for this new response.
&gt; 
&gt; Is that a problem?

Good catch!

The answer is minimally, ttuttle should write a unit test for that :D

I reached the same conclusion you did, and I think it will indeed be a problem.
I think our IsConnectedAndIdle bit that tries to peek the socket will fail, and
so we&#39;d end up not doing Keep-Alive on the socket.

<a href="https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_proxy_client_socket.cc&amp;l=265" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_prox...</a>
has the logic, and I think it&#39;d just cause us to close the socket rather than
drain the socket.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg28"
           name="27">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(27)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-27">
                          https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105 net/http/proxy_client_socket.cc:105: On 2014/12/10 22:57:01, Ryan Sleevi wrote: &gt; On 2014/12/10 ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-11 00:20:04 UTC)
                <a href="#msg28">#28</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-27"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-27"
            ><a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:105: 
On 2014/12/10 22:57:01, Ryan Sleevi wrote:
&gt; On 2014/12/10 22:09:21, Ryan Hamilton wrote:
&gt; &gt; I&#39;m curious about the keep-alive behavior in the face of non-zero
&gt; content-length
&gt; &gt; in the response. Perhaps this issue never comes up. But how do we ensure
that
&gt; we
&gt; &gt; drain the socket when the proxy replies back with a response body? If we
&gt; &gt; re-write the content-lenght, I think that we&#39;ll assume there is no more to
&gt; read.
&gt; &gt; Then when we send the next request, we&#39;ll read the body of the previous
&gt; response
&gt; &gt; as the headers for this new response.
&gt; &gt; 
&gt; &gt; Is that a problem?
&gt; 
&gt; Good catch!
&gt; 
&gt; The answer is minimally, ttuttle should write a unit test for that :D
&gt; 
&gt; I reached the same conclusion you did, and I think it will indeed be a
problem.
&gt; I think our IsConnectedAndIdle bit that tries to peek the socket will fail,
and
&gt; so we&#39;d end up not doing Keep-Alive on the socket.
&gt; 
&gt;
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_proxy_client_socket.cc&amp;l=265" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_prox...</a>
&gt; has the logic, and I think it&#39;d just cause us to close the socket rather than
&gt; drain the socket.

Huh. I am confused at why the BasicAuthProxyKeepAlive test is still passing,
then.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg29"
           name="28">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(28)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-28">
                          PTAL, everyone. On 2014/12/11 00:20:04, ttuttle wrote: &gt; https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc &gt; File net/http/proxy_client_socket.cc (right): &gt; &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-17 19:02:30 UTC)
                <a href="#msg29">#29</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-28"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-28"
            >PTAL, everyone.

On 2014/12/11 00:20:04, ttuttle wrote:
&gt;
<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
&gt; File net/http/proxy_client_socket.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_socket.cc#newcode105" rel="nofollow">https://codereview.chromium.org/769043003/diff/180001/net/http/proxy_client_s...</a>
&gt; net/http/proxy_client_socket.cc:105: 
&gt; On 2014/12/10 22:57:01, Ryan Sleevi wrote:
&gt; &gt; On 2014/12/10 22:09:21, Ryan Hamilton wrote:
&gt; &gt; &gt; I&#39;m curious about the keep-alive behavior in the face of non-zero
&gt; &gt; content-length
&gt; &gt; &gt; in the response. Perhaps this issue never comes up. But how do we ensure
&gt; that
&gt; &gt; we
&gt; &gt; &gt; drain the socket when the proxy replies back with a response body? If we
&gt; &gt; &gt; re-write the content-lenght, I think that we&#39;ll assume there is no more to
&gt; &gt; read.
&gt; &gt; &gt; Then when we send the next request, we&#39;ll read the body of the previous
&gt; &gt; response
&gt; &gt; &gt; as the headers for this new response.
&gt; &gt; &gt; 
&gt; &gt; &gt; Is that a problem?
&gt; &gt; 
&gt; &gt; Good catch!
&gt; &gt; 
&gt; &gt; The answer is minimally, ttuttle should write a unit test for that :D
&gt; &gt; 
&gt; &gt; I reached the same conclusion you did, and I think it will indeed be a
&gt; problem.
&gt; &gt; I think our IsConnectedAndIdle bit that tries to peek the socket will fail,
&gt; and
&gt; &gt; so we&#39;d end up not doing Keep-Alive on the socket.
&gt; &gt; 
&gt; &gt;
&gt;
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_proxy_client_socket.cc&amp;l=265" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/net/http/http_prox...</a>
&gt; &gt; has the logic, and I think it&#39;d just cause us to close the socket rather
than
&gt; &gt; drain the socket.
&gt; 
&gt; Huh. I am confused at why the BasicAuthProxyKeepAlive test is still passing,
&gt; then.

The content length is also stored in the HttpStreamParser, which remembers it
even if we modify the headers shown to the client of the HttpNetworkTransaction.
I think we&#39;re good here.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg30"
           name="29">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(29)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-29">
                          I&#39;m still shaky on the testing here. Why aren&#39;t you testing for a hypothetical multi-legged ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-17 22:37:12 UTC)
                <a href="#msg30">#30</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-29"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-29"
            >I&#39;m still shaky on the testing here.

Why aren&#39;t you testing for a hypothetical multi-legged auth? We should make sure
it works over a single connection still. I don&#39;t see any test covering that?

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/http_network_transaction_unittest.cc#newcode2669" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2669: MockRead(SYNCHRONOUS,
ERR_UNEXPECTED),  // Should not be reached.
Wait, why shouldn&#39;t it be reached? We should drain the socket and then send the
new request, right?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg31"
           name="30">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(30)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-30">
                          Hmm. I added the existing keep-alive test back, I thought? I guess that only covers ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-17 23:44:52 UTC)
                <a href="#msg31">#31</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-30"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-30"
            >Hmm. I added the existing keep-alive test back, I thought? I guess that
only covers multiple attempts at auth, not multi-*legged* auth? Are they
measurably different?

I&#39;ll take a look at it tomorrow.

On Wed, Dec 17, 2014 at 5:37 PM, &lt;<a href="mailto:rsleevi@chromium.org">rsleevi@chromium.org</a>&gt; wrote:

&gt; I&#39;m still shaky on the testing here.
&gt;
&gt; Why aren&#39;t you testing for a hypothetical multi-legged auth? We should
&gt; make sure
&gt; it works over a single connection still. I don&#39;t see any test covering
&gt; that?
&gt;
&gt;
&gt; <a href="https://codereview.chromium.org/769043003/diff/220001/net/" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/</a>
&gt; http/http_network_transaction_unittest.cc
&gt; File net/http/http_network_transaction_unittest.cc (right):
&gt;
&gt; <a href="https://codereview.chromium.org/769043003/diff/220001/net/" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/</a>
&gt; http/http_network_transaction_unittest.cc#newcode2669
&gt; net/http/http_network_transaction_unittest.cc:2669:
&gt; MockRead(SYNCHRONOUS, ERR_UNEXPECTED),  // Should not be reached.
&gt; Wait, why shouldn&#39;t it be reached? We should drain the socket and then
&gt; send the new request, right?
&gt;
&gt; <a href="https://codereview.chromium.org/769043003/" rel="nofollow">https://codereview.chromium.org/769043003/</a>
&gt;

To unsubscribe from this group and stop receiving emails from it, send an email
to <a href="mailto:chromium-reviews+unsubscribe@chromium.org">chromium-reviews+unsubscribe@chromium.org</a>.
</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg32"
           name="31">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(31)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-31">
                          On 2014/12/17 19:02:30, ttuttle wrote: &gt; The content length is also stored in the HttpStreamParser, ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:26:47 UTC)
                <a href="#msg32">#32</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-31"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-31"
            >On 2014/12/17 19:02:30, ttuttle wrote:
&gt; The content length is also stored in the HttpStreamParser, which remembers it
&gt; even if we modify the headers shown to the client of the
HttpNetworkTransaction.
&gt; I think we&#39;re good here.

I don&#39;t quite understand how this works, though you may well be right that it
does :&gt;

I&#39;m looking at code in HttpNetworkTransaction::PrepareForAuthRestart. It looks
like it&#39;s checking the headers to see if it&#39;s keep-alive but then is asking the
stream if it can find the end of the response. Is there any possibility that
those will disagree? If so, is that problematic?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg33"
           name="32">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(32)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-32">
                          https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc File net/http/http_proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500 net/http/http_proxy_client_socket.cc:500: return ERR_HTTPS_PROXY_TUNNEL_RESPONSE; On 2014/12/10 22:09:21, Ryan Hamilton wrote: &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:26:59 UTC)
                <a href="#msg33">#33</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-32"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-32"
            ><a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:500: return
ERR_HTTPS_PROXY_TUNNEL_RESPONSE;
On 2014/12/10 22:09:21, Ryan Hamilton wrote:
&gt; On 2014/12/09 15:31:15, ttuttle wrote:
&gt; &gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; &gt; I think you&#39;ve tried to make use of an early-return of the error here.
Yay!
&gt; I
&gt; &gt; &gt; love early-return. But I think you need to nuke the {}s at 492/497 and
&gt; &gt; &gt; refrormat?
&gt; &gt; 
&gt; &gt; What&#39;s wrong with the {}s? 
&gt; 
&gt; They look ugly :&gt;
&gt; 
&gt; &gt; They&#39;re to prevent &quot;jumping past assignment&quot; errors
&gt; &gt; from the switch.
&gt; 
&gt; Ugh. I see. In that case, I would suggest one of two approaches:
&gt; 1) simply inline the call to http_stream_parser_-&gt;IsConnectionReused()
&gt; 2) put the {}s around the entire case 407: block, which I think is more common
&gt; than simply putting braces around two lines in the middle of a block.

ping.

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers,
&quot;Connection&quot;);
I sure would have thought that you&#39;d need both Connection and Content-length (or
a synthetic C-L). Do you understand why Content-Length is not required?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg34"
           name="33">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(33)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-33">
                          https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99 net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers, &quot;Connection&quot;); On 2014/12/19 21:26:59, Ryan Hamilton wrote: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:30:25 UTC)
                <a href="#msg34">#34</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-33"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-33"
            ><a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers,
&quot;Connection&quot;);
On 2014/12/19 21:26:59, Ryan Hamilton wrote:
&gt; I sure would have thought that you&#39;d need both Connection and Content-length
(or
&gt; a synthetic C-L). Do you understand why Content-Length is not required?

Agreed. This is why I have trouble understanding how this doesn&#39;t break
something.

If a proxy sends a response along with the initial body, and we&#39;re going to
re-use that connection, we need the presence of Keep-Alive (either implicit or
explicit) and the ability to drain the body.

I don&#39;t think the tests send dummy bodies, and so it falls under the
&quot;IsConnectedAndIdle&quot; check and decides it doesn&#39;t need to drain the body. But we
should.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg35"
           name="34">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(34)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-34">
                          On 2014/12/19 21:30:25, Ryan Sleevi wrote: &gt; https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc &gt; File net/http/proxy_client_socket.cc (right): &gt; &gt; https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99 ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:40:43 UTC)
                <a href="#msg35">#35</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-34"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-34"
            >On 2014/12/19 21:30:25, Ryan Sleevi wrote:
&gt;
<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
&gt; File net/http/proxy_client_socket.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
&gt; net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers,
&gt; &quot;Connection&quot;);
&gt; On 2014/12/19 21:26:59, Ryan Hamilton wrote:
&gt; &gt; I sure would have thought that you&#39;d need both Connection and Content-length
&gt; (or
&gt; &gt; a synthetic C-L). Do you understand why Content-Length is not required?
&gt; 
&gt; Agreed. This is why I have trouble understanding how this doesn&#39;t break
&gt; something.
&gt; 
&gt; If a proxy sends a response along with the initial body, and we&#39;re going to
&gt; re-use that connection, we need the presence of Keep-Alive (either implicit or
&gt; explicit) and the ability to drain the body.

We do preserve the Keep-Alive header over now.

Content-Length isn&#39;t required because it&#39;s saved in the HttpStreamParser, which
knows how to read to the end of the body.

&gt; I don&#39;t think the tests send dummy bodies, and so it falls under the
&gt; &quot;IsConnectedAndIdle&quot; check and decides it doesn&#39;t need to drain the body. But
we
&gt; should.

I thought they did. BasicAuthProxyKeepAlive returns &quot;0123456789&quot; as the body for
the first failure, for example.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg36"
           name="35">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(35)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-35">
                          PTAL, rch and rsleevi. https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc File net/http/http_proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500 net/http/http_proxy_client_socket.cc:500: return ERR_HTTPS_PROXY_TUNNEL_RESPONSE; On 2014/12/19 21:26:58, ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:50:46 UTC)
                <a href="#msg36">#36</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-35"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-35"
            >PTAL, rch and rsleevi.

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_client_socket.cc#newcode500" rel="nofollow">https://codereview.chromium.org/769043003/diff/60001/net/http/http_proxy_clie...</a>
net/http/http_proxy_client_socket.cc:500: return
ERR_HTTPS_PROXY_TUNNEL_RESPONSE;
On 2014/12/19 21:26:58, Ryan Hamilton wrote:
&gt; On 2014/12/10 22:09:21, Ryan Hamilton wrote:
&gt; &gt; On 2014/12/09 15:31:15, ttuttle wrote:
&gt; &gt; &gt; On 2014/12/08 22:51:59, Ryan Hamilton wrote:
&gt; &gt; &gt; &gt; I think you&#39;ve tried to make use of an early-return of the error here.
&gt; Yay!
&gt; &gt; I
&gt; &gt; &gt; &gt; love early-return. But I think you need to nuke the {}s at 492/497 and
&gt; &gt; &gt; &gt; refrormat?
&gt; &gt; &gt; 
&gt; &gt; &gt; What&#39;s wrong with the {}s? 
&gt; &gt; 
&gt; &gt; They look ugly :&gt;
&gt; &gt; 
&gt; &gt; &gt; They&#39;re to prevent &quot;jumping past assignment&quot; errors
&gt; &gt; &gt; from the switch.
&gt; &gt; 
&gt; &gt; Ugh. I see. In that case, I would suggest one of two approaches:
&gt; &gt; 1) simply inline the call to http_stream_parser_-&gt;IsConnectionReused()
&gt; &gt; 2) put the {}s around the entire case 407: block, which I think is more
common
&gt; &gt; than simply putting braces around two lines in the middle of a block.
&gt; 
&gt; ping.

Done.

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers,
&quot;Connection&quot;);
On 2014/12/19 21:26:59, Ryan Hamilton wrote:
&gt; I sure would have thought that you&#39;d need both Connection and Content-length
(or
&gt; a synthetic C-L). Do you understand why Content-Length is not required?

Content-Length is read by the HttpStreamParser. We never directly examine it in
HttpProxyClientSocket.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg37"
           name="36">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(36)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Hamilton</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-36">
                          I think this LGTM. Sleevi? https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc File net/http/proxy_client_socket.cc (right): https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99 net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers, &quot;Connection&quot;); On ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 21:53:45 UTC)
                <a href="#msg37">#37</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-36"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-36"
            >I think this LGTM.  Sleevi?

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_socket.cc#newcode99" rel="nofollow">https://codereview.chromium.org/769043003/diff/220001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:99: CopyHeaderValues(old_headers, new_headers,
&quot;Connection&quot;);
On 2014/12/19 21:50:46, ttuttle wrote:
&gt; On 2014/12/19 21:26:59, Ryan Hamilton wrote:
&gt; &gt; I sure would have thought that you&#39;d need both Connection and Content-length
&gt; (or
&gt; &gt; a synthetic C-L). Do you understand why Content-Length is not required?
&gt; 
&gt; Content-Length is read by the HttpStreamParser. We never directly examine it
in
&gt; HttpProxyClientSocket.

Ah, I missed the last part. Ok, makes sense.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg38"
           name="37">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(37)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-37">
                          https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#oldcode2553 net/http/http_network_transaction_unittest.cc:2553: EXPECT_EQ(10, response-&gt;headers-&gt;GetContentLength()); Rather than deleting these, you should be ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                6 years ago
		(2014-12-19 22:06:25 UTC)
                <a href="#msg38">#38</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-37"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-37"
            ><a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#oldcode2553" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2553: EXPECT_EQ(10,
response-&gt;headers-&gt;GetContentLength());
Rather than deleting these, you should be asserting there is no body, right?

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#newcode2664" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2664: MockRead(&quot;X-Foo: bar\r\n&quot;),
Can you explicitly add a test for Set-Cookie behaviour? I agree that it&#39;s useful
to test X-Foo, but we also want to explicitly test headers to ensure they&#39;re not
also &quot;special-cased&quot; by HttpStreamParser (such as Content-Length, which tripped
up Ryan and I)

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#newcode2667" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2667: MockRead(SYNCHRONOUS,
ERR_UNEXPECTED),  // Should not be reached.
I&#39;d feel better for this test if you explicitly added content bytes.

That is, your &quot;should not be reached&quot; may indirectly cause line 2692 to be
reached for reasons unrelated to the 407 on 2663.

That is, by adding a body to be read, you can then assert that the response on
2683 *doesn&#39;t* include a body, to ensure that the body is stripped out.

Does that make sense?

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_cli...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_client_socket.cc#newcode488" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_cli...</a>
net/http/http_proxy_client_socket.cc:488: return ERR_TUNNEL_CONNECTION_FAILED;
What&#39;s the content of |response_| in this case, and how do we ensure it isn&#39;t
used? Should it be cleared? Ditto line 504-506

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc#newcode94" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:94: const char* kHeaders = &quot;HTTP/1.1 407 Proxy
Authentication Required\n\n&quot;;
const char[] const kHeaders

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc#newcode96" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:96: HttpUtil::AssembleRawHeaders(kHeaders,
strlen(kHeaders)));
s/strlen/arraysize

<a href="https://codereview.chromium.org/769043003/diff/240001/net/spdy/spdy_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/spdy/spdy_proxy_cli...</a>
File net/spdy/spdy_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/spdy/spdy_proxy_client_socket.cc#newcode433" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/spdy/spdy_proxy_cli...</a>
net/spdy/spdy_proxy_client_socket.cc:433: return ERR_TUNNEL_CONNECTION_FAILED;
Ditto the comments re: |response_| sanitization</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg39"
           name="38">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(38)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-38">
                          PTAL. https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (left): https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#oldcode2553 net/http/http_network_transaction_unittest.cc:2553: EXPECT_EQ(10, response-&gt;headers-&gt;GetContentLength()); On 2014/12/19 22:06:25, Ryan Sleevi wrote: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-02 19:40:55 UTC)
                <a href="#msg39">#39</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-38"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-38"
            >PTAL.

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (left):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#oldcode2553" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2553: EXPECT_EQ(10,
response-&gt;headers-&gt;GetContentLength());
On 2014/12/19 22:06:25, Ryan Sleevi wrote:
&gt; Rather than deleting these, you should be asserting there is no body, right?

Well, at least asserting that there is no Content-Length.

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_transaction_unittest.cc#newcode2664" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2664: MockRead(&quot;X-Foo: bar\r\n&quot;),
On 2014/12/19 22:06:25, Ryan Sleevi wrote:
&gt; Can you explicitly add a test for Set-Cookie behaviour? I agree that it&#39;s
useful
&gt; to test X-Foo, but we also want to explicitly test headers to ensure they&#39;re
not
&gt; also &quot;special-cased&quot; by HttpStreamParser (such as Content-Length, which
tripped
&gt; up Ryan and I)

Done. I don&#39;t see any way to test it besides just adding a Set-Cookie header and
checking for it in the response headers, so that&#39;s what I did.

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_cli...</a>
File net/http/http_proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_client_socket.cc#newcode488" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/http_proxy_cli...</a>
net/http/http_proxy_client_socket.cc:488: return ERR_TUNNEL_CONNECTION_FAILED;
On 2014/12/19 22:06:25, Ryan Sleevi wrote:
&gt; What&#39;s the content of |response_| in this case, and how do we ensure it isn&#39;t
&gt; used? Should it be cleared? Ditto line 504-506

I could delete the response headers, but I *think* the error code should be
enough to make sure it isn&#39;t used.

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
File net/http/proxy_client_socket.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc#newcode94" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:94: const char* kHeaders = &quot;HTTP/1.1 407 Proxy
Authentication Required\n\n&quot;;
On 2014/12/19 22:06:25, Ryan Sleevi wrote:
&gt; const char[] const kHeaders

The compiler gets rather cranky at this. It wants the [] after kHeaders, but
won&#39;t let me put a const after that. Does &quot;const char const kHeaders[]&quot; do it,
or is that just redundantly making it a not-const array of const chars? (Can you
even have a non-const array in this sense?)

<a href="https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_socket.cc#newcode96" rel="nofollow">https://codereview.chromium.org/769043003/diff/240001/net/http/proxy_client_s...</a>
net/http/proxy_client_socket.cc:96: HttpUtil::AssembleRawHeaders(kHeaders,
strlen(kHeaders)));
On 2014/12/19 22:06:25, Ryan Sleevi wrote:
&gt; s/strlen/arraysize

Done.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg40"
           name="39">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(39)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Ryan Sleevi</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-39">
                          lgtm https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (right): https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc#newcode2687 net/http/http_network_transaction_unittest.cc:2687: ASSERT_TRUE(response != NULL); nullptr although cleaner to just ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-02 22:56:02 UTC)
                <a href="#msg40">#40</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-39"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-39"
            >lgtm

<a href="https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc#newcode2687" rel="nofollow">https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2687: ASSERT_TRUE(response !=
NULL);
nullptr

although cleaner to just

ASSERT_TRUE(response), which will work for any of our container types as well
(i.e. it won&#39;t require calling .get() and will instead use the bool conversions)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg41"
           name="40">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(40)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>asanka</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-40">
                          lgtm
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-05 23:03:44 UTC)
                <a href="#msg41">#41</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-40"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-40"
            >lgtm</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg42"
           name="41">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(41)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-41">
                          https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc File net/http/http_network_transaction_unittest.cc (right): https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc#newcode2687 net/http/http_network_transaction_unittest.cc:2687: ASSERT_TRUE(response != NULL); On 2015/01/02 22:56:02, Ryan Sleevi (ooo ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-05 23:06:30 UTC)
                <a href="#msg42">#42</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-41"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-41"
            ><a href="https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc" rel="nofollow">https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_t...</a>
File net/http/http_network_transaction_unittest.cc (right):

<a href="https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_transaction_unittest.cc#newcode2687" rel="nofollow">https://codereview.chromium.org/769043003/diff/260001/net/http/http_network_t...</a>
net/http/http_network_transaction_unittest.cc:2687: ASSERT_TRUE(response !=
NULL);
On 2015/01/02 22:56:02, Ryan Sleevi (ooo until 1-6) wrote:
&gt; nullptr
&gt; 
&gt; although cleaner to just
&gt; 
&gt; ASSERT_TRUE(response), which will work for any of our container types as well
&gt; (i.e. it won&#39;t require calling .get() and will instead use the bool
conversions)

Done.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg43"
           name="42">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(42)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Deprecated (see juliatuttle)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-42">
                          The CQ bit was checked by ttuttle@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-06 00:09:28 UTC)
                <a href="#msg43">#43</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-42"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-42"
            >The CQ bit was checked by <a href="mailto:ttuttle@chromium.org">ttuttle@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg44"
           name="43">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(43)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-43">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/patch-status/769043003/280001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-06 00:10:27 UTC)
                <a href="#msg44">#44</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-43"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-43"
            >CQ is trying da patch. Follow status at
 <a href="https://chromium-cq-status.appspot.com/patch-status/769043003/280001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-status/769043003/280001</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg45"
           name="44">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(44)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-44">
                          Committed patchset #15 (id:280001)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-06 00:55:51 UTC)
                <a href="#msg45">#45</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-44"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-44"
            >Committed patchset #15 (id:280001)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg46"
           name="45">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(45)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-45">
                          Patchset 15 (id:??) landed as https://crrev.com/7933c117fd16b192e70609c331641e9112af5e42 Cr-Commit-Position: refs/heads/master@{#310014}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 11 months ago
		(2015-01-06 00:56:41 UTC)
                <a href="#msg46">#46</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-45"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-45"
            >Patchset 15 (id:??) landed as
<a href="https://crrev.com/7933c117fd16b192e70609c331641e9112af5e42" rel="nofollow">https://crrev.com/7933c117fd16b192e70609c331641e9112af5e42</a>
Cr-Commit-Position: refs/heads/master@{#310014}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 46)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 46)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(46)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(46)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 46;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 769043003;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 769043003: Sanitize headers in Proxy Authentication Required responses
     (Closed) </b><br/>
      Created 6 years ago by Deprecated (see juliatuttle)<br/>
      Modified 5 years, 11 months ago<br/>
      Reviewers: asanka, Ryan Hamilton, Ryan Sleevi<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 52
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
