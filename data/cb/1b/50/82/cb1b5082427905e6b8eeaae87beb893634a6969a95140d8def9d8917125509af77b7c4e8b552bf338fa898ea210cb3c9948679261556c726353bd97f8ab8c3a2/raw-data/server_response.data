<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='SPL related Bug #73257 - RDF' href='rss/bug.php?id=73257'>
        <link rel='alternate' type='application/rss+xml' title='SPL related Bug #73257 - RSS 2.0' href='rss/bug.php?id=73257&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #73257 :: pointer to uninitialized memory passed to unserialize</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=73257">Sec Bug</a>&nbsp;#73257</th>
            <td id="summary" colspan="5">pointer to uninitialized memory passed to unserialize</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2016-10-06 13:07 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-12-30 09:05 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=SPL+related">SPL related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.0.11</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7480" target="_blank">2016-7480</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=73257&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=73257&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=73257&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1475759263">&nbsp;</a><strong>[2016-10-06 13:07 UTC] yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
In SplObjectStorage::unserialize, pointer to uninitialized variable is passed to php_var_unserialize which may lead to code execution.

In SplObjectStorage::unserialize the variables entry and inf are defined on the stack. Then, they are passed as first argument (rval) to php_var_unserialize 
which ultimately invokes php_var_unserialize_internal with the same arguments.
In php_var_unserialize_internal, if the parsed element is a reference (R:), then zval_ptr_dtor is invoked with the given pointer. Thus, trying to destroy an uninitialized variable.

This issue may lead to memory corruption and undefined behavior (I think it can lead to remote code execution but don't have a demo yet).

Since the values of uninitialized variables depends on optimization, no test script it provided. However, I did manage to crash it randomly on Ubuntu 16.04 x86-64.


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=73257'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=73257'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1475759417">&nbsp;</a><strong>[2016-10-06 13:10 UTC] yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</strong>
<pre class='note'>Patch
```
diff --git a/ext/spl/spl_observer.c b/ext/spl/spl_observer.c
index 4ad0c6d..bdd95bd 100644
--- a/ext/spl/spl_observer.c
+++ b/ext/spl/spl_observer.c
@@ -763,6 +763,9 @@ SPL_METHOD(SplObjectStorage, unserialize)
 	spl_SplObjectStorageElement *element;
 	zend_long count;
 
+	ZVAL_UNDEF(&amp;entry);
+	ZVAL_UNDEF(&amp;inf);
+
 	if (zend_parse_parameters(ZEND_NUM_ARGS(), &quot;s&quot;, &amp;buf, &amp;buf_len) == FAILURE) {
 		return;
 	}
@@ -813,15 +816,14 @@ SPL_METHOD(SplObjectStorage, unserialize)
 				zval_ptr_dtor(&amp;entry);
 				goto outexcept;
 			}
-		} else {
-			ZVAL_UNDEF(&amp;inf);
-		}
+		} 
 
 		if (spl_object_storage_get_hash(&amp;key, intern, getThis(), &amp;entry) == FAILURE) {
 			zval_ptr_dtor(&amp;entry);
 			zval_ptr_dtor(&amp;inf);
 			goto outexcept;
 		}
+
 		pelement = spl_object_storage_get(intern, &amp;key);
 		spl_object_storage_free_hash(intern, &amp;key);
 		if (pelement) {
```
</pre>
</div><div class='comment type_related' ><a name="1475816073">&nbsp;</a><strong>[2016-10-07 04:54 UTC] yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</strong>
<pre class='note'>Related To: <a href='bug.php?id=73258'>Bug #73258</a>
</pre>
</div><div class='comment type_log' ><a name="1476165414">&nbsp;</a><strong>[2016-10-11 05:56 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.1Git-2016-10-06 (Git)</span>
<span class="added">+PHP Version: 7.0.11</span>
</div></div></div><div class='comment type_comment' ><a name="1476165414">&nbsp;</a><strong>[2016-10-11 05:56 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix is in security repo as 61cdd1255d5b9c8453be71aacbbf682796ac77d4 and in <a href="https://gist.github.com/878035c897be04617d38f15449b59797" rel="nofollow">https://gist.github.com/878035c897be04617d38f15449b59797</a>

please verify
</pre>
</div><div class='comment type_log' ><a name="1476165429">&nbsp;</a><strong>[2016-10-11 05:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_svn' ><a name="1476229930">&nbsp;</a><strong>[2016-10-11 23:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_log' ><a name="1476229930">&nbsp;</a><strong>[2016-10-11 23:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1476282384">&nbsp;</a><strong>[2016-10-12 14:26 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_comment' ><a name="1476355161">&nbsp;</a><strong>[2016-10-13 10:39 UTC] yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</strong>
<pre class='note'>looks good
</pre>
</div><div class='comment type_svn' ><a name="1476406936">&nbsp;</a><strong>[2016-10-14 01:02 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_svn' ><a name="1476411787">&nbsp;</a><strong>[2016-10-14 02:23 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_svn' ><a name="1476411803">&nbsp;</a><strong>[2016-10-14 02:23 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_svn' ><a name="1476698820">&nbsp;</a><strong>[2016-10-17 10:07 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f901dce57548cf1ef63578966ee16fa11509adcf</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_svn' ><a name="1476698841">&nbsp;</a><strong>[2016-10-17 10:07 UTC] <a href="//people.php.net/bwoebi">bwoebi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=61cdd1255d5b9c8453be71aacbbf682796ac77d4</a>
Log: Fix <a href='bug.php?id=73257'>bug #73257</a> and <a href='bug.php?id=73258'>bug #73258</a> - SplObjectStorage unserialize allows use of non-object as key
</pre>
</div><div class='comment type_comment' ><a name="1477909174">&nbsp;</a><strong>[2016-10-31 10:19 UTC] yannayl &#x61;&#116; checkpoint &#x64;&#111;&#x74; com</strong>
<pre class='note'>Assigned cve: CVE-2016-7480
Please associate it with this bug.
</pre>
</div><div class='comment type_log' ><a name="1483088712">&nbsp;</a><strong>[2016-12-30 09:05 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2016-7480</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
