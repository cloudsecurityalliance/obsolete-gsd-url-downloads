<!DOCTYPE html>
<html lang='en'>
<head>
<title>xorg/lib/libXrandr - X Resize and Rotate Extension C Library  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxrandr)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/xorg/lib/libXrandr/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/xorg/lib/libxrandr' title='xorg/lib/libXrandr Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='xorg/lib/libXrandr' href='/xorg/lib/libXrandr/'>xorg/lib/libXrandr</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a0df3e1c7728205e5c7650b2e6dce684139254a6'/><select name='h' onchange='this.form.submit();'>
<option value='CYGWIN'>CYGWIN</option>
<option value='DAMAGE-XFIXES'>DAMAGE-XFIXES</option>
<option value='IPv6-REVIEW'>IPv6-REVIEW</option>
<option value='XACE-SELINUX'>XACE-SELINUX</option>
<option value='XEVIE'>XEVIE</option>
<option value='XINERAMA_2'>XINERAMA_2</option>
<option value='XORG-6_8-branch'>XORG-6_8-branch</option>
<option value='XORG-CURRENT'>XORG-CURRENT</option>
<option value='XORG-RELEASE-1'>XORG-RELEASE-1</option>
<option value='XORG-RELEASE-1-STSF'>XORG-RELEASE-1-STSF</option>
<option value='XORG-RELEASE-1-TM'>XORG-RELEASE-1-TM</option>
<option value='XORG-STABLE'>XORG-STABLE</option>
<option value='XPRINT'>XPRINT</option>
<option value='get-set-primary'>get-set-primary</option>
<option value='gsr-current'>gsr-current</option>
<option value='master' selected='selected'>master</option>
<option value='randr-1.2'>randr-1.2</option>
<option value='randr-dpms'>randr-dpms</option>
<option value='transform-proposal'>transform-proposal</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>X Resize and Rotate Extension C Library  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxrandr)</td><td class='sub right'>keithp</td></tr></table>
<table class='tabs'><tr><td>
<a href='/xorg/lib/libXrandr/'>summary</a><a href='/xorg/lib/libXrandr/refs/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>refs</a><a href='/xorg/lib/libXrandr/log/'>log</a><a href='/xorg/lib/libXrandr/tree/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>tree</a><a class='active' href='/xorg/lib/libXrandr/commit/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>commit</a><a href='/xorg/lib/libXrandr/diff/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>diff</a></td><td class='form'><form class='right' method='get' action='/xorg/lib/libXrandr/log/'>
<input type='hidden' name='id' value='a0df3e1c7728205e5c7650b2e6dce684139254a6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a0df3e1c7728205e5c7650b2e6dce684139254a6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;</td><td class='right'>2016-09-25 22:21:40 +0200</td></tr>
<tr><th>committer</th><td>Matthieu Herrb &lt;matthieu@herrb.eu&gt;</td><td class='right'>2016-09-25 22:21:40 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXrandr/commit/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>a0df3e1c7728205e5c7650b2e6dce684139254a6</a> (<a href='/xorg/lib/libXrandr/patch/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXrandr/tree/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>3b42f0be1951f6e1c1427cf6630786d32eb0c3b4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXrandr/commit/?id=8ac94020b018105240ea45a87df2603d1eb5808b'>8ac94020b018105240ea45a87df2603d1eb5808b</a> (<a href='/xorg/lib/libXrandr/diff/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6&amp;id2=8ac94020b018105240ea45a87df2603d1eb5808b'>diff</a>)</td></tr></table>
<div class='commit-subject'>Avoid out of boundary accesses on illegal responses</div><div class='commit-msg'>The responses of the connected X server have to be properly checked
to avoid out of boundary accesses that could otherwise be triggered
by a malicious server.

Signed-off-by: Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;
Reviewed-by: Matthieu Herrb &lt;matthieu@herrb.eu&gt;
</div><div class='diffstat-header'><a href='/xorg/lib/libXrandr/diff/?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrConfig.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrConfig.c</a></td><td class='right'>32</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 24.1%;'/><td class='rem' style='width: 14.5%;'/><td class='none' style='width: 61.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrCrtc.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrCrtc.c</a></td><td class='right'>83</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 77.1%;'/><td class='rem' style='width: 22.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrMonitor.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrMonitor.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 21.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 78.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrOutput.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrOutput.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 13.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrProvider.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrProvider.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 28.9%;'/><td class='rem' style='width: 4.8%;'/><td class='none' style='width: 66.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXrandr/diff/src/XrrScreen.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrScreen.c</a></td><td class='right'>52</td><td class='graph'><table summary='file diffstat' width='83%'><tr><td class='add' style='width: 42.2%;'/><td class='rem' style='width: 20.5%;'/><td class='none' style='width: 37.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 172 insertions, 52 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/XrrConfig.c b/src/XrrConfig.c<br/>index 2f0282b..e68c45a 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrConfig.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrConfig.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrConfig.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrConfig.c</a></div><div class='hunk'>@@ -29,6 +29,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -272,23 +273,30 @@ static XRRScreenConfiguration *_XRRGetScreenInfo (Display *dpy,</div><div class='ctx'> 	rep.rate = 0;</div><div class='ctx'> 	rep.nrateEnts = 0;</div><div class='ctx'>     }</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2) {</div><div class='add'>+	nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'> </div><div class='del'>-    nbytes = (long) rep.length &lt;&lt; 2;</div><div class='add'>+	nbytesRead = (long) (rep.nSizes * SIZEOF (xScreenSizes) +</div><div class='add'>+			    ((rep.nrateEnts + 1)&amp; ~1) * 2 /* SIZEOF(CARD16) */);</div><div class='ctx'> </div><div class='del'>-    nbytesRead = (long) (rep.nSizes * SIZEOF (xScreenSizes) +</div><div class='del'>-			 ((rep.nrateEnts + 1)&amp; ~1) * 2 /* SIZEOF (CARD16) */);</div><div class='add'>+	/*</div><div class='add'>+	 * first we must compute how much space to allocate for</div><div class='add'>+	 * randr library's use; we'll allocate the structures in a single</div><div class='add'>+	 * allocation, on cleanlyness grounds.</div><div class='add'>+	 */</div><div class='ctx'> </div><div class='del'>-    /*</div><div class='del'>-     * first we must compute how much space to allocate for</div><div class='del'>-     * randr library's use; we'll allocate the structures in a single</div><div class='del'>-     * allocation, on cleanlyness grounds.</div><div class='del'>-     */</div><div class='add'>+	rbytes = sizeof (XRRScreenConfiguration) +</div><div class='add'>+	  (rep.nSizes * sizeof (XRRScreenSize) +</div><div class='add'>+	   rep.nrateEnts * sizeof (int));</div><div class='ctx'> </div><div class='del'>-    rbytes = sizeof (XRRScreenConfiguration) +</div><div class='del'>-      (rep.nSizes * sizeof (XRRScreenSize) +</div><div class='del'>-       rep.nrateEnts * sizeof (int));</div><div class='add'>+	scp = (struct _XRRScreenConfiguration *) Xmalloc(rbytes);</div><div class='add'>+    } else {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	nbytesRead = 0;</div><div class='add'>+	rbytes = 0;</div><div class='add'>+	scp = NULL;</div><div class='add'>+    }</div><div class='ctx'> </div><div class='del'>-    scp = (struct _XRRScreenConfiguration *) Xmalloc(rbytes);</div><div class='ctx'>     if (scp == NULL) {</div><div class='ctx'> 	_XEatData (dpy, (unsigned long) nbytes);</div><div class='ctx'> 	return NULL;</div><div class='head'>diff --git a/src/XrrCrtc.c b/src/XrrCrtc.c<br/>index 5ae35c5..6665092 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrCrtc.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrCrtc.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrCrtc.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrCrtc.c</a></div><div class='hunk'>@@ -24,6 +24,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -57,22 +58,33 @@ XRRGetCrtcInfo (Display *dpy, XRRScreenResources *resources, RRCrtc crtc)</div><div class='ctx'> 	return NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    nbytes = (long) rep.length &lt;&lt; 2;</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2)</div><div class='add'>+    {</div><div class='add'>+	nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'> </div><div class='del'>-    nbytesRead = (long) (rep.nOutput * 4 +</div><div class='del'>-			 rep.nPossibleOutput * 4);</div><div class='add'>+	nbytesRead = (long) (rep.nOutput * 4 +</div><div class='add'>+			     rep.nPossibleOutput * 4);</div><div class='ctx'> </div><div class='del'>-    /*</div><div class='del'>-     * first we must compute how much space to allocate for</div><div class='del'>-     * randr library's use; we'll allocate the structures in a single</div><div class='del'>-     * allocation, on cleanlyness grounds.</div><div class='del'>-     */</div><div class='add'>+	/*</div><div class='add'>+	 * first we must compute how much space to allocate for</div><div class='add'>+	 * randr library's use; we'll allocate the structures in a single</div><div class='add'>+	 * allocation, on cleanlyness grounds.</div><div class='add'>+	 */</div><div class='ctx'> </div><div class='del'>-    rbytes = (sizeof (XRRCrtcInfo) +</div><div class='del'>-	      rep.nOutput * sizeof (RROutput) +</div><div class='del'>-	      rep.nPossibleOutput * sizeof (RROutput));</div><div class='add'>+	rbytes = (sizeof (XRRCrtcInfo) +</div><div class='add'>+		  rep.nOutput * sizeof (RROutput) +</div><div class='add'>+		  rep.nPossibleOutput * sizeof (RROutput));</div><div class='add'>+</div><div class='add'>+	xci = (XRRCrtcInfo *) Xmalloc(rbytes);</div><div class='add'>+    }</div><div class='add'>+    else</div><div class='add'>+    {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	nbytesRead = 0;</div><div class='add'>+	rbytes = 0;</div><div class='add'>+	xci = NULL;</div><div class='add'>+    }</div><div class='ctx'> </div><div class='del'>-    xci = (XRRCrtcInfo *) Xmalloc(rbytes);</div><div class='ctx'>     if (xci == NULL) {</div><div class='ctx'> 	_XEatDataWords (dpy, rep.length);</div><div class='ctx'> 	UnlockDisplay (dpy);</div><div class='hunk'>@@ -194,12 +206,21 @@ XRRGetCrtcGamma (Display *dpy, RRCrtc crtc)</div><div class='ctx'>     if (!_XReply (dpy, (xReply *) &amp;rep, 0, xFalse))</div><div class='ctx'> 	goto out;</div><div class='ctx'> </div><div class='del'>-    nbytes = (long) rep.length &lt;&lt; 2;</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2)</div><div class='add'>+    {</div><div class='add'>+	nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'> </div><div class='del'>-    /* three channels of CARD16 data */</div><div class='del'>-    nbytesRead = (rep.size * 2 * 3);</div><div class='add'>+	/* three channels of CARD16 data */</div><div class='add'>+	nbytesRead = (rep.size * 2 * 3);</div><div class='ctx'> </div><div class='del'>-    crtc_gamma = XRRAllocGamma (rep.size);</div><div class='add'>+	crtc_gamma = XRRAllocGamma (rep.size);</div><div class='add'>+    }</div><div class='add'>+    else</div><div class='add'>+    {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	nbytesRead = 0;</div><div class='add'>+	crtc_gamma = NULL;</div><div class='add'>+    }</div><div class='ctx'> </div><div class='ctx'>     if (!crtc_gamma)</div><div class='ctx'>     {</div><div class='hunk'>@@ -357,7 +378,7 @@ XRRGetCrtcTransform (Display	*dpy,</div><div class='ctx'>     xRRGetCrtcTransformReq	*req;</div><div class='ctx'>     int				major_version, minor_version;</div><div class='ctx'>     XRRCrtcTransformAttributes	*attr;</div><div class='del'>-    char			*extra = NULL, *e;</div><div class='add'>+    char			*extra = NULL, *end = NULL, *e;</div><div class='ctx'>     int				p;</div><div class='ctx'> </div><div class='ctx'>     *attributes = NULL;</div><div class='hunk'>@@ -395,9 +416,17 @@ XRRGetCrtcTransform (Display	*dpy,</div><div class='ctx'> 	else</div><div class='ctx'> 	{</div><div class='ctx'> 	    int extraBytes = rep.length * 4 - CrtcTransformExtra;</div><div class='del'>-	    extra = Xmalloc (extraBytes);</div><div class='add'>+	    if (rep.length &lt; INT_MAX / 4 &amp;&amp;</div><div class='add'>+		rep.length * 4 &gt;= CrtcTransformExtra) {</div><div class='add'>+		extra = Xmalloc (extraBytes);</div><div class='add'>+		end = extra + extraBytes;</div><div class='add'>+	    } else</div><div class='add'>+		extra = NULL;</div><div class='ctx'> 	    if (!extra) {</div><div class='del'>-		_XEatDataWords (dpy, rep.length - (CrtcTransformExtra &gt;&gt; 2));</div><div class='add'>+		if (rep.length &gt; (CrtcTransformExtra &gt;&gt; 2))</div><div class='add'>+		    _XEatDataWords (dpy, rep.length - (CrtcTransformExtra &gt;&gt; 2));</div><div class='add'>+		else</div><div class='add'>+		    _XEatDataWords (dpy, rep.length);</div><div class='ctx'> 		UnlockDisplay (dpy);</div><div class='ctx'> 		SyncHandle ();</div><div class='ctx'> 		return False;</div><div class='hunk'>@@ -429,22 +458,38 @@ XRRGetCrtcTransform (Display	*dpy,</div><div class='ctx'> </div><div class='ctx'>     e = extra;</div><div class='ctx'> </div><div class='add'>+    if (e + rep.pendingNbytesFilter &gt; end) {</div><div class='add'>+	XFree (extra);</div><div class='add'>+	return False;</div><div class='add'>+    }</div><div class='ctx'>     memcpy (attr-&gt;pendingFilter, e, rep.pendingNbytesFilter);</div><div class='ctx'>     attr-&gt;pendingFilter[rep.pendingNbytesFilter] = '\0';</div><div class='ctx'>     e += (rep.pendingNbytesFilter + 3) &amp; ~3;</div><div class='ctx'>     for (p = 0; p &lt; rep.pendingNparamsFilter; p++) {</div><div class='ctx'> 	INT32	f;</div><div class='add'>+	if (e + 4 &gt; end) {</div><div class='add'>+	    XFree (extra);</div><div class='add'>+	    return False;</div><div class='add'>+	}</div><div class='ctx'> 	memcpy (&amp;f, e, 4);</div><div class='ctx'> 	e += 4;</div><div class='ctx'> 	attr-&gt;pendingParams[p] = (XFixed) f;</div><div class='ctx'>     }</div><div class='ctx'>     attr-&gt;pendingNparams = rep.pendingNparamsFilter;</div><div class='ctx'> </div><div class='add'>+    if (e + rep.currentNbytesFilter &gt; end) {</div><div class='add'>+	XFree (extra);</div><div class='add'>+	return False;</div><div class='add'>+    }</div><div class='ctx'>     memcpy (attr-&gt;currentFilter, e, rep.currentNbytesFilter);</div><div class='ctx'>     attr-&gt;currentFilter[rep.currentNbytesFilter] = '\0';</div><div class='ctx'>     e += (rep.currentNbytesFilter + 3) &amp; ~3;</div><div class='ctx'>     for (p = 0; p &lt; rep.currentNparamsFilter; p++) {</div><div class='ctx'> 	INT32	f;</div><div class='add'>+	if (e + 4 &gt; end) {</div><div class='add'>+	    XFree (extra);</div><div class='add'>+	    return False;</div><div class='add'>+	}</div><div class='ctx'> 	memcpy (&amp;f, e, 4);</div><div class='ctx'> 	e += 4;</div><div class='ctx'> 	attr-&gt;currentParams[p] = (XFixed) f;</div><div class='head'>diff --git a/src/XrrMonitor.c b/src/XrrMonitor.c<br/>index a9eaa7b..adc5330 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrMonitor.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrMonitor.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrMonitor.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrMonitor.c</a></div><div class='hunk'>@@ -24,6 +24,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -65,6 +66,15 @@ XRRGetMonitors(Display *dpy, Window window, Bool get_active, int *nmonitors)</div><div class='ctx'> 	return NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='add'>+    if (rep.length &gt; INT_MAX &gt;&gt; 2 ||</div><div class='add'>+	rep.nmonitors &gt; INT_MAX / SIZEOF(xRRMonitorInfo) ||</div><div class='add'>+	rep.noutputs &gt; INT_MAX / 4 ||</div><div class='add'>+	rep.nmonitors * SIZEOF(xRRMonitorInfo) &gt; INT_MAX - rep.noutputs * 4) {</div><div class='add'>+	_XEatData (dpy, rep.length);</div><div class='add'>+	UnlockDisplay (dpy);</div><div class='add'>+	SyncHandle ();</div><div class='add'>+	return NULL;</div><div class='add'>+    }</div><div class='ctx'>     nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'>     nmon = rep.nmonitors;</div><div class='ctx'>     noutput = rep.noutputs;</div><div class='hunk'>@@ -111,6 +121,14 @@ XRRGetMonitors(Display *dpy, Window window, Bool get_active, int *nmonitors)</div><div class='ctx'> 	    mon[m].outputs = output;</div><div class='ctx'> 	    buf += SIZEOF (xRRMonitorInfo);</div><div class='ctx'> 	    xoutput = (CARD32 *) buf;</div><div class='add'>+	    if (xmon-&gt;noutput &gt; rep.noutputs) {</div><div class='add'>+	        Xfree(buf);</div><div class='add'>+	        Xfree(mon);</div><div class='add'>+	        UnlockDisplay (dpy);</div><div class='add'>+	        SyncHandle ();</div><div class='add'>+	        return NULL;</div><div class='add'>+	    }</div><div class='add'>+	    rep.noutputs -= xmon-&gt;noutput;</div><div class='ctx'> 	    for (o = 0; o &lt; xmon-&gt;noutput; o++)</div><div class='ctx'> 		output[o] = xoutput[o];</div><div class='ctx'> 	    output += xmon-&gt;noutput;</div><div class='head'>diff --git a/src/XrrOutput.c b/src/XrrOutput.c<br/>index 85f0b6e..30f3d40 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrOutput.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrOutput.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrOutput.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrOutput.c</a></div><div class='hunk'>@@ -25,6 +25,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -60,6 +61,16 @@ XRRGetOutputInfo (Display *dpy, XRRScreenResources *resources, RROutput output)</div><div class='ctx'> 	return NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='add'>+    if (rep.length &gt; INT_MAX &gt;&gt; 2 || rep.length &lt; (OutputInfoExtra &gt;&gt; 2))</div><div class='add'>+    {</div><div class='add'>+        if (rep.length &gt; (OutputInfoExtra &gt;&gt; 2))</div><div class='add'>+	    _XEatDataWords (dpy, rep.length - (OutputInfoExtra &gt;&gt; 2));</div><div class='add'>+	else</div><div class='add'>+	    _XEatDataWords (dpy, rep.length);</div><div class='add'>+	UnlockDisplay (dpy);</div><div class='add'>+	SyncHandle ();</div><div class='add'>+	return NULL;</div><div class='add'>+    }</div><div class='ctx'>     nbytes = ((long) (rep.length) &lt;&lt; 2) - OutputInfoExtra;</div><div class='ctx'> </div><div class='ctx'>     nbytesRead = (long) (rep.nCrtcs * 4 +</div><div class='head'>diff --git a/src/XrrProvider.c b/src/XrrProvider.c<br/>index 9e620c7..d796cd0 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrProvider.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrProvider.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrProvider.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrProvider.c</a></div><div class='hunk'>@@ -25,6 +25,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -59,12 +60,20 @@ XRRGetProviderResources(Display *dpy, Window window)</div><div class='ctx'>       return NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    nbytes = (long) rep.length &lt;&lt; 2;</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2) {</div><div class='add'>+	nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'> </div><div class='del'>-    nbytesRead = (long) (rep.nProviders * 4);</div><div class='add'>+	nbytesRead = (long) (rep.nProviders * 4);</div><div class='ctx'> </div><div class='del'>-    rbytes = (sizeof(XRRProviderResources) + rep.nProviders * sizeof(RRProvider));</div><div class='del'>-    xrpr = (XRRProviderResources *) Xmalloc(rbytes);</div><div class='add'>+	rbytes = (sizeof(XRRProviderResources) + rep.nProviders *</div><div class='add'>+		  sizeof(RRProvider));</div><div class='add'>+	xrpr = (XRRProviderResources *) Xmalloc(rbytes);</div><div class='add'>+    } else {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	nbytesRead = 0;</div><div class='add'>+	rbytes = 0;</div><div class='add'>+	xrpr = NULL;</div><div class='add'>+    }</div><div class='ctx'> </div><div class='ctx'>     if (xrpr == NULL) {</div><div class='ctx'>        _XEatDataWords (dpy, rep.length);</div><div class='hunk'>@@ -121,6 +130,17 @@ XRRGetProviderInfo(Display *dpy, XRRScreenResources *resources, RRProvider provi</div><div class='ctx'> 	return NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='add'>+    if (rep.length &gt; INT_MAX &gt;&gt; 2 || rep.length &lt; ProviderInfoExtra &gt;&gt; 2)</div><div class='add'>+    {</div><div class='add'>+	if (rep.length &lt; ProviderInfoExtra &gt;&gt; 2)</div><div class='add'>+	    _XEatDataWords (dpy, rep.length);</div><div class='add'>+	else</div><div class='add'>+	    _XEatDataWords (dpy, rep.length - (ProviderInfoExtra &gt;&gt; 2));</div><div class='add'>+	UnlockDisplay (dpy);</div><div class='add'>+	SyncHandle ();</div><div class='add'>+	return NULL;</div><div class='add'>+    }</div><div class='add'>+</div><div class='ctx'>     nbytes = ((long) rep.length &lt;&lt; 2) - ProviderInfoExtra;</div><div class='ctx'> </div><div class='ctx'>     nbytesRead = (long)(rep.nCrtcs * 4 +</div><div class='head'>diff --git a/src/XrrScreen.c b/src/XrrScreen.c<br/>index b8ce7e5..1f7ffe6 100644<br/>--- a/<a href='/xorg/lib/libXrandr/tree/src/XrrScreen.c?id=8ac94020b018105240ea45a87df2603d1eb5808b'>src/XrrScreen.c</a><br/>+++ b/<a href='/xorg/lib/libXrandr/tree/src/XrrScreen.c?id=a0df3e1c7728205e5c7650b2e6dce684139254a6'>src/XrrScreen.c</a></div><div class='hunk'>@@ -24,6 +24,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdio.h&gt;</div><div class='ctx'> #include &lt;X11/Xlib.h&gt;</div><div class='ctx'> /* we need to be able to manipulate the Display structure on events */</div><div class='hunk'>@@ -105,27 +106,36 @@ doGetScreenResources (Display *dpy, Window window, int poll)</div><div class='ctx'> 	xrri-&gt;has_rates = _XRRHasRates (xrri-&gt;minor_version, xrri-&gt;major_version);</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    nbytes = (long) rep.length &lt;&lt; 2;</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2) {</div><div class='add'>+	nbytes = (long) rep.length &lt;&lt; 2;</div><div class='ctx'> </div><div class='del'>-    nbytesRead = (long) (rep.nCrtcs * 4 +</div><div class='del'>-			 rep.nOutputs * 4 +</div><div class='del'>-			 rep.nModes * SIZEOF (xRRModeInfo) +</div><div class='del'>-			 ((rep.nbytesNames + 3) &amp; ~3));</div><div class='add'>+	nbytesRead = (long) (rep.nCrtcs * 4 +</div><div class='add'>+			     rep.nOutputs * 4 +</div><div class='add'>+			     rep.nModes * SIZEOF (xRRModeInfo) +</div><div class='add'>+			     ((rep.nbytesNames + 3) &amp; ~3));</div><div class='ctx'> </div><div class='del'>-    /*</div><div class='del'>-     * first we must compute how much space to allocate for</div><div class='del'>-     * randr library's use; we'll allocate the structures in a single</div><div class='del'>-     * allocation, on cleanlyness grounds.</div><div class='del'>-     */</div><div class='add'>+	/*</div><div class='add'>+	 * first we must compute how much space to allocate for</div><div class='add'>+	 * randr library's use; we'll allocate the structures in a single</div><div class='add'>+	 * allocation, on cleanlyness grounds.</div><div class='add'>+	 */</div><div class='add'>+</div><div class='add'>+	rbytes = (sizeof (XRRScreenResources) +</div><div class='add'>+		  rep.nCrtcs * sizeof (RRCrtc) +</div><div class='add'>+		  rep.nOutputs * sizeof (RROutput) +</div><div class='add'>+		  rep.nModes * sizeof (XRRModeInfo) +</div><div class='add'>+		  rep.nbytesNames + rep.nModes);    /* '\0' terminate names */</div><div class='ctx'> </div><div class='del'>-    rbytes = (sizeof (XRRScreenResources) +</div><div class='del'>-	      rep.nCrtcs * sizeof (RRCrtc) +</div><div class='del'>-	      rep.nOutputs * sizeof (RROutput) +</div><div class='del'>-	      rep.nModes * sizeof (XRRModeInfo) +</div><div class='del'>-	      rep.nbytesNames + rep.nModes);	/* '\0' terminate names */</div><div class='add'>+	xrsr = (XRRScreenResources *) Xmalloc(rbytes);</div><div class='add'>+	wire_names = (char *) Xmalloc (rep.nbytesNames);</div><div class='add'>+    } else {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	nbytesRead = 0;</div><div class='add'>+	rbytes = 0;</div><div class='add'>+	xrsr = NULL;</div><div class='add'>+	wire_names = NULL;</div><div class='add'>+    }</div><div class='ctx'> </div><div class='del'>-    xrsr = (XRRScreenResources *) Xmalloc(rbytes);</div><div class='del'>-    wire_names = (char *) Xmalloc (rep.nbytesNames);</div><div class='ctx'>     if (xrsr == NULL || wire_names == NULL) {</div><div class='ctx'> 	Xfree (xrsr);</div><div class='ctx'> 	Xfree (wire_names);</div><div class='hunk'>@@ -174,6 +184,14 @@ doGetScreenResources (Display *dpy, Window window, int poll)</div><div class='ctx'>     wire_name = wire_names;</div><div class='ctx'>     for (i = 0; i &lt; rep.nModes; i++)  {</div><div class='ctx'> 	xrsr-&gt;modes[i].name = names;</div><div class='add'>+	if (xrsr-&gt;modes[i].nameLength &gt; rep.nbytesNames) {</div><div class='add'>+	    Xfree (xrsr);</div><div class='add'>+	    Xfree (wire_names);</div><div class='add'>+	    UnlockDisplay (dpy);</div><div class='add'>+	    SyncHandle ();</div><div class='add'>+	    return NULL;</div><div class='add'>+	}</div><div class='add'>+	rep.nbytesNames -= xrsr-&gt;modes[i].nameLength;</div><div class='ctx'> 	memcpy (names, wire_name, xrsr-&gt;modes[i].nameLength);</div><div class='ctx'> 	names[xrsr-&gt;modes[i].nameLength] = '\0';</div><div class='ctx'> 	names += xrsr-&gt;modes[i].nameLength + 1;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
