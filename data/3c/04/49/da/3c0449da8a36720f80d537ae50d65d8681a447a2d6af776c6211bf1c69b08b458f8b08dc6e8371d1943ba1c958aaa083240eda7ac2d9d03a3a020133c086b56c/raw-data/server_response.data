<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Diff - ae33effd43a615183f089f0a216b5965e8104842^! - platform/frameworks/native - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/frameworks/native/%2B/ae33effd43a615183f089f0a216b5965e8104842%255E%2521/">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/">frameworks</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/native/">native</a> / <a class="Breadcrumbs-crumb" href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842%5E%21/">ae33effd43a615183f089f0a216b5965e8104842^!</a> / <span class="Breadcrumbs-crumb">.</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>ae33effd43a615183f089f0a216b5965e8104842</td><td><span>[<a href="/platform/frameworks/native/+log/ae33effd43a615183f089f0a216b5965e8104842/">log</a>]</span> <span>[<a href="/platform/frameworks/native/+archive/ae33effd43a615183f089f0a216b5965e8104842/.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Michael Lentine &lt;mlentine@google.com&gt;</td><td>Fri Oct 31 11:10:13 2014 -0700</td></tr><tr><th class="Metadata-title">committer</th><td>Dan Stoza &lt;stoza@google.com&gt;</td><td>Fri Dec 05 20:31:09 2014 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842/">a4a8b22b63f8ca97a625398cdedebb93dcf2814b</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842%5E">09b9193d10b3849e426c5370a757a0eedc65a7ff</a> <span>[<a href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">Fix crash when user provides large values in the Parcel.

Bug: 18102648
Change-Id: <a href="https://android-review.googlesource.com/#/q/Ie6a24718e586a34424238363de80f9545951514f">Ie6a24718e586a34424238363de80f9545951514f</a>
(cherry-picked from commit 8afa1c4ab86d724feb7716e153b7835385534590)</pre><pre class="u-pre u-monospace Diff"><a name="F0" class="Diff-fileIndex"></a>diff --git <a href="/platform/frameworks/native/+/09b9193d10b3849e426c5370a757a0eedc65a7ff/libs/gui/ISurfaceComposer.cpp">a/libs/gui/ISurfaceComposer.cpp</a> <a href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842/libs/gui/ISurfaceComposer.cpp">b/libs/gui/ISurfaceComposer.cpp</a>
index 669755a..bc4baa3 100644
--- a/libs/gui/ISurfaceComposer.cpp
+++ b/libs/gui/ISurfaceComposer.cpp
</pre><pre class="u-pre u-monospace Diff-unified"><span class="Diff-hunk">@@ -312,19 +312,29 @@
</span><span class="Diff-change">         case SET_TRANSACTION_STATE: {</span>
<span class="Diff-change">             CHECK_INTERFACE(ISurfaceComposer, data, reply);</span>
<span class="Diff-change">             size_t count = data.readInt32();</span>
<span class="Diff-insert">+            if (count &gt; data.dataSize()) {</span>
<span class="Diff-insert">+                return BAD_VALUE;</span>
<span class="Diff-insert">+            }</span>
<span class="Diff-change">             ComposerState s;</span>
<span class="Diff-change">             Vector&lt;ComposerState&gt; state;</span>
<span class="Diff-change">             state.setCapacity(count);</span>
<span class="Diff-change">             for (size_t i=0 ; i&lt;count ; i++) {</span>
<span class="Diff-delete">-                s.read(data);</span>
<span class="Diff-insert">+                if (s.read(data) == BAD_VALUE) {</span>
<span class="Diff-insert">+                    return BAD_VALUE;</span>
<span class="Diff-insert">+                }</span>
<span class="Diff-change">                 state.add(s);</span>
<span class="Diff-change">             }</span>
<span class="Diff-change">             count = data.readInt32();</span>
<span class="Diff-insert">+            if (count &gt; data.dataSize()) {</span>
<span class="Diff-insert">+                return BAD_VALUE;</span>
<span class="Diff-insert">+            }</span>
<span class="Diff-change">             DisplayState d;</span>
<span class="Diff-change">             Vector&lt;DisplayState&gt; displays;</span>
<span class="Diff-change">             displays.setCapacity(count);</span>
<span class="Diff-change">             for (size_t i=0 ; i&lt;count ; i++) {</span>
<span class="Diff-delete">-                d.read(data);</span>
<span class="Diff-insert">+                if (d.read(data) == BAD_VALUE) {</span>
<span class="Diff-insert">+                    return BAD_VALUE;</span>
<span class="Diff-insert">+                }</span>
<span class="Diff-change">                 displays.add(d);</span>
<span class="Diff-change">             }</span>
<span class="Diff-change">             uint32_t flags = data.readInt32();</span>
</pre><pre class="u-pre u-monospace Diff"><a name="F1" class="Diff-fileIndex"></a>diff --git <a href="/platform/frameworks/native/+/09b9193d10b3849e426c5370a757a0eedc65a7ff/libs/gui/LayerState.cpp">a/libs/gui/LayerState.cpp</a> <a href="/platform/frameworks/native/+/ae33effd43a615183f089f0a216b5965e8104842/libs/gui/LayerState.cpp">b/libs/gui/LayerState.cpp</a>
index dcdcdf2..ccf8b78 100644
--- a/libs/gui/LayerState.cpp
+++ b/libs/gui/LayerState.cpp
</pre><pre class="u-pre u-monospace Diff-unified"><span class="Diff-hunk">@@ -55,8 +55,12 @@
</span><span class="Diff-change">     alpha = input.readFloat();</span>
<span class="Diff-change">     flags = input.readInt32();</span>
<span class="Diff-change">     mask = input.readInt32();</span>
<span class="Diff-delete">-    matrix = *reinterpret_cast&lt;layer_state_t::matrix22_t const *&gt;(</span>
<span class="Diff-delete">-            input.readInplace(sizeof(layer_state_t::matrix22_t)));</span>
<span class="Diff-insert">+    const void* matrix_data = input.readInplace(sizeof(layer_state_t::matrix22_t));</span>
<span class="Diff-insert">+    if (matrix_data) {</span>
<span class="Diff-insert">+        matrix = *reinterpret_cast&lt;layer_state_t::matrix22_t const *&gt;(matrix_data);</span>
<span class="Diff-insert">+    } else {</span>
<span class="Diff-insert">+        return BAD_VALUE;</span>
<span class="Diff-insert">+    }</span>
<span class="Diff-change">     input.read(crop);</span>
<span class="Diff-change">     input.read(transparentRegion);</span>
<span class="Diff-change">     return NO_ERROR;</span>
</pre></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>