
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>
Issue 30657: [security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape - Python tracker

</title>
<link rel="shortcut icon" href="@@file/favicon.ico" />
<link rel="stylesheet" type="text/css" href="@@file/main.css" />
<link rel="stylesheet" type="text/css" href="@@file/style.css" />
<link rel="search" type="application/opensearchdescription+xml" href="@@file/osd.xml" title="Python bug tracker search" />
<meta http-equiv="Content-Type"
      content="text/html; charset=utf-8" />

<script nonce="b2f7a9ecb5cec83a5d03e44c031d59c908ab72de0a8ea694aaadcd6cbfa3d523" type="text/javascript">
submitted = false;
function submit_once() {
    if (submitted) {
        alert("Your request is being processed.\nPlease be patient.");
        return false;
    }
    submitted = true;
    return true;
}

function help_window(helpurl, width, height) {
    HelpWin = window.open('https://bugs.python.org/' + helpurl, 'RoundupHelpWindow', 'scrollbars=yes,resizable=yes,toolbar=no,height='+height+',width='+width);
    HelpWin.focus ()
}
</script>


<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.js"></script>
<script type="text/javascript" src="@@file/issue.item.js"></script>
<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/smoothness/jquery-ui.css" />


</head>
<body>
  <!--  Logo  -->
  <h1 id="logoheader">
    <a accesskey="1" href="." id="logolink">
       <img src="@@file/python-logo.gif" alt="homepage" border="0" id="logo" /></a>
  </h1>

<div id="utility-menu">
<!-- Search Box -->
<div id="searchbox">
    <form name="searchform" method="get" action="issue" id="searchform">
      <div id="search">
       <input type="hidden" name="@columns"
              value="id,activity,title,creator,assignee,status,type" />
       <input type="hidden" name="@sort" value="-activity" />
       <input type="hidden" name="@filter" value="status" />
       <input type="hidden" name="@action" value="searchid" />
       <input type="hidden" name="ignore" value="file:content" />
       <input class="input-text" id="search-text"
              name="@search_text" size="10" />
       <input type="submit" id="submit" value="search" name="submit" class="input-button" />
       <input type="radio" name="status"
              id="status_notresolved" value="-1,1,3" />
       <label for="status_notresolved">open</label>
       <input type="radio" name="status" checked="checked"
              id="status_all" value="-1,1,2,3" />
       <label for="status_all">all</label>
      </div>
     </form>
</div>
</div>


<div id="left-hand-navigation">
<!--  Main Menu NEED LEVEL TWO HEADER AND FOOTER -->
<div id="menu">
  <ul class="level-one">
    <li><a href="https://www.python.org/" title="Go to the Python homepage">Python Home</a></li>
    <li><a href="https://www.python.org/about/" title="About The Python Language">About</a></li>
    <li><a href="https://www.python.org/blogs/" title="">News</a></li>
    <li><a href="https://www.python.org/doc/" title="">Documentation</a></li>
    <li><a href="https://www.python.org/downloads/" title="">Downloads</a></li>
    <li><a href="https://www.python.org/community/" title="">Community</a></li>
    <li><a href="https://www.python.org/psf/" title="Python Software Foundation">Foundation</a></li>
    <li><a href="https://devguide.python.org/" title="Python Developer's Guide">Developer's Guide</a></li>
    <li class="selected"><a href="." class="selected" title="Python Issue Tracker">Issue Tracker</a>
      <ul class="level-two">
        <li>
          <strong>Issues</strong>
          <ul class="level-three">
            
            <li><a href="issue?@template=search&amp;status=1">Search</a></li>
            <li><a href="issue?@action=random">Random Issue</a></li>
            <li>
              <form method="post" action="issue30657">
                <input type="submit" class="form-small"
                       value="Show issue:" />
                <input class="form-small" size="4" type="text" name="@number" />
                <input type="hidden" name="@type" value="issue" />
                <input type="hidden" name="@action" value="show" />
              </form>
            </li>
          </ul>
        </li>


        <li>
          <strong>Summaries</strong>
          <ul class="level-three">
            

            

            

            <li>
              <a href="issue?status=1&amp;@sort=-activity&amp;@columns=id%2Cactivity%2Ctitle%2Ccreator%2Cstatus&amp;@dispname=Issues%20with%20patch&amp;@startwith=0&amp;@group=priority&amp;keywords=2&amp;@action=search&amp;@filter=&amp;@pagesize=50">Issues with patch</a>
            </li>

            <li>
              <a href="issue?status=1&amp;@sort=-activity&amp;@columns=id%2Cactivity%2Ctitle%2Ccreator%2Cstatus&amp;@dispname=Easy%20issues&amp;@startwith=0&amp;@group=priority&amp;keywords=6&amp;@action=search&amp;@filter=&amp;@pagesize=50">Easy issues</a>
            </li>

            <li>
              <a href="issue?@template=stats">Stats</a>
            </li>

          </ul>
        </li>


        <li>
          <strong>User</strong>
          <form method="post" action="issue30657">
          <ul class="level-three">
            <li>
                Login&nbsp;(OpenID&nbsp;possible)<br />
	         <a style="display:inline;width:0;margin:0"
             href="issue30657?@action=oic_login&amp;provider=Google">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://www.google.com/favicon.ico"
                       alt="Google" title="Google" /></a>
	         <a style="display:inline;width:0;margin:0"
             href="issue30657?@action=oic_login&amp;provider=GitHub">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://www.github.com/favicon.ico"
                       alt="GitHub" title="GitHub" /></a>
	         <a style="display:inline;width:0;margin:0"
             href="issue30657?@action=openid_login&amp;provider=Launchpad">
                  <img hspace="0" vspace="0" width="16"
                       height="16"
                       src="https://launchpad.net/favicon.ico"
                       alt="Launchpad" title="Launchpad" /></a>
                <input size="10" name="openid_identifier" style="background:url(@@file/openid-16x16.gif)
                  center left no-repeat;padding-left:16px" /><br />
                <input size="10" type="password" name="__login_password" /><br />
                <input type="hidden" name="@action" value="Login" />
                <input type="checkbox" name="remember" id="remember" />
                <label for="remember">Remember me?</label><br />
                <input class="form-small" type="submit"
                       value="Login" /><br />
                <input type="hidden" name="__came_from"
                       value="https://bugs.python.org/issue30657?">
                
                <input type="hidden" name="@sort" value=""/>
<input type="hidden" name="@group" value=""/>
<input type="hidden" name="@pagesize" value="50"/>
<input type="hidden" name="@startwith" value="0"/>
            </li>
            <li>
                <a href="user?@template=register">Register</a>
            </li>
            <li><a href="user?@template=forgotten">Lost&nbsp;your&nbsp;login?</a></li>
          </ul>
          </form>
        </li>

        

        

        <li>
          <strong>Administration</strong>
          <ul class="level-three">
            
            <li>
                <a href="user?@sort=username">User List</a></li>
            <li>
                <a href="user?iscommitter=1&amp;@action=search&amp;@sort=username&amp;@pagesize=300">Committer List</a></li>
            
            
            
          </ul>
        </li>

        <li>
          <strong>Help</strong>
          <ul class="level-three">
            <li><a href="http://docs.python.org/devguide/triaging.html">
                Tracker Documentation</a></li>
            <li><a href="http://wiki.python.org/moin/TrackerDevelopment">
                Tracker Development</a></li>
            <li><a href="https://github.com/python/psf-infra-meta/issues">
                Report Tracker Problem</a></li>
          </ul>
        </li>

      </ul>
    </li>
  </ul>
</div> <!-- menu -->
</div> <!-- left-hand-navigation -->

<div id="content-body">
<div id="body-main">
<div id="content">
<div id="breadcrumb">
 
 
 Issue30657
 
</div>
 
 





<div>

<form method="post" name="itemSynopsis"
      onsubmit="return submit_once()"
      enctype="multipart/form-data" action="issue30657">

<fieldset><legend>classification</legend>
<table class="form">
<tr>
 <th class="required"><a href="http://docs.python.org/devguide/triaging.html#title" target="_blank">Title</a>:</th>
 
 <td colspan="3">
  <span>[security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape</span>
  <input type="hidden" name="title"
         value="[security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape">
 </td>
</tr>

<tr>
 <th class="required"><a href="http://docs.python.org/devguide/triaging.html#type" target="_blank">Type</a>:</th>
 <td>security</td>
 <th><a href="http://docs.python.org/devguide/triaging.html#stage" target="_blank">Stage</a>:</th>
 <td>resolved</td>
</tr>

<tr>
 <th><a href="http://docs.python.org/devguide/triaging.html#components" target="_blank">Components</a>:</th>
 <td>Interpreter Core</td>
 <th><a href="http://docs.python.org/devguide/triaging.html#versions" target="_blank">Versions</a>:</th>
 <td>Python 3.4, Python 3.5, Python 2.7</td>
</tr>
</table>
</fieldset>

<fieldset><legend>process</legend>
<table class="form">
<tr>
  <th><a href="http://docs.python.org/devguide/triaging.html#status" target="_blank">Status</a>:</th>
  <td>closed</td>
  <th><a href="http://docs.python.org/devguide/triaging.html#resolution" target="_blank">Resolution</a>:</th>
  <td>fixed</td>
</tr>

<tr>
 <th>
    <a href="http://docs.python.org/devguide/triaging.html#dependencies"
       target="_blank">Dependencies</a>:
 </th>
 <td>
  
  
 </td>
 <th><a href="http://docs.python.org/devguide/triaging.html#superseder" target="_blank">Superseder</a>:</th>
 <td>
  
 
 </td>
 </tr>
 <tr>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#assigned-to"
      target="_blank">Assigned To</a>:
 </th>
 
 <td>
  serhiy.storchaka
 </td>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#nosy-list"
      target="_blank">Nosy List</a><!--
        <span tal:condition="context/nosy_count" tal:replace="python: ' (%d)' % context.nosy_count" /> -->:
 </th>
 <td>
     jaybosamiya, larry, leosilva, ned.deily, serhiy.storchaka, vstinner
     
 </td>
</tr>
<tr>
 <th>
   <a href="http://docs.python.org/devguide/triaging.html#priority"
      target="_blank">Priority</a>:
 </th>
 <td>normal</td>
 <th>
    <a href="http://docs.python.org/devguide/triaging.html#keywords"
       target="_blank">Keywords</a>:
 </th>
 <td>easy (C), patch</td>


</tr>









</table>
</fieldset>

</form>

<p>Created on <strong>2017-06-13 15:35</strong> by <strong>jaybosamiya</strong>, last changed <strong>2019-05-10 18:20</strong> by <strong>ned.deily</strong>. This issue is now <strong style="color:#00F; background-color:inherit;">closed</strong>.</p>

<table class="files">
 <tr><th colspan="5" class="header">Files</th></tr>
 <tr>
  <th>File name</th>
  <th>Uploaded</th>
  <th>Description</th>
  <th>Edit</th>
 </tr>
 <tr>
  <td>
   <a href="file46950/poc-gen.py">poc-gen.py</a>
  </td>
  <td>
   <span>jaybosamiya</span>,
   <span>2017-06-13 15:35</span>
  </td>
  <td>Generates poc.py</td>
  <td>
      
      
      
  </td>
 </tr>
</table>

<table class="files">
 <tr><th class="header" colspan="4">Pull Requests</th></tr>
 <tr>
  <th>URL</th>
  <th>Status</th>
  <th>Linked</th>
  <th>Edit</th>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/2174" title="[2.7] bpo-30657: Check & prevent integer overflow in PyString_DecodeEscape">PR 2174</a></td>
  <td>merged</td>
  <td>
   <span>jaybosamiya</span>,
   <span>2017-06-13 20:14</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/4664" title="[3.5] bpo-30657: Check & prevent integer overflow in PyString_DecodeEscape (GH-2174)">PR 4664</a></td>
  <td>merged</td>
  <td>
   <span>hroncok</span>,
   <span>2017-12-01 17:59</span>
  </td>
  <td>
    
  </td>
 </tr>
 <tr>
  <td><a href="https://github.com/python/cpython/pull/4758" title="[3.4] bpo-30657: Check & prevent integer overflow in PyString_DecodeEscape (GH-2174)">PR 4758</a></td>
  <td>merged</td>
  <td>
   <span>hroncok</span>,
   <span>2017-12-08 20:33</span>
  </td>
  <td>
    
  </td>
 </tr>
</table>





<table class="messages">
 <tr><th colspan="4" class="header">Messages (17)</th></tr>
 
  <tr>
    <th>
     <a href="#msg295930" id="msg295930">msg295930</a> - <a
    href="msg295930">(view)</a></th>
   <th>Author: Jay Bosamiya (jaybosamiya) <span title="Contributor form received">*</span></th>
   <th>Date: 2017-06-13 15:35</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>In Python 2.7, there is a possible integer overflow in
PyString_DecodeEscape function of the file stringobject.c, which can
be abused to gain a heap overflow, possibly leading to arbitrary code
execution.

The relevant parts of the code are highlighted below:

    PyObject *PyString_DecodeEscape(const char *s,
                                    Py_ssize_t len,
                                    const char *errors,
                                    Py_ssize_t unicode,
                                    const char *recode_encoding)
    {
        int c;
        char *p, *buf;
        const char *end;
        PyObject *v;
(1)     Py_ssize_t newlen = recode_encoding ? 4*len:len;
(2)     v = PyString_FromStringAndSize((char *)NULL, newlen);
        if (v == NULL)
            return NULL;
(3)     p = buf = PyString_AsString(v);
        end = s + len;
        while (s &lt; end) {
            if (*s != '\\') {
              non_esc:
    #ifdef Py_USING_UNICODE
    [...]
    #else
                *p++ = *s++;
    #endif
                continue;
    [...]
            }
        }
(4)     if (p-buf &lt; newlen)
            _PyString_Resize(&amp;v, p - buf); /* v is cleared on error */
        return v;
      failed:
        Py_DECREF(v);
        return NULL;
    }


(1) If recode_encoding is true (i.e., non-null), we have an integer
      overflow here which can set newlen to be some very small value
(2) This allows a small string to be created into v
(3) Now p (and buf) use that small string
(4) The small string is copied into with a larger string, thereby
      giving a heap buffer overflow

In the highly unlikely but definitely possible situation that we pass
it a very large string (in the order of ~1GB on a 32-bit Python
install), one can reliably get heap corruption. It is possible to
access this function (and condition in line(1)) through function
parsestr from ast.c, when the file encoding of an input .py file is
something apart from utf-8 and iso-8859-1. This can be trivially done
using the following at the start of the file:
    # -*- coding: us-ascii -*-

The attached file (poc-gen.py) produces a poc.py file which satisfies
these constraints and shows the vulnerability.

Note: To see the vulnerability in action, it is necessary to have an
ASAN build of Python, compiled for 32 bit on a 64 bit machine.
Additionally, the poc.py file generated can take an extremely long
time to load (over a few hours), and finally crash. Instead, if one
wishes to see the proof of vulnerability quicker, then it might be
better to change the constant 4 in line (1) to 65536 (just for
simplicity sake), and change the multiplication_constant in poc-gen.py
file to be the same (i.e. 65536).

Proposed fix: Confirm that the multiplication will not overflow,
before actually performing the multiplication and depending on the
result.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg295947" id="msg295947">msg295947</a> - <a
    href="msg295947">(view)</a></th>
   <th>Author: Serhiy Storchaka (serhiy.storchaka) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-06-13 18:05</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Thank you for your report Jay. Even if it very unlikely that this can occurred unintentionally or be used for attack, this still is a bug and should be fixed. Do you want to provide a patch?</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg295957" id="msg295957">msg295957</a> - <a
    href="msg295957">(view)</a></th>
   <th>Author: Jay Bosamiya (jaybosamiya) <span title="Contributor form received">*</span></th>
   <th>Date: 2017-06-13 20:19</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I've made a patch that should fix the vulnerability. Please do let me know if changes are required. Thanks a lot :)

PS: For anyone who looks at this later on, in my original message describing the issue, the line `*p++ = *s++;` should be marked as (4) instead to understand this issue better.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg296277" id="msg296277">msg296277</a> - <a
    href="msg296277">(view)</a></th>
   <th>Author: Serhiy Storchaka (serhiy.storchaka) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-06-18 16:41</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/c3c9db89273fabc62ea1b48389d9a3000c1c03ae">c3c9db89273fabc62ea1b48389d9a3000c1c03ae</a> by Serhiy Storchaka (Jay Bosamiya) in branch '2.7':
[2.7] <a class="closed" title="[closed] [security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape" href="issue30657">bpo-30657</a>: Check &amp; prevent integer overflow in PyString_DecodeEscape (<a class="closed" title="[closed] xml.sax.xmlreader does not support the InputSource protocol" href="issue2174">#2174</a>)
<a href="https://github.com/python/cpython/commit/c3c9db89273fabc62ea1b48389d9a3000c1c03ae">https://github.com/python/cpython/commit/c3c9db89273fabc62ea1b48389d9a3000c1c03ae</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg306823" id="msg306823">msg306823</a> - <a
    href="msg306823">(view)</a></th>
   <th>Author: Leonidas S. Barbosa (leosilva)</th>
   <th>Date: 2017-11-23 15:11</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I couldn't reproduce using the poc, but seems python3.5 is also vulnerable to this bug. The code from py3.5 are quite similar to 2.7. 
In py3.5: <a href="https://github.com/python/cpython/blob/master/Objects/bytesobject.c">Objects/bytesobject.c</a> PyBytes_DecodeEscape</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg306826" id="msg306826">msg306826</a> - <a
    href="msg306826">(view)</a></th>
   <th>Author: Serhiy Storchaka (serhiy.storchaka) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-23 16:06</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Right, but it is not easy to exploit this bug. You need to parse Python sources longer than 512 MiB in 32-bit Python.

Python 3.5 currently takes only fixes for security bugs. I left on to Larry to decide whether it is worth to port the fix to 3.5.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg306875" id="msg306875">msg306875</a> - <a
    href="msg306875">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-24 01:34</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I would welcome a backport of this for 3.5 and even 3.4 (if it's vulnerable, which it probably is).</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg306890" id="msg306890">msg306890</a> - <a
    href="msg306890">(view)</a></th>
   <th>Author: Leonidas S. Barbosa (leosilva)</th>
   <th>Date: 2017-11-24 11:21</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Python 3.4 also has the similar code as 3.5, but applying the same patch tests for it results in test errors:

+======================================================================                                                                                                                                  
+ERROR: test_anydbm_creation (test.test_dbm.TestCase-dbm.ndbm)                                                                                                                                           
+----------------------------------------------------------------------                                                                                                                                 
+Traceback (most recent call last):                                                                                                                                                                    
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 74, in test_anydbm_creation^M                                                                                                                         
+    self.read_helper(f)^M                                                                                                                                                                                  
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 115, in read_helper                                                                                                                                
+    self.assertEqual(self._dict[key], f[key.encode("ascii")])                                                                                                                                           
+KeyError: b'0'                                                                                                                                                                                         
+                                                                                                                                                                                                        
+======================================================================                                                                                                                                  
+ERROR: test_anydbm_modification (test.test_dbm.TestCase-dbm.ndbm)                                                                                                                                        
+----------------------------------------------------------------------                                                                                                                                 
+Traceback (most recent call last):                                                                                                                                                                      
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 89, in test_anydbm_modification                                                                                                                   
+    self.read_helper(f)                                                                                                                                                                                
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 115, in read_helper                                                                                                                                
+    self.assertEqual(self._dict[key], f[key.encode("ascii")])                                                                                                                                           
+KeyError: b'0'                                                                                                                                                                                          
+                                                                                                                                                                                                       
+======================================================================                                                                                                                                  
+ERROR: test_anydbm_read (test.test_dbm.TestCase-dbm.ndbm)                                                                                                                                               
+----------------------------------------------------------------------                                                                                                                                  
+Traceback (most recent call last):                                                                                                                                                                      
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 95, in test_anydbm_read                                                                                                                             
+    self.read_helper(f)                                                                                                                                                                                 
+  File "/&lt;&lt;PKGBUILDDIR&gt;&gt;/Lib/test/test_dbm.py", line 115, in read_helper                                                                                                                                
+    self.assertEqual(self._dict[key], f[key.encode("ascii")])                                                                                                                                            
+KeyError: b'0'</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307138" id="msg307138">msg307138</a> - <a
    href="msg307138">(view)</a></th>
   <th>Author: Leonidas S. Barbosa (leosilva)</th>
   <th>Date: 2017-11-28 15:59</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I re-did the build here for python3.4 and couldn't reach the same test fail. So I'm assuming it was a false alarm. 
Said that, I believe the same patch that applies to py2.7 also applies to 3.4 and 3.5. I've build them using the patch and did some regression tests and it was ok.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307238" id="msg307238">msg307238</a> - <a
    href="msg307238">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-29 16:05</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Leo kirotawa silva: "I re-did the build here for python3.4 and couldn't reach the same test fail. So I'm assuming it was a false alarm."

Python 3.4 and 3.5 seem to be also vulnerable:
---

PyObject *PyBytes_DecodeEscape(const char *s,
                                Py_ssize_t len,
                                const char *errors,
                                Py_ssize_t unicode,
                                const char *recode_encoding)
{
    ...
    Py_ssize_t newlen = recode_encoding ? 4*len:len;
    v = PyBytes_FromStringAndSize((char *)NULL, newlen);
---

I don't think that Python 3.6 and 3.7 are vulnerable, the code was rewritten with the _PyBytesWriter API. The code got a new _PyBytes_DecodeEscapeRecode() helper function which calls _PyBytesWriter_WriteBytes(), and this function detects properly integer overflows.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307240" id="msg307240">msg307240</a> - <a
    href="msg307240">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-29 16:21</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I added this vulnerability to the python-security website:
<a href="http://python-security.readthedocs.io/vuln/cve-2017-1000158_pystring_decodeescape_integer_overflow.html">http://python-security.readthedocs.io/vuln/cve-2017-1000158_pystring_decodeescape_integer_overflow.html</a></pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307243" id="msg307243">msg307243</a> - <a
    href="msg307243">(view)</a></th>
   <th>Author: Serhiy Storchaka (serhiy.storchaka) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-29 17:03</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>I don't think it is worth to add this vulnerability to the python-security website. You need to compile a 1 GiB Python file on 32-bit system for reproducing it. It is very unlikely that this can happen by accident, and it is hard to used it in security attack. If you can make the attacked program compiling a 1 GiB Python file, you perhaps have easier ways to make a harm.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307245" id="msg307245">msg307245</a> - <a
    href="msg307245">(view)</a></th>
   <th>Author: STINNER Victor (vstinner) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-29 17:09</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Serhiy: "I don't think it is worth to add this vulnerability to the python-security website. You need to compile a 1 GiB Python file on 32-bit system for reproducing it. It is very unlikely that this can happen by accident, and it is hard to used it in security attack. If you can make the attacked program compiling a 1 GiB Python file, you perhaps have easier ways to make a harm."

I'm trying to keep track of all CVEs. People are scared by CVE numbers :-( But it seems like any bug can get a CVE number, without any real evalution of the severity of the bug.

I completed the description on python-security with your paragraph.

FYI I wrote python-security to make sure that vulnerabilities are fixed in supported Python branches. Here it seems like we forgot to fix Python 3.4 and 3.5.</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307246" id="msg307246">msg307246</a> - <a
    href="msg307246">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-11-29 17:11</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Resetting to "needs patch", because we still need PRs for 3.4 and 3.5 (please!).</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307868" id="msg307868">msg307868</a> - <a
    href="msg307868">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-12-08 21:34</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/fd8614c5c5466a14a945db5b059c10c0fb8f76d9">fd8614c5c5466a14a945db5b059c10c0fb8f76d9</a> by larryhastings (Miro Hrončok) in branch '3.5':
<a class="closed" title="[closed] [security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape" href="issue30657">bpo-30657</a>: Fix CVE-2017-1000158 (<a class="closed" title="[closed] Regression fix_imports does not refactor multiple imports correctly" href="issue4664">#4664</a>)
<a href="https://github.com/python/cpython/commit/fd8614c5c5466a14a945db5b059c10c0fb8f76d9">https://github.com/python/cpython/commit/fd8614c5c5466a14a945db5b059c10c0fb8f76d9</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307869" id="msg307869">msg307869</a> - <a
    href="msg307869">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-12-08 21:34</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>
New changeset <a href="https://hg.python.org/lookup/6c004b40f9d51872d848981ef1a18bb08c2dfc42">6c004b40f9d51872d848981ef1a18bb08c2dfc42</a> by larryhastings (Miro Hrončok) in branch '3.4':
<a class="closed" title="[closed] [security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape" href="issue30657">bpo-30657</a>: Fix CVE-2017-1000158 (<a class="closed" title="[closed] Python 3.x internet documentation needs work" href="issue4758">#4758</a>)
<a href="https://github.com/python/cpython/commit/6c004b40f9d51872d848981ef1a18bb08c2dfc42">https://github.com/python/cpython/commit/6c004b40f9d51872d848981ef1a18bb08c2dfc42</a>
</pre>
   </td>
  </tr>
 
 
  <tr>
    <th>
     <a href="#msg307870" id="msg307870">msg307870</a> - <a
    href="msg307870">(view)</a></th>
   <th>Author: Larry Hastings (larry) <span title="Contributor form received">*</span> <img src="@@file/committer.png" title="Python committer" alt="(Python committer)" /></th>
   <th>Date: 2017-12-08 21:36</th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    
    <pre>Merged into 3.4 and 3.5.  Thanks for the patches!

Since I see 2.7 has already had the fix committed, and these are the only three versions affected, I'm marking as closed / resolved / fixed.</pre>
   </td>
  </tr>
 
</table>

<table class="history table table-condensed table-striped"><tr><th colspan="4" class="header">
History
</th></tr><tr>
<th>Date</th>
<th>User</th>
<th>Action</th>
<th>Args</th>
</tr>
<tr><td>2019-05-10&nbsp;18:20:34</td><td>ned.deily</td><td>set</td><td>messages:
  - <a rel="nofollow" href="msg342086">msg342086</a></td></tr>
<tr><td>2019-05-10&nbsp;17:36:37</td><td>ned.deily</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user5248">ned.deily</a><br />messages:
  + <a rel="nofollow" href="msg342086">msg342086</a><br /></td></tr>
<tr><td>2017-12-08&nbsp;21:36:52</td><td>larry</td><td>set</td><td>status: open -> closed<br />resolution: fixed<br />messages:
  + <a rel="nofollow" href="msg307870">msg307870</a><br /><br />stage: patch review -> resolved</td></tr>
<tr><td>2017-12-08&nbsp;21:34:46</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307869">msg307869</a></td></tr>
<tr><td>2017-12-08&nbsp;21:34:19</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307868">msg307868</a></td></tr>
<tr><td>2017-12-08&nbsp;20:33:27</td><td>hroncok</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request4661">pull_request4661</a></td></tr>
<tr><td>2017-12-01&nbsp;17:59:39</td><td>hroncok</td><td>set</td><td>keywords:
  + <a rel="nofollow" href="keyword2">patch</a><br />stage: needs patch -> patch review<br />pull_requests:
  + <a rel="nofollow" href="pull_request4574">pull_request4574</a></td></tr>
<tr><td>2017-11-29&nbsp;17:11:48</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307246">msg307246</a><br />stage: resolved -> needs patch</td></tr>
<tr><td>2017-11-29&nbsp;17:09:27</td><td>vstinner</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307245">msg307245</a></td></tr>
<tr><td>2017-11-29&nbsp;17:03:20</td><td>serhiy.storchaka</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307243">msg307243</a></td></tr>
<tr><td>2017-11-29&nbsp;16:21:22</td><td>vstinner</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307240">msg307240</a></td></tr>
<tr><td>2017-11-29&nbsp;16:19:18</td><td>vstinner</td><td>set</td><td>title: CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape -> [security] CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape</td></tr>
<tr><td>2017-11-29&nbsp;16:05:39</td><td>vstinner</td><td>set</td><td>status: closed -> open<br /><br /><br />title: Unsafe arithmetic in PyString_DecodeEscape -> CVE-2017-1000158: Unsafe arithmetic in PyString_DecodeEscape<br />nosy:
  + <a rel="nofollow" href="user2377">vstinner</a><br />versions:
  + Python 2.7, Python 3.5<br />messages:
  + <a rel="nofollow" href="msg307238">msg307238</a><br />resolution: fixed -> (no value)</td></tr>
<tr><td>2017-11-28&nbsp;15:59:51</td><td>leosilva</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg307138">msg307138</a></td></tr>
<tr><td>2017-11-24&nbsp;11:21:24</td><td>leosilva</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg306890">msg306890</a><br />versions:
  + Python 3.4, - Python 2.7</td></tr>
<tr><td>2017-11-24&nbsp;01:34:56</td><td>larry</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg306875">msg306875</a></td></tr>
<tr><td>2017-11-23&nbsp;16:06:04</td><td>serhiy.storchaka</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user2731">larry</a><br />messages:
  + <a rel="nofollow" href="msg306826">msg306826</a><br /></td></tr>
<tr><td>2017-11-23&nbsp;15:11:00</td><td>leosilva</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user27436">leosilva</a><br />messages:
  + <a rel="nofollow" href="msg306823">msg306823</a><br /></td></tr>
<tr><td>2017-06-18&nbsp;16:44:15</td><td>serhiy.storchaka</td><td>set</td><td>status: open -> closed<br />resolution: fixed<br />stage: patch review -> resolved</td></tr>
<tr><td>2017-06-18&nbsp;16:41:06</td><td>serhiy.storchaka</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg296277">msg296277</a></td></tr>
<tr><td>2017-06-16&nbsp;09:23:22</td><td>serhiy.storchaka</td><td>set</td><td>assignee: <a rel="nofollow" href="user15623">serhiy.storchaka</a><br />stage: needs patch -> patch review</td></tr>
<tr><td>2017-06-13&nbsp;20:19:19</td><td>jaybosamiya</td><td>set</td><td>messages:
  + <a rel="nofollow" href="msg295957">msg295957</a></td></tr>
<tr><td>2017-06-13&nbsp;20:14:54</td><td>jaybosamiya</td><td>set</td><td>pull_requests:
  + <a rel="nofollow" href="pull_request2226">pull_request2226</a></td></tr>
<tr><td>2017-06-13&nbsp;18:05:21</td><td>serhiy.storchaka</td><td>set</td><td>keywords:
  + <a rel="nofollow" href="keyword18">easy (C)</a><br /><br />messages:
  + <a rel="nofollow" href="msg295947">msg295947</a><br />stage: needs patch</td></tr>
<tr><td>2017-06-13&nbsp;16:01:16</td><td>vstinner</td><td>set</td><td>nosy:
  + <a rel="nofollow" href="user15623">serhiy.storchaka</a><br /></td></tr>
<tr><td>2017-06-13&nbsp;15:35:29</td><td>jaybosamiya</td><td>create</td><td></td></tr>
</table>

</div>


</div> <!-- content-body -->
<div id="footer">
<div id="credits">
  Hosted on <a href="https://m.do.co/c/783434964889" title="Hosted on DigitalOcean">DigitalOcean</a>,
  <br>
  Supported by <a href="https://python.org/psf-landing/" title="The Python Software Foundation">The Python Software Foundation</a>,
  <br>
  Powered by <a href="http://roundup.sourceforge.net" title="Powered by the Roundup Issue Tracker">Roundup</a>
</div> <!-- credits -->
Copyright &copy; 1990-2020, <a href="http://python.org/psf">Python Software Foundation</a><br />
<a href="http://python.org/about/legal">Legal Statements</a>
</div> <!-- footer -->
</div> <!-- body-main -->
</div> <!-- content -->



</body>
</html>

