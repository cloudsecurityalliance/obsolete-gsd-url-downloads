<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Apache2 related Bug #69218 - RDF' href='rss/bug.php?id=69218'>
        <link rel='alternate' type='application/rss+xml' title='Apache2 related Bug #69218 - RSS 2.0' href='rss/bug.php?id=69218&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #69218 :: potential remote code execution with apache 2.4 apache2handler</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=69218">Sec Bug</a>&nbsp;#69218</th>
            <td id="summary" colspan="5">potential remote code execution with apache 2.4 apache2handler</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-03-11 09:17 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-04-17 20:54 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>php &#x61;&#116; bof &#x64;&#111;&#x74; de</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Apache2+related">Apache2 related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.7RC1</td>
            <th class="details">OS:</th>
            <td>linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-3330" target="_blank">2015-3330</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=69218&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=69218&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=69218&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1426065443">&nbsp;</a><strong>[2015-03-11 09:17 UTC] php &#x61;&#116; bof &#x64;&#111;&#x74; de</strong>
<pre class='note'>Description:
------------
Dear PHP security folks,

I'm investigating <a href="https://bugs.php.net/bug.php?id=68486" rel="nofollow">https://bugs.php.net/bug.php?id=68486</a> at the moment, and now think that it has the potential of resulting in remote code execution (at the machine code level, not PHP code level).

The issue is with Apache 2.4, the PHP apache2handler SAPI, and pipelined HTTP requests. Given a simple (just a single echo) PHP script <a href="http://example.com/foo" rel="nofollow">http://example.com/foo</a> the following results in segfaults, but not always:

echo -e &quot;GET /foo HTTP/1.1\nHost: example.com\n\nGET /foo HTTP/1.1\nHost: example.com\n\n&quot; | netcat localhost 80

This is because after the first request, the interpreter is deinitialized (sapi_apache2.c line 679 calls php_apache_request_dtor), BUT contrary to the situation under Apache 2.2, Apache 2.4 does NOT call the pool cleanup function (php_server_context_cleanup) before the second request is processed - resulting in SG(server_context) still being non-NULL, which then makes the second request being handled as a subrequest (parent_req != NULL), skipping the call to php_apache_request_ctor - thus running the request in a deconfigured interpreter.

Sometimes this leads to SEGV, sometimes it does not, which makes me fear this has the potential for RCE. I'm not a security researcher, just a lowly sysadmin, so I will not investigate exploitation potential further - but maybe you could?


</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=69218'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=69218'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1426521794">&nbsp;</a><strong>[2015-03-16 16:03 UTC] php &#x61;&#116; bof &#x64;&#111;&#x74; de</strong>
<pre class='note'>Hello? Anybody? I the original bug report, and on internals, we now have several positive reproducers for this issue. I worked on a fix, also see the original report.

From everything I understand so far:

EVERY apache2handler based Apache 2.4 ON THIS PLANET CAN BE MADE TO DUMP CORE or worse, AT WILL, WITH AN EASY DOUBLE-HTTP/1.1 REQUEST.

I will continue to work on my patch in the original report, without stressing the security implications too much; tomorrow I'll see that I can run my patched 5.6.7RC1 with our full production load, and will give feedback then.

Apart from that, I cannot invest much more time on this, especially without further guidance regarding several use case issues I don't understand with the current handler code.

Please also refer to these two internals list threads regarding discussion, reproductions, and open questions and issues:

        SAPI apache2handler + pipelined HTTP request core dumps
and, started today on a related topic
        PHP apache2handler virtual() function

Please tell, how would you like to proceed with this issue?
</pre>
</div><div class='comment type_comment' ><a name="1426625542">&nbsp;</a><strong>[2015-03-17 20:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Looks like the core issue is 68486, so I propose to keep the discussion there. It sounds like 2.4 subtly broke its own API without letting people know, but I guess we have to deal with it anyway. Unfortunately, I don't know apache2 internals enough to quickly evaluate this patch, so it probably will have to wait for the next release round, but I'll send a ping to people that may know more on it, and try to look into it a bit later.
</pre>
</div><div class='comment type_comment' ><a name="1426674915">&nbsp;</a><strong>[2015-03-18 10:35 UTC] php &#x61;&#116; bof &#x64;&#111;&#x74; de</strong>
<pre class='note'>Hi stas,

Apache 2.4 &quot;broke&quot; its API in the sense that the r-&gt;pool cleanup now happens asynchronously with request processing - sending of reply data to the client runs in parallel with processing the next request (of a HTTP/1.1 pipelined connection, at least), with the first request's r-&gt;pool cleanup only being called once all pending data has been sent to the client.

In <a href="https://bugs.php.net/bug.php?id=68486" rel="nofollow">https://bugs.php.net/bug.php?id=68486</a> gmoniker proposed a one-line fix to this, which appears to work in first testing. I'm giving it a workout on one of my production servers now, no coredumps during the first 10 minutes. I'll let that run for another 4 hours, and when it stays stable I'll add the one-line fix as a patch comment to the original ticket.
</pre>
</div><div class='comment type_comment' ><a name="1426753907">&nbsp;</a><strong>[2015-03-19 08:31 UTC] php &#x61;&#116; bof &#x64;&#111;&#x74; de</strong>
<pre class='note'>One-line patch for the issue is now attached to the original bug report. Production test with both apache 2.2 and 2.4 (prefork) has been running without any issues, since yesterday afternoon.

Stas, can you please take over getting this released? Maybe it would be good to make a CVE / some kind of advisory, once the fix is release, so people who have this deployed on apache 2.4 know they should upgrade?
</pre>
</div><div class='comment type_comment' ><a name="1426786082">&nbsp;</a><strong>[2015-03-19 17:28 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Does this patch work fine with virtual(), etc., esp. when virtual also calls PHP? Previous one had compatibility issues with that as I understand.
</pre>
</div><div class='comment type_comment' ><a name="1426791543">&nbsp;</a><strong>[2015-03-19 18:59 UTC] php &#x61;&#116; bof &#x64;&#111;&#x74; de</strong>
<pre class='note'>The one-liner patch fixes the remotely triggerable apache 2.4 http/1.1 pipelined connection segmentation fault.

virtual() is broken regardless of apache version, leading to a segmentation violation when reentering PHP. I verified this with apache 2.4 and 2.2 with PHP 5.6.7RC1, and just tested too with an old PHP 5.5.18 build under apache 2.2 - always segfaults.

That virtual() issue is clearly separate. I will keep investigating that a bit, and to that end open a new bug ticket - but as it seems to be a very old issue, and is not triggerable arbitrarily-remotely, I don't think it should be mixed with the fixing of <a href='bug.php?id=68486'>bug 68486</a>
</pre>
</div><div class='comment type_svn' ><a name="1428996554">&nbsp;</a><strong>[2015-04-14 07:29 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=809610f5ea38a83b284e1125d1fff129bdd615e7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=809610f5ea38a83b284e1125d1fff129bdd615e7</a>
Log: Fix <a href='bug.php?id=68486'>bug #68486</a> and <a href='bug.php?id=69218'>bug #69218</a> (segfault in apache2handler with apache 2.4)
</pre>
</div><div class='comment type_svn' ><a name="1429000301">&nbsp;</a><strong>[2015-04-14 08:31 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=809610f5ea38a83b284e1125d1fff129bdd615e7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=809610f5ea38a83b284e1125d1fff129bdd615e7</a>
Log: Fix <a href='bug.php?id=68486'>bug #68486</a> and <a href='bug.php?id=69218'>bug #69218</a> (segfault in apache2handler with apache 2.4)
</pre>
</div><div class='comment type_svn' ><a name="1429000309">&nbsp;</a><strong>[2015-04-14 08:31 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=af1cd45d171fbb06712f846cec7bf69438db8ec2" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=af1cd45d171fbb06712f846cec7bf69438db8ec2</a>
Log: Fix <a href='bug.php?id=68486'>bug #68486</a> and <a href='bug.php?id=69218'>bug #69218</a> (segfault in apache2handler with apache 2.4)
</pre>
</div><div class='comment type_svn' ><a name="1429087439">&nbsp;</a><strong>[2015-04-15 08:43 UTC] <a href="//people.php.net/jpauli">jpauli@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=01883bcffb682f34309f9fbf112eecb050559522" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=01883bcffb682f34309f9fbf112eecb050559522</a>
Log: Fix <a href='bug.php?id=68486'>bug #68486</a> and <a href='bug.php?id=69218'>bug #69218</a> (segfault in apache2handler with apache 2.4)
</pre>
</div><div class='comment type_log' ><a name="1429216458">&nbsp;</a><strong>[2015-04-16 20:34 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1429216458">&nbsp;</a><strong>[2015-04-16 20:34 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1429304058">&nbsp;</a><strong>[2015-04-17 20:54 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-3330</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
