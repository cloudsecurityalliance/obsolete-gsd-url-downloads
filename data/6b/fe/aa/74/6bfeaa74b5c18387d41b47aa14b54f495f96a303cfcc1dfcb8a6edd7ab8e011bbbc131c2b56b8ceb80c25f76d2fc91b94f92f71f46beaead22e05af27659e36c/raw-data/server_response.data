<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #79797 - RDF' href='rss/bug.php?id=79797'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #79797 - RSS 2.0' href='rss/bug.php?id=79797&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #79797 :: Use of freed hash key in the phar_parse_zipfile function</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=79797">Sec Bug</a>&nbsp;#79797</th>
            <td id="summary" colspan="5">Use of freed hash key in the phar_parse_zipfile function</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2020-07-06 03:38 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2020-08-03 08:08 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>grigoritchy &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.2.32</td>
            <th class="details">OS:</th>
            <td>Linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7068" target="_blank">2020-7068</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=79797&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=79797&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=79797&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1594006708">&nbsp;</a><strong>[2020-07-06 03:38 UTC] grigoritchy &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
he phar_parse_zipfile function had use-after-free vulnerability because of mishandling of the actual_alias variable.

----- ext/phar/zip.c -----
int phar_parse_zipfile(php_stream *fp, char *fname, size_t fname_len, char *alias, size_t alias_len, phar_archive_data** pphar, char **error) /* {{{ */
{
	...

	mydata-&gt;alias = entry.is_persistent ? pestrndup(actual_alias, mydata-&gt;alias_len, 1) : actual_alias;

	if (entry.is_persistent) {
		efree(actual_alias);
	}

	zend_hash_str_add_ptr(&amp;(PHAR_G(phar_alias_map)), actual_alias, mydata-&gt;alias_len, mydata);

	...
---------------------------

`actual_alias` variable is allocated by estrndup function, which string is part of data of the zip file.

The above code snippet `mydata-&gt;alias` is assigned by `pestrndup(actual_alias, mydata-&gt;alias_len, 1)` if entry.is_persistent is true. Or `mydata-&gt;alias` is assigned by `actual_alias` variable.
And if `entry.is_persistent` is true, `actual_alias` variable is freed by invoke efree function. `actual_alias` variable is used invoke of zend_hash_str_add_ptr function as 2nd argument.

Problem is that `actual_alias` variable is freed if `entry.is_persistent` is true, the key of `phar_alias_map` will use freed memory. `entry.is_persistent` is true if `phar.cache_list` fields is defined in php.ini file. 

So if `phar.cache_list` is defined with target phar path so that `entry.is_persistent` is true, then it can be that `phar_alias_map` hash key would use sensitive freed memory data such as heap addresses that addresses set via linked list after invoke the efree function. You can see details debugging information at Actual result.


Test script:
---------------
download poc.phar file at <a href="http://149.248.44.196/08b54c110a83ff5f9499da1882dbeeb2/poc.phar" rel="nofollow">http://149.248.44.196/08b54c110a83ff5f9499da1882dbeeb2/poc.phar</a>

----- php.ini -----
+ phar.cache_list =/path/poc.phar
-------------------

After setting php.ini file, execute php cli.

Expected result:
----------------
&quot;AAAAA&quot; is `actual_alias` data.
zend_hash_str_add function use &quot;AAAAA&quot; string as hash key.


Actual result:
--------------
&quot;AAAAA&quot; is `actual_alias` data.
After invoke of efree function, `actual_alias` data is &quot;0x00007ffff3a02008&quot;. Then zend_hash_str_add function use &quot;0x00007ffff3a02008&quot; string as hash key.


# gdb `which php`
(gdb) b *phar_parse_zipfile+11046
(gdb) r
Starting program: /usr/local/bin/php
...
(gdb) x/i $pc
=&gt; 0x5555557817a6 &lt;phar_parse_zipfile+11046&gt;:	callq  0x5555558cd0a0 &lt;_efree&gt;
(gdb) x/32gx $rdi
0x7ffff3a02000:	0x0000004141414141	0x00007ffff3a02010
0x7ffff3a02010:	0x00007ffff3a02018	0x00007ffff3a02020
0x7ffff3a02020:	0x00007ffff3a02028	0x00007ffff3a02030
0x7ffff3a02030:	0x00007ffff3a02038	0x00007ffff3a02040
0x7ffff3a02040:	0x00007ffff3a02048	0x00007ffff3a02050
0x7ffff3a02050:	0x00007ffff3a02058	0x00007ffff3a02060
0x7ffff3a02060:	0x00007ffff3a02068	0x00007ffff3a02070
0x7ffff3a02070:	0x00007ffff3a02078	0x00007ffff3a02080
0x7ffff3a02080:	0x00007ffff3a02088	0x00007ffff3a02090
0x7ffff3a02090:	0x00007ffff3a02098	0x00007ffff3a020a0
0x7ffff3a020a0:	0x00007ffff3a020a8	0x00007ffff3a020b0
0x7ffff3a020b0:	0x00007ffff3a020b8	0x00007ffff3a020c0
0x7ffff3a020c0:	0x00007ffff3a020c8	0x00007ffff3a020d0
0x7ffff3a020d0:	0x00007ffff3a020d8	0x00007ffff3a020e0
0x7ffff3a020e0:	0x00007ffff3a020e8	0x00007ffff3a020f0
0x7ffff3a020f0:	0x00007ffff3a020f8	0x00007ffff3a02100
(gdb) ni
...
(gdb) x/i $pc
=&gt; 0x55555578176e &lt;phar_parse_zipfile+10990&gt;:	callq  0x555555900f10 &lt;zend_hash_str_add&gt;
(gdb) x/32gx $rsi
0x7ffff3a02000:	0x00007ffff3a02008	0x00007ffff3a02010
0x7ffff3a02010:	0x00007ffff3a02018	0x00007ffff3a02020
0x7ffff3a02020:	0x00007ffff3a02028	0x00007ffff3a02030
0x7ffff3a02030:	0x00007ffff3a02038	0x00007ffff3a02040
0x7ffff3a02040:	0x00007ffff3a02048	0x00007ffff3a02050
0x7ffff3a02050:	0x00007ffff3a02058	0x00007ffff3a02060
0x7ffff3a02060:	0x00007ffff3a02068	0x00007ffff3a02070
0x7ffff3a02070:	0x00007ffff3a02078	0x00007ffff3a02080
0x7ffff3a02080:	0x00007ffff3a02088	0x00007ffff3a02090
0x7ffff3a02090:	0x00007ffff3a02098	0x00007ffff3a020a0
0x7ffff3a020a0:	0x00007ffff3a020a8	0x00007ffff3a020b0
0x7ffff3a020b0:	0x00007ffff3a020b8	0x00007ffff3a020c0
0x7ffff3a020c0:	0x00007ffff3a020c8	0x00007ffff3a020d0
0x7ffff3a020d0:	0x00007ffff3a020d8	0x00007ffff3a020e0
0x7ffff3a020e0:	0x00007ffff3a020e8	0x00007ffff3a020f0
0x7ffff3a020f0:	0x00007ffff3a020f8	0x00007ffff3a02100

(gdb) bt
#0  0x000055555578176e in zend_hash_str_add_ptr (pData=0x55555647da30, len=5, str=0x7ffff3a02000 &quot;\b \240\363\377\177&quot;, ht=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/Zend/zend_hash.h:619
#1  phar_parse_zipfile (fp=fp@entry=0x7ffff3a07000, fname=fname@entry=0x7ffff3a0b018 &quot;/home/ubuntu/poc.phar&quot;, fname_len=fname_len@entry=21, alias=alias@entry=0x0, alias_len=alias_len@entry=0, pphar=pphar@entry=0x7fffffffcde8,
    error=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/ext/phar/zip.c:715
#2  0x000055555578c72d in phar_open_from_fp (fp=0x7ffff3a07000, fname=fname@entry=0x7ffff3a0b018 &quot;/home/ubuntu/poc.phar&quot;, fname_len=fname_len@entry=21, alias=alias@entry=0x0, alias_len=alias_len@entry=0,
    pphar=pphar@entry=0x7fffffffcde8, is_data=0, error=0x0, options=0) at /home/ubuntu/php-7.4.7/ext/phar/phar.c:1720
#3  0x000055555578efd7 in phar_open_from_filename (fname=0x7ffff3a0b018 &quot;/home/ubuntu/poc.phar&quot;, fname@entry=0x7ffff3a03018 &quot;/home/ubuntu/poc.phar&quot;, fname_len=21, alias=alias@entry=0x0, alias_len=alias_len@entry=0,
    options=options@entry=0, pphar=pphar@entry=0x7fffffffcde8, error=0x0) at /home/ubuntu/php-7.4.7/ext/phar/phar.c:1537
#4  0x000055555578f25e in phar_split_cache_list () at /home/ubuntu/php-7.4.7/ext/phar/phar.c:141
#5  phar_ini_cache_list (entry=&lt;optimized out&gt;, new_value=&lt;optimized out&gt;, mh_arg1=&lt;optimized out&gt;, mh_arg2=&lt;optimized out&gt;, mh_arg3=&lt;optimized out&gt;, stage=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/ext/phar/phar.c:183
#6  0x000055555590d423 in zend_register_ini_entries (ini_entry=0x55555634b640 &lt;ini_entries+128&gt;, ini_entry@entry=0x55555634b5c0 &lt;ini_entries&gt;, module_number=18) at /home/ubuntu/php-7.4.7/Zend/zend_ini.c:252
#7  0x000055555578b6e0 in zm_startup_phar (type=&lt;optimized out&gt;, module_number=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/ext/phar/phar.c:3399
#8  0x00005555558f64a3 in zend_startup_module_ex (module=0x5555563bfdd0) at /home/ubuntu/php-7.4.7/Zend/zend_API.c:1860
#9  0x00005555558f654c in zend_startup_module_zval (zv=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/Zend/zend_API.c:1875
#10 0x0000555555903f32 in zend_hash_apply (ht=ht@entry=0x555556373900 &lt;module_registry&gt;, apply_func=apply_func@entry=0x5555558f6540 &lt;zend_startup_module_zval&gt;) at /home/ubuntu/php-7.4.7/Zend/zend_hash.c:1812
#11 0x00005555558f683a in zend_startup_modules () at /home/ubuntu/php-7.4.7/Zend/zend_API.c:1986
#12 0x00005555558913d3 in php_module_startup (sf=&lt;optimized out&gt;, additional_modules=&lt;optimized out&gt;, num_additional_modules=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/main/main.c:2332
#13 0x000055555597f2ed in php_cli_startup (sapi_module=&lt;optimized out&gt;) at /home/ubuntu/php-7.4.7/sapi/cli/php_cli.c:407
#14 0x00005555556623c7 in main (argc=1, argv=0x5555563899d0) at /home/ubuntu/php-7.4.7/sapi/cli/php_cli.c:1323

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=79797'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=79797'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1594739248">&nbsp;</a><strong>[2020-07-14 15:07 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1594739248">&nbsp;</a><strong>[2020-07-14 15:07 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Suggested fix including regression test:
&lt;<a href="https://gist.github.com/cmb69/dec5400fbdf619195015a696c3ed136d" rel="nofollow">https://gist.github.com/cmb69/dec5400fbdf619195015a696c3ed136d</a>&gt;

Stas, could you please handle this?
</pre>
</div><div class='comment type_log' ><a name="1596437083">&nbsp;</a><strong>[2020-08-03 06:44 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2020-7068</span>
</div></div></div><div class='comment type_log' ><a name="1596437137">&nbsp;</a><strong>[2020-08-03 06:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.4.7</span>
<span class="added">+PHP Version: 7.2.32</span>
</div></div></div><div class='comment type_svn' ><a name="1596442144">&nbsp;</a><strong>[2020-08-03 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_log' ><a name="1596442144">&nbsp;</a><strong>[2020-08-03 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1596442168">&nbsp;</a><strong>[2020-08-03 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_svn' ><a name="1596442197">&nbsp;</a><strong>[2020-08-03 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=9c3171f019d07b4271c5929478dddba0861e92af" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=9c3171f019d07b4271c5929478dddba0861e92af</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_svn' ><a name="1596442234">&nbsp;</a><strong>[2020-08-03 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=775385df0e954f8cf9b5046bebc8e40ce26e601b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=775385df0e954f8cf9b5046bebc8e40ce26e601b</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_svn' ><a name="1596445524">&nbsp;</a><strong>[2020-08-03 09:05 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f57a99937967ed010c6c57b339b703a3fff5eaa6" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f57a99937967ed010c6c57b339b703a3fff5eaa6</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_svn' ><a name="1596446196">&nbsp;</a><strong>[2020-08-03 09:16 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=7355ab81763a3d6a04ac11660e6a16d58838d187</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div><div class='comment type_svn' ><a name="1596446197">&nbsp;</a><strong>[2020-08-03 09:16 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=9c3171f019d07b4271c5929478dddba0861e92af" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=9c3171f019d07b4271c5929478dddba0861e92af</a>
Log: Fix #79797: Use of freed hash key in the phar_parse_zipfile function
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
