<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
<link rel="icon" href="/favicon.png">
<title>#981404 - compressed file is world readable, while zstd is running - Debian Bug report logs</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/bugs.css" type="text/css">

<link rel="canonical" href="&lt;a href=&quot;bugreport.cgi?bug=981404&quot;&gt;981404&lt;/a&gt;">
<script type="text/javascript">
<!--
function toggle_infmessages()
{
        allDivs=document.getElementsByTagName("div");
        for (var i = 0 ; i < allDivs.length ; i++ )
        {
                if (allDivs[i].className == "infmessage")
                {
                        allDivs[i].style.display=(allDivs[i].style.display == 'none' | allDivs[i].style.display == '') ? 'block' : 'none';
                }
        }
}
-->
</script>
</head>
<body>
<h1>Debian Bug report logs - 
<a href="mailto:981404@bugs.debian.org">#981404</a><br>
compressed file is world readable, while zstd is running</h1>
<div class="versiongraph"><a href="version.cgi?info=1;absolute=0;found=libzstd%2F1.3.8%2Bdfsg-3;found=libzstd%2F1.1.2-1;package=zstd;fixed=libzstd%2F1.4.8%2Bdfsg-1;fixed=libzstd%2F1.3.8%2Bdfsg-3%2Bdeb10u1;collapse=1"><img alt="version graph" src="version.cgi?found=libzstd%2F1.3.8%2Bdfsg-3;found=libzstd%2F1.1.2-1;package=zstd;width=2;height=2;absolute=0;collapse=1;fixed=libzstd%2F1.4.8%2Bdfsg-1;fixed=libzstd%2F1.3.8%2Bdfsg-3%2Bdeb10u1"></a></div>
<div class="pkginfo">
  <p>Package:
     <a class="submitter" href="pkgreport.cgi?package=zstd">zstd</a>;
Maintainer for <a href="pkgreport.cgi?package=zstd">zstd</a> is <a href="pkgreport.cgi?maint=debian-med-packaging%40lists.alioth.debian.org">Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</a>; Source for <a href="pkgreport.cgi?package=zstd">zstd</a> is <a href="pkgreport.cgi?src=libzstd">src:libzstd</a> (<a href="https://tracker.debian.org/pkg/libzstd">PTS</a>, <a href="https://buildd.debian.org/libzstd">buildd</a>, <a href="https://qa.debian.org/popcon.php?package=libzstd">popcon</a>). </p>

</div>

<div class="buginfo">
  <p>Reported by: <a href="pkgreport.cgi?submitter=harri%40afaics.de">Harald Dunkel &lt;harri@afaics.de&gt;</a></p>
  <p>Date: Sat, 30 Jan 2021 16:45:02 UTC</p>

<p>Severity: <em class="severity">critical</em></p>
<p>Tags: fixed-upstream, patch, upstream</p>

<p>Found in versions libzstd/1.3.8+dfsg-3, libzstd/1.1.2-1</p>
<p>Fixed in versions libzstd/1.4.8+dfsg-1, libzstd/1.3.8+dfsg-3+deb10u1</p>

<p><strong>Done:</strong> Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</p>

<p>Bug is archived. No further changes may be made.<p><p>Forwarded to <a href="https://github.com/facebook/zstd/issues/1630">https://github.com/facebook/zstd/issues/1630</a></p>
</div>

<p><a href="javascript:toggle_infmessages();">Toggle useless messages</a></p><div class="msgreceived"><p>View this report as an <a href="bugreport.cgi?bug=981404;mbox=yes">mbox folder</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;mboxstatus=yes">status mbox</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;mboxmaint=yes">maintainer mbox</a></p></div>

<div class="infmessage"><hr><p>
<a name="1"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt; -->
<!-- time:1612025104 -->
<strong>Report forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>:<br>
<code>Bug#981404</code>; Package <code>zstd</code>.
 (Sat, 30 Jan 2021 16:45:04 GMT) (<a href="bugreport.cgi?bug=981404;msg=2">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=2">mbox</a>, <a href="#1">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="3"></a>
<!-- request_addr: Harald Dunkel &lt;harri@afaics.de&gt; -->
<!-- time:1612025104 -->
<strong>Acknowledgement sent</strong>
to <code>Harald Dunkel &lt;harri@afaics.de&gt;</code>:<br>
New Bug report received and forwarded.  Copy sent to <code>Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>.
 (Sat, 30 Jan 2021 16:45:04 GMT) (<a href="bugreport.cgi?bug=981404;msg=4">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=4">mbox</a>, <a href="#3">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="5"></a><a name="msg5"></a><a href="#5">Message #5</a> received at submit@bugs.debian.org (<a href="bugreport.cgi?bug=981404;msg=5">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=5">mbox</a>, <a href="mailto:981404@bugs.debian.org?In-Reply-To=%3Cb90aa02e-803c-a261-6b29-c3496a2a4f88%40afaics.de%3E&amp;subject=Re%3A%20compressed%20file%20is%20world%20readable%2C%20while%20zstd%20is%20running&amp;body=On%20Sat%2C%2030%20Jan%202021%2017%3A34%3A45%20%2B0100%20Harald%20Dunkel%20%3Charri%40afaics.de%3E%20wrote%3A%0A%3E%20Package%3A%20zstd%0A%3E%20Version%3A%201.3.8%2Bdfsg-3%0A%3E%20Severity%3A%20critical%0A%3E%20%0A%3E%20Compressing%20a%20large%20file%20with%20restricted%20access%20permissions%20a%20new%2C%0A%3E%20world%20readable%20file%20is%20created%2C%20revealing%20the%20contents%20of%20the%0A%3E%20uncompressed%20file.%20Sample%3A%0A%3E%20%0A%3E%20%23%20whoami%0A%3E%20root%0A%3E%20%23%20zstd%20-q%20-13%20-T8%20sample.dmp%20%26%3E%20zstd.log%20%26%0A%3E%20%3A%0A%3E%20%3A%0A%3E%20%23%20ls%20-al%0A%3E%20total%20385983012%0A%3E%20drwxr-xr-x%20%202%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2016%3A01%20.%0A%3E%20drwxr-xr-x%2035%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2015%3A39%20..%0A%3E%20-rw-------%20%201%20oracle%20%20users%20279265214464%20Jan%2029%2022%3A02%20sample.dmp%0A%3E%20-rw-r--r--%20%201%20root%20%20%20%20root%20%20115981336576%20Jan%2030%2016%3A25%20sample.dmp.zst%0A%3E%20-rw-r--r--%20%201%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%20%20%20%200%20Jan%2030%2016%3A01%20zstd.log%0A%3E%20%3A%0A%3E%20%3A%0A%3E%20%5B1%5D%2B%20%20Done%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20zstd%20-q%20-13%20-T8%20sample.dmp%20%26%3E%20zstd.log%0A%3E%20%23%20md5sum%20sample.dmp.zst%0A%3E%205a3d3401e8e46483659e820f96ad0ef0%20%20sample.dmp.zst%0A%3E%20%0A%3E%20%0A%3E%20%0A%3E%20An%20attacker%20might%20be%20able%20to%20open%282%29%20the%20file%20while%20zstd%20is%20still%0A%3E%20running%2C%20wait%20for%20zstd%20to%20complete%20its%20job%2C%20and%20then%20read%282%29%20the%0A%3E%20whole%20file%3A%0A%3E%20%0A%3E%20%25%20whoami%0A%3E%20attacker%0A%3E%20%25%20ls%20-al%0A%3E%20total%20465071584%0A%3E%20drwxr-xr-x%20%202%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2016%3A01%20.%0A%3E%20drwxr-xr-x%2035%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2015%3A39%20..%0A%3E%20-rw-------%20%201%20oracle%20%20users%20279265214464%20Jan%2029%2022%3A02%20sample.dmp%0A%3E%20-rw-r--r--%20%201%20root%20%20%20%20root%20%20196968022016%20Jan%2030%2016%3A41%20sample.dmp.zst%0A%3E%20-rw-r--r--%20%201%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%20%20%20%200%20Jan%2030%2016%3A01%20zstd.log%0A%3E%20%25%20md5sum%20sample.dmp.zst%0A%3E%20%5EZ%0A%3E%20%5B1%5D%2B%20%20Stopped%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20md5sum%20sample.dmp.zst%0A%3E%20%3A%0A%3E%20%3A%0A%3E%20%25%20ls%20-al%0A%3E%20total%20475580484%0A%3E%20drwxr-xr-x%20%202%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2016%3A01%20.%0A%3E%20drwxr-xr-x%2035%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%204096%20Jan%2030%2015%3A39%20..%0A%3E%20-rw-------%20%201%20oracle%20%20users%20279265214464%20Jan%2029%2022%3A02%20sample.dmp%0A%3E%20-rw-------%20%201%20oracle%20%20users%20207729131801%20Jan%2029%2022%3A02%20sample.dmp.zst%0A%3E%20-rw-r--r--%20%201%20root%20%20%20%20root%20%20%20%20%20%20%20%20%20%20%20%20%200%20Jan%2030%2016%3A01%20zstd.log%0A%3E%20%0A%3E%20%25%20fg%0A%3E%20md5sum%20sample.dmp.zst%0A%3E%205a3d3401e8e46483659e820f96ad0ef0%20%20sample.dmp.zst%0A%3E%20%25%0A%3E%20%0A%3E%20In%20this%20sample%20session%20the%20attacker%20got%20the%20correct%20md5sum%2C%20just%20for%0A&amp;References=%3Cb90aa02e-803c-a261-6b29-c3496a2a4f88%40afaics.de%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=harri%40afaics.de" alt="">
<div class="header"><span class="headerfield">From:</span> Harald Dunkel &lt;harri@afaics.de&gt;</div>
<div class="header"><span class="headerfield">To:</span> Debian Bug Tracking System &lt;submit@bugs.debian.org&gt;</div>
<div class="header"><span class="headerfield">Subject:</span> compressed file is world readable, while zstd is running</div>
<div class="header"><span class="headerfield">Date:</span> Sat, 30 Jan 2021 17:34:45 +0100</div>
</div>
<pre class="message flowed">Package: zstd
Version: 1.3.8+dfsg-3
Severity: critical

Compressing a large file with restricted access permissions a new,
world readable file is created, revealing the contents of the
uncompressed file. Sample:

# whoami
root
# zstd -q -13 -T8 sample.dmp &amp;&gt; zstd.log &amp;
:
:
# ls -al
total 385983012
drwxr-xr-x  2 root    root          4096 Jan 30 16:01 .
drwxr-xr-x 35 root    root          4096 Jan 30 15:39 ..
-rw-------  1 oracle  users 279265214464 Jan 29 22:02 sample.dmp
-rw-r--r--  1 root    root  115981336576 Jan 30 16:25 sample.dmp.zst
-rw-r--r--  1 root    root             0 Jan 30 16:01 zstd.log
:
:
[1]+  Done                    zstd -q -13 -T8 sample.dmp &amp;&gt; zstd.log
# md5sum sample.dmp.zst
5a3d3401e8e46483659e820f96ad0ef0  sample.dmp.zst



An attacker might be able to open(2) the file while zstd is still
running, wait for zstd to complete its job, and then read(2) the
whole file:

% whoami
attacker
% ls -al
total 465071584
drwxr-xr-x  2 root    root          4096 Jan 30 16:01 .
drwxr-xr-x 35 root    root          4096 Jan 30 15:39 ..
-rw-------  1 oracle  users 279265214464 Jan 29 22:02 sample.dmp
-rw-r--r--  1 root    root  196968022016 Jan 30 16:41 sample.dmp.zst
-rw-r--r--  1 root    root             0 Jan 30 16:01 zstd.log
% md5sum sample.dmp.zst
^Z
[1]+  Stopped                 md5sum sample.dmp.zst
:
:
% ls -al
total 475580484
drwxr-xr-x  2 root    root          4096 Jan 30 16:01 .
drwxr-xr-x 35 root    root          4096 Jan 30 15:39 ..
-rw-------  1 oracle  users 279265214464 Jan 29 22:02 sample.dmp
-rw-------  1 oracle  users 207729131801 Jan 29 22:02 sample.dmp.zst
-rw-r--r--  1 root    root             0 Jan 30 16:01 zstd.log

% fg
md5sum sample.dmp.zst
5a3d3401e8e46483659e820f96ad0ef0  sample.dmp.zst
%

In this sample session the attacker got the correct md5sum, just for
demonstation purposes. Hi could have created his own private copy in
the same way.

This makes zstd unusable for me.


Regards
Harri


</pre>

<div class="infmessage"><hr><p>
<a name="6"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt; -->
<!-- time:1612216692 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>:<br>
<code>Bug#981404</code>; Package <code>zstd</code>.
 (Mon, 01 Feb 2021 21:58:12 GMT) (<a href="bugreport.cgi?bug=981404;msg=7">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=7">mbox</a>, <a href="#6">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="8"></a>
<!-- request_addr: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; -->
<!-- time:1612216692 -->
<strong>Acknowledgement sent</strong>
to <code>Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</code>:<br>
Extra info received and forwarded to list.  Copy sent to <code>Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>.
 (Mon, 01 Feb 2021 21:58:12 GMT) (<a href="bugreport.cgi?bug=981404;msg=9">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=9">mbox</a>, <a href="#8">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="10"></a><a name="msg10"></a><a href="#10">Message #10</a> received at 981404@bugs.debian.org (<a href="bugreport.cgi?bug=981404;msg=10">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=10">mbox</a>, <a href="mailto:981404@bugs.debian.org?body=On%20Mon%2C%201%20Feb%202021%2022%3A57%3A15%20%2B0100%20%3D%3Futf-8%3FQ%3F%3DC3%3D89tienne%3F%3D%20Mollier%20%3Cetienne.mollier%40mailoo.org%3E%20wrote%3A%0A%3E%20Control%3A%20fixed%20-1%201.4.8%2Bdfsg-1%0A%3E%20Control%3A%20tag%20-1%20patch%0A%3E%20%0A%3E%20Greetings%2C%0A%3E%20%0A%3E%20This%20critical%20issue%20is%20affecting%20Stable.%20%20Permissions%20at%0A%3E%20compression%20time%20are%20inherited%20from%20umask%2C%20this%20may%20be%20too%0A%3E%20relaxed%20when%20handling%20sensitive%20files.%0A%3E%20%0A%3E%20Fortunately%2C%20this%20seems%20to%20have%20been%20fixed%20upstream%20around%0A%3E%20version%201.4.1.%20%20Debian%20Sid%20is%20not%20affected%20anymore%20as%20far%20as%20I%0A%3E%20can%20see.%20%20I%20identified%20the%20few%20commits%5B1%2C2%2C3%2C4%5D%20from%20Mike%0A%3E%20Swanson%20and%20Yann%20Collet%20which%20solved%20the%20issue.%0A%3E%20%0A%3E%20%5B1%5D%20https%3A%2F%2Fgithub.com%2Ffacebook%2Fzstd%2Fcommit%2F3968160a916a759c3d3418da533e1b4f8b795343%0A%3E%20%5B2%5D%20https%3A%2F%2Fgithub.com%2Ffacebook%2Fzstd%2Fcommit%2Faf80f6dfacafcc2c916ecd57731107221e1f9986%0A%3E%20%5B3%5D%20https%3A%2F%2Fgithub.com%2Ffacebook%2Fzstd%2Fcommit%2F8b6d96827c24dd09109830272f413254833317d9%0A%3E%20%5B4%5D%20https%3A%2F%2Fgithub.com%2Ffacebook%2Fzstd%2Fcommit%2F7aaac3f69c1e0102099c192639017e660e88b4bf%0A%3E%20%0A%3E%20After%20some%20folding%2C%20I%20obtained%20the%20following%20patch%2C%20with%20which%20I%0A%3E%20could%20derive%20a%20fixed%20version%20of%20zstd%201.3.8%20for%20Buster%3A%0A%3E%20%0A%3E%20-------8%3C--------------8%3C--------------8%3C--------------8%3C-------%0A%3E%20---%20libzstd.orig%2Fprograms%2Ffileio.c%0A%3E%20%2B%2B%2B%20libzstd%2Fprograms%2Ffileio.c%0A%3E%20%40%40%20-482%2C8%20%2B482%2C14%20%40%40%0A%3E%20%20%20%20%20%20%7D%20%20%20%7D%0A%3E%20%20%0A%3E%20%20%20%20%20%20%7B%20%20%20FILE%2A%20const%20f%20%3D%20fopen%28%20dstFileName%2C%20%22wb%22%20%29%3B%0A%3E%20-%20%20%20%20%20%20%20%20if%20%28f%20%3D%3D%20NULL%29%0A%3E%20%2B%20%20%20%20%20%20%20%20if%20%28f%20%3D%3D%20NULL%29%20%7B%0A%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20DISPLAYLEVEL%281%2C%20%22zstd%3A%20%25s%3A%20%25s%5Cn%22%2C%20dstFileName%2C%20strerror%28errno%29%29%3B%0A%3E%20%2B%20%20%20%20%20%20%20%20%7D%20else%20if%20%28srcFileName%20%21%3D%20NULL%0A%3E%20%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%26%20strcmp%20%28srcFileName%2C%20stdinmark%29%0A%3E%20%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%26%20strcmp%28dstFileName%2C%20nulmark%29%20%29%20%7B%0A%3E%20%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2A%20reduce%20rights%20on%20newly%20created%20dst%20file%20while%20compression%20is%20ongoing%20%2A%2F%0A%3E%20%2B%20%20%20%20%20%20%20%20%20%20%20%20chmod%28dstFileName%2C%2000600%29%3B%0A%3E%20%2B%20%20%20%20%20%20%20%20%7D%0A%3E%20%20%20%20%20%20%20%20%20%20return%20f%3B%0A%3E%20%20%20%20%20%20%7D%0A%3E%20%20%7D%0A%3E%20-------8%3C--------------8%3C--------------8%3C--------------8%3C-------%0A%3E%20%0A%3E%20Side%20note%20to%20Debian%20Med%2C%20I%20know%20the%20package%20is%20transitionning%20to%0A%3E%20pkg-rpm%20team%2C%20and%20I%20am%20not%20super%20comfortable%20yet%20preparing%20an%0A%3E%20upload%20to%20Stable%5B5%5D%2C%20so%20I%27m%20just%20providing%20a%20proposal%20of%20patch%0A%3E%20as%20a%20starter.%0A%3E%20%0A%3E%20%5B5%5D%20https%3A%2F%2Fwww.debian.org%2Fdoc%2Fmanuals%2Fdevelopers-reference%2Fpkgs.en.html%23special-case-uploads-to-the-stable-and-oldstable-distributions%0A%3E%20%0A%3E%20Kind%20Regards%2C%0A%3E%20--%20%0A%3E%20%C3%89tienne%20Mollier%20%3Cetienne.mollier%40mailoo.org%3E%0A%3E%20Fingerprint%3A%20%208f91%20b227%20c7d6%20f2b1%20948c%20%208236%20793c%20f67e%208f0d%2011da%0A%3E%20Sent%20from%20%2Fdev%2Fpts%2F2%2C%20please%20excuse%20my%20verbosity.%0A&amp;References=%3Cb90aa02e-803c-a261-6b29-c3496a2a4f88%40afaics.de%3E%0A%20%3CYBh5Ox65t24hunnH%40fusion%3E&amp;In-Reply-To=%3CYBh5Ox65t24hunnH%40fusion%3E&amp;subject=Re%3A%20%5BDebian-med-packaging%5D%20Bug%23981404%3A%20compressed%20file%20is%20world%0A%20readable%2C%20while%20zstd%20is%20running">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=etienne.mollier%40mailoo.org" alt="">
<div class="header"><span class="headerfield">From:</span> Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> 981404@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Re: [Debian-med-packaging] Bug#981404: compressed file is world
 readable, while zstd is running</div>
<div class="header"><span class="headerfield">Date:</span> Mon, 1 Feb 2021 22:57:15 +0100</div>
</div>
<pre class="mime">[<a href="bugreport.cgi?att=0;bug=981404;msg=10">Message part 1</a> (text/plain, inline)]</pre>
<pre class="message">Control: fixed -1 1.4.8+dfsg-1
Control: tag -1 patch

Greetings,

This critical issue is affecting Stable.  Permissions at
compression time are inherited from umask, this may be too
relaxed when handling sensitive files.

Fortunately, this seems to have been fixed upstream around
version 1.4.1.  Debian Sid is not affected anymore as far as I
can see.  I identified the few commits[1,2,3,4] from Mike
Swanson and Yann Collet which solved the issue.

[1] <a href="https://github.com/facebook/zstd/commit/3968160a916a759c3d3418da533e1b4f8b795343">https://github.com/facebook/zstd/commit/3968160a916a759c3d3418da533e1b4f8b795343</a>
[2] <a href="https://github.com/facebook/zstd/commit/af80f6dfacafcc2c916ecd57731107221e1f9986">https://github.com/facebook/zstd/commit/af80f6dfacafcc2c916ecd57731107221e1f9986</a>
[3] <a href="https://github.com/facebook/zstd/commit/8b6d96827c24dd09109830272f413254833317d9">https://github.com/facebook/zstd/commit/8b6d96827c24dd09109830272f413254833317d9</a>
[4] <a href="https://github.com/facebook/zstd/commit/7aaac3f69c1e0102099c192639017e660e88b4bf">https://github.com/facebook/zstd/commit/7aaac3f69c1e0102099c192639017e660e88b4bf</a>

After some folding, I obtained the following patch, with which I
could derive a fixed version of zstd 1.3.8 for Buster:

-------8&lt;--------------8&lt;--------------8&lt;--------------8&lt;-------
--- libzstd.orig/programs/fileio.c
+++ libzstd/programs/fileio.c
@@ -482,8 +482,14 @@
     }   }
 
     {   FILE* const f = fopen( dstFileName, &quot;wb&quot; );
-        if (f == NULL)
+        if (f == NULL) {
             DISPLAYLEVEL(1, &quot;zstd: %s: %s\n&quot;, dstFileName, strerror(errno));
+        } else if (srcFileName != NULL
+                   &amp;&amp; strcmp (srcFileName, stdinmark)
+                   &amp;&amp; strcmp(dstFileName, nulmark) ) {
+                /* reduce rights on newly created dst file while compression is ongoing */
+            chmod(dstFileName, 00600);
+        }
         return f;
     }
 }
-------8&lt;--------------8&lt;--------------8&lt;--------------8&lt;-------

Side note to Debian Med, I know the package is transitionning to
pkg-rpm team, and I am not super comfortable yet preparing an
upload to Stable[5], so I&#39;m just providing a proposal of patch
as a starter.

[5] <a href="https://www.debian.org/doc/manuals/developers-reference/pkgs.en.html#special-case-uploads-to-the-stable-and-oldstable-distributions">https://www.debian.org/doc/manuals/developers-reference/pkgs.en.html#special-case-uploads-to-the-stable-and-oldstable-distributions</a>

Kind Regards,
-- 
Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;
Fingerprint:  8f91 b227 c7d6 f2b1 948c  8236 793c f67e 8f0d 11da
Sent from /dev/pts/2, please excuse my verbosity.
</pre>
<pre class="mime">[<a href="bugreport.cgi?att=1;bug=981404;filename=signature.asc;msg=10">signature.asc</a> (application/pgp-signature, inline)]</pre>

<div class="msgreceived"><hr><p>
<a name="11"></a>
<!-- command:fixed -->
<!-- requester: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; -->
<!-- request_addr: 981404-submit@bugs.debian.org -->
<!-- time:1612216692 -->
<!-- new_data:
$new_data = {
              &#39;fixed_versions&#39; =&gt; [
                                    &#39;libzstd/1.4.8+dfsg-1&#39;
                                  ]
            };
-->
<!-- old_data:
$old_data = {
              &#39;fixed_versions&#39; =&gt; []
            };
-->
<strong>Marked as fixed in versions libzstd/1.4.8+dfsg-1.</strong>
Request was from <code>Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</code>
to <code>981404-submit@bugs.debian.org</code>.
 (Mon, 01 Feb 2021 21:58:12 GMT) (<a href="bugreport.cgi?bug=981404;msg=12">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=12">mbox</a>, <a href="#11">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="13"></a>
<!-- command:tag -->
<!-- requester: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; -->
<!-- request_addr: 981404-submit@bugs.debian.org -->
<!-- time:1612216692 -->
<!-- new_data:
$new_data = {
              &#39;keywords&#39; =&gt; &#39;patch&#39;
            };
-->
<!-- old_data:
$old_data = {
              &#39;keywords&#39; =&gt; &#39;&#39;
            };
-->
<strong>Added tag(s) patch.</strong>
Request was from <code>Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</code>
to <code>981404-submit@bugs.debian.org</code>.
 (Mon, 01 Feb 2021 21:58:12 GMT) (<a href="bugreport.cgi?bug=981404;msg=14">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=14">mbox</a>, <a href="#13">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="15"></a>
<!-- command:forwarded -->
<!-- requester: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- request_addr: control@bugs.debian.org -->
<!-- time:1612388342 -->
<!-- new_data:
$new_data = {
              &#39;forwarded&#39; =&gt; &#39;<a href="https://github.com/facebook/zstd/issues/1630">https://github.com/facebook/zstd/issues/1630</a>&#39;
            };
-->
<!-- old_data:
$old_data = {
              &#39;forwarded&#39; =&gt; &#39;&#39;
            };
-->
<strong>Set Bug forwarded-to-address to &#39;<a href="https://github.com/facebook/zstd/issues/1630">https://github.com/facebook/zstd/issues/1630</a>&#39;.</strong>
Request was from <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>
to <code>control@bugs.debian.org</code>.
 (Wed, 03 Feb 2021 21:39:02 GMT) (<a href="bugreport.cgi?bug=981404;msg=16">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=16">mbox</a>, <a href="#15">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="17"></a>
<!-- command:tag -->
<!-- requester: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- request_addr: control@bugs.debian.org -->
<!-- time:1612388343 -->
<!-- new_data:
$new_data = {
              &#39;keywords&#39; =&gt; &#39;upstream fixed-upstream patch&#39;
            };
-->
<!-- old_data:
$old_data = {
              &#39;keywords&#39; =&gt; &#39;patch&#39;
            };
-->
<strong>Added tag(s) upstream and fixed-upstream.</strong>
Request was from <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>
to <code>control@bugs.debian.org</code>.
 (Wed, 03 Feb 2021 21:39:03 GMT) (<a href="bugreport.cgi?bug=981404;msg=18">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=18">mbox</a>, <a href="#17">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="19"></a>
<!-- request_addr: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; -->
<!-- time:1612996383 -->
<strong>Reply sent</strong>
to <code>Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</code>:<br>
You have taken responsibility.
 (Wed, 10 Feb 2021 22:33:03 GMT) (<a href="bugreport.cgi?bug=981404;msg=20">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=20">mbox</a>, <a href="#19">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="21"></a>
<!-- request_addr: Harald Dunkel &lt;harri@afaics.de&gt; -->
<!-- time:1612996383 -->
<strong>Notification sent</strong>
to <code>Harald Dunkel &lt;harri@afaics.de&gt;</code>:<br>
Bug acknowledged by developer.
 (Wed, 10 Feb 2021 22:33:03 GMT) (<a href="bugreport.cgi?bug=981404;msg=22">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=22">mbox</a>, <a href="#21">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="23"></a><a name="msg23"></a><a href="#23">Message #23</a> received at 981404-close@bugs.debian.org (<a href="bugreport.cgi?bug=981404;msg=23">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=23">mbox</a>, <a href="mailto:981404@bugs.debian.org?References=%3CE1l9y1q-0005xU-Cz%40fasolo.debian.org%3E&amp;body=On%20Wed%2C%2010%20Feb%202021%2022%3A32%3A10%20%2B0000%20Debian%20FTP%20Masters%20%3Cftpmaster%40ftp-master.debian.org%3E%20wrote%3A%0A%3E%20Source%3A%20libzstd%0A%3E%20Source-Version%3A%201.3.8%2Bdfsg-3%2Bdeb10u1%0A%3E%20Done%3A%20%C3%89tienne%20Mollier%20%3Cetienne.mollier%40mailoo.org%3E%0A%3E%20%0A%3E%20We%20believe%20that%20the%20bug%20you%20reported%20is%20fixed%20in%20the%20latest%20version%20of%0A%3E%20libzstd%2C%20which%20is%20due%20to%20be%20installed%20in%20the%20Debian%20FTP%20archive.%0A%3E%20%0A%3E%20A%20summary%20of%20the%20changes%20between%20this%20version%20and%20the%20previous%20one%20is%0A%3E%20attached.%0A%3E%20%0A%3E%20Thank%20you%20for%20reporting%20the%20bug%2C%20which%20will%20now%20be%20closed.%20%20If%20you%0A%3E%20have%20further%20comments%20please%20address%20them%20to%20981404%40bugs.debian.org%2C%0A%3E%20and%20the%20maintainer%20will%20reopen%20the%20bug%20report%20if%20appropriate.%0A%3E%20%0A%3E%20Debian%20distribution%20maintenance%20software%0A%3E%20pp.%0A%3E%20%C3%89tienne%20Mollier%20%3Cetienne.mollier%40mailoo.org%3E%20%28supplier%20of%20updated%20libzstd%20package%29%0A%3E%20%0A%3E%20%28This%20message%20was%20generated%20automatically%20at%20their%20request%3B%20if%20you%0A%3E%20believe%20that%20there%20is%20a%20problem%20with%20it%20please%20contact%20the%20archive%0A%3E%20administrators%20by%20mailing%20ftpmaster%40ftp-master.debian.org%29%0A%3E%20%0A%3E%20%0A%3E%20-----BEGIN%20PGP%20SIGNED%20MESSAGE-----%0A%3E%20Hash%3A%20SHA512%0A%3E%20%0A%3E%20Format%3A%201.8%0A%3E%20Date%3A%20Mon%2C%2001%20Feb%202021%2020%3A36%3A53%20%2B0100%0A%3E%20Source%3A%20libzstd%0A%3E%20Architecture%3A%20source%0A%3E%20Version%3A%201.3.8%2Bdfsg-3%2Bdeb10u1%0A%3E%20Distribution%3A%20buster-security%0A%3E%20Urgency%3A%20high%0A%3E%20Maintainer%3A%20Debian%20Med%20Packaging%20Team%20%3Cdebian-med-packaging%40lists.alioth.debian.org%3E%0A%3E%20Changed-By%3A%20%C3%89tienne%20Mollier%20%3Cetienne.mollier%40mailoo.org%3E%0A%3E%20Closes%3A%20981404%0A%3E%20Changes%3A%0A%3E%20%20libzstd%20%281.3.8%2Bdfsg-3%2Bdeb10u1%29%20buster-security%3B%20urgency%3Dhigh%0A%3E%20%20.%0A%3E%20%20%20%20%2A%20Team%20upload.%0A%3E%20%20%20%20%2A%20When%20a%20file%20with%20restricted%20permissions%20is%20compressed%2C%20the%20resulting%20file%0A%3E%20%20%20%20%20%20inherits%20the%20umask%20of%20the%20user%20for%20the%20time%20of%20the%20compression.%20%20This%20will%0A%3E%20%20%20%20%20%20usually%20lead%20to%20surprising%20and%20too%20relaxed%20permissions.%20%20This%20update%20adds%0A%3E%20%20%20%20%20%20fix-file-permissions-on-compression.patch%20to%20make%20sure%20the%20compressed%20file%0A%3E%20%20%20%20%20%20is%20not%20group%20or%20world%20readable%20for%20the%20duration%20of%20the%20compression.%0A%3E%20%20%20%20%20%20Closes%3A%20%23981404%0A%3E%20Checksums-Sha1%3A%0A%3E%20%20909d33d6118457384ba8e90fe7b319ed70f58706%202292%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.dsc%0A%3E%20%204283d7fd3abb54208784456b8883c4c90d760940%201299276%20libzstd_1.3.8%2Bdfsg.orig.tar.xz%0A%3E%20%204ebdb2e9974bd2945008da1a3bc6d8fc1e0ca4bc%2010864%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.debian.tar.xz%0A%3E%20%207fefa795f057209c4624f79555b2e960f9b52311%207563%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1_amd64.buildinfo%0A%3E%20Checksums-Sha256%3A%0A%3E%20%206ce2a1aafcde927492ac01e89488dc1640fc1dab8be8ded1947b3c06a421d98c%202292%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.dsc%0A%3E%20%2003851f2c26ffbf1d43633df3f98966f3c62e698e91ef4dc90523915bc934e5f7%201299276%20libzstd_1.3.8%2Bdfsg.orig.tar.xz%0A%3E%20%200109ff8e2b23662da58fe018959844c264985345a9b03bdb2213b760de87611b%2010864%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.debian.tar.xz%0A%3E%20%2032ffe444a0584d9622510c11222e27f9dad7b0c4bc4436eb83917ea1b2e6bea4%207563%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1_amd64.buildinfo%0A%3E%20Files%3A%0A%3E%20%2083019be1592cf47a45a3b206c96a776a%202292%20libs%20optional%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.dsc%0A%3E%20%20be6c01a65c48b62e151dd0972a36e995%201299276%20libs%20optional%20libzstd_1.3.8%2Bdfsg.orig.tar.xz%0A%3E%20%20aa6dfd0f7bcf8b7bee01613540800fe1%2010864%20libs%20optional%20libzstd_1.3.8%2Bdfsg-3%2Bdeb10u1.debian.tar.xz%0A&amp;subject=Re%3A%20Bug%23981404%3A%20fixed%20in%20libzstd%201.3.8%2Bdfsg-3%2Bdeb10u1&amp;In-Reply-To=%3CE1l9y1q-0005xU-Cz%40fasolo.debian.org%3E">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=ftpmaster%40ftp-master.debian.org" alt="">
<div class="header"><span class="headerfield">From:</span> Debian FTP Masters &lt;ftpmaster@ftp-master.debian.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> 981404-close@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Bug#981404: fixed in libzstd 1.3.8+dfsg-3+deb10u1</div>
<div class="header"><span class="headerfield">Date:</span> Wed, 10 Feb 2021 22:32:10 +0000</div>
</div>
<pre class="message">Source: libzstd
Source-Version: 1.3.8+dfsg-3+deb10u1
Done: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;

We believe that the bug you reported is fixed in the latest version of
libzstd, which is due to be installed in the Debian FTP archive.

A summary of the changes between this version and the previous one is
attached.

Thank you for reporting the bug, which will now be closed.  If you
have further comments please address them to 981404@bugs.debian.org,
and the maintainer will reopen the bug report if appropriate.

Debian distribution maintenance software
pp.
Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; (supplier of updated libzstd package)

(This message was generated automatically at their request; if you
believe that there is a problem with it please contact the archive
administrators by mailing ftpmaster@ftp-master.debian.org)


-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Format: 1.8
Date: Mon, 01 Feb 2021 20:36:53 +0100
Source: libzstd
Architecture: source
Version: 1.3.8+dfsg-3+deb10u1
Distribution: buster-security
Urgency: high
Maintainer: Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;
Changed-By: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;
Closes: <a href="bugreport.cgi?bug=981404">981404</a>
Changes:
 libzstd (1.3.8+dfsg-3+deb10u1) buster-security; urgency=high
 .
   * Team upload.
   * When a file with restricted permissions is compressed, the resulting file
     inherits the umask of the user for the time of the compression.  This will
     usually lead to surprising and too relaxed permissions.  This update adds
     fix-file-permissions-on-compression.patch to make sure the compressed file
     is not group or world readable for the duration of the compression.
     Closes: #<a href="bugreport.cgi?bug=981404">981404</a>
Checksums-Sha1:
 909d33d6118457384ba8e90fe7b319ed70f58706 2292 libzstd_1.3.8+dfsg-3+deb10u1.dsc
 4283d7fd3abb54208784456b8883c4c90d760940 1299276 libzstd_1.3.8+dfsg.orig.tar.xz
 4ebdb2e9974bd2945008da1a3bc6d8fc1e0ca4bc 10864 libzstd_1.3.8+dfsg-3+deb10u1.debian.tar.xz
 7fefa795f057209c4624f79555b2e960f9b52311 7563 libzstd_1.3.8+dfsg-3+deb10u1_amd64.buildinfo
Checksums-Sha256:
 6ce2a1aafcde927492ac01e89488dc1640fc1dab8be8ded1947b3c06a421d98c 2292 libzstd_1.3.8+dfsg-3+deb10u1.dsc
 03851f2c26ffbf1d43633df3f98966f3c62e698e91ef4dc90523915bc934e5f7 1299276 libzstd_1.3.8+dfsg.orig.tar.xz
 0109ff8e2b23662da58fe018959844c264985345a9b03bdb2213b760de87611b 10864 libzstd_1.3.8+dfsg-3+deb10u1.debian.tar.xz
 32ffe444a0584d9622510c11222e27f9dad7b0c4bc4436eb83917ea1b2e6bea4 7563 libzstd_1.3.8+dfsg-3+deb10u1_amd64.buildinfo
Files:
 83019be1592cf47a45a3b206c96a776a 2292 libs optional libzstd_1.3.8+dfsg-3+deb10u1.dsc
 be6c01a65c48b62e151dd0972a36e995 1299276 libs optional libzstd_1.3.8+dfsg.orig.tar.xz
 aa6dfd0f7bcf8b7bee01613540800fe1 10864 libs optional libzstd_1.3.8+dfsg-3+deb10u1.debian.tar.xz
 bc263ca409b530dcf48154928f71690b 7563 libs optional libzstd_1.3.8+dfsg-3+deb10u1_amd64.buildinfo

-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEsaUesned0BdDzBm6HPeSERtSKLAFAmAhotsACgkQHPeSERtS
KLBNnQ//eMzoHIEaIcfFb7KrxETltbOTWnXG5ml6CjV/gIrtGe+aLshUJTa8Uek9
ABaVXd1ij9yh81f6Hx1MsKYk66EbYz33TVV3UwjTgDjysKqH9g2SgZ6Gm3Wb1EQE
NOAu0BNTTtdw6KPI7Rn3URMR6Ab6rnu93OXOo8uL8f0lqVhWqnu8Vvw+pBoVBnT5
SH4Q98GdIjxitKvBIuTKGcqCgV25lUb+Ccg6QmkWDrRRL/ESxGrC4cj487aoVLem
v2WxQpQlyOrI7/SMsG24Tf1Bp+wMCiDptiv/LVkJOQF3YtQWtAv+EUNQDAg3+OAv
H/Z3qq+qIGx6+yS/yAPPd8CchZVMAG6Gi/25PniwJ9/BPjIXBUL3vj8DabyoEJyN
cWkd+SavLPjPtkvPZCdA1NqK0V0UtMp0/ET111pTfdGXxdKxLhrL1IOHyymH4FZ6
+aqNbc90fophz8+DtjxvWPN7MH+llrako1TS3tvuJuGOQdjLtjE1zowo10KTDeJd
D8lI8eRQ6bD+CdlUC6o2RJ5lWh2oiRaOx1wDSHdGij4jYDxtuVV3C7HlT0tFyYiP
p2HZe+fz0ekMTTjJkJjoqsGw80n6yM6UocMfDphnqrPlNAR9GcEUFXy8eeny3i4v
H3CZSV6OfaxSK7N/KCCqPWDKj9VScGC5R4wp4CqIiTmByxapXdY=
=9+fx
-----END PGP SIGNATURE-----



</pre>

<div class="infmessage"><hr><p>
<a name="24"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt; -->
<!-- time:1613039403 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>:<br>
<code>Bug#981404</code>; Package <code>zstd</code>.
 (Thu, 11 Feb 2021 10:30:03 GMT) (<a href="bugreport.cgi?bug=981404;msg=25">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=25">mbox</a>, <a href="#24">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="26"></a>
<!-- request_addr: wferi@niif.hu -->
<!-- time:1613039403 -->
<strong>Acknowledgement sent</strong>
to <code>wferi@niif.hu</code>:<br>
Extra info received and forwarded to list.  Copy sent to <code>Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>.
 (Thu, 11 Feb 2021 10:30:03 GMT) (<a href="bugreport.cgi?bug=981404;msg=27">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=27">mbox</a>, <a href="#26">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="28"></a><a name="msg28"></a><a href="#28">Message #28</a> received at 981404@bugs.debian.org (<a href="bugreport.cgi?bug=981404;msg=28">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=28">mbox</a>, <a href="mailto:981404@bugs.debian.org?subject=Re%3A%20Fix%20seems%20incomplete&amp;In-Reply-To=%3C87wnvex5lk.fsf%40lant.ki.iif.hu%3E&amp;References=%3C87wnvex5lk.fsf%40lant.ki.iif.hu%3E&amp;body=On%20Thu%2C%2011%20Feb%202021%2011%3A26%3A47%20%2B0100%20wferi%40niif.hu%20wrote%3A%0A%3E%20Hi%2C%0A%3E%20%0A%3E%20The%20patch%20in%20this%20bug%20report%20very%20much%20shrinks%20the%20window%20of%20the%0A%3E%20vulnerability%2C%20but%20doesn%27t%20close%20it%20completely%3A%20the%20file%20is%20still%0A%3E%20created%20with%20default%20permissions%2C%20then%20chmodded%20as%20a%20separate%20step.%0A%3E%20It%27s%20hard%2C%20but%20not%20impossible%20to%20still%20win%20the%20race%20and%20open%20the%20file%0A%3E%20before%20the%20chmod%2C%20enabling%20the%20same%20attack.%20%20I%20recommend%20something%20like%0A%3E%20%0A%3E%20fd%20%3D%20open%28dstFileName%2C%20O_WRONLY%7CO_CREAT%7CO_EXCL%2C%200600%29%3B%0A%3E%20if%20%28fd%20%21%3D%20-1%29%0A%3E%20%20%20%20%20f%20%3D%20fdopen%28%20fd%2C%20%22wb%22%20%29%3B%0A%3E%20if%20%28fd%20%3D%3D%20-1%20%7C%7C%20f%20%3D%3D%20NULL%29%0A%3E%20%20%20%20%20DISPLAYLEVEL%281%2C%20%22zstd%3A%20%25s%3A%20%25s%5Cn%22%2C%20dstFileName%2C%20strerror%28errno%29%29%3B%0A%3E%20return%20f%3B%0A%3E%20%0A%3E%20for%20example.%0A%3E%20--%20%0A%3E%20Regards%2C%0A%3E%20Feri%0A%3E%20%0A%3E%20%0A">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=wferi%40niif.hu" alt="">
<div class="header"><span class="headerfield">From:</span> wferi@niif.hu</div>
<div class="header"><span class="headerfield">To:</span> 981404@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Fix seems incomplete</div>
<div class="header"><span class="headerfield">Date:</span> Thu, 11 Feb 2021 11:26:47 +0100</div>
</div>
<pre class="message">Hi,

The patch in this bug report very much shrinks the window of the
vulnerability, but doesn&#39;t close it completely: the file is still
created with default permissions, then chmodded as a separate step.
It&#39;s hard, but not impossible to still win the race and open the file
before the chmod, enabling the same attack.  I recommend something like

fd = open(dstFileName, O_WRONLY|O_CREAT|O_EXCL, 0600);
if (fd != -1)
    f = fdopen( fd, &quot;wb&quot; );
if (fd == -1 || f == NULL)
    DISPLAYLEVEL(1, &quot;zstd: %s: %s\n&quot;, dstFileName, strerror(errno));
return f;

for example.
-- 
Regards,
Feri


</pre>

<div class="infmessage"><hr><p>
<a name="29"></a>
<!-- request_addr: debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt; -->
<!-- time:1613059024 -->
<strong>Information forwarded</strong>
to <code>debian-bugs-dist@lists.debian.org, Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>:<br>
<code>Bug#981404</code>; Package <code>zstd</code>.
 (Thu, 11 Feb 2021 15:57:04 GMT) (<a href="bugreport.cgi?bug=981404;msg=30">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=30">mbox</a>, <a href="#29">link</a>).</p></p></div>

<div class="infmessage"><hr><p>
<a name="31"></a>
<!-- request_addr: Salvatore Bonaccorso &lt;carnil@debian.org&gt; -->
<!-- time:1613059024 -->
<strong>Acknowledgement sent</strong>
to <code>Salvatore Bonaccorso &lt;carnil@debian.org&gt;</code>:<br>
Extra info received and forwarded to list.  Copy sent to <code>Debian Med Packaging Team &lt;debian-med-packaging@lists.alioth.debian.org&gt;</code>.
 (Thu, 11 Feb 2021 15:57:04 GMT) (<a href="bugreport.cgi?bug=981404;msg=32">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=32">mbox</a>, <a href="#31">link</a>).</p></p></div>

<hr><p class="msgreceived"><a name="33"></a><a name="msg33"></a><a href="#33">Message #33</a> received at 981404@bugs.debian.org (<a href="bugreport.cgi?bug=981404;msg=33">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=33">mbox</a>, <a href="mailto:981404@bugs.debian.org?body=On%20Thu%2C%2011%20Feb%202021%2016%3A54%3A53%20%2B0100%20Salvatore%20Bonaccorso%20%3Ccarnil%40debian.org%3E%20wrote%3A%0A%3E%20Hi%20Feri%2C%2C%0A%3E%20%0A%3E%20On%20Thu%2C%20Feb%2011%2C%202021%20at%2011%3A26%3A47AM%20%2B0100%2C%20wferi%40niif.hu%20wrote%3A%0A%3E%20%3E%20Hi%2C%0A%3E%20%3E%20%0A%3E%20%3E%20The%20patch%20in%20this%20bug%20report%20very%20much%20shrinks%20the%20window%20of%20the%0A%3E%20%3E%20vulnerability%2C%20but%20doesn%27t%20close%20it%20completely%3A%20the%20file%20is%20still%0A%3E%20%3E%20created%20with%20default%20permissions%2C%20then%20chmodded%20as%20a%20separate%20step.%0A%3E%20%3E%20It%27s%20hard%2C%20but%20not%20impossible%20to%20still%20win%20the%20race%20and%20open%20the%20file%0A%3E%20%3E%20before%20the%20chmod%2C%20enabling%20the%20same%20attack.%20%20I%20recommend%20something%20like%0A%3E%20%3E%20%0A%3E%20%3E%20fd%20%3D%20open%28dstFileName%2C%20O_WRONLY%7CO_CREAT%7CO_EXCL%2C%200600%29%3B%0A%3E%20%3E%20if%20%28fd%20%21%3D%20-1%29%0A%3E%20%3E%20%20%20%20%20f%20%3D%20fdopen%28%20fd%2C%20%22wb%22%20%29%3B%0A%3E%20%3E%20if%20%28fd%20%3D%3D%20-1%20%7C%7C%20f%20%3D%3D%20NULL%29%0A%3E%20%3E%20%20%20%20%20DISPLAYLEVEL%281%2C%20%22zstd%3A%20%25s%3A%20%25s%5Cn%22%2C%20dstFileName%2C%20strerror%28errno%29%29%3B%0A%3E%20%3E%20return%20f%3B%0A%3E%20%3E%20%0A%3E%20%3E%20for%20example.%0A%3E%20%0A%3E%20See%20%23982519%20respectively%20https%3A%2F%2Fgithub.com%2Ffacebook%2Fzstd%2Fissues%2F2491%0A%3E%20upstream.%0A%3E%20%0A%3E%20Regards%2C%0A%3E%20Salvatore%0A%3E%20%0A%3E%20%0A&amp;References=%3Cb90aa02e-803c-a261-6b29-c3496a2a4f88%40afaics.de%3E%0A%20%3C87wnvex5lk.fsf%40lant.ki.iif.hu%3E%0A%20%3CYCVTTU61gD7el9I1%40eldamar.lan%3E&amp;In-Reply-To=%3CYCVTTU61gD7el9I1%40eldamar.lan%3E&amp;subject=Re%3A%20Bug%23981404%3A%20Fix%20seems%20incomplete">reply</a>):</p>
<div class="headers">
<img src="/cgi-bin/libravatar.cgi?email=carnil%40debian.org" alt="">
<div class="header"><span class="headerfield">From:</span> Salvatore Bonaccorso &lt;carnil@debian.org&gt;</div>
<div class="header"><span class="headerfield">To:</span> wferi@niif.hu, 981404@bugs.debian.org</div>
<div class="header"><span class="headerfield">Cc:</span> 982519@bugs.debian.org</div>
<div class="header"><span class="headerfield">Subject:</span> Re: Bug#981404: Fix seems incomplete</div>
<div class="header"><span class="headerfield">Date:</span> Thu, 11 Feb 2021 16:54:53 +0100</div>
</div>
<pre class="message">Hi Feri,,

On Thu, Feb 11, 2021 at 11:26:47AM +0100, wferi@niif.hu wrote:
&gt; Hi,
&gt; 
&gt; The patch in this bug report very much shrinks the window of the
&gt; vulnerability, but doesn&#39;t close it completely: the file is still
&gt; created with default permissions, then chmodded as a separate step.
&gt; It&#39;s hard, but not impossible to still win the race and open the file
&gt; before the chmod, enabling the same attack.  I recommend something like
&gt; 
&gt; fd = open(dstFileName, O_WRONLY|O_CREAT|O_EXCL, 0600);
&gt; if (fd != -1)
&gt;     f = fdopen( fd, &quot;wb&quot; );
&gt; if (fd == -1 || f == NULL)
&gt;     DISPLAYLEVEL(1, &quot;zstd: %s: %s\n&quot;, dstFileName, strerror(errno));
&gt; return f;
&gt; 
&gt; for example.

See #982519 respectively <a href="https://github.com/facebook/zstd/issues/2491">https://github.com/facebook/zstd/issues/2491</a>
upstream.

Regards,
Salvatore


</pre>

<div class="msgreceived"><hr><p>
<a name="34"></a>
<!-- command:found -->
<!-- requester: Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt; -->
<!-- request_addr: control@bugs.debian.org -->
<!-- time:1613811242 -->
<!-- new_data:
$new_data = {
              &#39;found_versions&#39; =&gt; [
                                    &#39;libzstd/1.3.8+dfsg-3&#39;,
                                    &#39;libzstd/1.1.2-1&#39;
                                  ]
            };
-->
<!-- old_data:
$old_data = {
              &#39;found_versions&#39; =&gt; [
                                    &#39;libzstd/1.3.8+dfsg-3&#39;
                                  ]
            };
-->
<strong>Marked as found in versions libzstd/1.1.2-1.</strong>
Request was from <code>Ã‰tienne Mollier &lt;etienne.mollier@mailoo.org&gt;</code>
to <code>control@bugs.debian.org</code>.
 (Sat, 20 Feb 2021 08:54:02 GMT) (<a href="bugreport.cgi?bug=981404;msg=35">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=35">mbox</a>, <a href="#34">link</a>).</p></p></div>

<div class="msgreceived"><hr><p>
<a name="36"></a>
<!-- command:archive -->
<!-- requester: Debbugs Internal Request &lt;owner@bugs.debian.org&gt; -->
<!-- request_addr: internal_control@bugs.debian.org -->
<!-- time:1616916305 -->
<!-- new_data:
$new_data = {};
-->
<!-- old_data:
$old_data = {};
-->
<strong>Bug archived.</strong>
Request was from <code>Debbugs Internal Request &lt;owner@bugs.debian.org&gt;</code>
to <code>internal_control@bugs.debian.org</code>.
 (Sun, 28 Mar 2021 07:25:05 GMT) (<a href="bugreport.cgi?bug=981404;msg=37">full text</a>, <a href="bugreport.cgi?bug=981404;mbox=yes;msg=37">mbox</a>, <a href="#36">link</a>).</p></p></div>

<hr>
<p class="msgreceived">Send a report that <a href="https://bugs.debian.org/cgi-bin/bugspam.cgi?bug=981404">this bug log contains spam</a>.</p>
<hr>
<ADDRESS>Debian bug tracking system administrator &lt;<A HREF="mailto:owner@bugs.debian.org">owner@bugs.debian.org</A>&gt;.
Last modified:
<!--timestamp-->Sat Oct 30 18:36:36 2021<!--end timestamp-->; 
Machine Name:
<!--machinename-->buxtehude<!--machinename-->
<P>
<A HREF="https://www.debian.org/Bugs/">Debian Bug tracking system</A>
</p>
<p>
  Debbugs is free software and licensed under the terms of the GNU
  Public License version 2. The current version can be obtained
  from <a href="https://bugs.debian.org/debbugs-source/">https://bugs.debian.org/debbugs-source/</a>.
</p>
<p>
Copyright Â© 1999 Darren O. Benham,
1997,2003 nCipher Corporation Ltd,
1994-97 Ian Jackson,
2005-2017 Don Armstrong, and many other contributors.
</p>
</ADDRESS>

</body>
</html>
