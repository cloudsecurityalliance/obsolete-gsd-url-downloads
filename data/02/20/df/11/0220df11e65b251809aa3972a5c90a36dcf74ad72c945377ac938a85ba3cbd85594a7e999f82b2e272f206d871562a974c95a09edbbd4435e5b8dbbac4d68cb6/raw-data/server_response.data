<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 2134613002: Stop injection when injections are invalidated -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '90effb4d35f727fe4ec2f6e1a85cc7aa';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/2134613002%252526ust%25253D1608725336607117%252526usg%25253DAFQjCNHYzcQoQRVN8emBBdGUPOoE2EWRkQ%26service%3Dah">Sign out</a>

</div>
<div class="counter">(391)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-2134613002">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/2134613002/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            2134613002</a>:
    Stop injection when injections are invalidated 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            4 years, 5 months ago by <a href="/user/robwu" onMouseOver="M_showUserInfoPopup(this)">robwu</a>
          </div>
          <div><b>Modified:</b><br/>
            4 years, 5 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <a href="/user/Devlin" onMouseOver="M_showUserInfoPopup(this)">Devlin</a>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, chromium-apps-reviews_chromium.org, extensions-reviews_chromium.org
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Stop injection when injections are invalidated

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=625393">625393</a>

  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/2134613002/#ps1"
       onclick="M_toggleSectionForPS('2134613002', '1')"
       class="toggled-section ">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 4
      
    </div>
  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-20001-pointer"
       href="/2134613002/#ps20001"
       onclick="M_toggleSectionForPS('2134613002', '20001')"
       class="toggled-section opentriangle">
      Patch Set 2
      : Expand scope of ScriptInjectionWatchers
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 2
      
    </div>
  

  <div id="ps-20001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 4 years, 5 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue2134613002_20001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/2134613002/20001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+112 lines, -33 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2134613002/patch/20001/30002">
            extensions/renderer/script_injection.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2134613002/diff/20001/extensions/renderer/script_injection.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">2 chunks</td>
          <td style="white-space: nowrap">+3 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2134613002_20001_30002.diff"
             title="Download patch for extensions/renderer/script_injection.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2134613002/patch/20001/30001">
            extensions/renderer/script_injection.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2134613002/diff/20001/extensions/renderer/script_injection.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2134613002/diff2/1:20001/extensions/renderer/script_injection.cc"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">5 chunks</td>
          <td style="white-space: nowrap">+13 lines, -3 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2134613002_20001_30001.diff"
             title="Download patch for extensions/renderer/script_injection.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2134613002/patch/20001/30004">
            extensions/renderer/script_injection_manager.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2134613002/diff/20001/extensions/renderer/script_injection_manager.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2134613002/diff2/1:20001/extensions/renderer/script_injection_manager.h"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">3 chunks</td>
          <td style="white-space: nowrap">+5 lines, -3 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2134613002_20001_30004.diff"
             title="Download patch for extensions/renderer/script_injection_manager.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2134613002/patch/20001/30003">
            extensions/renderer/script_injection_manager.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/2134613002/diff2/1:20001/extensions/renderer/script_injection_manager.cc"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">12 chunks</td>
          <td style="white-space: nowrap">+82 lines, -12 lines</td>
        
        <td style="white-space: nowrap">
          <b>
            2 comments
            
            
          </b>
        </td>
        <td>
          <a href="/download/issue2134613002_20001_30003.diff"
             title="Download patch for extensions/renderer/script_injection_manager.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/2134613002/patch/20001/30005">
            extensions/renderer/user_script_injector.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/2134613002/diff/20001/extensions/renderer/user_script_injector.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">5 chunks</td>
          <td style="white-space: nowrap">+9 lines, -15 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue2134613002_20001_30005.diff"
             title="Download patch for extensions/renderer/user_script_injector.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 20001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 6 (1 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 6)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 6)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(6)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(6)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>robwu</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          rob@robwu.nl changed reviewers: + rdevlin.cronin@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-08 09:12:36 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            ><a href="mailto:rob@robwu.nl">rob@robwu.nl</a> changed reviewers:
+ <a href="mailto:rdevlin.cronin@chromium.org">rdevlin.cronin@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>robwu</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          Tested locally using the same steps as the other patch.
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-08 09:12:37 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            >Tested locally using the same steps as the other patch.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Devlin</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc File extensions/renderer/script_injection.cc (right): https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc#newcode225 extensions/renderer/script_injection.cc:225: if (!injection_host_) A comment explaining why/how this could happen ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-08 20:51:09 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            ><a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
File extensions/renderer/script_injection.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc#newcode225" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
extensions/renderer/script_injection.cc:225: if (!injection_host_)
A comment explaining why/how this could happen would be useful.

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection_manager.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
File extensions/renderer/script_injection_manager.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection_manager.cc#newcode446" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
extensions/renderer/script_injection_manager.cc:446: ScriptInjectionWatcher
watcher(injection.get(), this);
Hmm... I think this isn&#39;t quite sufficient.  Consider the following scenario:
Extensions A and B both want to inject on a page.
Extension A injects, and blocks.
During blocking, Extension B is removed
  We only have a watcher for Extension A (the injecting one)
Extension B starts injecting, and blows up

Unless I&#39;m missing some way that&#39;s mitigated?

Instead, I think we have to keep track of both pending and active injections
during these times, and notify both of extension host removal.  This will
probably render the Watcher class unnecessary.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>robwu</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc File extensions/renderer/script_injection.cc (right): https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc#newcode225 extensions/renderer/script_injection.cc:225: if (!injection_host_) On 2016/07/08 20:51:09, Devlin wrote: &gt; A ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-09 05:22:02 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            ><a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
File extensions/renderer/script_injection.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection.cc#newcode225" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
extensions/renderer/script_injection.cc:225: if (!injection_host_)
On 2016/07/08 20:51:09, Devlin wrote:
&gt; A comment explaining why/how this could happen would be useful.

Done.

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection_manager.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
File extensions/renderer/script_injection_manager.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_injection_manager.cc#newcode446" rel="nofollow">https://codereview.chromium.org/2134613002/diff/1/extensions/renderer/script_...</a>
extensions/renderer/script_injection_manager.cc:446: ScriptInjectionWatcher
watcher(injection.get(), this);
On 2016/07/08 20:51:09, Devlin wrote:
&gt; Hmm... I think this isn&#39;t quite sufficient.  Consider the following scenario:
&gt; Extensions A and B both want to inject on a page.
&gt; Extension A injects, and blocks.
&gt; During blocking, Extension B is removed
&gt;   We only have a watcher for Extension A (the injecting one)
&gt; Extension B starts injecting, and blows up
&gt; 
&gt; Unless I&#39;m missing some way that&#39;s mitigated?

You&#39;re right - I solved the issue by constructing a queue of
ScriptInjectionWatchers. I also moved the frame logic to
active_injection_frames_, so that we can have an early out in the
ScriptInjection::Inject (similarly to |injection_host_|).

&gt; Instead, I think we have to keep track of both pending and active injections
&gt; during these times, and notify both of extension host removal.  This will
&gt; probably render the Watcher class unnecessary.

I added the class to avoid spreeing push_back with a balanced find &amp; erase all
over the place. With the watcher class, the watcher is set up when it&#39;s
constructed and automatically removed upon destruction.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>Devlin</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc File extensions/renderer/script_injection_manager.cc (right): https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc#newcode110 extensions/renderer/script_injection_manager.cc:110: class ScriptInjectionManager::ScriptInjectionWatcher { I&#39;m still not quite happy with ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-11 23:30:55 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            ><a href="https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/scr...</a>
File extensions/renderer/script_injection_manager.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc#newcode110" rel="nofollow">https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/scr...</a>
extensions/renderer/script_injection_manager.cc:110: class
ScriptInjectionManager::ScriptInjectionWatcher {
I&#39;m still not quite happy with this implementation.  It seems a little like it&#39;s
more complicated than it should be (I&#39;m worried we&#39;re going to forget to put one
of these somewhere, etc), while also not fully addressing the concerns (e.g.
what if a ScriptInjection blocks, and finishes asynchronously? The injection is
stored in running_injections_, but it doesn&#39;t look like we&#39;ll update the
extension or frame for those).

I wonder if there&#39;s a way that we can put a little more of this logic into the
ScriptInjection/InjectionHost.  For one thing, we now have the
RendererExtensionRegistry(), which we could check for the presence of the
extension.  Then rather than having these updates, we can just check
injection_host_-&gt;IsValid() at set times throughout the injection process. 
Unfortunately, that doesn&#39;t answer the question of frames.

I&#39;ll think on this a bit more and circle back, but if you had any thoughts,
happy to hear them. :)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>robwu</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-5">
                          https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc File extensions/renderer/script_injection_manager.cc (right): https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc#newcode110 extensions/renderer/script_injection_manager.cc:110: class ScriptInjectionManager::ScriptInjectionWatcher { On 2016/07/11 23:30:55, Devlin wrote: &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                4 years, 5 months ago
		(2016-07-12 08:59:36 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             >
          <div class="message-body">
            
            <pre name="cl-message-5"
            ><a href="https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc" rel="nofollow">https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/scr...</a>
File extensions/renderer/script_injection_manager.cc (right):

<a href="https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/script_injection_manager.cc#newcode110" rel="nofollow">https://codereview.chromium.org/2134613002/diff/20001/extensions/renderer/scr...</a>
extensions/renderer/script_injection_manager.cc:110: class
ScriptInjectionManager::ScriptInjectionWatcher {
On 2016/07/11 23:30:55, Devlin wrote:
&gt; I&#39;m still not quite happy with this implementation.  It seems a little like
it&#39;s
&gt; more complicated than it should be (I&#39;m worried we&#39;re going to forget to put
one
&gt; of these somewhere, etc), while also not fully addressing the concerns (e.g.
&gt; what if a ScriptInjection blocks, and finishes asynchronously? The injection
is
&gt; stored in running_injections_, but it doesn&#39;t look like we&#39;ll update the
&gt; extension or frame for those).

We only need to be careful when InjectJs() is called.
Currently, when a script is *not* being injected, it is stored in
|pending_injections_| or |running_injections_|. If it *is* about to be injected,
there will always be a ScriptInjectionWatcher on the stack, which was designed
to be resilient against unexpected reentrancy (with respect to the same
frame/injection).


&gt; I wonder if there&#39;s a way that we can put a little more of this logic into the
&gt; ScriptInjection/InjectionHost.  For one thing, we now have the
&gt; RendererExtensionRegistry(), which we could check for the presence of the
&gt; extension.  Then rather than having these updates, we can just check
&gt; injection_host_-&gt;IsValid() at set times throughout the injection process. 
&gt; Unfortunately, that doesn&#39;t answer the question of frames.

Scripts injection should be aborted in the following cases:

1. Extension unloads.
2. Extension reloads.
3. Frame unloads (includes frame reloads).

Using RendererExtensionRegistry seems to only cover case 1, not case 2.

&gt; I&#39;ll think on this a bit more and circle back, but if you had any thoughts,
happy to hear them. :)

I only have half-baked thoughts for now. The issue is that InjectionHost and
ScriptInjection can outlive each other, so there needs to be some mediator that
outlives both (or some token that is reset whenever either of the invalidation
events occur). I found this role in the UserScriptManager (and the new watcher).</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 6)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 6)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(6)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(6)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 6;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 2134613002;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 2134613002: Stop injection when injections are invalidated
    </b><br/>
      Created 4 years, 5 months ago by robwu<br/>
      Modified 4 years, 5 months ago<br/>
      Reviewers: Devlin<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 6
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
