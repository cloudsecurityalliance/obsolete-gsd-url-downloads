<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/qemu/+bug/1912780/+index" />

    <meta charset="UTF-8" />
    <title>Bug #1912780 “QEMU: Null Pointer Failure in fdctrl_read() in hw/...” : Bugs : QEMU</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/1912780" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/1912780/bug.atom" title="Bug 1912780 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="[via qemu-security list]

This is Gaoning Pan from Zhejiang University &amp; Ant Security Light-Year Lab.
I found a Null Pointer issue locates in fdctrl_read() in  hw/block/fdc.c.
This flaw allows a malicious guest user or process in a denial of service condition.

This issus was discovered in the latest Qemu-5.2.0. When using floppy device, there are several
choices to get specific drive in get_drv(), depending on fdctrl-&gt;cur_drv. But not all drives are
initialized properly, leaving fdctrl-&gt;driv..." />
      <meta property="og:description" content="[via qemu-security list]

This is Gaoning Pan from Zhejiang University &amp; Ant Security Light-Year Lab.
I found a Null Pointer issue locates in fdctrl_read() in  hw/block/fdc.c.
This flaw allows a malicious guest user or process in a denial of service condition.

This issus was discovered in the latest Qemu-5.2.0. When using floppy device, there are several
choices to get specific drive in get_drv(), depending on fdctrl-&gt;cur_drv. But not all drives are
initialized properly, leaving fdctrl-&gt;driv..." />
    

    
    
      <meta property="og:title" content="Bug #1912780 “QEMU: Null Pointer Failure in fdctrl_read() in hw/...” : Bugs : QEMU" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/1912780" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["arm", "feature-request", "i386", "linux-user", "mips", "patch", "ppc", "qemu-img", "s390x", "sh4", "sparc", "usb", "windows"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/qemu/+bug/1912780/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/qemu"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/27372372/qemu_64.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/qemu">QEMU</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/qemu">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/qemu">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/qemu">Bugs</a></li>
      
      
    
    
      
      <li class="specifications"><a href="https://blueprints.launchpad.net/qemu">Blueprints</a></li>
      
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/qemu">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/qemu">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    QEMU: Null Pointer Failure in fdctrl_read() in hw/block/fdc.c
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #1912780 reported by
      <a href="https://launchpad.net/~pjps" class="sprite person">P J P</a>
      <time title="2021-01-22 12:37:06 UTC" datetime="2021-01-22T12:37:06.579963+00:00">on 2021-01-22</time>
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">258</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr class="highlight" id="tasksummary2676750">
    <td>
      <a class="bugtask-expander" href="https://bugs.launchpad.net/qemu/+bug/1912780/+editstatus">
        &#8203;
      </a>
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2676750">
        <span class="yui3-activator-data-box">
            <a class="sprite product" href="https://bugs.launchpad.net/qemu">QEMU</a>
        </span>
        <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
          Edit
        </button>
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        
        
          <a href="https://bugs.launchpad.net/qemu/+bug/1912780/+editstatus" style="float: left" class="value statusEXPIRED">Expired</a>
          <a href="https://bugs.launchpad.net/qemu/+bug/1912780/+editstatus" style="margin-left: 3px">
            <img class="editicon" src="/@@/edit" />
          </a>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceHIGH">High</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2676750">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
            Edit
          </button>
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  
    <tr class="bugtask-collapsible-content hidden" id="task2676750">
     <td colspan="7"><form action="/qemu/+bug/1912780/+editstatus" method="post" enctype="multipart/form-data">
  

  <p class="error message">
    You need to log in to change this bug's status.
  </p>
  
  <table class="summary" style="float: right; margin-left: 1em;">
    <tr>
      <th>Affecting:</th>
      <td><a href="/qemu">QEMU</a></td>
    </tr>
    <tr>
      <th>Filed here by:</th>
      <td><a href="https://launchpad.net/~pjps" class="sprite person">P J P</a></td>
    </tr>
    <tr>
      <th>When:</th>
      <td>
        <time title="2021-01-22 12:37:06 UTC" datetime="2021-01-22T12:37:06.579963+00:00">2021-01-22</time>
      </td>
    </tr>
    
    
    
    <tr>
      <th>Completed:</th>
      <td>
        <time title="2021-05-18 04:41:42 UTC" datetime="2021-05-18T04:41:42.807153+00:00">2021-05-18</time>
      </td>
    </tr>
  </table>
  <div class="field">
    <table>
      <tr>
        <td>
          <label for="qemu.target">Target</label>
        </td>
      </tr>
      <tr>
        <td>
          <table>
  <tr>
    <td>
      <label>
        <input class="radioType" id="qemu.target.option.package" name="qemu.target" type="radio" value="package" />
        Distribution
      </label>
    </td>
    <td>
      <select id="qemu.target.distribution" name="qemu.target.distribution" size="1" >
<option value="baltix">Baltix</option>
<option value="boss">BOSS</option>
<option value="charms">Juju Charms Collection</option>
<option value="elbuntu">Elbuntu</option>
<option value="guadalinex">Guadalinex</option>
<option value="guadalinexedu">Guadalinex Edu</option>
<option value="kiwilinux">Kiwi Linux</option>
<option value="nubuntu">nUbuntu</option>
<option value="pld-linux">PLD Linux</option>
<option value="tilix">Tilix</option>
<option value="tuxlab">tuXlab</option>
<option selected="selected" value="ubuntu">Ubuntu</option>
<option value="ubuntu-leb">Ubuntu Linaro Evaluation Build</option>
<option value="ubuntu-rtm">Ubuntu RTM</option>
</select>
<input name="qemu.target.distribution-empty-marker" type="hidden" value="1" />
    </td>
  </tr>
  <tr>
    <td align="right">
      <label for="qemu.target.option.package">
        Package
      </label>
    </td>
    <td>
      


    <input type="text" value="" id="qemu.target.package"
                         name="qemu.target.package" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;qemu.target.option.package&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('qemu.target.package');
              var select_menu = Y.DOM.byId('qemu.target.package-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-qemu-target-package" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_assign_me_button": false, "extra_no_results_message": null, "picker_type": "default", "selected_value_metadata": null, "remove_team_text": "Remove team", "selected_value": null, "step_title": "Search by name", "header": "Select a package", "vocabulary_filters": [], "show_create_team": false, "input_element": "qemu.target.package", "assign_me_text": "Pick me", "remove_person_text": "Remove person", "show_remove_button": false, "vocabulary_name": "DistributionPackage", "show_widget_id": "show-widget-qemu-target-package"};
        var show_widget_id = 'show-widget-qemu-target-package';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>

  <tr>
    <td>
      <label>
        <input class="radioType" checked="checked" id="qemu.target.option.product" name="qemu.target" type="radio" value="product" />
       Project
      </label>
    </td>
    <td>
      


    <input type="text" value="qemu" id="qemu.target.product"
                         name="qemu.target.product" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;qemu.target.option.product&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('qemu.target.product');
              var select_menu = Y.DOM.byId('qemu.target.product-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-qemu-target-product" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"show_assign_me_button": false, "extra_no_results_message": null, "picker_type": "default", "selected_value_metadata": null, "remove_team_text": "Remove team", "selected_value": "qemu", "step_title": "Search", "header": "Select a project", "vocabulary_filters": [], "show_create_team": false, "input_element": "qemu.target.product", "assign_me_text": "Pick me", "remove_person_text": "Remove person", "show_remove_button": false, "vocabulary_name": "Product", "show_widget_id": "show-widget-qemu-target-product"};
        var show_widget_id = 'show-widget-qemu-target-product';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>
</table>

          
        </td>
      </tr>
    </table>
    
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="qemu.status">Status</label>
        </td>
        <td>
          <label style="font-weight: bold" for="qemu.importance">Importance</label>
        </td>
        
      </tr>
      <tr>
        <td><div>
<div class="value">
<select id="qemu.status" name="qemu.status" size="1" >
<option selected="selected" value="Expired">Expired</option>
</select>
</div>
<input name="qemu.status-empty-marker" type="hidden" value="1" />
</div></td>
        <td title="Changeable only by a project maintainer or bug supervisor">
          <span class="sprite read-only"></span>
          <span class="importanceHIGH">High</span>
        </td>
        
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="qemu.assignee">Assigned to</label>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="white-space: nowrap">

  <table>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" checked="checked" id="qemu.assignee.assign_to_nobody" name="qemu.assignee.option" value="qemu.assignee.assign_to_nobody" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="qemu.assignee.assign_to_nobody">
          Nobody
        </label>
      </td>
    </tr>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" id="qemu.assignee.assign_to_me" name="qemu.assignee.option" value="qemu.assignee.assign_to_me" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="qemu.assignee.assign_to_me">
          Me
        </label>
      </td>
    </tr>
    
    
  </table>


</td>
      </tr>
    </table>
    
  </div>
  <div class="field">
    <div>
      <label style="font-weight: bold" for="qemu.comment_on_change">Comment on this change (optional)</label>
      <textarea cols="62" rows="4" id="qemu.comment_on_change" name="qemu.comment_on_change"></textarea>
    </div>
    <div>
      <label style="font-weight: normal">
        <input type="checkbox" name="subscribe" id="subscribe" value="Subscribe" />
        Email me about changes to this bug report
      </label>
    </div>
  </div>
  
</form>
</td>
    </tr>
  


        
      </tbody>

    </table>



<div class="actions">
  
    <span id="also-affects-product" class="">
    <a class="menu-link-addupstream sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+choose-affected-product">Also affects project</a>
        <a href="/+help-bugs/also-affects-project-help.html" target="help" class="sprite maybe action-icon">(?)</a>
    </span>
    <span id="also-affects-package" class="">
    <a class="menu-link-adddistro sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+distrotask">Also affects distribution/package</a>
    </span>
    <a class="menu-link-nominate sprite milestone" href="https://bugs.launchpad.net/qemu/+bug/1912780/+nominate">Nominate for series</a>
    
  

</div>




      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>[via qemu-security list]</p>
<p>This is Gaoning Pan from Zhejiang University &amp; Ant Security Light-Year Lab.<br />
I found a Null Pointer issue locates in fdctrl_read() in  hw/block/fdc.c.<br />
This flaw allows a malicious guest user or process in a denial of service condition.</p>
<p>This issus was discovered in the latest Qemu-5.2.0. When using floppy device, there are several<br />
choices to get specific drive in get_drv(), depending on fdctrl-&gt;cur_drv. But not all drives are<br />
initialized properly, leaving fdctrl-<wbr />&gt;drives[<wbr />0]-&gt;blk as NULL. So when the drive was used in<br />
blk_pread(<wbr />cur_drv-<wbr />&gt;blk, fd_offset(cur_drv), fdctrl-&gt;fifo, BDRV_SECTOR_SIZE) at line 1918,<br />
null pointer access triggers, thus denial of service.My reproduced environment is as follows:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Host: ubuntu 18.04<br />
&nbsp;&nbsp;&nbsp;&nbsp;Guest: ubuntu 18.04</p>
<p>My boot command is as follows:</p>
<p>&nbsp;&nbsp;qemu-<wbr />system-<wbr />x86_64 -enable-kvm -boot c -m 2G -drive format=<wbr />qcow2,file=<wbr />./ubuntu.<wbr />img \<br />
&nbsp;&nbsp;&nbsp;-nic user,hostfwd=<wbr />tcp:0.0.<wbr />0.0:5555-<wbr />:22 -device floppy,<wbr />unit=1,<wbr />drive=mydrive \<br />
&nbsp;&nbsp;&nbsp;-drive id=mydrive,<wbr />file=null-<wbr />co://,size=<wbr />2M,format=<wbr />raw,if=<wbr />none -display none</p>
<p>ASAN output is as follows:<br />
=======<wbr />=======<wbr />=======<wbr />=======<wbr />=======<wbr />=======<wbr />=======<wbr />=======<wbr />=======<wbr />==<br />
==14688==ERROR: AddressSanitizer: SEGV on unknown address 0x00000000034c (pc 0x5636eee9bbaf bp 0x7ff2a53fdea0 sp 0x7ff2a53fde90 T3)<br />
==14688==The signal is caused by a WRITE memory access.<br />
==14688==Hint: address points to the zero page.<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0 0x5636eee9bbae in blk_inc_in_flight ../block/<wbr />block-backend.<wbr />c:1356<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1 0x5636eee9b766 in blk_prw ../block/<wbr />block-backend.<wbr />c:1328<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2 0x5636eee9cd76 in blk_pread ../block/<wbr />block-backend.<wbr />c:1491<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3 0x5636ee1adf24 in fdctrl_read_data ../hw/block/<wbr />fdc.c:1918<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4 0x5636ee1a6654 in fdctrl_read ../hw/block/<wbr />fdc.c:935<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5 0x5636eebb84c8 in portio_read ../softmmu/<wbr />ioport.<wbr />c:179<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6 0x5636ee9848c5 in memory_<wbr />region_<wbr />read_accessor ../softmmu/<wbr />memory.<wbr />c:442<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7 0x5636ee9855c2 in access_<wbr />with_adjusted_<wbr />size ../softmmu/<wbr />memory.<wbr />c:552<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8 0x5636ee98f0b7 in memory_<wbr />region_<wbr />dispatch_<wbr />read1 ../softmmu/<wbr />memory.<wbr />c:1420<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9 0x5636ee98f311 in memory_<wbr />region_<wbr />dispatch_<wbr />read ../softmmu/<wbr />memory.<wbr />c:1449<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10 0x5636ee8ff64a in flatview_<wbr />read_continue ../softmmu/<wbr />physmem.<wbr />c:2822<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11 0x5636ee8ff9e5 in flatview_read ../softmmu/<wbr />physmem.<wbr />c:2862<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12 0x5636ee8ffb83 in address_<wbr />space_read_<wbr />full ../softmmu/<wbr />physmem.<wbr />c:2875<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13 0x5636ee8ffdeb in address_space_rw ../softmmu/<wbr />physmem.<wbr />c:2903<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14 0x5636eea6a924 in kvm_handle_io ../accel/<wbr />kvm/kvm-<wbr />all.c:2285<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15 0x5636eea6c5e3 in kvm_cpu_exec ../accel/<wbr />kvm/kvm-<wbr />all.c:2531<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16 0x5636eeca492b in kvm_vcpu_thread_fn ../accel/<wbr />kvm/kvm-<wbr />cpus.c:<wbr />49<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17 0x5636ef1bc296 in qemu_thread_start ../util/<wbr />qemu-thread-<wbr />posix.c:<wbr />521<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18 0x7ff337c736da in start_thread (/lib/x86_<wbr />64-linux-<wbr />gnu/libpthread.<wbr />so.0+0x76da)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#19 0x7ff33799ca3e in __clone (/lib/x86_<wbr />64-linux-<wbr />gnu/libc.<wbr />so.6+0x121a3e)</p>
<p>AddressSanitizer can not provide additional info.<br />
SUMMARY: AddressSanitizer: SEGV ../block/<wbr />block-backend.<wbr />c:1356 in blk_inc_in_flight<br />
Thread T3 created by T0 here:<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0 0x7ff33c580d2f in __interceptor_<wbr />pthread_<wbr />create (/usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />libasan.<wbr />so.4+0x37d2f)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1 0x5636ef1bc673 in qemu_thread_create ../util/<wbr />qemu-thread-<wbr />posix.c:<wbr />558<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2 0x5636eeca4ce7 in kvm_start_<wbr />vcpu_thread ../accel/<wbr />kvm/kvm-<wbr />cpus.c:<wbr />73<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3 0x5636ee9aa965 in qemu_init_vcpu ../softmmu/<wbr />cpus.c:<wbr />622<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4 0x5636ee82a9b4 in x86_cpu_realizefn ../target/<wbr />i386/cpu.<wbr />c:6731<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5 0x5636eed002f4 in device_set_realized ../hw/core/<wbr />qdev.c:<wbr />886<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6 0x5636eecc59bc in property_set_bool ../qom/<wbr />object.<wbr />c:2251<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7 0x5636eecc0c28 in object_property_set ../qom/<wbr />object.<wbr />c:1398<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8 0x5636eecb6fb9 in object_<wbr />property_<wbr />set_qobject ../qom/<wbr />qom-qobject.<wbr />c:28<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9 0x5636eecc1175 in object_<wbr />property_<wbr />set_bool ../qom/<wbr />object.<wbr />c:1465<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10 0x5636eecfc286 in qdev_realize ../hw/core/<wbr />qdev.c:<wbr />399<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11 0x5636ee739b34 in x86_cpu_new ../hw/i386/<wbr />x86.c:111<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12 0x5636ee739d6d in x86_cpus_init ../hw/i386/<wbr />x86.c:138<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13 0x5636ee6f843e in pc_init1 ../hw/i386/<wbr />pc_piix.<wbr />c:159<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14 0x5636ee6fab1e in pc_init_v5_2 ../hw/i386/<wbr />pc_piix.<wbr />c:438<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15 0x5636ee1cb4a7 in machine_<wbr />run_board_<wbr />init ../hw/core/<wbr />machine.<wbr />c:1134<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16 0x5636ee9c323d in qemu_init ../softmmu/<wbr />vl.c:4369<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17 0x5636edd92c71 in main ../softmmu/<wbr />main.c:<wbr />49<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18 0x7ff33789cb96 in __libc_start_main (/lib/x86_<wbr />64-linux-<wbr />gnu/libc.<wbr />so.6+0x21b96)</p>
<p>==14688==ABORTING</p>
<p>Reproducer is attached.</p>
<p>Best regards.<br />
Gaoning Pan of Zhejiang University &amp; Ant Security Light-Year Lab</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            Tags:
          </span>
          <span id="tag-list">
            <a class="unofficial-tag" href="/qemu/+bugs?field.tag=cve">cve</a>
            <a class="unofficial-tag" href="/qemu/+bugs?field.tag=security">security</a>
          </span>
          
          <a href="+edit" title="Edit tags" id="tags-trigger" class="sprite edit action-icon">Edit</a>
          <a href="/+help-bugs/tag-help.html" target="help" class="sprite maybe action-icon">Tag help</a>
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        <div class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve">
              <a href="/bugs/cve/2021-20196" title="A NULL pointer dereference flaw was f...">2021-20196</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-01-22T12:37:06.579963+00:00" title="2021-01-22 12:37:06 UTC">on 2021-01-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a class="sprite download-icon" href="https://bugs.launchpad.net/qemu/+bug/1912780/+attachment/5455646/+files/fdc.c">Reproducer</a>
        <a class="sprite edit action-icon" href="/qemu/+bug/1912780/+attachment/5455646">Edit</a>
        (523 bytes,
        text/x-csrc)
      </li>
    </ul>

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10"></textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-01-22T12:44:50.507095+00:00" title="2021-01-22 12:44:50 UTC">on 2021-01-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>The given reproducer does not seem to work as expected to trigger this issue.<br />
IIUC, issue occurs because a privileged guest user may change the selected<br />
floppy drive via FD_REG_<wbr />DOR:fdctrl_<wbr />write_dor(<wbr />) ioport write command</p>
<p>&nbsp;&nbsp;static void fdctrl_<wbr />write_dor(<wbr />FDCtrl *fdctrl, uint32_t value)<br />
&nbsp;&nbsp;{<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Selected drive */<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdctrl-<wbr />&gt;cur_drv = value &amp; FD_DOR_SELMASK;  &lt;= selected drive changes based on &#x27;value&#x27;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br />
&nbsp;&nbsp;}</p>
<p>Little tweaking of parameters under gdb reproduces the crash</p>
<p>$ gdb --args ./bin/qemu-<wbr />system-<wbr />x86_64 -runas test -nographic -enable-kvm -m 2048<br />
&nbsp;&nbsp;&nbsp;-drive file=fdc.<wbr />img,format=<wbr />qcow2,if=<wbr />floppy,<wbr />id=myfdc /var/lib/<wbr />libvirt/<wbr />images/<wbr />f27vm.qcow2<br />
...<br />
==541702==ERROR: AddressSanitizer: SEGV on unknown address 0x00000000034c (pc 0x55555938377f bp 0x7fff6f3fdeb0 sp 0x7fff6f3fdea0 T3)<br />
==541702==The signal is caused by a WRITE memory access.<br />
==541702==Hint: address points to the zero page.<br />
&nbsp;&nbsp;&nbsp;&nbsp;#0 0x55555938377f in blk_inc_in_flight ../block/<wbr />block-backend.<wbr />c:1356<br />
&nbsp;&nbsp;&nbsp;&nbsp;#1 0x55555938325b in blk_prw ../block/<wbr />block-backend.<wbr />c:1328<br />
&nbsp;&nbsp;&nbsp;&nbsp;#2 0x555559384ec5 in blk_pread ../block/<wbr />block-backend.<wbr />c:1491<br />
&nbsp;&nbsp;&nbsp;&nbsp;#3 0x555557d7c798 in fdctrl_read_data ../hw/block/<wbr />fdc.c:1919<br />
&nbsp;&nbsp;&nbsp;&nbsp;#4 0x555557d7207c in fdctrl_read ../hw/block/<wbr />fdc.c:936<br />
&nbsp;&nbsp;&nbsp;&nbsp;#5 0x555558ee7c40 in portio_read ../softmmu/<wbr />ioport.<wbr />c:179<br />
&nbsp;&nbsp;&nbsp;&nbsp;#6 0x555558c9a0c1 in memory_<wbr />region_<wbr />read_accessor ../softmmu/<wbr />memory.<wbr />c:442<br />
&nbsp;&nbsp;&nbsp;&nbsp;#7 0x555558c9af04 in access_<wbr />with_adjusted_<wbr />size ../softmmu/<wbr />memory.<wbr />c:552<br />
&nbsp;&nbsp;&nbsp;&nbsp;#8 0x555558ca7159 in memory_<wbr />region_<wbr />dispatch_<wbr />read1 ../softmmu/<wbr />memory.<wbr />c:1420<br />
&nbsp;&nbsp;&nbsp;&nbsp;#9 0x555558ca7433 in memory_<wbr />region_<wbr />dispatch_<wbr />read ../softmmu/<wbr />memory.<wbr />c:1449<br />
&nbsp;&nbsp;&nbsp;&nbsp;#10 0x555558f6214e in flatview_<wbr />read_continue ../softmmu/<wbr />physmem.<wbr />c:2822<br />
&nbsp;&nbsp;&nbsp;&nbsp;#11 0x555558f62560 in flatview_read ../softmmu/<wbr />physmem.<wbr />c:2862<br />
&nbsp;&nbsp;&nbsp;&nbsp;#12 0x555558f62700 in address_<wbr />space_read_<wbr />full ../softmmu/<wbr />physmem.<wbr />c:2875<br />
&nbsp;&nbsp;&nbsp;&nbsp;#13 0x555558f62977 in address_space_rw ../softmmu/<wbr />physmem.<wbr />c:2903<br />
&nbsp;&nbsp;&nbsp;&nbsp;#14 0x555558d037b9 in kvm_handle_io ../accel/<wbr />kvm/kvm-<wbr />all.c:2285<br />
&nbsp;&nbsp;&nbsp;&nbsp;#15 0x555558d05a4b in kvm_cpu_exec ../accel/<wbr />kvm/kvm-<wbr />all.c:2531<br />
&nbsp;&nbsp;&nbsp;&nbsp;#16 0x555558ee0efa in kvm_vcpu_thread_fn ../accel/<wbr />kvm/kvm-<wbr />cpus.c:<wbr />49<br />
&nbsp;&nbsp;&nbsp;&nbsp;#17 0x55555977ec18 in qemu_thread_start ../util/<wbr />qemu-thread-<wbr />posix.c:<wbr />521<br />
&nbsp;&nbsp;&nbsp;&nbsp;#18 0x7ffff63323f8 in start_thread (/lib64/<wbr />libpthread.<wbr />so.0+0x93f8)<br />
&nbsp;&nbsp;&nbsp;&nbsp;#19 0x7ffff625f902 in __GI___clone (/lib64/<wbr />libc.so.<wbr />6+0x101902)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">The given reproducer does not seem to work as expected to trigger this issue.
IIUC, issue occurs because a privileged guest user may change the selected
floppy drive via FD_REG_DOR:fdctrl_write_dor() ioport write command

  static void fdctrl_write_dor(FDCtrl *fdctrl, uint32_t value)                    
  {
      ...
      /* Selected drive */ 
      fdctrl-&gt;cur_drv = value &amp; FD_DOR_SELMASK;  &lt;= selected drive changes based on 'value'
      ...
  }

Little tweaking of parameters under gdb reproduces the crash

$ gdb --args ./bin/qemu-system-x86_64 -runas test -nographic -enable-kvm -m 2048
   -drive file=fdc.img,format=qcow2,if=floppy,id=myfdc /var/lib/libvirt/images/f27vm.qcow2
...
==541702==ERROR: AddressSanitizer: SEGV on unknown address 0x00000000034c (pc 0x55555938377f bp 0x7fff6f3fdeb0 sp 0x7fff6f3fdea0 T3)
==541702==The signal is caused by a WRITE memory access.
==541702==Hint: address points to the zero page.
    #0 0x55555938377f in blk_inc_in_flight ../block/block-backend.c:1356
    #1 0x55555938325b in blk_prw ../block/block-backend.c:1328
    #2 0x555559384ec5 in blk_pread ../block/block-backend.c:1491
    #3 0x555557d7c798 in fdctrl_read_data ../hw/block/fdc.c:1919
    #4 0x555557d7207c in fdctrl_read ../hw/block/fdc.c:936
    #5 0x555558ee7c40 in portio_read ../softmmu/ioport.c:179
    #6 0x555558c9a0c1 in memory_region_read_accessor ../softmmu/memory.c:442
    #7 0x555558c9af04 in access_with_adjusted_size ../softmmu/memory.c:552
    #8 0x555558ca7159 in memory_region_dispatch_read1 ../softmmu/memory.c:1420
    #9 0x555558ca7433 in memory_region_dispatch_read ../softmmu/memory.c:1449
    #10 0x555558f6214e in flatview_read_continue ../softmmu/physmem.c:2822
    #11 0x555558f62560 in flatview_read ../softmmu/physmem.c:2862
    #12 0x555558f62700 in address_space_read_full ../softmmu/physmem.c:2875
    #13 0x555558f62977 in address_space_rw ../softmmu/physmem.c:2903
    #14 0x555558d037b9 in kvm_handle_io ../accel/kvm/kvm-all.c:2285
    #15 0x555558d05a4b in kvm_cpu_exec ../accel/kvm/kvm-all.c:2531
    #16 0x555558ee0efa in kvm_vcpu_thread_fn ../accel/kvm/kvm-cpus.c:49
    #17 0x55555977ec18 in qemu_thread_start ../util/qemu-thread-posix.c:521
    #18 0x7ffff63323f8 in start_thread (/lib64/libpthread.so.0+0x93f8)
    #19 0x7ffff625f902 in __GI___clone (/lib64/libc.so.6+0x101902)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-01-22T12:46:14.411872+00:00" title="2021-01-22 12:46:14 UTC">on 2021-01-22</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Proposed patch:</p>
<p>$ git diff hw/block/<br />
diff --git a/hw/block/fdc.c b/hw/block/fdc.c<br />
index 3636874432.<wbr />.13a9470d19 100644<br />
--- a/hw/block/fdc.c<br />
+++ b/hw/block/fdc.c<br />
@@ -1429,7 +1429,9 @@ static void fdctrl_<wbr />write_dor(<wbr />FDCtrl *fdctrl, uint32_t value)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Selected drive */<br />
-    fdctrl-&gt;cur_drv = value &amp; FD_DOR_SELMASK;<br />
+    if (fdctrl-<wbr />&gt;drives[<wbr />value &amp; FD_DOR_<wbr />SELMASK]<wbr />.blk) {<br />
+        fdctrl-&gt;cur_drv = value &amp; FD_DOR_SELMASK;<br />
+    }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdctrl-&gt;dor = value;<br />
&nbsp;}<br />
@@ -1894,6 +1896,10 @@ static uint32_t fdctrl_<wbr />read_data(<wbr />FDCtrl *fdctrl)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t pos;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur_drv = get_cur_<wbr />drv(fdctrl)<wbr />;<br />
+    if (!cur_drv-&gt;blk) {<br />
+        FLOPPY_DPRINTF(&quot;No drive connected\n&quot;);<br />
+        return 0;<br />
+    }<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdctrl-&gt;dsr &amp;= ~FD_DSR_PWRDOWN;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!(fdctrl-&gt;msr &amp; FD_MSR_RQM) || !(fdctrl-&gt;msr &amp; FD_MSR_DIO)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;FLOPPY_<wbr />DPRINTF(<wbr />&quot;error: controller not ready for reading\n&quot;);<br />
@@ -2420,7 +2426,8 @@ static void fdctrl_<wbr />write_data(<wbr />FDCtrl *fdctrl, uint32_t value)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pos == FD_SECTOR_LEN - 1 ||<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdctrl-<wbr />&gt;data_pos == fdctrl-&gt;data_len) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur_<wbr />drv = get_cur_<wbr />drv(fdctrl)<wbr />;<br />
-            if (blk_pwrite(<wbr />cur_drv-<wbr />&gt;blk, fd_offset(cur_drv), fdctrl-&gt;fifo,<br />
+            if (cur_drv-&gt;blk == NULL<br />
+                || blk_pwrite(<wbr />cur_drv-<wbr />&gt;blk, fd_offset(cur_drv), fdctrl-&gt;fifo,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />BDRV_SECTOR_<wbr />SIZE, 0) &lt; 0) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;FLOPPY_<wbr />DPRINTF(<wbr />&quot;error writing sector %d\n&quot;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;fd_<wbr />sector(<wbr />cur_drv)<wbr />);</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Proposed patch:

$ git diff hw/block/
diff --git a/hw/block/fdc.c b/hw/block/fdc.c
index 3636874432..13a9470d19 100644
--- a/hw/block/fdc.c
+++ b/hw/block/fdc.c
@@ -1429,7 +1429,9 @@ static void fdctrl_write_dor(FDCtrl *fdctrl, uint32_t value)
         }
     }
     /* Selected drive */
-    fdctrl-&gt;cur_drv = value &amp; FD_DOR_SELMASK;
+    if (fdctrl-&gt;drives[value &amp; FD_DOR_SELMASK].blk) {
+        fdctrl-&gt;cur_drv = value &amp; FD_DOR_SELMASK;
+    }
 
     fdctrl-&gt;dor = value;
 }
@@ -1894,6 +1896,10 @@ static uint32_t fdctrl_read_data(FDCtrl *fdctrl)
     uint32_t pos;
 
     cur_drv = get_cur_drv(fdctrl);
+    if (!cur_drv-&gt;blk) {
+        FLOPPY_DPRINTF("No drive connected\n");
+        return 0;
+    }
     fdctrl-&gt;dsr &amp;= ~FD_DSR_PWRDOWN;
     if (!(fdctrl-&gt;msr &amp; FD_MSR_RQM) || !(fdctrl-&gt;msr &amp; FD_MSR_DIO)) {
         FLOPPY_DPRINTF("error: controller not ready for reading\n");
@@ -2420,7 +2426,8 @@ static void fdctrl_write_data(FDCtrl *fdctrl, uint32_t value)
         if (pos == FD_SECTOR_LEN - 1 ||
             fdctrl-&gt;data_pos == fdctrl-&gt;data_len) {
             cur_drv = get_cur_drv(fdctrl);
-            if (blk_pwrite(cur_drv-&gt;blk, fd_offset(cur_drv), fdctrl-&gt;fifo,
+            if (cur_drv-&gt;blk == NULL
+                || blk_pwrite(cur_drv-&gt;blk, fd_offset(cur_drv), fdctrl-&gt;fifo,
                            BDRV_SECTOR_SIZE, 0) &lt; 0) {
                 FLOPPY_DPRINTF("error writing sector %d\n",
                                fd_sector(cur_drv));</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-01-23T09:16:10.949676+00:00" title="2021-01-23 09:16:10 UTC">on 2021-01-23</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On Friday, 22 January, 2021, 05:42:55 pm IST, 潘高宁 &lt;email address hidden&gt; wrote:<br />
<span class="foldable-quoted">
&gt;  This patch seems to work now. I&#x27;ve re-compiled and tested the QEMU, which showed the functional operation was working well.
</span></p>
<p>CVE-2021-20196 assigned by Red Hat Inc.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On Friday, 22 January, 2021, 05:42:55 pm IST, 潘高宁 &lt;pgn@zju.edu.cn&gt; wrote: 
&gt;  This patch seems to work now. I've re-compiled and tested the QEMU, which showed the functional operation was working well.


CVE-2021-20196 assigned by Red Hat Inc.
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~pjps" class="sprite person">P J P (pjps)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-01-23T11:24:30.185277+00:00" title="2021-01-23 11:24:30 UTC">on 2021-01-23</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Upstream patch:<br />
&nbsp;&nbsp;-&gt; <a rel="nofollow" href="https://lists.nongnu.org/archive/html/qemu-devel/2021-01/msg05986.html">https:/<wbr />/lists.<wbr />nongnu.<wbr />org/archive/<wbr />html/qemu-<wbr />devel/2021-<wbr />01/msg05986.<wbr />html</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Upstream patch:
  -&gt; https://lists.nongnu.org/archive/html/qemu-devel/2021-01/msg05986.html</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Private Security &#8594; Public Security
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~th-huth" class="sprite person">Thomas Huth (th-huth)</a>
    
    <time title="2021-05-14 19:24:11 UTC" datetime="2021-05-14T19:24:11.152715+00:00">on 2021-05-14</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in qemu: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; In Progress
      </td>
    </tr>
    <tr>
      <td style="text-align: right;">
        <b>importance</b>:
      </td>
      <td>
        Undecided &#8594; High
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~jnsnow" class="sprite person">John Snow (jnsnow)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-05-17T22:42:25.104832+00:00" title="2021-05-17 22:42:25 UTC">on 2021-05-17</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Took a look at the patch today, I think it might need a change or two but it should be quick to do. I&#x27;ve asked Thomas to move this issue to gitlab so I can keep a closer eye on it.</p>
<p>--js</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Took a look at the patch today, I think it might need a change or two but it should be quick to do. I've asked Thomas to move this issue to gitlab so I can keep a closer eye on it.

--js</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/qemu/+bug/1912780/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~th-huth" class="sprite person">Thomas Huth (th-huth)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-05-18T04:41:43.759162+00:00" title="2021-05-18 04:41:43 UTC">on 2021-05-18</time><span class="editable-message-last-edit-date">:
              </span>
              <a href="/qemu/+bug/1912780/comments/7">
                <strong>Moved bug report</strong>
              </a>
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/qemu/+bug/1912780/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This is an automated cleanup. This bug report has been moved to QEMU&#x27;s<br />
new bug tracker on gitlab.com and thus gets marked as &#x27;expired&#x27; now.<br />
Please continue with the discussion here:</p>
<p>&nbsp;<a rel="nofollow" href="https://gitlab.com/qemu-project/qemu/-/issues/338">https:/<wbr />/gitlab.<wbr />com/qemu-<wbr />project/<wbr />qemu/-/<wbr />issues/<wbr />338</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">
This is an automated cleanup. This bug report has been moved to QEMU's
new bug tracker on gitlab.com and thus gets marked as 'expired' now.
Please continue with the discussion here:

 https://gitlab.com/qemu-project/qemu/-/issues/338
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in qemu: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        In Progress &#8594; Expired
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/qemu/+bug/1912780/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/qemu/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public Security</strong>
         information
     </span>&nbsp;<a class="sprite edit action-icon" id="privacy-link" href="/qemu/+bug/1912780/+secrecy">Edit</a>

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this security related information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    <li class="sprite bug-dupe">
    <span id="mark-duplicate-text">
    <a class="menu-link-mark-dupe" href="/qemu/+bug/1912780/+duplicate">Mark as duplicate</a>
    </span>
    </li>
    
    <li><a class="menu-link-createquestion sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+create-question">Convert to a question</a></li>
    
    <li><a class="menu-link-addbranch sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+addbranch">Link a related branch</a></li>
    <li><a class="menu-link-linktocve sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+linkcve">Link to <abbr title="Common Vulnerabilities and Exposures Index">CVE</abbr></a></li>
    <li><a class="menu-link-unlinkcve sprite modify remove" href="https://bugs.launchpad.net/qemu/+bug/1912780/+unlinkcve">Remove CVE link</a></li>
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/qemu/+bug/1912780/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/qemu/+bug/1912780/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/qemu/+bug/1912780/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  
  <div class="portlet" id="portlet-attachments">
    <h2>Bug attachments</h2>
    <ul>
      <li class="download-attachment">
        <a class="sprite download-icon" href="https://bugs.launchpad.net/qemu/+bug/1912780/+attachment/5455646/+files/fdc.c">Reproducer</a>
        <small>
          (<a href="/qemu/+bug/1912780/+attachment/5455646">edit</a>)
        </small>
      </li>
    </ul>
    <ul>
      <li>
        <a class="sprite add" href="/qemu/+bug/1912780/+addcomment">Add attachment</a>
      </li>
    </ul>
  </div>


      <div class="portlet" id="portlet-watches">
  <h2>Remote bug watches</h2>
  <ul>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://gitlab.com/qemu-project/qemu/-/issues/338">auto-gitlab.com-qemu-project-qemu-- #338</a>
      <a class="sprite edit action-icon" title="Change watch details" href="/bugs/1912780/+watch/143004">Edit</a>
    </li>
  </ul>
  <p>Bug watches keep track of this bug in other bug trackers.</p>
</div>

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"subscribers_portlet_url_data": {"web_link": "https://bugs.launchpad.net/bugs/1912780", "self_link": "https://bugs.launchpad.net/api/devel/bugs/1912780"}, "information_type_data": {"PUBLIC": {"description": "Everyone can see this information.\n", "name": "Public", "is_private": false, "order": 0, "description_css_class": "choice-description", "value": "PUBLIC"}, "PUBLICSECURITY": {"description": "Everyone can see this security related information.\n", "name": "Public Security", "is_private": false, "order": 1, "description_css_class": "choice-description", "value": "PUBLICSECURITY"}, "USERDATA": {"description": "Only shared with users permitted to see private user information.\n", "name": "Private", "is_private": true, "order": 3, "description_css_class": "choice-description", "value": "USERDATA"}, "PRIVATESECURITY": {"description": "Only the security group can see this information.\n ", "name": "Private Security", "is_private": true, "order": 2, "description_css_class": "choice-description", "value": "PRIVATESECURITY"}}, "total_comments_and_activity": 15, "bug_is_private": false, "related_features": {}, "first visible_recent_comment": -33, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1912780", "web_link": "https://bugs.launchpad.net/bugs/1912780", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 1912780, "private": false, "information_type": "Public Security", "name": null, "title": "QEMU: Null Pointer Failure in fdctrl_read() in hw/block/fdc.c", "description": "[via qemu-security list]\n\nThis is Gaoning Pan from Zhejiang University \u0026 Ant Security Light-Year Lab.\nI found a Null Pointer issue locates in fdctrl_read() in  hw/block/fdc.c.\nThis flaw allows a malicious guest user or process in a denial of service condition.\n\nThis issus was discovered in the latest Qemu-5.2.0. When using floppy device, there are several\nchoices to get specific drive in get_drv(), depending on fdctrl-\u003ecur_drv. But not all drives are\ninitialized properly, leaving fdctrl-\u003edrives[0]-\u003eblk as NULL. So when the drive was used in\nblk_pread(cur_drv-\u003eblk, fd_offset(cur_drv), fdctrl-\u003efifo, BDRV_SECTOR_SIZE) at line 1918,\nnull pointer access triggers, thus denial of service.My reproduced environment is as follows:\n\n    Host: ubuntu 18.04\n    Guest: ubuntu 18.04\n\nMy boot command is as follows:\n\n  qemu-system-x86_64 -enable-kvm -boot c -m 2G -drive format=qcow2,file=./ubuntu.img \\\n   -nic user,hostfwd=tcp:0.0.0.0:5555-:22 -device floppy,unit=1,drive=mydrive \\\n   -drive id=mydrive,file=null-co://,size=2M,format=raw,if=none -display none\n\nASAN output is as follows:\n=================================================================\n==14688==ERROR: AddressSanitizer: SEGV on unknown address 0x00000000034c (pc 0x5636eee9bbaf bp 0x7ff2a53fdea0 sp 0x7ff2a53fde90 T3)\n==14688==The signal is caused by a WRITE memory access.\n==14688==Hint: address points to the zero page.\n    #0 0x5636eee9bbae in blk_inc_in_flight ../block/block-backend.c:1356\n    #1 0x5636eee9b766 in blk_prw ../block/block-backend.c:1328\n    #2 0x5636eee9cd76 in blk_pread ../block/block-backend.c:1491\n    #3 0x5636ee1adf24 in fdctrl_read_data ../hw/block/fdc.c:1918\n    #4 0x5636ee1a6654 in fdctrl_read ../hw/block/fdc.c:935\n    #5 0x5636eebb84c8 in portio_read ../softmmu/ioport.c:179\n    #6 0x5636ee9848c5 in memory_region_read_accessor ../softmmu/memory.c:442\n    #7 0x5636ee9855c2 in access_with_adjusted_size ../softmmu/memory.c:552\n    #8 0x5636ee98f0b7 in memory_region_dispatch_read1 ../softmmu/memory.c:1420\n    #9 0x5636ee98f311 in memory_region_dispatch_read ../softmmu/memory.c:1449\n    #10 0x5636ee8ff64a in flatview_read_continue ../softmmu/physmem.c:2822\n    #11 0x5636ee8ff9e5 in flatview_read ../softmmu/physmem.c:2862\n    #12 0x5636ee8ffb83 in address_space_read_full ../softmmu/physmem.c:2875\n    #13 0x5636ee8ffdeb in address_space_rw ../softmmu/physmem.c:2903\n    #14 0x5636eea6a924 in kvm_handle_io ../accel/kvm/kvm-all.c:2285\n    #15 0x5636eea6c5e3 in kvm_cpu_exec ../accel/kvm/kvm-all.c:2531\n    #16 0x5636eeca492b in kvm_vcpu_thread_fn ../accel/kvm/kvm-cpus.c:49\n    #17 0x5636ef1bc296 in qemu_thread_start ../util/qemu-thread-posix.c:521\n    #18 0x7ff337c736da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\n    #19 0x7ff33799ca3e in __clone (/lib/x86_64-linux-gnu/libc.so.6+0x121a3e)\n\nAddressSanitizer can not provide additional info.\nSUMMARY: AddressSanitizer: SEGV ../block/block-backend.c:1356 in blk_inc_in_flight\nThread T3 created by T0 here:\n    #0 0x7ff33c580d2f in __interceptor_pthread_create (/usr/lib/x86_64-linux-gnu/libasan.so.4+0x37d2f)\n    #1 0x5636ef1bc673 in qemu_thread_create ../util/qemu-thread-posix.c:558\n    #2 0x5636eeca4ce7 in kvm_start_vcpu_thread ../accel/kvm/kvm-cpus.c:73\n    #3 0x5636ee9aa965 in qemu_init_vcpu ../softmmu/cpus.c:622\n    #4 0x5636ee82a9b4 in x86_cpu_realizefn ../target/i386/cpu.c:6731\n    #5 0x5636eed002f4 in device_set_realized ../hw/core/qdev.c:886\n    #6 0x5636eecc59bc in property_set_bool ../qom/object.c:2251\n    #7 0x5636eecc0c28 in object_property_set ../qom/object.c:1398\n    #8 0x5636eecb6fb9 in object_property_set_qobject ../qom/qom-qobject.c:28\n    #9 0x5636eecc1175 in object_property_set_bool ../qom/object.c:1465\n    #10 0x5636eecfc286 in qdev_realize ../hw/core/qdev.c:399\n    #11 0x5636ee739b34 in x86_cpu_new ../hw/i386/x86.c:111\n    #12 0x5636ee739d6d in x86_cpus_init ../hw/i386/x86.c:138\n    #13 0x5636ee6f843e in pc_init1 ../hw/i386/pc_piix.c:159\n    #14 0x5636ee6fab1e in pc_init_v5_2 ../hw/i386/pc_piix.c:438\n    #15 0x5636ee1cb4a7 in machine_run_board_init ../hw/core/machine.c:1134\n    #16 0x5636ee9c323d in qemu_init ../softmmu/vl.c:4369\n    #17 0x5636edd92c71 in main ../softmmu/main.c:49\n    #18 0x7ff33789cb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\n\n==14688==ABORTING\n\nReproducer is attached.\n\nBest regards.\nGaoning Pan of Zhejiang University \u0026 Ant Security Light-Year Lab", "owner_link": "https://bugs.launchpad.net/api/devel/~pjps", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/bug_tasks", "duplicate_of_link": null, "date_created": "2021-01-22T12:37:06.579963+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/subscriptions", "date_last_updated": "2021-05-18T04:41:44.447670+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 258, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/cves", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/attachments", "security_related": true, "latest_patch_uploaded": null, "tags": ["cve", "security"], "date_last_message": "2021-05-18T04:41:43.759162+00:00", "number_of_duplicates": 0, "message_count": 8, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/messages", "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1912780/linked_merge_proposals", "http_etag": "\"9934378e6cdee3f882e979baa1552f086ae61683-1f9d22ea5edc99ca694185095bd16870b363a5dd\""}, "bugtask_data": {"2676750": {"assignee_vocabulary": "AllUserTeamsParticipation", "user_can_unassign": false, "bugtask_path": "/qemu/+bug/1912780", "assignee_value": null, "user_can_edit_status": true, "bug_title": "QEMU: Null Pointer Failure in fdctrl_read() in hw/block/fdc.c", "user_can_edit_milestone": false, "prefix": "qemu", "form_row_id": "task2676750", "target_is_product": true, "user_can_edit_importance": false, "assignee_is_team": null, "delete_link": "https://bugs.launchpad.net/qemu/+bug/1912780/+delete", "user_can_edit_assignee": false, "milestone_widget_items": "[]", "status_widget_items": "[]", "status_value": "Expired", "importance_value": "High", "hide_assignee_team_selection": true, "user_can_delete": false, "row_id": "tasksummary2676750", "assignee_vocabulary_filters": [], "targetname": "QEMU", "importance_widget_items": "[]", "milestone_value": null, "id": 2676750}}, "context": {"self_link": "https://bugs.launchpad.net/api/devel/qemu/+bug/1912780", "web_link": "https://bugs.launchpad.net/qemu/+bug/1912780", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/1912780", "milestone_link": null, "status": "Expired", "importance": "High", "assignee_link": null, "bug_target_display_name": "QEMU", "bug_target_name": "qemu", "bug_watch_link": null, "date_assigned": null, "date_created": "2021-01-22T12:37:06.579963+00:00", "date_confirmed": null, "date_incomplete": null, "date_in_progress": null, "date_closed": "2021-05-18T04:41:42.807153+00:00", "date_left_new": "2021-05-14T19:24:11.560806+00:00", "date_triaged": null, "date_fix_committed": null, "date_fix_released": null, "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~pjps", "target_link": "https://bugs.launchpad.net/api/devel/qemu", "title": "Bug #1912780 in QEMU: \"QEMU: Null Pointer Failure in fdctrl_read() in hw/block/fdc.c\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/qemu/+bug/1912780/related_tasks", "is_complete": true, "http_etag": "\"5debf67ca21c2d345d2d011034a4b036a450b8ec-94c27c1412ebce4a1a875f14d94b40fb69c0b3ea\""}, "initial_comment_batch_offset": 41};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 59 queries/external actions issued in 0.87 seconds

    Features: {'app.maintenance_message': None, 'visible_render_time': None, 'bugs.affected_count_includes_dupes.disabled': None, 'app.mainsite_only.canonical_url': None, 'disclosure.dsp_picker.enabled': 'on', 'bugs.nominations.bug_supervisors_can_target': 'on', 'baselayout.careers_link.disabled': None, 'hard_timeout': '9000', 'js.yui_version': None, 'profiling.enabled': None}

    r0d8de2b

    -->

</html>

