<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHP Language Specification Bug #69207 - RDF' href='rss/bug.php?id=69207'>
        <link rel='alternate' type='application/rss+xml' title='PHP Language Specification Bug #69207 - RSS 2.0' href='rss/bug.php?id=69207&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #69207 :: move_uploaded_file allows nulls in path</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=69207">Sec Bug</a>&nbsp;#69207</th>
            <td id="summary" colspan="5">move_uploaded_file allows nulls in path</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-03-09 17:35 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-03-31 05:45 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHP+Language+Specification">PHP Language Specification</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>Irrelevant</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-2348" target="_blank">2015-2348</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=69207&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=69207&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=69207&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1425922521">&nbsp;</a><strong>[2015-03-09 17:35 UTC] habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
with newer versions of PHP, we all taught Nullbytes issues were over. but there is still one simple bypass and I still have no clue why there is.



Test script:
---------------
move_uploaded_file($_FILES['x']['tmp_name'],&quot;/tmp/test.php\x00.jpg&quot;)

That file will create what you think it shouldn't!

Actual result:
--------------
I expect the fix of the next version to notice nullbytes and actually not ignore them this time.

Thanks!

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=69207'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=69207'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1425924763">&nbsp;</a><strong>[2015-03-09 18:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Could you please provide more information about what you think is the problem, what is the expected result and what is the actual result?
</pre>
</div><div class='comment type_comment' ><a name="1425925303">&nbsp;</a><strong>[2015-03-09 18:21 UTC] habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi, @stats

Sure. why not. the problem is that, the null byte is deprecated (I think to stop LFI... and similar attacks). Nullbytes are dangerous and thus, are not actually avilable since php 5.3.1, however, using \x00 it is still possible to use them.

say the script:

move_uploaded_file($_FILES['x']['tmp_name'],&quot;/tmp/test.php\x00.jpg&quot;)

Should actually have created /tmp/test.php\x00.jpg when in reality, it creates /tmp/test.php which should bypass .jpg extenssion checking scripts. I still don't know why this nullbyte works when the %00 is deprecated.

Anyway, I guess I have answered your question
</pre>
</div><div class='comment type_log' ><a name="1426621665">&nbsp;</a><strong>[2015-03-17 19:47 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: Nullbytes - The Come back</span>
<span class="added">+Summary: move_uploaded_file allows nulls in path</span>
</div></div></div><div class='comment type_log' ><a name="1426635591">&nbsp;</a><strong>[2015-03-17 23:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1426635591">&nbsp;</a><strong>[2015-03-17 23:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_svn' ><a name="1426655396">&nbsp;</a><strong>[2015-03-18 05:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=1291d6bbee93b6109eb07e8f7916ff1b7fcc13e1" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=1291d6bbee93b6109eb07e8f7916ff1b7fcc13e1</a>
Log: Fix <a href='bug.php?id=69207'>bug #69207</a> - move_uploaded_file allows nulls in path
</pre>
</div><div class='comment type_svn' ><a name="1426672026">&nbsp;</a><strong>[2015-03-18 09:47 UTC] <a href="//people.php.net/jpauli">jpauli@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=93b8970b3316cd5c557eae2f03d7efc39a9eae53" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=93b8970b3316cd5c557eae2f03d7efc39a9eae53</a>
Log: Fix <a href='bug.php?id=69207'>bug #69207</a> - move_uploaded_file allows nulls in path
</pre>
</div><div class='comment type_svn' ><a name="1426726815">&nbsp;</a><strong>[2015-03-19 01:00 UTC] <a href="//people.php.net/tyrael">tyrael@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=313ff116fa08918fb3949d51f17eb39d0b950962" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=313ff116fa08918fb3949d51f17eb39d0b950962</a>
Log: Fix <a href='bug.php?id=69207'>bug #69207</a> - move_uploaded_file allows nulls in path
</pre>
</div><div class='comment type_comment' ><a name="1426861551">&nbsp;</a><strong>[2015-03-20 14:25 UTC] habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi, Again.

This has been assigned with CVE-2015-2348. it will be published in mitre as soon as a fix is publicly available (if it hasn't already) 5.3.7, maybe?

This has been classified as remotely exploitable  modernate-critical issue following the reason(s):

- If you allow file uploads and you check them on extension, its very probable you pass the file using move_uploaded_file and thus causing an RCE.
- Checking on mime type, size, content header, extension... won't stop the exploit from passing as a valid file. consider the code <a href="https://github.com/RandomStorm/DVWA/blob/master/vulnerabilities/upload/source/high.php" rel="nofollow">https://github.com/RandomStorm/DVWA/blob/master/vulnerabilities/upload/source/high.php</a> that code is suppose to be a secure/unbreakable code for RCE. its the highest level of DVWA. many developers follow the same practice and I am sure no one still blacklists null-bytes.

Thanks for pushing a fix so fast! :)
</pre>
</div><div class='comment type_comment' ><a name="1426874272">&nbsp;</a><strong>[2015-03-20 17:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I'm not sure how you achieve remote exploit with this, unless you already have security vulnerability, such as allowing writing arbitrary remotely specified files or trusting extension supplied externally. Trusting remotely supplied extension is a grave security error as naturally you can be given any file under any extension, regardless of its contents. DWVA is an example of this error, but nobody should be actually writing such code if they want any security.
</pre>
</div><div class='comment type_comment' ><a name="1426874980">&nbsp;</a><strong>[2015-03-20 18:09 UTC] habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>&quot;... but nobody should be actually writing such code if they want any security.&quot;

Indeed. but most of the codes I audit have similar checks. extension &amp; mime checking, its how everybody does it. and I see no problems with it, (at-least to cause RCE) until this bug. I agree with you that this like you said won't happen if the name got randomized and explicitly moved to a custom extension.

But considering how many sites are out there with such vulnerabilities like the one in DVWA, this is remotely exploitable. but there is no use in debating while this issue has been fixed! :)

Thanks!
</pre>
</div><div class='comment type_comment' ><a name="1427702584">&nbsp;</a><strong>[2015-03-30 08:03 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>I can't validate the CVE you've mentioned. It does appear as assigned, but no details (or any PHP reference) although the fix is public for more than 10 days. I'm going to ignore it for now.
</pre>
</div><div class='comment type_comment' ><a name="1427703455">&nbsp;</a><strong>[2015-03-30 08:17 UTC] habte &#x64;&#111;&#x74; yibelo &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>@kaplan Yes I know. I have been trying to reach the CVE team for days. they haven't provided any public info just yet. I don't know what is wrong with them but I am hoping they will release public info soon.

Thanks!
</pre>
</div><div class='comment type_log' ><a name="1427780754">&nbsp;</a><strong>[2015-03-31 05:45 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-2348</span>
</div></div></div><div class='comment type_comment' ><a name="1427780754">&nbsp;</a><strong>[2015-03-31 05:45 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>Confirmed with <a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348" rel="nofollow">https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348</a>
</pre>
</div><div class='comment type_svn' ><a name="1469014755">&nbsp;</a><strong>[2016-07-20 11:39 UTC] <a href="//people.php.net/davey">davey@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=6632684e032e2a895c4fd6178c4bc3736d57e03c" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=6632684e032e2a895c4fd6178c4bc3736d57e03c</a>
Log: Fix <a href='bug.php?id=69207'>bug #69207</a> - move_uploaded_file allows nulls in path
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
