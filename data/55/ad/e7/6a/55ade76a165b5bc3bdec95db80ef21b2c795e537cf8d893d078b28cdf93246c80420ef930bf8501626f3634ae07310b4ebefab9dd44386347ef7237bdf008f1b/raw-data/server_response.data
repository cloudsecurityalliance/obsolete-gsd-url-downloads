<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #77973 - RDF' href='rss/bug.php?id=77973'>
        <link rel='alternate' type='application/rss+xml' title='GD related Bug #77973 - RSS 2.0' href='rss/bug.php?id=77973&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #77973 :: Uninitialized read in gdImageCreateFromXbm </title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=77973">Sec Bug</a>&nbsp;#77973</th>
            <td id="summary" colspan="5">Uninitialized read in gdImageCreateFromXbm </td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2019-05-05 10:29 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-06-21 00:18 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=GD+related">GD related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.1.29</td>
            <th class="details">OS:</th>
            <td>Windows, Linux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11038" target="_blank">2019-11038</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=77973&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=77973&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=77973&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1557052172">&nbsp;</a><strong>[2019-05-05 10:29 UTC] chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Versions
--------
PHP 8.0.0-dev - Latest code
PHP 7.3.5 - Stable

Configure Line
--------------
Latest Code from Git-
./configure --prefix=/dir_name/install --enable-gd --enable-cli --enable-debug --without-pear

PHP stable version 7.3.5 -
./configure --prefix=/dir_name/install --with-gd --enable-cli --enable-debug --without-pear

Reproduce Steps
---------------
1. Save test script as xbm.php
   Then execute these commands.
2. export ZEND_DONT_UNLOAD_MODULES=1
3. export USE_ZEND_ALLOC=0
4. valgrind ./php xbm.php



Test script:
---------------
&lt;?php
$contents = hex2bin(&quot;23646566696e6520776964746820320a23646566696e652068656967687420320a737461746963206368617220626974735b5d203d7b0a7a7a787a7a&quot;);
$filepath = dirname(__FILE__).DIRECTORY_SEPARATOR.&quot;test.xbm&quot;;
file_put_contents($filepath, $contents);
$xbm = imagecreatefromxbm($filepath);
?&gt;


Actual result:
--------------
Valgrind
--------
Line numbers are from PHP version 7.3.5

==27902== Conditional jump or move depends on uninitialised value(s)
==27902==    at 0x4B12F5: php_gd_gdImageSetPixel (gd.c:766)
==27902==    by 0x4C45C4: php_gd_gdImageCreateFromXbm (gd_xbm.c:141)
==27902==    by 0x4A845F: _php_image_create_from (gd.c:2463)
==27902==    by 0x4A85E5: zif_imagecreatefromxbm (gd.c:2527)
==27902==    by 0x80E61C: ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER (zend_vm_execute.h:690)
==27902==    by 0x87BA0F: execute_ex (zend_vm_execute.h:55465)
==27902==    by 0x88107D: zend_execute (zend_vm_execute.h:60881)
==27902==    by 0x7A599E: zend_execute_scripts (zend.c:1568)
==27902==    by 0x70B0C3: php_execute_script (main.c:2630)
==27902==    by 0x883DD2: do_cli (php_cli.c:997)
==27902==    by 0x884F49: main (php_cli.c:1389)

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=77973'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=77973'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1557052321">&nbsp;</a><strong>[2019-05-05 10:32 UTC] chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Cause of Bug
-------------
Description
------------
This bug is present in gdImageCreateFromXbm method of ext/gd/libgd/gd_xbm.c file.
This method contains below mentioned lines.

...
unsigned int b;
...
sscanf(h, &quot;%x&quot;, &amp;b);
		for (bit = 1; bit &lt;= max_bit; bit = bit &lt;&lt; 1) {
			gdImageSetPixel(im, x++, y, (b &amp; bit) ? 1 : 0);
...

So when sscanf method is not able to read a hex value, &quot;b&quot; variable will contain uninitialized data.
</pre>
</div><div class='comment type_log' ><a name="1557103903">&nbsp;</a><strong>[2019-05-06 00:51 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_log' ><a name="1557103973">&nbsp;</a><strong>[2019-05-06 00:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1557103973">&nbsp;</a><strong>[2019-05-06 00:52 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Not sure why is this security issue. So it gets random value, where's security problem in that?
</pre>
</div><div class='comment type_log' ><a name="1557120489">&nbsp;</a><strong>[2019-05-06 05:28 UTC] chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Assigned</span>
</div></div></div><div class='comment type_comment' ><a name="1557120489">&nbsp;</a><strong>[2019-05-06 05:28 UTC] chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>My understanding is an uninitialized variable in a method can contain data which is present in stack memory. Sometimes this may lead to unintended information disclosure. But I am not sure.

This document has some information on uninitialized variables.
<a href="https://cwe.mitre.org/data/definitions/457.html" rel="nofollow">https://cwe.mitre.org/data/definitions/457.html</a> - (Use of Uninitialized Variable)
</pre>
</div><div class='comment type_log' ><a name="1557131474">&nbsp;</a><strong>[2019-05-06 08:31 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Assigned</span>
<span class="added">+Status:      Analyzed</span>
<span class="removed">-PHP Version: 7.3.5</span>
<span class="added">+PHP Version: 7.1</span>
</div></div></div><div class='comment type_comment' ><a name="1557131474">&nbsp;</a><strong>[2019-05-06 08:31 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this issue!  I can confirm the bug, which
affects our bundled libgd as well as upstream libgd.

Since a common pattern is to read a user supplied image file and
to output the image afterwards, there is the potential of
information disclosure, namely that up to 16 bits can be read from
the stack, which are encoded in the resulting image.  However,
this can only happen when imagecreatefromxbm() is called
(imagecreatefromstring() cannot read XBM images), which appears to
be pretty uncommon.  Not sure if we need a CVE therefore.

Anyhow, the fix is straight forward:
&lt;<a href="https://gist.github.com/cmb69/2626f1f03df7fb87411238be70ae8995" rel="nofollow">https://gist.github.com/cmb69/2626f1f03df7fb87411238be70ae8995</a>&gt;.
</pre>
</div><div class='comment type_log' ><a name="1558863569">&nbsp;</a><strong>[2019-05-26 09:39 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To: cmb</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1558863569">&nbsp;</a><strong>[2019-05-26 09:39 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Stas, please apply the fix for the next GA releases.
</pre>
</div><div class='comment type_log' ><a name="1558998797">&nbsp;</a><strong>[2019-05-27 23:13 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2019-11038</span>
</div></div></div><div class='comment type_log' ><a name="1559000933">&nbsp;</a><strong>[2019-05-27 23:48 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.1</span>
<span class="added">+PHP Version: 7.1.29</span>
</div></div></div><div class='comment type_svn' ><a name="1559000941">&nbsp;</a><strong>[2019-05-27 23:49 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ed6dee9a198c904ad5e03113e58a2d2c200f5184" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ed6dee9a198c904ad5e03113e58a2d2c200f5184</a>
Log: Fix #77973: Uninitialized read in gdImageCreateFromXbm
</pre>
</div><div class='comment type_log' ><a name="1559000941">&nbsp;</a><strong>[2019-05-27 23:49 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Analyzed</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1559000988">&nbsp;</a><strong>[2019-05-27 23:49 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ed6dee9a198c904ad5e03113e58a2d2c200f5184" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ed6dee9a198c904ad5e03113e58a2d2c200f5184</a>
Log: Fix #77973: Uninitialized read in gdImageCreateFromXbm
</pre>
</div><div class='comment type_svn' ><a name="1559027278">&nbsp;</a><strong>[2019-05-28 07:07 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of cmbecker69@gmx.de
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=903b1828dcd68f7cf8b9177a3fe6f481bf627ba9" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=903b1828dcd68f7cf8b9177a3fe6f481bf627ba9</a>
Log: Fix #77973: Uninitialized read in gdImageCreateFromXbm
</pre>
</div><div class='comment type_comment' ><a name="1560301845">&nbsp;</a><strong>[2019-06-12 01:10 UTC] chamal &#x64;&#111;&#x74; desilva &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>CVE-ID (2019-11038) for this bug  is in reserved status.
Is it possible to make this CVE-ID public please?
</pre>
</div><div class='comment type_comment' ><a name="1560314510">&nbsp;</a><strong>[2019-06-12 04:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Yes, sorry, I was extremely busy this week and didn't update the CVEs yet. I'd get to it in coming days.
</pre>
</div><div class='comment type_comment' ><a name="1561076308">&nbsp;</a><strong>[2019-06-21 00:18 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Updated now.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
