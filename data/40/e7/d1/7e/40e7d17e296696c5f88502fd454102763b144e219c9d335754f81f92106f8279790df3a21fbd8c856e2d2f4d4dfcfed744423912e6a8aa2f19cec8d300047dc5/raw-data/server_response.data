<!DOCTYPE html>
<html lang='en'>
<head>
<title>xorg/lib/libXi - X.org libXi Client library for XInput.  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxi)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/xorg/lib/libXi/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/xorg/lib/libxi' title='xorg/lib/libXi Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='xorg/lib/libXi' href='/xorg/lib/libXi/'>xorg/lib/libXi</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='19a9cd607de73947fcfb104682f203ffe4e1f4e5'/><select name='h' onchange='this.form.submit();'>
<option value='CYGWIN'>CYGWIN</option>
<option value='DAMAGE-XFIXES'>DAMAGE-XFIXES</option>
<option value='IPv6-REVIEW'>IPv6-REVIEW</option>
<option value='XACE-SELINUX'>XACE-SELINUX</option>
<option value='XEVIE'>XEVIE</option>
<option value='XINERAMA_2'>XINERAMA_2</option>
<option value='XORG-6_8-branch'>XORG-6_8-branch</option>
<option value='XORG-CURRENT'>XORG-CURRENT</option>
<option value='XORG-RELEASE-1'>XORG-RELEASE-1</option>
<option value='XORG-RELEASE-1-STSF'>XORG-RELEASE-1-STSF</option>
<option value='XORG-RELEASE-1-TM'>XORG-RELEASE-1-TM</option>
<option value='XORG-STABLE'>XORG-STABLE</option>
<option value='XPRINT'>XPRINT</option>
<option value='input-hotplug'>input-hotplug</option>
<option value='libXi-1.1-branch'>libXi-1.1-branch</option>
<option value='libXi-1.2-branch'>libXi-1.2-branch</option>
<option value='libXi-1.3-branch'>libXi-1.3-branch</option>
<option value='libXi-1.4-branch'>libXi-1.4-branch</option>
<option value='libXi-1.6-branch'>libXi-1.6-branch</option>
<option value='libxi-1.0-branch'>libxi-1.0-branch</option>
<option value='master' selected='selected'>master</option>
<option value='mpx'>mpx</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>X.org libXi Client library for XInput.  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxi)</td><td class='sub right'>daniels</td></tr></table>
<table class='tabs'><tr><td>
<a href='/xorg/lib/libXi/'>summary</a><a href='/xorg/lib/libXi/refs/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>refs</a><a href='/xorg/lib/libXi/log/'>log</a><a href='/xorg/lib/libXi/tree/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>tree</a><a class='active' href='/xorg/lib/libXi/commit/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>commit</a><a href='/xorg/lib/libXi/diff/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>diff</a></td><td class='form'><form class='right' method='get' action='/xorg/lib/libXi/log/'>
<input type='hidden' name='id' value='19a9cd607de73947fcfb104682f203ffe4e1f4e5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='19a9cd607de73947fcfb104682f203ffe4e1f4e5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;</td><td class='right'>2016-09-25 22:31:34 +0200</td></tr>
<tr><th>committer</th><td>Matthieu Herrb &lt;matthieu@herrb.eu&gt;</td><td class='right'>2016-09-25 22:31:34 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXi/commit/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>19a9cd607de73947fcfb104682f203ffe4e1f4e5</a> (<a href='/xorg/lib/libXi/patch/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXi/tree/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>5fbb89ac3f543a3b25d9eb9e85def0e19b174e9e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXi/commit/?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>2286282f965064176b3b1492646c6e2e0f4ab7dd</a> (<a href='/xorg/lib/libXi/diff/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5&amp;id2=2286282f965064176b3b1492646c6e2e0f4ab7dd'>diff</a>)</td></tr></table>
<div class='commit-subject'>Properly validate server responses.</div><div class='commit-msg'>By validating length fields from server responses, out of boundary
accesses and endless loops can be mitigated.

Signed-off-by: Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;
Reviewed-by: Matthieu Herrb &lt;matthieu@herrb.eu&gt;
</div><div class='diffstat-header'><a href='/xorg/lib/libXi/diff/?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGMotion.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGMotion.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 5.6%;'/><td class='rem' style='width: 2.8%;'/><td class='none' style='width: 91.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGetBMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetBMap.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 5.6%;'/><td class='rem' style='width: 2.8%;'/><td class='none' style='width: 91.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGetDCtl.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetDCtl.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 11.1%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 83.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGetFCtl.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetFCtl.c</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 16.7%;'/><td class='rem' style='width: 2.8%;'/><td class='none' style='width: 80.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGetKMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetKMap.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 30.6%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 61.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XGetMMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetMMap.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 69.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XIQueryDevice.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XIQueryDevice.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 94.4%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XListDev.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XListDev.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 41.7%;'/><td class='rem' style='width: 16.7%;'/><td class='none' style='width: 41.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XOpenDev.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XOpenDev.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 27.8%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 63.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXi/diff/src/XQueryDv.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XQueryDv.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 16.7%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 77.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>10 files changed, 99 insertions, 23 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/XGMotion.c b/src/XGMotion.c<br/>index 7785843..9433e29 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGMotion.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGMotion.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGMotion.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGMotion.c</a></div><div class='hunk'>@@ -114,7 +114,8 @@ XGetDeviceMotionEvents(</div><div class='ctx'>     }</div><div class='ctx'>     /* rep.axes is a CARD8, so assume max number of axes for bounds check */</div><div class='ctx'>     if (rep.nEvents &lt;</div><div class='del'>-	(INT_MAX / (sizeof(XDeviceTimeCoord) + (UCHAR_MAX * sizeof(int))))) {</div><div class='add'>+	(INT_MAX / (sizeof(XDeviceTimeCoord) + (UCHAR_MAX * sizeof(int)))) &amp;&amp;</div><div class='add'>+	rep.nEvents * (rep.axes + 1) &lt;= rep.length) {</div><div class='ctx'> 	size_t bsize = rep.nEvents *</div><div class='ctx'> 	    (sizeof(XDeviceTimeCoord) + (rep.axes * sizeof(int)));</div><div class='ctx'> 	bufp = Xmalloc(bsize);</div><div class='head'>diff --git a/src/XGetBMap.c b/src/XGetBMap.c<br/>index 002daba..13bb8c6 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGetBMap.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGetBMap.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGetBMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetBMap.c</a></div><div class='hunk'>@@ -92,7 +92,8 @@ XGetDeviceButtonMapping(</div><div class='ctx'> </div><div class='ctx'>     status = _XReply(dpy, (xReply *) &amp; rep, 0, xFalse);</div><div class='ctx'>     if (status == 1) {</div><div class='del'>-	if (rep.length &lt;= (sizeof(mapping) &gt;&gt; 2)) {</div><div class='add'>+	if (rep.length &lt;= (sizeof(mapping) &gt;&gt; 2) &amp;&amp;</div><div class='add'>+	    rep.nElts &lt;= (rep.length &lt;&lt; 2)) {</div><div class='ctx'> 	    unsigned long nbytes = rep.length &lt;&lt; 2;</div><div class='ctx'> 	    _XRead(dpy, (char *)mapping, nbytes);</div><div class='ctx'> </div><div class='head'>diff --git a/src/XGetDCtl.c b/src/XGetDCtl.c<br/>index c5d3b53..7f6b396 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGetDCtl.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGetDCtl.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGetDCtl.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetDCtl.c</a></div><div class='hunk'>@@ -93,7 +93,8 @@ XGetDeviceControl(</div><div class='ctx'>     if (rep.length &gt; 0) {</div><div class='ctx'> 	unsigned long nbytes;</div><div class='ctx'> 	size_t size = 0;</div><div class='del'>-	if (rep.length &lt; (INT_MAX &gt;&gt; 2)) {</div><div class='add'>+	if (rep.length &lt; (INT_MAX &gt;&gt; 2) &amp;&amp;</div><div class='add'>+	    (rep.length &lt;&lt; 2) &gt;= sizeof(xDeviceState)) {</div><div class='ctx'> 	    nbytes = (unsigned long) rep.length &lt;&lt; 2;</div><div class='ctx'> 	    d = Xmalloc(nbytes);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -117,7 +118,8 @@ XGetDeviceControl(</div><div class='ctx'> 	    size_t val_size;</div><div class='ctx'> </div><div class='ctx'> 	    r = (xDeviceResolutionState *) d;</div><div class='del'>-	    if (r-&gt;num_valuators &gt;= (INT_MAX / (3 * sizeof(int))))</div><div class='add'>+	    if (sizeof(xDeviceResolutionState) &gt; nbytes ||</div><div class='add'>+		r-&gt;num_valuators &gt;= (INT_MAX / (3 * sizeof(int))))</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	    val_size = 3 * sizeof(int) * r-&gt;num_valuators;</div><div class='ctx'> 	    if ((sizeof(xDeviceResolutionState) + val_size) &gt; nbytes)</div><div class='head'>diff --git a/src/XGetFCtl.c b/src/XGetFCtl.c<br/>index 7fd6d0e..82dcc64 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGetFCtl.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGetFCtl.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGetFCtl.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetFCtl.c</a></div><div class='hunk'>@@ -73,6 +73,7 @@ XGetFeedbackControl(</div><div class='ctx'>     XFeedbackState *Sav = NULL;</div><div class='ctx'>     xFeedbackState *f = NULL;</div><div class='ctx'>     xFeedbackState *sav = NULL;</div><div class='add'>+    char *end = NULL;</div><div class='ctx'>     xGetFeedbackControlReq *req;</div><div class='ctx'>     xGetFeedbackControlReply rep;</div><div class='ctx'>     XExtDisplayInfo *info = XInput_find_display(dpy);</div><div class='hunk'>@@ -105,10 +106,12 @@ XGetFeedbackControl(</div><div class='ctx'> 	    goto out;</div><div class='ctx'> 	}</div><div class='ctx'> 	sav = f;</div><div class='add'>+	end = (char *)f + nbytes;</div><div class='ctx'> 	_XRead(dpy, (char *)f, nbytes);</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; *num_feedbacks; i++) {</div><div class='del'>-	    if (f-&gt;length &gt; nbytes)</div><div class='add'>+	    if ((char *)f + sizeof(*f) &gt; end ||</div><div class='add'>+	        f-&gt;length == 0 || f-&gt;length &gt; nbytes)</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	    nbytes -= f-&gt;length;</div><div class='ctx'> </div><div class='hunk'>@@ -125,6 +128,8 @@ XGetFeedbackControl(</div><div class='ctx'> 	    case StringFeedbackClass:</div><div class='ctx'> 	    {</div><div class='ctx'> 		xStringFeedbackState *strf = (xStringFeedbackState *) f;</div><div class='add'>+		if ((char *)f + sizeof(*strf) &gt; end)</div><div class='add'>+		    goto out;</div><div class='ctx'> 		size += sizeof(XStringFeedbackState) +</div><div class='ctx'> 		    (strf-&gt;num_syms_supported * sizeof(KeySym));</div><div class='ctx'> 	    }</div><div class='head'>diff --git a/src/XGetKMap.c b/src/XGetKMap.c<br/>index 0540ce4..008a72b 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGetKMap.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGetKMap.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGetKMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetKMap.c</a></div><div class='hunk'>@@ -54,6 +54,7 @@ SOFTWARE.</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XI.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XIproto.h&gt;</div><div class='ctx'> #include &lt;X11/Xlibint.h&gt;</div><div class='hunk'>@@ -93,9 +94,16 @@ XGetDeviceKeyMapping(register Display * dpy, XDevice * dev,</div><div class='ctx'> 	return (KeySym *) NULL;</div><div class='ctx'>     }</div><div class='ctx'>     if (rep.length &gt; 0) {</div><div class='del'>-	*syms_per_code = rep.keySymsPerKeyCode;</div><div class='del'>-	nbytes = (long)rep.length &lt;&lt; 2;</div><div class='del'>-	mapping = (KeySym *) Xmalloc((unsigned)nbytes);</div><div class='add'>+	if (rep.length &lt; INT_MAX &gt;&gt; 2 &amp;&amp;</div><div class='add'>+	    rep.length == rep.keySymsPerKeyCode * keycount) {</div><div class='add'>+	    *syms_per_code = rep.keySymsPerKeyCode;</div><div class='add'>+	    nbytes = (long)rep.length &lt;&lt; 2;</div><div class='add'>+	    mapping = (KeySym *) Xmalloc((unsigned)nbytes);</div><div class='add'>+	} else {</div><div class='add'>+	    *syms_per_code = 0;</div><div class='add'>+	    nbytes = 0;</div><div class='add'>+	    mapping = NULL;</div><div class='add'>+	}</div><div class='ctx'> 	if (mapping)</div><div class='ctx'> 	    _XRead(dpy, (char *)mapping, nbytes);</div><div class='ctx'> 	else</div><div class='head'>diff --git a/src/XGetMMap.c b/src/XGetMMap.c<br/>index 246698c..33c114f 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XGetMMap.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XGetMMap.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XGetMMap.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XGetMMap.c</a></div><div class='hunk'>@@ -53,6 +53,7 @@ SOFTWARE.</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XI.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XIproto.h&gt;</div><div class='ctx'> #include &lt;X11/Xlibint.h&gt;</div><div class='hunk'>@@ -85,8 +86,14 @@ XGetDeviceModifierMapping(</div><div class='ctx'> 	SyncHandle();</div><div class='ctx'> 	return (XModifierKeymap *) NULL;</div><div class='ctx'>     }</div><div class='del'>-    nbytes = (unsigned long)rep.length &lt;&lt; 2;</div><div class='del'>-    res = (XModifierKeymap *) Xmalloc(sizeof(XModifierKeymap));</div><div class='add'>+    if (rep.length &lt; (INT_MAX &gt;&gt; 2) &amp;&amp;</div><div class='add'>+	rep.numKeyPerModifier == rep.length &gt;&gt; 1) {</div><div class='add'>+	nbytes = (unsigned long)rep.length &lt;&lt; 2;</div><div class='add'>+	res = (XModifierKeymap *) Xmalloc(sizeof(XModifierKeymap));</div><div class='add'>+    } else {</div><div class='add'>+	nbytes = 0;</div><div class='add'>+	res = NULL;</div><div class='add'>+    }</div><div class='ctx'>     if (res) {</div><div class='ctx'> 	res-&gt;modifiermap = (KeyCode *) Xmalloc(nbytes);</div><div class='ctx'> 	if (res-&gt;modifiermap)</div><div class='head'>diff --git a/src/XIQueryDevice.c b/src/XIQueryDevice.c<br/>index fb8504f..a457cd6 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XIQueryDevice.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XIQueryDevice.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XIQueryDevice.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XIQueryDevice.c</a></div><div class='hunk'>@@ -26,6 +26,7 @@</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;stdint.h&gt;</div><div class='ctx'> #include &lt;X11/Xlibint.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XI2proto.h&gt;</div><div class='hunk'>@@ -43,6 +44,7 @@ XIQueryDevice(Display *dpy, int deviceid, int *ndevices_return)</div><div class='ctx'>     xXIQueryDeviceReq   *req;</div><div class='ctx'>     xXIQueryDeviceReply reply;</div><div class='ctx'>     char                *ptr;</div><div class='add'>+    char                *end;</div><div class='ctx'>     int                 i;</div><div class='ctx'>     char                *buf;</div><div class='ctx'> </div><div class='hunk'>@@ -60,14 +62,24 @@ XIQueryDevice(Display *dpy, int deviceid, int *ndevices_return)</div><div class='ctx'>     if (!_XReply(dpy, (xReply*) &amp;reply, 0, xFalse))</div><div class='ctx'>         goto error;</div><div class='ctx'> </div><div class='del'>-    *ndevices_return = reply.num_devices;</div><div class='del'>-    info = Xmalloc((reply.num_devices + 1) * sizeof(XIDeviceInfo));</div><div class='add'>+    if (reply.length &lt; INT_MAX / 4)</div><div class='add'>+    {</div><div class='add'>+	*ndevices_return = reply.num_devices;</div><div class='add'>+	info = Xmalloc((reply.num_devices + 1) * sizeof(XIDeviceInfo));</div><div class='add'>+    }</div><div class='add'>+    else</div><div class='add'>+    {</div><div class='add'>+	*ndevices_return = 0;</div><div class='add'>+	info = NULL;</div><div class='add'>+    }</div><div class='add'>+</div><div class='ctx'>     if (!info)</div><div class='ctx'>         goto error;</div><div class='ctx'> </div><div class='ctx'>     buf = Xmalloc(reply.length * 4);</div><div class='ctx'>     _XRead(dpy, buf, reply.length * 4);</div><div class='ctx'>     ptr = buf;</div><div class='add'>+    end = buf + reply.length * 4;</div><div class='ctx'> </div><div class='ctx'>     /* info is a null-terminated array */</div><div class='ctx'>     info[reply.num_devices].name = NULL;</div><div class='hunk'>@@ -79,6 +91,9 @@ XIQueryDevice(Display *dpy, int deviceid, int *ndevices_return)</div><div class='ctx'>         XIDeviceInfo    *lib = &amp;info[i];</div><div class='ctx'>         xXIDeviceInfo   *wire = (xXIDeviceInfo*)ptr;</div><div class='ctx'> </div><div class='add'>+        if (ptr + sizeof(xXIDeviceInfo) &gt; end)</div><div class='add'>+            goto error_loop;</div><div class='add'>+</div><div class='ctx'>         lib-&gt;deviceid    = wire-&gt;deviceid;</div><div class='ctx'>         lib-&gt;use         = wire-&gt;use;</div><div class='ctx'>         lib-&gt;attachment  = wire-&gt;attachment;</div><div class='hunk'>@@ -87,12 +102,23 @@ XIQueryDevice(Display *dpy, int deviceid, int *ndevices_return)</div><div class='ctx'> </div><div class='ctx'>         ptr += sizeof(xXIDeviceInfo);</div><div class='ctx'> </div><div class='add'>+        if (ptr + wire-&gt;name_len &gt; end)</div><div class='add'>+            goto error_loop;</div><div class='add'>+</div><div class='ctx'>         lib-&gt;name = Xcalloc(wire-&gt;name_len + 1, 1);</div><div class='add'>+        if (lib-&gt;name == NULL)</div><div class='add'>+            goto error_loop;</div><div class='ctx'>         strncpy(lib-&gt;name, ptr, wire-&gt;name_len);</div><div class='add'>+        lib-&gt;name[wire-&gt;name_len] = '\0';</div><div class='ctx'>         ptr += ((wire-&gt;name_len + 3)/4) * 4;</div><div class='ctx'> </div><div class='ctx'>         sz = size_classes((xXIAnyInfo*)ptr, nclasses);</div><div class='ctx'>         lib-&gt;classes = Xmalloc(sz);</div><div class='add'>+        if (lib-&gt;classes == NULL)</div><div class='add'>+        {</div><div class='add'>+            Xfree(lib-&gt;name);</div><div class='add'>+            goto error_loop;</div><div class='add'>+        }</div><div class='ctx'>         ptr += copy_classes(lib, (xXIAnyInfo*)ptr, &amp;nclasses);</div><div class='ctx'>         /* We skip over unused classes */</div><div class='ctx'>         lib-&gt;num_classes = nclasses;</div><div class='hunk'>@@ -103,6 +129,12 @@ XIQueryDevice(Display *dpy, int deviceid, int *ndevices_return)</div><div class='ctx'>     SyncHandle();</div><div class='ctx'>     return info;</div><div class='ctx'> </div><div class='add'>+error_loop:</div><div class='add'>+    while (--i &gt;= 0)</div><div class='add'>+    {</div><div class='add'>+        Xfree(info[i].name);</div><div class='add'>+        Xfree(info[i].classes);</div><div class='add'>+    }</div><div class='ctx'> error:</div><div class='ctx'>     UnlockDisplay(dpy);</div><div class='ctx'> error_unlocked:</div><div class='head'>diff --git a/src/XListDev.c b/src/XListDev.c<br/>index b85ff3c..f850cd0 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XListDev.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XListDev.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XListDev.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XListDev.c</a></div><div class='hunk'>@@ -74,7 +74,7 @@ static int pad_to_xid(int base_size)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static size_t</div><div class='del'>-SizeClassInfo(xAnyClassPtr *any, int num_classes)</div><div class='add'>+SizeClassInfo(xAnyClassPtr *any, size_t len, int num_classes)</div><div class='ctx'> {</div><div class='ctx'>     int size = 0;</div><div class='ctx'>     int j;</div><div class='hunk'>@@ -90,6 +90,8 @@ SizeClassInfo(xAnyClassPtr *any, int num_classes)</div><div class='ctx'>                 {</div><div class='ctx'>                     xValuatorInfoPtr v;</div><div class='ctx'> </div><div class='add'>+                    if (len &lt; sizeof(v))</div><div class='add'>+                        return 0;</div><div class='ctx'>                     v = (xValuatorInfoPtr) *any;</div><div class='ctx'>                     size += pad_to_xid(sizeof(XValuatorInfo) +</div><div class='ctx'>                         (v-&gt;num_axes * sizeof(XAxisInfo)));</div><div class='hunk'>@@ -98,6 +100,8 @@ SizeClassInfo(xAnyClassPtr *any, int num_classes)</div><div class='ctx'>             default:</div><div class='ctx'>                 break;</div><div class='ctx'>         }</div><div class='add'>+        if ((*any)-&gt;length &gt; len)</div><div class='add'>+            return 0;</div><div class='ctx'>         *any = (xAnyClassPtr) ((char *)(*any) + (*any)-&gt;length);</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='hunk'>@@ -170,7 +174,7 @@ XListInputDevices(</div><div class='ctx'>     register Display	*dpy,</div><div class='ctx'>     int			*ndevices)</div><div class='ctx'> {</div><div class='del'>-    size_t size;</div><div class='add'>+    size_t s, size;</div><div class='ctx'>     xListInputDevicesReq *req;</div><div class='ctx'>     xListInputDevicesReply rep;</div><div class='ctx'>     xDeviceInfo *list, *slist = NULL;</div><div class='hunk'>@@ -178,6 +182,7 @@ XListInputDevices(</div><div class='ctx'>     XDeviceInfo *clist = NULL;</div><div class='ctx'>     xAnyClassPtr any, sav_any;</div><div class='ctx'>     XAnyClassPtr Any;</div><div class='add'>+    char *end = NULL;</div><div class='ctx'>     unsigned char *nptr, *Nptr;</div><div class='ctx'>     int i;</div><div class='ctx'>     unsigned long rlen;</div><div class='hunk'>@@ -213,16 +218,20 @@ XListInputDevices(</div><div class='ctx'> </div><div class='ctx'> 	any = (xAnyClassPtr) ((char *)list + (*ndevices * sizeof(xDeviceInfo)));</div><div class='ctx'> 	sav_any = any;</div><div class='add'>+	end = (char *)list + rlen;</div><div class='ctx'> 	for (i = 0; i &lt; *ndevices; i++, list++) {</div><div class='del'>-            size += SizeClassInfo(&amp;any, (int)list-&gt;num_classes);</div><div class='add'>+            s = SizeClassInfo(&amp;any, end - (char *)any, (int)list-&gt;num_classes);</div><div class='add'>+            if (!s)</div><div class='add'>+                goto out;</div><div class='add'>+            size += s;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	Nptr = ((unsigned char *)list) + rlen + 1;</div><div class='add'>+	Nptr = ((unsigned char *)list) + rlen;</div><div class='ctx'> 	for (i = 0, nptr = (unsigned char *)any; i &lt; *ndevices; i++) {</div><div class='add'>+	    if (nptr &gt;= Nptr)</div><div class='add'>+		goto out;</div><div class='ctx'> 	    size += *nptr + 1;</div><div class='ctx'> 	    nptr += (*nptr + 1);</div><div class='del'>-	    if (nptr &gt; Nptr)</div><div class='del'>-		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	clist = (XDeviceInfoPtr) Xmalloc(size);</div><div class='head'>diff --git a/src/XOpenDev.c b/src/XOpenDev.c<br/>index 029dec2..4b3c460 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XOpenDev.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XOpenDev.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XOpenDev.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XOpenDev.c</a></div><div class='hunk'>@@ -53,6 +53,7 @@ SOFTWARE.</div><div class='ctx'> #include &lt;config.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#include &lt;limits.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XI.h&gt;</div><div class='ctx'> #include &lt;X11/extensions/XIproto.h&gt;</div><div class='ctx'> #include &lt;X11/Xlibint.h&gt;</div><div class='hunk'>@@ -86,9 +87,15 @@ XOpenDevice(</div><div class='ctx'> 	return (XDevice *) NULL;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    rlen = rep.length &lt;&lt; 2;</div><div class='del'>-    dev = (XDevice *) Xmalloc(sizeof(XDevice) + rep.num_classes *</div><div class='del'>-			      sizeof(XInputClassInfo));</div><div class='add'>+    if (rep.length &lt; INT_MAX &gt;&gt; 2 &amp;&amp;</div><div class='add'>+	(rep.length &lt;&lt; 2) &gt;= rep.num_classes * sizeof(xInputClassInfo)) {</div><div class='add'>+	rlen = rep.length &lt;&lt; 2;</div><div class='add'>+	dev = (XDevice *) Xmalloc(sizeof(XDevice) + rep.num_classes *</div><div class='add'>+				  sizeof(XInputClassInfo));</div><div class='add'>+    } else {</div><div class='add'>+	rlen = 0;</div><div class='add'>+	dev = NULL;</div><div class='add'>+    }</div><div class='ctx'>     if (dev) {</div><div class='ctx'> 	int dlen;	/* data length */</div><div class='ctx'> </div><div class='head'>diff --git a/src/XQueryDv.c b/src/XQueryDv.c<br/>index de1c0e5..7ee2272 100644<br/>--- a/<a href='/xorg/lib/libXi/tree/src/XQueryDv.c?id=2286282f965064176b3b1492646c6e2e0f4ab7dd'>src/XQueryDv.c</a><br/>+++ b/<a href='/xorg/lib/libXi/tree/src/XQueryDv.c?id=19a9cd607de73947fcfb104682f203ffe4e1f4e5'>src/XQueryDv.c</a></div><div class='hunk'>@@ -73,7 +73,7 @@ XQueryDeviceState(</div><div class='ctx'>     xQueryDeviceStateReply rep;</div><div class='ctx'>     XDeviceState *state = NULL;</div><div class='ctx'>     XInputClass *any, *Any;</div><div class='del'>-    char *data = NULL;</div><div class='add'>+    char *data = NULL, *end = NULL;</div><div class='ctx'>     XExtDisplayInfo *info = XInput_find_display(dpy);</div><div class='ctx'> </div><div class='ctx'>     LockDisplay(dpy);</div><div class='hunk'>@@ -92,6 +92,7 @@ XQueryDeviceState(</div><div class='ctx'> 	if (rep.length &lt; (INT_MAX &gt;&gt; 2)) {</div><div class='ctx'> 	    rlen = (unsigned long) rep.length &lt;&lt; 2;</div><div class='ctx'> 	    data = Xmalloc(rlen);</div><div class='add'>+	    end = data + rlen;</div><div class='ctx'> 	}</div><div class='ctx'> 	if (!data) {</div><div class='ctx'> 	    _XEatDataWords(dpy, rep.length);</div><div class='hunk'>@@ -100,7 +101,8 @@ XQueryDeviceState(</div><div class='ctx'> 	_XRead(dpy, data, rlen);</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0, any = (XInputClass *) data; i &lt; (int)rep.num_classes; i++) {</div><div class='del'>-	    if (any-&gt;length &gt; rlen)</div><div class='add'>+	    if ((char *)any + sizeof(XInputClass) &gt; end ||</div><div class='add'>+		any-&gt;length == 0 || any-&gt;length &gt; rlen)</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	    rlen -= any-&gt;length;</div><div class='ctx'> </div><div class='hunk'>@@ -114,6 +116,8 @@ XQueryDeviceState(</div><div class='ctx'> 	    case ValuatorClass:</div><div class='ctx'> 	    {</div><div class='ctx'> 		xValuatorState *v = (xValuatorState *) any;</div><div class='add'>+		if ((char *)any + sizeof(xValuatorState) &gt; end)</div><div class='add'>+		    goto out;</div><div class='ctx'> 		size += (sizeof(XValuatorState) +</div><div class='ctx'> 			 (v-&gt;num_valuators * sizeof(int)));</div><div class='ctx'> 	    }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
