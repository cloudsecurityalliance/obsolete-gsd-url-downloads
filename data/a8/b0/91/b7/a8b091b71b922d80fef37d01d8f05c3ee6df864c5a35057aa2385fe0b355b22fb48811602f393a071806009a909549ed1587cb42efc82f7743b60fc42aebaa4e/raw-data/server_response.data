<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>6e4b8e505173f803a5fc05abc09f64eef89dc308 - platform/system/bt - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><link rel="stylesheet" type="text/css" href="/+static/doc.css"><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/system/bt/%2B/6e4b8e505173f803a5fc05abc09f64eef89dc308">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">android</a> / <a class="Breadcrumbs-crumb" href="/platform/">platform</a> / <a class="Breadcrumbs-crumb" href="/platform/system/">system</a> / <a class="Breadcrumbs-crumb" href="/platform/system/bt/">bt</a> / <span class="Breadcrumbs-crumb">6e4b8e505173f803a5fc05abc09f64eef89dc308</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>6e4b8e505173f803a5fc05abc09f64eef89dc308</td><td><span>[<a href="/platform/system/bt/+log/6e4b8e505173f803a5fc05abc09f64eef89dc308">log</a>]</span> <span>[<a href="/platform/system/bt/+archive/6e4b8e505173f803a5fc05abc09f64eef89dc308.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Cheney Ni &lt;cheneyni@google.com&gt;</td><td>Wed Aug 08 22:20:08 2018 +0800</td></tr><tr><th class="Metadata-title">committer</th><td>android-build-team Robot &lt;android-build-team-robot@google.com&gt;</td><td>Thu Aug 16 16:02:28 2018 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/">56774ee58c5c27d048c31da41ab359768b73437c</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308%5E">198888b8e0163bab7a417161c63e483804ae8e31</a> <span>[<a href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">Checks the SMP length to fix OOB read

Bug: 111937065
Test: manual
Change-Id: <a href="https://android-review.googlesource.com/#/q/I330880a6e1671d0117845430db4076dfe1aba688">I330880a6e1671d0117845430db4076dfe1aba688</a>
Merged-In: <a href="https://android-review.googlesource.com/#/q/I330880a6e1671d0117845430db4076dfe1aba688">I330880a6e1671d0117845430db4076dfe1aba688</a>
(cherry picked from commit fceb753bda651c4135f3f93a510e5fcb4c7542b8)
</pre><ul class="DiffTree"><li><a href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/stack/smp/smp_act.cc">stack/smp/smp_act.cc</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308%5E%21/#F0">diff</a>]</span></li></ul><div class="DiffSummary">1 file changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: 56774ee58c5c27d048c31da41ab359768b73437c</div><ol class="FileList"><li class="FileList-item FileList-item--regularFile" title="Regular file - .clang-format"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/.clang-format">.clang-format</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitignore"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/.gitignore">.gitignore</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gn"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/.gn">.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.bp"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/Android.bp">Android.bp</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - Android.mk"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/Android.mk">Android.mk</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - BUILD.gn"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/BUILD.gn">BUILD.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CleanSpec.mk"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/CleanSpec.mk">CleanSpec.mk</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - EventLogTags.logtags"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/EventLogTags.logtags">EventLogTags.logtags</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - MODULE_LICENSE_APACHE2"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/MODULE_LICENSE_APACHE2">MODULE_LICENSE_APACHE2</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - NOTICE"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/NOTICE">NOTICE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - OWNERS"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/OWNERS">OWNERS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - PREUPLOAD.cfg"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/PREUPLOAD.cfg">PREUPLOAD.cfg</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README.md"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/README.md">README.md</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - audio_a2dp_hw/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/audio_a2dp_hw/">audio_a2dp_hw/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - audio_hearing_aid_hw/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/audio_hearing_aid_hw/">audio_hearing_aid_hw/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - binder/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/binder/">binder/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - bta/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/bta/">bta/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - btcore/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/btcore/">btcore/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - btif/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/btif/">btif/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - build/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/build/">build/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - conf/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/conf/">conf/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - device/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/device/">device/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - doc/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/doc/">doc/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - embdrv/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/embdrv/">embdrv/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - hci/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/hci/">hci/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - include/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/include/">include/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - internal_include/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/internal_include/">internal_include/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - main/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/main/">main/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - osi/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/osi/">osi/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - packet/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/packet/">packet/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - profile/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/profile/">profile/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - proto/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/proto/">proto/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - service/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/service/">service/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - stack/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/stack/">stack/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - test/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/test/">test/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tools/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/tools/">tools/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - types/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/types/">types/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - udrv/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/udrv/">udrv/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - utils/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/utils/">utils/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - vendor_libs/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/vendor_libs/">vendor_libs/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - vnd/"><a class="FileList-itemLink" href="/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308/vnd/">vnd/</a></li></ol><div class="InlineReadme"><div class="InlineReadme-path">README.md</div><div class="doc"><h1><a class="h" name="Fluoride-Bluetooth-stack" href="#Fluoride-Bluetooth-stack"><span></span></a><a class="h" name="fluoride-bluetooth-stack" href="#fluoride-bluetooth-stack"><span></span></a>Fluoride Bluetooth stack</h1><h2><a class="h" name="Building-and-running-on-AOSP" href="#Building-and-running-on-AOSP"><span></span></a><a class="h" name="building-and-running-on-aosp" href="#building-and-running-on-aosp"><span></span></a>Building and running on AOSP</h2><p>Just build AOSP - Fluoride is there by default.</p><h2><a class="h" name="Building-and-running-on-Linux" href="#Building-and-running-on-Linux"><span></span></a><a class="h" name="building-and-running-on-linux" href="#building-and-running-on-linux"><span></span></a>Building and running on Linux</h2><p>Instructions for Ubuntu, tested on 14.04 with Clang 3.5.0 and 16.10 with Clang 3.8.0</p><h3><a class="h" name="Download-source" href="#Download-source"><span></span></a><a class="h" name="download-source" href="#download-source"><span></span></a>Download source</h3><pre class="code"><span class="pln">mkdir </span><span class="pun">~/</span><span class="pln">fluoride
cd </span><span class="pun">~/</span><span class="pln">fluoride
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">system</span><span class="pun">/</span><span class="pln">bt
</span></pre><p>Install dependencies (require sudo access):</p><pre class="code"><span class="pln">cd </span><span class="pun">~/</span><span class="pln">fluoride</span><span class="pun">/</span><span class="pln">bt
build</span><span class="pun">/</span><span class="pln">install_deps</span><span class="pun">.</span><span class="pln">sh
</span></pre><p>Then fetch third party dependencies:</p><pre class="code"><span class="pln">cd </span><span class="pun">~/</span><span class="pln">fluoride</span><span class="pun">/</span><span class="pln">bt
mkdir third_party
cd third_party
git clone https</span><span class="pun">://</span><span class="pln">github</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">google</span><span class="pun">/</span><span class="pln">googletest</span><span class="pun">.</span><span class="pln">git
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">external</span><span class="pun">/</span><span class="pln">aac
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">external</span><span class="pun">/</span><span class="pln">libchrome
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">external</span><span class="pun">/</span><span class="pln">libldac
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">external</span><span class="pun">/</span><span class="pln">modp_b64
git clone https</span><span class="pun">://</span><span class="pln">android</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">platform</span><span class="pun">/</span><span class="pln">external</span><span class="pun">/</span><span class="pln">tinyxml2
</span></pre><p>And third party dependencies of third party dependencies:</p><pre class="code"><span class="pln">cd fluoride</span><span class="pun">/</span><span class="pln">bt</span><span class="pun">/</span><span class="pln">third_party</span><span class="pun">/</span><span class="pln">libchrome</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/</span><span class="pln">third_party
mkdir valgrind
cd valgrind
curl https</span><span class="pun">://</span><span class="pln">chromium</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">chromium</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/+/</span><span class="pln">master</span><span class="pun">/</span><span class="pln">third_party</span><span class="pun">/</span><span class="pln">valgrind</span><span class="pun">/</span><span class="pln">valgrind</span><span class="pun">.</span><span class="pln">h</span><span class="pun">?</span><span class="pln">format</span><span class="pun">=</span><span class="pln">TEXT </span><span class="pun">|</span><span class="pln"> base64 </span><span class="pun">-</span><span class="pln">d </span><span class="pun">&gt;</span><span class="pln"> valgrind</span><span class="pun">.</span><span class="pln">h
curl https</span><span class="pun">://</span><span class="pln">chromium</span><span class="pun">.</span><span class="pln">googlesource</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">chromium</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/+/</span><span class="pln">master</span><span class="pun">/</span><span class="pln">third_party</span><span class="pun">/</span><span class="pln">valgrind</span><span class="pun">/</span><span class="pln">memcheck</span><span class="pun">.</span><span class="pln">h</span><span class="pun">?</span><span class="pln">format</span><span class="pun">=</span><span class="pln">TEXT </span><span class="pun">|</span><span class="pln"> base64 </span><span class="pun">-</span><span class="pln">d </span><span class="pun">&gt;</span><span class="pln"> memcheck</span><span class="pun">.</span><span class="pln">h
</span></pre><p>NOTE: If system/bt is checked out under AOSP, then create symbolic links instead of downloading sources</p><pre class="code">cd system/bt
mkdir third_party
cd third_party
ln -s ../../../external/aac aac
ln -s ../../../external/libchrome libchrome
ln -s ../../../external/libldac libldac
ln -s ../../../external/modp_b64 modp_b64
ln -s ../../../external/tinyxml2 tinyxml2
ln -s ../../../external/googletest googletest
</pre><h3><a class="h" name="Generate-your-build-files" href="#Generate-your-build-files"><span></span></a><a class="h" name="generate-your-build-files" href="#generate-your-build-files"><span></span></a>Generate your build files</h3><pre class="code"><span class="pln">cd </span><span class="pun">~/</span><span class="pln">fluoride</span><span class="pun">/</span><span class="pln">bt
gn gen out</span><span class="pun">/</span><span class="typ">Default</span><span class="pln">
</span></pre><h3><a class="h" name="Build" href="#Build"><span></span></a><a class="h" name="build" href="#build"><span></span></a>Build</h3><pre class="code"><span class="pln">cd </span><span class="pun">~/</span><span class="pln">fluoride</span><span class="pun">/</span><span class="pln">bt
ninja </span><span class="pun">-</span><span class="pln">C out</span><span class="pun">/</span><span class="typ">Default</span><span class="pln"> all
</span></pre><p>This will build all targets (the shared library, executables, tests, etc) and put them in out/Default. To build an individual target, replace &ldquo;all&rdquo; with the target of your choice, e.g. <code class="code">ninja -C out/Default net_test_osi</code>.</p><h3><a class="h" name="Run" href="#Run"><span></span></a><a class="h" name="run" href="#run"><span></span></a>Run</h3><pre class="code"><span class="pln">cd </span><span class="pun">~/</span><span class="pln">fluoride</span><span class="pun">/</span><span class="pln">bt</span><span class="pun">/</span><span class="pln">out</span><span class="pun">/</span><span class="typ">Default</span><span class="pln">
LD_LIBRARY_PATH</span><span class="pun">=./</span><span class="pln"> </span><span class="pun">./</span><span class="pln">bluetoothtbd </span><span class="pun">-</span><span class="pln">create</span><span class="pun">-</span><span class="pln">ipc</span><span class="pun">-</span><span class="pln">socket</span><span class="pun">=</span><span class="pln">fluoride
</span></pre><h3><a class="h" name="Eclipse-IDE-Support" href="#Eclipse-IDE-Support"><span></span></a><a class="h" name="eclipse-ide-support" href="#eclipse-ide-support"><span></span></a>Eclipse IDE Support</h3><ol><li><p>Follows the Chromium project <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/linux_eclipse_dev.md">Eclipse Setup Instructions</a> until &ldquo;Optional: Building inside Eclipse&rdquo; section (don&#39;t do that section, we will set it up differently)</p></li><li><p>Generate Eclipse settings:</p></li></ol><pre class="code"><span class="pln">cd system</span><span class="pun">/</span><span class="pln">bt
gn gen </span><span class="pun">--</span><span class="pln">ide</span><span class="pun">=</span><span class="pln">eclipse out</span><span class="pun">/</span><span class="typ">Default</span><span class="pln">
</span></pre><ol start="3"><li><p>In Eclipse, do File-&gt;Import-&gt;C/C++-&gt;C/C++ Project Settings, choose the XML location under system/bt/out/Default</p></li><li><p>Right click on the project. Go to Preferences-&gt;C/C++ Build-&gt;Builder Settings. Uncheck &ldquo;Use default build command&rdquo;, but instead using &ldquo;ninja -C out/Default&rdquo;</p></li><li><p>Goto Behaviour tab, change clean command to &ldquo;-t clean&rdquo;</p></li></ol></div></div></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>