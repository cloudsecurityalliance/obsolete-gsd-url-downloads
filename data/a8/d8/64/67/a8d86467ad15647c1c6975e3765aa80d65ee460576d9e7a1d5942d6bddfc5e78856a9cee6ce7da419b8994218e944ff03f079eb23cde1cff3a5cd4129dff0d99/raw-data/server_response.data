<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='*XML functions Bug #64938 - RDF' href='rss/bug.php?id=64938'>
        <link rel='alternate' type='application/rss+xml' title='*XML functions Bug #64938 - RSS 2.0' href='rss/bug.php?id=64938&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #64938 :: libxml_disable_entity_loader setting is shared between requests (FPM)</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=64938">Bug</a>&nbsp;#64938</th>
            <td id="summary" colspan="5">libxml_disable_entity_loader setting is shared between requests (FPM)</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2013-05-28 13:43 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2017-11-27 16:01 UTC</td>
            <td rowspan="6">

                <table id="votes">
                    <tr><th class="details">Votes:</th><td>58</td></tr>
                    <tr><th class="details">Avg. Score:</th><td>4.5 &plusmn; 0.9</td></tr>
                    <tr><th class="details">Reproduced:</th><td>47 of 48 (97.9%)</td></tr>
                    <tr><th class="details">Same Version:</th><td>13 (27.7%)</td></tr>
                    <tr><th class="details">Same OS:</th><td>9 (19.1%)</td></tr>
                </table>

            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>Sjon &#x61;&#116; hortensius &#x64;&#111;&#x74; net</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=remi">remi</a> (<a href="https://people.php.net/remi">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=%2AXML+functions">*XML functions</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.4.15</td>
            <th class="details">OS:</th>
            <td>Archlinux</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8866" target="_blank">2015-8866</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=64938&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=64938&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=64938&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1369748613">&nbsp;</a><strong>[2013-05-28 13:43 UTC] Sjon &#x61;&#116; hortensius &#x64;&#111;&#x74; net</strong>
<pre class='note'>Description:
------------
The libxml_disable_entity_loader() setting is shared between hits in a FPM 
process. Therefore; our script have the external entity-loader randomly 
enabled/disabled.

Test script:
---------------
&lt;?php

die(var_dump(libxml_disable_entity_loader(false)));

Expected result:
----------------
The default setting (which is true since 5.4.13) should always be var_dump-ed

Actual result:
--------------
since this setting is remembered in the thread; after a while all hits return 
false

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=64938'>Add a Patch</a></p><h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/php-src/pull/2944">Fixed bug #64938 libxml_disable_entity_loader setting is shared betwe&acirc;&euro;&brvbar;</a>
      (php-src/2944)</li>
</ul>
</div>
<p><a href='gh-pull-add.php?bug_id=64938'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_related' ><a name="1369812106">&nbsp;</a><strong>[2013-05-29 07:21 UTC] sjon &#x61;&#116; hortensius &#x64;&#111;&#x74; net</strong>
<pre class='note'>Related To: <a href='bug.php?id=62577'>Bug #62577</a>
</pre>
</div><div class='comment type_log' ><a name="1369949426">&nbsp;</a><strong>[2013-05-30 21:30 UTC] Sjon &#x61;&#116; hortensius &#x64;&#111;&#x74; net</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: libxml_disable_entity_loader setting is shared
          between hits</span>
<span class="added">+Summary: libxml_disable_entity_loader setting is shared
          between threads</span>
</div></div></div><div class='comment type_comment' ><a name="1369949426">&nbsp;</a><strong>[2013-05-30 21:30 UTC] Sjon &#x61;&#116; hortensius &#x64;&#111;&#x74; net</strong>
<pre class='note'>Clarified summary
</pre>
</div><div class='comment type_log' ><a name="1381406609">&nbsp;</a><strong>[2013-10-10 12:03 UTC] <a href="//people.php.net/mike">mike@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Package: FPM related</span>
<span class="added">+Package: *XML functions</span>
</div></div></div><div class='comment type_comment' ><a name="1422549890">&nbsp;</a><strong>[2015-01-29 16:44 UTC] stefan &#x64;&#111;&#x74; behninger &#x61;&#116; nasdaq &#x64;&#111;&#x74; com</strong>
<pre class='note'>Seems like this is a much bigger issue. We discovered that disabling the loader does not only affect the current thread but obviously changes the setting globally on the entire server. Plus, it seems to be persisted in a way that only restarting the server got us back to normal.

Planning to do some more tests tomorrow to eliminate any kind of caching that might have been involved.

We're on PHP 5.3.3 on CentOS, strictly single-threaded.
</pre>
</div><div class='comment type_svn' ><a name="1422778208">&nbsp;</a><strong>[2015-02-01 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of martin@divbyzero.net
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=de31324c221c1791b26350ba106cc26bad23ace9" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=de31324c221c1791b26350ba106cc26bad23ace9</a>
Log: Fix <a href='bug.php?id=64938'>bug #64938</a>: libxml_disable_entity_loader setting is shared between threads
</pre>
</div><div class='comment type_log' ><a name="1422778208">&nbsp;</a><strong>[2015-02-01 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1422778211">&nbsp;</a><strong>[2015-02-01 08:10 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of martin@divbyzero.net
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=c1eb87ab1a2e2df1868b70cd7b8016c6147092c5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=c1eb87ab1a2e2df1868b70cd7b8016c6147092c5</a>
Log: Fix <a href='bug.php?id=64938'>bug #64938</a>: libxml_disable_entity_loader setting is shared between threads
</pre>
</div><div class='comment type_comment' ><a name="1430308661">&nbsp;</a><strong>[2015-04-29 11:57 UTC] freitsabes &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Sorry, but I would like to ask for clarification:
For php-cgi I see the following behaviour:
1. I issue a request that has a call of libxml_disable_entity_loader()
2. A subsequent request to a different script that is NOT calling libxml_disable_entity_loader is affected by the first request because the setting is shared between subsequent requests on the same process.

Is this a bug or working as intended?

PHP 5.4.39 with libxml 2.9.2
</pre>
</div><div class='comment type_comment' ><a name="1444999560">&nbsp;</a><strong>[2015-10-16 12:46 UTC] mark &#x61;&#116; netalico &#x64;&#111;&#x74; com</strong>
<pre class='note'>Any suggested workarounds for this issue? This bug is pretty critical because it can basically take down sites running something like Magento. It appears to only be fixed in PHP 5.6, which a lot of codebases aren't ready for yet.
</pre>
</div><div class='comment type_comment' ><a name="1448441573">&nbsp;</a><strong>[2015-11-25 08:52 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>Also fixed in 5.5.22 (per the commits above).
</pre>
</div><div class='comment type_comment' ><a name="1450787184">&nbsp;</a><strong>[2015-12-22 12:26 UTC] robert &#x64;&#111;&#x74; egginton &#x61;&#116; c3media &#x64;&#111;&#x74; co &#x64;&#111;&#x74; uk</strong>
<pre class='note'>I'm using 5.5.30 and php-fpm and can reproduce the problem by using the inverse of the script:

Test script:
---------------
&lt;?php

die(var_dump(libxml_disable_entity_loader(true)));

---------------

The default seems to be false for me. After a few hits the results all end up true, so somehow this value is persisting within php-fpm children.
</pre>
</div><div class='comment type_comment' ><a name="1450787754">&nbsp;</a><strong>[2015-12-22 12:35 UTC] robert &#x64;&#111;&#x74; egginton &#x61;&#116; c3media &#x64;&#111;&#x74; co &#x64;&#111;&#x74; uk</strong>
<pre class='note'>For mark at netalico dot com:

The workaround for something like Magento (not required for CE&gt;1.9.2.0 when a workaround was added) is to add this line to the start of your script:

if (function_exists('libxml_disable_entity_loader')) {
    libxml_disable_entity_loader(false);
}
</pre>
</div><div class='comment type_log' ><a name="1461662064">&nbsp;</a><strong>[2016-04-26 09:14 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: remi</span>
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID:      2015-8866</span>
</div></div></div><div class='comment type_svn' ><a name="1469014782">&nbsp;</a><strong>[2016-07-20 11:39 UTC] <a href="//people.php.net/davey">davey@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of martin@divbyzero.net
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=c1eb87ab1a2e2df1868b70cd7b8016c6147092c5" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=c1eb87ab1a2e2df1868b70cd7b8016c6147092c5</a>
Log: Fix <a href='bug.php?id=64938'>bug #64938</a>: libxml_disable_entity_loader setting is shared between threads
</pre>
</div><div class='comment type_comment' ><a name="1476095246">&nbsp;</a><strong>[2016-10-10 10:27 UTC] robert &#x64;&#111;&#x74; egginton &#x61;&#116; c3media &#x64;&#111;&#x74; co &#x64;&#111;&#x74; uk</strong>
<pre class='note'>I can confirm that I still get the issue with 7.0.11. I run my above checking script and after a few runs all entries come out as true, so this is still not thread safe.
</pre>
</div><div class='comment type_comment' ><a name="1476264820">&nbsp;</a><strong>[2016-10-12 09:33 UTC] ntd &#x61;&#116; entidi &#x64;&#111;&#x74; it</strong>
<pre class='note'>The problem is still present in php-fpm 5.6.26 (debian 8.6).

Commit c1eb87ab1a2e2df1868b70cd7b8016c6147092c5 was pushed 20 months ago, so I suppose it did not fix the problem.
</pre>
</div><div class='comment type_log' ><a name="1476452284">&nbsp;</a><strong>[2016-10-14 13:38 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Closed</span>
<span class="added">+Status: Re-Opened</span>
</div></div></div><div class='comment type_comment' ><a name="1476452284">&nbsp;</a><strong>[2016-10-14 13:38 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Re-opened according to recent user comments (thanks!)
</pre>
</div><div class='comment type_log' ><a name="1508822141">&nbsp;</a><strong>[2017-10-24 05:15 UTC] <a href="//people.php.net/kalle">kalle@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Re-Opened</span>
<span class="added">+Status: Assigned</span>
</div></div></div><div class='comment type_comment' ><a name="1511798384">&nbsp;</a><strong>[2017-11-27 15:59 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<pre class='note'>Can someone test this simple fix proposal

diff --git a/ext/libxml/libxml.c b/ext/libxml/libxml.c
index d88860c..bfc1224 100644
--- a/ext/libxml/libxml.c
+++ b/ext/libxml/libxml.c
@@ -848,7 +848,6 @@ static PHP_MINIT_FUNCTION(libxml)
        if (sapi_module.name) {
                static const char * const supported_sapis[] = {
                        &quot;cgi-fcgi&quot;,
-                       &quot;fpm-fcgi&quot;,
                        &quot;litespeed&quot;,
                        NULL
                };
</pre>
</div><div class='comment type_log' ><a name="1511798499">&nbsp;</a><strong>[2017-11-27 16:01 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Summary: libxml_disable_entity_loader setting is shared
          between threads</span>
<span class="added">+Summary: libxml_disable_entity_loader setting is shared
          between requests (FPM)</span>
</div></div></div><div class='comment type_svn' ><a name="1511888454">&nbsp;</a><strong>[2017-11-28 17:00 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of remi@remirepo.net
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=8e5b9532da0308c50c9cb316e9fda530becdc543" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=8e5b9532da0308c50c9cb316e9fda530becdc543</a>
Log: Fixed <a href='bug.php?id=64938'>bug #64938</a> libxml_disable_entity_loader setting is shared between requests (FPM)
</pre>
</div><div class='comment type_log' ><a name="1511888455">&nbsp;</a><strong>[2017-11-28 17:00 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1511956869">&nbsp;</a><strong>[2017-11-29 12:01 UTC] maunel-php &#x61;&#116; mausz &#x64;&#111;&#x74; at</strong>
<pre class='note'>@remi

Just noticed that there's a bug report for this. We're shipping the following patch since noticing the issue ourself:

diff -Naur php-7.2.0.orig/ext/libxml/libxml.c php-7.2.0/ext/libxml/libxml.c
--- php-7.2.0.orig/ext/libxml/libxml.c  2017-11-12 19:03:42.890478753 +0100
+++ php-7.2.0/ext/libxml/libxml.c       2017-11-12 19:03:58.510298201 +0100
@@ -880,13 +880,14 @@
                xmlSetGenericErrorFunc(NULL, php_libxml_error_handler);
                xmlParserInputBufferCreateFilenameDefault(php_libxml_input_buffer_create_filename);
                xmlOutputBufferCreateFilenameDefault(php_libxml_output_buffer_create_filename);
-
-               /* Enable the entity loader by default. This ensures that
-                * other threads/requests that might have disabled the loader
-                * do not affect the current request.
-                */
-               LIBXML(entity_loader_disabled) = 0;
        }
+
+       /* Enable the entity loader by default. This ensures that
+        * other threads/requests that might have disabled the loader
+        * do not affect the current request.
+        */
+       LIBXML(entity_loader_disabled) = 0;
+
        return SUCCESS;
 }

No idea which one is better. Just wanted to share this.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
