<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #70755 - RDF' href='rss/bug.php?id=70755'>
        <link rel='alternate' type='application/rss+xml' title='FPM related Bug #70755 - RSS 2.0' href='rss/bug.php?id=70755&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #70755 :: fpm_log.c memory leak and buffer overflow</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=70755">Sec Bug</a>&nbsp;#70755</th>
            <td id="summary" colspan="5">fpm_log.c memory leak and buffer overflow</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-10-21 08:54 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2016-05-29 11:31 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>imre &#x64;&#111;&#x74; rad &#x61;&#116; search-lab &#x64;&#111;&#x74; hu</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=FPM+related">FPM related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.14</td>
            <th class="details">OS:</th>
            <td>All</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-5114" target="_blank">2016-5114</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=70755&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=70755&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=70755&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1445417660">&nbsp;</a><strong>[2015-10-21 08:54 UTC] imre &#x64;&#111;&#x74; rad &#x61;&#116; search-lab &#x64;&#111;&#x74; hu</strong>
<pre class='note'>Description:
------------
After adding %{REQUEST_URI}e to the end of the access.format option of the PHP-FPM ini, I noticed binary output appearing in the access log file. (I find this feature quite useful because it helps understanding the current workload in case of rewritten URLs)

At line 237 of php-fpm.c:
len2 = snprintf(b, FPM_LOG_BUFFER - len, &quot;%s&quot;, env ? env : &quot;-&quot;);

From snprintf() manual:
The functions snprintf() and vsnprintf() do not write more than size bytes (including the terminating null byte ('\0')). If the output was truncated due to this limit then the return value is the number of characters (excluding the terminating null byte) which would have been written to the final string if enough space had been available. 


The full length (len) is increased by len2 at line 449:
len += len2;

After exiting the loop, a \n byte is written outside of the compiled buffer and the log line along with some memory area lying after it is flushed into the access log:

	if (!test &amp;&amp; strlen(buffer) &gt; 0) {
 		buffer[len] = '\n';
		write(fpm_log_fd, buffer, len + 1);
	}


I classify the above vulnerability as memory leak and limited buffer overflow.
Due to the pre-requisites, I consider severity of this vulnerability as low.

Are you going to make a CVE identifier assigned to it or should I report to MITRE independently?



Test script:
---------------
The access.format looked like this (it is important to have the long stuff as the last token in the format string):

access.format = %{HTTP_HOST}e %R [%t] %m %r%Q%q %p %{user}C %{system}C %{total}C %{kilo}M %{mili}d %s %f %{REMOTE_ADDR}e %{REQUEST_URI}e

Send a HTTP request with long query string then.


Expected result:
----------------
Too long lines in the access log should be cutted in some way, for eg like this:

foobar.info 127.0.0.1 [17/Jul/2015:19:21:37 +0200] GET /wp-admin/load-scripts.php?c=1&amp;load%5B%5D=hoverIntent,common,admin-bar,suggest,inline-edit-post,heartbeat,svg-painter,wp-auth-check,jquery-ui-core,jquery-ui-widget,jquery&amp;load%5B%5D=-ui-tabs,jquery-ui-mouse,jquery-ui-draggable,jquery-ui-slider,jquery-touch-punch,iris,wp-color-picker,jquery-ui-accordion,jquery&amp;load%5B%5D=-ui-position,jquery-ui-menu,jquery-ui-autocomplete,jquery-ui-sortable,backbone,wp-util,wp-backbone,media-models,wp-plupload,medi&amp;load%5B%5D=aelement,wp-mediaelement,media-views,media-editor,media-audiovideo,wp-playli 17109 81.10 40.55 121.64 2816 24.662 200 /foobar.info/pages/wp-admin/load-scripts.php 5.38.155.205 /wp-admin/load-scripts.php?c=1&amp;load%5B%5D=hoverIntent,common,admin-bar,suggest,inline-edit-post,heartbeat,svg-painter,wp-auth-check,jquery-ui-core,jquery-ui-widget,jquery&amp;load%5B%5D=-ui-tabs,jquery-ui-mouse,jquery-ui-draggable,jquery-ui-slider,jquery-touch-punch,iris,wp-color-picker,jquery-ui-accordion,jquery&amp;load%5B%5D=-ui-posi...



Actual result:
--------------
A sample line from the access log:


foobar.info 127.0.0.1 [17/Jul/2015:19:21:37 +0200] GET /wp-admin/load-scripts.php?c=1&amp;load%5B%5D=hoverIntent,common,admin-bar,suggest,inline-edit-post,heartbeat,svg-painter,wp-auth-check,jquery-ui-core,jquery-ui-widget,jquery&amp;load%5B%5D=-ui-tabs,jquery-ui-mouse,jquery-ui-draggable,jquery-ui-slider,jquery-touch-punch,iris,wp-color-picker,jquery-ui-accordion,jquery&amp;load%5B%5D=-ui-position,jquery-ui-menu,jquery-ui-autocomplete,jquery-ui-sortable,backbone,wp-util,wp-backbone,media-models,wp-plupload,medi&amp;load%5B%5D=aelement,wp-mediaelement,media-views,media-editor,media-audiovideo,wp-playli 17109 81.10 40.55 121.64 2816 24.662 200 /foobar.info/pages/wp-admin/load-scripts.php 5.38.155.205 /wp-admin/load-scripts.php?c=1&amp;load%5B%5D=hoverIntent,common,admin-bar,suggest,inline-edit-post,heartbeat,svg-painter,wp-auth-check,jquery-ui-core,jquery-ui-widget,jquery&amp;load%5B%5D=-ui-tabs,jquery-ui-mouse,jquery-ui-draggable,jquery-ui-slider,jquery-touch-punch,iris,wp-color-picker,jquery-ui-accordion,jquery&amp;load%5B%5D=-ui-posi^@^@^@^@^@^@^@^@^@ è&lt;97&gt; ü^?^@^@^A^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^A^@^@^@^@^@^@^@¡9©U^@^@^@^@ÕB^@^@^@^@^@^@^B^@^@^@^@^@^@^@^F^@^@^@^@^@^@^@¯D&lt;93&gt;^@^@^@^@^@l^C^B^@^@^@^@^@^@^@^@^@^@^@^@^@V`^@^@^@^@^@^@¡9©U^@^@^@^@¯D&lt;93&gt;^@^@^@^@^@Âc^B^@^@^@^@^@/wp-admin/load-scripts.php^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@c=1&amp;load%5B%5D=hoverIntent,com



</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=70755'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=70755'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1449562160">&nbsp;</a><strong>[2015-12-08 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1449562160">&nbsp;</a><strong>[2015-12-08 08:09 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Please try the following patch: 

diff --git a/sapi/fpm/fpm/fpm_log.c b/sapi/fpm/fpm/fpm_log.c
index b0bf32a..187fe9b 100644
--- a/sapi/fpm/fpm/fpm_log.c
+++ b/sapi/fpm/fpm/fpm_log.c
@@ -448,6 +448,11 @@ int fpm_log_write(char *log_format TSRMLS_DC) /* {{{ */
                                b += len2;
                                len += len2;
                        }
+                       if (len &gt;= FPM_LOG_BUFFER) {
+                               zlog(ZLOG_NOTICE, &quot;the log buffer is full (%d). The access log request has been truncated.&quot;, FPM_LOG_BUFFER);
+                               len = FPM_LOG_BUFFER;
+                               break;
+                       }
                        continue;
                }
</pre>
</div><div class='comment type_comment' ><a name="1449733025">&nbsp;</a><strong>[2015-12-10 07:37 UTC] imre &#x64;&#111;&#x74; rad &#x61;&#116; search-lab &#x64;&#111;&#x74; hu</strong>
<pre class='note'>I've tested it using this simple Perl script: <a href="http://pastebin.com/XE9cSejA" rel="nofollow">http://pastebin.com/XE9cSejA</a>

It works as expected; thank you for the patch.
</pre>
</div><div class='comment type_comment' ><a name="1451334731">&nbsp;</a><strong>[2015-12-28 20:32 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>In security repo as commit be19dbcb84fea0001e53cea2732c00de7ae6c371
</pre>
</div><div class='comment type_log' ><a name="1452050359">&nbsp;</a><strong>[2016-01-06 03:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1452050359">&nbsp;</a><strong>[2016-01-06 03:19 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_svn' ><a name="1452051522">&nbsp;</a><strong>[2016-01-06 03:38 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_svn' ><a name="1452062053">&nbsp;</a><strong>[2016-01-06 06:34 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_svn' ><a name="1452062059">&nbsp;</a><strong>[2016-01-06 06:34 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_svn' ><a name="1452062075">&nbsp;</a><strong>[2016-01-06 06:34 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_svn' ><a name="1452062080">&nbsp;</a><strong>[2016-01-06 06:34 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=be19dbcb84fea0001e53cea2732c00de7ae6c371</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_svn' ><a name="1452062107">&nbsp;</a><strong>[2016-01-06 06:35 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=2721a0148649e07ed74468f097a28899741eb58f" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=2721a0148649e07ed74468f097a28899741eb58f</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div><div class='comment type_comment' ><a name="1454410472">&nbsp;</a><strong>[2016-02-02 10:54 UTC] korvin1986 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hello, 
is any CVE-ID exists for this vulnerability?
Or have I request it at <a href="http://www.cve.mitre.org" rel="nofollow">http://www.cve.mitre.org</a> ?
</pre>
</div><div class='comment type_comment' ><a name="1464325633">&nbsp;</a><strong>[2016-05-27 05:07 UTC] henri &#x61;&#116; nerv &#x64;&#111;&#x74; fi</strong>
<pre class='note'>2016-01-30: CVE request was made directly to MITRE.
2016-02-02: CVE request in oss-security mailing list: <a href="http://www.openwall.com/lists/oss-security/2016/02/02/4" rel="nofollow">http://www.openwall.com/lists/oss-security/2016/02/02/4</a>
2016-05-27: Discussing with MITRE again to get this assigned.
</pre>
</div><div class='comment type_comment' ><a name="1464516068">&nbsp;</a><strong>[2016-05-29 10:01 UTC] henri &#x61;&#116; nerv &#x64;&#111;&#x74; fi</strong>
<pre class='note'>MITRE responds <a href="http://www.openwall.com/lists/oss-security/2016/05/29/1" rel="nofollow">http://www.openwall.com/lists/oss-security/2016/05/29/1</a> following:

As explained in the www.search-lab.hu post (in the section between &quot;We
found the answer by reviewing the source code&quot; and &quot;And here we are&quot;),
there was really only one underlying problem: the code misinterpreted
the semantics of the snprintf return value. Use CVE-2016-5114. The
other outcomes were consequences of this. The &quot;memory leak&quot; is the
same as the &quot;out-of-boundaries read&quot;: extra bytes from process memory
were being written to a log file that might be readable by untrusted
users. The &quot;buffer overflow&quot; is the same as the &quot;wrote a \n character
outside of the allocated memory.&quot;
</pre>
</div><div class='comment type_log' ><a name="1464521491">&nbsp;</a><strong>[2016-05-29 11:31 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2016-5114</span>
</div></div></div><div class='comment type_svn' ><a name="1469014462">&nbsp;</a><strong>[2016-07-20 11:34 UTC] <a href="//people.php.net/davey">davey@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=2eaa7556605ffc0d78c89965f5e905cf801207ef</a>
Log: Fixed <a href='bug.php?id=70755'>bug #70755</a>: fpm_log.c memory leak and buffer overflow
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
