<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='GNU MP related Bug #74308 - RDF' href='rss/bug.php?id=74308'>
        <link rel='alternate' type='application/rss+xml' title='GNU MP related Bug #74308 - RSS 2.0' href='rss/bug.php?id=74308&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Bug #74308 :: Memory corruption in gmp_powm</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=74308">Bug</a>&nbsp;#74308</th>
            <td id="summary" colspan="5">Memory corruption in gmp_powm</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2017-03-24 10:34 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2017-08-12 01:07 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td></td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Wont fix</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=GNU+MP+related">GNU MP related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.1.3</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><em>None</em></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=74308&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=74308&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=74308&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>

<form id="vote" method="post" action="vote.php">
    <div class="sect">
        <fieldset>
            <legend>Have you experienced this issue?</legend>
            <div>
                <input type="radio" id="rep-y" name="reproduced" value="1" onchange="show('canreproduce')"> <label for="rep-y">yes</label>
                <input type="radio" id="rep-n" name="reproduced" value="0" onchange="hide('canreproduce')"> <label for="rep-n">no</label>
                <input type="radio" id="rep-d" name="reproduced" value="2" onchange="hide('canreproduce')" checked="checked"> <label for="rep-d">don't know</label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Rate the importance of this bug to you:</legend>
            <div>
                <label for="score-5">high</label>
                <input type="radio" id="score-5" name="score" value="2">
                <input type="radio" id="score-4" name="score" value="1">
                <input type="radio" id="score-3" name="score" value="0" checked="checked">
                <input type="radio" id="score-2" name="score" value="-1">
                <input type="radio" id="score-1" name="score" value="-2">
                <label for="score-1">low</label>
            </div>
        </fieldset>
    </div>
    <div id="canreproduce" class="sect" style="display: none">
        <fieldset>
            <legend>Are you using the same PHP version?</legend>
            <div>
                <input type="radio" id="ver-y" name="samever" value="1"> <label for="ver-y">yes</label>
                <input type="radio" id="ver-n" name="samever" value="0" checked="checked"> <label for="ver-n">no</label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Are you using the same operating system?</legend>
            <div>
                <input type="radio" id="os-y" name="sameos" value="1"> <label for="os-y">yes</label>
                <input type="radio" id="os-n" name="sameos" value="0" checked="checked"> <label for="os-n">no</label>
            </div>
        </fieldset>
    </div>
    <div id="submit" class="sect">
        <input type="hidden" name="id" value="74308">
        <input type="submit" value="Vote">
    </div>
</form>
<br clear="all">


<div class='comment type_comment' ><a name="1490351662">&nbsp;</a><strong>[2017-03-24 10:34 UTC] whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
I found it via Black-box Testing.It looks like the libgmp's problem.And I think it's a security bug for memory corruption.
My test environment：
root@mhn:~# /usr/local/php/bin/php -v
PHP 7.1.3 (cli) (built: Mar 24 2017 13:29:12) ( ZTS )
Copyright (c) 1997-2017 The PHP Group
Zend Engine v3.1.0, Copyright (c) 1998-2017 Zend Technologies

And gmp's version is 6.1.2.

Test script:
---------------
&lt;?php
ini_set('memory_limit',-1);
$a=str_repeat(&quot;1&quot;,0x80000000);

var_dump(gmp_powm(&quot;1&quot;,$a ,200));

?&gt;

Expected result:
----------------
no crash

Actual result:
--------------
root@mhn:~# gdb --q --args ./php-7.1.3/sapi/cli/php -n test.php
Reading symbols from ./php-7.1.3/sapi/cli/php...done.
(gdb) r
Starting program: /root/php-7.1.3/sapi/cli/php -n test.php
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
GNU MP: Cannot allocate memory (size=2147483665)

Program received signal SIGABRT, Aborted.
0x00007ffff5720c37 in __GI_raise (sig=sig@entry=6)
    at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
56	../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  0x00007ffff5720c37 in __GI_raise (sig=sig@entry=6)
    at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007ffff5724028 in __GI_abort () at abort.c:89
#2  0x00007ffff75072a5 in __gmp_default_allocate ()
   from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#3  0x00007ffff7507b89 in __gmp_tmp_reentrant_alloc ()
   from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#4  0x00007ffff751d76f in __gmpz_set_str () from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#5  0x00000000005e9ada in convert_to_gmp (gmpnumber=0x7fffffffad50, 
    val=&lt;optimized out&gt;, base=&lt;optimized out&gt;) at /root/php-7.1.3/ext/gmp/gmp.c:738
#6  0x00000000005ec6af in zif_gmp_powm (execute_data=&lt;optimized out&gt;, 
    return_value=0x7ffff12130c0) at /root/php-7.1.3/ext/gmp/gmp.c:1427
#7  0x00000000008bcfb7 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER ()
    at /root/php-7.1.3/Zend/zend_vm_execute.h:675
#8  0x00000000008abe73 in execute_ex (ex=&lt;optimized out&gt;)
    at /root/php-7.1.3/Zend/zend_vm_execute.h:429
#9  0x0000000000907edb in zend_execute (op_array=&lt;optimized out&gt;, 
    return_value=&lt;optimized out&gt;) at /root/php-7.1.3/Zend/zend_vm_execute.h:474
#10 0x0000000000861d47 in zend_execute_scripts (type=type@entry=8, 
    retval=retval@entry=0x0, file_count=file_count@entry=3)
    at /root/php-7.1.3/Zend/zend.c:1476
#11 0x00000000007f2010 in php_execute_script (
    primary_file=primary_file@entry=0x7fffffffd290) at /root/php-7.1.3/main/main.c:2537
#12 0x000000000090a355 in do_cli (argc=3, argv=0x11f8a30)
    at /root/php-7.1.3/sapi/cli/php_cli.c:993
#13 0x0000000000440d3a in main (argc=3, argv=0x11f8a30)
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
    at /root/php-7.1.3/sapi/cli/php_cli.c:1381

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=74308'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=74308'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1490416280">&nbsp;</a><strong>[2017-03-25 04:31 UTC] whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Most of functions for GNU Mp related have the same problem.
</pre>
</div><div class='comment type_comment' ><a name="1490441790">&nbsp;</a><strong>[2017-03-25 11:36 UTC] whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Take this function （gmp_scan0) as an example
test script
&lt;?php
ini_set('memory_limit',-1);
$a=str_repeat(&quot;1&quot;,0xffffffff);
gmp_scan0($a,0xffffffff);
--------------------------------------------------------
crash information：
root@mhn:~# /usr/local/php/bin/php test.php 
GNU MP: Cannot allocate memory (size=4294967312)
Aborted (core dumped)
--------------------------------------------------------
root@mhn:~# gdb -q --args ./php-7.1.3/sapi/cli/php -n test.php
Reading symbols from ./php-7.1.3/sapi/cli/php...done.
(gdb) r
Starting program: /root/php-7.1.3/sapi/cli/php -n test.php
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
GNU MP: Cannot allocate memory (size=4294967312)

Program received signal SIGABRT, Aborted.
0x00007ffff5720c37 in __GI_raise (sig=sig@entry=6)
    at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
56	../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  0x00007ffff5720c37 in __GI_raise (sig=sig@entry=6)
    at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007ffff5724028 in __GI_abort () at abort.c:89
#2  0x00007ffff75072a5 in __gmp_default_allocate ()
   from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#3  0x00007ffff7507b89 in __gmp_tmp_reentrant_alloc ()
   from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#4  0x00007ffff751d76f in __gmpz_set_str () from /usr/lib/x86_64-linux-gnu/libgmp.so.10
#5  0x00000000005e9ada in convert_to_gmp (gmpnumber=0x7fffffffad70, 
    val=&lt;optimized out&gt;, base=&lt;optimized out&gt;) at /root/php-7.1.3/ext/gmp/gmp.c:738
#6  0x00000000005ea4c8 in zif_gmp_scan0 (execute_data=&lt;optimized out&gt;, 
    return_value=0x7fffffffadc0) at /root/php-7.1.3/ext/gmp/gmp.c:2050
#7  0x00000000008bd1bd in ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER ()
    at /root/php-7.1.3/Zend/zend_vm_execute.h:628
#8  0x00000000008abe73 in execute_ex (ex=&lt;optimized out&gt;)
    at /root/php-7.1.3/Zend/zend_vm_execute.h:429
#9  0x0000000000907edb in zend_execute (op_array=&lt;optimized out&gt;, 
    return_value=&lt;optimized out&gt;) at /root/php-7.1.3/Zend/zend_vm_execute.h:474
#10 0x0000000000861d47 in zend_execute_scripts (type=type@entry=8, 
    retval=retval@entry=0x0, file_count=file_count@entry=3)
    at /root/php-7.1.3/Zend/zend.c:1476
#11 0x00000000007f2010 in php_execute_script (
    primary_file=primary_file@entry=0x7fffffffd290) at /root/php-7.1.3/main/main.c:2537
#12 0x000000000090a355 in do_cli (argc=3, argv=0x11f8a30)
    at /root/php-7.1.3/sapi/cli/php_cli.c:993
#13 0x0000000000440d3a in main (argc=3, argv=0x11f8a30)
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
    at /root/php-7.1.3/sapi/cli/php_cli.c:1381
</pre>
</div><div class='comment type_log' ><a name="1490561951">&nbsp;</a><strong>[2017-03-26 20:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type: Security</span>
<span class="added">+Type: Bug</span>
</div></div></div><div class='comment type_comment' ><a name="1490699074">&nbsp;</a><strong>[2017-03-28 11:04 UTC] whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Is there anyone dealing with the problem?
</pre>
</div><div class='comment type_comment' ><a name="1490702997">&nbsp;</a><strong>[2017-03-28 12:09 UTC] <a href="//people.php.net/nikic">nikic@php.net</a></strong>
<pre class='note'>I don't think we're going to fix OOM issues in GMP. It is not possible for us to replace the GMP allocator functions due to conflicts with other libraries using GMP (we used to do this, it does not work robustly).

There is no security issue here, because GMP safely aborts in case of an OOM condition. The only attack vector here is denial of service. However, if you allow attacker-controlled, unbounded allocations you have a DOS vector regardless of GMPs OOM behavior.
</pre>
</div><div class='comment type_comment' ><a name="1490703809">&nbsp;</a><strong>[2017-03-28 12:23 UTC] whitehat002 &#x61;&#116; hotmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>I venture to ask who should deal with the problem.
</pre>
</div><div class='comment type_log' ><a name="1502500075">&nbsp;</a><strong>[2017-08-12 01:07 UTC] <a href="//people.php.net/ajf">ajf@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Wont fix</span>
</div></div></div><div class='comment type_comment' ><a name="1502500075">&nbsp;</a><strong>[2017-08-12 01:07 UTC] <a href="//people.php.net/ajf">ajf@php.net</a></strong>
<pre class='note'>Fixing OOM issues for GMP is essentially a “wouldn't it be nice” thing. Unless and until GMP is baked into the core language as a data type, rather than an optional extension, it's probably not going to be fixed.
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
