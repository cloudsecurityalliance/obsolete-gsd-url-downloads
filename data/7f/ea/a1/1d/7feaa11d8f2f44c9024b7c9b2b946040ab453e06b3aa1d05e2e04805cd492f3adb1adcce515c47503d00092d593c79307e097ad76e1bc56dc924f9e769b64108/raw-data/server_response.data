<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Zip Related Bug #69253 - RDF' href='rss/bug.php?id=69253'>
        <link rel='alternate' type='application/rss+xml' title='Zip Related Bug #69253 - RSS 2.0' href='rss/bug.php?id=69253&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #69253 :: ZIP Integer Overflow leads to writing past heap boundary</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=69253">Sec Bug</a>&nbsp;#69253</th>
            <td id="summary" colspan="5">ZIP Integer Overflow leads to writing past heap boundary</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-03-18 03:54 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-03-20 05:49 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>emmanuel &#x64;&#111;&#x74; law &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Zip+Related">Zip Related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.6</td>
            <th class="details">OS:</th>
            <td>*nix</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-2331" target="_blank">2015-2331</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=69253&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=69253&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=69253&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1426650854">&nbsp;</a><strong>[2015-03-18 03:54 UTC] emmanuel &#x64;&#111;&#x74; law &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Description:
------------ 
PHP &lt;= 5.6.6 has a Integer overflow vulnerability when opening a ZipArchive with a large number of entries. This results in writing pass the heap boundary and crashing PHP.

Configuration:
-------------
./configure --enable-zip 




Test script:
---------------
&lt;?php

$path = $argv[1];

$zip = new ZipArchive;
if ($zip-&gt;open($path) === true) {
echo &quot;OPEN!&quot;;

}
$zip-&gt;close();
?&gt;

Actual result:
--------------
Technical Details:
------------------
./php  testzip.php fuzz.zip


Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x89f6ff8 --&gt; 0x0
EBX: 0x0
ECX: 0xb7dcb3a0 --&gt; 0x0
EDX: 0x89c64b8 --&gt; 0x0
ESI: 0x30 ('0')
EDI: 0x0
EBP: 0xbfffbd88 --&gt; 0xbfffbe38 --&gt; 0xbfffbec8 --&gt; 0xbfffbf58 --&gt; 0xbfffbf88 --&gt; 0xbfffbfb8 --&gt; 0xbfffc018 --&gt; 0xbfffc088 --&gt; 0xbfffc098 --&gt; 0xbfffc0c8 --&gt; 0xbfffc0e8 --&gt; 0xbfffc148 --&gt; 0xbfffe2e8 --&gt; 0xbffff4d8 --&gt; 0xbffff5e8 --&gt; 0xbffff658 --&gt; 0x0
ESP: 0xbfffbd50 --&gt; 0x89f6ff8 --&gt; 0x0
EIP: 0x8391390 (&lt;_zip_cdir_new+219&gt;:    add    DWORD PTR [ebp-0x8],0x1)
EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)

[-------------------------------------code-------------------------------------]
   0x8393c5a &lt;_zip_entry_init+12&gt;:      mov    eax,DWORD PTR [ebp+0x8]
   0x8393c5d &lt;_zip_entry_init+15&gt;:      mov    DWORD PTR [eax+0x4],0x0
   0x8393c64 &lt;_zip_entry_init+22&gt;:      mov    eax,DWORD PTR [ebp+0x8]
=&gt; 0x8393c67 &lt;_zip_entry_init+25&gt;:      mov    DWORD PTR [eax+0x8],0x0
   0x8393c6e &lt;_zip_entry_init+32&gt;:      mov    eax,DWORD PTR [ebp+0x8]
   0x8393c71 &lt;_zip_entry_init+35&gt;:      mov    DWORD PTR [eax+0xc],0x0
   0x8393c78 &lt;_zip_entry_init+42&gt;:      pop    ebp


gdb-peda$ info proc mappings
process 15992
Mapped address spaces:

                        Start Addr   End Addr       Size     Offset objfile
                        0x8048000  0x88c7000   0x87f000        0x0 /root/php-5.6.6/sapi/cli/php
                        0x88c7000  0x88c8000     0x1000   0x87e000 /root/php-5.6.6/sapi/cli/php
                        0x88c8000  0x88d0000     0x8000   0x87f000 /root/php-5.6.6/sapi/cli/php
Heap OverFlow==&gt;        0x88d0000  0x89f7000   0x127000        0x0 [heap]
                        0xb7a95000 0xb7ac0000    0x2b000        0x0
		        ...............


The vulnerability is in zip_dirent.c:113
	else if ((cd-&gt;entry=(struct zip_entry *)malloc(sizeof(*(cd-&gt;entry))*(size_t)nentry)) == NULL) {

whereby sizeof(*(cd-&gt;entry)) * nentry results in an integer overflow


The crash will be trigger later on when writing past the heap boundary:

#1  0x08391390 in _zip_cdir_new (nentry=0x3000000000000000, error=0xbfffbf14) at /root/php-5.6.6/ext/zip/lib/zip_dirent.c:120
120             _zip_entry_init(cd-&gt;entry+i);

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=69253'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=69253'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1426651164">&nbsp;</a><strong>[2015-03-18 03:59 UTC] emmanuel &#x64;&#111;&#x74; law &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Backtrace
---------

gdb-peda$ bt
#0  0x08393c67 in _zip_entry_init (e=0x89f6ff8) at /root/php-5.6.6/ext/zip/lib/zip_entry.c:53
#1  0x08391390 in _zip_cdir_new (nentry=0x3000000000000000, error=0xbfffbf14) at /root/php-5.6.6/ext/zip/lib/zip_dirent.c:120
#2  0x08398fa6 in _zip_read_eocd64 (f=0x89c6820, eocd64loc=0x89c69c0 &quot;&quot;, buf=0x89c6988 &quot;&quot;, buf_offset=0x0, buflen=0x62, flags=0x0, error=0xbfffbf14)
    at /root/php-5.6.6/ext/zip/lib/zip_open.c:734
#3  0x083977de in _zip_readcdir (fp=0x89c6820, buf_offset=0x0, buf=0x89c6988 &quot;&quot;, eocd=0x89c69d4 &quot;&quot;, buflen=0x62, flags=0x0, error=0xbfffbf14)
    at /root/php-5.6.6/ext/zip/lib/zip_open.c:229
#4  0x0839866a in _zip_find_central_dir (fp=0x89c6820, flags=0x0, zep=0xbfffbfe4, len=0x62) at /root/php-5.6.6/ext/zip/lib/zip_open.c:539
#5  0x08397568 in _zip_open (fn=0xb7c2818c &quot;/root/php-5.6.6/sapi/cli/fuzz_temp_minimize_output&quot;, fp=0x89c6820, flags=0x0, zep=0xbfffbfe4)
    at /root/php-5.6.6/ext/zip/lib/zip_open.c:147
#6  0x08397436 in zip_open (fn=0xb7c2818c &quot;/root/php-5.6.6/sapi/cli/fuzz_temp_minimize_output&quot;, _flags=0x0, zep=0xbfffbfe4) at /root/php-5.6.6/ext/zip/lib/zip_open.c:100
#7  0x08389fb5 in c_ziparchive_open (ht=0x1, return_value=0xb7c26774, return_value_ptr=0xb7c09148, this_ptr=0xb7c267b4, return_value_used=0x1)
    at /root/php-5.6.6/ext/zip/php_zip.c:1568
#8  0x0845e6d0 in zend_do_fcall_common_helper_SPEC (execute_data=0xb7c091c4) at /root/php-5.6.6/Zend/zend_vm_execute.h:558
#9  0x0845f243 in ZEND_DO_FCALL_BY_NAME_SPEC_HANDLER (execute_data=0xb7c091c4) at /root/php-5.6.6/Zend/zend_vm_execute.h:693
#10 0x0845ddc7 in execute_ex (execute_data=0xb7c091c4) at /root/php-5.6.6/Zend/zend_vm_execute.h:363
#11 0x0845de2b in zend_execute (op_array=0xb7c27020) at /root/php-5.6.6/Zend/zend_vm_execute.h:388
#12 0x08424e96 in zend_execute_scripts (type=0x8, retval=0x0, file_count=0x3) at /root/php-5.6.6/Zend/zend.c:1341
#13 0x083a28a9 in php_execute_script (primary_file=0xbffff428) at /root/php-5.6.6/main/main.c:2578
#14 0x084c5844 in do_cli (argc=0x3, argv=0x88e9bc8) at /root/php-5.6.6/sapi/cli/php_cli.c:994
#15 0x084c67e1 in main (argc=0x3, argv=0x88e9bc8) at /root/php-5.6.6/sapi/cli/php_cli.c:1378
#16 0xb7c7bc05 in __libc_start_main () from /lib/libc.so.6
#17 0x08067141 in _start () at ../sysdeps/i386/elf/start.S:119
</pre>
</div><div class='comment type_log' ><a name="1426653310">&nbsp;</a><strong>[2015-03-18 04:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1426653310">&nbsp;</a><strong>[2015-03-18 04:35 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Could you provide file fuzz.zip for testing?
</pre>
</div><div class='comment type_log' ><a name="1426654597">&nbsp;</a><strong>[2015-03-18 04:56 UTC] emmanuel &#x64;&#111;&#x74; law &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Open</span>
</div></div></div><div class='comment type_comment' ><a name="1426654597">&nbsp;</a><strong>[2015-03-18 04:56 UTC] emmanuel &#x64;&#111;&#x74; law &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Here's a link to the file:

<a href="https://www.dropbox.com/s/v3tv1fou6hvkqst/fuzz.zip?dl=0" rel="nofollow">https://www.dropbox.com/s/v3tv1fou6hvkqst/fuzz.zip?dl=0</a>



$ md5 fuzz.zip
MD5 (fuzz.zip) = bb2b009af232c7ce9223495a233198ff

$ hexdump -C fuzz.zip
00000000  50 4b 06 06 30 30 30 30  30 30 30 30 30 30 30 30  |PK..000000000000|
00000010  30 30 30 30 30 30 30 30  00 00 00 00 00 00 00 30  |00000000.......0|
00000020  00 00 00 00 00 00 00 30  30 00 00 00 00 00 00 00  |.......00.......|
00000030  00 00 00 00 00 00 00 00  50 4b 06 07 30 30 30 30  |........PK..0000|
00000040  00 00 00 00 00 00 00 00  30 30 30 30 50 4b 05 06  |........0000PK..|
00000050  00 00 00 00 30 30 30 30  30 30 30 30 30 30 30 30  |....000000000000|
00000060  30 30                                             |00|
00000062
</pre>
</div><div class='comment type_log' ><a name="1426656251">&nbsp;</a><strong>[2015-03-18 05:24 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1426656251">&nbsp;</a><strong>[2015-03-18 05:24 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_comment' ><a name="1426656457">&nbsp;</a><strong>[2015-03-18 05:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>You may want also to report this upstream to libzip maintainers.
</pre>
</div><div class='comment type_comment' ><a name="1426664581">&nbsp;</a><strong>[2015-03-18 07:43 UTC] henri &#x61;&#116; nerv &#x64;&#111;&#x74; fi</strong>
<pre class='note'>Out of interest what fuzzer did you use?
</pre>
</div><div class='comment type_log' ><a name="1426671146">&nbsp;</a><strong>[2015-03-18 09:32 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-2331</span>
</div></div></div><div class='comment type_svn' ><a name="1426672021">&nbsp;</a><strong>[2015-03-18 09:47 UTC] <a href="//people.php.net/jpauli">jpauli@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=4a8d8b4154334b1714e19b82b061201d41dc87d6" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4a8d8b4154334b1714e19b82b061201d41dc87d6</a>
Log: Fix <a href='bug.php?id=69253'>bug #69253</a> - ZIP Integer Overflow leads to writing past heap boundary
</pre>
</div><div class='comment type_log' ><a name="1426672128">&nbsp;</a><strong>[2015-03-18 09:48 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Private report: No</span>
<span class="added">+Private report: Yes</span>
</div></div></div><div class='comment type_comment' ><a name="1426672128">&nbsp;</a><strong>[2015-03-18 09:48 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>Marked as private to give upstream time to fix it as well. Notified them at libzip@nih.at
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
