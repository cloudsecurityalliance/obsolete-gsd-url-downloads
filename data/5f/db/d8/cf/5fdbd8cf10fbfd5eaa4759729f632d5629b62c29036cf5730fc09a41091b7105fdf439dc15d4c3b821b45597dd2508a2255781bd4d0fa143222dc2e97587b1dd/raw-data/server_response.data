<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Reproducible crash Bug #68618 - RDF' href='rss/bug.php?id=68618'>
        <link rel='alternate' type='application/rss+xml' title='Reproducible crash Bug #68618 - RSS 2.0' href='rss/bug.php?id=68618&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #68618 :: out of bounds read crashes php-cgi</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=68618">Sec Bug</a>&nbsp;#68618</th>
            <td id="summary" colspan="5">out of bounds read crashes php-cgi</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2014-12-17 21:24 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-01-20 20:00 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Reproducible+crash">Reproducible crash</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>master-Git-2014-12-17 (Git)</td>
            <th class="details">OS:</th>
            <td>Debian 7</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-9427" target="_blank">2014-9427</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=68618&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=68618&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=68618&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1418851460">&nbsp;</a><strong>[2014-12-17 21:24 UTC] brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
I cloned the php git repo on 12/16/2014 and built from source using the afl-gcc compiler:

CC=/path/to/afl-gcc ./configure
AFL_HARDEN=1 make

PHP 7.0.0-dev (cgi-fcgi) (built: Dec 16 2014 14:07:45)
Copyright (c) 1997-2014 The PHP Group
Zend Engine v3.0.0-dev, Copyright (c) 1998-2014 Zend Technologies

While fuzzing the php-cgi binary, I found that a one byte file containing # and no newline causes php-cgi to segfault. 

printf &quot;#&quot; &gt;crashme.php
./php-cgi crashme.php
Segmentation fault

I talked with the author of afl-fuzz to make sure there wasn't some pointer weirdness happening as a result of compiling this with afl-gcc and he says it looks like an out of bounds read, probably not exploitable, but might could disclose server memory, but anyone that can upload php scripts can do far worse. 

I have not tried exploiting this via a browser with XSS or anything fancy yet, just passing this via the command line in a Debian VM. I can provide a core dump or any other information that is needed.

Expected result:
----------------
php-cgi should fail gracefully, not segfault.

Actual result:
--------------
==61759== Invalid read of size 1
==61759==    at 0x4575B0: main (cgi_main.c:2460)
==61759==  Address 0x4024000 is not stack'd, malloc'd or (recently) free'd
==61759== 
==61759== 
==61759== Process terminating with default action of signal 11 (SIGSEGV)
==61759==  Access not within mapped region at address 0x4024000
==61759==    at 0x4575B0: main (cgi_main.c:2460)
==61759==  If you believe this happened as a result of a stack
==61759==  overflow in your program's main thread (unlikely but
==61759==  possible), you can try to increase the size of the
==61759==  main thread stack using the --main-stacksize= flag.
==61759==  The main thread stack size used in this run was 8388608.
Segmentation fault

</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=68618&amp;patch=68618a&amp;revision=latest" >68618a</a>
(last revision 2021-06-04 15:39 UTC by 10615713 &#x61;&#116; qq &#x64;&#111;&#x74; com)
<br><p><a href='patch-add.php?bug_id=68618'>Add a Patch</a></p><h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/web-bugs/pull/18">Adds possibility to search for commenter-email</a>
      (web-bugs/18)</li>
</ul>
</div>
<p><a href='gh-pull-add.php?bug_id=68618'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1418852366">&nbsp;</a><strong>[2014-12-17 21:39 UTC] brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>PHP 5.4.35-0+deb7u2 (cgi-fcgi) (built: Nov 19 2014 07:58:17) is also susceptible to this crash.
</pre>
</div><div class='comment type_log' ><a name="1418852673">&nbsp;</a><strong>[2014-12-17 21:44 UTC] brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Type:           Bug</span>
<span class="added">+Type:           Security</span>
<span class="removed">-Private report: No</span>
<span class="added">+Private report: Yes</span>
</div></div></div><div class='comment type_comment' ><a name="1418852673">&nbsp;</a><strong>[2014-12-17 21:44 UTC] brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Changing this to a security bug until someone smarter than me can take a look at mark it otherwise.
</pre>
</div><div class='comment type_comment' ><a name="1418889999">&nbsp;</a><strong>[2014-12-18 08:06 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<pre class='note'>Reproduced with 5.6.4:

(gdb) bt
#0  0x00007ffff4be76ba in memchr () from /lib64/libc.so.6
#1  0x000055555575bec0 in lex_scan (zendlval=zendlval@entry=0x7fffffff8f68) at Zend/zend_language_scanner.l:1757
#2  0x000055555577b982 in zendlex (zendlval=zendlval@entry=0x7fffffff8f60) at /usr/src/debug/php-5.6.4/Zend/zend_compile.c:6875
#3  0x0000555555755a3e in zendparse () at /usr/src/debug/php-5.6.4/Zend/zend_language_parser.c:3732
#4  0x000055555575b275 in compile_file (file_handle=file_handle@entry=0x7fffffffd7d0, type=8) at Zend/zend_language_scanner.l:586
#5  0x000055555578231a in dtrace_compile_file (file_handle=0x7fffffffd7d0, type=&lt;optimized out&gt;) at /usr/src/debug/php-5.6.4/Zend/zend_dtrace.c:40
#6  0x0000555555794d1f in zend_execute_scripts (type=type@entry=8, retval=retval@entry=0x0, file_count=file_count@entry=3)
    at /usr/src/debug/php-5.6.4/Zend/zend.c:1336
#7  0x0000555555730c9b in php_execute_script (primary_file=0x7fffffffd7d0) at /usr/src/debug/php-5.6.4/main/main.c:2584
#8  0x0000555555611c0f in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at /usr/src/debug/php-5.6.4/sapi/cgi/cgi_main.c:2457
</pre>
</div><div class='comment type_comment' ><a name="1418893244">&nbsp;</a><strong>[2014-12-18 09:00 UTC] brian &#x64;&#111;&#x74; carpenter &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Seeing something slightly different with 7.0.0-dev:

(gdb) bt
#0  memchr () at ../sysdeps/x86_64/memchr.S:46
#1  0x00000000013c083b in lex_scan (zendlval=0x7fffbb981880)
    at Zend/zend_language_scanner.l:1641
#2  0x0000000001462ec8 in zendlex (elem=0x7fffbb981920)
    at /home/geeknik/php-src/Zend/zend_compile.c:1335
#3  0x000000000139dacf in zendparse ()
    at /home/geeknik/php-src/Zend/zend_language_parser.c:4408
#4  0x00000000013a9cad in compile_file (file_handle=0x7fffbb9849b0, type=8)
    at Zend/zend_language_scanner.l:585
#5  0x0000000000eca498 in phar_compile_file (file_handle=0x7fffbb9849b0, type=8)
    at /home/geeknik/php-src/ext/phar/phar.c:3311
#6  0x0000000001517ca8 in zend_execute_scripts (type=8, retval=0x0, 
    file_count=3) at /home/geeknik/php-src/Zend/zend.c:1257
#7  0x00000000012ddfc2 in php_execute_script (primary_file=0x7fffbb9849b0)
    at /home/geeknik/php-src/main/main.c:2563
#8  0x0000000000455425 in main (argc=2, argv=0x7fffbb984d68)
    at /home/geeknik/php-src/sapi/cgi/cgi_main.c:2478
#9  0x00007f123f7b1ead in __libc_start_main (main=&lt;optimized out&gt;, 
    argc=&lt;optimized out&gt;, ubp_av=&lt;optimized out&gt;, init=&lt;optimized out&gt;, 
    fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffbb984d58)
    at libc-start.c:244
#10 0x000000000045b33d in _start ()
</pre>
</div><div class='comment type_log' ><a name="1419931811">&nbsp;</a><strong>[2014-12-30 09:30 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1419931811">&nbsp;</a><strong>[2014-12-30 09:30 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1421784052">&nbsp;</a><strong>[2015-01-20 20:00 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2014-9427</span>
</div></div></div><div class='comment type_related' ><a name="1438543542">&nbsp;</a><strong>[2015-08-02 19:25 UTC] hugh &#x61;&#116; allthethings &#x64;&#111;&#x74; co &#x64;&#111;&#x74; nz</strong>
<pre class='note'>Related To: <a href='bug.php?id=70183'>Bug #70183</a>
</pre>
</div><div class='comment type_patch' ><a name="1622821171">&nbsp;</a><strong>[2021-06-04 15:39 UTC] 10615713 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: 68618a
Revision:   1622821171
URL:        <a href="https://bugs.php.net/patch-display.php?bug=68618&amp;patch=68618a&amp;revision=1622821171" rel="nofollow">https://bugs.php.net/patch-display.php?bug=68618&amp;patch=68618a&amp;revision=1622821171</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
