<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 1327723005: Fix crash during EmbeddedWorkerInstance startup sequence failures -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '83d3be554f39b50b0db9e9a0a2631766';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/1327723005%252526ust%25253D1608694734022500%252526usg%25253DAFQjCNFZrHhXkc-ZF_fLl2QrHJvf3hxJmA%26service%3Dah">Sign out</a>

</div>
<div class="counter">(282)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-1327723005">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/1327723005/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            1327723005</a>:
    Fix crash during EmbeddedWorkerInstance startup sequence failures  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            5 years, 3 months ago by <a href="/user/falken" onMouseOver="M_showUserInfoPopup(this)">falken</a>
          </div>
          <div><b>Modified:</b><br/>
            4 years, 9 months ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/kinuko" onMouseOver="M_showUserInfoPopup(this)">kinuko</a></span>, <span class='approval'><a href="/user/nhiroki" onMouseOver="M_showUserInfoPopup(this)">nhiroki</a></span>, <a href="/user/kinuko%20(google)" onMouseOver="M_showUserInfoPopup(this)">kinuko (google)</a>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, michaeln, jsbell+serviceworker_chromium.org, tzik, serviceworker-reviews, jam, nhiroki, darin-cc_chromium.org, horo+watch_chromium.org, kinuko+serviceworker, kinuko+watch, blink-worker-reviews_chromium.org
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">Fix crash during EmbeddedWorkerInstance startup sequence failures

Once EWInstance startup calls the callback, it's possible that the
underlying ServiceWorkerVersion is destroyed, hence destroying
|this|. We must guard against that.

Also some failure points in the startup sequence weren't calling
OnStopped() as expected.

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=529520">529520</a>, <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=531345">531345</a>
Committed: <a href="https://crrev.com/37b83877e63f62f8aebb337494f1116539182bdf">https://crrev.com/37b83877e63f62f8aebb337494f1116539182bdf</a>
Cr-Commit-Position: refs/heads/master@{#349368}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/1327723005/#ps1"
       onclick="M_toggleSectionForPS('1327723005', '1')"
       class="toggled-section ">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-20001-pointer"
       href="/1327723005/#ps20001"
       onclick="M_toggleSectionForPS('1327723005', '20001')"
       class="toggled-section ">
      Patch Set 2
      : added unittests
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 4
      
    </div>
  

  <div id="ps-20001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-40001-pointer"
       href="/1327723005/#ps40001"
       onclick="M_toggleSectionForPS('1327723005', '40001')"
       class="toggled-section ">
      Patch Set 3
      : comments
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-40001"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-60001-pointer"
       href="/1327723005/#ps60001"
       onclick="M_toggleSectionForPS('1327723005', '60001')"
       class="toggled-section opentriangle">
      Patch Set 4
      : fix asan
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 3
      
    </div>
  

  <div id="ps-60001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 5 years, 3 months ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue1327723005_60001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/1327723005/60001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+102 lines, -19 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1327723005/patch/60001/70002">
            content/browser/service_worker/embedded_worker_instance.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1327723005/diff2/1:60001/content/browser/service_worker/embedded_worker_instance.h"
             title="Delta from patch set 1">1</a>
        
          <a href="/1327723005/diff2/20001:60001/content/browser/service_worker/embedded_worker_instance.h"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+6 lines, -0 lines</td>
        
        <td style="white-space: nowrap">
          <b>
            1 comment
            
            
          </b>
        </td>
        <td>
          <a href="/download/issue1327723005_60001_70002.diff"
             title="Download patch for content/browser/service_worker/embedded_worker_instance.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1327723005/patch/60001/70001">
            content/browser/service_worker/embedded_worker_instance.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1327723005/diff2/1:60001/content/browser/service_worker/embedded_worker_instance.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/1327723005/diff2/20001:60001/content/browser/service_worker/embedded_worker_instance.cc"
             title="Delta from patch set 2">2</a>
        
        </td>
        
          <td style="white-space: nowrap">6 chunks</td>
          <td style="white-space: nowrap">+19 lines, -10 lines</td>
        
        <td style="white-space: nowrap">
          <b>
            2 comments
            
            
          </b>
        </td>
        <td>
          <a href="/download/issue1327723005_60001_70001.diff"
             title="Download patch for content/browser/service_worker/embedded_worker_instance.cc">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1327723005/patch/60001/70003">
            content/browser/service_worker/embedded_worker_instance_unittest.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance_unittest.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1327723005/diff2/1:60001/content/browser/service_worker/embedded_worker_instance_unittest.cc"
             title="Delta from patch set 1">1</a>
        
          <a href="/1327723005/diff2/20001:60001/content/browser/service_worker/embedded_worker_instance_unittest.cc"
             title="Delta from patch set 2">2</a>
        
          <a href="/1327723005/diff2/40001:60001/content/browser/service_worker/embedded_worker_instance_unittest.cc"
             title="Delta from patch set 3">3</a>
        
        </td>
        
          <td style="white-space: nowrap">6 chunks</td>
          <td style="white-space: nowrap">+77 lines, -9 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1327723005_60001_70003.diff"
             title="Download patch for content/browser/service_worker/embedded_worker_instance_unittest.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 60001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 14 (3 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 14)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 14)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(14)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(14)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>falken</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          falken@chromium.org changed reviewers: + kinuko@chromium.org, nhiroki@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-09 09:56:24 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            ><a href="mailto:falken@chromium.org">falken@chromium.org</a> changed reviewers:
+ <a href="mailto:kinuko@chromium.org">kinuko@chromium.org</a>, <a href="mailto:nhiroki@chromium.org">nhiroki@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>falken</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          This is a sneak preview of a patch... I still need to add unittests. But ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-09 09:56:24 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            >This is a sneak preview of a patch... I still need to add unittests. But if you
have time until then PTAL.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>falken</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          Added unittests PTAL
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-10 10:35:25 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            >Added unittests PTAL</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>kinuko (google)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          kinuko@google.com changed reviewers: + kinuko@google.com
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-10 22:14:19 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            ><a href="mailto:kinuko@google.com">kinuko@google.com</a> changed reviewers:
+ <a href="mailto:kinuko@google.com">kinuko@google.com</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>kinuko (google)</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          looking good (will take another look later) https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc File content/browser/service_worker/embedded_worker_instance_unittest.cc (right): https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc#newcode25 content/browser/service_worker/embedded_worker_instance_unittest.cc:25: // cannot ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-10 22:14:19 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >looking good (will take another look later)

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance_unittest.cc
(right):

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc#newcode25" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance_unittest.cc:25: //
cannot be used.
base::Passed() or base::Owned() works?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>nhiroki</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc File content/browser/service_worker/embedded_worker_instance.cc (right): https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc#newcode319 content/browser/service_worker/embedded_worker_instance.cc:319: // already been called. The following code might work? ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-11 04:33:02 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            ><a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance.cc (right):

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc#newcode319" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance.cc:319: // already been
called.
The following code might work?

// Here
  OnStartFailed(ABORT, callback);
  return;

// In OnStartFailed
  Status old_status = status_;
  if (status_ != STOPPED)
    ReleaseProcess();  // Sets |status_| to STOPPED. 
  base::WeakPtr&lt;EmbeddedWorkerInstance&gt; weak_this = weak_factory_.GetWeakPtr();
  callback.Run(status);
  if (weak_this &amp;&amp; old_status_ != STOPPED)
    FOR_EACH_OBSERVER(Listener, listener_list_, OnStopped(STARTING));</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>falken</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          Thanks, PTAL. https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc File content/browser/service_worker/embedded_worker_instance.cc (right): https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc#newcode319 content/browser/service_worker/embedded_worker_instance.cc:319: // already been called. On 2015/09/11 04:33:02, ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-11 09:48:17 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            >Thanks, PTAL.

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance.cc (right):

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance.cc#newcode319" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance.cc:319: // already been
called.
On 2015/09/11 04:33:02, nhiroki wrote:
&gt; The following code might work?
&gt; 
&gt; // Here
&gt;   OnStartFailed(ABORT, callback);
&gt;   return;
&gt; 
&gt; // In OnStartFailed
&gt;   Status old_status = status_;
&gt;   if (status_ != STOPPED)
&gt;     ReleaseProcess();  // Sets |status_| to STOPPED. 
&gt;   base::WeakPtr&lt;EmbeddedWorkerInstance&gt; weak_this =
weak_factory_.GetWeakPtr();
&gt;   callback.Run(status);
&gt;   if (weak_this &amp;&amp; old_status_ != STOPPED)
&gt;     FOR_EACH_OBSERVER(Listener, listener_list_, OnStopped(STARTING));

I like this, done, with the minor exception of calling ReleaseProcess even if
STOPPED, it should be a no-op.

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance_unittest.cc
(right):

<a href="https://codereview.chromium.org/1327723005/diff/20001/content/browser/service_worker/embedded_worker_instance_unittest.cc#newcode25" rel="nofollow">https://codereview.chromium.org/1327723005/diff/20001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance_unittest.cc:25: //
cannot be used.
On 2015/09/10 22:14:19, kinuko (google) wrote:
&gt; base::Passed() or base::Owned() works?

Huh yes... I must have made a mistake on my first attempt. Done.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>nhiroki</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          lgtm
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-12 23:55:31 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            >lgtm</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>kinuko</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          lgtm https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc File content/browser/service_worker/embedded_worker_instance.cc (right): https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc#newcode513 content/browser/service_worker/embedded_worker_instance.cc:513: OnStopped(old_status)); nit: would be better to update the ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-13 08:41:12 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >lgtm

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance.cc (right):

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc#newcode513" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance.cc:513:
OnStopped(old_status));
nit: would be better to update the comment for Listener::OnStopped about when it
could be called

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.h" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance.h (right):

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.h#newcode238" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance.h:238: // |callback|
with |status|. May destroy |this|.
nit: ... via |callback|. ?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>nhiroki</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          &gt; Also some failure points in the startup sequence weren&#39;t calling &gt; OnStopped() as expected. ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-17 06:14:13 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-9"
            >&gt; Also some failure points in the startup sequence weren&#39;t calling
&gt; OnStopped() as expected.

This could fix issue 531345 (see my inline comment for the details). We&#39;d like
to fix the issue asap, so let me check the CQ box on behalf of falken@ (he is
ooo for a while).

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
File content/browser/service_worker/embedded_worker_instance.cc (right):

<a href="https://codereview.chromium.org/1327723005/diff/60001/content/browser/service_worker/embedded_worker_instance.cc#newcode353" rel="nofollow">https://codereview.chromium.org/1327723005/diff/60001/content/browser/service...</a>
content/browser/service_worker/embedded_worker_instance.cc:353:
OnStartFailed(callback, status);
I guess this could fix issue 531345. Before this patch, EmbeddedWorkerInstance
could be stick on STARTING state and subsequent StartWorker requests are queued
up until the timeout timer is fired (5 minutes). The timeout timer stops the
EWInstance[1] and records TimeoutPhase as SENT_START_WORKER.

[1]
<a href="https://code.google.com/p/chromium/codesearch#chromium/src/content/browser/service_worker/service_worker_version.cc&amp;sq=package:chromium&amp;type=cs&amp;rcl=1442446036&amp;l=2038" rel="nofollow">https://code.google.com/p/chromium/codesearch#chromium/src/content/browser/se...</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>nhiroki</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          The CQ bit was checked by nhiroki@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-17 06:15:00 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-10"
            >The CQ bit was checked by <a href="mailto:nhiroki@chromium.org">nhiroki@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-11">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/patch-status/1327723005/60001 View timeline at https://chromium-cq-status.appspot.com/patch-timeline/1327723005/60001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-17 06:15:16 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-11"
            >CQ is trying da patch. Follow status at
 <a href="https://chromium-cq-status.appspot.com/patch-status/1327723005/60001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-status/1327723005/60001</a>
View timeline at
 <a href="https://chromium-cq-status.appspot.com/patch-timeline/1327723005/60001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-timeline/1327723005/60001</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg13"
           name="12">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(12)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-12">
                          Committed patchset #4 (id:60001)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-17 07:14:09 UTC)
                <a href="#msg13">#13</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-12"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-12"
            >Committed patchset #4 (id:60001)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg14"
           name="13">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(13)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-13">
                          Patchset 4 (id:??) landed as https://crrev.com/37b83877e63f62f8aebb337494f1116539182bdf Cr-Commit-Position: refs/heads/master@{#349368}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 3 months ago
		(2015-09-17 07:15:25 UTC)
                <a href="#msg14">#14</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-13"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-13"
            >Patchset 4 (id:??) landed as
<a href="https://crrev.com/37b83877e63f62f8aebb337494f1116539182bdf" rel="nofollow">https://crrev.com/37b83877e63f62f8aebb337494f1116539182bdf</a>
Cr-Commit-Position: refs/heads/master@{#349368}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 14)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 14)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(14)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(14)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 14;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 1327723005;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 1327723005: Fix crash during EmbeddedWorkerInstance startup sequence failures
     (Closed) </b><br/>
      Created 5 years, 3 months ago by falken<br/>
      Modified 4 years, 9 months ago<br/>
      Reviewers: nhiroki, kinuko, kinuko (google)<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 7
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
