<!DOCTYPE html>
<html lang='en'>
<head>
<title>xorg/lib/libXv - Xvideo extension library  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxv)</title>
<meta name='generator' content='cgit v1.2.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='https://cgit.freedesktop.org/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://cgit.freedesktop.org/xorg/lib/libXv/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='https://gitlab.freedesktop.org/xorg/lib/libxv' title='xorg/lib/libXv Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='https://cgit.freedesktop.org/logo.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='xorg/lib/libXv' href='/xorg/lib/libXv/'>xorg/lib/libXv</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d9da580b46a28ab497de2e94fdc7b9ff953dab17'/><select name='h' onchange='this.form.submit();'>
<option value='CYGWIN'>CYGWIN</option>
<option value='DAMAGE-XFIXES'>DAMAGE-XFIXES</option>
<option value='IPv6-REVIEW'>IPv6-REVIEW</option>
<option value='XACE-SELINUX'>XACE-SELINUX</option>
<option value='XEVIE'>XEVIE</option>
<option value='XINERAMA_2'>XINERAMA_2</option>
<option value='XORG-6_8-branch'>XORG-6_8-branch</option>
<option value='XORG-CURRENT'>XORG-CURRENT</option>
<option value='XORG-RELEASE-1'>XORG-RELEASE-1</option>
<option value='XORG-RELEASE-1-STSF'>XORG-RELEASE-1-STSF</option>
<option value='XORG-RELEASE-1-TM'>XORG-RELEASE-1-TM</option>
<option value='XORG-STABLE'>XORG-STABLE</option>
<option value='XPRINT'>XPRINT</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Xvideo extension library  (mirrored from https://gitlab.freedesktop.org/xorg/lib/libxv)</td><td class='sub right'>krh</td></tr></table>
<table class='tabs'><tr><td>
<a href='/xorg/lib/libXv/'>summary</a><a href='/xorg/lib/libXv/refs/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>refs</a><a href='/xorg/lib/libXv/log/'>log</a><a href='/xorg/lib/libXv/tree/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>tree</a><a class='active' href='/xorg/lib/libXv/commit/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>commit</a><a href='/xorg/lib/libXv/diff/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>diff</a></td><td class='form'><form class='right' method='get' action='/xorg/lib/libXv/log/'>
<input type='hidden' name='id' value='d9da580b46a28ab497de2e94fdc7b9ff953dab17'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d9da580b46a28ab497de2e94fdc7b9ff953dab17'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;</td><td class='right'>2016-09-25 21:30:03 +0200</td></tr>
<tr><th>committer</th><td>Matthieu Herrb &lt;matthieu@herrb.eu&gt;</td><td class='right'>2016-09-28 18:04:42 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXv/commit/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>d9da580b46a28ab497de2e94fdc7b9ff953dab17</a> (<a href='/xorg/lib/libXv/patch/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXv/tree/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>a54efa12778416e3296cb6a2353ab7095caf970e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/xorg/lib/libXv/commit/?id=cf8cc328f1e370a548b71581bada7e1ee073c756'>cf8cc328f1e370a548b71581bada7e1ee073c756</a> (<a href='/xorg/lib/libXv/diff/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17&amp;id2=cf8cc328f1e370a548b71581bada7e1ee073c756'>diff</a>)</td></tr></table>
<div class='commit-subject'>Protocol handling issues in libXv - CVE-2016-5407</div><div class='commit-msg'>The Xv query functions for adaptors and encodings suffer from out of
boundary accesses if a hostile X server sends a maliciously crafted
response.

A previous fix already checks the received length against fixed values
but ignores additional length specifications which are stored inside
the received data.

These lengths are accessed in a for-loop. The easiest way to guarantee
a correct processing is by validating all lengths against the
remaining size left before accessing referenced memory.

This makes the previously applied check obsolete, therefore I removed
it.

Signed-off-by: Tobias Stoeckmann &lt;tobias@stoeckmann.org&gt;
Reviewed-by: Matthieu Herrb &lt;matthieu@herrb.eu&gt;
</div><div class='diffstat-header'><a href='/xorg/lib/libXv/diff/?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/xorg/lib/libXv/diff/src/Xv.c?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>src/Xv.c</a></td><td class='right'>46</td><td class='graph'><table summary='file diffstat' width='46%'><tr><td class='add' style='width: 63.0%;'/><td class='rem' style='width: 37.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 29 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/Xv.c b/src/Xv.c<br/>index e47093a..be450c4 100644<br/>--- a/<a href='/xorg/lib/libXv/tree/src/Xv.c?id=cf8cc328f1e370a548b71581bada7e1ee073c756'>src/Xv.c</a><br/>+++ b/<a href='/xorg/lib/libXv/tree/src/Xv.c?id=d9da580b46a28ab497de2e94fdc7b9ff953dab17'>src/Xv.c</a></div><div class='hunk'>@@ -158,6 +158,7 @@ XvQueryAdaptors(</div><div class='ctx'>     size_t size;</div><div class='ctx'>     unsigned int ii, jj;</div><div class='ctx'>     char *name;</div><div class='add'>+    char *end;</div><div class='ctx'>     XvAdaptorInfo *pas = NULL, *pa;</div><div class='ctx'>     XvFormat *pfs, *pf;</div><div class='ctx'>     char *buffer = NULL;</div><div class='hunk'>@@ -197,17 +198,13 @@ XvQueryAdaptors(</div><div class='ctx'>     /* GET INPUT ADAPTORS */</div><div class='ctx'> </div><div class='ctx'>     if (rep.num_adaptors == 0) {</div><div class='del'>-        /* If there's no adaptors, there's nothing more to do. */</div><div class='add'>+        /* If there are no adaptors, there's nothing more to do. */</div><div class='ctx'>         status = Success;</div><div class='ctx'>         goto out;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    if (size &lt; (rep.num_adaptors * sz_xvAdaptorInfo)) {</div><div class='del'>-        /* If there's not enough data for the number of adaptors,</div><div class='del'>-           then we have a problem. */</div><div class='del'>-        status = XvBadReply;</div><div class='del'>-        goto out;</div><div class='del'>-    }</div><div class='add'>+    u.buffer = buffer;</div><div class='add'>+    end = buffer + size;</div><div class='ctx'> </div><div class='ctx'>     size = rep.num_adaptors * sizeof(XvAdaptorInfo);</div><div class='ctx'>     if ((pas = Xmalloc(size)) == NULL) {</div><div class='hunk'>@@ -225,9 +222,12 @@ XvQueryAdaptors(</div><div class='ctx'>         pa++;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    u.buffer = buffer;</div><div class='ctx'>     pa = pas;</div><div class='ctx'>     for (ii = 0; ii &lt; rep.num_adaptors; ii++) {</div><div class='add'>+        if (u.buffer + sz_xvAdaptorInfo &gt; end) {</div><div class='add'>+            status = XvBadReply;</div><div class='add'>+            goto out;</div><div class='add'>+        }</div><div class='ctx'>         pa-&gt;type = u.pa-&gt;type;</div><div class='ctx'>         pa-&gt;base_id = u.pa-&gt;base_id;</div><div class='ctx'>         pa-&gt;num_ports = u.pa-&gt;num_ports;</div><div class='hunk'>@@ -239,6 +239,10 @@ XvQueryAdaptors(</div><div class='ctx'>         size = u.pa-&gt;name_size;</div><div class='ctx'>         u.buffer += pad_to_int32(sz_xvAdaptorInfo);</div><div class='ctx'> </div><div class='add'>+        if (u.buffer + size &gt; end) {</div><div class='add'>+            status = XvBadReply;</div><div class='add'>+            goto out;</div><div class='add'>+        }</div><div class='ctx'>         if ((name = Xmalloc(size + 1)) == NULL) {</div><div class='ctx'>             status = XvBadAlloc;</div><div class='ctx'>             goto out;</div><div class='hunk'>@@ -259,6 +263,11 @@ XvQueryAdaptors(</div><div class='ctx'> </div><div class='ctx'>         pf = pfs;</div><div class='ctx'>         for (jj = 0; jj &lt; pa-&gt;num_formats; jj++) {</div><div class='add'>+            if (u.buffer + sz_xvFormat &gt; end) {</div><div class='add'>+                Xfree(pfs);</div><div class='add'>+                status = XvBadReply;</div><div class='add'>+                goto out;</div><div class='add'>+            }</div><div class='ctx'>             pf-&gt;depth = u.pf-&gt;depth;</div><div class='ctx'>             pf-&gt;visual_id = u.pf-&gt;visual;</div><div class='ctx'>             pf++;</div><div class='hunk'>@@ -327,6 +336,7 @@ XvQueryEncodings(</div><div class='ctx'>     size_t size;</div><div class='ctx'>     unsigned int jj;</div><div class='ctx'>     char *name;</div><div class='add'>+    char *end;</div><div class='ctx'>     XvEncodingInfo *pes = NULL, *pe;</div><div class='ctx'>     char *buffer = NULL;</div><div class='ctx'>     union {</div><div class='hunk'>@@ -364,17 +374,13 @@ XvQueryEncodings(</div><div class='ctx'>     /* GET ENCODINGS */</div><div class='ctx'> </div><div class='ctx'>     if (rep.num_encodings == 0) {</div><div class='del'>-        /* If there's no encodings, there's nothing more to do. */</div><div class='add'>+        /* If there are no encodings, there's nothing more to do. */</div><div class='ctx'>         status = Success;</div><div class='ctx'>         goto out;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    if (size &lt; (rep.num_encodings * sz_xvEncodingInfo)) {</div><div class='del'>-        /* If there's not enough data for the number of adaptors,</div><div class='del'>-           then we have a problem. */</div><div class='del'>-        status = XvBadReply;</div><div class='del'>-        goto out;</div><div class='del'>-    }</div><div class='add'>+    u.buffer = buffer;</div><div class='add'>+    end = buffer + size;</div><div class='ctx'> </div><div class='ctx'>     size = rep.num_encodings * sizeof(XvEncodingInfo);</div><div class='ctx'>     if ((pes = Xmalloc(size)) == NULL) {</div><div class='hunk'>@@ -391,10 +397,12 @@ XvQueryEncodings(</div><div class='ctx'>         pe++;</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-    u.buffer = buffer;</div><div class='del'>-</div><div class='ctx'>     pe = pes;</div><div class='ctx'>     for (jj = 0; jj &lt; rep.num_encodings; jj++) {</div><div class='add'>+        if (u.buffer + sz_xvEncodingInfo &gt; end) {</div><div class='add'>+            status = XvBadReply;</div><div class='add'>+            goto out;</div><div class='add'>+        }</div><div class='ctx'>         pe-&gt;encoding_id = u.pe-&gt;encoding;</div><div class='ctx'>         pe-&gt;width = u.pe-&gt;width;</div><div class='ctx'>         pe-&gt;height = u.pe-&gt;height;</div><div class='hunk'>@@ -405,6 +413,10 @@ XvQueryEncodings(</div><div class='ctx'>         size = u.pe-&gt;name_size;</div><div class='ctx'>         u.buffer += pad_to_int32(sz_xvEncodingInfo);</div><div class='ctx'> </div><div class='add'>+        if (u.buffer + size &gt; end) {</div><div class='add'>+            status = XvBadReply;</div><div class='add'>+            goto out;</div><div class='add'>+        }</div><div class='ctx'>         if ((name = Xmalloc(size + 1)) == NULL) {</div><div class='ctx'>             status = XvBadAlloc;</div><div class='ctx'>             goto out;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.1</a> (<a href='https://git-scm.com/'>git 2.18.0</a>) at 2021-10-30 22:00:20 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
