<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    
    
      
    
    
      Issue 1463463003: AppCache: fix a browser crashing bug that can happen during updates. -
    
    Code Review
  </title>
  <link rel="icon" href="/static/favicon.ico" />
  <link type="text/css" rel="stylesheet"
  href="/static/styles.css?v=408576698
" />
  <script type="text/javascript" src="/static/autocomplete/lib/jquery.js"></script>
  <script type="text/javascript"
    src="/static/script.js?v=408576698
"></script>
   <!-- head block to insert js/css for forms processing -->
   
   <!-- /head -->
</head>
<body onunload="M_unloadPage();">

<!-- Begin help window -->
<script type="text/javascript"><!--
var xsrfToken = '35439bf0c70de387ebf258d6757e53fb';
var helpDisplayed = false;
document.onclick = M_clickCommon;
var media_url = "/static/";
var base_url = "/";
// -->
</script>
<div id="help" style="display: none;">

<div style="font-size: medium; text-align: center;">Keyboard Shortcuts</div>
<hr />
<table class="shortcuts">
  <tr valign="top">
    <td>
      <table>
        <tr>
          <td></td><th>File</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to issue</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to file after / before current file</td>
        </tr>
        <tr>
          <td><span>J</span> / <span>K</span> <b>:</b></td><td>jump to next file with a comment after / before current file</td>
        </tr>
        <tr>
          <td></td><th>Side-by-side diff</th>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>toggle intra-line diffs</td>
        </tr>
        <tr>
          <td><span>e</span> <b>:</b></td><td>expand all comments</td>
        </tr>
        <tr>
          <td><span>c</span> <b>:</b></td><td>collapse all comments</td>
        </tr>
        <tr>
          <td><span>s</span> <b>:</b></td><td>toggle showing all comments</td>
        </tr>
        <tr>
          <td><span>n</span> / <span>p</span> <b>:</b></td><td>next / previous diff chunk or comment</td>
        </tr>
        <tr>
          <td><span>N</span> / <span>P</span> <b>:</b></td><td>next / previous comment</td>
        </tr>
        <tr>
          <td><span>&lt;Up&gt;</span> / <span>&lt;Down&gt;</span> <b>:</b></td><td>next / previous line</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <td></td><th>Issue</th>
        </tr>
        <tr>
          <td><span>u</span> <b>:</b></td><td>up to list of issues</td>
        </tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to patch after / before current patch</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current patch in side-by-side view</td>
        </tr>
        <tr>
          <td><span>i</span> <b>:</b></td><td>open current patch in unified diff view</td>
        </tr>
        <tr><td>&nbsp;</td></tr>
          <tr><td></td><th>Issue List</th></tr>
        <tr>
          <td><span>j</span> / <span>k</span> <b>:</b></td><td>jump to issue after / before current issue</td>
        </tr>
        <tr>
          <td><span>o</span> / <span>&lt;Enter&gt;</span> <b>:</b></td><td>open current issue</td>
        </tr>
      </table>
    </td>
  </tr>

</table>
</div>
<!-- End help window -->

<div align="right">

<div style="float:left; font-size:x-large"><img style="vertical-align:middle" src="/static/chromium-24.png" /> Chromium Code Reviews</div>




<b>chromiumcodereview-hr@appspot.gserviceaccount.com (chromiumcodereview-hr)</b>
|

<span style="color:red">Please choose your nickname with</span>
<a class="novisit" href="/settings">Settings</a>
|


<a class="novisit" target="_blank"
   href="http://code.google.com/p/rietveld/wiki/CodeReviewHelp">Help</a>

|
<a class="novisit" href="http://www.chromium.org/">Chromium Project</a>
|
<a class="novisit" href="https://chromium-review.googlesource.com/dashboard/self?polygerrit=1">Gerrit Changes</a>
|

<a class="novisit" href="https://codereview.chromium.org/_ah/logout?continue=https://accounts.google.com/Logout%3Fcontinue%3Dhttps://uc.appengine.google.com/_ah/logout%253Fcontinue%253Dhttps://google.com/url%25253Fsa%25253DD%252526q%25253Dhttps://codereview.chromium.org/1463463003%252526ust%25253D1608714552232213%252526usg%25253DAFQjCNGP8KpEOwIFNV4sSw8mCLMagKK3CQ%26service%3Dah">Sign out</a>

</div>
<div class="counter">(223)</div>
<br />
<div class="mainmenu">
  
  <a href="/" class="active">Issues</a>
  <a href="/search">Search</a>

</div>
<div class="mainmenu2">
  
  
    &nbsp;&nbsp;&nbsp;
    <a href="/mine">My Issues</a>
    |
    <a href="/starred">Starred</a>
    &nbsp;&nbsp;&nbsp;
    <a href="/all?closed=0">Open</a>
    |
    <a href="/all?closed=1">Closed</a>
    |
    <a href="/all">All</a>
  

</div>

<div>

  <h2>
    <span id="issue-star-1463463003">
  
    
      <img src="/static/star-dark.gif" width="15" height="15" border="0">
    
  
</span>

    Issue <a href="/1463463003/"
               onmouseover="M_showPopUp(this, 'popup-issue');">
            1463463003</a>:
    AppCache: fix a browser crashing bug that can happen during updates.  (Closed) 
  </h2>

  <table class="issue-details" border="0" width="100%">
    <tr valign="top">

      <td class="meta" width="20%">
        <div class="issue_details_sidebar">
          <div><b>Created:</b><br/>
            5 years, 1 month ago by <a href="/user/michaeln" onMouseOver="M_showUserInfoPopup(this)">michaeln</a>
          </div>
          <div><b>Modified:</b><br/>
            5 years, 1 month ago
          </div>
          <div><b>Reviewers:</b><br/>
            <span class='approval'><a href="/user/gzobqq" onMouseOver="M_showUserInfoPopup(this)">gzobqq</a></span>
          </div>
          
          <div><b>CC:</b><br/>
            chromium-reviews, michaeln, darin-cc_chromium.org, jam, Will Harris
          </div>
          
          
          <div><b>Base URL:</b><br/>
            
            https://chromium.googlesource.com/chromium/src.git@master
            
          </div>
          
          
          <div><b>Target Ref:</b><br/>
            refs/pending/heads/master
          </div>
          
          
          <div><b>Project:</b><br/>
            <a href="/search?project=chromium">
              chromium
            </a>
          </div>
          
          <div><b>Visibility:</b><br/>
            
                Public.
            
          </div>
          
          <div><a title="Find reviews for the same repository ID - c14d891d44f0afff64e56ed7c9702df1d807b1ee"
               href="/search?repo_guid=c14d891d44f0afff64e56ed7c9702df1d807b1ee">
            <b>More Reviews</b></a>
          </div>
          
        </div>
      </td>

      <td style="padding-left: .8em; padding-right: .8em;" width="80%">
        




  <h3><a id="issue-description-pointer"
     href="javascript:M_toggleSection('issue-description')"
     class="toggled-section opentriangle">
    Description</a></h3>
  <div id="issue-description">AppCache: fix a browser crashing bug that can happen during updates.

BUG=<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=558589">558589</a>
Committed: <a href="https://crrev.com/e5c298b780737c53fa9aae44d6fef522931d88b0">https://crrev.com/e5c298b780737c53fa9aae44d6fef522931d88b0</a>
Cr-Commit-Position: refs/heads/master@{#360967}
  </div>




  <h3>
    <a id="ps-1-pointer"
       href="/1463463003/#ps1"
       onclick="M_toggleSectionForPS('1463463003', '1')"
       class="toggled-section ">
      Patch Set 1
      
      <span class="anchor">#</span>
    </a>
  </h3>

  
    <div>
      <i>Total comments:</i> 7
      
    </div>
  

  <div id="ps-1"
  
       style="display:none">
  
  </div>
  

  <h3>
    <a id="ps-20001-pointer"
       href="/1463463003/#ps20001"
       onclick="M_toggleSectionForPS('1463463003', '20001')"
       class="toggled-section opentriangle">
      Patch Set 2
      :  
      <span class="anchor">#</span>
    </a>
  </h3>

  

  <div id="ps-20001"
  
       style="">
    
<div class="issue-list">

  <div class="pagination">
    <div style="float: left;">
      <i>Created:</i> 5 years, 1 month ago
    </div>
    <div style="float: right;">
      
        Download
          <a href="/download/issue1463463003_20001.diff"
            title="Patchset in text format">[raw]</a>
          <a href="/tarball/1463463003/20001"
            title="Tarball containing the original and patched files">[tar.bz2]</a>
      
    </div>
    <div style="clear:both;"></div>
  </div>

  <table id="queues" style="clear:both;">
    <tr align="left">
      <th colspan="2"></th>
      <th>Unified diffs</th>
      <th>Side-by-side diffs</th>
      <th>Delta from patch set</th>
      <th colspan="3">Stats <font style='font-weight: normal'>(<i>+11 lines, -3 lines</i>)</font></th>
      <th>Patch</th>
    </tr>

    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1463463003/patch/20001/30002">
            content/browser/appcache/appcache_update_job.h
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1463463003/diff/20001/content/browser/appcache/appcache_update_job.h">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
        </td>
        
          <td style="white-space: nowrap">1 chunk</td>
          <td style="white-space: nowrap">+1 line, -0 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1463463003_20001_30002.diff"
             title="Download patch for content/browser/appcache/appcache_update_job.h">
            Download
          </a>
        </td>
      </tr>
    
      <tr name="patch">
        <td class="first" width="14"><img src="/static/closedtriangle.gif"
    style="visibility: hidden;" width="12" height="9" /></td>
        <td style="white-space: nowrap">M</td>
        <td>
          <a class="noul"
             href="/1463463003/patch/20001/30001">
            content/browser/appcache/appcache_update_job.cc
          </a>
        </td>
        <td>
          <a class="noul"
             href="/1463463003/diff/20001/content/browser/appcache/appcache_update_job.cc">
            View
          </a>
        </td>
        <td style="white-space: nowrap">
        
          <a href="/1463463003/diff2/1:20001/content/browser/appcache/appcache_update_job.cc"
             title="Delta from patch set 1">1</a>
        
        </td>
        
          <td style="white-space: nowrap">3 chunks</td>
          <td style="white-space: nowrap">+10 lines, -3 lines</td>
        
        <td style="white-space: nowrap">
          
            0 comments
            
            
          
        </td>
        <td>
          <a href="/download/issue1463463003_20001_30001.diff"
             title="Download patch for content/browser/appcache/appcache_update_job.cc">
            Download
          </a>
        </td>
      </tr>
    
  </table>

  
  
</div>

  
  </div>
  
    <script language="JavaScript" type="text/javascript">
         <!--
         var lastPSId = 20001;
         // -->
       </script>
  




  <h3>
    <a id="messages-pointer"
       href="javascript:M_toggleSection('messages')"
       class="toggled-section opentriangle">
      Messages
    </a>
  </h3>

  
    <div><i>
    Total messages: 13 (4 generated)
    </i></div>
  

  <div id="messages">
    <div style="margin-bottom: .5em;">
      <a href="javascript:M_expandAllVisibleComments('cl', 13)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 13)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(13)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(13)">
        Hide Generated Messages</a>
      
    </div>

    
      <div class="message    generated"
           style="display: none"
           id="generated-msg1"
           name="0">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(0)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-0">
                          Description was changed from ========== appcache BUG=558589 ========== to ========== appcache BUG=558589 ==========
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 01:50:43 UTC)
                <a href="#msg1">#1</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-0"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-0"
            >Description was changed from

==========
appcache

BUG=558589
==========

to

==========
appcache

BUG=558589
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg2"
           name="1">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(1)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-1">
                          michaeln@chromium.org changed reviewers: + gzobqq@gmail.com
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 01:50:43 UTC)
                <a href="#msg2">#2</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-1"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-1"
            ><a href="mailto:michaeln@chromium.org">michaeln@chromium.org</a> changed reviewers:
+ <a href="mailto:gzobqq@gmail.com">gzobqq@gmail.com</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg3"
           name="2">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(2)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-2">
                          not tested yet, but here&#39;s what i have in mind as a fix
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 01:51:34 UTC)
                <a href="#msg3">#3</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-2"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-2"
            >not tested yet, but here&#39;s what i have in mind as a fix</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg4"
           name="3">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(3)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>gzobqq</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-3">
                          Thanks, I tested that this fix stops the PoC. https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc File content/browser/appcache/appcache_update_job.cc (right): https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431 content/browser/appcache/appcache_update_job.cc:431: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 06:10:54 UTC)
                <a href="#msg4">#4</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-3"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-3"
            >Thanks, I tested that this fix stops the PoC.

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
File content/browser/appcache/appcache_update_job.cc (right):

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:431: return;
Do we care about lack of host notification?

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode887" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:887:
--master_entries_completed_;
Another possible fix would be to do this erase() and -- outside the if. This way
any failed fetches won&#39;t be counted in master_entries_completed_, so failed urls
can&#39;t be counted multiple times. On the positive side, any re-fetches will also
get notified. But I&#39;m not quite sure this change doesn&#39;t have side effects.

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode1696" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:1696: void
AppCacheUpdateJob::DeleteSoon() {
In any case, perhaps double check here or in the destructor that
master_entry_fetches_ and pending_url_fetches_ are empty. It&#39;s difficult to
verify the correctness of the check at MaybeCompleteUpdate().</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg5"
           name="4">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(4)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-4">
                          thnx for looking and verifying it fixes the crash https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc File content/browser/appcache/appcache_update_job.cc (right): https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431 content/browser/appcache/appcache_update_job.cc:431: ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 20:38:56 UTC)
                <a href="#msg5">#5</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-4"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-4"
            >thnx for looking and verifying it fixes the crash

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
File content/browser/appcache/appcache_update_job.cc (right):

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:431: return;
On 2015/11/20 06:10:54, gzobqq wrote:
&gt; Do we care about lack of host notification?

we care more about the crash

for this to happen, the master resource load must succeed a moment earlier and
then fail to load a moment later. this seems like a small corner case. i think
trading minor correctness errors (visible events) in that case for robustness is
a reasonable trade.

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode887" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:887:
--master_entries_completed_;
On 2015/11/20 06:10:54, gzobqq wrote:
&gt; Another possible fix would be to do this erase() and -- outside the if. This
way
&gt; any failed fetches won&#39;t be counted in master_entries_completed_, so failed
urls
&gt; can&#39;t be counted multiple times. On the positive side, any re-fetches will
also
&gt; get notified.
&gt;
&gt; *But I&#39;m not quite sure this change doesn&#39;t have side effects.*

This is very tricky code, the concern for breaking something else is what led me
to add the new collection instead of trying to alter the existing book keeping.
The simple addition is a lot easier to reason about.

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode1696" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:1696: void
AppCacheUpdateJob::DeleteSoon() {
On 2015/11/20 06:10:54, gzobqq wrote:
&gt; In any case, perhaps double check here or in the destructor that
&gt; master_entry_fetches_ and pending_url_fetches_ are empty. It&#39;s difficult to
&gt; verify the correctness of the check at MaybeCompleteUpdate().

I&#39;ve converted a few DCHECKs in the dtor to CHECKs given the severity of getting
it wrong.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message  approval  "
           
           id="msg6"
           name="5">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(5)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>gzobqq</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-5">
                          On 2015/11/20 20:38:56, michaeln wrote: &gt; thnx for looking and verifying it fixes the crash ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 21:08:05 UTC)
                <a href="#msg6">#6</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-5"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-5"
            >On 2015/11/20 20:38:56, michaeln wrote:
&gt; thnx for looking and verifying it fixes the crash
&gt; 
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; File content/browser/appcache/appcache_update_job.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; content/browser/appcache/appcache_update_job.cc:431: return;
&gt; On 2015/11/20 06:10:54, gzobqq wrote:
&gt; &gt; Do we care about lack of host notification?
&gt; 
&gt; we care more about the crash
&gt; 
&gt; for this to happen, the master resource load must succeed a moment earlier and
&gt; then fail to load a moment later. this seems like a small corner case. i think
&gt; trading minor correctness errors (visible events) in that case for robustness
is
&gt; a reasonable trade.
&gt; 
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode887" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; content/browser/appcache/appcache_update_job.cc:887:
&gt; --master_entries_completed_;
&gt; On 2015/11/20 06:10:54, gzobqq wrote:
&gt; &gt; Another possible fix would be to do this erase() and -- outside the if. This
&gt; way
&gt; &gt; any failed fetches won&#39;t be counted in master_entries_completed_, so failed
&gt; urls
&gt; &gt; can&#39;t be counted multiple times. On the positive side, any re-fetches will
&gt; also
&gt; &gt; get notified.
&gt; &gt;
&gt; &gt; *But I&#39;m not quite sure this change doesn&#39;t have side effects.*
&gt; 
&gt; This is very tricky code, the concern for breaking something else is what led
me
&gt; to add the new collection instead of trying to alter the existing book
keeping.
&gt; The simple addition is a lot easier to reason about.

I agree.

&gt; 
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode1696" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; content/browser/appcache/appcache_update_job.cc:1696: void
&gt; AppCacheUpdateJob::DeleteSoon() {
&gt; On 2015/11/20 06:10:54, gzobqq wrote:
&gt; &gt; In any case, perhaps double check here or in the destructor that
&gt; &gt; master_entry_fetches_ and pending_url_fetches_ are empty. It&#39;s difficult to
&gt; &gt; verify the correctness of the check at MaybeCompleteUpdate().
&gt; 
&gt; I&#39;ve converted a few DCHECKs in the dtor to CHECKs given the severity of
getting
&gt; it wrong.

LGTM</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg7"
           name="6">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(6)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-6">
                          https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc File content/browser/appcache/appcache_update_job.cc (right): https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431 content/browser/appcache/appcache_update_job.cc:431: return; On 2015/11/20 20:38:55, michaeln wrote: &gt; On 2015/11/20 ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 21:19:15 UTC)
                <a href="#msg7">#7</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-6"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-6"
            ><a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
File content/browser/appcache/appcache_update_job.cc (right):

<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
content/browser/appcache/appcache_update_job.cc:431: return;
On 2015/11/20 20:38:55, michaeln wrote:
&gt; On 2015/11/20 06:10:54, gzobqq wrote:
&gt; &gt; Do we care about lack of host notification?
&gt; 
&gt; we care more about the crash
&gt; 
&gt; for this to happen, the master resource load must succeed a moment earlier and
&gt; then fail to load a moment later. this seems like a small corner case. i think
&gt; trading minor correctness errors (visible events) in that case for robustness
is
&gt; a reasonable trade.

If we were to care... looks like the sequence of expected events should be:
CHECKING, DOWNLOADING, ERROR and AssociateNoCache(GURL())?</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg8"
           name="7">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(7)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-7">
                          Description was changed from ========== appcache BUG=558589 ========== to ========== AppCache: fix a browser crashing ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 22:12:57 UTC)
                <a href="#msg8">#8</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-7"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-7"
            >Description was changed from

==========
appcache

BUG=558589
==========

to

==========
AppCache: fix a browser crashing bug that can happen during updates.

BUG=558589
==========</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    generated"
           style="display: none"
           id="generated-msg9"
           name="8">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(8)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>michaeln</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-8">
                          The CQ bit was checked by michaeln@chromium.org
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 23:00:32 UTC)
                <a href="#msg9">#9</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-8"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-8"
            >The CQ bit was checked by <a href="mailto:michaeln@chromium.org">michaeln@chromium.org</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message    "
           
           id="msg10"
           name="9">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(9)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-9">
                          CQ is trying da patch. Follow status at https://chromium-cq-status.appspot.com/patch-status/1463463003/20001 View timeline at https://chromium-cq-status.appspot.com/patch-timeline/1463463003/20001
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-20 23:00:55 UTC)
                <a href="#msg10">#10</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-9"
             style="display: none;">
          <div class="message-body">
            
            <pre name="cl-message-9"
            >CQ is trying da patch. Follow status at
 <a href="https://chromium-cq-status.appspot.com/patch-status/1463463003/20001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-status/1463463003/20001</a>
View timeline at
 <a href="https://chromium-cq-status.appspot.com/patch-timeline/1463463003/20001" rel="nofollow">https://chromium-cq-status.appspot.com/patch-timeline/1463463003/20001</a></pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg11"
           name="10">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(10)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-10">
                          Committed patchset #2 (id:20001)
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-21 00:42:05 UTC)
                <a href="#msg11">#11</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-10"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-10"
            >Committed patchset #2 (id:20001)</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg12"
           name="11">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(11)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>commit-bot: I haz the power</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden;"
                           class="extra"
                           id="cl-preview-11">
                          Patchset 2 (id:??) landed as https://crrev.com/e5c298b780737c53fa9aae44d6fef522931d88b0 Cr-Commit-Position: refs/heads/master@{#360967}
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-21 00:43:26 UTC)
                <a href="#msg12">#12</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-11"
             style="display: none;">
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-11"
            >Patchset 2 (id:??) landed as
<a href="https://crrev.com/e5c298b780737c53fa9aae44d6fef522931d88b0" rel="nofollow">https://crrev.com/e5c298b780737c53fa9aae44d6fef522931d88b0</a>
Cr-Commit-Position: refs/heads/master@{#360967}</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    
      <div class="message issue_was_closed   "
           
           id="msg13"
           name="12">
        <div class="header">
          <table border="0" width="100%" cellspacing="0" cellpadding="0">
            <tr class="comment_title"
                onclick="M_switchChangelistComment(12)">
              <td style="padding-left: 5px; white-space: nowrap;">
                <b>gzobqq</b>
              </td>
              <td width="100%" style="overflow:hidden;">
                <table style="table-layout:fixed; white-space: nowrap;"
                       width="100%">
                  <tr>
                    <td>
                      <span style="white-space: nowrap; overflow: hidden; display: none;"
                           class="extra"
                           id="cl-preview-12">
                          On 2015/11/20 21:19:15, michaeln wrote: &gt; https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc &gt; File content/browser/appcache/appcache_update_job.cc (right): &gt; &gt; https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431 &gt; ...
                      </span>
                    </td>
                  </tr>
                </table>
              </td>
              <td align="right"
                  style="white-space: nowrap; padding-right: 5px; padding-left: 3px;">
                5 years, 1 month ago
		(2015-11-21 09:37:20 UTC)
                <a href="#msg13">#13</a>
              </td>
            </tr>
          </table>
        </div>

        <div id="cl-comment-12"
             >
          <div class="message-body">
            
              <span class="extra-note">
                Message was sent while issue was closed.
              </span>
            
            <pre name="cl-message-12"
            >On 2015/11/20 21:19:15, michaeln wrote:
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; File content/browser/appcache/appcache_update_job.cc (right):
&gt; 
&gt;
<a href="https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/appcache_update_job.cc#newcode431" rel="nofollow">https://codereview.chromium.org/1463463003/diff/1/content/browser/appcache/ap...</a>
&gt; content/browser/appcache/appcache_update_job.cc:431: return;
&gt; On 2015/11/20 20:38:55, michaeln wrote:
&gt; &gt; On 2015/11/20 06:10:54, gzobqq wrote:
&gt; &gt; &gt; Do we care about lack of host notification?
&gt; &gt; 
&gt; &gt; we care more about the crash
&gt; &gt; 
&gt; &gt; for this to happen, the master resource load must succeed a moment earlier
and
&gt; &gt; then fail to load a moment later. this seems like a small corner case. i
think
&gt; &gt; trading minor correctness errors (visible events) in that case for
robustness
&gt; is
&gt; &gt; a reasonable trade.
&gt; 
&gt; If we were to care... looks like the sequence of expected events should be:
&gt; CHECKING, DOWNLOADING, ERROR and AssociateNoCache(GURL())?

If I&#39;m reading this correctly, it would be:
CHECKING
DOWNLOADING if group_-&gt;update_status() == DOWNLOADING
AssociateIncompleteCache(inprogress_cache_.get(), manifest_url_) if
inprogress_cache_
AssociateNoCache(GURL()) if inprogress_cache_
ERROR

The error notification has the difficulty that AppCacheErrorDetails takes the
(possibly redirected?) request-&gt;url() and response code. These come from the
first failed request and are not known later.</pre>
          </div>
          <div class="message-footer"></div>
        </div>

      </div>
    

    <div>
      <a href="javascript:M_expandAllVisibleComments('cl', 13)">
        Expand Messages</a>
      |
      <a href="javascript:M_collapseAllVisibleComments('cl', 13)">
        Collapse Messages</a>
      
      |
      <a href="javascript:M_showGeneratedComments(13)">
        Show Generated Messages</a>
      |
      <a href="javascript:M_hideGeneratedComments(13)">
        Hide Generated Messages</a>
      
    </div>

  </div>

<script language="JavaScript" type="text/javascript">
<!--
var lastMsgID = 13;
// -->
</script>




<script language="JavaScript" type="text/javascript">
  <!--
    document.onkeydown = M_changelistKeyDown;
    var dashboardState = new M_DashboardState(window, 'patch', 'M_CLPatchMarker');
    var issueId = 1463463003;
    M_toggleIssueOverviewByAnchor();
  // -->
</script>



      </td>
    </tr>
  </table>

</div>

  
    <div class="popup" id="popup-issue">
      <b>Issue 1463463003: AppCache: fix a browser crashing bug that can happen during updates.
     (Closed) </b><br/>
      Created 5 years, 1 month ago by michaeln<br/>
      Modified 5 years, 1 month ago<br/>
      Reviewers: gzobqq<br/>
      Base URL: https://chromium.googlesource.com/chromium/src.git@master<br/>
      Comments: 7
      
    </div>
  


<p></p>
<div style="float: left;">
  <a target="_blank" href="http://code.google.com/appengine/"><img border="0"
   src="/static/appengine-noborder-120x30.gif"
   alt="Powered by Google App Engine" /></a>
</div>

<div class="extra" style="font-size: 9pt; float: right; text-align: right;">
  <div style="margin-top: .3em;">This is Rietveld <a href='http://code.google.com/p/rietveld/source/list'>408576698
</a></div>
</div>


<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55762617-11', {
    'allowLinker': true,
    'siteSpeedSampleRate': 100
  });
  ga('require', 'linker');
  ga('linker:autoLink',
     ['chromiumcodereview.appspot.com', 'codereview.chromium.org'] );
  ga('send', 'pageview');

  // CRDX Feedback button.
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink',
      'https://bugs.chromium.org/p/chromium/issues/entry?cc=andybons@chromium.org&components=Infra%3ECodereview%3ERietveld&labels=Infra-DX');
</script>


</body>
</html>
