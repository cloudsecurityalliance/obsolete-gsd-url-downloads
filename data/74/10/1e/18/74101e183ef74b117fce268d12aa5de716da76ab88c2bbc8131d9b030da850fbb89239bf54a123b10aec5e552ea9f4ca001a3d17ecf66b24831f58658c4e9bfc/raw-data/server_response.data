<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-GB">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-GB">
<![endif]-->
<!--[if !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-GB">
<!--<![endif]-->
<head>
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <link rel="pingback" href="https://blog.milne.it/xmlrpc.php">  
<title>MikroTik RouterOS Security Vulnerability &#8211; L2TP Tunnel Unencrypted &#8211; CVE-2017-6297 &#8211; Milne.IT</title>
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Milne.IT &raquo; Feed" href="https://blog.milne.it/feed/" />
<link rel="alternate" type="application/rss+xml" title="Milne.IT &raquo; Comments Feed" href="https://blog.milne.it/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Milne.IT &raquo; MikroTik RouterOS Security Vulnerability &#8211; L2TP Tunnel Unencrypted &#8211; CVE-2017-6297 Comments Feed" href="https://blog.milne.it/2017/02/24/mikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/blog.milne.it\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.6"}};
			!function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='https://blog.milne.it/wp-includes/css/dist/block-library/style.min.css?ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-google-font2-css'  href='//fonts.googleapis.com/css?family=Aldrich&#038;subset=latin&#038;ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-google-font3-css'  href='//fonts.googleapis.com/css?family=Arimo&#038;subset=latin&#038;ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-google-font4-css'  href='//fonts.googleapis.com/css?family=Arimo&#038;subset=latin&#038;ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-google-font6-css'  href='//fonts.googleapis.com/css?family=Arimo&#038;subset=latin&#038;ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-style-css'  href='https://blog.milne.it/wp-content/themes/happenstance/style.css?ver=5.6' type='text/css' media='all' />
<style id='happenstance-style-inline-css' type='text/css'>
#wrapper #header .site-title { font-family: Aldrich, Arial, Helvetica, sans-serif; }
#wrapper #header .site-description {font-family: Arimo, Arial, Helvetica, sans-serif; }
#wrapper h1, #wrapper h2, #wrapper h3, #wrapper h4, #wrapper h5, #wrapper h6, #wrapper #container .navigation .section-heading, #wrapper .info-box .info-box-headline, #wrapper #comments .entry-headline, #wrapper #main-content .wrapper-related-posts .flexslider .slides li a, html #wrapper .header-image .header-image-text .header-image-headline { font-family: Arimo, Arial, Helvetica, sans-serif; }
#wrapper #container #sidebar .sidebar-widget .sidebar-headline, #wrapper #wrapper-footer #footer .footer-widget .footer-headline { font-family: Arimo, Arial, Helvetica, sans-serif; }
</style>
<link rel='stylesheet' id='happenstance-elegantfont-css'  href='https://blog.milne.it/wp-content/themes/happenstance/css/elegantfont.css?ver=5.6' type='text/css' media='all' />
<link rel='stylesheet' id='happenstance-google-font-default-css'  href='//fonts.googleapis.com/css?family=Oswald&#038;subset=latin%2Clatin-ext&#038;ver=5.6' type='text/css' media='all' />
<script type='text/javascript' src='https://blog.milne.it/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/html5.js?ver=3.7.3' id='happenstance-html5-ie-js'></script>
<![endif]-->
<link rel="https://api.w.org/" href="https://blog.milne.it/wp-json/" /><link rel="alternate" type="application/json" href="https://blog.milne.it/wp-json/wp/v2/posts/442" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blog.milne.it/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://blog.milne.it/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.6" />
<link rel="canonical" href="https://blog.milne.it/2017/02/24/mikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297/" />
<link rel='shortlink' href='https://blog.milne.it/?p=442' />
<link rel="alternate" type="application/json+oembed" href="https://blog.milne.it/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.milne.it%2F2017%2F02%2F24%2Fmikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://blog.milne.it/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.milne.it%2F2017%2F02%2F24%2Fmikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297%2F&#038;format=xml" />
<!--[if IE]>
<style type="text/css" media="screen">
#container-shadow, .attachment-post-thumbnail, .attachment-thumbnail {
        behavior: url("https://blog.milne.it/wp-content/themes/happenstance/css/pie/PIE.php");
        zoom: 1;
}
</style>
<![endif]-->
<style type="text/css" id="custom-background-css">
body.custom-background { background-color: #5e5e5e; }
</style>
	<link rel="icon" href="https://blog.milne.it/wp-content/uploads/2017/01/cropped-Favicon-32x32.png" sizes="32x32" />
<link rel="icon" href="https://blog.milne.it/wp-content/uploads/2017/01/cropped-Favicon-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://blog.milne.it/wp-content/uploads/2017/01/cropped-Favicon-180x180.png" />
<meta name="msapplication-TileImage" content="https://blog.milne.it/wp-content/uploads/2017/01/cropped-Favicon-270x270.png" />
		<style type="text/css" id="wp-custom-css">
			/*
You can add your own CSS here.

Click the help icon above to learn more.
*/

.PoshConsole {
  color: #EEEDF0;
  background-color: #012456;
  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace;
  font-size: 0.80em;
  padding: .25em;
  padding-top: 0.25em;
  padding-right: 0.25em;
  padding-bottom: 0.25em;
  padding-left: 0.25em;
  line-height: 1.1
}

.PoshError {
	color: #FF0000;
}		</style>
		  
</head> 
<body class="post-template-default single single-post postid-442 single-format-standard custom-background" id="wrapper">
<div class="pattern"></div> 
   
<div id="container">
<div id="container-shadow">
  <header id="header">
   
    <div class="header-content-wrapper">
    <div class="header-content">
      <p class="site-title"><a href="https://blog.milne.it/">Milne.IT</a></p>
      <p class="site-description">An IT Automation blog.  PowerShell, Linux, and more.  By Ryan Milne</p>
<form id="searchform" method="get" action="https://blog.milne.it/">
  <div class="searchform-wrapper"><input type="text" value="" name="s" id="s" placeholder="Search here..." />
  <input type="submit" class="send icon_search" name="searchsubmit" value="&#x55;" /></div>
</form>    </div>
    </div>
  <div class="menu-box-container">
    <div class="menu-box-wrapper">
    <div class="menu-box">
      <a class="link-home" href="https://blog.milne.it/"><i class="icon_house" aria-hidden="true"></i></a>
<div class="menu-header-container"><ul id="nav" class="menu"><li id="menu-item-157" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-157"><a href="https://blog.milne.it/about-me/">About Me</a></li>
<li id="menu-item-35" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35"><a href="https://blog.milne.it/category/powershell/">PowerShell</a></li>
<li id="menu-item-99" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-99"><a href="https://blog.milne.it/category/linux/">Linux</a></li>
</ul></div>    </div>
    </div>
  </div>
    
  </header> <!-- end of header -->

  <div id="wrapper-content">
  <div id="main-content">
  <div id="content" class="hentry"><p class="breadcrumb-navigation"><!-- Breadcrumb NavXT 6.6.0 -->
<span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to Milne.IT." href="https://blog.milne.it" class="home" ><span property="name">Milne.IT</span></a><meta property="position" content="1"></span> &gt; <span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to the MikroTik category archives." href="https://blog.milne.it/category/mikrotik/" class="taxonomy category" ><span property="name">MikroTik</span></a><meta property="position" content="2"></span> &gt; <span property="itemListElement" typeof="ListItem"><span property="name" class="post post-post current-item">MikroTik RouterOS Security Vulnerability &#8211; L2TP Tunnel Unencrypted &#8211; CVE-2017-6297</span><meta property="url" content="https://blog.milne.it/2017/02/24/mikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297/"><meta property="position" content="3"></span></p>    <div class="content-headline">   
      <h1 class="entry-headline title single-title entry-title"><span class="entry-headline-text">MikroTik RouterOS Security Vulnerability &#8211; L2TP Tunnel Unencrypted &#8211; CVE-2017-6297</span></h1>
    </div>
    <p class="post-meta">
      <span class="post-info-author vcard author"><i class="icon_pencil-edit" aria-hidden="true"></i><span class="fn"><a href="https://blog.milne.it/author/ryan-milne/" title="Posts by Ryan Milne" rel="author">Ryan Milne</a></span></span>
      <span class="post-info-date post_date date updated"><i class="icon_calendar" aria-hidden="true"></i>24 Feb 2017</span>
      <span class="post-info-comments"><i class="icon_comment_alt" aria-hidden="true"></i><a href="https://blog.milne.it/2017/02/24/mikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297/#respond">0 Comments</a></span>
    </p>
    <div class="post-info">
      <p class="post-category"><span class="post-info-category"><i class="icon_folder-alt" aria-hidden="true"></i><a href="https://blog.milne.it/category/mikrotik/" rel="category tag">MikroTik</a></span></p>
      <p class="post-tags"><span class="post-info-tags"><i class="icon_tag_alt" aria-hidden="true"></i><a href="https://blog.milne.it/tag/cve-2017-6297/" rel="tag">CVE-2017-6297</a>, <a href="https://blog.milne.it/tag/mikrotik/" rel="tag">MikroTik</a>, <a href="https://blog.milne.it/tag/security/" rel="tag">Security</a></span></p>
    </div>
    <div class="entry-content">
<p class="manual-excerpt">The L2TP Client in MikroTik RouterOS versions 6.83.3 and 6.37.4 does not enable IPsec encryption after a reboot.  This allows eavesdroppers to view the transmitted data unencrypted.  It also allows eavesdroppers to obtain L2TP client secrets and then establish tunnels to the L2TP servers, gaining unauthorised access to the networks they provide access to.</p>
<h1>Vulnerability Summary</h1>
<p>The L2TP Client in MikroTik RouterOS versions 6.83.3 and 6.37.4 does not enable IPsec encryption after a reboot.  This allows eavesdroppers to view the transmitted data unencrypted.  It also allows eavesdroppers to obtain L2TP client secrets and then establish tunnels to the L2TP servers, gaining unauthorised access to the networks they provide access to.</p>
<h1>Product overview</h1>
<p><a href="https://mikrotik.com/software">RouterOS</a> is a versatile operating system, as you might guess primarily intended to run as a router.  It is a modified version of Linux, where access to traditional GNU/Linux userland is not generally possible, and the device is instead maintained and configured through its own CLI, web interface, Windows GUI application (&#8220;WinBox&#8221;), and API.  RouterOS primarily runs on MikroTik / RouterBOARD hardware; however you can also download it as an x86 virtual machine, branded <strong>Cloud Hosted Router</strong> or <strong>CHR</strong>.</p>
<p>RouterOS is used by both individuals and businesses.  Hobbyists often run it on MikroTik hardware in homelabs as &#8211; compared to other routers priced for home use such as the DrayTek Vigor range &#8211; they are extremely powerful but also very affordable.  Businesses use them as affordable and powerful alternatives to Cisco hardware.</p>
<p>RouterOS supports various VPN and tunnelling protocols, including PPTP, L2TP, SSTP, OpenVPN.  As well as being able to operate as a server for these tunnels (as is standard for a router), it can also operate as a VPN client.</p>
<h1>Vulnerability overview</h1>
<p>When you configure an L2TP Client on RouterOS, you have the choice of whether or not to enable IPsec.  If you enable it, you configure the L2TP Client with the IPsec Secret.</p>
<div id="attachment_484" style="width: 499px" class="wp-caption alignnone"><a href="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_1.png"><img aria-describedby="caption-attachment-484" loading="lazy" src="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_1.png" alt="" width="489" height="539" class="size-full wp-image-484" srcset="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_1.png 489w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_1-272x300.png 272w" sizes="(max-width: 489px) 100vw, 489px" /></a><p id="caption-attachment-484" class="wp-caption-text">WinBox GUI showing an L2TP Client Interface with IPsec enabled and IPsec Secret specified.</p></div>
<p>In normal operation, when you enable an L2TP Client interface with IPsec enabled, RouterOS first attempts to establish an IPsec tunnel to the specified server.  If the IPsec tunnel is successfully established, all L2TP traffic is transmitted through this tunnel &#8211; including the L2TP authentication and any subsequent traffic.  If the IPsec tunnel is not successfully established, no L2TP connection is attempted.  If you disable and re-enable the L2TP Client interface, this process repeats.</p>
<p>However, if you configure and enable an L2TP Client interface with IPsec enabled and then reboot the router, <strong>RouterOS attempts the L2TP Client connection directly; not through IPsec</strong>.  If the L2TP server does not accept connections without IPsec, then the connection fails and the tunnel is never established until one disables and re-enables the interface.  However <strong>if the L2TP server also accepts connections without IPsec, an unencrypted L2TP tunnel is successfully established</strong>.</p>
<p>There is no direct feedback to the user that the L2TP tunnel has been established without IPsec encryption.  One can tell as follows:</p>
<ul>
<li>On RouterOS, viewing <strong>IP > IPsec > Policies</strong> in normal operation shows a dynamically created policy for the L2TP Client connection.  When this bug is triggered, there is no such policy.
<div id="attachment_485" style="width: 545px" class="wp-caption alignnone"><a href="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_2.png"><img aria-describedby="caption-attachment-485" loading="lazy" src="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_2.png" alt="" width="535" height="153" class="size-full wp-image-485" srcset="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_2.png 535w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_2-300x86.png 300w" sizes="(max-width: 535px) 100vw, 535px" /></a><p id="caption-attachment-485" class="wp-caption-text">L2TP tunnel in normal operation.  A dynamic IPsec policy is visible.</p></div>
<div id="attachment_486" style="width: 536px" class="wp-caption alignnone"><a href="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_3.png"><img aria-describedby="caption-attachment-486" loading="lazy" src="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_3.png" alt="" width="526" height="164" class="size-full wp-image-486" srcset="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_3.png 526w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_3-300x94.png 300w" sizes="(max-width: 526px) 100vw, 526px" /></a><p id="caption-attachment-486" class="wp-caption-text">L2TP tunnel after bug triggered.  The dynamic IPsec policy is missing.</p></div>
</li>
<li>On RouterOS, viewing the log in normal operation shows entries relating to the establishing of the IPsec tunnel &#8211; for example &#8220;<code>IPsec-SA established</code>&#8220;.  When this bug is triggered, these messages are not written to the log.</li>
<li>Capturing the physical interface&#8217;s packets (for example with Wireshark, or using RouterOS&#8217;s Packet Sniffer), would show ESP traffic in normal operation, i.e. encrypted so you cannot see the contents of the inner tunnel&#8217;s packets.  When this bug is triggered, the inner tunnel&#8217;s packets are not encrypted and can be read directly.
<div id="attachment_488" style="width: 744px" class="wp-caption alignnone"><a href="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4.png"><img aria-describedby="caption-attachment-488" loading="lazy" src="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4-1024x415.png" alt="" width="734" height="297" class="size-large wp-image-488" srcset="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4-1024x415.png 1024w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4-300x122.png 300w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4-768x311.png 768w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_4.png 1122w" sizes="(max-width: 734px) 100vw, 734px" /></a><p id="caption-attachment-488" class="wp-caption-text">L2TP tunnel in normal operation.  Traffic is encrypted by ESP (in this case over UDP 4500 due to NAT-Traversal.)</p></div>
<p><div id="attachment_491" style="width: 744px" class="wp-caption alignnone"><a href="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5.png"><img aria-describedby="caption-attachment-491" loading="lazy" src="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5-1024x420.png" alt="" width="734" height="301" class="size-large wp-image-491" srcset="https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5-1024x420.png 1024w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5-300x123.png 300w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5-768x315.png 768w, https://blog.milne.it/wp-content/uploads/2017/02/MikroTik_L2TP_5.png 1117w" sizes="(max-width: 734px) 100vw, 734px" /></a><p id="caption-attachment-491" class="wp-caption-text">L2TP tunnel after bug triggered.  Packets sent through the tunnel are visible outside, wrapped in the L2TP tunnel.  In this case you can see ICMP ping packets in both directions.</p></div>
</li>
</ul>
<h1>Impact</h1>
<p>Consider the following real-world scenario:  You wish to connect your MikroTik router to an L2TP/IPsec server.  The L2TP/IPsec server also accepts L2TP connections without IPsec.  The reason why unencrypted L2TP connections are accepted isn&#8217;t relevant, but for example it could either be a server configuration oversight, or it could be intentional.</p>
<ul>
<li>Oversight example: With a Linux server running <a href="https://libreswan.org/">libreswan</a> for IPsec and <a href="https://github.com/xelerance/xl2tpd">xl2tpd</a> for L2TP, you would normally use iptables to block L2TP traffic without an IPsec policy, and allow L2TP traffic encrypted by IPsec.  Those without a decent understanding of iptables are unlikely to set up these rules correctly, or even at all.  Even those with a good understanding can make innocent mistakes.
<p>See the example iptables INPUT chain below.  Some may think that, after rule 6 accepts L2TP/IPsec traffic, rule 7 is sufficient to drop L2TP unencrypted traffic.  However, if rule 6 has recently allowed an L2TP/IPsec connection, rule 4 can subsequently allow an unencrypted L2TP connection between the same IP addresses, as the connection tracking believes it&#8217;s an existing connection that should be allowed through.  Rule 2 is required prior to rule 4 in order to prevent this.</p>
<pre class="brush: plain; highlight: [4,6,8,9]; title: ; notranslate" title="">
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     icmp --  anywhere             anywhere
2    DROP       udp  --  anywhere             anywhere             udp dpt:l2f policy match dir in pol none
3    DROP       all  --  anywhere             anywhere             ctstate INVALID
4    ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
5    ACCEPT     udp  --  anywhere             anywhere             multiport dports isakmp,ipsec-nat-t
6    ACCEPT     udp  --  anywhere             anywhere             udp dpt:l2f policy match dir in pol ipsec
7    DROP       udp  --  anywhere             anywhere             udp dpt:l2f
8    DROP       all  --  anywhere             anywhere
</pre>
</li>
<li>Intentional example:  A server that is used for normal encrypted connections by road warriors, and also tunnels some other traffic between servers that is already satisfactorily encrypted and thus does not need to waste CPU on IPsec (e.g. SSH, HTTPS).</li>
</ul>
<p>This bug has two main consequences.</p>
<p>First, all of the traffic between the RouterOS L2TP Client and the L2TP server is unencrypted (without the user being made clearly aware), and can be intercepted by eavesdroppers on the wider internet with the relevant access.  Privacy is <strong>the</strong> core expectation of using a VPN, so this is gravely unacceptable behaviour.</p>
<p>By analogy, this bug is similar to if you tell your web browser to go to TLS-encrypted <strong>https</strong>://www.example.com, but it instead goes to unencrypted <strong>http</strong>://www.example.com.  Now, these days many websites and web servers have measures to ensure that HTTPS is used and HTTP connections never take place.  It&#8217;s good that webmasters are doing this &#8220;for the greater good&#8221;, but that doesn&#8217;t somehow make it the server&#8217;s responsibility &#8211; if the client is told to use encryption, it should use encryption.  At bare minimum, it should warn the user if an encrypted session is not established and an unencrypted one is going to be used instead.  Similarly, while it is certainly a best practice for an L2TP/IPsec server to prevent unencrypted L2TP connections, it&#8217;s not their responsibility to the client to do so.</p>
<p>Second, the L2TP authentication process is also unencrypted, which can allow an eavesdropper to compromise the L2TP server and/or network behind it.</p>
<p>In more detail, RouterOS can perform PPP authentication with PAP, MS-CHAP (v1 or v2), or CHAP.</p>
<ul>
<li>PAP &#8211; The L2TP password is transmitted in the clear, and so is unencrypted.  If the PPP authentication process is captured by an eavesdropper, they can easily obtain the L2TP password.</li>
<li>MS-CHAP (v1 or v2) &#8211; These mechanisms have known vulnerabilities.  If the PPP authentication process is captured by an eavesdropper, they will be able to crack the password with not much effort.</li>
<li>CHAP &#8211; As far as I know, CHAP does not have any vulnerabilities as such.  It does use MD5 as its cryptographic hash function however, which is quicker to crack than other hash algorithms and has known weaknesses.  So if the PPP authentication process is captured by an eavesdropper, depending on the quality of the password, they may be able to crack it.</li>
</ul>
<p>With PAP and MS-CHAP, the password is as good as given to the eavesdropper.  With CHAP, it depends on the strength of the password.  Overall, an eavesdropper has a much easier time obtaining the L2TP password, which will allow them to impersonate the user to the L2TP server and establish an L2TP tunnel.  Depending on the configuration of the L2TP server, this may give them access to internal networks intended to be protected from the outside world.</p>
<h1>Proof of concept</h1>
<p>The simplest proof of concept involves using two RouterOS instances &#8211; one as the L2TP server and one as the L2TP client.  The RouterOS L2TP server has to have IPsec either enabled or disabled &#8211; it cannot be configured to accept both encrypted and encrypted L2TP connections at the same time &#8211; so it is configured with IPsec disabled.  An L2TP client with IPsec enabled should thus fail to connect to this server, however after a reboot it does not.</p>
<ol>
<li>On the server instance:
<ul>
<li>Enable the L2TP server.</li>
<li>Configure an IP pool of addresses to give out to connecting clients.</li>
<li>Configure the ppp profile to use this IP pool.</li>
<li>Configure a PPP username and password.</li>
</ul>
<p>For example, on the command line:</p>
<pre class="brush: plain; title: ; notranslate" title="">
/ip pool
add name=L2TP ranges=192.168.123.10-192.168.123.20
/ppp profile
set *FFFFFFFE local-address=192.168.123.1 remote-address=L2TP
/interface l2tp-server server
set enabled=yes
/ppp secret
add name=ppp1 password=1234
</pre>
</li>
<li>On the client instance, configure the L2TP client as follows:
<ul>
<li>Configure the IP of the server instance.</li>
<li>Configure the PPP username and password.</li>
<li>Enable IPsec and set an IPsec secret.</li>
</ul>
<p>For example, on the command line, assuming the server instance has IP address 192.168.100.101:</p>
<pre class="brush: plain; title: ; notranslate" title="">
/interface l2tp-client
add connect-to=192.168.100.101 disabled=no ipsec-secret=5678 name=l2tp-out1 \
    password=1234 use-ipsec=yes user=ppp1
</pre>
</li>
<li>On the client instance, when you enable the L2TP client interface, the tunnel fails to establish.  If you review the logs, you can see that it attempted to establish an IPsec session.  If you view <strong>IP > IPsec > Policies</strong>, you can see that a dynamic IPsec policy has been created to ensure L2TP traffic is encrypted between the client and server.  This is working as expected, as the L2TP server is not configured to accept IPsec connections.</li>
<li>On the client instance, if you disable the client interface, you can see that the IPsec policy is deleted.  If you reenable the client interface, it is recreated, and the tunnel still fails to establish.  This is working as expected.</li>
<li>If you reboot the client instance operating system (for example with <code>/system reboot</code>), when the router starts back up, it will successfully establish the L2TP session.  The logs will show no IPsec session.  Under <strong>IP > IPsec > Policies</strong>, no policy has been created.  If you capture the traffic from the physical interface and send some traffic through the tunnel, you will be able to see the unencrypted packets encapsulated within L2TP without IPsec encapsulation.</li>
</ol>
<p>A different proof-of-concept more similar to real-world scenarios can be created using a Linux server using libreswan and xl2tpd, and <strong>not</strong> including iptables rules on the INPUT chain to drop port 1701 traffic that does not have an IPsec policy.  (<a href="https://github.com/hwdsl2/setup-ipsec-vpn">This script</a> is very useful for creating this configuration &#8211; remove any DROP rules for port 1701 after running it).  Such a server will accept L2TP connections either with or without IPsec.  Configuring the RouterOS L2TP Client correctly with IPsec enabled will establish L2TP/IPsec connections successfully in normal operation, as well as establish unencrypted L2TP connections without IPsec after a reboot.</p>
<h1>Vulnerable / tested versions</h1>
<p>RouterOS maintains two stable branches &#8211; &#8220;Current&#8221; and &#8220;Bugfix&#8221;.  This vulnerability has been demonstrated on both the latest Current (v6.83.3) and the latest Bugfix (v6.37.4) at the time of writing.  It is likely present in older versions as well.</p>
<h1>Solutions / Workarounds</h1>
<p>MikroTik Support have confirmed to me by email that this will be fixed in an upcoming version.</p>
<p>There are a few workarounds and mitigations:</p>
<ol>
<li>Create a firewall rule on the outbound chain that blocks unencrypted L2TP traffic.
<p>(Note: This is a good practice for L2TP/IPsec regardless of this vulnerability.)</p>
<p>This will block outbound L2TP traffic (including authentication) unless it is encrypted by IPsec.  When the server is rebooted, the L2TP tunnel will fail to establish until the L2TP client interface is manually disabled and re-enabled, but it will not perform the L2TP handshake or tunnel any packets over the open internet.</p>
<p>For example:</p>
<pre class="brush: plain; title: ; notranslate" title="">
/ip firewall filter add action=reject chain=output comment=&quot;Outbound - Block L2TP without IPsec&quot; ipsec-policy=out,none port=1701 protocol=udp reject-with=\
    icmp-admin-prohibited
</pre>
</li>
<li>Create a static IPsec policy identical to the dynamic policy created in normal operation when the L2TP Client Interface is enabled.  This policy will force the L2TP traffic to always be encrypted by IPsec, in lieu of the dynamic policy that is not created after a reboot.
<p>This workaround is difficult when dynamic IP addresses are involved and requires scripting to ensure the policy is kept up-to-date with the correct IP addresses.
</li>
<li>If possible / applicable, use a different type of tunnel to L2TP/IPsec.
<ul>
<li>IPIP/IPsec tunnels are unaffected by this issue.</li>
<li>GRE/IPsec tunnels have not been tested, but judging from the similarities between IPIP and GRE configuration and differences from L2TP configuration in the WinBox GUI, it seems likely that GRE is also unaffected.</li>
<li>OpenVPN and SSTP do not use IPsec for encryption, and so are unaffected.<br />
(Note: PPTP also does not use IPsec.  However PPTP has unrelated known weaknesses, and thus it is strongly recommended to avoid using it.)</li>
</ul>
</li>
</ol>
<p>Additionally, if the user also has control over the L2TP server, it would be a good practice to attempt to prevent unencrypted connections on the L2TP server as well, unless there is a need for unencrypted L2TP connections.</p>
<h1>Vendor contact</h1>
<p>MikroTik do not appear to have a specific method for reporting security vulnerabilities, so I contacted them through their support email address <a href="https://mikrotik.com/support">on their website</a>.  Overall, contact with MikroTik has had both positives and negatives.</p>
<p>On the positive side, support were very responsive and very polite.  They agreed that the vulnerability can be publicly disclosed immediately so as to warn their customers, and they certainly didn&#8217;t make any threats in relation to the disclosure.  They didn&#8217;t ask for any proof of ownership of a RouterOS licence or RouterBOARD product, which is normally a requirement for support according to their website.</p>
<p>On the negative side, MikroTik do not seem to have the appropriate procedures in place to handle vulnerability disclosure.  In particular there is no real way to securely communicate with them.  They did not offer GPG keys.  It seems very likely that the HTTPS form on their website simply generates an email that is sent to them, in all likelihood also unencrypted, and it&#8217;s a one-off form rather than a messaging portal &#8211; the conversation continued over email.  Furthermore, they requested the <code>supout.rif</code> file that RouterOS generates to assist in support issues, which I have discovered includes sensitive information such as IPsec secrets in plain text. They also seemed to put the onus on me to fully prove the bug &#8211; this is understandable if they have a bug bounty program, but as far as they know they do not, so they were relying on my goodwill.</p>
<ul>
<li>2017-02-17: Emailed support notifying of a security vulnerability, and asking for a secure method of contact.</li>
<li>2017-02-17: Support replied inviting to send the vulnerability over email.</li>
<li>2017-02-17: Replied expressing concern over providing details through unencrypted email.</li>
<li>2017-02-17: Support replied saying it&#8217;s up to me how to deliver the information, but suggested submitting through the mikrotik.com website&#8217;s HTTPS form.</li>
<li>2017-02-17: Submitted vulnerability details by HTTPS form.</li>
<li>2017-02-17: Received email response from support indicating resolution <a href="http://wiki.mikrotik.com/wiki/Manual:IP/IPsec#Allow_Only_Ipsec_Encapsulated_Traffic">on the MikroTik Wiki</a>.</li>
<li>2017-02-17: Replied informing them that this mainly applied to L2TP servers, and that this was still a security bug nonetheless.</li>
<li>2017-02-22: Support replied asking for <code>supout.rif</code> files for further diagnostic.</li>
<li>2017-02-22: Replied providing <code>supout.rif</code> files, and also a step-by-step for reproducing on CHR.</li>
<li>2017-02-23: Support replied confirming they could reproduce the bug and would fix it in a future version of RouterOS.</li>
<li>2017-02-23: Replied asking for an agreeable time before publicly disclosing the vulnerability.</li>
<li>2017-02-23: Support replied saying it can be disclosed now.  &#8220;It is better that other users know that such security problem may happen.&#8221;</li>
</ul>
<h1>Responsible Disclosure</h1>
<p>The technical ability of RouterOS&#8217;s &#8220;end-users&#8221; is generally quite high, so they are easily able to apply one of the workarounds / mitigations above, almost as easily as they would apply RouterOS updates.  Given this, and the fact that RouterOS does not update automatically, there is little security benefit to delaying disclosure until MikroTik release the update with the bug fixed.  Disclosing this vulnerability now has the greater security benefit of allowing RouterOS L2TP Client users to put in place suitable mitigations prior to MikroTik fixing the bug.</p>
<div id="happenstance-post-nav" class="navigation" role="navigation">
	<div class="nav-wrapper">
  <p class="nav-previous"><a href="https://blog.milne.it/2017/02/16/all-in-one-get-user-cmdlet-part-4-5-source-control-detour-with-tortoisehg-and-bitbucket/" title="All-in-one Get-User cmdlet: Part 4.5 - Source Control Detour with TortoiseHg and Bitbucket">&larr; Previous post</a></p>
	<p class="nav-next"><a href="https://blog.milne.it/2017/02/26/all-in-one-get-user-cmdlet-part-5-handling-edge-cases/" title="All-in-one Get-User cmdlet: Part 5 - Handling Edge Cases">Next post &rarr;</a></p>
   </div>
</div>
<div class="wrapper-related-posts">
      <h2 class="entry-headline">Related Posts</h2>  
      <div class="flexslider">      
        <ul class="slides">
	       <li><a title="MikroTik: NTP Servers as Domain Names" href="https://blog.milne.it/2017/05/21/mikrotik-ntp-servers-as-domain-names/"><img class="attachment-slider-thumb wp-post-image" src="https://blog.milne.it/wp-content/themes/happenstance/images/slide.jpg" alt="MikroTik: NTP Servers as Domain Names" /></a><a class="slider-link" title="MikroTik: NTP Servers as Domain Names" href="https://blog.milne.it/2017/05/21/mikrotik-ntp-servers-as-domain-names/">MikroTik: NTP Servers as Domain Names</a></li>
	       <li><a title="MikroTik: http-ping / Netwatch for HTTP" href="https://blog.milne.it/2017/05/05/mikrotik-http-ping-netwatch-for-http/"><img class="attachment-slider-thumb wp-post-image" src="https://blog.milne.it/wp-content/themes/happenstance/images/slide.jpg" alt="MikroTik: http-ping / Netwatch for HTTP" /></a><a class="slider-link" title="MikroTik: http-ping / Netwatch for HTTP" href="https://blog.milne.it/2017/05/05/mikrotik-http-ping-netwatch-for-http/">MikroTik: http-ping / Netwatch for HTTP</a></li>
        </ul>
      </div>
</div>

<div id="comments" class="comments-area">

	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Comment <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2017/02/24/mikrotik-routeros-security-vulnerability-l2tp-tunnel-unencrypted-cve-2017-6297/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://blog.milne.it/wp-comments-post.php" method="post" id="commentform" class="comment-form"><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p><label for="comment"></label><textarea id="comment" name="comment" cols="45" rows="8" aria-required="true" placeholder="Comment..."></textarea></p><p class="comment-form-author"><label for="author"></label> <input id="author" name="author" type="text" placeholder="Your name *" value=""  size="30" aria-required='true' /></p>
<p class="comment-form-email"><label for="email"></label> <input id="email" name="email" type="text" placeholder="E-mail *" value="" size="30" aria-required='true' /></p>
<p class="comment-form-url"><label for="url"></label> <input id="url" name="url" type="text" placeholder="Website" value="" size="30" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='442' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="d29654cc74" /></p><input type="hidden" id="ak_js" name="ak_js" value="68"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	
</div><!-- #comments .comments-area -->    </div>   
  </div> <!-- end of content -->
<aside id="sidebar">
<div id="search-2" class="sidebar-widget widget_search"><form id="searchform" method="get" action="https://blog.milne.it/">
  <div class="searchform-wrapper"><input type="text" value="" name="s" id="s" placeholder="Search here..." />
  <input type="submit" class="send icon_search" name="searchsubmit" value="&#x55;" /></div>
</form></div>
		<div id="recent-posts-2" class="sidebar-widget widget_recent_entries">
		 <p class="sidebar-headline"><span class="sidebar-headline-text">Recent Posts</span></p>
		<ul>
											<li>
					<a href="https://blog.milne.it/2017/06/15/dnscrypt-proxy-revisited-configuring-on-debian-raspbian-jessie/">dnscrypt-proxy Revisited: Configuring on Debian / Raspbian Jessie</a>
									</li>
											<li>
					<a href="https://blog.milne.it/2017/06/04/dnscrypt-proxy-revisited-installing-on-debian-raspbian-jessie/">dnscrypt-proxy Revisited: Installing on Debian / Raspbian Jessie</a>
									</li>
											<li>
					<a href="https://blog.milne.it/2017/05/21/mikrotik-ntp-servers-as-domain-names/">MikroTik: NTP Servers as Domain Names</a>
									</li>
											<li>
					<a href="https://blog.milne.it/2017/05/05/mikrotik-http-ping-netwatch-for-http/">MikroTik: http-ping / Netwatch for HTTP</a>
									</li>
											<li>
					<a href="https://blog.milne.it/2017/04/13/all-in-one-get-user-cmdlet-part-7-skype-for-business-online/">All-in-one Get-User cmdlet: Part 7 &#8211; Skype for Business Online</a>
									</li>
					</ul>

		</div><div id="text-2" class="sidebar-widget widget_text"> <p class="sidebar-headline"><span class="sidebar-headline-text">Planet PowerShell</span></p>			<div class="textwidget"><a href="http://www.planetpowershell.com/">
<img src="https://blog.milne.it/wp-content/uploads/2017/03/planet-powershell-300x126.png" /></a></div>
		</div><div id="archives-2" class="sidebar-widget widget_archive"> <p class="sidebar-headline"><span class="sidebar-headline-text">Archives</span></p>
			<ul>
					<li><a href='https://blog.milne.it/2017/06/'>June 2017</a></li>
	<li><a href='https://blog.milne.it/2017/05/'>May 2017</a></li>
	<li><a href='https://blog.milne.it/2017/04/'>April 2017</a></li>
	<li><a href='https://blog.milne.it/2017/03/'>March 2017</a></li>
	<li><a href='https://blog.milne.it/2017/02/'>February 2017</a></li>
	<li><a href='https://blog.milne.it/2017/01/'>January 2017</a></li>
			</ul>

			</div><div id="meta-2" class="sidebar-widget widget_meta"> <p class="sidebar-headline"><span class="sidebar-headline-text">Meta</span></p>
		<ul>
						<li><a href="https://blog.milne.it/wp-login.php">Log in</a></li>
			<li><a href="https://blog.milne.it/feed/">Entries feed</a></li>
			<li><a href="https://blog.milne.it/comments/feed/">Comments feed</a></li>

			<li><a href="https://en-gb.wordpress.org/">WordPress.org</a></li>
		</ul>

		</div></aside> <!-- end of sidebar -->
  </div> <!-- end of main-content -->
  </div> <!-- end of wrapper-content -->
<footer id="wrapper-footer">
</footer>  <!-- end of wrapper-footer -->
</div> <!-- end of container-shadow -->
</div> <!-- end of container -->
<script type='text/javascript' src='https://blog.milne.it/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b' id='syntaxhighlighter-core-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js?ver=3.0.9b' id='syntaxhighlighter-brush-plain-js'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://blog.milne.it/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.head.appendChild( corecss );
		var themecssurl = "https://blog.milne.it/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		document.head.appendChild( themecss );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script>
<script type='text/javascript' src='https://blog.milne.it/wp-includes/js/comment-reply.min.js?ver=5.6' id='comment-reply-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/flexslider.min.js?ver=2.6.1' id='happenstance-flexslider-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/flexslider-settings.js?ver=1.0' id='happenstance-flexslider-settings-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/placeholders.js?ver=2.0.8' id='happenstance-placeholders-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/scroll-to-top.js?ver=1.0' id='happenstance-scroll-to-top-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/menubox.js?ver=1.0' id='happenstance-menubox-js'></script>
<script type='text/javascript' id='happenstance-selectnav-js-extra'>
/* <![CDATA[ */
var HappenStanceSiteParameters = {"message_menu":"= Menu =","message_home":"Home","link_home":"https:\/\/blog.milne.it\/"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/selectnav.js?ver=0.1' id='happenstance-selectnav-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-content/themes/happenstance/js/responsive.js?ver=1.0' id='happenstance-responsive-js'></script>
<script type='text/javascript' src='https://blog.milne.it/wp-includes/js/wp-embed.min.js?ver=5.6' id='wp-embed-js'></script>
<script async="async" type='text/javascript' src='https://blog.milne.it/wp-content/plugins/akismet/_inc/form.js?ver=4.1.8' id='akismet-form-js'></script>
     
</body>
</html>
<!--
Performance optimized by W3 Total Cache. Learn more: https://www.boldgrid.com/w3-total-cache/


Served from: blog.milne.it @ 2021-10-30 17:09:33 by W3 Total Cache
-->