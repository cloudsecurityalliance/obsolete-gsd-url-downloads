<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #76129 - RDF' href='rss/bug.php?id=76129'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #76129 - RSS 2.0' href='rss/bug.php?id=76129&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #76129 :: fix for CVE-2018-5712 may not be complete</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=76129">Sec Bug</a>&nbsp;#76129</th>
            <td id="summary" colspan="5">fix for CVE-2018-5712 may not be complete</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2018-03-21 16:53 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2018-04-29 20:47 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>scorneli &#x61;&#116; redhat &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.1.15</td>
            <th class="details">OS:</th>
            <td>Fedora 27 (but probably global)</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10547" target="_blank">2018-10547</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=76129&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=76129&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=76129&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1521651212">&nbsp;</a><strong>[2018-03-21 16:53 UTC] scorneli &#x61;&#116; redhat &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
I've tested the fix for CVE-2018-5712 (<a href="http://git.php.net/?p=php-src.git;a=commit;h=4e3f55c36272a5f29b50e1924b78e9db1b23f214" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4e3f55c36272a5f29b50e1924b78e9db1b23f214</a>) and it does not appear to be sufficient for me.

The &quot;phar_do_404()&quot; function in ext/phar/phar_object.c also returns parts of the request unfiltered, leading to another XSS vector. I've tested this with Fedora 27's php-7.1.15 version. I've not tested a new vanilla upstream version to verify that it's affected, but I've checked the upstream git sources and they appear to be affected.

The &quot;phar_do_403()&quot; function shares similar code, so I've proactively changed that, too. Not tested, though.

I've attached a patch that I've used to test my theory.

I'm not sure if you guys are already aware of this issue, but I've not communicated this to any 3rd parties yet. I've also not requested a CVE ID yet.

Given that this can be easily figured by anyone testing CVE-2018-5712, I don't think that this needs any special embargo. However, if you want to embargo this, do you have a rough timeline when this would be OK for you to make public?

Thanks,

Stefan Cornelius / Red Hat Product Security

Test script:
---------------
I'm not doing anything out of the ordinary, really. Fedora 27 with default httpd/php config. The phar is a bare minimum phar package only printing phpinfo(). Although the phar file was build with a php version containing the original fix (4e3f55c36272a5f29b50e1924b78e9db1b23f214), I still can reproduce the XSS.

Expected result:
----------------
No XSS

Actual result:
--------------
XSS

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=76129'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=76129'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1521651438">&nbsp;</a><strong>[2018-03-21 16:57 UTC] scorneli &#x61;&#116; redhat &#x64;&#111;&#x74; com</strong>
<pre class='note'>I'm having problems attaching the patch (restricts my access, although I'm the reporter).

Maybe this will do as a workaround:
diff -pur php-7.1.15/ext/phar/phar_object.c php-7.1.15_patch/ext/phar/phar_object.c
--- php-7.1.15/ext/phar/phar_object.c	2018-02-28 12:19:23.000000000 +0100
+++ php-7.1.15_patch/ext/phar/phar_object.c	2018-03-21 16:59:02.846809270 +0100
@@ -307,9 +307,7 @@ static void phar_do_403(char *entry, int
 	ctr.line = &quot;HTTP/1.0 403 Access Denied&quot;;
 	sapi_header_op(SAPI_HEADER_REPLACE, &amp;ctr);
 	sapi_send_headers();
-	PHPWRITE(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;Access Denied&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;403 - File &quot;, sizeof(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;Access Denied&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;403 - File &quot;) - 1);
-	PHPWRITE(entry, entry_len);
-	PHPWRITE(&quot; Access Denied&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;, sizeof(&quot; Access Denied&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;) - 1);
+	PHPWRITE(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;Access Denied&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;403 - File Access Denied&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;, sizeof(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;Access Denied&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;403 - File Access Denied&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;) - 1);
 }
 /* }}} */
 
@@ -332,9 +330,7 @@ static void phar_do_404(phar_archive_dat
 	ctr.line = &quot;HTTP/1.0 404 Not Found&quot;;
 	sapi_header_op(SAPI_HEADER_REPLACE, &amp;ctr);
 	sapi_send_headers();
-	PHPWRITE(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;File Not Found&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;404 - File &quot;, sizeof(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;File Not Found&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;404 - File &quot;) - 1);
-	PHPWRITE(entry, entry_len);
-	PHPWRITE(&quot; Not Found&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;,  sizeof(&quot; Not Found&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;) - 1);
+	PHPWRITE(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;File Not Found&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;404 - File Not Found&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;, sizeof(&quot;&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;File Not Found&lt;/title&gt;\n &lt;/head&gt;\n &lt;body&gt;\n  &lt;h1&gt;404 - File Not Found&lt;/h1&gt;\n &lt;/body&gt;\n&lt;/html&gt;&quot;) - 1);
 }
 /* }}} */
</pre>
</div><div class='comment type_log' ><a name="1522211962">&nbsp;</a><strong>[2018-03-28 04:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1522211962">&nbsp;</a><strong>[2018-03-28 04:39 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Fix published in security repo as 4b7328615e1e51ba3ea79293bfd611ef7fa041fd and in <a href="https://gist.github.com/smalyshev/1e8e838c45653bb556f68af829d913ee" rel="nofollow">https://gist.github.com/smalyshev/1e8e838c45653bb556f68af829d913ee</a>. Please verify.
</pre>
</div><div class='comment type_comment' ><a name="1522798483">&nbsp;</a><strong>[2018-04-03 23:34 UTC] scorneli &#x61;&#116; redhat &#x64;&#111;&#x74; com</strong>
<pre class='note'>Hi,

Are you going to get a CVE for this?
</pre>
</div><div class='comment type_comment' ><a name="1522800091">&nbsp;</a><strong>[2018-04-04 00:01 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I don't think it needs separate CVE - it's the same issue, just in different place.
</pre>
</div><div class='comment type_comment' ><a name="1522851017">&nbsp;</a><strong>[2018-04-04 14:10 UTC] scorneli &#x61;&#116; redhat &#x64;&#111;&#x74; com</strong>
<pre class='note'>There have been new PHP versions and some downstream projects released updates fixing CVE-2018-5712 already. This additional fix can't have the same CVE without possibly leading to confusion.

I can also get a CVE ID for this, just let me know. I just want to avoid dupes/race condition when requesting the ID from MITRE.

Additionally, I've tested the patch and it seems to work for me.
</pre>
</div><div class='comment type_log' ><a name="1524516046">&nbsp;</a><strong>[2018-04-23 20:40 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: needed</span>
</div></div></div><div class='comment type_comment' ><a name="1524516080">&nbsp;</a><strong>[2018-04-23 20:41 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>OK I guess we can request a CVE and ask to link it to the previous one (not sure how they do it)
</pre>
</div><div class='comment type_log' ><a name="1524546766">&nbsp;</a><strong>[2018-04-24 05:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1524546766">&nbsp;</a><strong>[2018-04-24 05:12 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_log' ><a name="1525034879">&nbsp;</a><strong>[2018-04-29 20:47 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2018-10547</span>
</div></div></div><div class='comment type_comment' ><a name="1633520655">&nbsp;</a><strong>[2021-10-06 11:44 UTC] gustavowoltmann123 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Good post, But I am interested in Reddit. So I am focusing on free use Reddit for a long time. it's very effective <a href="https://nsdigitalworld.com/2021/09/25/free-use-reddit/" rel="nofollow">https://nsdigitalworld.com/2021/09/25/free-use-reddit/</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
