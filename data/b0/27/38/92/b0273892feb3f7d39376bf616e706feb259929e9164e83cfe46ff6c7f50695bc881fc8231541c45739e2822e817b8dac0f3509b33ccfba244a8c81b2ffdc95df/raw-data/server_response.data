<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy - #2 - Security - HashiCorp Discuss</title>
    <meta name="description" content="Bulletin ID: HCSEC-2021-09 
Affected Products / Versions: Vault and Vault Enterprise 1.5.1 and newer; fixed in 1.5.8, 1.6.4, and 1.7.1. 
Publication Date: April 21, 2021 
Summary 
Vault and Vault Enterprise (“Vault”) PKI&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.0.beta7 - https://github.com/discourse/discourse version 436edbb51a15c634e65c0d7cdccdb4ce9aecd8f1">
<link rel="icon" type="image/png" href="https://aws1.discourse-cdn.com/hashicorp/optimized/1X/768b0c508ad4facc44cabe5a30aff4d7f8afa863_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="https://aws1.discourse-cdn.com/hashicorp/optimized/1X/154331ed085112b536f7a0c4c5355c17a57e53c1_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="https://discuss.hashicorp.com/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://discuss.hashicorp.com","potentialAction":{"@type":"SearchAction","target":"https://discuss.hashicorp.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="https://discuss.hashicorp.com/opensearch.xml" title="HashiCorp Discuss Search">

      <link href="https://sea2.discourse-cdn.com/hashicorp/stylesheets/desktop_3efd433df85c59aaefb5500dd3bf1fda39cbdf6b.css?__ws=discuss.hashicorp.com" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="https://sea2.discourse-cdn.com/hashicorp/stylesheets/desktop_theme_19_b1232ab7e1a63dce3d47ad01483d60057495aa70.css?__ws=discuss.hashicorp.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="19" data-theme-name="discourse-hashicorp-theme"/>
    


<script src="https://sea2.discourse-cdn.com/hashicorp/theme-javascripts/d50ac3dedd3ea76578c300e5e62bc17c5b4f01d2.js?__ws=discuss.hashicorp.com"></script>
    <meta id="data-ga-universal-analytics" data-tracking-code="UA-36299135-17" data-json="{&quot;cookieDomain&quot;:&quot;auto&quot;}" data-auto-link-domains="">

  <link rel="preload" href="https://aws1.discourse-cdn.com/hashicorp/assets/google-universal-analytics-v3-706f1d28f0a97f67a47515c96189277240ec4940d968955042066d7873fd1fe8.gz.js" as="script">
<script src="https://aws1.discourse-cdn.com/hashicorp/assets/google-universal-analytics-v3-706f1d28f0a97f67a47515c96189277240ec4940d968955042066d7873fd1fe8.gz.js"></script>


        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy&#39;" href="https://discuss.hashicorp.com/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461.rss" />
    <meta property="og:site_name" content="HashiCorp Discuss" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://aws1.discourse-cdn.com/hashicorp/original/1X/154331ed085112b536f7a0c4c5355c17a57e53c1.png" />
<meta property="og:image" content="https://aws1.discourse-cdn.com/hashicorp/original/1X/154331ed085112b536f7a0c4c5355c17a57e53c1.png" />
<meta property="og:url" content="https://discuss.hashicorp.com/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461/2" />
<meta name="twitter:url" content="https://discuss.hashicorp.com/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461/2" />
<meta property="og:title" content="HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy" />
<meta name="twitter:title" content="HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy" />
<meta property="og:description" content="Bulletin ID: HCSEC-2021-09  Affected Products / Versions: Vault and Vault Enterprise 1.5.1 and newer; fixed in 1.5.8, 1.6.4, and 1.7.1.  Publication Date: April 21, 2021  Summary  Vault and Vault Enterprise (“Vault”) PKI Secrets Engine tidy functionality may cause Vault to exclude revoked-but-unexpired certificates from the Vault CRL. This vulnerability, CVE-2021-29653, was fixed in Vault and Vault Enterprise 1.5.8, 1.6.4, and 1.7.1.  Background  The Vault PKI Secrets Engine generates dynamic X...." />
<meta name="twitter:description" content="Bulletin ID: HCSEC-2021-09  Affected Products / Versions: Vault and Vault Enterprise 1.5.1 and newer; fixed in 1.5.8, 1.6.4, and 1.7.1.  Publication Date: April 21, 2021  Summary  Vault and Vault Enterprise (“Vault”) PKI Secrets Engine tidy functionality may cause Vault to exclude revoked-but-unexpired certificates from the Vault CRL. This vulnerability, CVE-2021-29653, was fixed in Vault and Vault Enterprise 1.5.8, 1.6.4, and 1.7.1.  Background  The Vault PKI Secrets Engine generates dynamic X...." />
<meta property="article:published_time" content="2021-04-21T20:29:10+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler">
    <!-- Replace icons -->






<script src="https://sea2.discourse-cdn.com/hashicorp/theme-javascripts/350479ec786d3192eb5f22fc034f23a6abba1c60.js?__ws=discuss.hashicorp.com"></script>
    <header>
      <a href="/">
          <img src="https://aws1.discourse-cdn.com/hashicorp/original/1X/668e19cbc79e3eaa176133c3679dc30aa57ba474.svg" alt="HashiCorp Discuss" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461">HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy</a>
    </h1>

      <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="https://discuss.hashicorp.com/c/security/52" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #0088CC'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Security</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='https://discuss.hashicorp.com/tag/security-vault' class='discourse-tag' rel="tag">security-vault</a>
        </div>
      </div>
  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
            <meta itemprop='name' content='HashiCorp'>
              <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                <meta itemprop='url' content='https://aws1.discourse-cdn.com/hashicorp/original/1X/668e19cbc79e3eaa176133c3679dc30aa57ba474.svg'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://discuss.hashicorp.com/u/jfinnigan'><span itemprop='name'>jfinnigan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="https://discuss.hashicorp.com/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-04-21T20:29:10Z' class='post-time'>
                April 21, 2021,  8:29pm
              </time>
              <meta itemprop='dateModified' content='2021-04-21T20:29:10Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p><strong>Bulletin ID:</strong> HCSEC-2021-09<br>
<strong>Affected Products / Versions:</strong> Vault and Vault Enterprise 1.5.1 and newer; fixed in 1.5.8, 1.6.4, and 1.7.1.<br>
<strong>Publication Date:</strong> April 21, 2021</p>
<p><strong>Summary</strong><br>
Vault and Vault Enterprise (“Vault”) PKI Secrets Engine tidy functionality may cause Vault to exclude revoked-but-unexpired certificates from the Vault CRL. This vulnerability, CVE-2021-29653, was fixed in Vault and Vault Enterprise 1.5.8, 1.6.4, and 1.7.1.</p>
<p><strong>Background</strong><br>
The Vault <a href="https://www.vaultproject.io/docs/secrets/pki">PKI Secrets Engine</a> generates dynamic X.509 certificates, supported by Vault’s built-in authentication and authorization mechanisms. Vault provides API endpoints for <a href="https://www.vaultproject.io/api/secret/pki#generate-certificate">certification generation</a> and <a href="https://www.vaultproject.io/api/secret/pki#revoke-certificate">certificate revocation</a>, among other PKI actions. Vault also exposes a <a href="https://www.vaultproject.io/api/secret/pki#read-crl">certificate revocation list</a> (CRL) that can be used to enforce certificate revocation.</p>
<p>The PKI Secrets Engine’s <a href="https://www.vaultproject.io/api/secret/pki#tidy">tidy</a> endpoint allows tidying up the storage backend and/or CRL by removing certificates that have expired and are past a certain buffer period beyond their expiration time. The <a href="https://www.vaultproject.io/api/secret/pki#tidy_revoked_certs">tidy_revoked_certs</a> parameter, which defaults to false, can be set to true to expire all revoked and expired certificates, removing them both from the CRL and from storage.</p>
<p><strong>Details</strong><br>
It was discovered that a change to the tidy_revoked_certs logic, released in Vault 1.5.1, had an unintended effect of removing revoked-but-unexpired certificates from Vault’s CRL. Environments that utilize this feature may have such certificates excluded from their CRL after a tidy operation and subsequently treated as valid since they are no longer in the CRL and not yet past their NotAfter value.</p>
<p>The tidy_revoked_certificates logic for Vault 1.5.1 permanently removed the revoked certificates from Vault storage and, even when the update is applied, a correct CRL cannot be regenerated.</p>
<p>Exposure to this issue requires several conditions to be met:</p>
<ol>
<li>Use the PKI Secrets Engine provided by Vault 1.5.1 or newer.</li>
<li>Use the PKI engine’s <a href="https://www.vaultproject.io/api/secret/pki#revoke-certificate">certificate revocation mechanism</a>.</li>
<li>Use and enforce the PKI engine’s <a href="https://www.vaultproject.io/api/secret/pki#read-crl">certificate revocation list</a>.</li>
<li>Use the PKI engine’s <a href="https://www.vaultproject.io/api/secret/pki#tidy">tidy mechanism</a>, with tidy_revoked_certs parameter set to non-default true.</li>
</ol>
<p>Condition 1 may be investigated by obtaining the current Vault version through the web UI or the /sys/health endpoint. Conditions 2, 3, and 4 may be investigated by reviewing Vault audit or Vault supporting infrastructure (eg. load balancer) logs for usage of the certificate revocation, CRL, and tidy API endpoints (/pki/revoke, /pki/crl, and /pki/tidy).</p>
<p>Even with all conditions met, exposure will be environment-dependent and will vary depending on PKI design, PKI certificate use case, and certificate TTL.</p>
<p><strong>Remediation</strong><br>
Customers should review their Vault environment for the conditions noted above, evaluate the risk associated with this issue, and consider upgrading to Vault Enterprise 1.5.8 / 1.6.4 / 1.7.1 or newer. Please refer to <a href="https://www.vaultproject.io/docs/upgrading">Upgrading Vault</a> for general guidance and version-specific upgrade notes.</p>
<p>Customers for whom the four conditions noted above are true should consider exposure in the context of their environment and PKI design. For example, if all conditions above have been met in an environment where long-lived certificates have been issued and subsequently revoked, and the exclusion of these certificates from the CRL presents unacceptable risk, then it may be necessary to rotate root and/or intermediate CAs to force invalidation of those certificates.</p>
<p>More generally, customers using the PKI secrets engine should consider the lifetime of certificates being issued. By keeping TTLs relatively short, revocations are less likely to be needed, keeping CRLs short and helping the secrets engine scale to large workloads. The Vault documentation contains <a href="https://www.vaultproject.io/docs/secrets/pki#keep-certificate-lifetimes-short-for-crl-s-sake">guidance</a> on this topic.</p>
<p><strong>Acknowledgement</strong><br>
This issue was identified by an external party who reported it to HashiCorp.</p>
<p><em>We deeply appreciate any effort to discover and disclose security vulnerabilities responsibly. For information about security at HashiCorp and the reporting of security vulnerabilities, please see <a href="https://hashicorp.com/security">https://hashicorp.com/security</a>.</em></p>
        </div>

        <meta itemprop='headline' content='HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy'>
          <meta itemprop='keywords' content='security-vault'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='/' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='/categories' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='/guidelines' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  
</html>
