<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='Filesystem function related Bug #77630 - RDF' href='rss/bug.php?id=77630'>
        <link rel='alternate' type='application/rss+xml' title='Filesystem function related Bug #77630 - RSS 2.0' href='rss/bug.php?id=77630&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #77630 :: rename() across the device may allow unwanted access during processing</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=77630">Sec Bug</a>&nbsp;#77630</th>
            <td id="summary" colspan="5">rename() across the device may allow unwanted access during processing</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2019-02-18 00:39 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2019-03-12 19:57 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>manabu &#x64;&#111;&#x74; matsui &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=Filesystem+function+related">Filesystem function related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.1.26</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9637" target="_blank">2019-9637</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=77630&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=77630&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=77630&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1550450365">&nbsp;</a><strong>[2019-02-18 00:39 UTC] manabu &#x64;&#111;&#x74; matsui &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
I tried to strace rename across devices, and the process was done as follows.
(Only system calls that should be noticed are pulled out so as not to become too long)

openat(AT_FDCWD, &quot;/boot/hoge/oldfile&quot;, O_RDONLY) = 3
openat(AT_FDCWD, &quot;/tmp/dstdir/newfile&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 4
(mmap and write contents)
chmod(&quot;/tmp/dstdir/newfile&quot;, 0100664)       = 0
chown(&quot;/tmp/dstdir/newfile&quot;, 1000, 1000)    = 0
unlink(&quot;oldfile&quot;)                           = 0

Until chown is done, users who were not allowed to access to oldfile may be able to access newfile.

It is not impossible to avoid this problem by properly controlling environments such as umask, effective-gid (in case of linux semantics), group of destination directory (in case of bsd semantics).

However,  it is handled like mv command of GNU-oreutils, for example, there is no need for special preparation, so I think it will be safer.

* unlink newfile before open and open with O_EXCL to ensure that we do not open inappropriate file created by someone.
* open newfile with mode=600 to ensure that access from unwanted users is prevented during copying process.
* do chmod after chown to ensure that group access is not enabled until the group to which file belongs is set properly.



</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=77630'>Add a Patch</a></p><h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/php-src/pull/3766">list interfaces/adding just &quot;binary&quot; state status.</a>
      (php-src/3766)</li>
</ul>
</div>
<p><a href='gh-pull-add.php?bug_id=77630'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1550525275">&nbsp;</a><strong>[2019-02-18 21:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Feedback</span>
</div></div></div><div class='comment type_comment' ><a name="1550525275">&nbsp;</a><strong>[2019-02-18 21:27 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>On UNIX, PHP uses libc rename function. Thus, if you think renaming is done wrong, I think it should be submitted to libc maintainers for your system. If you use non-UNIX system, please specify which one.
</pre>
</div><div class='comment type_log' ><a name="1550525394">&nbsp;</a><strong>[2019-02-18 21:29 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Feedback</span>
<span class="added">+Status: Open</span>
</div></div></div><div class='comment type_comment' ><a name="1550525394">&nbsp;</a><strong>[2019-02-18 21:29 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Correction - there's a separate code for handling EXDEV, so it's possible the issue is in the code. I'll check it.
</pre>
</div><div class='comment type_comment' ><a name="1550526760">&nbsp;</a><strong>[2019-02-18 21:52 UTC] manabu &#x64;&#111;&#x74; matsui &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>This is a problem when VCWD_RENAME() fails with EXDEV.

In this case, the current implementation will execute php_copy_file(), VCWD_CHMOD(), VCWD_CHOWN() in this order.

This is around the php_plain_files_rename() function in main/streams/plain_wrapper.c.


	ret = VCWD_RENAME(url_from, url_to);

	if (ret == -1) {
#ifndef PHP_WIN32
# ifdef EXDEV
		if (errno == EXDEV) {
			zend_stat_t sb;
			if (php_copy_file(url_from, url_to) == SUCCESS) {
				if (VCWD_STAT(url_from, &amp;sb) == 0) {
#  ifndef TSRM_WIN32
					if (VCWD_CHMOD(url_to, sb.st_mode)) {
						if (errno == EPERM) {
							php_error_docref2(NULL, url_from, url_to, E_WARNING, &quot;%s&quot;, strerror(errno));
							VCWD_UNLINK(url_from);
							return 1;
						}
						php_error_docref2(NULL, url_from, url_to, E_WARNING, &quot;%s&quot;, strerror(errno));
						return 0;
					}
					if (VCWD_CHOWN(url_to, sb.st_uid, sb.st_gid)) {
						if (errno == EPERM) {
							php_error_docref2(NULL, url_from, url_to, E_WARNING, &quot;%s&quot;, strerror(errno));
							VCWD_UNLINK(url_from);
							return 1;
						}
						php_error_docref2(NULL, url_from, url_to, E_WARNING, &quot;%s&quot;, strerror(errno));
						return 0;
					}
#  endif
					VCWD_UNLINK(url_from);
					return 1;
				}
			}
			php_error_docref2(NULL, url_from, url_to, E_WARNING, &quot;%s&quot;, strerror(errno));
			return 0;
		}
# endif
#endif
</pre>
</div><div class='comment type_comment' ><a name="1550527032">&nbsp;</a><strong>[2019-02-18 21:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I have a feeling that the best practice here would be just to have proper umask, if this is indeed a problem. Switching CHOWN/CHMOD may make sense (error handling probably will have to be adjusted... not sure).
</pre>
</div><div class='comment type_comment' ><a name="1551599266">&nbsp;</a><strong>[2019-03-03 07:47 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Proposed fix in <a href="https://gist.github.com/smalyshev/4198b4573b002884ff552cffccbf050a" rel="nofollow">https://gist.github.com/smalyshev/4198b4573b002884ff552cffccbf050a</a>, please verify.
</pre>
</div><div class='comment type_log' ><a name="1551599305">&nbsp;</a><strong>[2019-03-03 07:48 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.3.2</span>
<span class="added">+PHP Version: 7.1.26</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID:      needed</span>
</div></div></div><div class='comment type_log' ><a name="1551685104">&nbsp;</a><strong>[2019-03-04 07:38 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1551685104">&nbsp;</a><strong>[2019-03-04 07:38 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The fix for this bug has been committed.

Snapshots of the sources are packaged every three hours; this change
will be in the next snapshot. You can grab the snapshot at
<a href="http://snaps.php.net/" rel="nofollow">http://snaps.php.net/</a>.

 For Windows:

<a href="http://windows.php.net/snapshots/" rel="nofollow">http://windows.php.net/snapshots/</a>
 
Thank you for the report, and for helping us make PHP better.


</pre>
</div><div class='comment type_svn' ><a name="1551720072">&nbsp;</a><strong>[2019-03-04 17:21 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=e3133e4db70476fb7adfdedb738483e2255ce0e1" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=e3133e4db70476fb7adfdedb738483e2255ce0e1</a>
Log: Fix <a href='bug.php?id=77630'>bug #77630</a> - safer rename() procedure
</pre>
</div><div class='comment type_log' ><a name="1552420632">&nbsp;</a><strong>[2019-03-12 19:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2019-9637</span>
</div></div></div><div class='comment type_patch' ><a name="1553948643">&nbsp;</a><strong>[2019-03-30 12:24 UTC] </strong>
<pre class='note'>The following pull request has been associated:

Patch Name: list interfaces/adding just &quot;binary&quot; state status.
On GitHub:  <a href="https://github.com/php/php-src/pull/3766" rel="nofollow">https://github.com/php/php-src/pull/3766</a>
Patch:      <a href="https://github.com/php/php-src/pull/3766.patch" rel="nofollow">https://github.com/php/php-src/pull/3766.patch</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
