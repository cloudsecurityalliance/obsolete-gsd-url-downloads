<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #76557 - RDF' href='rss/bug.php?id=76557'>
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #76557 - RSS 2.0' href='rss/bug.php?id=76557&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #76557 :: heap-buffer-overflow (READ of size 48) while reading exif data</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=76557">Sec Bug</a>&nbsp;#76557</th>
            <td id="summary" colspan="5">heap-buffer-overflow (READ of size 48) while reading exif data</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2018-07-01 00:34 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2018-08-03 02:56 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=kalle">kalle</a> (<a href="https://people.php.net/kalle">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=EXIF+related">EXIF related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.6.36</td>
            <th class="details">OS:</th>
            <td>Debian 9 x64</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-14851" target="_blank">2018-14851</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=76557&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=76557&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=76557&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1530405294">&nbsp;</a><strong>[2018-07-01 00:34 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>Description:
------------
USE_ZEND_ALLOC=0 ./php-7.2.7 -r '$exif = exif_read_data(&quot;<a href="http://dtf.pw/php727/poc/630/test000.jpeg&quot;" rel="nofollow">http://dtf.pw/php727/poc/630/test000.jpeg&quot;</a>); var_dump($exif);'


Expected result:
----------------
No crash.

Actual result:
--------------
==996==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x61d000011958 at pc 0x0000004ce426 bp 0x7ffc064d6a00 sp 0x7ffc064d61b0
READ of size 48 at 0x61d000011958 thread T0
    #0 0x4ce425 in __asan_memcpy /b/build/slave/linux_upload_clang/build/src/third_party/llvm/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:23:3
    #1 0x13f4905 in _estrndup /root/php-7.2.7/Zend/zend_alloc.c:2538:2
    #2 0xe039ad in exif_iif_add_value /root/php-7.2.7/ext/exif/exif.c:2119:21
    #3 0xe039ad in exif_iif_add_tag /root/php-7.2.7/ext/exif/exif.c:2199
    #4 0xe0b818 in exif_process_IFD_TAG /root/php-7.2.7/ext/exif/exif.c:3543:2
    #5 0xe0bccf in exif_process_IFD_in_MAKERNOTE /root/php-7.2.7/ext/exif/exif.c:3213:8
    #6 0xe0bccf in exif_process_IFD_TAG /root/php-7.2.7/ext/exif/exif.c:3494
    #7 0xe08c15 in exif_process_IFD_in_JPEG /root/php-7.2.7/ext/exif/exif.c:3576:8
    #8 0xe0ac0e in exif_process_IFD_TAG /root/php-7.2.7/ext/exif/exif.c:3534:11
    #9 0xe08c15 in exif_process_IFD_in_JPEG /root/php-7.2.7/ext/exif/exif.c:3576:8
    #10 0xe014c0 in exif_process_TIFF_in_JPEG /root/php-7.2.7/ext/exif/exif.c:3665:2
    #11 0xe014c0 in exif_process_APP1 /root/php-7.2.7/ext/exif/exif.c:3690
    #12 0xe014c0 in exif_scan_JPEG_header /root/php-7.2.7/ext/exif/exif.c:3835
    #13 0xe014c0 in exif_scan_FILE_header /root/php-7.2.7/ext/exif/exif.c:4224
    #14 0xe014c0 in exif_read_from_impl /root/php-7.2.7/ext/exif/exif.c:4365
    #15 0xe014c0 in exif_read_from_stream /root/php-7.2.7/ext/exif/exif.c:4382
    #16 0xdf8f18 in exif_read_from_file /root/php-7.2.7/ext/exif/exif.c:4409:8
    #17 0xdf8f18 in zif_exif_read_data /root/php-7.2.7/ext/exif/exif.c:4482
    #18 0x17c5d34 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER /root/php-7.2.7/Zend/zend_vm_execute.h:617:2
    #19 0x15ed419 in execute_ex /root/php-7.2.7/Zend/zend_vm_execute.h:59723:7
    #20 0x15eda9a in zend_execute /root/php-7.2.7/Zend/zend_vm_execute.h:63760:2
    #21 0x14758eb in zend_eval_stringl /root/php-7.2.7/Zend/zend_execute_API.c:1082:4
    #22 0x1475fb9 in zend_eval_stringl_ex /root/php-7.2.7/Zend/zend_execute_API.c:1123:11
    #23 0x1475fb9 in zend_eval_string_ex /root/php-7.2.7/Zend/zend_execute_API.c:1134
    #24 0x18c4aea in do_cli /root/php-7.2.7/sapi/cli/php_cli.c:1044:8
    #25 0x18c2c03 in main /root/php-7.2.7/sapi/cli/php_cli.c:1405:18
    #26 0x7f43ac6d32e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
    #27 0x427479 in _start (/root/php-7.2.7/sapi/cli/php+0x427479)

Address 0x61d000011958 is a wild pointer.
SUMMARY: AddressSanitizer: heap-buffer-overflow /b/build/slave/linux_upload_clang/build/src/third_party/llvm/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:23:3 in __asan_memcpy

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=76557'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=76557'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_log' ><a name="1530464625">&nbsp;</a><strong>[2018-07-01 17:03 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Verified</span>
</div></div></div><div class='comment type_comment' ><a name="1530464625">&nbsp;</a><strong>[2018-07-01 17:03 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thanks for reporting this issue!  I can confirm the OOB read with
valgrind on PHP-7.1 and master (haven't tested other versions).
</pre>
</div><div class='comment type_log' ><a name="1530500378">&nbsp;</a><strong>[2018-07-02 02:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: kalle</span>
</div></div></div><div class='comment type_log' ><a name="1530500392">&nbsp;</a><strong>[2018-07-02 02:59 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-PHP Version: 7.2.7</span>
<span class="added">+PHP Version: 5.6.36</span>
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID:      needed</span>
</div></div></div><div class='comment type_comment' ><a name="1530505209">&nbsp;</a><strong>[2018-07-02 04:20 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I am not sure whether I understand the code right or not, but it looks to me like the problem is in exif_process_IFD_in_MAKERNOTE, where the code changes offset_base:

	switch (maker_note-&gt;offset_mode) {
		case MN_OFFSET_MAKER:
			offset_base = value_ptr;

... etc.

When offset_base is changed, both IFDlength and displacement stay the same, so when the values in exif_process_IFD_TAG() are verified:

		if (byte_count &gt; IFDlength || offset_val &gt; IFDlength-byte_count || value_ptr &lt; dir_entry || offset_val &lt; (size_t)(dir_entry-offset_base)) {

they are checked against the same IFDlength values as before, however the code uses new offset_base:

		value_ptr = offset_base+offset_val;

So if that offset_base is more than before, and offset_val is checked the length measured with old base, the new value can cause reading outside the data that is loaded.
</pre>
</div><div class='comment type_log' ><a name="1530508976">&nbsp;</a><strong>[2018-07-02 05:22 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Verified</span>
<span class="added">+Status: Assigned</span>
</div></div></div><div class='comment type_comment' ><a name="1530508977">&nbsp;</a><strong>[2018-07-02 05:22 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Proposed fix in <a href="https://gist.github.com/smalyshev/9e3197a51b489ab0ecb2438da6f4d59f" rel="nofollow">https://gist.github.com/smalyshev/9e3197a51b489ab0ecb2438da6f4d59f</a> and in security repo as 53cb7bf758cb1137239b069c5642ac00736bf787. Please verify.
</pre>
</div><div class='comment type_related' ><a name="1530509209">&nbsp;</a><strong>[2018-07-02 05:26 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Related To: <a href='bug.php?id=76558'>Bug #76558</a>
</pre>
</div><div class='comment type_comment' ><a name="1530540154">&nbsp;</a><strong>[2018-07-02 14:02 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>I can confirm the proposed patch fixes this issue (and #76558) in PHP 7.2.7.
</pre>
</div><div class='comment type_svn' ><a name="1531785475">&nbsp;</a><strong>[2018-07-16 23:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=3462efa386f26d343062094514af604c29e3edce" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=3462efa386f26d343062094514af604c29e3edce</a>
Log: Fix <a href='bug.php?id=76557'>bug #76557</a>: heap-buffer-overflow (READ of size 48) while reading exif data
</pre>
</div><div class='comment type_log' ><a name="1531785475">&nbsp;</a><strong>[2018-07-16 23:57 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1533236454">&nbsp;</a><strong>[2018-08-02 19:00 UTC] geeknik &#x61;&#116; protonmail &#x64;&#111;&#x74; ch</strong>
<pre class='note'>CVE-2018-14851 has been assigned to this bug.
</pre>
</div><div class='comment type_log' ><a name="1533265003">&nbsp;</a><strong>[2018-08-03 02:56 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID: needed</span>
<span class="added">+CVE-ID: 2018-14851</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
