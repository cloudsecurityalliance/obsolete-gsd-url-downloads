<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #68113 - RDF' href='rss/bug.php?id=68113'>
        <link rel='alternate' type='application/rss+xml' title='EXIF related Bug #68113 - RSS 2.0' href='rss/bug.php?id=68113&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #68113 :: Heap corruption in exif_thumbnail()</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=68113">Sec Bug</a>&nbsp;#68113</th>
            <td id="summary" colspan="5">Heap corruption in exif_thumbnail()</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2014-09-28 23:31 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2014-10-14 17:41 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>stas@php.net</td>
            <th class="details">Assigned:</th>
            <td></td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=EXIF+related">EXIF related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>5.4.33</td>
            <th class="details">OS:</th>
            <td>*</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3670" target="_blank">2014-3670</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=68113&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=68113&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=68113&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1411947086">&nbsp;</a><strong>[2014-09-28 23:31 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Description:
------------
Report by Otto Ebeling:



Hi,

IÂ¹d like to report a bug that causes heap corruption when parsing
the thumbnail of a specially crafted .jpg image. Could you confirm
that you can repro and provide an estimated timeline for releasing
the fix so we can coordinate this with the HHVM team as HHVM contains
the affected code as well?

Details:
PHP provides APIs such as exif_thumbnail that can be used to extract
embedded thumbnails from various image formats. In the process of
extracting a TIFF-formatted EXIF thumbnail from a JPEG image, PHP
re-encodes most IFD tags present in the thumbnail directory and
prepends them to the thumbnail image in order to produce a standalone
TIFF file. Individual values are re-encoded using the
exif_ifd_make_value function.

If this function is asked to write out an array of floating point
values (single or double precision), it erroneously uses the size
of the whole array when copying individual elements using memmove,
leading to heap corruption.

See:
<a href="https://github.com/php/php-src/blob/dbccc8c112e0afaa34db7a913096f849a02da4de/ext/exif/exif.c#L2447" rel="nofollow">https://github.com/php/php-src/blob/dbccc8c112e0afaa34db7a913096f849a02da4de/ext/exif/exif.c#L2447</a>
byte_count is the length of the entire array as calculated at
<a href="https://github.com/php/php-src/blob/dbccc8c112e0afaa34db7a913096f849a02da4de/ext/exif/exif.c#L2390" rel="nofollow">https://github.com/php/php-src/blob/dbccc8c112e0afaa34db7a913096f849a02da4de/ext/exif/exif.c#L2390</a>

In addition to this, the 'from' pointer of the memmove calls point
to the pointer to the array, not its contents. Instead of
&amp;info_data-&gt;value.f, the code should be using &amp;info_value-&gt;f

To exploit a target application that uses this API (or exif_read_data with
suitable parameters), a malicious user can trigger this condition by
supplying a tag that contains an array of floating-point values, and
futher tags that indicate the presence of a TIFF thumbnail. The image
itself need not be valid as long as the exif_ifd_make_value gets invoked.

Example .jpg file (xxd format) that causes a SIGSEGV on PHP 5.6.0:
0000000: ffd8 ffe1 0050 4578 6966 0000 4949 2a00  .....PExif..II*.
0000010: 1500 0000 ff00 0020 0000 00ff ffff ffff  ....... ........
0000020: 1100 001d 0000 0000 0003 001a 010c 0024  ...............$
0000030: 0000 0017 0000 0001 0204 0001 0000 0040  ...............@
0000040: 0000 0017 0104 0001 0000 0001 0000 0000  ................
0000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000100: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000120: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000130: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000150: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000160: 0000 0000 0000 0000 0000 0000 0000 0000  ................

Script:
&lt;?php exif_thumbnail(&quot;corrupt_heap.jpg&quot;); ?&gt;

Regards,
Otto Ebeling
Facebook Security Infrastructure




</pre>
</div><h2>Patches</h2>
<a href="patch-display.php?bug_id=68113&amp;patch=exif-fix&amp;revision=latest" >exif-fix</a>
(last revision 2014-09-29 00:00 UTC by stas@php.net)
<br><p><a href='patch-add.php?bug_id=68113'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=68113'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_patch' ><a name="1411948801">&nbsp;</a><strong>[2014-09-29 00:00 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The following patch has been added/updated:

Patch Name: exif-fix
Revision:   1411948801
URL:        <a href="https://bugs.php.net/patch-display.php?bug=68113&amp;patch=exif-fix&amp;revision=1411948801" rel="nofollow">https://bugs.php.net/patch-display.php?bug=68113&amp;patch=exif-fix&amp;revision=1411948801</a>
</pre>
</div><div class='comment type_log' ><a name="1411968857">&nbsp;</a><strong>[2014-09-29 05:34 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2014-3670</span>
</div></div></div><div class='comment type_svn' ><a name="1413308527">&nbsp;</a><strong>[2014-10-14 17:42 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_log' ><a name="1413308527">&nbsp;</a><strong>[2014-10-14 17:42 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Open</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_svn' ><a name="1413308664">&nbsp;</a><strong>[2014-10-14 17:44 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413308757">&nbsp;</a><strong>[2014-10-14 17:45 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413308762">&nbsp;</a><strong>[2014-10-14 17:46 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413309203">&nbsp;</a><strong>[2014-10-14 17:53 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413309208">&nbsp;</a><strong>[2014-10-14 17:53 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413309214">&nbsp;</a><strong>[2014-10-14 17:53 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413367851">&nbsp;</a><strong>[2014-10-15 10:10 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413367860">&nbsp;</a><strong>[2014-10-15 10:11 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=f9ba0a157f2d7e6d027285cb2ef964a919e67b8e</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413367865">&nbsp;</a><strong>[2014-10-15 10:11 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=ddb207e7fa2e9adeba021a1303c3781efda5409b</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1413374892">&nbsp;</a><strong>[2014-10-15 12:08 UTC] <a href="//people.php.net/jpauli">jpauli@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=d0a6b7d1242bab3ebd4f1687bfa56b01e6767f67" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=d0a6b7d1242bab3ebd4f1687bfa56b01e6767f67</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1415043633">&nbsp;</a><strong>[2014-11-03 19:40 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1416342902">&nbsp;</a><strong>[2014-11-18 20:35 UTC] <a href="//people.php.net/ab">ab@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=287c91c1f060dc85a8bdb51488c50db8614448b7</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div><div class='comment type_svn' ><a name="1469014828">&nbsp;</a><strong>[2016-07-20 11:40 UTC] <a href="//people.php.net/davey">davey@php.net</a></strong>
<pre class='note'>Automatic comment on behalf of stas
Revision: <a href="http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff" rel="nofollow">http://git.php.net/?p=php-src.git;a=commit;h=4a38cc0a3c4db2ac42a5063df0f6ee1ec70b30ff</a>
Log: Fix <a href='bug.php?id=68113'>bug #68113</a> (Heap corruption in exif_thumbnail())
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
