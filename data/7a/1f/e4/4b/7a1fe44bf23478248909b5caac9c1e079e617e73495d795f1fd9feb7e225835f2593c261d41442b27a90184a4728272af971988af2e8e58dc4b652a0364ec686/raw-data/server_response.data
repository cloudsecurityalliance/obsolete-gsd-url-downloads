<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='SOAP related Bug #69085 - RDF' href='rss/bug.php?id=69085'>
        <link rel='alternate' type='application/rss+xml' title='SOAP related Bug #69085 - RSS 2.0' href='rss/bug.php?id=69085&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #69085 :: SoapClient's __call() type confusion through unserialize()</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=69085">Sec Bug</a>&nbsp;#69085</th>
            <td id="summary" colspan="5">SoapClient's __call() type confusion through unserialize()</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2015-02-19 23:13 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2015-08-10 08:12 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>andrea &#x64;&#111;&#x74; palazzo &#x61;&#116; truel &#x64;&#111;&#x74; it</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=dmitry">dmitry</a> (<a href="https://people.php.net/dmitry">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=SOAP+related">SOAP related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>Irrelevant</td>
            <th class="details">OS:</th>
            <td></td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-4147" target="_blank">2015-4147</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_3' class='control'><a href='bug.php?id=69085&amp;edit=3'>Add Comment</a></span>
<span id='control_1' class='control'><a href='bug.php?id=69085&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=69085&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1424387615">&nbsp;</a><strong>[2015-02-19 23:13 UTC] andrea &#x64;&#111;&#x74; palazzo &#x61;&#116; truel &#x64;&#111;&#x74; it</strong>
<pre class='note'>Description:
------------
SoapClient's __call() method is prone to a type confusion vulnerability which can be used to gain remote code execution through unsafe unserialize() calls.

In soap.c:2906

if (zend_hash_find(Z_OBJPROP_P(this_ptr), &quot;__default_headers&quot;, sizeof(&quot;__default_headers&quot;), (void **) &amp;tmp)==SUCCESS) {
       HashTable *default_headers = Z_ARRVAL_P(*tmp);

the Z_ARRVAL_P macro is called on __default_headers assuming that it is an array without any actual check about it.

It has been shown several times that this kind of vulnerability could lead to crash, arbitrary read/write memory access and code execution, so I'm not discussing about the actual exploitation of this one (you can refer to my previous submissions about natsort() and extract() if needed by the way).
However, it's worth pointing out that given the nature of __call() magic method, any direct call on a user-controlled userialized input should be considered remotely exploitable.


Test script:
---------------
&lt;?php

//tested on 64bit Ubuntu PHP 5.6.6
//crash on memory access violation @1337

$dummy = unserialize('O:10:&quot;SoapClient&quot;:3:{s:3:&quot;uri&quot;;s:1:&quot;a&quot;;s:8:&quot;location&quot;;s:22:&quot;<a href="http://localhost/a.xml&quot;;s:17:&quot;__default_headers&quot;;i:1337;}'" rel="nofollow">http://localhost/a.xml&quot;;s:17:&quot;__default_headers&quot;;i:1337;}'</a>);
var_dump($dummy-&gt;whatever());

?&gt;

Actual result:
--------------
(gdb) r soapvar.php 
Starting program: /usr/bin/php soapvar.php
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
[New Thread 0x7fffec568700 (LWP 13984)]
[Thread 0x7fffec568700 (LWP 13984) exited]

Program received signal SIGSEGV, Segmentation fault.
zend_hash_internal_pointer_reset_ex (ht=ht@entry=0x539, pos=pos@entry=0x0)
    at /build/buildd/php5-5.6.3+dfsg/Zend/zend_hash.c:1020
1020			*pos = ht-&gt;pListHead;
(gdb) x/i $pc
=&gt; 0x6e93d3 &lt;zend_hash_internal_pointer_reset_ex+3&gt;:	mov    0x20(%rdi),%rax
(gdb) p $rdi
$1 = 1337

</pre>
</div><h2>Patches</h2>
<p><a href='patch-add.php?bug_id=69085'>Add a Patch</a></p><h2>Pull Requests</h2>
<p><a href='gh-pull-add.php?bug_id=69085'>Add a Pull Request</a></p><h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1425288835">&nbsp;</a><strong>[2015-03-02 09:33 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>it should be fixed now
</pre>
</div><div class='comment type_comment' ><a name="1425306061">&nbsp;</a><strong>[2015-03-02 14:21 UTC] andrea &#x64;&#111;&#x74; palazzo &#x61;&#116; truel &#x64;&#111;&#x74; it</strong>
<pre class='note'>Hi, the fix seems ok to me, the Z_TYPE_PP check should do it.
By the way, doing a little more testing I came across another entry point for a very similiar issue located in do_soap_call() (called by __call(), indeed). Let me know if I should open another topic or it is ok to discuss it here.

Andrea
</pre>
</div><div class='comment type_comment' ><a name="1425308305">&nbsp;</a><strong>[2015-03-02 14:58 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>please, add the references to the other similar places right here. Just branch, file, line number.
</pre>
</div><div class='comment type_comment' ><a name="1425310752">&nbsp;</a><strong>[2015-03-02 15:39 UTC] andrea &#x64;&#111;&#x74; palazzo &#x61;&#116; truel &#x64;&#111;&#x74; it</strong>
<pre class='note'>Here you go, soap.c:2754, in do_soap_call()

if (call_uri == NULL) {
	call_uri = Z_STRVAL_PP(uri);
}

where uri comes from zend_hash_find(Z_OBJPROP_P(this_ptr), &quot;uri&quot;, sizeof(&quot;uri&quot;), (void *)&amp;uri), line 2748.

If the &quot;uri&quot; field has been previously unserialized as an int
, this could still result in an info leak whereas the attacker would be able to control a str.val field of a zval.
</pre>
</div><div class='comment type_log' ><a name="1425367478">&nbsp;</a><strong>[2015-03-03 07:24 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: dmitry</span>
</div></div></div><div class='comment type_comment' ><a name="1425367479">&nbsp;</a><strong>[2015-03-03 07:24 UTC] <a href="//people.php.net/dmitry">dmitry@php.net</a></strong>
<pre class='note'>I hope all the similar problems in ext/soap should be fixed now
</pre>
</div><div class='comment type_comment' ><a name="1425379101">&nbsp;</a><strong>[2015-03-03 10:38 UTC] andrea &#x64;&#111;&#x74; palazzo &#x61;&#116; truel &#x64;&#111;&#x74; it</strong>
<pre class='note'>They should be, I'll take a more accurate look these days and keep you posted if something else comes up.
Thank you for your time and please let me know if your are going to assign a CVE to this one.

Best regards,
Andrea
</pre>
</div><div class='comment type_comment' ><a name="1439194342">&nbsp;</a><strong>[2015-08-10 08:12 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<pre class='note'>This issue was assigned with two CVEs at <a href="http://seclists.org/oss-sec/2015/q2/599" rel="nofollow">http://seclists.org/oss-sec/2015/q2/599</a>

CVE-2015-4147
CVE-2015-4148
</pre>
</div><div class='comment type_log' ><a name="1439194364">&nbsp;</a><strong>[2015-08-10 08:12 UTC] <a href="//people.php.net/kaplan">kaplan@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2015-4147</span>
</div></div></div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2021 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Sat Oct 30 19:03:34 2021 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>
