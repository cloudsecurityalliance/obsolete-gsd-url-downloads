<!DOCTYPE html>
<html lang="en">
  <head>
    <title>80919 &ndash; CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="data/assets/c60deb3d48830179eae269c9e65a7506.css?1462892334" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1462892331"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 1000
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "80919 – CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections",
                             "show_bug.cgi?id=80919" );
        document.title = "80919 – CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "80919 – CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1462892334"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico">
  </head>

  <body 
        class="bugs-freedesktop-org
                 bz_bug
                 bz_status_RESOLVED
                 bz_product_dbus
                 bz_component_core
                 bz_bug_80919 yui-skin-sam">

  <div id="header"><div id="banner">
  </div>

    <div id="titles">
      <span id="title">Bugzilla &ndash; Bug&nbsp;80919</span>

        <span id="subtitle" class="subheader">CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections</span>

        <span id="information" class="header_addl_info">Last modified: 2014-09-16 16:34:39 UTC</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>


</ul>
    </div>
  </div>

  <div id="bugzilla-body">


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2014-09-16 16:34:39">
  <input type="hidden" name="id" value="80919">
  <input type="hidden" name="token" value="1635619160-MaSrvV_euWgpm2Febe3zJ5XxiLgcuFZv1dY3TFz58pI">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=80919"><b>Bug&nbsp;80919</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">CVE-2014-3639: Security implications of <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED WONTFIX - max_incomplete_connections: disconnect random unauthenticated connection?"
   href="show_bug.cgi?id=80851">Bug #80851</a> - max_incomplete_connections</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'CVE-2014-3639: Security implications of Bug #80851 - max_incomplete_connections' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >dbus

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=dbus"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >core

  (<a href="buglist.cgi?component=core&amp;product=dbus&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>
<td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">Other
        All
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>medium
       normal
      </td>
    </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Simon McVittie</span>
</span>
      </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_qa_contact">


  <a 
      title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#qa_contact"
  >QA Contact:</a>

</th>
      <td><span class="vcard"><span class="fn">Sjoerd Simons</span>
</span>
      </td>
    </tr>
    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'dbus\x40maint.invalid',
        'dbus\x40maint.invalid');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>

    <tr><th class="field_label "
    id="field_label_status_whiteboard">


  <a 
      title="Each bug has a free-form single line text entry box for adding tags and status information."
      class="field_help_link"
      href="page.cgi?id=fields.html#status_whiteboard"
  >Whiteboard:</a>

</th><td>review+  
  </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >patch, security

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2014-07-04 16:57 UTC by <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2014-09-16 16:34 UTC
      (<a href="show_activity.cgi?id=80919">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>2 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="thiago">thiago</option>
                <option value="walters">walters</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 
<tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_i915_platform">


  <a 
      title="Intel platforms affected by the bug"
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_i915_platform"
  >i915 platform:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_i915_platform" >

</td>
    </tr>
    <tr>
      <th class="field_label  bz_hidden_field"
    id="field_label_cf_i915_features">


  <a 
      title="Features of the i915 driver affected by the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_i915_features"
  >i915 features:</a>

</th>
  <td class="field_value  bz_hidden_field"
      id="field_container_cf_i915_features" >

</td>
    </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="2" class="left">
      Attachments
    </th>
  </tr>


      <tr id="a1" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=102277"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH] Randomize disconnect</span></b></a>

          <span class="bz_attach_extra_info">
              (2.04 KB,
                patch)

            <br>
            <a href="#attach_102277"
               title="Go to the comment associated with the attachment">2014-07-04 17:04 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=102277&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102277">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a2" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=102375"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections</span></b></a>

          <span class="bz_attach_extra_info">
              (9.77 KB,
                patch)

            <br>
            <a href="#attach_102375"
               title="Go to the comment associated with the attachment">2014-07-07 15:01 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=102375&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a3" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=102430"
               title="View the content of the attachment">
          <b>[PATCH] config: change default auth_timeout to 5 seconds</b></a>

          <span class="bz_attach_extra_info">
              (1.08 KB,
                patch)

            <br>
            <a href="#attach_102430"
               title="Go to the comment associated with the attachment">2014-07-08 11:06 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=102430&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102430">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a4" class="bz_contenttype_text_plain bz_patch bz_tr_obsolete bz_default_hidden">
        <td>
            <a href="attachment.cgi?id=102769"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections</span></b></a>

          <span class="bz_attach_extra_info">
              (11.88 KB,
                patch)

            <br>
            <a href="#attach_102769"
               title="Go to the comment associated with the attachment">2014-07-14 12:21 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=102769&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102769">
      Splinter Review</a>
        </td>
      </tr>
      <tr id="a5" class="bz_contenttype_text_plain bz_patch">
        <td>
            <a href="attachment.cgi?id=105796"
               title="View the content of the attachment">
          <b>[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections</b></a>

          <span class="bz_attach_extra_info">
              (11.55 KB,
                patch)

            <br>
            <a href="#attach_105796"
               title="Go to the comment associated with the attachment">2014-09-05 11:30 UTC</a>,

            <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
          </span>
        </td>


        <td>
          <a href="attachment.cgi?id=105796&amp;action=edit">Details</a>&#x0020; |
    <a href="https://bugs.freedesktop.org/page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=105796">
      Splinter Review</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
            <a href="#a0" onclick="return toggle_display(this);">Show
              Obsolete</a> (3)
            <a id="view_all" href="attachment.cgi?bugid=80919&amp;action=viewall&amp;hide_obsolete=1">View All</a>
        </span>
    </td>
  </tr>
</table>
<br>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js?1462891770" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-04 16:57:49 UTC
        </span>

      </div>




<pre class="bz_comment_text">I wrote a program to quickly connect to the system bus without authenticating. While that program is running, normal connections to the system bus rarely succeed (less than 1 success for 10 attempt) because of the max_incomplete_connections limit.

This bug is to discuss the security implications of <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED WONTFIX - max_incomplete_connections: disconnect random unauthenticated connection?"
   href="show_bug.cgi?id=80851">Bug #80851</a>.

This is how the issue looks like:

$ dbus-monitor --system
Failed to open connection to system bus: Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.

$ strace dbus-monitor --system
[...]
sendto(3, &quot;\0&quot;, 1, MSG_NOSIGNAL, NULL, 0) = 1
sendto(3, &quot;AUTH EXTERNAL xxxxxxxx\r\n&quot;, 24, MSG_NOSIGNAL, NULL, 0) = 24
poll([{fd=3, events=POLLIN}], 1, 4294967295) = 1 ([{fd=3, revents=POLLIN|POLLERR|POLLHUP}])
close(3)                                = 0
write(2, &quot;Failed to open connection to sys&quot;..., 252) = 252

Because this limit is enforced before the authentication, it is not user specific and any user could prevent new connections on the system bus from all users.</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-04 17:04:02 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=102277" name="attach_102277" title="[PATCH] Randomize disconnect">attachment 102277</a> <a href="attachment.cgi?id=102277&amp;action=edit" title="[PATCH] Randomize disconnect">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102277'>[review]</a>
[PATCH] Randomize disconnect

I implemented the random connection drop mentioned in the FIXME (See <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED WONTFIX - max_incomplete_connections: disconnect random unauthenticated connection?"
   href="show_bug.cgi?id=80851">Bug #80851</a>) but then it didn't help in practice: I can still prevent others from completing the authentication. The limit of 64 incomplete connections on the system bus is a small number and when dropping connections randomly quickly in this small pool, it still reach the innocent ones. We cannot choose correctly which connection to drop: we cannot check the pid of the other end at this stage.</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-04 17:06:39 UTC
        </span>

      </div>




<pre class="bz_comment_text">I think the issue should be solved differently:
- whenever the limit max_incomplete_connections is reached, dbus-daemon must stop reading on the listening socket and not call accept(). Removing the socket from the mainloop watchers: see _dbus_connection_toggle_watch_unlocked how it is done.
- whenever it goes below the limit, add the listening socket back in the mainloop. It could go below the limit either because some authentication finished or because auth_timeout = 30000 (30 seconds) was reached.

One benefit of stopping incoming connections before the accept() is that we don't allocate unnecessary resources in dbus-daemon if we are not ready to accept them. The choice between clients to accept would be done in the kernel. The backlog [1] is read in order [2]: it means that fast connectors would unfortunately be privileged compared to the innocent clients.

[1] <a href="http://cgit.freedesktop.org/dbus/dbus/tree/dbus/dbus-sysdeps-unix.c#n1088">http://cgit.freedesktop.org/dbus/dbus/tree/dbus/dbus-sysdeps-unix.c#n1088</a>
  if (listen (listen_fd, 30 /* backlog */) &lt; 0)
[2] <a href="http://lxr.free-electrons.com/source/net/unix/af_unix.c#L1286">http://lxr.free-electrons.com/source/net/unix/af_unix.c#L1286</a>

To solve this, we can reduce the backlog to a smaller number (5). When the backlog is full, connections are not rejected on Unix sockets: instead, clients calling connect() would either block (or return EAGAIN for async sockets) [3]. The choice between the sockets to accept will be more fair between the clients because all client processes will be waiting on the same wait queue &quot;u-&gt;peer_wait&quot;.

[3] <a href="http://lxr.free-electrons.com/source/net/unix/af_unix.c#L1127">http://lxr.free-electrons.com/source/net/unix/af_unix.c#L1127</a>

On TCP socket: similarly, connections are not rejected when the backlog is full but instead of a wait queue, it will rely on the tcp retransmission mechanism:
<a href="http://veithen.blogspot.co.uk/2014/01/how-tcp-backlog-works-in-linux.html">http://veithen.blogspot.co.uk/2014/01/how-tcp-backlog-works-in-linux.html</a></pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-04 17:10:41 UTC
        </span>

      </div>




<pre class="bz_comment_text">My initial reaction is to make D-Bus disconnect unauthenticated connections after a very low timeout (5 seconds) without any data being read. That is, the timer gets reset as soon as data is received. This expiry might be done only when the limit is reached.

This way, on a legitimate system slowness situation with lots of connections happening (e.g., booting), no expiry is done and everyone manages to connect. If there's a DoS happening, the connections are dropped if they don't write anything -- and they get dropped if they write garbage too.

The only attack vector that remains will be to write byte-by-byte with a very low timeout between characters.

We may want to reset the timer on newlines being received instead. With such short buffers being sent over the socket, fragmentation is unlikely (possibly even impossible).

We also need to limit the number of possible commands being sent by the client. The client could keep insisting on different extensions be negotiated, thus resetting its timer. (NEGOTIATE FOOBAR1, NEGOTIATE FOOBAR2, ...). Any ideas on how to limit this?</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-07 14:53:22 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=80919#c3">comment #3</a>)
<span class="quote">&gt; My initial reaction is to make D-Bus disconnect unauthenticated connections
&gt; after a very low timeout (5 seconds) without any data being read. That is,
&gt; the timer gets reset as soon as data is received. This expiry might be done
&gt; only when the limit is reached.
&gt; 
&gt; This way, on a legitimate system slowness situation with lots of connections
&gt; happening (e.g., booting), no expiry is done and everyone manages to
&gt; connect. If there's a DoS happening, the connections are dropped if they
&gt; don't write anything -- and they get dropped if they write garbage too.
&gt; 
&gt; The only attack vector that remains will be to write byte-by-byte with a
&gt; very low timeout between characters.
&gt; 
&gt; We may want to reset the timer on newlines being received instead. With such
&gt; short buffers being sent over the socket, fragmentation is unlikely
&gt; (possibly even impossible).
&gt; 
&gt; We also need to limit the number of possible commands being sent by the
&gt; client. The client could keep insisting on different extensions be
&gt; negotiated, thus resetting its timer. (NEGOTIATE FOOBAR1, NEGOTIATE FOOBAR2,
&gt; ...). Any ideas on how to limit this?</span >

I agree that the current authentication timeout might be too long by default. I am not sure about the &quot;without any data being read&quot; condition. In my tests, I changed it to 5 seconds too:

  &lt;limit name=&quot;auth_timeout&quot;&gt;5000&lt;/limit&gt;

But in any case, changing the auth_timeout does not fix the bug: dbus-monitor still fail because it does not have time to complete the authentication steps while the fast connector initiated the 64 incomplete connections (max_incomplete_connections=64 on the system bus).

I will post a patch for the solution from <a href="show_bug.cgi?id=80919#c2">Comment #2</a>.</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-07 15:01:29 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

With this patch applied, I can't make new connections to fail. I am trying with &quot;dbus-monitor --system&quot; while the fast connector is running and I see that dbus-monitor freezes for maximum 5 seconds (I tested with auth_timeout=5000) and then connect successfully.

So the patch reduces the harm of the attack from a DoS (the new connection fails) to a slow connection at startup (up to auth_timeout).

The patch introduces a new symbol in libdbus:
dbus_server_toggle_all_watches()

It didn't seem that the feature was exported before.</pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Colin Walters</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-07 15:46:15 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=80919#c5">comment #5</a>)

<span class="quote">&gt; So the patch reduces the harm of the attack from a DoS (the new connection
&gt; fails) to a slow connection at startup (up to auth_timeout).</span >

Can't you still perform the DoS by starting many instances of the fast connector process?</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-07 16:28:24 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=80919#c6">comment #6</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=80919#c5">comment #5</a>)
&gt; 
&gt; &gt; So the patch reduces the harm of the attack from a DoS (the new connection
&gt; &gt; fails) to a slow connection at startup (up to auth_timeout).
&gt; 
&gt; Can't you still perform the DoS by starting many instances of the fast
&gt; connector process?</span >

I tried with 10 processes running the fast connector. It does not seem to change anything compared to only 1 fast connector process. dbus-monitor does not fail to connect, it just needs some time (auth_timeout=5s in my test) to connect.

Then I tried with 100 processes, and dbus-monitor took 14 seconds to connect instead of 5 seconds.

So yes, it is still sensible to the DoS attack but I think it is reasonably resistant with the patch because:
- it does not fail to connect anymore, it just takes time
- a successful attack would require lots of malicious processes or threads: each thread needs to be blocked in the connect(2) call so the kernel will likely wake up one of them (in the u-&gt;peer_wait wait queue) instead of dbus-daemon. So the attack cannot be rewritten using plenty of sockets connecting asynchronously in a single process.</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-07 16:41:16 UTC
        </span>

      </div>




<pre class="bz_comment_text">I ran each test twice and the durations are stable:

100 fast connectors =&gt; dbus-monitor takes 14 seconds to connect
200 fast connectors =&gt; dbus-monitor takes 16 seconds to connect
300 fast connectors =&gt; dbus-monitor takes 30 seconds to connect
400 fast connectors =&gt; dbus-monitor takes 34 seconds to connect
500 fast connectors =&gt; dbus-monitor takes 45 seconds to connect</pre>
    </div>

    <div id="c9" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 11:06:45 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=102430" name="attach_102430" title="[PATCH] config: change default auth_timeout to 5 seconds">attachment 102430</a> <a href="attachment.cgi?id=102430&amp;action=edit" title="[PATCH] config: change default auth_timeout to 5 seconds">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102430'>[review]</a>
[PATCH] config: change default auth_timeout to 5 seconds</pre>
    </div>

    <div id="c10" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 17:41:57 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>:
-----------------------------------------------------------------

This patch is syntactically correct, but I don't know what it's supposed to do. It sets all sockets to be watched, that's all.</pre>
    </div>

    <div id="c11" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 17:42:13 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class=""><a href="attachment.cgi?id=102430" name="attach_102430" title="[PATCH] config: change default auth_timeout to 5 seconds">attachment 102430</a> <a href="attachment.cgi?id=102430&amp;action=edit" title="[PATCH] config: change default auth_timeout to 5 seconds">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102430'>[review]</a>
[PATCH] config: change default auth_timeout to 5 seconds

Review of <span class=""><a href="attachment.cgi?id=102430" name="attach_102430" title="[PATCH] config: change default auth_timeout to 5 seconds">attachment 102430</a> <a href="attachment.cgi?id=102430&amp;action=edit" title="[PATCH] config: change default auth_timeout to 5 seconds">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102430'>[review]</a>:
-----------------------------------------------------------------

Looks good.</pre>
    </div>

    <div id="c12" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 17:42:52 UTC
        </span>

      </div>




<pre class="bz_comment_text">Can you explain a little more what the first patch does and how it accomplishes it? I see it always setting all watches to enabled. Where do they get disabled?</pre>
    </div>

    <div id="c13" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 18:13:15 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=80919#c12">comment #12</a>)
<span class="quote">&gt; Can you explain a little more what the first patch does and how it
&gt; accomplishes it? I see it always setting all watches to enabled. Where do
&gt; they get disabled?</span >

The first &quot;if&quot; in the function bus_context_check_all_watches() decides whether to enable or disable the watchers (with the boolean variable &quot;enabled&quot;), depending on whether the &quot;n_incomplete&quot; limit is reached.

That function is called whenever the &quot;n_incomplete&quot; value changes (incremented or decremented).

The boolean is transmitted from BusContext to all DBusServers, and then from each DBusServer to all DBusWatches.</pre>
    </div>

    <div id="c14" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thiago Macieira</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-08 19:28:36 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>:
-----------------------------------------------------------------

Ok, I had missed that part of the patch. Now it makes sense.</pre>
    </div>

    <div id="c15" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-14 10:03:45 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a>:
-----------------------------------------------------------------

(not a full review)

::: bus/bus.c
&#64;&#64; +1687,5 &#64;&#64;
<span class="quote">&gt; +       * several &lt;listen&gt; configuration items) and a DBusServer might
&gt; +       * contain several DBusWatch in its DBusWatchList (if getaddrinfo
&gt; +       * returns several addresses on a dual IPv4-IPv6 stack or if
&gt; +       * systemd passes several fds).
&gt; +       * We want to enable/disable them all.</span >

Is there any other reason why a watch might be disabled? I'm concerned about this situation:

- watches on fds 23, 24, 25 are all enabled
- watch on fd 23 is disabled for some other reason
- DoS attempted, max incomplete connections hit, all watches are disabled
- DoS over, all watches are re-enabled
- now the watch on fd 23 has been re-enabled, even though its &quot;other reason&quot; to be disabled might still be valid

&#64;&#64; +1690,5 &#64;&#64;
<span class="quote">&gt; +       * systemd passes several fds).
&gt; +       * We want to enable/disable them all.
&gt; +       */
&gt; +      DBusServer *server = link-&gt;data;
&gt; +      dbus_server_toggle_all_watches (server, enabled);</span >

Please do not make this into public API. dbus-daemon is statically linked to libdbus-internal.la, so it has access to _dbus_whatever() and does not need symbols to be exported.</pre>
    </div>

    <div id="c16" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-14 11:01:24 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=80919#c15">comment #15</a>)
<span class="quote">&gt; Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a> [review]
&gt; [PATCH] Stop listening on DBusServer sockets when reaching
&gt; max_incomplete_connections
&gt; 
&gt; Review of <span class="bz_obsolete"><a href="attachment.cgi?id=102375" name="attach_102375" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102375</a> <a href="attachment.cgi?id=102375&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102375'>[review]</a> [review]:
&gt; -----------------------------------------------------------------
&gt; 
&gt; (not a full review)
&gt; 
&gt; ::: bus/bus.c
&gt; &#64;&#64; +1687,5 &#64;&#64;
&gt; &gt; +       * several &lt;listen&gt; configuration items) and a DBusServer might
&gt; &gt; +       * contain several DBusWatch in its DBusWatchList (if getaddrinfo
&gt; &gt; +       * returns several addresses on a dual IPv4-IPv6 stack or if
&gt; &gt; +       * systemd passes several fds).
&gt; &gt; +       * We want to enable/disable them all.
&gt; 
&gt; Is there any other reason why a watch might be disabled? I'm concerned about
&gt; this situation:
&gt; 
&gt; - watches on fds 23, 24, 25 are all enabled
&gt; - watch on fd 23 is disabled for some other reason
&gt; - DoS attempted, max incomplete connections hit, all watches are disabled
&gt; - DoS over, all watches are re-enabled
&gt; - now the watch on fd 23 has been re-enabled, even though its &quot;other reason&quot;
&gt; to be disabled might still be valid</span >

Watches on a DBusConnection can be enabled and disabled.

But watches on DBusServer (on the passive listening socket) were never disabled: _dbus_server_toggle_watch() is never called (i.e. it is dead code and not exported to libdbus) and before the patch, it was the only way to enable/disable the watch.

Since the patch introduces dbus_server_toggle_all_watches(), I should update the patch should also delete the dead code _dbus_server_toggle_watch() because we don't need to enable/disable individual watches.

Note that in the usual system/session bus, there is only 1 watch per DBusServer because it uses only one file descriptor to listen on the /var/run/dbus/system_bus_socket (or &#64;/tmp/dbus-*) socket.

<span class="quote">&gt; &#64;&#64; +1690,5 &#64;&#64;
&gt; &gt; +       * systemd passes several fds).
&gt; &gt; +       * We want to enable/disable them all.
&gt; &gt; +       */
&gt; &gt; +      DBusServer *server = link-&gt;data;
&gt; &gt; +      dbus_server_toggle_all_watches (server, enabled);
&gt; 
&gt; Please do not make this into public API. dbus-daemon is statically linked to
&gt; libdbus-internal.la, so it has access to _dbus_whatever() and does not need
&gt; symbols to be exported.</span >

Ok, I will make the changes.</pre>
    </div>

    <div id="c17" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-07-14 12:21:26 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class="bz_obsolete"><a href="attachment.cgi?id=102769" name="attach_102769" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102769</a> <a href="attachment.cgi?id=102769&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102769'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Changes in patch v2:
- delete _dbus_server_toggle_watch
- rename to _dbus_server_toggle_all_watches
- move the prototype to dbus-server-protected.h
- bus/bus.c: add #include &lt;dbus/dbus-server-protected.h&gt;. It's not the perfect place because _dbus_server_* functions were for subclassing DBusServer but it seems to be the best we have.</pre>
    </div>

    <div id="c18" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-03 17:26:59 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class="bz_obsolete"><a href="attachment.cgi?id=102769" name="attach_102769" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102769</a> <a href="attachment.cgi?id=102769&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102769'>[review]</a>
[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Review of <span class="bz_obsolete"><a href="attachment.cgi?id=102769" name="attach_102769" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 102769</a> <a href="attachment.cgi?id=102769&amp;action=edit" title="[PATCH] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=102769'>[review]</a>:
-----------------------------------------------------------------

Patch seems good but I'd like more comments.

::: bus/connection.c
&#64;&#64; +293,4 &#64;&#64;
<span class="quote">&gt;            _dbus_list_remove_link (&amp;d-&gt;connections-&gt;incomplete, d-&gt;link_in_connection_list);
&gt;            d-&gt;link_in_connection_list = NULL;
&gt;            d-&gt;connections-&gt;n_incomplete -= 1;
&gt; +          bus_context_check_all_watches (d-&gt;connections-&gt;context);</span >

deserves a comment, I think:

/* If we have dropped below the max. number of incomplete
 * connections, start accept()ing again */

&#64;&#64; +692,4 &#64;&#64;
<span class="quote">&gt;    bus_connections_expire_incomplete (connections);
&gt;    
&gt; +  /* The listening sockets are removed from the poll while n_incomplete
&gt; +   * reaches the max */</span >

/* The listening socket is removed from the main loop,
 * i.e. does not accept(), while n_incomplete is at its
 * maximum value; so we shouldn't get here in that case */

&#64;&#64; +695,5 &#64;&#64;
<span class="quote">&gt; +   * reaches the max */
&gt; +  _dbus_assert (connections-&gt;n_incomplete &lt;=
&gt; +      bus_context_get_max_incomplete_connections (connections-&gt;context));
&gt; +
&gt; +  bus_context_check_all_watches (d-&gt;connections-&gt;context);</span >

I think this deserves a comment:

/* If we have the maximum number of incomplete connections,
 * stop accept()ing any more, to avert a DoS. See fd.o #80919 */

&#64;&#64; +1403,4 &#64;&#64;
<span class="quote">&gt;    _dbus_assert (d-&gt;connections-&gt;n_incomplete &gt;= 0);
&gt;    _dbus_assert (d-&gt;connections-&gt;n_completed &gt; 0);
&gt;  
&gt; +  bus_context_check_all_watches (d-&gt;connections-&gt;context);</span >

/* If we have dropped below the max. number of incomplete
 * connections, start accept()ing again */</pre>
    </div>

    <div id="c19" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c19">Comment 19</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alban Crequy</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-05 11:30:58 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=105796" name="attach_105796" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 105796</a> <a href="attachment.cgi?id=105796&amp;action=edit" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=105796'>[review]</a>
[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Thanks for the comments!

Changes in patch v3:

- Add the two bugzilla links in commit log
- Add comments suggested by Simon
- Remove unrelated whitespace changes in dbus/dbus-server.h and dbus/dbus-server-protected.h</pre>
    </div>

    <div id="c20" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c20">Comment 20</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-09 14:37:30 UTC
        </span>

      </div>




<pre class="bz_comment_text">Comment on <span class=""><a href="attachment.cgi?id=105796" name="attach_105796" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 105796</a> <a href="attachment.cgi?id=105796&amp;action=edit" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=105796'>[review]</a>
[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections

Review of <span class=""><a href="attachment.cgi?id=105796" name="attach_105796" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">attachment 105796</a> <a href="attachment.cgi?id=105796&amp;action=edit" title="[PATCH v3] Stop listening on DBusServer sockets when reaching max_incomplete_connections">[details]</a></span> <a href='page.cgi?id=splinter.html&amp;bug=80919&amp;attachment=105796'>[review]</a>:
-----------------------------------------------------------------

Looks good</pre>
    </div>

    <div id="c21" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c21">Comment 21</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-12 22:18:12 UTC
        </span>

      </div>




<pre class="bz_comment_text">CVE-2014-3639 has been allocated for this vulnerability.</pre>
    </div>

    <div id="c22" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=80919#c22">Comment 22</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon McVittie</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-09-16 16:34:39 UTC
        </span>

      </div>




<pre class="bz_comment_text">Fixed in 1.8.8, making public</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=80919">Format For Printing</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>


</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>
<p align="center">
  Use of freedesktop.org services, including Bugzilla, is subject to our <a href="https://www.freedesktop.org/wiki/CodeOfConduct/">Code of Conduct</a>. How we collect and use information is described in our <a href="https://www.freedesktop.org/wiki/PrivacyPolicy">Privacy Policy</a>.
</p>
  </body>
</html>